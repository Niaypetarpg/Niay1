import { useState, useEffect, useRef, useCallback } from 'react'
import { Camera, Plus, Minus, Crown, X, Moon, Sun, User, Lock, Sword, Heart, Search, Trash2, Smile, BookOpenText, Zap, BookA, CircleDot, Webhook, Coins, Backpack, ArrowBigRightDash, ArrowBigLeftDash, Info, ChevronDown, ChevronUp, ChevronRight, Wrench, Sparkles, CornerLeftDown, CornerRightUp, LifeBuoy, BatteryCharging, ShieldPlus, Users, ShoppingBag, Package, BarChart3, ChevronLeft, BadgeHelp, Clover, Shell, Snowflake, Flame, Droplet, Edit, ArrowRightCircle, PlusCircle, HandMetal, MapPin, ArrowDownUp, Award, BookOpen, ListTree, RefreshCcw, RotateCw, RotateCcw, Settings2, Hand, Sigma, Dices, Check, Send, BookType, FileText, ClipboardCheck, Trophy, Target, Shuffle, Pencil, ListPlus, Save, Archive, MoveVertical, Menu, Gamepad2, TowerControl } from 'lucide-react'
import AccountDataModal from './AccountDataModal'
import pokedexData, { POKEMON_DIET_MAP } from './pokemonData'
import { POKEMON_DESLOCAMENTO_MAP } from './pokemonDeslocamentos'
import { POKEMON_CAPACIDADE_MAP } from './pokemonCapacidades'
import GOLPES_DATA_IMPORTED from './golpesData'
import HABILIDADES_DATA_IMPORTED, { HABILIDADES_NAMES as HABILIDADES_NAMES_IMPORTED } from './habilidadesData'
import CARACTERISTICAS_DATA_IMPORTED, { TALENTOS_DATA as TALENTOS_DATA_IMPORTED, TALENTOS_NAMES as TALENTOS_NAMES_IMPORTED } from './caracteristicasETalentosData'
import POKEMON_ABILITIES from './pokemonAbilities'
import { generatePokemonMoves } from './pokemonMoveGenerator'
// Firebase imports
import {
  saveTrainerData, loadTrainerData, subscribeToTrainer,
  saveMestreConfig, loadMestreConfig,
  saveNpcTrainers, loadNpcTrainers, subscribeToNpcTrainers,
  saveGlobalExoticSpecies, loadGlobalExoticSpecies, subscribeToGlobalExoticSpecies,
  saveBattleData, loadBattleData, subscribeToBattle,
  savePokemonStages, saveTrainerStages, loadPokemonStages, loadTrainerStages,
  subscribeToPokemonStages, subscribeToTrainerStages,
  saveChatMessages, loadChatMessages, subscribeToChatMessages,
  saveInterludioData, loadInterludioData, subscribeToInterludio,
  saveHiddenPokelojaItems, loadHiddenPokelojaItems, subscribeToHiddenPokelojaItems,
  saveCustomPrices, loadCustomPrices, subscribeToCustomPrices,
  saveVTTData, loadVTTData, subscribeToVTT,
  saveXpCapturas, loadXpCapturas, subscribeToXpCapturas, subscribeToAllXpCapturas,
  saveSafariData, loadSafariData, subscribeToSafari,
  saveGeneratedApricornTrees, loadGeneratedApricornTrees, subscribeToGeneratedApricornTrees,
  saveBackups, loadBackups, subscribeToBackups,
  saveToFirebase, subscribeToFirebase,
  saveTradeHub, loadTradeHub, subscribeToTradeHub,
  saveGBBattle, loadGBBattle, subscribeToGBBattle,
  saveGBChatMessages, subscribeToGBChatMessages,
  saveNpcTeams, loadNpcTeams, subscribeToNpcTeams,
  saveSessionScenarios, loadSessionScenarios, subscribeToSessionScenarios,
  saveScenarioDisplay, subscribeToScenarioDisplay,
  saveQuests, loadQuests, subscribeToQuests,
  saveSmartPokefoneMessages, loadSmartPokefoneMessages, subscribeToSmartPokefoneMessages,
  saveTriunfosGerais, subscribeToTriunfosGerais,
  saveTriunfosIndividuais, subscribeToTriunfosIndividuais,
  saveMostrarTriunfos, subscribeToMostrarTriunfos,
  saveAnotacoes, subscribeToAnotacoes
} from './firebaseService'
import { database } from './firebase'
import { ref, set, get } from 'firebase/database'

// Helper para sanitizar IDs de Pokemon para uso como chaves do Firebase
// Firebase não permite ".", "#", "$", "/", "[", ou "]" em chaves
const sanitizeFirebaseKey = (key) => {
  if (!key) return key
  return String(key).replace(/[.#$/\[\]]/g, '_')
}

// Parser matemático seguro — substitui eval() para evitar bloqueio de CSP
// Suporta +, -, *, /, parênteses e números decimais
const safeMathEval = (expr) => {
  let pos = 0
  const str = String(expr).replace(/\s/g, '')
  const parseExpr = () => {
    let result = parseTerm()
    while (pos < str.length && (str[pos] === '+' || str[pos] === '-')) {
      const op = str[pos++]
      const term = parseTerm()
      result = op === '+' ? result + term : result - term
    }
    return result
  }
  const parseTerm = () => {
    let result = parseFactor()
    while (pos < str.length && (str[pos] === '*' || str[pos] === '/')) {
      const op = str[pos++]
      const factor = parseFactor()
      result = op === '*' ? result * factor : result / factor
    }
    return result
  }
  const parseFactor = () => {
    if (str[pos] === '(') { pos++; const r = parseExpr(); pos++; return r }
    if (str[pos] === '-') { pos++; return -parseFactor() }
    if (str[pos] === '+') { pos++; return parseFactor() }
    let numStr = ''
    while (pos < str.length && /[\d.]/.test(str[pos])) numStr += str[pos++]
    return parseFloat(numStr) || 0
  }
  return parseExpr()
}

// Cores dos tipos de Pokémon
const TYPE_COLORS = {
  'Normal': '#A8A878',
  'Fogo': '#F08030',
  'Água': '#6890F0',
  'Elétrico': '#F8D030',
  'Planta': '#78C850',
  'Gelo': '#98D8D8',
  'Lutador': '#C03028',
  'Venenoso': '#A040A0',
  'Terrestre': '#E0C068',
  'Voador': '#A890F0',
  'Psíquico': '#F85888',
  'Inseto': '#A8B820',
  'Pedra': '#B8A038',
  'Fantasma': '#705898',
  'Dragão': '#7038F8',
  'Sombrio': '#705848',
  'Metal': '#B8B8D0',
  'Fada': '#EE99AC'
}

// Normalização de nomes de tipos (pokemonData usa "Aço"/"Terra"/"Veneno", golpesData usa "Metal"/"Terra"/"Venenoso")
const TYPE_ALIASES = { 'Aço': 'Metal', 'Terra': 'Terrestre', 'Veneno': 'Venenoso' }
const normalizeType = (type) => TYPE_ALIASES[type] || type

// Tabela de efetividade de tipos para cálculo de dano
// strong = tipos contra os quais o golpe causa 2x de dano
// weak = tipos contra os quais o golpe causa 0.5x de dano
// immune = tipos contra os quais o golpe causa 0x de dano
const TYPE_EFFECTIVENESS = {
  'Normal':    { strong: [], weak: ['Pedra', 'Metal'], immune: ['Fantasma'] },
  'Planta':    { strong: ['Terrestre', 'Pedra', 'Água'], weak: ['Planta', 'Fogo', 'Venenoso', 'Voador', 'Inseto', 'Dragão', 'Metal'], immune: [] },
  'Fogo':      { strong: ['Planta', 'Gelo', 'Inseto', 'Metal'], weak: ['Fogo', 'Água', 'Pedra', 'Dragão'], immune: [] },
  'Água':      { strong: ['Fogo', 'Terrestre', 'Pedra'], weak: ['Água', 'Planta', 'Dragão'], immune: [] },
  'Elétrico':  { strong: ['Água', 'Voador'], weak: ['Elétrico', 'Planta', 'Dragão'], immune: ['Terrestre'] },
  'Voador':    { strong: ['Planta', 'Lutador', 'Inseto'], weak: ['Elétrico', 'Pedra', 'Metal'], immune: [] },
  'Gelo':      { strong: ['Planta', 'Terrestre', 'Voador', 'Dragão'], weak: ['Fogo', 'Água', 'Gelo', 'Metal'], immune: [] },
  'Pedra':     { strong: ['Fogo', 'Gelo', 'Voador', 'Inseto'], weak: ['Lutador', 'Terrestre', 'Metal'], immune: [] },
  'Terrestre': { strong: ['Fogo', 'Elétrico', 'Venenoso', 'Pedra', 'Metal'], weak: ['Planta', 'Inseto'], immune: ['Voador'] },
  'Metal':     { strong: ['Gelo', 'Pedra', 'Fada'], weak: ['Fogo', 'Água', 'Elétrico', 'Metal'], immune: [] },
  'Lutador':   { strong: ['Normal', 'Gelo', 'Pedra', 'Sombrio', 'Metal'], weak: ['Venenoso', 'Voador', 'Psíquico', 'Inseto', 'Fada'], immune: ['Fantasma'] },
  'Sombrio':   { strong: ['Psíquico', 'Fantasma'], weak: ['Lutador', 'Sombrio', 'Fada'], immune: [] },
  'Psíquico':  { strong: ['Lutador', 'Venenoso'], weak: ['Psíquico', 'Metal'], immune: ['Sombrio'] },
  'Venenoso':  { strong: ['Planta', 'Fada'], weak: ['Venenoso', 'Terrestre', 'Pedra', 'Fantasma'], immune: ['Metal'] },
  'Inseto':    { strong: ['Planta', 'Psíquico', 'Sombrio'], weak: ['Fogo', 'Lutador', 'Venenoso', 'Voador', 'Fantasma', 'Metal', 'Fada'], immune: [] },
  'Fada':      { strong: ['Lutador', 'Dragão', 'Sombrio'], weak: ['Fogo', 'Venenoso', 'Metal'], immune: [] },
  'Fantasma':  { strong: ['Psíquico', 'Fantasma'], weak: ['Sombrio'], immune: ['Normal'] },
  'Dragão':    { strong: ['Dragão'], weak: ['Metal'], immune: ['Fada'] }
}

// Calcula o multiplicador de tipo para um golpe contra um defensor (considera dual-type)
const calcTypeMultiplier = (moveType, defenderTypes) => {
  const normalizedMoveType = normalizeType(moveType)
  const effectiveness = TYPE_EFFECTIVENESS[normalizedMoveType]
  if (!effectiveness) return 1

  let multiplier = 1
  for (const defType of defenderTypes) {
    const normalizedDefType = normalizeType(defType)
    if (effectiveness.immune.includes(normalizedDefType)) {
      return 0
    } else if (effectiveness.strong.includes(normalizedDefType)) {
      multiplier *= 2
    } else if (effectiveness.weak.includes(normalizedDefType)) {
      multiplier *= 0.5
    }
  }
  return multiplier
}

// Tabela de XP necessária para alcançar o próximo nível
// Exemplo: Nível 1→2 precisa de 25 XP, Nível 2→3 precisa de 50 XP, Nível 3→4 precisa de 100 XP
// XP Total acumulada: Nível 1=0, Nível 2=25, Nível 3=75, Nível 4=175, etc.
const XP_TABLE = {
  1: 0, 2: 25, 3: 50, 4: 100, 5: 150, 6: 200, 7: 400, 8: 600, 9: 800, 10: 1000,
  11: 1500, 12: 2000, 13: 3000, 14: 4000, 15: 5000, 16: 6000, 17: 7000, 18: 8000, 19: 9000, 20: 10000,
  21: 11500, 22: 13000, 23: 14500, 24: 16000, 25: 17500, 26: 19000, 27: 20500, 28: 22000, 29: 23500, 30: 25000,
  31: 27500, 32: 30000, 33: 32500, 34: 35000, 35: 37500, 36: 40000, 37: 42500, 38: 45000, 39: 47500, 40: 50000,
  41: 55000, 42: 60000, 43: 65000, 44: 70000, 45: 75000, 46: 80000, 47: 85000, 48: 90000, 49: 95000, 50: 100000,
  51: 110000, 52: 120000, 53: 130000, 54: 140000, 55: 150000, 56: 160000, 57: 170000, 58: 180000, 59: 190000, 60: 200000,
  61: 210000, 62: 220000, 63: 230000, 64: 240000, 65: 250000, 66: 260000, 67: 270000, 68: 280000, 69: 290000, 70: 300000,
  71: 310000, 72: 320000, 73: 330000, 74: 340000, 75: 350000, 76: 360000, 77: 370000, 78: 380000, 79: 390000, 80: 400000,
  81: 410000, 82: 420000, 83: 430000, 84: 440000, 85: 450000, 86: 460000, 87: 470000, 88: 480000, 89: 490000, 90: 500000,
  91: 510000, 92: 520000, 93: 530000, 94: 540000, 95: 550000, 96: 560000, 97: 570000, 98: 580000, 99: 590000, 100: 600000
}

// Calcula XP total acumulada necessária para alcançar determinado nível
const getTotalXPForLevel = (level) => {
  let total = 0
  for (let i = 2; i <= level; i++) {
    total += XP_TABLE[i] || 0
  }
  return total
}

// Migração: Corrige totalXP de Pokémon de backups antigos
const migratePokemonXP = (pokemon) => {
  if (!pokemon || !pokemon.level) return pokemon

  const expectedMinXP = getTotalXPForLevel(pokemon.level)
  const currentTotalXP = pokemon.totalXP || 0

  // Se totalXP é menor que o mínimo esperado para o nível, está usando sistema antigo
  if (currentTotalXP < expectedMinXP) {
    return {
      ...pokemon,
      totalXP: expectedMinXP // Reseta para o mínimo do nível (0/X progresso)
    }
  }

  return pokemon
}

// Funções auxiliares para XP
// Retorna XP necessária para ir do nível atual para o próximo
const getXPForNextLevel = (currentLevel) => {
  if (currentLevel >= 100) return 0
  return XP_TABLE[currentLevel + 1] || 0
}

// Retorna XP atual no nível (progresso no nível atual)
// totalXP armazena XP total acumulada, então subtraímos a XP total do nível atual
const getCurrentLevelXP = (pokemon) => {
  const totalXP = pokemon.totalXP || 0
  const level = pokemon.level || 1
  const xpForCurrentLevel = getTotalXPForLevel(level)
  return totalXP - xpForCurrentLevel
}

// Retorna progresso em porcentagem (0-100%)
const getXPProgress = (pokemon) => {
  const currentXP = getCurrentLevelXP(pokemon)
  const neededXP = getXPForNextLevel(pokemon.level)
  if (neededXP === 0) return 100 // Nível 100
  return Math.min(100, (currentXP / neededXP) * 100)
}

// Mapeamento de estilos de tipos Pokémon
const TYPE_STYLES = {
  'Normal': 'bg-pink-400',
  'normal': 'bg-pink-400',
  'Norma': 'bg-pink-400',
  'Fogo': 'bg-gradient-to-r from-orange-500 to-red-600',
  'Água': 'bg-blue-900',
  'água': 'bg-blue-900',
  'Planta': 'bg-green-700',
  'Elétrico': 'bg-yellow-400 text-gray-900',
  'Gelo': 'bg-blue-300 text-gray-900',
  'Lutador': 'bg-gradient-to-r from-pink-400 to-yellow-700',
  'Veneno': 'bg-gradient-to-r from-green-500 to-purple-600',
  'Venenoso': 'bg-gradient-to-r from-green-500 to-purple-600',
  'Terra': 'bg-yellow-700',
  'Voador': 'bg-gradient-to-r from-blue-400 to-white',
  'Psíquico': 'bg-gradient-to-r from-purple-300 to-purple-700',
  'Inseto': 'bg-gradient-to-r from-purple-500 to-green-500',
  'Pedra': 'bg-gray-500',
  'Fantasma': 'bg-gradient-to-r from-purple-700 to-black',
  'Dragão': 'bg-gradient-to-r from-blue-600 to-orange-500',
  'Sombrio': 'bg-black',
  'Noturno': 'bg-black',
  'Metal': 'bg-gradient-to-r from-slate-300 to-blue-400',
  'Fada': 'bg-gradient-to-r from-pink-400 via-purple-400 via-purple-300 to-yellow-300'
}

// Lista de tipos Pokémon (únicos, baseados em TYPE_STYLES)
const POKEMON_TYPES = [
  'Normal', 'Fogo', 'Água', 'Planta', 'Elétrico', 'Gelo',
  'Lutador', 'Veneno', 'Terra', 'Voador', 'Psíquico', 'Inseto',
  'Pedra', 'Fantasma', 'Dragão', 'Sombrio', 'Metal', 'Fada'
]

// Tabela de progressão de nível do treinador
const LEVEL_PROGRESSION = [
  { nivel: 0, totalAtributo: 66, totalTalento: 0 },
  { nivel: 1, totalAtributo: 67, totalTalento: 1 },
  { nivel: 2, totalAtributo: 68, totalTalento: 2 },
  { nivel: 3, totalAtributo: 69, totalTalento: 3 },
  { nivel: 4, totalAtributo: 70, totalTalento: 4 },
  { nivel: 5, totalAtributo: 71, totalTalento: 5 },
  { nivel: 6, totalAtributo: 72, totalTalento: 6 },
  { nivel: 7, totalAtributo: 72, totalTalento: 7 },
  { nivel: 8, totalAtributo: 73, totalTalento: 8 },
  { nivel: 9, totalAtributo: 73, totalTalento: 9 },
  { nivel: 10, totalAtributo: 75, totalTalento: 10 },
  { nivel: 11, totalAtributo: 75, totalTalento: 11 },
  { nivel: 12, totalAtributo: 76, totalTalento: 11 },
  { nivel: 13, totalAtributo: 76, totalTalento: 12 },
  { nivel: 14, totalAtributo: 78, totalTalento: 12 },
  { nivel: 15, totalAtributo: 78, totalTalento: 13 },
  { nivel: 16, totalAtributo: 79, totalTalento: 13 },
  { nivel: 17, totalAtributo: 79, totalTalento: 14 },
  { nivel: 18, totalAtributo: 81, totalTalento: 14 },
  { nivel: 19, totalAtributo: 81, totalTalento: 15 },
  { nivel: 20, totalAtributo: 82, totalTalento: 15 },
  { nivel: 21, totalAtributo: 82, totalTalento: 16 },
  { nivel: 22, totalAtributo: 84, totalTalento: 16 },
  { nivel: 23, totalAtributo: 84, totalTalento: 17 },
  { nivel: 24, totalAtributo: 85, totalTalento: 17 },
  { nivel: 25, totalAtributo: 85, totalTalento: 18 },
  { nivel: 26, totalAtributo: 87, totalTalento: 18 },
  { nivel: 27, totalAtributo: 87, totalTalento: 19 },
  { nivel: 28, totalAtributo: 88, totalTalento: 19 },
  { nivel: 29, totalAtributo: 88, totalTalento: 20 },
  { nivel: 30, totalAtributo: 90, totalTalento: 20 },
  { nivel: 31, totalAtributo: 90, totalTalento: 21 },
  { nivel: 32, totalAtributo: 91, totalTalento: 21 },
  { nivel: 33, totalAtributo: 91, totalTalento: 22 },
  { nivel: 34, totalAtributo: 93, totalTalento: 22 },
  { nivel: 35, totalAtributo: 93, totalTalento: 23 },
  { nivel: 36, totalAtributo: 94, totalTalento: 23 },
  { nivel: 37, totalAtributo: 94, totalTalento: 24 },
  { nivel: 38, totalAtributo: 96, totalTalento: 24 },
  { nivel: 39, totalAtributo: 96, totalTalento: 25 },
  { nivel: 40, totalAtributo: 97, totalTalento: 25 },
  { nivel: 41, totalAtributo: 97, totalTalento: 26 },
  { nivel: 42, totalAtributo: 99, totalTalento: 26 },
  { nivel: 43, totalAtributo: 99, totalTalento: 27 },
  { nivel: 44, totalAtributo: 100, totalTalento: 27 },
  { nivel: 45, totalAtributo: 100, totalTalento: 28 },
  { nivel: 46, totalAtributo: 102, totalTalento: 28 },
  { nivel: 47, totalAtributo: 102, totalTalento: 29 },
  { nivel: 48, totalAtributo: 103, totalTalento: 29 },
  { nivel: 49, totalAtributo: 103, totalTalento: 30 },
  { nivel: 50, totalAtributo: 106, totalTalento: 30 }
]

// Lista de espécies Pokémon - gerada dinamicamente do pokemonData
const POKEMON_SPECIES = pokedexData.map(p => p.nome).sort()

// Dados de Descritores
const DESCRITORES_DATA = [
  {
    nome: "Ameaça",
    efeito: "Este Golpe posiciona um efeito que cobre uma parte do campo de batalha. Alguns destes Golpes permitem usos subsequentes para tornar o terreno ainda mais perigoso."
  },
  {
    nome: "Barreira",
    efeito: "Uma Barreira é criada no campo de batalha. O comprimento da Barreira em metros é especificado após o Descritor. A Barreira pode ser contínua ou dividida em várias partes, mas uma parte não pode estar mais distante de um metro da mais próxima. A menos que especificado o contrário, a altura da Barreira é de dois metros e a espessura dela é de alguns centímetros, mas é possível acumular Barreiras vertical e horizontalmente para que fiquem mais altas ou espessas, respectivamente. Ao fim do encontro (ou em cinco minutos), as Barreiras desaparecem. Cada Barreira determinará se é possível ou não se deslocar através dela ou se é possível ou não mirar Golpes através dela."
  },
  {
    nome: "Clima",
    efeito: "O Clima é alterado para uma área."
  },
  {
    nome: "Cobertura",
    efeito: "Uma Cobertura encobre o alvo com uma camada de algum material, concedendo normalmente efeitos benéficos. Não é possível acumular os efeitos de mais de uma Cobertura simultaneamente. Se uma Cobertura concede resistência a um Tipo de dano, o alvo sofre metade do dano que normalmente sofreria por aquele Tipo de dano."
  },
  {
    nome: "Coluna",
    efeito: "Uma Coluna pode afetar várias criaturas e sempre será um Golpe À Distância. Para construir a área, desenhe uma linha do usuário do Golpe até um ponto dentro do alcance máximo. Depois crie um retângulo a partir desta linha, com largura igual ao valor especificado após o Descritor. As criaturas no retângulo serão afetadas."
  },
  {
    nome: "Dança",
    efeito: "Uma Dança deve ser feita."
  },
  {
    nome: "Empurrão",
    efeito: "Um Empurrão desloca o alvo um número de metros especificado após o Descritor se acertar. A direção para a qual o alvo é deslocado é a direção oposta do usuário do Empurrão. O alvo sofrerá dano extra – apresentado entre parênteses após o número de metros empurrado – se colidir com um Terreno Bloqueador e se colidir com outra criatura, caso em que ambos sofrem este dano. Dano sofrido em virtude do Empurrão (como por se chocar com algo ou por queda) é considerado sem Tipo sempre causando dano padrão, e não se aplicam os Atributos Defesa ou Defesa Especial."
  },
  {
    nome: "Exaustão",
    efeito: "Após usar o Golpe, o usuário está cansado e por isso não poderá usar Ações na rodada seguinte (ele ainda pode ser retornado à pokébola)."
  },
  {
    nome: "Explosão",
    efeito: "Uma Explosão pode afetar várias criaturas, especificamente todas as criaturas em uma área circular com centro no alvo. O raio do círculo é especificado após o Descritor."
  },
  {
    nome: "Impacto",
    efeito: "Um Impacto só pode ser usado se o usuário se deslocou em direção ao alvo durante a rodada. É possível se deslocar para longe do alvo e depois de volta no mesmo turno, desde que seu Deslocamento seja suficiente."
  },
  {
    nome: "Interceptação",
    efeito: "Uma Interceptação pode ser usada durante a ação de oponentes. Normalmente ela possuirá uma situação que permite ativá-la. Se nenhuma situação for especificada, ela pode ser usada quando quiser. Enquanto Interceptações podem ser usadas como Ação Livre fora de seu turno, não será possível usar sua Ação de Golpe naquela rodada."
  },
  {
    nome: "Interrupção",
    efeito: "Uma Interrupção pode ser usada durante a ação de oponentes. Normalmente ela possuirá uma situação que permite ativá-la. Se nenhuma situação for especificada, ela pode ser usada quando quiser. Enquanto Interrupções podem ser usadas como Ação Livre fora de seu turno, não será possível usar nenhuma Ação naquela rodada. Salvo para usar Finta, não é possível usar uma Interrupção contra Interceptações ou Interrupções."
  },
  {
    nome: "Investida",
    efeito: "Uma Investida pode afetar várias criaturas, especificamente uma linha reta de todo o Deslocamento. O usuário se desloca em linha reta o máximo de seu Deslocamento. Todas as criaturas atravessadas são acertadas, contudo a Dificuldade de Acurácia do Golpe aumenta em 2 para cada alvo além do primeiro. O usuário da Investida não pode terminar o seu Deslocamento em um local ocupado."
  },
  {
    nome: "Moral",
    efeito: "O efeito de um Golpe que afeta a Moral funcionará tendo o Golpe acertado ou errado."
  },
  {
    nome: "Preparo",
    efeito: "Um Golpe que precisa de Preparo demorará para ser ativado. Quando um destes Golpes é declarado, o turno do usuário imediatamente acaba. Na rodada seguinte, e consumindo a Ação de Golpe (ou Ação Padrão, se for um humano), o Golpe ocorrerá. Se o usuário do Golpe mudar de ideia sobre o que fazer durante a rodada de preparo, ele não é obrigado a continuar a executar o Golpe na rodada seguinte."
  },
  {
    nome: "Prisão",
    efeito: "Uma Prisão previne a fuga. Um alvo Preso não pode fugir, ser convocado de volta à pokébola nem se deslocar. Ele se liberta caso aquele que criou a Prisão vá embora, fique inconsciente ou seja convocado à pokébola."
  },
  {
    nome: "Rebote",
    efeito: "Um Rebote é um Golpe que possui consequências negativas ao próprio usuário, ou seja, que causará dano aousuário no processo. A quantidade de dano é proporcional ao dano causado (como metade, um terço, ou semelhantes), e não se somam danos por Condições ou por Empurrão. Este dano é considerado sem Tipo (sempre causando dano padrão) e não se aplicam Atributos Defesa ou Defesa Especial."
  },
  {
    nome: "Saraivada",
    efeito: "Uma Saraivada é um Golpe constituído de vários pequenos ataques – como múltiplos dardos ou socos. Cada Saraivada possui um número de ataques especificado após o Descritor e cada um destes ataques é resolvido como ataques separados para todos os fins: para cada um é feito um Teste de Acurácia – ativando quaisquer efeitos dependentes de Testes de Acurácia normalmente – e uma rolagem de dano própria – adicionando Ataque ou Ataque Especial e subtraindo Defesa e Defesa Especial normalmente."
  },
  {
    nome: "Som",
    efeito: "Este Golpe depende da produção de Som."
  }
]

// Dados de Tags de Concurso
const TAGS_CONCURSO_DATA = [
  {
    nome: "Abertura",
    pontuacaoBasal: "2d4",
    efeito: "+2d4 à Pontuação se for o primeiro da rodada."
  },
  {
    nome: "Abstração",
    pontuacaoBasal: "2d4",
    efeito: "A Expectativa do Jurado não poderá ser aumentada durante aquela rodada."
  },
  {
    nome: "Clímax",
    pontuacaoBasal: "0",
    efeito: "Dobre a Pontuação que ganhar na próxima rodada."
  },
  {
    nome: "Cobiça",
    pontuacaoBasal: "0",
    efeito: "Reduza à metade a Pontuação do competidor que Pontuou imediatamente antes e adicione a quantidade reduzida à sua Pontuação."
  },
  {
    nome: "Conquista",
    pontuacaoBasal: "2d4",
    efeito: "A Expectativa do Jurado não poderá ser reduzida durante aquela rodada."
  },
  {
    nome: "Constrangimento",
    pontuacaoBasal: "2d4",
    efeito: "Independentemente da Aptidão do Golpe, ele sempre reduz em 1 a Expectativa de todos os Jurados."
  },
  {
    nome: "Continuação",
    pontuacaoBasal: "0",
    efeito: "A Pontuação deste Golpe é 1d4 se for o primeiro ou o segundo da rodada; 2d4 se for o terceiro ou o quarto da rodada; ou 3d4 se for o último da rodada."
  },
  {
    nome: "Dedicatória",
    pontuacaoBasal: "1d4",
    efeito: "+3d4 se nenhum outro competidor escolheu o mesmo Jurado naquela rodada."
  },
  {
    nome: "Desfecho",
    pontuacaoBasal: "0",
    efeito: "A Pontuação deste Golpe se torna 15d4 se todos os competidores se apresentaram para o mesmo jurado. Só é possível usar um Golpe com este Descritor se o competidor for o quarto ou quinto na ordem da rodada."
  },
  {
    nome: "Despedida",
    pontuacaoBasal: "2d4",
    efeito: "Dobre a Pontuação se estiver na última rodada da Apelação."
  },
  {
    nome: "Encerramento",
    pontuacaoBasal: "2d4",
    efeito: "+2d4 à Pontuação se for o último da rodada."
  },
  {
    nome: "Entrada",
    pontuacaoBasal: "2d4",
    efeito: "Na próxima rodada, o competidor será o primeiro da rodada."
  },
  {
    nome: "Especial",
    pontuacaoBasal: "-",
    efeito: "Na próxima rodada, o competidor poderá escolher sua posição na ordem da rodada."
  },
  {
    nome: "Excentricidade",
    pontuacaoBasal: "2d4",
    efeito: "A Pontuação deste Golpe é Xd4, em que X é igual a 6 - a Expectativa do Jurado antes do Golpe."
  },
  {
    nome: "Extravagância",
    pontuacaoBasal: "-",
    efeito: "Independentemente da Aptidão do Golpe, ele sempre aumenta em 1 a Expectativa de todos os Jurados."
  },
  {
    nome: "Incentivo",
    pontuacaoBasal: "2d4",
    efeito: "+2d4 se o Golpe aumentar a Expectativa."
  },
  {
    nome: "Modelo",
    pontuacaoBasal: "0",
    efeito: "A Pontuação deste Golpe é Xd4, em que X é a Expectativa do Jurado antes do Golpe."
  },
  {
    nome: "Modéstia",
    pontuacaoBasal: "2d4",
    efeito: "Este Golpe pode ser usado várias rodadas seguidas e ainda obter o benefício de +1d4, desde que seja da Aptidão associada ao Concurso."
  },
  {
    nome: "Originalidade",
    pontuacaoBasal: "-",
    efeito: "Independentemente da Aptidão do Golpe, ele sempre aumenta em 2 a Expectativa do Jurado."
  },
  {
    nome: "Pausa",
    pontuacaoBasal: "2d4",
    efeito: "Na próxima rodada, o competidor será o último da rodada."
  },
  {
    nome: "Perspectiva",
    pontuacaoBasal: "2d4",
    efeito: "+3d4 se a Expectativa do Jurado atingiu a Expectativa máxima durante a rodada."
  },
  {
    nome: "Proveito",
    pontuacaoBasal: "1d4",
    efeito: "+3d4 à Pontuação se houve algum aumento de Expectativa nas últimas duas rodadas da Apelação."
  },
  {
    nome: "Reviravolta",
    pontuacaoBasal: "1d4",
    efeito: "+3d4 à Pontuação se possuir a menor Pontuação."
  },
  {
    nome: "Segurança",
    pontuacaoBasal: "3d4",
    efeito: "-"
  },
  {
    nome: "Sorteio",
    pontuacaoBasal: "2d4",
    efeito: "Na próxima rodada, a ordem será necessariamente sorteada."
  },
  {
    nome: "Surpresa",
    pontuacaoBasal: "2d4",
    efeito: "Este Golpe sempre é o primeiro da rodada, ignorando a ordem."
  }
]

// Dados de Atributos e Perícias
const ATRIBUTOS_PERICIAS_DATA = [
  {
    nome: "Saúde",
    explicacao: "Saúde serve um propósito especial, diferente dos outros cinco Atributos. A Saúde não possui Modificador. Em vez disso, ela é um Atributo que determina seus Pontos de Vida máximos, calculados da seguinte forma: (Nível + Saúde) multiplicado por 4. Como a Saúde sequer possui um Modificador, as Perícias de Saúde são competências possuídas. Não é necessário fazer rolagens delas:",
    pericias: [
      { nome: "Apneia", descricao: "Você pode prender sua respiração por até cinco minutos." },
      { nome: "Imunidade", descricao: "Seu sistema imunológico é muito eficiente. Você recebe apenas três quartos do dano que normalmente receberia por Queimaduras ou Venenos. Além disso, ao fazer testes para a Confusão, Congelamento, Paralisia ou Sono, receba +2 às rolagens." },
      { nome: "Jejum", descricao: "Sem esta Perícia, um humano pode sobreviver até quatro dias sem água e até duas semanas sem comida. Com esta Perícia, um personagem pode aguentar até uma semana sem água e até um mês sem comida." },
      { nome: "Resiliência", descricao: "Resiliência está ligada à durabilidade diante do trabalho físico. Você não corre o risco de perder Pontos de Vida mesmo após horas correndo, nadando ou trabalhando." }
    ]
  },
  {
    nome: "Ataque",
    explicacao: "O Modificador de Ataque (MA) é adicionado a qualquer ataque improvisado. Também, quando quiser uma proeza atlética, o Narrador definirá com qual Perícia de Ataque ela mais se aproxima.",
    pericias: [
      {
        nome: "Corrida",
        descricao: "Esta Perícia é usada para correr, permitindo recuperar o atraso em perseguições.",
        tabela: [
          { resultado: "1", efeito: "Tropeça e cai" },
          { resultado: "5", efeito: "Cãibra impõe -1 ao deslocamento" },
          { resultado: "10", efeito: "Deslocamento Normal" },
          { resultado: "15", efeito: "+2 ao deslocamento" },
          { resultado: "20", efeito: "+4 ao deslocamento" },
          { resultado: "30", efeito: "Deslocamento x4 (apenas terrestre)" }
        ]
      },
      {
        nome: "Força",
        descricao: "Auxilia a empurrar ou levantar objetos pesados. Um indivíduo destreinado pode suspender/empurrar metade de seu peso.",
        tabela: [
          { resultado: "1", efeito: "Derruba o objeto e fica atordoado" },
          { resultado: "5", efeito: "Força normal (metade do peso)" },
          { resultado: "10", efeito: "Igual a seu peso" },
          { resultado: "15", efeito: "Peso x2" },
          { resultado: "20", efeito: "Peso x3" },
          { resultado: "30", efeito: "Peso x4" }
        ]
      },
      { nome: "Intimidação", descricao: "Usada contra humanos e pokémons. Sempre rolada contra NPCs, quanto mais alto melhor." },
      {
        nome: "Salto",
        descricao: "Pular mais alto e mais distante. Humanos padrão: 60cm vertical.",
        tabela: [
          { resultado: "1", altura: "Tropeça e cai", horizontal: "-" },
          { resultado: "5", altura: "60cm", horizontal: "1,5m" },
          { resultado: "10", altura: "1,2m", horizontal: "3m" },
          { resultado: "15", altura: "1,5m", horizontal: "3,6m" },
          { resultado: "20", altura: "2,4m", horizontal: "6m" },
          { resultado: "30", altura: "3m", horizontal: "9m" }
        ]
      }
    ]
  },
  {
    nome: "Defesa",
    explicacao: "O Modificador de Defesa (MD) será usado sob a forma de Perícia de Defesa quando se realiza uma proeza de resistência, como resistir ao sono ou à fome. Normalmente, a Defesa será a maneira mais comum pela qual um personagem pode evitar sofrer dano aos seus Pontos de Vida.",
    pericias: [
      {
        nome: "Concentração",
        descricao: "Ajuda a manter foco mesmo ferido ou distraído.",
        tabela: [
          { resultado: "1", efeito: "Menor estímulo interrompe" },
          { resultado: "5", efeito: "Sofre até 10 dano" },
          { resultado: "10", efeito: "Sofre até 20 dano" },
          { resultado: "15", efeito: "Sofre até 50 dano" },
          { resultado: "20", efeito: "Sofre até 150 dano" },
          { resultado: "30", efeito: "Nenhum dano atrapalha" }
        ]
      },
      { nome: "Deflexão", descricao: "Interceptar objetos atirados (defletindo ou pegando). Não funciona contra Golpes pokémons não-físicos. Rolada contra NPCs, quanto mais alto melhor." },
      {
        nome: "Incansável",
        descricao: "Manter-se sem dormir. Teste após 24h sem sono e a cada 2h seguintes.",
        tabela: [
          { resultado: "1", efeito: "Adormece 1d4 horas" },
          { resultado: "5", efeito: "Perde 25% PV máximo" },
          { resultado: "10", efeito: "Perde 15% PV máximo" },
          { resultado: "15", efeito: "Perde 5% PV máximo" },
          { resultado: "20", efeito: "Não perde PV" },
          { resultado: "30", efeito: "Não perde PV e não testa 2h depois" }
        ]
      },
      {
        nome: "Regeneração",
        descricao: "Recuperação aprimorada durante descanso (padrão: 10% PV em 8h).",
        tabela: [
          { resultado: "1", efeito: "Nenhuma recuperação" },
          { resultado: "5", efeito: "Cura 10% PV máximo" },
          { resultado: "10", efeito: "Cura 15%" },
          { resultado: "15", efeito: "Cura 25%" },
          { resultado: "20", efeito: "Cura 50%" },
          { resultado: "30", efeito: "Cura total e remove aflições" }
        ]
      }
    ]
  },
  {
    nome: "Ataque Especial",
    explicacao: "Sempre que realizar um ato que exija conhecimento acadêmico, experiência ou inteligência geral, seu Narrador colocará este teste em um teste de Perícias de Ataque Especial.",
    pericias: [
      {
        nome: "Engenharia",
        descricao: "Compreensão e operação de máquinas.",
        tabela: [
          { resultado: "1", efeito: "Objeto estranho" },
          { resultado: "5", efeito: "Supõe propósito" },
          { resultado: "10", efeito: "Entende objetivo, liga/desliga" },
          { resultado: "15", efeito: "Opera e repara" },
          { resultado: "20", efeito: "Usa mesmo defeituoso" },
          { resultado: "30", efeito: "Entende plenamente e pode replicar" }
        ]
      },
      {
        nome: "História",
        descricao: "Conhecimento sobre o passado.",
        tabela: [
          { resultado: "1", efeito: "Não sabe nada" },
          { resultado: "5", efeito: "Ouviu falar mas não prestou atenção" },
          { resultado: "10", efeito: "Sabe sobre pessoas famosas e marcos" },
          { resultado: "15", efeito: "Sabe especificidades e detalhes" },
          { resultado: "20", efeito: "Sabe detalhes ignorados por livros" },
          { resultado: "30", efeito: "Como se tivesse presenciado" }
        ]
      },
      { nome: "Investigação", descricao: "Entender propósitos e procurar ativamente. Encontra objetos importantes rapidamente. Rolada contra cenário do Narrador." },
      { nome: "Programação", descricao: "Acesso a computadores e redes. Tarefas incluem: acessar dispositivos/computadores/redes, danificar programações, ativar/desativar remotos, alterar senhas, manipular hardware, ocultar evidências." }
    ]
  },
  {
    nome: "Defesa Especial",
    explicacao: "O Modificador de Defesa Especial (MDE) é usado para definir a percepção sensorial e a força da personalidade do personagem. Sempre que realizar um ato que exija blefar, mediar, convencer, achar contatos ou se portar com outros de maneira geral, pode usar uma Perícia de Defesa Especial.",
    pericias: [
      { nome: "Empatia", descricao: "Entender e amansar pokémons chateados (amedrontados, preocupados, zangados, agressivos). Usada apenas contra pokémons, não funciona em pokémons de alta Inteligência. Rolada contra NPCs." },
      {
        nome: "Manha",
        descricao: "Ter contatos e entender dinâmica local.",
        tabela: [
          { resultado: "1", efeito: "Não sabe nada" },
          { resultado: "5", efeito: "Ouviu sobre empresários" },
          { resultado: "10", efeito: "Sabe lugares inseguros e serviços questionáveis" },
          { resultado: "15", efeito: "Sabe grupos e onde agem" },
          { resultado: "20", efeito: "Sabe detalhes dos líderes" },
          { resultado: "30", efeito: "Pode se passar por membro" }
        ]
      },
      { nome: "Manipulação", descricao: "Convencer através de argumentos ou mentiras. Garante que alguém compre seu ponto de vista ou faça algo sugerido. Rolada contra NPCs." },
      { nome: "Percepção", descricao: "Notar coisas que passariam despercebidas. Rolada contra cenário do Narrador ou contra Furtividade." }
    ]
  },
  {
    nome: "Velocidade",
    explicacao: "Sempre que um ato exigir precisão, equilíbrio, flexibilidade ou rapidez, seu Narrador pode pedir que você faça um teste de uma Perícia de Velocidade. Adicione seu Modificador de Velocidade (MV) a este teste.",
    pericias: [
      {
        nome: "Acrobacia",
        descricao: "Equilíbrio, escalar, atravessar locais oscilantes.",
        tabela: [
          { resultado: "1", equilibrio: "Você cai", escalada: "-" },
          { resultado: "5", equilibrio: "Superfície larga", escalada: "Escada comum" },
          { resultado: "10", equilibrio: "Saliência/tronco", escalada: "Escala 3m" },
          { resultado: "15", equilibrio: "Caminhos estreitos", escalada: "Escala prédio" },
          { resultado: "20", equilibrio: "Sem problemas", escalada: "Sem problemas" }
        ]
      },
      { nome: "Furtividade", descricao: "Mover-se sorrateiramente, deslocar silenciosamente e se esconder. Rolada contra humanos e pokémons." },
      {
        nome: "Performance",
        descricao: "Tocar instrumentos, cantar, dançar ou atuar.",
        tabela: [
          { resultado: "1", efeito: "Medo de palco" },
          { resultado: "5", efeito: "Passos/notas perdidos" },
          { resultado: "10", efeito: "Salva de palmas" },
          { resultado: "15", efeito: "Ovação de pé (até 100 créditos diários)" },
          { resultado: "20", efeito: "Gritos por minutos, desempenho primoroso (até 1000 créditos diários), fama local" },
          { resultado: "30", efeito: "Inspira movimentos sociais" }
        ]
      },
      { nome: "Prestidigitação", descricao: "Movimento manual rápido e discreto. Bater carteiras, esconder coisas, encantar com mágica. Rolada contra humanos e pokémons." }
    ]
  }
]

// Dados de Capacidades
const CAPACIDADES_DATA = {
  "Força": {
    descricao: "A Força representa a potência muscular do pokémon. Esta Capacidade possui um valor que varia de 1 a 10, correspondente ao peso que este pokémon pode suspender fisicamente. O peso dado é uma média, e dependendo de quão bem treinados são os seus pokémons, eles podem ser capazes de erguer um pouco mais que a média. Com base em quanto eles podem levantar, é possível prever o quanto eles podem empurrar ou quanta força eles podem colocar em seus ataques. Se um pokémon for alimentado e treinado apropriadamente tendo em vista o aumento de sua massa muscular, o Narrador pode permitir o aumento da Força de um pokémon em 1.",
    tabela: [
      { força: "1", peso: "5 kg" },
      { força: "2", peso: "23 kg" },
      { força: "3", peso: "45 kg" },
      { força: "4", peso: "90 kg" },
      { força: "5", peso: "158 kg" },
      { força: "6", peso: "227 kg" },
      { força: "7", peso: "340 kg" },
      { força: "8", peso: "455 kg" },
      { força: "9", peso: "1135 kg" },
      { força: "10", peso: "1815 kg" }
    ]
  },
  "Inteligência": {
    descricao: "A Capacidade inteligência é quantificada de 1 a 7, representando o intelecto do pokémon. A Inteligência é uma expectativa média de todos os membros daquela espécie pokémon. Quanto mais esperto for o pokémon, mais fácil será que aja por conta própria se não for possível comandá-lo. Isso também significa que as espécies de pokémons mais inteligentes são uma ameaça muito maior, pois planejam e desenvolvem sociedades completamente próprias.",
    tabela: [
      { inteligência: "1", intelecto: "Vegetal", pensamentos: "Incapaz dos mais simples pensamentos" },
      { inteligência: "2", intelecto: "Animal", pensamentos: "Autoconsciente" },
      { inteligência: "3", intelecto: "Animal Inteligente", pensamentos: "Não desenvolve tarefas por si próprio, mas é capaz de seguir a liderança e as ordens alheias" },
      { inteligência: "4", intelecto: "Deficiente", pensamentos: "Pode criar e usar Ferramentas" },
      { inteligência: "5", intelecto: "Humano", pensamentos: "Como uma pessoa comum" },
      { inteligência: "6", intelecto: "Superior", pensamentos: "Pode agir como um líder" },
      { inteligência: "7", intelecto: "Gênio", pensamentos: "Exemplos: calcula como supercomputadores e falar muitas línguas diferentes" }
    ]
  },
  "Salto": {
    descricao: "Esta Capacidade é quantificada de 1 a 10, indicando a altura máximo que o pokémon é capaz de saltar no ar. Se o seu Pokémon usar sua Capacidade Salto durante uma rodada de um encontro, ele será considerado como usando seu Deslocamento para aquela rodada (e se lembre de que não se pula apenas para cima).",
    tabela: [
      { salto: "1", altura: "1 m" },
      { salto: "2", altura: "2 m" },
      { salto: "3", altura: "3 m" },
      { salto: "4", altura: "4,5 m" },
      { salto: "5", altura: "6 m" },
      { salto: "6", altura: "7,6 m" },
      { salto: "7", altura: "10,6 m" },
      { salto: "8", altura: "15,2 m" },
      { salto: "9", altura: "21 m" },
      { salto: "10", altura: "30 m" }
    ]
  },
  "Adesão": "Permite tratar terreno vertical e tetos como Terreno Regular, usando Deslocamento Terrestre, mesmo em superfícies lisas.",
  "Afundamento": "O pokémon não pode nadar nem se mover na água. A cada rodada submerso perde 25% dos PV máximos e pode morrer por sufocamento.",
  "Alcance": "Permite realizar ataques corpo a corpo contra alvos a até 5 metros de distância, geralmente devido a tamanho, membros extensíveis ou arremesso.",
  "Amorfia": "O pokémon não possui forma consistente, podendo se liquefazer, se esticar e atravessar frestas ou fechaduras.",
  "Aura": "Permite ler e manipular auras. A cor indica emoção dominante e escuridão indica más intenções. Não permite leitura de mentes.",
  "Bruxaria": "Permite amaldiçoar criaturas merecedoras (traidores, criminosos etc.). A maldição persiste até redenção ou reparação.",
  "Calor": "O pokémon é sempre quente ao toque.",
  "Camuflagem": "Usuário avançado de Silêncio. Golpes à distância não podem alvocá-lo em Terreno Acidentado, e ataques contra ele têm Dificuldade de Acurácia +2.",
  "Combustão": "Permite produzir e controlar chamas, desde pequenas até grandes explosões de fogo.",
  "Congelação": {
    descricao: "Permite congelar terreno usando Ação de Movimento em rodadas alternadas.",
    tabela: [
      { resultado: "1", área: "1 m²" },
      { resultado: "6", área: "5 m²" },
      { resultado: "9", área: "7 m²" },
      { resultado: "12", área: "10 m²" },
      { resultado: "15", área: "15 m²" },
      { resultado: "18", área: "20 m²" },
      { resultado: "20", área: "30 m²" }
    ]
  },
  "Eletricidade": "Produz eletricidade controlada. Pode recarregar dispositivos com rolagem 1d20 (sucesso com 13+).",
  "Encolhimento": "Reduz o tamanho para até 75% sem alterar peso. Ataques contra ele têm Dificuldade de Acurácia +3.",
  "Escalada": "Trata terreno vertical como Terreno Regular, exceto superfícies lisas.",
  "Família": {
    descricao: "Machos e fêmeas são espécies distintas mas contam como uma só para procriação.",
    tabela: [
      { par: "Ilumise / Volbeat" },
      { par: "Latias / Latios" },
      { par: "Lunatone / Solrock" },
      { par: "Miltank / Tauros" },
      { par: "Plusle / Minun" },
      { par: "Nidoran♀ / Nidorina / Nidoqueen vs Nidoran♂ / Nidorino / Nidoking" },
      { par: "Smoochum / Jynx vs Mime Jr. / Mr. Mime" },
      { par: "Vullaby / Mandibuzz vs Rufflet / Braviary" }
    ]
  },
  "Faro": {
    descricao: "Permite rastrear odores. Uso: 1 vez por hora.",
    tabela: [
      { resultado: "11+", condição: "Após cheirar alvo ou pertence" },
      { resultado: "16+", condição: "Odor aleatório" },
      { resultado: "20", condição: "Odor específico sem referência" }
    ]
  },
  "Fiação": "Permite disparar fios (seda, teia, vinha) até 10m usando Ação de Movimento. Teste de Acurácia 6 se usado contra criaturas.",
  "Frio": "O pokémon é sempre frio ao toque.",
  "Geleira": "Trata Terreno Gelado como Terreno Regular se vantajoso.",
  "Guelras": "Permite respirar debaixo d'água indefinidamente.",
  "Hierarquia": "Estrutura social rígida. Formas menos evoluídas tornam-se Prestativas. Pode causar submissão ou hostilidade conforme diferença de níveis.",
  "Incubação": "Reduz em 2 horas por dia o tempo de eclosão de ovos mantidos com o pokémon.",
  "Ininteligível": "A mente do pokémon não pode ser lida.",
  "Intangibilidade": "Permite atravessar terreno bloqueador e paredes por até 30 segundos (5 rodadas). Não pode atacar enquanto intangível.",
  "Invisibilidade": "Permite ficar invisível por até 4 minutos. Ataques contra ele têm Dificuldade de Acurácia +4.",
  "Luminar": "Emite luz corporal, podendo atrair ou afastar pokémons.",
  "Magnetismo": "Manipula campos magnéticos, atrai ou repele metais e identifica o norte magnético.",
  "Manancial": "Produz água potável em intensidades variadas.",
  "Materialização": "Cria rochas adjacentes ao corpo. Para cada 2,5 kg criados perde 2 PV. Máximo de 25 kg por rodada.",
  "Obrigatoriedade": "Determina uma Habilidade fixa obrigatória. Pode substituir escolha de Habilidade inicial ou a segunda Habilidade no nível 40.",
  "Onirismo": "Produz material onírico usado pela máquina do Hipnólogo.",
  "Presciência": "Recebe visões do futuro de forma não controlada, determinadas pelo Narrador.",
  "Rebento": "Acelera crescimento vegetal. 1 metro a cada 6 segundos, até 125% do tamanho natural. Custa 1 PV a cada 2 rodadas.",
  "Repeteco": "Exclusivo de Wobbuffet. Permite Contra-Ataque e Escudo Espelho como Rodada Sim/Rodada Não, com penalidades acumulativas.",
  "Secreção": "Exclusivo de Shuckle. Frutas viram Concentrados após 24h e Doce Raro após 2 semanas.",
  "Sedução": "Produz feromônios ou odores agradáveis que atraem pokémons selvagens.",
  "Silêncio": "Não produz som ao se mover. Golpes à distância não podem alvocá-lo em Terreno Acidentado.",
  "Telecinesia": "Move objetos à distância de até o Nível do pokémon, com peso máximo de 2,5 kg por Nível.",
  "Telepatia": "Lê pensamentos superficiais e projeta pensamentos. Não funciona se diferença de Inteligência for maior que 1.",
  "Térreo": "Transforma terreno adjacente em Terreno Acidentado ou Regular em rodadas alternadas.",
  "Tumefação": "Aumenta tamanho até 125%. Ataques contra ele têm Dificuldade de Acurácia -3, mas ele se torna Terreno Bloqueador.",
  "Vento": "Cria rajadas de vento variando de brisa leve a fortes correntes.",
  "Virtualidade": "Pode entrar em dispositivos eletrônicos, viajar por cabos, ler dados 1 vez/dia e tentar controlar aparelhos (1d20, sucesso 16+)."
}

const CAPACIDADES_NAMES = Object.keys(CAPACIDADES_DATA).sort()

// Dados de Golpes - importados do arquivo golpesData.js
const GOLPES_DATA = GOLPES_DATA_IMPORTED

const GOLPES_NAMES = Object.keys(GOLPES_DATA).sort()

// Dados de Habilidades - importados do arquivo habilidadesData.js
const HABILIDADES_DATA = HABILIDADES_DATA_IMPORTED || {}
const HABILIDADES_NAMES = HABILIDADES_NAMES_IMPORTED || []

// Dados de Características e Talentos - importados do arquivo caracteristicasETalentosData.js
const CARACTERISTICAS_DATA = CARACTERISTICAS_DATA_IMPORTED
const TALENTOS_DATA = TALENTOS_DATA_IMPORTED
const TALENTOS_NAMES = TALENTOS_NAMES_IMPORTED

// Dados de Pokébolas
const POKEBALLS_LIST = [
  'Custom Pokeball',
  'Pokeball', 'Greatball', 'Ultraball', 'Masterball', 'Alphaball', 'Beastball', 'Cherishball',
  'Diveball', 'Dreamball', 'Duskball', 'Fastball', 'Featherball', 'Friendball', 'Healball',
  'Heavyball', 'Leadenball', 'Levelball', 'Loveball', 'Lunarball', 'Lureball', 'Luxuryball',
  'Nestball', 'Netball', 'Parkball', 'Premierball', 'Quickball', 'Repeatball',
  'Safariball', 'Sportball', 'Timerball', 'NeoGenBall', 'Noryball'
]

// Mapa de modificadores de captura por pokébola
const POKEBALL_MODIFIERS = {
  'Customball': 'custom',
  'Custom Pokeball': 'custom', // Pokébola customizada da lista
  'Pokeball': ['+15'],
  'Pokébola': ['+15'], // Nome usado na Pokéloja
  'Greatball': ['+5'],
  'Ultraball': ['-5'],
  'Masterball': ['auto'],
  'Safariball': ['0'],
  'Levelball': ['+5', '-15'],
  'Lureball': ['+0', '-15'],
  'Lunarball': ['0', '-15'],
  'Friendball': ['-5'],
  'Loveball': ['0', '-15'],
  'Heavyball': ['+5', '0', '-5', '-10', '-15', '-20'],
  'Fastball': ['+5', '-15'],
  'Sportball': ['0'],
  'Premierball': ['0'],
  'Repeatball': ['+10', '-15'],
  'Timerball': ['+5', '0', '-5', '-10', '-15', '-20'],
  'Nestball': ['0', '-15'],
  'Netball': ['0', '-15'],
  'Diveball': ['+5', '-15'],
  'Luxuryball': ['-5'],
  'Healball': ['-5'],
  'Quickball': ['-20', '-15', '-10'],
  'Duskball': ['0', '-15'],
  'Cherishball': ['-5'],
  'Parkball': ['0'],
  'Dreamball': ['0'],
  'Beastball': ['+45', '-50'],
  'NeoGenBall': ['0'], // Pokébola especial
  'Noryball': ['-5'], // Pokébola especial
  'Featherball': ['+5', '-5'], // +5, ou -5 se o alvo possuir mais de 15 de velocidade ou voar/flutuar
  'Leadenball': ['+5', '-15'], // +5, caso o treinador esteja escondido, -15
  'Alphaball': ['+10', '-15'] // +10, ou -15 se o pokémon for Alpha
}

// Lista de pokébolas para o PC (com Custom Pokeball 2)
const POKEBALLS_PC_LIST = [
  'Custom Pokeball 2',
  'Pokeball', 'Greatball', 'Ultraball', 'Masterball', 'Alphaball', 'Beastball', 'Cherishball',
  'Diveball', 'Dreamball', 'Duskball', 'Fastball', 'Friendball', 'Healball',
  'Heavyball', 'Leadenball', 'Levelball', 'Loveball', 'Lunarball', 'Lureball', 'Luxuryball',
  'Nestball', 'Netball', 'Parkball', 'Premierball', 'Quickball', 'Repeatball',
  'Safariball', 'Sportball', 'Timerball', 'NeoGenBall', 'Noryball'
]

// Naturezas para geração de Pokémon (Hub de Troca)
const NATURES = [
  {nome:"Ousada", up:"Saúde", down:"Ataque", gosto:"Nenhum", desgosto:"Picante"},
  {nome:"Dócil", up:"Saúde", down:"Defesa", gosto:"Nenhum", desgosto:"Azedo"},
  {nome:"Orgulhosa", up:"Saúde", down:"Ataque Especial", gosto:"Nenhum", desgosto:"Seco"},
  {nome:"Excêcentrica", up:"Saúde", down:"Defesa Especial", gosto:"Nenhum", desgosto:"Amargo"},
  {nome:"Preguiçosa", up:"Saúde", down:"Velocidade", gosto:"Nenhum", desgosto:"Doce"},
  {nome:"Desesperada", up:"Ataque", down:"Saúde", gosto:"Picante", desgosto:"Nenhum"},
  {nome:"Solitária", up:"Ataque", down:"Defesa", gosto:"Picante", desgosto:"Azedo"},
  {nome:"Firme", up:"Ataque", down:"Ataque Especial", gosto:"Picante", desgosto:"Seco"},
  {nome:"Travessa", up:"Ataque", down:"Defesa Especial", gosto:"Picante", desgosto:"Amargo"},
  {nome:"Brava", up:"Ataque", down:"Velocidade", gosto:"Picante", desgosto:"Doce"},
  {nome:"Rígida", up:"Defesa", down:"Saúde", gosto:"Azedo", desgosto:"Nenhum"},
  {nome:"Arrojada", up:"Defesa", down:"Ataque", gosto:"Azedo", desgosto:"Picante"},
  {nome:"Endiabrada", up:"Defesa", down:"Ataque Especial", gosto:"Azedo", desgosto:"Seco"},
  {nome:"Negligente", up:"Defesa", down:"Defesa Especial", gosto:"Azedo", desgosto:"Amargo"},
  {nome:"Relaxada", up:"Defesa", down:"Velocidade", gosto:"Azedo", desgosto:"Doce"},
  {nome:"Tímida", up:"Ataque Especial", down:"Saúde", gosto:"Seco", desgosto:"Nenhum"},
  {nome:"Modesta", up:"Ataque Especial", down:"Ataque", gosto:"Seco", desgosto:"Picante"},
  {nome:"Amável", up:"Ataque Especial", down:"Defesa", gosto:"Seco", desgosto:"Azedo"},
  {nome:"Imprudente", up:"Ataque Especial", down:"Defesa Especial", gosto:"Seco", desgosto:"Amargo"},
  {nome:"Quieta", up:"Ataque Especial", down:"Velocidade", gosto:"Seco", desgosto:"Doce"},
  {nome:"Enjoada", up:"Defesa Especial", down:"Saúde", gosto:"Amargo", desgosto:"Nenhum"},
  {nome:"Calma", up:"Defesa Especial", down:"Ataque", gosto:"Amargo", desgosto:"Picante"},
  {nome:"Gentil", up:"Defesa Especial", down:"Defesa", gosto:"Amargo", desgosto:"Azedo"},
  {nome:"Meticulosa", up:"Defesa Especial", down:"Ataque Especial", gosto:"Amargo", desgosto:"Seco"},
  {nome:"Atrevida", up:"Defesa Especial", down:"Velocidade", gosto:"Amargo", desgosto:"Doce"},
  {nome:"Séria", up:"Velocidade", down:"Saúde", gosto:"Doce", desgosto:"Nenhum"},
  {nome:"Medrosa", up:"Velocidade", down:"Ataque", gosto:"Doce", desgosto:"Picante"},
  {nome:"Apressada", up:"Velocidade", down:"Defesa", gosto:"Doce", desgosto:"Azedo"},
  {nome:"Alegre", up:"Velocidade", down:"Ataque Especial", gosto:"Doce", desgosto:"Seco"},
  {nome:"Ingênua", up:"Velocidade", down:"Defesa Especial", gosto:"Doce", desgosto:"Amargo"},
  {nome:"Comedida", up:"Nenhum", down:"Nenhum", gosto:"Nenhum", desgosto:"Nenhum"},
  {nome:"Chata", up:"Nenhum", down:"Nenhum", gosto:"Nenhum", desgosto:"Nenhum"},
  {nome:"Paciente", up:"Nenhum", down:"Nenhum", gosto:"Nenhum", desgosto:"Nenhum"},
  {nome:"Sensata", up:"Nenhum", down:"Nenhum", gosto:"Nenhum", desgosto:"Nenhum"},
  {nome:"Estoica", up:"Nenhum", down:"Nenhum", gosto:"Nenhum", desgosto:"Nenhum"}
]

// Funções auxiliares para geração de Pokémon (Hub de Troca)
const applyNature = (baseStats, nature) => {
  const modified = {...baseStats}
  const attrMap = {
    "Saúde": "saude", "Ataque": "ataque", "Defesa": "defesa",
    "Ataque Especial": "ataqueEspecial", "Defesa Especial": "defesaEspecial", "Velocidade": "velocidade"
  }
  if (nature.up !== "Nenhum") {
    const key = attrMap[nature.up]
    modified[key] += (nature.up === "Saúde") ? 1 : 2
  }
  if (nature.down !== "Nenhum") {
    const key = attrMap[nature.down]
    modified[key] = Math.max(1, modified[key] - ((nature.down === "Saúde") ? 1 : 2))
  }
  return modified
}

const getStatHierarchy = (stats) => {
  const attrs = [
    {key: "saude", valor: stats.saude},
    {key: "ataque", valor: stats.ataque},
    {key: "defesa", valor: stats.defesa},
    {key: "ataqueEspecial", valor: stats.ataqueEspecial},
    {key: "defesaEspecial", valor: stats.defesaEspecial},
    {key: "velocidade", valor: stats.velocidade}
  ]
  return attrs.sort((a, b) => b.valor - a.valor)
}

const distributePoints = (baseStats, hierarchy, level) => {
  const points = level - 1
  const current = {...baseStats}
  if (points <= 0) return current
  const order = hierarchy.map(a => a.key)
  const values = {...current}
  for (let p = 0; p < points; p++) {
    const valid = []
    for (let i = 0; i < order.length; i++) {
      const key = order[i]
      const newVal = values[key] + 1
      let ok = true
      if (i > 0 && newVal >= values[order[i - 1]]) ok = false
      if (i < order.length - 1 && newVal <= values[order[i + 1]]) ok = false
      if (ok) valid.push(key)
    }
    if (valid.length > 0) {
      const pick = valid[Math.floor(Math.random() * valid.length)]
      values[pick] += 1
      current[pick] += 1
    } else {
      values[order[0]] += 1
      current[order[0]] += 1
      for (let i = 1; i < order.length; i++) {
        if (values[order[i]] >= values[order[i - 1]]) {
          values[order[i]] = values[order[i - 1]] - 1
          current[order[i]] = values[order[i - 1]] - 1
        }
      }
    }
  }
  return current
}

const generateGender = (genderRatio) => {
  if (!genderRatio || genderRatio === 'assexuado') return 'assexuado'
  if (genderRatio === '50_50') return Math.random() < 0.5 ? 'Macho' : 'Fêmea'
  if (genderRatio === '87_12') return Math.random() < 0.875 ? 'Macho' : 'Fêmea'
  if (genderRatio === '75_25') return Math.random() < 0.75 ? 'Macho' : 'Fêmea'
  if (genderRatio === '25_75') return Math.random() < 0.25 ? 'Macho' : 'Fêmea'
  if (genderRatio === '100_0') return 'Macho'
  if (genderRatio === '0_100') return 'Fêmea'
  return 'assexuado'
}

// Frases aleatórias para quando não há Held Item
const NO_HELD_ITEM_PHRASES = [
  "Sua mochila não está muito pesada?",
  "Me dá um trocado?",
  "O que você vai me dar agora?",
  "Deixa eu levar sua mochila!",
  "Vou segurar essa Masterball aqui."
]

// Itens Chave disponíveis
const KEY_ITEMS_LIST = [
  'Custom Pokeball',
  'Custom Item Chave',
  ...POKEBALLS_LIST.slice(1),
  'Pokeovo',
  // Corredor de Cura
  'Potion',
  'Superpotion',
  'Hiperpotion',
  'Revive',
  'Antidoto',
  'Antiparalisante',
  'Despertador',
  'Anticongelante',
  'Moomoo Milk',
  'Pó Energizante',
  'Raiz Energizante',
  'Panaceia',
  'Pó Curativo',
  'Erva da Sobrevida',
  'Água Solarizada',
  'Refri',
  'Limonada',
  'Lava Cookie',
  'Barra de Pokechocolate Radical',
  'Bala de Coração',
  'Spray para Queimaduras',
  'Concentrado de Sálvia',
  'Poção da Paciência',
  'Poção da Braveza',
  // Corredor de Repelente
  'Repel',
  'Super Repel',
  'Max Repel',
  'Repel Off',
  // Corredor de Suplemento
  'Hp-up',
  'Proteína',
  'Ferro',
  'Cálcio',
  'Zinco',
  'Carburante',
  'PP-up',
  'Rare Candy',
  'Éter',
  'Elixir',
  'Suplemento Sortido',
  'Doce não tão raro',
  // Corredor de Melhoradores
  'X-Ataque',
  'X-Defesa',
  'X-Ataque Especial',
  'X-Defesa Especial',
  'X-Velocidade',
  'X-Acurácia',
  'Golpe Atroz',
  'Guarda Especial',
  'Reforço Natural',
  'Raiz Revigorante',
  'Fumo Rápido',
  'Veneno Sintético',
  'Shiny Charm',
  // Corredor de Apricorns e Bonsais
  'Apricorn Vermelha',
  'Apricorn Verde',
  'Apricorn Preta',
  'Apricorn Rosa',
  'Apricorn Branca',
  'Apricorn Azul',
  'Apricorn Amarela',
  'Apricorn Arco-íris',
  'Bonsai Vermelho',
  'Bonsai Verde',
  'Bonsai Azul',
  'Bonsai Preto',
  'Bonsai Amarelo',
  'Bonsai Rosa',
  'Bonsai Branco',
  'Bonsai Arco-íris',
  // Corredor de Ração
  'Ração Humana',
  'Ração Vegetariana',
  'Ração Carnívora',
  'Ração Onívora',
  // Corredor de Frutas
  'Persim', 'Wepear', 'Pinap', 'Pamtre', 'Bluk', 'Nanab', 'Durin', 'Razz', 'Oran', 'Nomel',
  'Magost', 'Watmel', 'Spelon', 'Cornn', 'Belue', 'Rabuta',
  'Figy', 'Aguav', 'Wiki', 'Iapapa', 'Mago', 'Sitrus',
  'Chesto', 'Cheri', 'Rawst', 'Aspear', 'Pecha',
  'Kebia', 'Charti', 'Haban', 'Coba', 'Babiri', 'Occa', 'Shuca', 'Colbur', 'Chople',
  'Yache', 'Wacan', 'Kasib', 'Passho', 'Payapa', 'Tanga', 'Roseli', 'Chilan', 'Rindo',
  'Starf', 'Apicot', 'Lansat', 'Liechi', 'Ganlon', 'Petaya', 'Salac',
  'Kelpsy', 'Hondew', 'Qualot', 'Pomeg', 'Tamato', 'Grepa',
  'Lum', 'Leppa',
  'Enigma', 'Micle', 'Kee', 'Jaboca', 'Maranga', 'Rowap', 'Custap',
  // Corredor de Puffins
  'Puffin Picante', 'Puffin Picante Seco', 'Puffin Picante Doce', 'Puffin Picante Amargo', 'Puffin Picante Azedo',
  'Puffin Seco', 'Puffin Seco Picante', 'Puffin Seco Doce', 'Puffin Seco Amargo', 'Puffin Seco Azedo',
  'Puffin Doce', 'Puffin Doce Picante', 'Puffin Doce Seco', 'Puffin Doce Amargo', 'Puffin Doce Azedo',
  'Puffin Amargo', 'Puffin Amargo Picante', 'Puffin Amargo Seco', 'Puffin Amargo Doce', 'Puffin Amargo Azedo',
  'Puffin Azedo', 'Puffin Azedo Picante', 'Puffin Azedo Seco', 'Puffin Azedo Doce', 'Puffin Azedo Amargo',
  // Corredor de Pokesucos
  'Pokesuco Vermelho',
  'Pokesuco Verde',
  'Pokesuco Amarelo',
  'Pokesuco Azul',
  'Pokesuco Rosa',
  'Pokesuco Branco',
  'Pokesuco Arco-íris',
  // Peças de pokébola quebradas
  'Peças de Pokeball',
  'Peças de Greatball',
  'Peças de Ultraball',
  'Peças de Beastball',
  'Peças de Cherishball',
  'Peças de Diveball',
  'Peças de Dreamball',
  'Peças de Duskball',
  'Peças de Fastball',
  'Peças de Featherball',
  'Peças de Friendball',
  'Peças de Healball',
  'Peças de Heavyball',
  'Peças de Leadenball',
  'Peças de Levelball',
  'Peças de Loveball',
  'Peças de Lunarball',
  'Peças de Lureball',
  'Peças de Luxuryball',
  'Peças de Neogenball',
  'Peças de Nestball',
  'Peças de Netball',
  'Peças de Noryball',
  'Peças de Parkball',
  'Peças de Premierball',
  'Peças de Quickball',
  'Peças de Repeatball',
  'Peças de Safariball',
  'Peças de Sportball',
  'Peças de Timerball'
]

// Lista de imagens de Pokeovo (será randomizada quando adicionar)
const POKEOVO_IMAGES = [
  '/pokeovo a.png',
  '/pokeovo b.png',
  '/pokeovo c.png',
  '/pokeovo d.png',
  '/pokeovo e.png',
  '/pokeovo f.png',
  '/pokeovo g.png',
  '/pokeovo h.png',
  '/pokeovo i.png',
  '/pokeovo j.png'
]

// Mapeamento de peças de pokébola quebradas para seus arquivos de imagem
const BROKEN_POKEBALL_IMAGES = {
  'Pokeball': '/pokebolaquebrada.png',
  'Greatball': '/greatballquebrada.png',
  'Ultraball': '/ultraballquebrada.png',
  'Beastball': '/beastballquebrada.png',
  'Cherishball': '/cherisballquebrada.png',
  'Diveball': '/diveballquebrada.png',
  'Dreamball': '/dreamballquebrada.png',
  'Duskball': '/duskballquebrada.png',
  'Fastball': '/fastballquebrada.png',
  'Featherball': '/featherballquebrada.png',
  'Friendball': '/friendballquebrada.png',
  'Healball': '/healballquebrada.png',
  'Heavyball': '/heavyballquebrada.png',
  'Leadenball': '/leadenballquebrada.png',
  'Levelball': '/levelballquebrada.png',
  'Loveball': '/loveballquebrada.png',
  'Lunarball': '/lunarbalballquebrada.png',
  'Lureball': '/lureballballquebrada.png',
  'Luxuryball': '/luxuryballquebrada.png',
  'Neogenball': '/neogenballquebrada.png',
  'Nestball': '/nestballquebrada.png',
  'Netball': '/netballquebrada.png',
  'Noryball': '/noryballquebrada.png',
  'Parkball': '/parkballquebrada.png',
  'Premierball': '/premierballquebrada.png',
  'Quickball': '/quickballquebrada.png',
  'Repeatball': '/repeatballquebrada.png',
  'Safariball': '/safariballquebrada.png',
  'Sportball': '/sportballquebrada.png',
  'Timerball': '/timerballquebrada.png'
}

// Helper para obter os ícones de dieta de um Pokémon
const DIET_IMAGE_MAP = {
  'Autônomo': '/dietas/autonomo.png',
  'Carnívoro': '/dietas/carnivoro.png',
  'Eletrizante': '/dietas/eletrizante.png',
  'Fotossintetizante': '/dietas/fotossintetizante.png',
  'Herbívoro': '/dietas/herbívoro.png',
  'Minerávoro': '/dietas/mineravoro.png',
  'Onívoro': '/dietas/onivoro.png',
}

const FLAVOR_COLORS = {
  'Azedo': 'text-yellow-500',
  'Seco': 'text-blue-400',
  'Doce': 'text-pink-400',
  'Amargo': 'text-green-500',
  'Picante': 'text-red-500',
}

const FLAVOR_ABBR = {
  'Amargo': { abbr: 'Am', color: 'text-green-500' },
  'Seco':   { abbr: 'Sc', color: 'text-blue-400' },
  'Doce':   { abbr: 'Dc', color: 'text-pink-400' },
  'Picante':{ abbr: 'Pc', color: 'text-red-500' },
  'Azedo':  { abbr: 'Az', color: 'text-yellow-500' },
}

const renderDescriptionWithFlavors = (description) => {
  const parts = description.split(/(Azedo|Seco|Doce|Amargo|Picante)/g)
  return parts.map((part, i) =>
    FLAVOR_COLORS[part]
      ? <span key={i} className={`font-semibold ${FLAVOR_COLORS[part]}`}>{part}</span>
      : part
  )
}

const getDietComponents = (speciesName) => {
  if (!speciesName) return []
  // Buscar pelo nome base (sem sufixos de forma como " de Paldea", " Mega", etc.)
  const diet = POKEMON_DIET_MAP[speciesName] || null
  if (!diet) return []
  // Separar dietas combinadas pelo ' e '
  return diet.split(' e ').map(d => d.trim()).filter(d => DIET_IMAGE_MAP[d])
}

const DietIcons = ({ speciesName, dietOverride, size = 20 }) => {
  const components = dietOverride
    ? dietOverride.split(' e ').map(d => d.trim()).filter(d => DIET_IMAGE_MAP[d])
    : getDietComponents(speciesName)
  if (components.length === 0) return null
  return (
    <div className="flex gap-1 items-center">
      {components.map((d) => (
        <img
          key={d}
          src={DIET_IMAGE_MAP[d]}
          alt={d}
          title={d}
          width={size}
          height={size}
          className="object-contain"
          onError={(e) => { e.target.style.display = 'none' }}
        />
      ))}
    </div>
  )
}

// Estrutura da PokéLoja
// Função helper para obter a imagem do item
const getItemImage = (itemName) => {
  // Verificar se é um Pokesuco
  if (itemName.startsWith('Pokesuco ')) {
    if (itemName.includes('Arco-íris')) return '/pokesuco/pokesucoarcoiris.png'
    if (itemName.includes('Fraco')) return '/pokesuco/pokesucobranco.png'
    if (itemName.includes('Vermelho')) return '/pokesuco/pokesucovermelho.png'
    if (itemName.includes('Verde')) return '/pokesuco/pokesucoverde.png'
    if (itemName.includes('Azul')) return '/pokesuco/pokesucoazul.png'
    if (itemName.includes('Rosa')) return '/pokesuco/pokesucorosa.png'
    if (itemName.includes('Amarelo')) return '/pokesuco/pokesucoamarelo.png'
    return '/pokesuco/pokesucobranco.png'
  }
  // Verificar se é uma peça de pokébola quebrada
  if (itemName.startsWith('Peças de ')) {
    const pokeballType = itemName.replace('Peças de ', '')
    if (BROKEN_POKEBALL_IMAGES[pokeballType]) {
      return BROKEN_POKEBALL_IMAGES[pokeballType]
    }
  }

  // Verificar se é um Puffin numerado/aromatizado (ex: "Puffin Amargo (Azedo) 3")
  if (itemName.startsWith('Puffin ')) {
    const baseName = itemName.replace(/\s*\([^)]+\)/g, '').replace(/\s+\d+$/, '').trim()
    const puffinItem = POKELOJA_DATA['Puffin']?.find(i => i.name === baseName)
    if (puffinItem) return puffinItem.image
  }
  // Procurar em todas as categorias da PokéLoja
  for (const category in POKELOJA_DATA) {
    const item = POKELOJA_DATA[category].find(i => i.name === itemName)
    if (item) return item.image
  }
  // Se não encontrar, retornar imagem padrão baseada no nome
  return `/pokeballs/${itemName.toLowerCase().replace(/\s+/g, '')}.png`
}

// Função para renderizar o efeito de um golpe (com suporte a tabelas)
const renderGolpeEfeito = (efeito, darkMode) => {
  // Se o efeito é uma string simples, retornar como está
  if (typeof efeito === 'string') {
    return efeito
  }

  // Se o efeito é um objeto com tabela(s), renderizar com formatação especial
  if (typeof efeito === 'object' && (efeito.tabela || efeito.tabelaDano || efeito.tabelaTipo)) {
    return (
      <div className="space-y-3">
        {/* Descrição do efeito */}
        {efeito.descricao && (
          <p className={darkMode ? 'text-gray-300' : 'text-gray-700'}>
            {efeito.descricao}
          </p>
        )}

        {/* Tabela principal */}
        {efeito.tabela && (
          <div className={`overflow-x-auto rounded-lg ${darkMode ? 'bg-gray-900' : 'bg-gray-50'}`}>
            <table className="w-full text-sm">
              <thead>
                <tr className={`${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-gray-200 border-gray-300'} border-b-2`}>
                  {Object.keys(efeito.tabela[0]).map((key, idx) => (
                    <th key={idx} className={`px-3 py-2 text-left font-bold ${darkMode ? 'text-gray-200' : 'text-gray-800'}`}>
                      {key.charAt(0).toUpperCase() + key.slice(1).replace(/([A-Z])/g, ' $1')}
                    </th>
                  ))}
                </tr>
              </thead>
              <tbody>
                {efeito.tabela.map((row, idx) => (
                  <tr key={idx} className={`${darkMode ? 'border-gray-700' : 'border-gray-300'} border-b last:border-b-0`}>
                    {Object.values(row).map((value, cellIdx) => (
                      <td key={cellIdx} className={`px-3 py-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                        {value}
                      </td>
                    ))}
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}

        {/* Tabela de Dano (para Poder Oculto) */}
        {efeito.tabelaDano && (
          <div className={`overflow-x-auto rounded-lg ${darkMode ? 'bg-gray-900' : 'bg-gray-50'}`}>
            <div className={`px-3 py-2 font-bold ${darkMode ? 'bg-gray-800 text-gray-200' : 'bg-gray-200 text-gray-800'}`}>
              Tabela de Dano Basal (1d4)
            </div>
            <table className="w-full text-sm">
              <thead>
                <tr className={`${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-gray-200 border-gray-300'} border-b-2`}>
                  <th className={`px-3 py-2 text-left font-bold ${darkMode ? 'text-gray-200' : 'text-gray-800'}`}>Resultado</th>
                  <th className={`px-3 py-2 text-left font-bold ${darkMode ? 'text-gray-200' : 'text-gray-800'}`}>Dano Basal</th>
                </tr>
              </thead>
              <tbody>
                {efeito.tabelaDano.map((row, idx) => (
                  <tr key={idx} className={`${darkMode ? 'border-gray-700' : 'border-gray-300'} border-b last:border-b-0`}>
                    <td className={`px-3 py-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>{row.resultado}</td>
                    <td className={`px-3 py-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>{row.danoBasal}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}

        {/* Tabela de Tipo (para Poder Oculto) */}
        {efeito.tabelaTipo && (
          <div className={`overflow-x-auto rounded-lg ${darkMode ? 'bg-gray-900' : 'bg-gray-50'}`}>
            <div className={`px-3 py-2 font-bold ${darkMode ? 'bg-gray-800 text-gray-200' : 'bg-gray-200 text-gray-800'}`}>
              Tabela de Tipo (1d20)
            </div>
            <table className="w-full text-sm">
              <thead>
                <tr className={`${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-gray-200 border-gray-300'} border-b-2`}>
                  <th className={`px-3 py-2 text-left font-bold ${darkMode ? 'text-gray-200' : 'text-gray-800'}`}>Resultado</th>
                  <th className={`px-3 py-2 text-left font-bold ${darkMode ? 'text-gray-200' : 'text-gray-800'}`}>Tipo</th>
                </tr>
              </thead>
              <tbody>
                {efeito.tabelaTipo.map((row, idx) => (
                  <tr key={idx} className={`${darkMode ? 'border-gray-700' : 'border-gray-300'} border-b last:border-b-0`}>
                    <td className={`px-3 py-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>{row.resultado}</td>
                    <td className={`px-3 py-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>{row.tipo}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </div>
    )
  }

  // Fallback: retornar como string
  return String(efeito)
}

const BG_IMAGES = ['/bg1.png', '/bg 2.png', '/bg3.png', '/bg4.png']

const POKELOJA_DATA = {
  'Cura': [
    { name: 'Potion', price: 200, description: 'Restaura 2d12+10 PV', image: '/pokeballs/potion.png' },
    { name: 'Superpotion', price: 350, description: 'Restaura 3d12+20 PV', image: '/pokeballs/superpotion.png' },
    { name: 'Hiperpotion', price: 400, description: 'Restaura 4d12+30 PV', image: '/pokeballs/hiperpotion.png' },
    { name: 'Antidoto', price: 250, description: 'Cura envenenamento', image: '/pokeballs/antidoto.png' },
    { name: 'Antiparalisante', price: 200, description: 'Cura paralisia', image: '/pokeballs/antiparalisante.png' },
    { name: 'Despertador', price: 200, description: 'Acorda o pokémon', image: '/pokeballs/despertador.png' },
    { name: 'Anticongelante', price: 200, description: 'Descongela o pokémon', image: '/pokeballs/anticongelante.png' },
    { name: 'Revive', price: 300, description: 'Revive o pokémon', image: '/pokeballs/revive.png' },
    { name: 'Moomoo Milk', price: 400, description: 'Restaura 8d6+25 Pontos de vida.', image: '/pokeballs/moomoomilk.png' },
    { name: 'Pó Energizante', price: 300, description: 'Restaura 4d10+15 Pontos de Vida, mas é Repulsivo (o pokémon perde 10% de felicidade).', image: '/pokeballs/poenergizante.png' },
    { name: 'Raiz Energizante', price: 450, description: 'Restaura 4d20+15 Pontos de Vida, mas é Repulsivo (o pokémon perde 10% de felicidade).', image: '/pokeballs/raizenergizante.png' },
    { name: 'Panaceia', price: 500, description: 'Restaura todas as Condições.', image: '/pokeballs/panaceia.png' },
    { name: 'Pó Curativo', price: 300, description: 'Restaura todas as Condições, mas é Repulsivo (o pokémon perde 10% de felicidade).', image: '/pokeballs/pocurativo.png' },
    { name: 'Erva da Sobrevida', price: 200, description: 'Restaura um pokémon inconsciente a 10 Pontos de Vida, mas é Repulsivo (o pokémon perde 10% de felicidade).', image: '/pokeballs/ervadasobrevida.png' },
    { name: 'Água Solarizada', price: 300, description: 'Restaura 30 Pontos de vida.', image: '/pokeballs/aguasolarizada.png' },
    { name: 'Refri', price: 400, description: 'Restaura 45 Pontos de vida.', image: '/pokeballs/refri.png' },
    { name: 'Limonada', price: 500, description: 'Restaura 60 Pontos de vida.', image: '/pokeballs/limonada.png' },
    { name: 'Lava Cookie', price: 400, description: 'Restaura todas as Condições.', image: '/pokeballs/lavacookie.png' },
    { name: 'Barra de Pokechocolate Radical', price: 100, description: 'Restaura 20 Pontos de vida. Role 1d20, se o resultado for maior ou igual a 11, o pokémon pedirá outra, caso não receba, diminua em 10 a felicidade dele. Faça essa rolagem toda vez que ele consumir o item.', image: '/pokeballs/barradepokechocolateradical.png' },
    { name: 'Bala de Coração', price: 100, description: 'Restaura 20 pontos de vida. Role 1d20, se o resultado for maior ou igual a 11, o pokémon recebe a condição Paixão.', image: '/pokeballs/baladecoração.png' },
    { name: 'Spray para Queimaduras', price: 250, description: 'Cura queimaduras.', image: '/pokeballs/sprayparaqueimaduras.png' },
    { name: 'Concentrado de Sálvia', price: 400, description: 'O pokémon se cura em 2d10+15 Pontos de vida. Se o pokémon for do tipo planta, ele recebe 4d10+15.', image: '/pokeballs/concentradodesalvia.png' },
    { name: 'Poção da Paciência', price: 300, description: 'A cada rodada o pokémon se cura em 10 Pontos de vida, por cinco rodadas.', image: '/pokeballs/pocaodapaciencia.png' },
    { name: 'Poção da Braveza', price: 650, description: 'O pokémon se cura em 2d12+15 Pontos de vida e aumenta em 1 a fase de ataque.', image: '/pokeballs/pocaodabraveza.png' }
  ],
  'Repelente': [
    { name: 'Repel', price: 200, description: '1d6+3 horas', image: '/pokeballs/repel.png' },
    { name: 'Super Repel', price: 300, description: '1d8+4 horas', image: '/pokeballs/superrepel.png' },
    { name: 'Max Repel', price: 400, description: '1d10+5 horas', image: '/pokeballs/maxrepel.png' },
    { name: 'Repel Off', price: 400, description: 'Cancela os efeitos de qualquer repelente.', image: '/pokeballs/repeloff.png' }
  ],
  'Captura': [
    { name: 'Pokeball', price: 200, description: '+15', image: '/pokeballs/pokeball.png' },
    { name: 'Greatball', price: 500, description: '+5', image: '/pokeballs/greatball.png' },
    { name: 'Ultraball', price: 1000, description: '-5', image: '/pokeballs/ultraball.png' },
    { name: 'Beastball', price: 2000, description: '+45, ou -50 se o alvo possui a Habilidade Ultrabesta', image: '/pokeballs/beastball.png' },
    { name: 'Cherishball', price: 2000, description: '-5', image: '/pokeballs/cherishball.png' },
    { name: 'Diveball', price: 2000, description: '+5, ou -15 se estiver submerso ou no subterrâneo.', image: '/pokeballs/diveball.png' },
    { name: 'Dreamball', price: 2000, description: '+0, Pokébola funcional em sonhos.', image: '/pokeballs/dreamball.png' },
    { name: 'Duskball', price: 2000, description: '+0, ou -15 se estiver muito escuro.', image: '/pokeballs/duskball.png' },
    { name: 'Fastball', price: 2000, description: '+5, ou -15 se o alvo possui algum Deslocamento acima de 7.', image: '/pokeballs/fastball.png' },
    { name: 'Friendball', price: 2000, description: '-5, A Lealdade do alvo começará 3.', image: '/pokeballs/friendball.png' },
    { name: 'Healball', price: 2000, description: '-5, Todos os PV são recuperados.', image: '/pokeballs/healball.png' },
    { name: 'Heavyball', price: 2000, description: '+5, reduzindo em 5 para cada Categoria de Peso do alvo mais pesada que Leve.', image: '/pokeballs/heavyball.png' },
    { name: 'Leadenball', price: 2000, description: '+5, caso o treinador esteja escondido, -15. É necessário um teste de força para arremessar a mais de 3m.', image: '/pokeballs/leadenball.png' },
    { name: 'Levelball', price: 2000, description: '+5, ou -15 se o Nível do alvo é menor que a metade do Nível do seu pokémon.', image: '/pokeballs/levelball.png' },
    { name: 'Loveball', price: 2000, description: '+0, ou -15 se o sexo do alvo é o oposto do sexo do seu pokémon.', image: '/pokeballs/loveball.png' },
    { name: 'Lunarball', price: 2000, description: '+0, ou -15 se o alvo em algum ponto pode evoluir usando uma Pedra da Lua.', image: '/pokeballs/lunarball.png' },
    { name: 'Lureball', price: 2000, description: '+0, ou -15 se o alvo foi atraído ao encontro por uma isca.', image: '/pokeballs/lureball.png' },
    { name: 'Luxuryball', price: 2000, description: '-5, Fica feliz.', image: '/pokeballs/luxuryball.png' },
    { name: 'Nestball', price: 2000, description: '+0; ou -15 se o Nível do alvo é menor que 10.', image: '/pokeballs/nestball.png' },
    { name: 'Netball', price: 2000, description: '+0, ou -15 se o alvo é dos Tipos Água ou Inseto.', image: '/pokeballs/netball.png' },
    { name: 'Parkball', price: 2000, description: '+0, Pokébola autorizadas para uso dentro de uma Zona de Safari.', image: '/pokeballs/parkball.png' },
    { name: 'Premierball', price: 2000, description: '+0', image: '/pokeballs/premierball.png' },
    { name: 'Quickball', price: 2000, description: '-20, ou -15 se for usada na segunda rodada do combate ou -10 se for usada depois da segunda rodada', image: '/pokeballs/quickball.png' },
    { name: 'Repeatball', price: 2000, description: '+10; ou -15 se o alvo já consta na sua lista de Pokémons Possuídos.', image: '/pokeballs/repeatball.png' },
    { name: 'Safariball', price: 2000, description: '+0, Pokébola autorizadas para uso dentro de uma Zona de Safari.', image: '/pokeballs/safariball.png' },
    { name: 'Sportball', price: 2000, description: '+0, Pokébola autorizadas para uso dentro de uma Zona de Safari.', image: '/pokeballs/sportball.png' },
    { name: 'Timerball', price: 2000, description: '+5, reduzindo em 5 para cada duas rodadas de combate (até o mínimo de -20)', image: '/pokeballs/timerball.png' },
    { name: 'Featherball', price: 2000, description: '+5, ou -5 se o alvo possuir mais de 15 de velocidade ou voar/flutuar. Pode ser arremessada a até 15m sem precisar fazer teste de força.', image: '/pokeballs/featherball.png' },
    { name: 'Masterball', description: 'Captura automática.', image: '/pokeballs/masterball.png', noShop: true },
    { name: 'Alphaball', description: '+10, ou -15 se o pokémon for Alpha.', image: '/pokeballs/alphaball.png', noShop: true }
  ],
  'Suplemento': [
    { name: 'Hp-up', price: 4900, description: 'Aumenta a Saúde Basal em 1.', image: '/pokeballs/hpup.png' },
    { name: 'Proteína', price: 4900, description: 'Aumenta o Ataque Basal em 1.', image: '/pokeballs/proteina.png' },
    { name: 'Ferro', price: 4900, description: 'Aumenta a Defesa Basal em 1.', image: '/pokeballs/ferro.png' },
    { name: 'Cálcio', price: 4900, description: 'Aumenta o Ataque Especial Basal em 1.', image: '/pokeballs/calcio.png' },
    { name: 'Zinco', price: 4900, description: 'Aumenta a Defesa Especial Basal em 1.', image: '/pokeballs/zinco.png' },
    { name: 'Carburante', price: 4900, description: 'Aumenta a Velocidade Basal em 1.', image: '/pokeballs/carburante.png' },
    { name: 'PP-up', price: 9800, description: 'Escolha um Golpe* do pokémon.Se o Golpe escolhido tinha Frequência Rodada Sim Rodada Não, ele agora pode ser usado À Vontade. Se o Golpe escolhido tinha Frequência Por Encontro, ele agora pode ser usado Rodada Sim Rodada Não. Se ele possuía Frequência Centro Pokémon, ele agora pode ser usado Por Encontro.', image: '/pokeballs/ppup.png' },
    { name: 'Rare Candy', price: 48000, description: 'O pokémon ganha 1 nível.', image: '/pokeballs/rarecandy.png' },
    { name: 'Éter', price: 450, description: 'Restaura o uso de um Golpe.', image: '/pokeballs/eter.png' },
    { name: 'Elixir', price: 750, description: 'Restaura o uso de todos os Golpes.', image: '/pokeballs/elixir.png' },
    { name: 'Suplemento Sortido', price: 2000, description: 'Este suplemento não passou em todos os testes de qualidade, talvez ele faça mal a seu pokémon. Role 1d20, se o resultado for 8 ou mais, seu pokémon perde 1 de um atributo aleatório (Role 1d6 para saber o atributo). Caso contrário, ele recebe 2 em um atributo aleatório.', image: '/pokeballs/suplementosortido.png' },
    { name: 'Doce não tão raro', price: 25000, description: 'O pokémon recebe 10000 de XP.', image: '/pokeballs/docenaotaoraro.png' }
  ],
  'Melhoradores': [
    { name: 'X-Ataque', price: 80, description: 'Eleva uma Fase de Ataque.', image: '/pokeballs/x-ataque.png' },
    { name: 'X-Defesa', price: 80, description: 'Eleva uma Fase de Defesa.', image: '/pokeballs/x-defesa.png' },
    { name: 'X-Ataque Especial', price: 80, description: 'Eleva uma Fase de Ataque Especial.', image: '/pokeballs/x-ataqueespecial.png' },
    { name: 'X-Defesa Especial', price: 80, description: 'Eleva uma Fase de Defesa Especial.', image: '/pokeballs/x-defesaespecial.png' },
    { name: 'X-Velocidade', price: 80, description: 'Eleva uma Fase de Velocidade.', image: '/pokeballs/x-velocidade.png' },
    { name: 'X-Acurácia', price: 80, description: 'Reduz em 2 as Dificuldades de Acurácia.', image: '/pokeballs/x-acuracia.png' },
    { name: 'Golpe Atroz', price: 80, description: 'Obtém Críticos em resultados 18 a 20 nos Testes de Acurácia.', image: '/pokeballs/golpeatroz.png' },
    { name: 'Guarda Especial', price: 80, description: 'Não pode perder Fases, porém dura apenas cinco rodadas.', image: '/pokeballs/guardaespecial.png' },
    { name: 'Reforço Natural', price: 200, description: 'Eleva duas Fases de Ataque ou de Ataque Especial, mas é Repulsivo (o pokémon perde 10% de felicidade).', image: '/pokeballs/reforconatural.png' },
    { name: 'Raiz Revigorante', price: 200, description: 'Eleva duas Fases de Defesa ou de Defesa Especial, mas é Repulsivo (o pokémon perde 10% de felicidade).', image: '/pokeballs/raizrevigorante.png' },
    { name: 'Fumo Rápido', price: 200, description: 'Eleva duas Fases de Velocidade, mas é Repulsivo (o pokémon perde 10% de felicidade).', image: '/pokeballs/fumorapido.png' },
    { name: 'Veneno Sintético', price: 200, description: 'O pokémon está envenenado. Todos os ataques corpo a corpo do pokémon infligem a condição Envenenado.', image: '/pokeballs/venenosintetico.png' }
  ],
  'Apricorns e Bonsais': [
    { name: 'Apricorn Vermelha', price: 50, description: 'Seu suco é Picante e adiciona 1/4 da qualidade ao Salto.', image: '/pokeballs/apricornvermelhor.png' },
    { name: 'Apricorn Verde', price: 50, description: 'Seu suco é Amargo e adiciona 1/4 da qualidade à Inteligência.', image: '/pokeballs/apricornverde.png' },
    { name: 'Apricorn Preta', price: 50, description: 'Não tem gosto. Cura qualquer veneno. Intensifica um dos sabores de outra apricorn.', image: '/pokeballs/apricornpreta.png' },
    { name: 'Apricorn Rosa', price: 50, description: 'Seu suco é Doce e adiciona 1/2 da qualidade ao deslocamento de terrestre e natação.', image: '/pokeballs/apricornrosa.png' },
    { name: 'Apricorn Branca', price: 50, description: 'Não tem gosto. Abranda o gosto dos outros apricorns em um suco. Ao ser consumido pelo pokémon que o está segurando, cura 1d20+2 de vida, após sofrer um dano igual ou maior que 20.', image: '/pokeballs/apricornbranca.png' },
    { name: 'Apricorn Azul', price: 50, description: 'Seu suco é Seco e adiciona 1/2 da qualidade ao deslocamento de escavação, subaquático e voo.', image: '/pokeballs/apricornazul.png' },
    { name: 'Apricorn Amarela', price: 50, description: 'Seu suco é Azedo e adiciona um quarto da qualidade à Força.', image: '/pokeballs/apricornamarela.png' },
    { name: 'Apricorn Arco-íris', price: 200, description: 'Seu suco tem sabor único e palatável a todos, sendo dominante em qualquer mistura.', image: '/pokeballs/apricornarcoiris.png' },
    { name: 'Bonsai Vermelho', price: 300, description: 'Gera apricorns Vermelha', image: '/pokeballs/bonsaivermelho.png' },
    { name: 'Bonsai Verde', price: 300, description: 'Gera apricorns Verde', image: '/pokeballs/bonsaiverde.png' },
    { name: 'Bonsai Azul', price: 300, description: 'Gera apricorns Azul', image: '/pokeballs/bonsaiazul.png' },
    { name: 'Bonsai Preto', price: 300, description: 'Gera apricorns Preta', image: '/pokeballs/bonsaipreto.png' },
    { name: 'Bonsai Amarelo', price: 300, description: 'Gera apricorns Amarela', image: '/pokeballs/bonsaiamarelo.png' },
    { name: 'Bonsai Rosa', price: 300, description: 'Gera apricorns Rosa', image: '/pokeballs/bonsairosa.png' },
    { name: 'Bonsai Branco', price: 300, description: 'Gera apricorns Branca', image: '/pokeballs/bonsaibranco.png' },
    { name: 'Bonsai Arco-íris', price: 1000, description: 'Gera apricorns Arco-íris', image: '/pokeballs/bonsaiarcoiris.png' }
  ],
  'Ração': [
    { name: 'Ração Humana', price: 100, description: 'Conjunto de 3 refeições diárias.', image: '/pokeballs/racaohumana.png' },
    { name: 'Ração Vegetariana', price: 150, description: 'Conjunto de 3 refeições diárias, para pokémons vegetarianos.', image: '/pokeballs/racaovegetariana.png' },
    { name: 'Ração Carnívora', price: 200, description: 'Conjunto de 3 refeições diárias, para pokémons carnívoros.', image: '/pokeballs/racaocarnivora.png' },
    { name: 'Ração Onívora', price: 200, description: 'Conjunto de 3 refeições diárias, para pokémon onívoros.', image: '/pokeballs/racaoonivora.png' }
  ],
  'Frutas': [
    { name: 'Persim', realName: 'Caqui', price: 90, description: 'Sabores: Azedo, Doce, Picante, Seco. Restaura Confusão.', image: '/frutas/persim.png' },
    { name: 'Wepear', realName: 'Abacate', price: 90, description: 'Sabores: Amargo, Azedo. Nenhum efeito de consumo.', image: '/frutas/wepear.png' },
    { name: 'Pinap', realName: 'Abacaxi', price: 90, description: 'Sabores: Azedo, Picante. Nenhum efeito de consumo.', image: '/frutas/pinap.png' },
    { name: 'Pamtre', realName: 'Açaí', price: 90, description: 'Sabores: Doce, Seco. Nenhum efeito de consumo.', image: '/frutas/pamtre.png' },
    { name: 'Bluk', realName: 'Amora', price: 90, description: 'Sabores: Doce, Seco. Nenhum efeito de consumo.', image: '/frutas/bluk.png' },
    { name: 'Nanab', realName: 'Banana', price: 90, description: 'Sabores: Amargo, Doce. Nenhum efeito de consumo.', image: '/frutas/nanab.png' },
    { name: 'Durin', realName: 'Durião', price: 90, description: 'Sabores: Amargo, Azedo. Nenhum efeito de consumo.', image: '/frutas/durin.png' },
    { name: 'Razz', realName: 'Framboesa', price: 90, description: 'Sabores: Picante, Seco. Nenhum efeito de consumo.', image: '/frutas/razz.png' },
    { name: 'Oran', realName: 'Laranja', price: 90, description: 'Sabores: Amargo, Azedo, Picante, Seco. Recupera 1d8 PV.', image: '/frutas/oran.png' },
    { name: 'Nomel', realName: 'Limão', price: 90, description: 'Sabores: Azedo, Picante. Nenhum efeito de consumo.', image: '/frutas/nomel.png' },
    { name: 'Magost', realName: 'Mangostão', price: 90, description: 'Sabores: Amargo, Doce. Nenhum efeito de consumo.', image: '/frutas/magost.png' },
    { name: 'Watmel', realName: 'Melancia', price: 90, description: 'Sabores: Amargo, Doce. Nenhum efeito de consumo.', image: '/frutas/watmel.png' },
    { name: 'Spelon', realName: 'Melão', price: 90, description: 'Sabores: Picante, Seco. Nenhum efeito de consumo.', image: '/frutas/spelon.png' },
    { name: 'Cornn', realName: 'Milho', price: 90, description: 'Sabores: Doce, Seco. Nenhum efeito de consumo.', image: '/frutas/cornn.png' },
    { name: 'Belue', realName: 'Mirtilo', price: 90, description: 'Sabores: Azedo, Picante. Nenhum efeito de consumo.', image: '/frutas/belue.png' },
    { name: 'Rabuta', realName: 'Rambután', price: 90, description: 'Sabores: Amargo, Azedo. Nenhum efeito de consumo.', image: '/frutas/rabuta.png' },
    { name: 'Figy', realName: 'Figo', price: 155, description: 'Sabores: Picante. Recupera um oitavo dos PV máximos, mas torna Confuso se o pokémon desgosta de Picante.', image: '/frutas/figy.png' },
    { name: 'Aguav', realName: 'Goiaba', price: 155, description: 'Sabores: Amargo. Recupera um oitavo dos PV máximos, mas torna Confuso se o pokémon desgosta de Amargo.', image: '/frutas/aguav.png' },
    { name: 'Wiki', realName: 'Kiwi', price: 155, description: 'Sabores: Seco. Recupera um oitavo dos PV máximos, mas torna Confuso se o pokémon desgosta de Seco.', image: '/frutas/wiki.png' },
    { name: 'Iapapa', realName: 'Mamão', price: 155, description: 'Sabores: Azedo. Recupera um oitavo dos PV máximos, mas torna Confuso se o pokémon desgosta de Azedo.', image: '/frutas/iapapa.png' },
    { name: 'Mago', realName: 'Manga', price: 155, description: 'Sabores: Doce. Recupera um oitavo dos PV máximos, mas torna Confuso se o pokémon desgosta de Doce.', image: '/frutas/mago.png' },
    { name: 'Sitrus', realName: 'Toranja', price: 155, description: 'Sabores: Amargo, Azedo, Doce, Seco. Recupera 2d8 PV.', image: '/frutas/sitrus.png' },
    { name: 'Chesto', realName: 'Castanha', price: 225, description: 'Sabores: Seco. Restaura Sono.', image: '/frutas/chesto.png' },
    { name: 'Cheri', realName: 'Cereja', price: 225, description: 'Sabores: Picante. Restaura Paralisia.', image: '/frutas/cheri.png' },
    { name: 'Rawst', realName: 'Morango', price: 225, description: 'Sabores: Amargo. Restaura Queimadura.', image: '/frutas/rawst.png' },
    { name: 'Aspear', realName: 'Pera', price: 225, description: 'Sabores: Azedo. Restaura Congelamento.', image: '/frutas/aspear.png' },
    { name: 'Pecha', realName: 'Pêssego', price: 225, description: 'Sabores: Doce. Restaura Veneno.', image: '/frutas/pecha.png' },
    { name: 'Kebia', realName: 'Akebia', price: 275, description: 'Sabores: Picante, Seco. Se sofrer um dano Venenoso que seria superefetivo, sofre apenas dano neutro.', image: '/frutas/kebia.png' },
    { name: 'Charti', realName: 'Alcachofra', price: 275, description: 'Sabores: Picante, Seco. Se sofrer um dano de Pedra que seria superefetivo, sofre apenas dano neutro.', image: '/frutas/charti.png' },
    { name: 'Haban', realName: 'Araçá', price: 275, description: 'Sabores: Amargo, Doce. Se sofrer um dano de Dragão que seria superefetivo, sofre apenas dano neutro.', image: '/frutas/haban.png' },
    { name: 'Coba', realName: 'Babaco', price: 275, description: 'Sabores: Amargo, Seco. Se sofrer um dano Voador que seria superefetivo, sofre apenas dano neutro.', image: '/frutas/coba.png' },
    { name: 'Babiri', realName: 'Biribá', price: 275, description: 'Sabores: Picante, Seco. Se sofrer um dano Metálico que seria superefetivo, sofre apenas dano neutro.', image: '/frutas/babiri.png' },
    { name: 'Occa', realName: 'Cacau', price: 275, description: 'Sabores: Picante, Seco. Se sofrer um dano de Fogo que seria superefetivo, sofre apenas dano neutro.', image: '/frutas/occa.png' },
    { name: 'Shuca', realName: 'Caju', price: 275, description: 'Sabores: Picante, Seco. Se sofrer um dano de Terra que seria superefetivo, sofre apenas dano neutro.', image: '/frutas/shuca.png' },
    { name: 'Colbur', realName: 'Cardo', price: 275, description: 'Sabores: Amargo, Azedo. Se sofrer um dano de Trevas que seria superefetivo, sofre apenas dano neutro.', image: '/frutas/colbur.png' },
    { name: 'Chople', realName: 'Chipotle', price: 275, description: 'Sabores: Amargo, Picante. Se sofrer um dano Lutador que seria superefetivo, sofre apenas dano neutro.', image: '/frutas/chople.png' },
    { name: 'Yache', realName: 'Chirimoia', price: 275, description: 'Sabores: Azedo, Seco. Se sofrer um dano de Gelo que seria superefetivo, sofre apenas dano neutro.', image: '/frutas/yache.png' },
    { name: 'Wacan', realName: 'Guajilote', price: 275, description: 'Sabores: Azedo, Doce. Se sofrer um dano Elétrico que seria superefetivo, sofre apenas dano neutro.', image: '/frutas/wacan.png' },
    { name: 'Kasib', realName: 'Mandioca', price: 275, description: 'Sabores: Doce, Seco. Se sofrer um dano Fantasma que seria superefetivo, sofre apenas dano neutro.', image: '/frutas/kasib.png' },
    { name: 'Passho', realName: 'Maracujá', price: 275, description: 'Sabores: Amargo, Seco. Se sofrer um dano de Água que seria superefetivo, sofre apenas dano neutro.', image: '/frutas/passho.png' },
    { name: 'Payapa', realName: 'Papaia', price: 275, description: 'Sabores: Azedo, Doce. Se sofrer um dano Psíquico que seria superefetivo, sofre apenas dano neutro.', image: '/frutas/payapa.png' },
    { name: 'Tanga', realName: 'Pitanga', price: 275, description: 'Sabores: Azedo, Picante. Se sofrer um dano de Inseto que seria superefetivo, sofre apenas dano neutro.', image: '/frutas/tanga.png' },
    { name: 'Roseli', realName: 'Rosália', price: 275, description: 'Sabores: Doce, Seco. Se sofrer um dano de Fada que seria superefetivo, sofre apenas dano neutro.', image: '/frutas/roseli.png' },
    { name: 'Chilan', realName: 'Sininho', price: 275, description: 'Sabores: Doce, Seco. Se sofrer um dano Normal, sofre apenas metade do dano.', image: '/frutas/chilan.png' },
    { name: 'Rindo', realName: 'Tamarindo', price: 275, description: 'Sabores: Amargo, Picante. Se sofrer um dano de Planta que seria superefetivo, sofre apenas dano neutro.', image: '/frutas/rindo.png' },
    { name: 'Starf', realName: 'Carambola', price: 365, description: 'Sabores: Amargo, Azedo, Doce, Picante, Seco. Quando abaixo da metade dos PV, eleva uma Fase em um Atributo aleatório (exceto Saúde).', image: '/frutas/starf.png' },
    { name: 'Apicot', realName: 'Damasco', price: 365, description: 'Sabores: Azedo, Picante, Seco. Quando abaixo da metade dos PV, eleva uma Fase em Defesa Especial.', image: '/frutas/apicot.png' },
    { name: 'Lansat', realName: 'Langsat', price: 365, description: 'Sabores: Amargo, Azedo, Doce, Picante, Seco. Quando abaixo da metade dos PV, os Golpes do pokémon serão Críticos em resultados de Acurácia de 18 a 20 por 3 rodadas.', image: '/frutas/lansat.png' },
    { name: 'Liechi', realName: 'Lichia', price: 365, description: 'Sabores: Doce, Picante, Seco. Quando abaixo da metade dos PV, eleva uma Fase em Ataque.', image: '/frutas/liechi.png' },
    { name: 'Ganlon', realName: 'Longana', price: 365, description: 'Sabores: Amargo, Doce, Seco. Quando abaixo da metade dos PV, eleva uma Fase em Defesa.', image: '/frutas/ganlon.png' },
    { name: 'Petaya', realName: 'Pitaia', price: 365, description: 'Sabores: Amargo, Azedo, Picante. Quando abaixo da metade dos PV, eleva uma Fase em Ataque Especial.', image: '/frutas/petaya.png' },
    { name: 'Salac', realName: 'Salak', price: 365, description: 'Sabores: Amargo, Azedo, Doce. Quando abaixo da metade dos PV, eleva uma Fase em Velocidade.', image: '/frutas/salac.png' },
    { name: 'Kelpsy', realName: 'Alga', price: 375, description: 'Sabores: Amargo, Azedo, Seco. Se for do interesse, reduz o Ataque Basal em 1.', image: '/frutas/kelpsy.png' },
    { name: 'Hondew', realName: 'Cantalupo', price: 375, description: 'Sabores: Amargo, Picante, Seco. Se for do interesse, reduz o Ataque Especial Basal em 1.', image: '/frutas/hondew.png' },
    { name: 'Qualot', realName: 'Nêspera', price: 375, description: 'Sabores: Azedo, Doce, Picante. Se for do interesse, reduz a Defesa Basal em 1.', image: '/frutas/qualot.png' },
    { name: 'Pomeg', realName: 'Romã', price: 375, description: 'Sabores: Amargo, Doce, Picante. Se for do interesse, reduz a Saúde Basal em 1.', image: '/frutas/pomeg.png' },
    { name: 'Tamato', realName: 'Tomate', price: 375, description: 'Sabores: Picante, Seco. Se for do interesse, reduz a Velocidade Basal em 1.', image: '/frutas/tamato.png' },
    { name: 'Grepa', realName: 'Uva', price: 375, description: 'Sabores: Azedo, Doce, Seco. Se for do interesse, reduz a Defesa Especial Basal em 1.', image: '/frutas/grepa.png' },
    { name: 'Lum', realName: 'Ameixa', price: 555, description: 'Sabores: Amargo, Doce, Picante, Seco. Restaura qualquer Condição.', image: '/frutas/lum.png' },
    { name: 'Leppa', realName: 'Maçã', price: 1375, description: 'Sabores: Amargo, Azedo, Doce, Picante. Restaura um uso de um Golpe.', image: '/frutas/leppa.png' },
    { name: 'Enigma', realName: 'Enigma', price: 2555, description: 'Sabores: Picante, Seco. Se acertado por um Golpe superefetivo, recupera um quarto dos PV máximos.', image: '/frutas/enigma.png' },
    { name: 'Micle', realName: 'Fruta Milagrosa', price: 2555, description: 'Sabores: Doce, Seco. Quando abaixo da metade dos PV, as Dificuldades de Acurácia dos Golpes são reduzidas em 2 por 3 rodadas.', image: '/frutas/micle.png' },
    { name: 'Kee', realName: 'Guaraná', price: 2555, description: 'Sabores: Doce, Seco. Quando acertado por um Golpe Físico, eleva uma Fase em Defesa.', image: '/frutas/kee.png' },
    { name: 'Jaboca', realName: 'Jabuticaba', price: 2555, description: 'Sabores: Amargo, Azedo. Quando acertado por um ataque Corpo a Corpo, o atacante sofre metade do dano causado.', image: '/frutas/jaboca.png' },
    { name: 'Maranga', realName: 'Jaca', price: 2555, description: 'Sabores: Amargo, Seco. Quando acertado por um Golpe Especial, eleva uma Fase em Defesa Especial.', image: '/frutas/maranga.png' },
    { name: 'Rowap', realName: 'Jambo', price: 2555, description: 'Sabores: Azedo, Picante. Quando acertado por um ataque à Distância, o atacante sofre metade do dano causado.', image: '/frutas/rowap.png' },
    { name: 'Custap', realName: 'Pinha', price: 2555, description: 'Sabores: Amargo, Doce. Quando abaixo de 10% dos PV, os Golpes causadores de dano adquirem o Descritor Interrupção se puderem ser usados à Vontade por 1 rodada.', image: '/frutas/custap.png' }
  ],
  'Pokesucos': [
    { name: 'Pokesuco Vermelho', price: 0, description: 'Adicione 1/4 da qualidade do Suco ao Salto. Pode variar de ₽150 a ₽1.500.', image: '/pokesuco/pokesucovermelho.png', isPokesucoLoja: true, sucoColor: 'Vermelho' },
    { name: 'Pokesuco Verde', price: 0, description: 'Adicione 1/4 da qualidade do Suco à Inteligência. Pode variar de ₽150 a ₽1.500.', image: '/pokesuco/pokesucoverde.png', isPokesucoLoja: true, sucoColor: 'Verde' },
    { name: 'Pokesuco Amarelo', price: 0, description: 'Adicione 1/4 do valor do Suco à Força. Pode variar de ₽150 a ₽1.500.', image: '/pokesuco/pokesucoamarelo.png', isPokesucoLoja: true, sucoColor: 'Amarelo' },
    { name: 'Pokesuco Azul', price: 0, description: 'Adicione 1/2 da qualidade do Suco aos Deslocamentos de Escavação, Subaquático e de Voo. Pode variar de ₽150 a ₽1.500.', image: '/pokesuco/pokesucoazul.png', isPokesucoLoja: true, sucoColor: 'Azul' },
    { name: 'Pokesuco Rosa', price: 0, description: 'Adicione 1/2 da qualidade do Suco aos Deslocamentos Terrestre e de Natação. Pode variar de ₽150 a ₽1.500.', image: '/pokesuco/pokesucorosa.png', isPokesucoLoja: true, sucoColor: 'Rosa' },
    { name: 'Pokesuco Branco', price: 0, description: 'Adicione 1/5 da qualidade do Suco ao atributo alvo ou 1/3 aos deslocamentos alvos. Sem gostos fortes, todos os pokémons bebem sem reclamar. Pode variar de ₽150 a ₽1.500.', image: '/pokesuco/pokesucobranco.png', isPokesucoLoja: true, sucoColor: 'Branco' },
    { name: 'Pokesuco Arco-íris', price: 0, description: 'Adiciona 1/4 da qualidade do suco a todos os atributos e deslocamentos. Sem gostos fortes, todos os pokémons bebem sem reclamar. Pode variar de ₽150 a ₽1.500.', image: '/pokesuco/pokesucoarcoiris.png', isPokesucoLoja: true, sucoColor: 'Arco-íris' }
  ],
  'Puffin': [
    { name: 'Puffin Picante', price: null, description: 'Aumenta estilo.', image: '/puffins/puffinpicante.png' },
    { name: 'Puffin Picante Seco', price: null, description: 'Aumenta estilo e beleza.', image: '/puffins/puffinpicanteseco.png' },
    { name: 'Puffin Picante Doce', price: null, description: 'Aumenta estilo e ternura.', image: '/puffins/puffinpicantedoce.png' },
    { name: 'Puffin Picante Amargo', price: null, description: 'Aumenta estilo e perspicácia.', image: '/puffins/puffinpicanteamargo.png' },
    { name: 'Puffin Picante Azedo', price: null, description: 'Aumenta estilo e vigor.', image: '/puffins/puffinpicanteazedo.png' },
    { name: 'Puffin Seco', price: null, description: 'Aumenta beleza.', image: '/puffins/puffinseco.png' },
    { name: 'Puffin Seco Picante', price: null, description: 'Aumenta beleza e estilo.', image: '/puffins/puffinsecopicante.png' },
    { name: 'Puffin Seco Doce', price: null, description: 'Aumenta beleza e ternura.', image: '/puffins/puffinsecodoce.png' },
    { name: 'Puffin Seco Amargo', price: null, description: 'Aumenta beleza e perspicácia.', image: '/puffins/puffinsecoamargo.png' },
    { name: 'Puffin Seco Azedo', price: null, description: 'Aumenta beleza e vigor.', image: '/puffins/puffinsecoazedo.png' },
    { name: 'Puffin Doce', price: null, description: 'Aumenta a ternura.', image: '/puffins/puffindoce.png' },
    { name: 'Puffin Doce Picante', price: null, description: 'Aumenta a ternura e estilo.', image: '/puffins/puffindocepicante.png' },
    { name: 'Puffin Doce Seco', price: null, description: 'Aumenta a ternura e beleza.', image: '/puffins/puffindoceseco.png' },
    { name: 'Puffin Doce Amargo', price: null, description: 'Aumenta a ternura e perspicácia.', image: '/puffins/puffindoceamargo.png' },
    { name: 'Puffin Doce Azedo', price: null, description: 'Aumenta a ternura e vigor.', image: '/puffins/puffindoceazedo.png' },
    { name: 'Puffin Amargo', price: null, description: 'Aumenta a perspicácia.', image: '/puffins/puffinamargo.png' },
    { name: 'Puffin Amargo Picante', price: null, description: 'Aumenta a perspicácia e estilo.', image: '/puffins/puffinamargopicante.png' },
    { name: 'Puffin Amargo Seco', price: null, description: 'Aumenta a perspicácia e beleza.', image: '/puffins/puffinamargoseco.png' },
    { name: 'Puffin Amargo Doce', price: null, description: 'Aumenta a perspicácia e ternura.', image: '/puffins/puffinamargodoce.png' },
    { name: 'Puffin Amargo Azedo', price: null, description: 'Aumenta a perspicácia e vigor.', image: '/puffins/puffinamargoazedo.png' },
    { name: 'Puffin Azedo', price: null, description: 'Aumenta o vigor.', image: '/puffins/puffinazedo.png' },
    { name: 'Puffin Azedo Picante', price: null, description: 'Aumenta o vigor e estilo.', image: '/puffins/puffinazedopicante.png' },
    { name: 'Puffin Azedo Seco', price: null, description: 'Aumenta o vigor e beleza.', image: '/puffins/puffinazedoseco.png' },
    { name: 'Puffin Azedo Doce', price: null, description: 'Aumenta o vigor e ternura.', image: '/puffins/puffinazedodoce.png' },
    { name: 'Puffin Azedo Amargo', price: null, description: 'Aumenta o vigor e perspicácia.', image: '/puffins/puffinazedoamargo.png' }
  ]
}

// Função para extrair sabores de uma fruta pelo nome
const getFruitFlavors = (fruitName) => {
  const fruit = POKELOJA_DATA['Frutas']?.find(f => f.name === fruitName)
  if (!fruit) return []
  const match = fruit.description.match(/Sabores: ([^.]+)\./)
  if (!match) return []
  return match[1].split(', ').map(s => s.trim()).filter(Boolean)
}

// Mapeamento de sabores de puffin para aptidões
const FLAVOR_LIST = ['Picante', 'Seco', 'Doce', 'Amargo', 'Azedo']
const FLAVOR_TO_APTIDAO = { Picante: 'estilo', Seco: 'beleza', Doce: 'ternura', Amargo: 'perspicacia', Azedo: 'vigor' }

// Parser de nome de puffin (ex: "Puffin Azedo Amargo (Doce) 4")
const parsePuffinName = (name) => {
  let remaining = name.replace(/^Puffin\s+/, '')
  let aroma = null
  const aromaMatch = remaining.match(/\(([^)]+)\)/)
  if (aromaMatch) {
    aroma = aromaMatch[1].trim()
    remaining = remaining.replace(/\s*\([^)]+\)/, '').trim()
  }
  const tokens = remaining.split(/\s+/)
  const valor = parseInt(tokens[tokens.length - 1]) || 0
  const flavors = tokens.slice(0, -1).filter(t => FLAVOR_LIST.includes(t))
  return { primaryFlavor: flavors[0] || null, secondaryFlavor: flavors[1] || null, aroma, valor }
}

// Corredores que nunca aparecem na Pokéloja (sempre ocultos para treinadores)
const CORREDORES_SEMPRE_OCULTOS = ['Apricorns e Bonsais', 'Puffin']

// Mapeamento de Apricorn para cor
const APRICORN_COLOR_MAP = {
  'Apricorn Vermelha': 'Vermelho',
  'Apricorn Verde': 'Verde',
  'Apricorn Preta': 'Preto',
  'Apricorn Rosa': 'Rosa',
  'Apricorn Branca': 'Branco',
  'Apricorn Azul': 'Azul',
  'Apricorn Amarela': 'Amarelo',
  'Apricorn Arco-íris': 'Arco-íris'
}

// Imagens dos Pokesucos por cor base
const POKESUCO_IMAGE_MAP = {
  'Vermelho': '/pokesuco/pokesucovermelho.png',
  'Verde': '/pokesuco/pokesucoverde.png',
  'Amarelo': '/pokesuco/pokesucoamarelo.png',
  'Azul': '/pokesuco/pokesucoazul.png',
  'Rosa': '/pokesuco/pokesucorosa.png',
  'Branco': '/pokesuco/pokesucobranco.png',
  'Arco-íris': '/pokesuco/pokesucoarcoiris.png'
}

// Efeitos dos Pokesucos
const POKESUCO_EFEITO_MAP = {
  'Vermelho': 'Adicione 1/4 da qualidade do Suco ao Salto.',
  'Verde': 'Adicione 1/4 da qualidade do Suco à Inteligência.',
  'Amarelo': 'Adicione 1/4 do valor do Suco à Força.',
  'Azul': 'Adicione 1/2 da qualidade do Suco aos Deslocamentos de Escavação, Subaquático e de Voo.',
  'Rosa': 'Adicione 1/2 da qualidade do Suco aos Deslocamentos Terrestre e de Natação.',
  'Fraco': 'Adicione 1/5 da qualidade do Suco ao atributo alvo ou 1/3 aos deslocamentos alvos. Sem gostos fortes, todos os pokémons bebem sem reclamar.',
  'Arco-íris': 'Adiciona 1/4 da qualidade do suco a todos os atributos e deslocamentos. Sem gostos fortes, todos os pokémons bebem sem reclamar.'
}

// Tipos de Pokesuco para a Pokéloja
const POKESUCO_LOJA_TIPOS = ['Vermelho', 'Verde', 'Amarelo', 'Azul', 'Rosa', 'Branco', 'Arco-íris']

// Mapa de pesos para sorteio de itens escondidos na Pokéloja
// Quanto maior o peso, maior a chance de ser escondido
const POKELOJA_HIDE_WEIGHTS = {
  // Captura
  'Pokeball': 1,
  'Greatball': 2,
  'Ultraball': 4,
  'Beastball': 9,
  'Cherishball': 5,
  'Diveball': 5,
  'Dreamball': 9,
  'Duskball': 5,
  'Fastball': 5,
  'Friendball': 5,
  'Healball': 5,
  'Heavyball': 5,
  'Leadenball': 5,
  'Levelball': 5,
  'Loveball': 5,
  'Lunarball': 5,
  'Lureball': 5,
  'Luxuryball': 5,
  'Nestball': 5,
  'Netball': 5,
  'Parkball': 9,
  'Premierball': 9,
  'Quickball': 5,
  'Repeatball': 5,
  'Safariball': 9,
  'Sportball': 9,
  'Timerball': 5,
  'Featherball': 5,
  // Cura
  'Potion': 1,
  'Superpotion': 3,
  'Hiperpotion': 4,
  'Antidoto': 1,
  'Antiparalisante': 1,
  'Despertador': 1,
  'Anticongelante': 1,
  'Revive': 4,
  'Moomoo Milk': 7,
  'Pó Energizante': 7,
  'Raiz Energizante': 7,
  'Panaceia': 3,
  'Pó Curativo': 5,
  'Erva da Sobrevida': 5,
  'Água Solarizada': 2,
  'Refri': 2,
  'Limonada': 3,
  'Lava Cookie': 5,
  'Barra de Pokechocolate Radical': 1,
  'Bala de Coração': 1,
  'Spray para Queimaduras': 1,
  'Concentrado de Sálvia': 5,
  'Poção da Paciência': 5,
  'Poção da Braveza': 5,
  // Repelente
  'Repel': 1,
  'Super Repel': 2,
  'Max Repel': 4,
  'Repel Off': 3,
  // Suplemento
  'Hp-up': 5,
  'Proteína': 5,
  'Ferro': 5,
  'Cálcio': 5,
  'Zinco': 5,
  'Carburante': 5,
  'PP-up': 5,
  'Rare Candy': 9,
  'Éter': 5,
  'Elixir': 6,
  'Suplemento Sortido': 4,
  'Doce não tão raro': 8,
  // Melhoradores
  'X-Ataque': 1,
  'X-Defesa': 1,
  'X-Ataque Especial': 1,
  'X-Defesa Especial': 1,
  'X-Velocidade': 1,
  'X-Acurácia': 1,
  'Golpe Atroz': 3,
  'Guarda Especial': 3,
  'Reforço Natural': 3,
  'Raiz Revigorante': 3,
  'Fumo Rápido': 3,
  'Veneno Sintético': 3
}

// Componente de Combate Interlúdio
function CombateInterludioApp({ darkMode }) {
  const [level, setLevel] = useState(10)
  const [advantage2, setAdvantage2] = useState(false)
  const [advantage4, setAdvantage4] = useState(false)
  const [buffs, setBuffs] = useState(3)
  const [formula, setFormula] = useState('')

  // Calcular d12s baseados no nível
  const calculateD12FromLevel = (lvl) => {
    let d12Count = 0
    if (lvl >= 1) d12Count += 1
    if (lvl >= 10) d12Count += Math.floor(lvl / 10)
    return d12Count
  }

  // Calcular a fórmula
  const calculateFormula = () => {
    const d12Count = calculateD12FromLevel(level)
    let d6Count = 0
    if (advantage2) d6Count += 1
    if (advantage4) d6Count += 2
    const d4Count = buffs

    const formulaParts = []
    if (d12Count > 0) formulaParts.push(`${d12Count}d12`)
    if (d6Count > 0) formulaParts.push(`${d6Count}d6`)
    if (d4Count > 0) formulaParts.push(`${d4Count}d4`)

    setFormula(formulaParts.length > 0 ? formulaParts.join(' + ') : 'Nenhum dado na fórmula')
  }

  useEffect(() => {
    calculateFormula()
  }, [level, advantage2, advantage4, buffs])

  return (
    <div className="space-y-6">
      <div className="text-center mb-4">
        <h2 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-cyan-400' : 'text-blue-600'}`}>
          Calculadora de Fórmulas com Dados
        </h2>
        <p className={`${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
          Insira os valores abaixo para calcular a fórmula baseada em nível, vantagens e buffs.
        </p>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-3 gap-2 sm:gap-3 md:gap-4">
        {/* Nível */}
        <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg p-4`}>
          <label className={`block mb-2 font-bold ${darkMode ? 'text-cyan-400' : 'text-blue-600'}`}>
            Nível (1 a 100)
          </label>
          <input
            type="number"
            min="1"
            max="100"
            value={level}
            onChange={(e) => setLevel(Math.min(100, Math.max(1, parseInt(e.target.value) || 1)))}
            className={`w-full px-3 py-2 rounded border-2 ${
              darkMode
                ? 'bg-gray-700 border-gray-600 text-white'
                : 'bg-white border-gray-300 text-gray-800'
            }`}
          />
        </div>

        {/* Vantagens */}
        <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg p-4`}>
          <label className={`block mb-2 font-bold ${darkMode ? 'text-cyan-400' : 'text-blue-600'}`}>
            Vantagens
          </label>
          <div className="space-y-2">
            <label className="flex items-center gap-2 cursor-pointer">
              <input
                type="checkbox"
                checked={advantage2}
                onChange={(e) => {
                  setAdvantage2(e.target.checked)
                  if (e.target.checked) setAdvantage4(false)
                }}
                className="w-5 h-5"
              />
              <span className={darkMode ? 'text-gray-300' : 'text-gray-700'}>Vantagem x2 (1d6)</span>
            </label>
            <label className="flex items-center gap-2 cursor-pointer">
              <input
                type="checkbox"
                checked={advantage4}
                onChange={(e) => {
                  setAdvantage4(e.target.checked)
                  if (e.target.checked) setAdvantage2(false)
                }}
                className="w-5 h-5"
              />
              <span className={darkMode ? 'text-gray-300' : 'text-gray-700'}>Vantagem x4 (2d6)</span>
            </label>
          </div>
        </div>

        {/* Buffs */}
        <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg p-4`}>
          <label className={`block mb-2 font-bold ${darkMode ? 'text-cyan-400' : 'text-blue-600'}`}>
            Pontos de Buffs (0 a 100)
          </label>
          <input
            type="number"
            min="0"
            max="100"
            value={buffs}
            onChange={(e) => setBuffs(Math.min(100, Math.max(0, parseInt(e.target.value) || 0)))}
            className={`w-full px-3 py-2 rounded border-2 ${
              darkMode
                ? 'bg-gray-700 border-gray-600 text-white'
                : 'bg-white border-gray-300 text-gray-800'
            }`}
          />
        </div>
      </div>

      {/* Resultado */}
      <div className={`${darkMode ? 'bg-gray-800 border-blue-500' : 'bg-white border-blue-400'} border-l-4 rounded-lg p-3 sm:p-5 md:p-6`}>
        <h3 className={`text-lg sm:text-xl font-bold mb-4 ${darkMode ? 'text-cyan-400' : 'text-blue-600'}`}>
          Fórmula Resultante:
        </h3>
        <div className={`text-2xl sm:text-3xl font-mono font-bold text-center py-3 sm:py-5 md:py-6 rounded-lg ${
          darkMode ? 'bg-gray-700 text-white' : 'bg-gray-100 text-gray-800'
        }`}>
          {formula}
        </div>

        <div className={`mt-6 pt-4 border-t ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
          <p className={`font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Explicação da fórmula:</p>
          <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} rounded-lg p-4 mb-3`}>
            <p className={`font-semibold ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Nível:</p>
            <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
              Do nível 1 ao 9, adiciona-se 1d12. Adiciona-se 1d12 extra nos níveis 10, 20, 30, 40, 50, 60, 70, 80, 90, 100.
            </p>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-2 mt-2">
              <div className={`text-center py-1 rounded ${darkMode ? 'bg-gray-600' : 'bg-white'}`}>
                <span className={`text-xs ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>Nível 1-9: 1d12</span>
              </div>
              <div className={`text-center py-1 rounded ${darkMode ? 'bg-gray-600' : 'bg-white'}`}>
                <span className={`text-xs ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>Nível 10-19: 2d12</span>
              </div>
              <div className={`text-center py-1 rounded ${darkMode ? 'bg-gray-600' : 'bg-white'}`}>
                <span className={`text-xs ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>Nível 20-29: 3d12</span>
              </div>
              <div className={`text-center py-1 rounded ${darkMode ? 'bg-gray-600' : 'bg-white'}`}>
                <span className={`text-xs ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>Nível 30-39: 4d12</span>
              </div>
            </div>
          </div>
          <ul className={`list-disc list-inside space-y-1 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
            <li><strong>Vantagem x2:</strong> Adiciona 1d6 à fórmula</li>
            <li><strong>Vantagem x4:</strong> Adiciona 2d6 à fórmula</li>
            <li><strong>Pontos de Buffs:</strong> Cada ponto adiciona 1d4 à fórmula</li>
          </ul>
          <div className="flex justify-center gap-2 sm:gap-3 md:gap-4 mt-4">
            <div className="w-12 h-12 bg-pink-600 rounded-lg flex items-center justify-center font-bold text-white">d12</div>
            <div className="w-12 h-12 bg-cyan-500 rounded-lg flex items-center justify-center font-bold text-white">d6</div>
            <div className="w-12 h-12 bg-purple-600 rounded-lg flex items-center justify-center font-bold text-white">d4</div>
          </div>
        </div>
      </div>
    </div>
  )
}

// Componente de Concurso Interlúdio
function ConcursoInterludioApp({ darkMode }) {
  const aptitudes = ['Vigor', 'Estilo', 'Beleza', 'Ternura', 'Perspicácia']

  const contestTags = [
    { tag: 'Abertura', score: '2d4', effect: '+2d4 à Pontuação se for o primeiro da rodada.' },
    { tag: 'Abstração', score: '2d4', effect: 'A Expectativa do Jurado não poderá ser aumentada durante aquela rodada.' },
    { tag: 'Clímax', score: '0', effect: 'Dobre a Pontuação que ganhar na próxima rodada.' },
    { tag: 'Cobiça', score: '0', effect: 'Reduza à metade a Pontuação do competidor que Pontuou imediatamente antes e adicione a quantidade reduzida à sua Pontuação.' },
    { tag: 'Conquista', score: '2d4', effect: 'A Expectativa do Jurado não poderá ser reduzida durante aquela rodada.' },
    { tag: 'Constrangimento', score: '2d4', effect: 'Independentemente da Aptidão do Golpe, ele sempre reduz em 1 a Expectativa de todos os Jurados.' },
    { tag: 'Continuação', score: '0', effect: 'A Pontuação deste Golpe é 1d4 se for o primeiro ou o segundo da rodada; 2d4 se for o terceiro ou o quarto da rodada; ou 3d4 se for o último da rodada.' },
    { tag: 'Dedicatória', score: '1d4', effect: '+3d4 se nenhum outro competidor escolheu o mesmo Jurado naquela rodada.' },
    { tag: 'Desfecho', score: '0', effect: 'A Pontuação deste Golpe se torna 15d4 se todos os competidores se apresentaram para o mesmo jurado. Só é possível usar um Golpe com este Descritor se o competidor for o quarto ou quinto na ordem da rodada.' },
    { tag: 'Despedida', score: '2d4', effect: 'Dobre a Pontuação se estiver na última rodada da Apelação.' },
    { tag: 'Encerramento', score: '2d4', effect: '+2d4 à Pontuação se for o último da rodada.' },
    { tag: 'Entrada', score: '2d4', effect: 'Na próxima rodada, o competidor será o primeiro da rodada.' },
    { tag: 'Especial', score: '0', effect: 'Na próxima rodada, o competidor poderá escolher sua posição na ordem da rodada.' },
    { tag: 'Excentricidade', score: '2d4', effect: 'A Pontuação deste Golpe é Xd4, em que X é igual a 6 - a Expectativa do Jurado antes do Golpe.' },
    { tag: 'Extravagância', score: '0', effect: 'Independentemente da Aptidão do Golpe, ele sempre aumenta em 1 a Expectativa de todos os Jurados.' },
    { tag: 'Incentivo', score: '2d4', effect: '+2d4 se o Golpe aumentar a Expectativa.' },
    { tag: 'Modelo', score: '0', effect: 'A Pontuação deste Golpe é Xd4, em que X é a Expectativa do Jurado antes do Golpe.' },
    { tag: 'Modéstia', score: '2d4', effect: 'Este Golpe pode ser usado várias rodadas seguidas e ainda obter o benefício de +1d4, desde que seja da Aptidão associada ao Concurso.' },
    { tag: 'Originalidade', score: '0', effect: 'Independentemente da Aptidão do Golpe, ele sempre aumenta em 2 a Expectativa do Jurado.' },
    { tag: 'Pausa', score: '2d4', effect: 'Na próxima rodada, o competidor será o último da rodada.' },
    { tag: 'Perspectiva', score: '2d4', effect: '+3d4 se a Expectativa do Jurado atingiu a Expectativa máxima durante a rodada.' },
    { tag: 'Proveito', score: '1d4', effect: '+3d4 à Pontuação se houve algum aumento de Expectativa nas últimas duas rodadas da Apelação.' },
    { tag: 'Reviravolta', score: '1d4', effect: '+3d4 à Pontuação se possuir a menor Pontuação.' },
    { tag: 'Segurança', score: '3d4', effect: 'Não tem.' },
    { tag: 'Sorteio', score: '2d4', effect: 'Na próxima rodada, a ordem será necessariamente sorteada.' },
    { tag: 'Surpresa', score: '2d4', effect: 'Este Golpe sempre é o primeiro da rodada, ignorando a ordem.' }
  ]

  const pokemonNames = [
    'Pikachu', 'Eevee', 'Bulbasaur', 'Charmander', 'Squirtle',
    'Jigglypuff', 'Meowth', 'Psyduck', 'Snorlax', 'Lucario',
    'Gardevoir', 'Gengar', 'Dragonite', 'Mewtwo', 'Mew',
    'Charizard', 'Blastoise', 'Venusaur', 'Gyarados', 'Arcanine'
  ]

  const [selectedAptitude, setSelectedAptitude] = useState('Vigor')
  const [pokemonCount, setPokemonCount] = useState(5)
  const [pokemonList, setPokemonList] = useState([])
  const [stats, setStats] = useState({ selected: 0, total: 0 })

  // Rolar dados
  const rollDice = (diceString) => {
    if (diceString === '0') return 0
    const [numDice, diceType] = diceString.split('d').map(Number)
    let total = 0
    for (let i = 0; i < numDice; i++) {
      total += Math.floor(Math.random() * diceType) + 1
    }
    return total
  }

  // Gerar golpe aleatório com aptidão ponderada
  const generateRandomMove = (aptitude) => {
    const weightedAptitudes = [...aptitudes, aptitude]
    const randomAptitude = weightedAptitudes[Math.floor(Math.random() * weightedAptitudes.length)]
    const randomTag = contestTags[Math.floor(Math.random() * contestTags.length)]
    return { aptitude: randomAptitude, tag: randomTag }
  }

  // Gerar Pokémon
  const generatePokemon = () => {
    let selectedCount = 0
    let totalMoves = 0
    const newList = []

    for (let i = 0; i < pokemonCount; i++) {
      const moves = []
      for (let j = 0; j < 4; j++) {
        const move = generateRandomMove(selectedAptitude)
        moves.push(move)
        totalMoves++
        if (move.aptitude === selectedAptitude) selectedCount++
      }
      newList.push({
        id: i + 1,
        name: pokemonNames[Math.floor(Math.random() * pokemonNames.length)],
        moves,
        score: null,
        scoreDetails: null
      })
    }

    setPokemonList(newList)
    setStats({ selected: selectedCount, total: totalMoves })
  }

  // Calcular pontuação de um Pokémon
  const calculatePokemonScore = (pokemonId) => {
    setPokemonList(prev => prev.map(pokemon => {
      if (pokemon.id !== pokemonId) return pokemon

      let totalScore = 0
      const details = []

      pokemon.moves.forEach((move, idx) => {
        let score = rollDice(move.tag.score)
        if (move.aptitude === selectedAptitude) {
          score += rollDice('1d4')
        }
        details.push({ move: `${move.aptitude} - ${move.tag.tag}`, score })
        totalScore += score
      })

      return { ...pokemon, score: totalScore, scoreDetails: details }
    }))
  }

  // Calcular todas as pontuações
  const calculateAllScores = () => {
    pokemonList.forEach(p => calculatePokemonScore(p.id))
  }

  useEffect(() => {
    generatePokemon()
  }, [])

  return (
    <div className="space-y-6">
      <div className="text-center mb-4">
        <h2 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-purple-400' : 'text-purple-600'}`}>
          Calculadora de Concurso Pokémon
        </h2>
        <p className={`${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
          Sorteie golpes para concursos Pokémon e calcule suas notas. A aptidão selecionada tem <span className={`font-bold px-1 rounded ${darkMode ? 'bg-yellow-600' : 'bg-yellow-200'}`}>peso 2</span> no sorteio dos golpes.
        </p>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-2 sm:gap-3 md:gap-4">
        {/* Configurações */}
        <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg p-4`}>
          <h3 className={`font-bold mb-3 ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>Configurações do Concurso</h3>

          <div className="mb-4">
            <label className={`block mb-2 font-semibold ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Aptidão:</label>
            <select
              value={selectedAptitude}
              onChange={(e) => setSelectedAptitude(e.target.value)}
              className={`w-full px-3 py-2 rounded border-2 ${
                darkMode
                  ? 'bg-gray-700 border-gray-600 text-white'
                  : 'bg-white border-gray-300 text-gray-800'
              }`}
            >
              {aptitudes.map(apt => (
                <option key={apt} value={apt}>{apt}</option>
              ))}
            </select>
            <p className={`text-sm mt-2 p-2 rounded ${darkMode ? 'bg-blue-900 text-blue-300' : 'bg-blue-100 text-blue-700'}`}>
              A aptidão selecionada terá <strong>peso 2</strong> no sorteio dos golpes.
            </p>
          </div>

          <div className="mb-4">
            <label className={`block mb-2 font-semibold ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Número de Pokémon (1-20):</label>
            <input
              type="number"
              min="1"
              max="20"
              value={pokemonCount}
              onChange={(e) => setPokemonCount(Math.min(20, Math.max(1, parseInt(e.target.value) || 1)))}
              className={`w-full px-3 py-2 rounded border-2 ${
                darkMode
                  ? 'bg-gray-700 border-gray-600 text-white'
                  : 'bg-white border-gray-300 text-gray-800'
              }`}
            />
          </div>

          <div className="flex gap-2">
            <button
              onClick={generatePokemon}
              className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold"
            >
              Sortear Golpes
            </button>
            <button
              onClick={calculateAllScores}
              className="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold"
            >
              Calcular Notas
            </button>
          </div>

          {/* Estatísticas */}
          <div className="grid grid-cols-3 gap-2 mt-4">
            <div className={`text-center p-2 rounded ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
              <div className={`text-lg sm:text-xl font-bold ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>{stats.selected}</div>
              <div className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Aptidão selecionada</div>
            </div>
            <div className={`text-center p-2 rounded ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
              <div className={`text-lg sm:text-xl font-bold ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>{stats.total}</div>
              <div className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Total de golpes</div>
            </div>
            <div className={`text-center p-2 rounded ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
              <div className={`text-lg sm:text-xl font-bold ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>
                {stats.total > 0 ? Math.round((stats.selected / stats.total) * 100) : 0}%
              </div>
              <div className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Porcentagem</div>
            </div>
          </div>
        </div>

        {/* Lista de Pokémon */}
        <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg p-4 max-h-96 overflow-y-auto`}>
          <h3 className={`font-bold mb-3 ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>Pokémon e Seus Golpes</h3>

          <div className="space-y-3">
            {pokemonList.map(pokemon => (
              <div key={pokemon.id} className={`${darkMode ? 'bg-gray-700' : 'bg-gray-50'} rounded-lg p-3 border-l-4 border-red-500`}>
                <div className="flex justify-between items-center mb-2">
                  <span className={`font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{pokemon.name}</span>
                  <span className="w-7 h-7 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm font-bold">
                    {pokemon.id}
                  </span>
                </div>

                <div className="space-y-1">
                  {pokemon.moves.map((move, idx) => (
                    <div key={idx} className={`${darkMode ? 'bg-gray-600' : 'bg-white'} p-2 rounded border-l-2 border-blue-500`}>
                      <span className={`font-semibold ${move.aptitude === selectedAptitude ? 'text-green-500' : 'text-red-400'}`}>
                        {move.aptitude}{move.aptitude === selectedAptitude ? ' ✓' : ''}
                      </span>
                      <span className={darkMode ? 'text-gray-300' : 'text-gray-700'}> - </span>
                      <span className={`font-semibold ${darkMode ? 'text-gray-200' : 'text-gray-800'}`}>{move.tag.tag}</span>
                      <div className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Pontuação basal: {move.tag.score}</div>
                    </div>
                  ))}
                </div>

                <button
                  onClick={() => calculatePokemonScore(pokemon.id)}
                  className="mt-2 w-full px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-sm font-semibold"
                >
                  Calcular nota
                </button>

                {pokemon.score !== null && (
                  <div className={`mt-2 p-2 rounded text-center ${darkMode ? 'bg-gray-600' : 'bg-gray-200'}`}>
                    <div className={`font-bold text-lg ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                      Pontuação Total: {pokemon.score}
                    </div>
                    {pokemon.scoreDetails && (
                      <div className={`text-xs mt-1 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                        {pokemon.scoreDetails.map((d, i) => (
                          <div key={i}>{i + 1}. {d.move}: {d.score}</div>
                        ))}
                      </div>
                    )}
                  </div>
                )}
              </div>
            ))}
          </div>
        </div>
      </div>

      {/* Tabela de Tags */}
      <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg p-4`}>
        <h3 className={`font-bold mb-3 ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>Tags de Concurso e Seus Efeitos</h3>
        <div className="overflow-x-auto">
          <table className="w-full text-sm">
            <thead>
              <tr className="bg-blue-600 text-white">
                <th className="p-2 text-left">Tag de Concurso</th>
                <th className="p-2 text-left">Pontuação Basal</th>
                <th className="p-2 text-left">Efeito</th>
              </tr>
            </thead>
            <tbody>
              {contestTags.map((tag, idx) => (
                <tr key={tag.tag} className={idx % 2 === 0 ? (darkMode ? 'bg-gray-700' : 'bg-gray-50') : (darkMode ? 'bg-gray-800' : 'bg-white')}>
                  <td className={`p-2 font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{tag.tag}</td>
                  <td className={`p-2 ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>{tag.score}</td>
                  <td className={`p-2 ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>{tag.effect}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  )
}

function App() {
  const [currentUser, setCurrentUser] = useState(null)
  const [sessionBg, setSessionBg] = useState(null)
  const [showPokezapPanel, setShowPokezapPanel] = useState(false)
  const [showBatalhaChat, setShowBatalhaChat] = useState(false)
  const [pokezapMessages, setPokezapMessages] = useState([])
  const [pokezapInput, setPokezapInput] = useState('')
  const [pokezapRecipients, setPokezapRecipients] = useState([])
  const [showPokezapRecipientPicker, setShowPokezapRecipientPicker] = useState(false)
  const [dataLoaded, setDataLoaded] = useState(false) // Flag para evitar salvar antes de carregar
  const [currentArea, setCurrentArea] = useState('')
  const [darkMode, setDarkMode] = useState(true)
  const [sidebarOpen, setSidebarOpen] = useState(false)
  const [sidebarPinned, setSidebarPinned] = useState(() => localStorage.getItem('sidebarPinned') === 'true')
  const [selectedUser, setSelectedUser] = useState(null)
  const [password, setPassword] = useState('')
  const [error, setError] = useState('')
  
  // Estado do treinador
  const [level, setLevel] = useState(1)
  const [image, setImage] = useState('')
  const [classes, setClasses] = useState(['', '', '', ''])
  const [attributes, setAttributes] = useState({
    saude: 10, ataque: 10, defesa: 10, ataqueEspecial: 10, defesaEspecial: 10, velocidade: 10
  })
  const [skills, setSkills] = useState({
    saude: [], ataque: [], defesa: [], ataqueEspecial: [], defesaEspecial: [], velocidade: []
  })
  const [currentHP, setCurrentHP] = useState(44)
  
  // Estado dos Pokémon
  const [mainTeam, setMainTeam] = useState([])
  const [pcPokemon, setPcPokemon] = useState([])
  const [pokedex, setPokedex] = useState([])
  const [showSwapPokemonModal, setShowSwapPokemonModal] = useState(false) // Modal de troca de pokémon
  const [swapMainTeamSearch, setSwapMainTeamSearch] = useState('') // Pesquisa do time principal
  const [swapPcSearch, setSwapPcSearch] = useState('') // Pesquisa do PC
  const [selectedSwapMainTeam, setSelectedSwapMainTeam] = useState(null) // Pokémon selecionado do time principal
  const [selectedSwapPc, setSelectedSwapPc] = useState(null) // Pokémon selecionado do PC
  const [npcPokemonList, setNpcPokemonList] = useState([]) // Pokémon gerados recentemente
  const [npcPokemon, setNpcPokemon] = useState([]) // Pokémon confirmados como NPC
  const [expandedNpcCards, setExpandedNpcCards] = useState([]) // IDs dos cards expandidos
  const [showNpcDamageModal, setShowNpcDamageModal] = useState(false) // Modal de dano/cura NPC
  const [selectedNpcPokemon, setSelectedNpcPokemon] = useState(null) // Pokémon NPC selecionado para dano/cura
  const [npcDamageAmount, setNpcDamageAmount] = useState('') // Quantidade de dano/cura
  const [npcConditions, setNpcConditions] = useState({}) // Condições de captura por pokémon {pokemonId: {confusao: false, critico: false, ...}}
  const [npcAlfaStatus, setNpcAlfaStatus] = useState({}) // Status Alfa por pokémon NPC {pokemonId: true/false}
  // Hub de Troca
  const [tradeHubOffers, setTradeHubOffers] = useState([]) // Array de ofertas de troca
  const [tradeHubCompletedTrades, setTradeHubCompletedTrades] = useState({}) // {tradeId: trainerUsername}
  const [expandedTradeCards, setExpandedTradeCards] = useState({}) // Cards expandidos no hub de troca
  const [tradeHubAlfaStatus, setTradeHubAlfaStatus] = useState({}) // Alfa status para pokémon do hub
  const [tradeHubConditions, setTradeHubConditions] = useState({}) // Condições dos pokémon do hub
  const ALL_TRADE_REGIOES = ['Kanto','Johto','Hoenn','Sinnoh','Unova','Kalos','Alola','Galar','Paldea']
  const [tradeHubRegioesOferecidos, setTradeHubRegioesOferecidos] = useState(['Kanto','Johto','Hoenn','Sinnoh','Unova','Kalos','Alola','Galar','Paldea'])
  const [tradeHubRegioesExigidos, setTradeHubRegioesExigidos] = useState(['Kanto','Johto','Hoenn','Sinnoh','Unova','Kalos','Alola','Galar','Paldea'])
  const [showTradeRegioesModal, setShowTradeRegioesModal] = useState(false)
  const [showTradeConfirmModal, setShowTradeConfirmModal] = useState(false)
  const [selectedTradeOffer, setSelectedTradeOffer] = useState(null)
  const [selectedTradeUserPokemon, setSelectedTradeUserPokemon] = useState(null)
  const [showTradeSelectPokemonModal, setShowTradeSelectPokemonModal] = useState(false)
  const [showSendToTrainerModal, setShowSendToTrainerModal] = useState(false) // Modal de envio para treinador
  const [pokemonToSend, setPokemonToSend] = useState(null) // Pokémon NPC a ser enviado
  const [sendPokemonSpecies, setSendPokemonSpecies] = useState('') // Espécie do pokémon a enviar (editável)
  const [sendPokemonNature, setSendPokemonNature] = useState(null) // Natureza do pokémon a enviar (editável)
  const [speciesSearchSend, setSpeciesSearchSend] = useState('') // Busca de espécie no modal de envio
  const [natureSearchSend, setNatureSearchSend] = useState('') // Busca de natureza no modal de envio
  const [showAbilityModal, setShowAbilityModal] = useState(false) // Modal de detalhes da habilidade
  const [selectedAbility, setSelectedAbility] = useState(null) // Habilidade selecionada
  const [showSendXpModal, setShowSendXpModal] = useState(false) // Modal de envio de XP para treinadores
  const [selectedNpcPokemonForXp, setSelectedNpcPokemonForXp] = useState(null) // Pokémon NPC selecionado para enviar XP
  const [selectedTrainersForXp, setSelectedTrainersForXp] = useState({}) // Treinadores selecionados para receber XP
  const [openPokemonSection, setOpenPokemonSection] = useState(null) // { pokemon, section } — pop-up mobile de seção do card

  // ===== BATALHA GAME BOY =====
  const [gbBattleData, setGbBattleData] = useState({
    npcPokemon: [],           // NPCs enviados pelo mestre [{...pokemonData, pokeball, id}]
    allowedUsers: {},         // { username: 'red'|'blue'|false } - permissão e time
    battleMode: 'individual', // 'individual' | 'dupla'
  })
  const [gbChatMessages, setGbChatMessages] = useState([])
  const [gbChatInput, setGbChatInput] = useState('')
  const [gbActivePokemon, setGbActivePokemon] = useState({}) // { username: [pokemonId] } - pokémon "fora da pokébola"
  const [gbSelectedTargets, setGbSelectedTargets] = useState([]) // [pokemonId] - alvos selecionados para golpe
  const [gbTempBattleStats, setGbTempBattleStats] = useState({}) // { pokemonId: { stages: {ataque:0,...}, accuracyDebuff: 0 } }
  const gbBattleSaveSkipRef = useRef(true)

  // ===== TIMES NPC =====
  const [npcTeams, setNpcTeams] = useState([])
  const [npcTeamSelectingSlot, setNpcTeamSelectingSlot] = useState(null) // { teamId, slotType: 'trainer'|'pokemon', slotIndex }
  const [npcTeamSearchQuery, setNpcTeamSearchQuery] = useState('')
  const npcTeamsSaveSkipRef = useRef(true)

  // ===== CENÁRIOS DA SESSÃO =====
  const [sessionScenarios, setSessionScenarios] = useState([])
  const [showAddScenarioModal, setShowAddScenarioModal] = useState(false)
  const [editingScenario, setEditingScenario] = useState(null)
  const [scenarioForm, setScenarioForm] = useState({ title: '', imageUrls: [''] })
  const [scenarioDragIndex, setScenarioDragIndex] = useState(null)
  const [scenarioDisplay, setScenarioDisplay] = useState(null) // { active, scenarioId, currentImageIndex }
  const [playerScenarioPopupOpen, setPlayerScenarioPopupOpen] = useState(false)
  const sessionScenariosSaveSkipRef = useRef(true)
  const scenarioDisplaySaveSkipRef = useRef(true)

  // Estados de pesquisa, filtro e paginação do PC
  const [pcSearchQuery, setPcSearchQuery] = useState('') // Busca por nome/espécie no PC
  const [pcTypeFilter, setPcTypeFilter] = useState('') // Filtro de tipo no PC
  const [pcPage, setPcPage] = useState(0) // Página atual do PC (grid 5x4)

  // Estados para Sedex Pkm
  const [showSedexPkmModal, setShowSedexPkmModal] = useState(false) // Modal de envio de pokémon
  const [sedexPkmSearch, setSedexPkmSearch] = useState('') // Busca de pokémon no modal Sedex
  const [selectedSedexPkm, setSelectedSedexPkm] = useState(null) // Pokémon selecionado para envio
  const [selectedSedexPkmTrainer, setSelectedSedexPkmTrainer] = useState('') // Treinador destinatário

  // Estados de pesquisa e filtro da Pokédex
  const [pokedexSearchQuery, setPokedexSearchQuery] = useState('') // Busca por espécie na Pokédex
  const [pokedexTypeFilter, setPokedexTypeFilter] = useState('') // Filtro de tipo na Pokédex para ver detalhes

  // Estados para área de Batalha
  const [battleTrainers, setBattleTrainers] = useState([]) // Treinadores enviados para batalha
  const [battlePokemon, setBattlePokemon] = useState([]) // Pokémon enviados para batalha
  const [battleTrainersList, setBattleTrainersList] = useState([]) // Lista ordenada de treinadores em batalha
  const [battlePokemonList, setBattlePokemonList] = useState([]) // Lista ordenada de pokémon em batalha
  const [currentTrainerTurn, setCurrentTrainerTurn] = useState(0) // Índice do turno atual dos treinadores
  const [currentPokemonTurn, setCurrentPokemonTurn] = useState(0) // Índice do turno atual dos pokémon
  const [trainerRound, setTrainerRound] = useState(1) // Rodada atual dos treinadores
  const [pokemonRound, setPokemonRound] = useState(1) // Rodada atual dos pokémon
  const [battlePokemonConditions, setBattlePokemonConditions] = useState({}) // Condições dos pokémons em batalha {pokemonId: [{condition, rounds}, ...]}
  const pokemonBattleRefs = useRef([]) // Refs para os elementos dos pokémons em batalha
  const [selectedTeamPokemon, setSelectedTeamPokemon] = useState(null) // Pokémon selecionado do time principal para ver detalhes

  // Estados para Dano/Cura Treinador em Batalha
  const [showTrainerBattleDamageModal, setShowTrainerBattleDamageModal] = useState(false)
  const [trainerBattleDamageAmount, setTrainerBattleDamageAmount] = useState('')
  const [armaDeEscolha, setArmaDeEscolha] = useState(false) // Checkbox "Arma de escolha" - muda tabela de dano do treinador

  // Estados para Dano/Cura Treinador NPC em Batalha (Mestre)
  const [showNpcTrainerBattleDamageModal, setShowNpcTrainerBattleDamageModal] = useState(false)
  const [npcTrainerBattleDamageAmount, setNpcTrainerBattleDamageAmount] = useState('')
  const [selectedNpcTrainerForDamage, setSelectedNpcTrainerForDamage] = useState(null)

  // Estados para Dano/Cura Pokémon NPC em Batalha (Mestre)
  const [showNpcPokemonBattleDamageModal, setShowNpcPokemonBattleDamageModal] = useState(false)
  const [npcPokemonBattleDamageAmount, setNpcPokemonBattleDamageAmount] = useState('')
  const [selectedNpcPokemonForDamage, setSelectedNpcPokemonForDamage] = useState(null)

  const [showBattleMoveModal, setShowBattleMoveModal] = useState(false) // Modal de golpe na batalha
  const [selectedBattleMove, setSelectedBattleMove] = useState(null) // Golpe selecionado na batalha
  const [showBattleAbilityModal, setShowBattleAbilityModal] = useState(false) // Modal de habilidade na batalha
  const [selectedBattleAbility, setSelectedBattleAbility] = useState(null) // Habilidade selecionada na batalha
  const [userBattleModifiers, setUserBattleModifiers] = useState({}) // {username: [...modifiers]} - Modificadores de batalha por usuário
  const [showModifierModal, setShowModifierModal] = useState(false) // Modal de adicionar/editar modificador
  const [modifierForm, setModifierForm] = useState({ nome: '', mod: '', descricao: '', aplicarAcuracia: false, aplicarDano: false, aplicarCaptura: false, usosACadaXLvl: '' }) // Formulário de modificador
  const [editingModifierIndex, setEditingModifierIndex] = useState(null) // Índice do modificador sendo editado
  const [showModifierDetailsModal, setShowModifierDetailsModal] = useState(false) // Modal de detalhes do modificador
  const [selectedModifier, setSelectedModifier] = useState(null) // Modificador selecionado para ver detalhes
  const [userActiveModifiers, setUserActiveModifiers] = useState({}) // {username: [...activeIndexes]} - Lista de índices dos modificadores ativos por usuário
  const [isCritical, setIsCritical] = useState(false) // Checkbox CRIT
  const [showCaptureModal, setShowCaptureModal] = useState(false) // Modal de captura
  const [selectedPokeball, setSelectedPokeball] = useState(null) // Pokébola selecionada para captura
  const [selectedPokeballModifier, setSelectedPokeballModifier] = useState('') // Modificador selecionado da pokébola
  const [customPokeballModifier, setCustomPokeballModifier] = useState('') // Modificador customizado
  const [selectedMasterNpcPokemon, setSelectedMasterNpcPokemon] = useState(null) // Pokémon NPC selecionado pelo mestre na área Batalha
  const [revealedNpcPokemon, setRevealedNpcPokemon] = useState({}) // {pokemonId: boolean} - controla se nome/tipo está revelado
  const [revealedTrainers, setRevealedTrainers] = useState({}) // {trainerId: boolean} - controla se nome do treinador está revelado
  const [pokemonStages, setPokemonStages] = useState({}) // {pokemonId: {ataque: 0, ataqueEspecial: 0, defesa: 0, defesaEspecial: 0, velocidade: 0, precisao: 0}}
  const [trainerStages, setTrainerStages] = useState({}) // {trainerId: {ataque: 0, ataqueEspecial: 0, defesa: 0, defesaEspecial: 0, velocidade: 0, precisao: 0}}
  const [battleTrainerConditions, setBattleTrainerConditions] = useState({}) // {trainerId: [{condition, rounds}, null, null]}
  const [showModifiersSection, setShowModifiersSection] = useState(false) // Controla expansão da seção Modificadores
  const [showCaptureSection, setShowCaptureSection] = useState(false) // Controla expansão da seção Lançar Pokébola
  const [showHealingSection, setShowHealingSection] = useState(false) // Controla expansão da seção Cura em Batalha
  const [showHealingModal, setShowHealingModal] = useState(false) // Modal de cura
  const [selectedHealingItem, setSelectedHealingItem] = useState(null) // Item de cura selecionado
  const [showTalentosSection, setShowTalentosSection] = useState(false) // Controla expansão da seção Talentos em Jogo
  const [talentinhos, setTalentinhos] = useState([]) // Lista de talentinhos [{nome, expressao, alvos: []}, ...]
  const [showTalentinhoModal, setShowTalentinhoModal] = useState(false) // Modal de adicionar/editar talentinho
  const [talentinhoForm, setTalentinhoForm] = useState({ nome: '', expressao: '', alvos: [], usosACadaXLvl: '' }) // Formulário de talentinho
  const [editingTalentinhoIndex, setEditingTalentinhoIndex] = useState(null) // Índice do talentinho sendo editado
  const [showTalentinhoDetailModal, setShowTalentinhoDetailModal] = useState(false) // Modal de detalhes do talentinho
  const [selectedTalentinhoDetail, setSelectedTalentinhoDetail] = useState(null) // Talentinho selecionado para ver detalhes
  const [showLimitesUsoSection, setShowLimitesUsoSection] = useState(false) // Controla expansão da seção Limites de Uso
  const [modifierUsosAtuais, setModifierUsosAtuais] = useState({}) // {modifierIndex: usosRestantes} - Usos atuais dos modificadores
  const [talentinhoUsosAtuais, setTalentinhoUsosAtuais] = useState({}) // {talentinhoIndex: usosRestantes} - Usos atuais dos talentinhos
  const [shinyCharmUsoDiario, setShinyCharmUsoDiario] = useState(true) // Se o Shiny Charm ainda pode ser usado hoje
  const [limitesUsoPersonalizados, setLimitesUsoPersonalizados] = useState([]) // Array de limites de uso personalizados
  const [limitesUsoPersonalizadosUsosAtuais, setLimitesUsoPersonalizadosUsosAtuais] = useState({}) // {index: usosRestantes}
  const [showAddLimiteUsoModal, setShowAddLimiteUsoModal] = useState(false) // Modal de adicionar limite de uso
  const [limiteUsoForm, setLimiteUsoForm] = useState({ nome: '', usosACadaXLvl: '', fontes: { talento: false, item: false, outros: false } }) // Formulário de limite de uso

  // States para menus de Interlúdio
  const [showIntTalentosMenu, setShowIntTalentosMenu] = useState(false) // Menu Int. Talentos
  const [showIntLUMenu, setShowIntLUMenu] = useState(false) // Menu Int. L.U.
  const [showPokebolVaiMenu, setShowPokebolVaiMenu] = useState(false) // Menu Pokébola, Vai!
  const [showCuraInterludioMenu, setShowCuraInterludioMenu] = useState(false) // Menu Cura no Interlúdio

  // States para Interlúdio M (mestre)
  const [interludioMSelectedTrainer, setInterludioMSelectedTrainer] = useState(null) // Treinador selecionado no Interlúdio M
  const [interludioMTrainerData, setInterludioMTrainerData] = useState(null) // Dados do treinador selecionado no Interlúdio M
  const [interludioMApp, setInterludioMApp] = useState(null) // App selecionado no Interlúdio M ('combate' ou 'concurso')
  const [showIntMTalentosMenu, setShowIntMTalentosMenu] = useState(false) // Menu Int. Talentos no Interlúdio M
  const [showIntMLUMenu, setShowIntMLUMenu] = useState(false) // Menu Int. L.U. no Interlúdio M
  const [showIntMPokebolVaiMenu, setShowIntMPokebolVaiMenu] = useState(false) // Menu Pokébola, Vai! no Interlúdio M
  const [showIntMCuraMenu, setShowIntMCuraMenu] = useState(false) // Menu Cura no Interlúdio M
  const [showRegrasInterludioModal, setShowRegrasInterludioModal] = useState(false) // Modal de Regras do Interlúdio

  // Modais
  const [showLevelModal, setShowLevelModal] = useState(false)
  const [showClassModal, setShowClassModal] = useState(false)
  const [showImageModal, setShowImageModal] = useState(false)
  const [showImagePCModal, setShowImagePCModal] = useState(false)
  const [showHPModal, setShowHPModal] = useState(false)
  const [showBattleHPModal, setShowBattleHPModal] = useState(false)
  const [battleHpValue, setBattleHpValue] = useState('')
  const [selectedBattlePokemon, setSelectedBattlePokemon] = useState(null)

  // Estados para botões Físico/Especial nos modais de dano
  const [showDamageTypeButtons, setShowDamageTypeButtons] = useState(false) // Mostra botões Físico/Especial após clicar em Dano
  const [pendingDamageValue, setPendingDamageValue] = useState(0) // Valor de dano pendente para aplicar
  const [pendingDamageContext, setPendingDamageContext] = useState(null) // Contexto do dano: 'battlePokemon', 'trainer', 'trainerBattle', 'npcPokemon', 'npcPokemonBattle'
  const [showAddPokemonModal, setShowAddPokemonModal] = useState(false)
  const [showXPModal, setShowXPModal] = useState(false)
  const [showHappinessModal, setShowHappinessModal] = useState(false)
  const [happinessAmount, setHappinessAmount] = useState('')
  const [selectedPokemonHappinessIndex, setSelectedPokemonHappinessIndex] = useState(null)
  const [showTrainerImageModal, setShowTrainerImageModal] = useState(false)
  const [trainerImageUrl, setTrainerImageUrl] = useState('')
  const [trainerImageUploadType, setTrainerImageUploadType] = useState('link') // 'link' ou 'file'
  const [currentSlot, setCurrentSlot] = useState(null)
  const [tempLevel, setTempLevel] = useState('')
  const [imageUrl, setImageUrl] = useState('')
  const [classSearch, setClassSearch] = useState('')
  const [hpValue, setHpValue] = useState('')
  const [selectedPokemonIndex, setSelectedPokemonIndex] = useState(null)
  const [xpToAdd, setXpToAdd] = useState('')
  const [xpBonus, setXpBonus] = useState('')
  const [showPokedexDetailModal, setShowPokedexDetailModal] = useState(false)
  const [selectedPokedexEntry, setSelectedPokedexEntry] = useState(null)

  // States para capacidades
  const [selectedCapacityForInfo, setSelectedCapacityForInfo] = useState(null)
  const [showCapacityInfoModal, setShowCapacityInfoModal] = useState(false)
  const [capacitySearch, setCapacitySearch] = useState('')
  const [otherCapacities, setOtherCapacities] = useState([]) // Array de slots dinâmicos

  // States para sistema de Habilidades
  const [showHabilidadesModal, setShowHabilidadesModal] = useState(false)
  const [selectedPokemonForHabilidades, setSelectedPokemonForHabilidades] = useState(null)
  const [selectedPokemonTypeForHabilidades, setSelectedPokemonTypeForHabilidades] = useState(null) // 'team' ou 'pc'
  const [habilidadesSearch, setHabilidadesSearch] = useState('')
  const [habilidadesSelectedList, setHabilidadesSelectedList] = useState([]) // Lista de habilidades selecionadas
  const [showHabilidadeDetailModal, setShowHabilidadeDetailModal] = useState(false)
  const [selectedHabilidadeForDetail, setSelectedHabilidadeForDetail] = useState(null)

  // States para sistema de Características e Talentos
  const [expandedCaracteristicas, setExpandedCaracteristicas] = useState([]) // IDs das características expandidas
  const [expandedTalentos, setExpandedTalentos] = useState([]) // IDs dos talentos expandidos
  const [caracteristicasSelected, setCaracteristicasSelected] = useState([]) // Lista de características selecionadas
  const [showTalentosModal, setShowTalentosModal] = useState(false)
  const [talentosSearch, setTalentosSearch] = useState('')
  const [talentosSelected, setTalentosSelected] = useState([]) // Lista de talentos selecionados
  const [talentosFilterSelected, setTalentosFilterSelected] = useState([]) // Filtros de talentos selecionados: 'Geral', classes[0], classes[1], classes[2], classes[3]
  const [showBolsaTalentoModal, setShowBolsaTalentoModal] = useState(false)
  const [bolsaTalento, setBolsaTalento] = useState(0)

  // States para sistema de Tipo de Escolha (Elementalista)
  const [elementalistaTypes, setElementalistaTypes] = useState([]) // Tipos selecionados pelo Elementalista
  const [showElementalistaTypesModal, setShowElementalistaTypesModal] = useState(false) // Modal de seleção de tipos do treinador
  const [elementalistaTypesSearch, setElementalistaTypesSearch] = useState('') // Busca no modal de tipos do treinador
  const [showPokemonTypeEditModal, setShowPokemonTypeEditModal] = useState(false) // Modal de edição de tipos do pokémon
  const [selectedPokemonForTypeEdit, setSelectedPokemonForTypeEdit] = useState(null) // Pokémon selecionado para edição de tipos
  const [pokemonTypeEditSource, setPokemonTypeEditSource] = useState(null) // 'team' ou 'pc'

  // States para sistema de Estilizador (Ranger)
  const [estilizadorBattery, setEstilizadorBattery] = useState(10) // Bateria do Estilizador (0-10)

  // States para sistema de Estilizador Policial (Policial)
  const [estilizadorPolicialBattery, setEstilizadorPolicialBattery] = useState(30) // Bateria do Estilizador Policial (0-30 ou 0-40)
  const [thunderStoneActive, setThunderStoneActive] = useState(false) // Se a Pedra do Trovão foi ativada

  // States para sistema de Evolução
  const [showEvolutionModal, setShowEvolutionModal] = useState(false)
  const [selectedPokemonForEvolution, setSelectedPokemonForEvolution] = useState(null)
  const [evolutionLocation, setEvolutionLocation] = useState(null) // 'team' ou 'pc'
  const [evolutionPokemonIndex, setEvolutionPokemonIndex] = useState(null)
  const [evolutionSearch, setEvolutionSearch] = useState('')
  const [selectedEvolutionSpecies, setSelectedEvolutionSpecies] = useState(null)

  // States para sistema de Pokébolas
  const [showPokeballModal, setShowPokeballModal] = useState(false)
  const [showPokeballPCModal, setShowPokeballPCModal] = useState(false)
  const [selectedPokemonForPokeball, setSelectedPokemonForPokeball] = useState(null)
  const [selectedPokemonTypeForPokeball, setSelectedPokemonTypeForPokeball] = useState(null) // 'team' ou 'pc'
  const [pokeballSearch, setPokeballSearch] = useState('')
  const [selectedPokeballForPC, setSelectedPokeballForPC] = useState('')
  const [showCustomPokeballOptions, setShowCustomPokeballOptions] = useState(false)
  const [customPokeballUploadType, setCustomPokeballUploadType] = useState('link') // 'link' ou 'file'
  const [customPokeballLink, setCustomPokeballLink] = useState('')
  const [customPokeballFile, setCustomPokeballFile] = useState(null)
  const [showCustomPokeball2Options, setShowCustomPokeball2Options] = useState(false)
  const [customPokeball2UploadType, setCustomPokeball2UploadType] = useState('link') // 'link' ou 'file'
  const [customPokeball2Link, setCustomPokeball2Link] = useState('')
  const [customPokeball2File, setCustomPokeball2File] = useState(null)

  // States para sistema de Held Items
  const [showHeldItemModal, setShowHeldItemModal] = useState(false)
  const [showHeldItemPCModal, setShowHeldItemPCModal] = useState(false)
  const [selectedPokemonForHeldItem, setSelectedPokemonForHeldItem] = useState(null)
  const [selectedPokemonTypeForHeldItem, setSelectedPokemonTypeForHeldItem] = useState(null) // 'team' ou 'pc'
  const [heldItemName, setHeldItemName] = useState('')
  const [heldItemDescription, setHeldItemDescription] = useState('')
  const [showHeldItemDetailModal, setShowHeldItemDetailModal] = useState(false)
  const [selectedHeldItemForDetail, setSelectedHeldItemForDetail] = useState(null)

  // States para sistema de Mochila
  const [pokemonedas, setPokemonedas] = useState(0)
  const [keyItems, setKeyItems] = useState([]) // Array de {name: string, quantity: number}
  const [customItems, setCustomItems] = useState([]) // Array de {name: string, quantity: number, description: string}
  const [showAddKeyItemModal, setShowAddKeyItemModal] = useState(false)
  const [selectedKeyItem, setSelectedKeyItem] = useState('')
  const [keyItemQuantity, setKeyItemQuantity] = useState(1)
  const [keyItemSearch, setKeyItemSearch] = useState('')
  const [keyItemsPage, setKeyItemsPage] = useState(0)
  const [showAddCustomItemModal, setShowAddCustomItemModal] = useState(false)
  const [customItemName, setCustomItemName] = useState('')
  const [customItemQuantity, setCustomItemQuantity] = useState(1)
  const [showCustomKeyItemModal, setShowCustomKeyItemModal] = useState(false)
  const [customKeyItemName, setCustomKeyItemName] = useState('')
  const [customKeyItemQty, setCustomKeyItemQty] = useState(1)
  const [customKeyItemImageUrl, setCustomKeyItemImageUrl] = useState('')
  const [customKeyItemDescription, setCustomKeyItemDescription] = useState('')
  const [showMochilaDescModal, setShowMochilaDescModal] = useState(false)
  const [mochilaDescItem, setMochilaDescItem] = useState(null)
  const [customItemDescription, setCustomItemDescription] = useState('')

  // States para Bugigangas do Mestre
  const [masterItems, setMasterItems] = useState([]) // {id, name, quantity, quantityFixed, image, description?}
  const [masterItemsSent, setMasterItemsSent] = useState([]) // items enviados (qty chegou a 0)
  const [masterItemsPage, setMasterItemsPage] = useState(0)
  const [masterItemsSentPage, setMasterItemsSentPage] = useState(0)
  const [showFabricarItemModal, setShowFabricarItemModal] = useState(false)
  const [fabricarItemName, setFabricarItemName] = useState('')
  const [fabricarItemQty, setFabricarItemQty] = useState('')
  const [fabricarItemImage, setFabricarItemImage] = useState('')
  const [fabricarItemDescription, setFabricarItemDescription] = useState('')
  const [showEditMasterItemModal, setShowEditMasterItemModal] = useState(false)
  const [editingMasterItem, setEditingMasterItem] = useState(null)
  const [editMasterItemName, setEditMasterItemName] = useState('')
  const [editMasterItemQty, setEditMasterItemQty] = useState('')
  const [editMasterItemImage, setEditMasterItemImage] = useState('')
  const [editMasterItemDescription, setEditMasterItemDescription] = useState('')
  const [showMandarItemModal, setShowMandarItemModal] = useState(false)
  const [mandarItemTarget, setMandarItemTarget] = useState(null)
  const [mandarItemSelectedUsers, setMandarItemSelectedUsers] = useState([])
  const [showMasterItemDescModal, setShowMasterItemDescModal] = useState(false)
  const [masterItemDescTarget, setMasterItemDescTarget] = useState(null)
  const [showRenovarItemModal, setShowRenovarItemModal] = useState(false)
  const [renovarItemTarget, setRenovarItemTarget] = useState(null)
  const [renovarItemQty, setRenovarItemQty] = useState('')
  const [showGiveItemModal, setShowGiveItemModal] = useState(false)
  const [selectedItemToGive, setSelectedItemToGive] = useState(null)
  const [selectedPokemonToReceiveItem, setSelectedPokemonToReceiveItem] = useState(null)
  const [showEditKeyItemQuantityModal, setShowEditKeyItemQuantityModal] = useState(false)
  const [selectedKeyItemForEdit, setSelectedKeyItemForEdit] = useState(null)
  const [editKeyItemQuantity, setEditKeyItemQuantity] = useState(1)
  const [showDeleteConfirmModal, setShowDeleteConfirmModal] = useState(false)
  const [itemToDelete, setItemToDelete] = useState(null)
  const [deleteType, setDeleteType] = useState(null) // 'keyItem' ou 'customItem'
  const [showEditCustomItemModal, setShowEditCustomItemModal] = useState(false)
  const [showRepairPokeballModal, setShowRepairPokeballModal] = useState(false) // Modal para reparar pokébola
  const [selectedPokeballToRepair, setSelectedPokeballToRepair] = useState('') // Tipo de pokébola a reparar
  const [repairPokeballSearch, setRepairPokeballSearch] = useState('') // Busca para selecionar tipo de pokébola
  const [selectedCustomItemForEdit, setSelectedCustomItemForEdit] = useState(null)
  const [editCustomItemName, setEditCustomItemName] = useState('')
  const [editCustomItemQuantity, setEditCustomItemQuantity] = useState(1)
  const [editCustomItemDescription, setEditCustomItemDescription] = useState('')
  const [showPokemonedasModal, setShowPokemonedasModal] = useState(false)
  const [pokemonedasValue, setPokemonedasValue] = useState('')

  // States para Pokesuco
  const [showPokesucoModal, setShowPokesucoModal] = useState(false)
  const [pokesucoSlots, setPokesucoSlots] = useState([null, null, null])
  const [pokesucoModificador, setPokesucoModificador] = useState(0)
  const [pokesucoIntensificar, setPokesucoIntensificar] = useState(null)
  const [pokesucoDominante, setPokesucoDominante] = useState(null)
  const [pokesucoLojaQualidades, setPokesucoLojaQualidades] = useState({})
  const [showPokesucoQualidadeModal, setShowPokesucoQualidadeModal] = useState(false)
  const [pokesucoQualidadeSelectedItem, setPokesucoQualidadeSelectedItem] = useState('')
  const [pokesucoQualidadeValue, setPokesucoQualidadeValue] = useState(5)

  // States para modal de valor/aroma ao adicionar Puffin pela mochila
  const [showPuffinValorModal, setShowPuffinValorModal] = useState(false)
  const [puffinValorSelectedItem, setPuffinValorSelectedItem] = useState('')
  const [puffinValorValue, setPuffinValorValue] = useState(5)
  const [puffinAromaFlavor, setPuffinAromaFlavor] = useState(null)

  // States para Puffin
  const [showFazerPuffinModal, setShowFazerPuffinModal] = useState(false)
  const [puffinSlots, setPuffinSlots] = useState([null, null, null, null, null])
  const [puffinSlotDropdown, setPuffinSlotDropdown] = useState(null)

  // States para Sedex Item
  const [showSedexItemModal, setShowSedexItemModal] = useState(false)
  const [sedexItemSearch, setSedexItemSearch] = useState('')
  const [selectedSedexItem, setSelectedSedexItem] = useState(null) // {name, type: 'key' ou 'custom', quantity, description?}
  const [selectedSedexTrainer, setSelectedSedexTrainer] = useState('') // Username do treinador selecionado
  const [availableTrainers, setAvailableTrainers] = useState([]) // Lista de treinadores disponíveis

  // States para Fotografias
  const [showFotografiaModal, setShowFotografiaModal] = useState(false)
  const [fotografiaNome, setFotografiaNome] = useState('')
  const [fotografiaUrl, setFotografiaUrl] = useState('')
  const [fotografiaPreco, setFotografiaPreco] = useState('')
  const [fotografias, setFotografias] = useState([]) // Array de {url, preco, id}
  const [editingFotografiaId, setEditingFotografiaId] = useState(null)

  // States para Pokeovo
  const [pokeovoList, setPokeovoList] = useState([]) // Array de {id, species, imageIndex}
  const [showPokeovoSpeciesModal, setShowPokeovoSpeciesModal] = useState(false)
  const [selectedPokeovoSpecies, setSelectedPokeovoSpecies] = useState('Misterioso')
  const [pokeovoSpeciesSearch, setPokeovoSpeciesSearch] = useState('')
  const [showHatchMysteryEggModal, setShowHatchMysteryEggModal] = useState(false)
  const [selectedPokeovoToHatch, setSelectedPokeovoToHatch] = useState(null)
  const [hatchSpeciesSearch, setHatchSpeciesSearch] = useState('')
  const [selectedHatchSpecies, setSelectedHatchSpecies] = useState('')

  // States para Shiny Charm
  const [showShinyCharmModal, setShowShinyCharmModal] = useState(false)
  const [shinyCharmLuckyNumber, setShinyCharmLuckyNumber] = useState('')
  const [showEditShinyCharmModal, setShowEditShinyCharmModal] = useState(false)
  const [shinyCharmToEdit, setShinyCharmToEdit] = useState(null)

  // States para PokéLoja
  const [expandedCorredores, setExpandedCorredores] = useState({}) // {corredor: boolean}
  const [showItemDescriptionModal, setShowItemDescriptionModal] = useState(false)
  const [selectedItemForDescription, setSelectedItemForDescription] = useState(null)
  const [showBuyItemModal, setShowBuyItemModal] = useState(false)
  const [selectedItemToBuy, setSelectedItemToBuy] = useState(null)
  const [buyItemQuantity, setBuyItemQuantity] = useState(1)

  // States para Treinador NPC
  const [npcTrainers, setNpcTrainers] = useState([])

  // States para NPCs Arquivados
  const [archivedNpcTrainers, setArchivedNpcTrainers] = useState([]) // Treinadores NPC arquivados
  const [archivedNpcPokemon, setArchivedNpcPokemon] = useState([]) // Pokémon NPC arquivados
  const [showCustomTrainerModal, setShowCustomTrainerModal] = useState(false)
  const [showRandomTrainerModal, setShowRandomTrainerModal] = useState(false)
  const [customTrainerForm, setCustomTrainerForm] = useState({
    name: '',
    level: 1,
    attributes: {
      saude: 6,
      ataque: 6,
      defesa: 6,
      ataqueEspecial: 6,
      defesaEspecial: 6,
      velocidade: 6
    },
    classes: [],
    talentosMode: 'aleatorio', // 'aleatorio' ou 'manual'
    selectedTalentos: [], // Para modo manual
    imageUrl: '' // URL da imagem do treinador
  })
  const [randomTrainerForm, setRandomTrainerForm] = useState({
    name: '',
    level: 1,
    imageUrl: '' // URL da imagem do treinador
  })
  const [showNPCTalentosModal, setShowNPCTalentosModal] = useState(false)
  const [selectedNPCForTalentos, setSelectedNPCForTalentos] = useState(null)
  const [showSelectTalentosModal, setShowSelectTalentosModal] = useState(false)

  // States para sistema de Tutoria e Golpes
  const [showTutoriaModal, setShowTutoriaModal] = useState(false)
  const [selectedPokemonForTutoria, setSelectedPokemonForTutoria] = useState(null)
  const [selectedPokemonTypeForTutoria, setSelectedPokemonTypeForTutoria] = useState(null) // 'team' ou 'pc'
  const [tutoriaGolpesSearch, setTutoriaGolpesSearch] = useState('')
  const [tutoriaSelectedGolpes, setTutoriaSelectedGolpes] = useState([])
  const [showGolpeDetailModal, setShowGolpeDetailModal] = useState(false)
  const [selectedGolpeForDetail, setSelectedGolpeForDetail] = useState(null)
  const [showPCGolpesModal, setShowPCGolpesModal] = useState(false)
  const [selectedPokemonForPCGolpes, setSelectedPokemonForPCGolpes] = useState(null)
  const [expandedGolpeInPC, setExpandedGolpeInPC] = useState(null)

  const [captureForm, setCaptureForm] = useState({ nickname: '', level: 5 })
  const [pokemonToCapture, setPokemonToCapture] = useState(null)
  const [fullPokedexData, setFullPokedexData] = useState([])
  const [globalExoticSpecies, setGlobalExoticSpecies] = useState([])
  const [showExoticDataModal, setShowExoticDataModal] = useState(false)
  const [exoticDataForm, setExoticDataForm] = useState({
    dexNumber: '',
    altura: '',
    peso: '',
    genero: '',
    tipos: [],
    habitats: [''],
    catchRate: '',
    baseExp: '',
    evolucao: '',
    evolucaoNivel: '',
    evolucaoItem: '',
    statusBasais: {
      saude: '',
      ataque: '',
      defesa: '',
      ataqueEspecial: '',
      defesaEspecial: '',
      velocidade: ''
    }
  })
  const [selectedPokemonForImage, setSelectedPokemonForImage] = useState(null)
  const [imageUploadType, setImageUploadType] = useState('link') // 'link' ou 'file'
  const [pokemonImages, setPokemonImages] = useState({})

  // Estado para edição de Pokémon
  const [showEditPokemonModal, setShowEditPokemonModal] = useState(false)
  const [editingPokemon, setEditingPokemon] = useState(null)
  const [editingPokemonLocation, setEditingPokemonLocation] = useState(null) // 'team' ou 'pc'
  const [pokemonEditForm, setPokemonEditForm] = useState({
    nature: '',
    shiny: false,
    legendary: false,
    baseAttributes: {
      saude: '',
      ataque: '',
      defesa: '',
      ataqueEspecial: '',
      defesaEspecial: '',
      velocidade: ''
    },
    levelPoints: {
      saude: '',
      ataque: '',
      defesa: '',
      ataqueEspecial: '',
      defesaEspecial: '',
      velocidade: ''
    },
    bonusPoints: {
      saude: '',
      ataque: '',
      defesa: '',
      ataqueEspecial: '',
      defesaEspecial: '',
      velocidade: ''
    },
    gender: '',
    displacement: {
      terrestre: '',
      nadar: '',
      voar: '',
      cavar: '',
      submerso: ''
    },
    weight: '',
    height: '',
    loyalty: '',
    capacities: {
      forca: '',
      inteligencia: '',
      salto: '',
      others: [] // Array de strings com nomes das capacidades
    },
    dietaSlot1: '',
    dietaSlot2: ''
  })
  const [natureSearch, setNatureSearch] = useState('')
  const [showDietSlotDropdown, setShowDietSlotDropdown] = useState(null) // null | 1 | 2

  // Estados para modal de edição do PC
  const [showEditPokemonPCModal, setShowEditPokemonPCModal] = useState(false)

  // Estados para modal de habilidades do PC
  const [showHabilidadesPCModal, setShowHabilidadesPCModal] = useState(false)

  // Estados para modal Name Rater - Time Principal
  const [showNameRaterModal, setShowNameRaterModal] = useState(false)
  const [nameRaterIndex, setNameRaterIndex] = useState(null)
  const [nameRaterNickname, setNameRaterNickname] = useState('')

  // Estados para modal Name Rater PC
  const [showNameRaterPCModal, setShowNameRaterPCModal] = useState(false)
  const [nameRaterPCIndex, setNameRaterPCIndex] = useState(null)
  const [nameRaterPCNickname, setNameRaterPCNickname] = useState('')

  // Estado para visualização de informações do Pokémon
  const [showPokemonInfoModal, setShowPokemonInfoModal] = useState(false)
  const [viewingPokemon, setViewingPokemon] = useState(null)

  // Estados para modal de edição de Aptidões de Pokémon
  const [showAptidoesModal, setShowAptidoesModal] = useState(false)
  const [aptidoesEditingPokemon, setAptidoesEditingPokemon] = useState(null) // { pokemon, location, index }
  const [aptidoesTempValues, setAptidoesTempValues] = useState({ estilo: 0, beleza: 0, ternura: 0, perspicacia: 0, vigor: 0 })

  // Estados para modal de Snack (puffins → aptidões)
  const [showSnackModal, setShowSnackModal] = useState(false)
  const [snackDropdownPokemon, setSnackDropdownPokemon] = useState(null) // índice do pokémon com dropdown aberto

  // Estado para modal de Dano/Cura de Pokémon
  const [showPokemonHPModal, setShowPokemonHPModal] = useState(false)
  const [selectedPokemonHP, setSelectedPokemonHP] = useState(null)

  // Estados para Enciclopédia (Treinador)
  const [encyclopediaSection, setEncyclopediaSection] = useState('Golpedex') // 'Golpedex', 'Descritordex', 'Tag de Concursodex', 'Períciadex', 'Habilidadedex', 'Capacidadex', 'Condiçõesdex'
  const [apricornSubarea, setApricornSubarea] = useState('Árvores') // 'Árvores', 'Bonsais'
  const [golpedexSearches, setGolpedexSearches] = useState(['', '', '', '', '', '', '', '']) // 8 barras de pesquisa
  const [habilidadedexSearches, setHabilidadedexSearches] = useState(['', '', '', '', '', '', '', '']) // 8 barras de pesquisa para habilidades
  const [capacidadexSearches, setCapacidadexSearches] = useState(['', '', '', '', '', '', '', '']) // 8 barras de pesquisa para capacidades
  const [expandedDescritor, setExpandedDescritor] = useState(null) // Nome do descritor expandido ou null
  const [expandedTagConcurso, setExpandedTagConcurso] = useState(null) // Nome da tag de concurso expandida ou null
  const [expandedAtributo, setExpandedAtributo] = useState(null) // Nome do atributo expandido ou null
  const [expandedCondicoes, setExpandedCondicoes] = useState([]) // Array de nomes de condições expandidas
  const [expandedItendexCorredores, setExpandedItendexCorredores] = useState([]) // Array de corredores expandidos no Itendex
  const [highlightedProgressaoRows, setHighlightedProgressaoRows] = useState([]) // Array de níveis destacados na tabela de Progressão de nível

  // Estados para Enciclopédia M (Mestre)
  const [encyclopediaMSection, setEncyclopediaMSection] = useState('Golpedex M') // 'Golpedex M', 'Descritordex M', 'Tag de Concursodex M', 'Períciadex M', 'Habilidadedex M', 'Capacidadex M', 'Condiçõesdex M'
  const [golpedexMSearches, setGolpedexMSearches] = useState(['', '', '', '', '', '', '', '']) // 8 barras de pesquisa
  const [habilidadedexMSearches, setHabilidadedexMSearches] = useState(['', '', '', '', '', '', '', '']) // 8 barras de pesquisa para habilidades
  const [capacidadexMSearches, setCapacidadexMSearches] = useState(['', '', '', '', '', '', '', '']) // 8 barras de pesquisa para capacidades
  const [expandedDescritorM, setExpandedDescritorM] = useState(null) // Nome do descritor expandido ou null
  const [expandedTagConcursoM, setExpandedTagConcursoM] = useState(null) // Nome da tag de concurso expandida ou null
  const [expandedAtributoM, setExpandedAtributoM] = useState(null) // Nome do atributo expandido ou null
  const [expandedCondicoesM, setExpandedCondicoesM] = useState([]) // Array de nomes de condições expandidas
  const [expandedItendexCorredoresM, setExpandedItendexCorredoresM] = useState([]) // Array de corredores expandidos no Itendex M

  // Estados para Progressão (Treinador)
  const [progressaoSection, setProgressaoSection] = useState('Vivências') // 'Vivências', 'Diário da Jornada', 'Background'
  const [background, setBackground] = useState('') // Texto do background do personagem (máx 2000 caracteres)
  const [showBackgroundModal, setShowBackgroundModal] = useState(false) // Modal para editar background
  const [selectedBackgroundTrainer, setSelectedBackgroundTrainer] = useState('') // Treinador selecionado para ver o background
  const [selectedBackgroundData, setSelectedBackgroundData] = useState(null) // Dados do treinador selecionado para ver background
  const [vivencias, setVivencias] = useState([]) // Lista de vivências
  const [showNovaVivenciaModal, setShowNovaVivenciaModal] = useState(false)
  const [novaVivenciaNome, setNovaVivenciaNome] = useState('')
  const [novaVivenciaFrequencia, setNovaVivenciaFrequencia] = useState('')
  const [novaVivenciaAlvo, setNovaVivenciaAlvo] = useState('')
  const [novaVivenciaGatilho, setNovaVivenciaGatilho] = useState('')
  const [novaVivenciaEfeito, setNovaVivenciaEfeito] = useState('')
  const [expandedVivencia, setExpandedVivencia] = useState(null) // ID da vivência expandida ou null
  const [editingVivenciaId, setEditingVivenciaId] = useState(null) // ID da vivência sendo editada ou null
  const [conquistas, setConquistas] = useState([]) // Lista de conquistas
  const [showNovaConquistaModal, setShowNovaConquistaModal] = useState(false)
  const [novaConquistaNome, setNovaConquistaNome] = useState('')
  const [novaConquistaLevelUp, setNovaConquistaLevelUp] = useState(false)
  const [novaConquistaDescricao, setNovaConquistaDescricao] = useState('')
  const [selectedConquista, setSelectedConquista] = useState(null) // Conquista selecionada para ver detalhes
  const [conquistaEditando, setConquistaEditando] = useState(null) // Conquista sendo editada (ID)
  const [selectedDiarioTrainer, setSelectedDiarioTrainer] = useState('') // Treinador selecionado para ver o diário
  const [selectedDiarioData, setSelectedDiarioData] = useState(null) // Dados do treinador selecionado para ver diário
  const [ciclos, setCiclos] = useState([]) // Lista de ciclos concluídos (cada um com verdade e conquistas)
  const [showFimCicloModal, setShowFimCicloModal] = useState(false) // Modal para encerrar ciclo
  const [fimCicloVerdade, setFimCicloVerdade] = useState('') // Verdade do ciclo
  const [selectedCiclo, setSelectedCiclo] = useState(null) // Ciclo selecionado para visualizar
  const [draggingConquistaId, setDraggingConquistaId] = useState(null) // ID da conquista sendo arrastada

  // Estados para XP & Capturas
  const [xpList, setXpList] = useState([]) // Lista de XPs: [{value: number, species?: string}]
  const [capturaList, setCapturaList] = useState([]) // Lista de capturas: [{species: string, level: number, captureValue: number}]
  const [showAddXpModal, setShowAddXpModal] = useState(false) // Modal para adicionar XP
  const [addXpValue, setAddXpValue] = useState('') // Valor do XP a ser adicionado
  const [showEditXpModal, setShowEditXpModal] = useState(false) // Modal para editar XP
  const [editingXpIndex, setEditingXpIndex] = useState(null) // Índice do XP sendo editado
  const [editXpValue, setEditXpValue] = useState('') // Valor do XP sendo editado
  const [showEditCapturaModal, setShowEditCapturaModal] = useState(false) // Modal para editar Captura
  const [editingCapturaIndex, setEditingCapturaIndex] = useState(null) // Índice da Captura sendo editada
  const [editCapturaData, setEditCapturaData] = useState({ species: '', level: '', captureValue: '' }) // Dados da captura sendo editada
  const [allTrainersXpCapturas, setAllTrainersXpCapturas] = useState({}) // Dados de XP & Capturas de todos os treinadores (para o mestre)
  const [showAcoesComandoModal, setShowAcoesComandoModal] = useState(false) // Modal de Ações de Comando
  const [selectedAcaoComandoPokemon, setSelectedAcaoComandoPokemon] = useState('') // Pokémon selecionado no dropdown
  const [acaoComandoType, setAcaoComandoType] = useState('') // 'captura', 'batalha', 'block'
  const [showXpCapturasM, setShowXpCapturasM] = useState(true) // Controla expansão da área XP & Capturas M
  const [showCombateXpCapturas, setShowCombateXpCapturas] = useState(false) // Controla expansão do App de Combate na área XP & Capturas M

  // Grid de Captura - NOVO
  const [gridCapturaConfig, setGridCapturaConfig] = useState(null) // { rows, cols, trainer, pokemons: [{species, level, imageUrl, captureValue, types}] }
  const [revealedCards, setRevealedCards] = useState([]) // Array de índices dos cards revelados
  const [showGridModal, setShowGridModal] = useState(false) // Modal de configuração do grid
  const [gridRows, setGridRows] = useState('') // Número de linhas
  const [gridCols, setGridCols] = useState('') // Número de colunas
  const [gridTrainer, setGridTrainer] = useState('') // Treinador selecionado
  const [selectedGridState, setSelectedGridState] = useState(null) // Estado selecionado: 'bloqueado', 'capturado', 'vencido'
  const [gridCardStates, setGridCardStates] = useState({}) // Objeto mapeando índice -> estado

  // Estados para Pokecaixinha
  const [pokecaixinha, setPokecaixinha] = useState(0) // Valor guardado na pokecaixinha
  const [showPokecaixinhaModal, setShowPokecaixinhaModal] = useState(false) // Modal de depósito
  const [pokecaixinhaDepositValue, setPokecaixinhaDepositValue] = useState('') // Valor a depositar

  // Estados para Drag and Drop do Time Principal
  const [dragPokemonIndex, setDragPokemonIndex] = useState(null)
  const [dragOverPokemonIndex, setDragOverPokemonIndex] = useState(null)

  // Estados para Interlúdio
  const [interludioPlayers, setInterludioPlayers] = useState([
    { username: 'Alocin', jnChecked: false, rtChecked: false, jnPoints: 5, rtPoints: 5 },
    { username: 'Lila', jnChecked: false, rtChecked: false, jnPoints: 5, rtPoints: 5 },
    { username: 'Ludovic', jnChecked: false, rtChecked: false, jnPoints: 5, rtPoints: 5 },
    { username: 'Noryat', jnChecked: false, rtChecked: false, jnPoints: 5, rtPoints: 5 },
    { username: 'Pedro', jnChecked: false, rtChecked: false, jnPoints: 5, rtPoints: 5 }
  ])
  const [chatMessages, setChatMessages] = useState([]) // Mensagens do chat
  const [chatInput, setChatInput] = useState('') // Input do chat
  const [quickRollNumDice, setQuickRollNumDice] = useState(1) // Número de dados para rolagem rápida
  const [quickRollDiceType, setQuickRollDiceType] = useState('d20') // Tipo de dado para rolagem rápida
  const chatContainerRef = useRef(null) // Ref para container do chat (scroll)
  const vttCanvasRef = useRef(null) // Ref para o canvas do VTT (zoom com roda do mouse)
  const isLoadingVttLocationRef = useRef(false) // Flag para evitar loop infinito no VTT
  const [showCustomModal, setShowCustomModal] = useState(false) // Modal de ação customizada
  const [customActionName, setCustomActionName] = useState('') // Nome da ação customizada
  const [customActionCost, setCustomActionCost] = useState('') // Custo da ação customizada
  const [customActionPlayer, setCustomActionPlayer] = useState(null) // Player que está criando ação customizada
  const [customActionType, setCustomActionType] = useState('') // 'jn' ou 'rt'
  const [interludioApp, setInterludioApp] = useState(null) // null, 'combate', 'concurso'

  // Estados para Dano/Cura Interlúdio
  const [showInterludioPokemonDamageModal, setShowInterludioPokemonDamageModal] = useState(false)
  const [selectedInterludioPokemon, setSelectedInterludioPokemon] = useState(null)
  const [interludioPokemonDamageAmount, setInterludioPokemonDamageAmount] = useState('')
  const [showInterludioTrainerDamageModal, setShowInterludioTrainerDamageModal] = useState(false)
  const [interludioTrainerDamageAmount, setInterludioTrainerDamageAmount] = useState('')

  // ===== STATES SAFARI - MESTRE =====
  const [safariStaffSubarea, setSafariStaffSubarea] = useState('Mapa Safari Staff')
  const [safariStaffActiveRun, setSafariStaffActiveRun] = useState(null)
  const [safariRunGrids, setSafariRunGrids] = useState({})
  const [safariRunAreas, setSafariRunAreas] = useState({})
  const [safariTimers, setSafariTimers] = useState({})
  const [safariRunPermissions, setSafariRunPermissions] = useState({})
  const [safariRunEncounters, setSafariRunEncounters] = useState({})
  const [safariRunPaidUsers, setSafariRunPaidUsers] = useState({})
  const [safariRunLastClicked, setSafariRunLastClicked] = useState({}) // {runKey: {row, col}}
  const [expandedSafariNpcCards, setExpandedSafariNpcCards] = useState([])
  const [safariStaffEncounterActiveRun, setSafariStaffEncounterActiveRun] = useState(null)
  const [showSafariNpcDamageModal, setShowSafariNpcDamageModal] = useState(false)
  const [selectedSafariNpcPokemon, setSelectedSafariNpcPokemon] = useState(null)
  const [safariNpcDamageAmount, setSafariNpcDamageAmount] = useState('')
  const [safariNpcDamageRunNumber, setSafariNpcDamageRunNumber] = useState(null)

  // ===== STATES SAFARI - TREINADOR =====
  const [safariSubarea, setSafariSubarea] = useState('Mapa Safari')
  const [showMapaSafariCompletoModal, setShowMapaSafariCompletoModal] = useState(false)
  const [safariMapSelectedArea, setSafariMapSelectedArea] = useState(null)
  const [safariActiveRun, setSafariActiveRun] = useState(null)
  const [safariCurrentArea, setSafariCurrentArea] = useState('Área Central')
  const [safariGridData, setSafariGridData] = useState(null)
  const [safariSelectedPokemon, setSafariSelectedPokemon] = useState(new Set())
  const [safariActiveCaptureModifiers, setSafariActiveCaptureModifiers] = useState([]) // Índices dos modificadores ativos no Safari
  const [safariSpectatorRun, setSafariSpectatorRun] = useState(null) // Run sendo assistida no modo espectador
  const [quickDice, setQuickDice] = useState('') // Input de dados para o chat do Espectador Safari
  const [showAreaNavigationModal, setShowAreaNavigationModal] = useState(false)
  const [safariGridClickCount, setSafariGridClickCount] = useState(0)
  const safariPaidRunsRef = useRef(new Set())
  const locallyRemovedFromPcRef = useRef(new Set())   // IDs removidos do PC localmente (evita race condition Firebase)
  const locallyRemovedFromTeamRef = useRef(new Set()) // IDs removidos do Time localmente

  // Apricorn Trees
  const [generatedApricornTrees, setGeneratedApricornTrees] = useState([])
  const [plantedTrees, setPlantedTrees] = useState([])
  const [showPlantTreeModal, setShowPlantTreeModal] = useState(false)
  const [plantLocation, setPlantLocation] = useState('')
  const [selectedTreeToPlant, setSelectedTreeToPlant] = useState(null)
  const [treeSearchQuery, setTreeSearchQuery] = useState('')

  // Ações de JN (Jogo de Narração)
  const acoesJN = [
    { nome: 'Participar de Concurso', custo: 3 },
    { nome: 'Participar de Torneio', custo: 3 },
    { nome: 'Procurar Pokémon', custo: 1 },
    { nome: 'Batalha com treinador', custo: 1 },
    { nome: 'Catalogar pokémon', custo: 1 },
    { nome: 'Adicionar Recompensa', custo: 3 },
    { nome: 'Em busca da Lenda', custo: 4 },
    { nome: 'Sidequest', custo: 5 },
    { nome: 'NPC aleatório', custo: 1 },
    { nome: 'NPC específico', custo: 3 },
    { nome: 'Batalha de Ginásio', custo: 3 },
    { nome: 'Entrar no Safári', custo: 3 }
  ]

  // Ações de RT (Roteiro)
  const acoesRT = [
    { nome: 'Adicionar NPC Treinador', custo: 1 },
    { nome: 'Adicionar NPC de História', custo: 1 },
    { nome: 'Adicionar NPC Vilão', custo: 3 },
    { nome: 'Adicionar Obstáculo Fácil', custo: 1 },
    { nome: 'Adicionar Obstáculo Médio', custo: 3 },
    { nome: 'Adicionar Obstáculo Difícil', custo: 3 },
    { nome: 'Adicionar Quest Fácil', custo: 2 },
    { nome: 'Adicionar Quest Médio', custo: 3 },
    { nome: 'Adicionar Quest Difícil', custo: 4 }
  ]

  // Apricorn Trees Data
  const APRICORN_TREES = [
    { name: 'Árvore Apricorn Vermelha', chance: 5, image: '/treevermelho.png', fruit: 'Apricorn Vermelha' },
    { name: 'Árvore Apricorn Verde', chance: 5, image: '/treeverde.png', fruit: 'Apricorn Verde' },
    { name: 'Árvore Apricorn Azul', chance: 5, image: '/treeazul.png', fruit: 'Apricorn Azul' },
    { name: 'Árvore Apricorn Preta', chance: 5, image: '/treepreto.png', fruit: 'Apricorn Preta' },
    { name: 'Árvore Apricorn Amarela', chance: 5, image: '/treeamarelo.png', fruit: 'Apricorn Amarela' },
    { name: 'Árvore Apricorn Rosa', chance: 5, image: '/treerosa.png', fruit: 'Apricorn Rosa' },
    { name: 'Árvore Apricorn Branca', chance: 5, image: '/treebranco.png', fruit: 'Apricorn Branca' },
    { name: 'Árvore Apricorn Arco-íris', chance: 0.5, image: '/treearcoiris.png', fruit: 'Apricorn Arco-íris' },
    { name: 'Árvore Apricorn sem frutos', chance: 64.5, image: '/treevaiza.png', fruit: null }
  ]

  // Dados de Clima
  const CLIMA_LIST = [
    { name: 'Ensolarado', image: 'solclima.png' },
    { name: 'Chuvoso', image: 'chuvosoclima.png' },
    { name: 'Nublado', image: 'nubladoclima.png' },
    { name: 'Tempestade', image: 'tempestadeclima.png' },
    { name: 'Ventania', image: 'ventaniaclima.png' },
    { name: 'Neve', image: 'neveclima.png' },
    { name: 'Granizo', image: 'granizoclima.png' },
    { name: 'Nevoeiro', image: 'nevoeiroclima.png' },
    { name: 'Tempestade de Areia', image: 'tempestadedeareiaclima.png' },
  ]

  // Estados para Visão do Mestre
  const [visaoMestreSection, setVisaoMestreSection] = useState('Perfis') // 'Perfis', 'Pokéloja Config'
  const [selectedTrainer, setSelectedTrainer] = useState(null) // Username do treinador selecionado ou null
  const [selectedTrainerData, setSelectedTrainerData] = useState(null) // Dados do treinador selecionado carregados do Firebase
  const [expandedTeamPokemon, setExpandedTeamPokemon] = useState(null) // Index do pokémon do time expandido ou null
  const [showCaracTaleModal, setShowCaracTaleModal] = useState(false) // Modal de Características & Talentos
  const [showMochilaModal, setShowMochilaModal] = useState(false) // Modal da Mochila
  const [showVivenciasModal, setShowVivenciasModal] = useState(false) // Modal de Vivências
  const [showMestreBackgroundModal, setShowMestreBackgroundModal] = useState(false) // Modal de Background na Visão do Mestre
  const [showMestreInsigniasModal, setShowMestreInsigniasModal] = useState(false) // Modal de Insígnias na Visão do Mestre
  const [expandedMestreInsignias, setExpandedMestreInsignias] = useState([]) // Regiões expandidas no modal de insígnias
  const [hiddenPokelojaItems, setHiddenPokelojaItems] = useState([]) // Array de nomes de itens ocultos na Pokéloja
  const [customPrices, setCustomPrices] = useState({}) // Objeto com preços customizados {itemName: price}
  const [editingPriceItem, setEditingPriceItem] = useState(null) // Nome do item sendo editado
  const [editingPriceValue, setEditingPriceValue] = useState('') // Valor temporário do preço sendo editado

  const [selectedPokemonHPIndex, setSelectedPokemonHPIndex] = useState(null)
  const [hpAmount, setHpAmount] = useState('')
  const [damageMultiplier, setDamageMultiplier] = useState(null) // null, 'x2', 'x4', '/2', '/4'
  // Estado para modal de HP Temporário
  const [showTempHPModal, setShowTempHPModal] = useState(false)
  const [selectedPokemonForTempHP, setSelectedPokemonForTempHP] = useState(null)
  const [selectedPokemonTempHPIndex, setSelectedPokemonTempHPIndex] = useState(null)
  const [tempHPAmount, setTempHPAmount] = useState('')

  // Lista de espécies combinando pokémon normais e exóticos globais
  const allSpecies = [
    ...POKEMON_SPECIES,
    ...globalExoticSpecies.map(e => e.nome)
  ].sort()

  // Estado para modal de Account Data
  const [showAccountDataModal, setShowAccountDataModal] = useState(false)

  // ===== QUESTS (Central Niaypeta Rio Corp™) =====
  const [quests, setQuests] = useState([])
  const [questSubAreaMestre, setQuestSubAreaMestre] = useState('Ativas')
  const [questSubAreaTreinador, setQuestSubAreaTreinador] = useState('Ativas')
  const [showNewQuestModal, setShowNewQuestModal] = useState(false)
  const [editingQuest, setEditingQuest] = useState(null)
  const [questForm, setQuestForm] = useState({ nome: '', descricao: '', limite: 1, recompensa: '' })
  const [expandedQuestIdMestre, setExpandedQuestIdMestre] = useState(null)
  const [expandedQuestIdTreinador, setExpandedQuestIdTreinador] = useState(null)
  const [questPageMestre, setQuestPageMestre] = useState(0)
  const [questPageTreinador, setQuestPageTreinador] = useState(0)
  const questsSaveSkipRef = useRef(true)

  // ===== SMART POKEFONE =====
  const [smartPokefoneMessages, setSmartPokefoneMessages] = useState([])
  const [expandedMessageId, setExpandedMessageId] = useState(null)
  const smartPokefoneSaveSkipRef = useRef(true)

  // ===== TRIUNFOS =====
  const [triunfosGerais, setTriunfosGerais] = useState([])
  const triunfosGeraisSaveSkipRef = useRef(true)
  const [triunfosIndividuais, setTriunfosIndividuais] = useState({})
  const triunfosIndividuaisSaveSkipRef = useRef(true)
  const [mostrarTriunfosData, setMostrarTriunfosData] = useState(null)
  const mostrarTriunfosSaveSkipRef = useRef(true)
  const [mostrarTriunfosMinimized, setMostrarTriunfosMinimized] = useState(false)
  const [mostrarTriunfosPlayerOpen, setMostrarTriunfosPlayerOpen] = useState(false)
  const [spoilerMestreConfirmado, setSpoilerMestreConfirmado] = useState(false)
  const [showAddTriunfoGeralModal, setShowAddTriunfoGeralModal] = useState(false)
  const [showAddTriunfoIndividualModal, setShowAddTriunfoIndividualModal] = useState(false)
  const [triunfoIndividualTargetUser, setTriunfoIndividualTargetUser] = useState('')
  const [triunfoGeralFields, setTriunfoGeralFields] = useState([{ texto: '', vagas: 1 }])
  const [triunfoIndividualFields, setTriunfoIndividualFields] = useState([{ texto: '' }])
  const [editingTriunfoGeral, setEditingTriunfoGeral] = useState(null)
  const [editingTriunfoIndividual, setEditingTriunfoIndividual] = useState(null)

  // ===== POKE AGENDA =====
  const [anotacoes, setAnotacoes] = useState([])
  const anotacoesSaveSkipRef = useRef(true)
  const [showPokeAgendaPanel, setShowPokeAgendaPanel] = useState(false)
  const [showAddAnotacaoModal, setShowAddAnotacaoModal] = useState(false)
  const [editingAnotacao, setEditingAnotacao] = useState(null)
  const [anotacaoForm, setAnotacaoForm] = useState({ titulo: '', descricao: '' })
  const [expandedAnotacaoId, setExpandedAnotacaoId] = useState(null)
  const [showSelectUserForTriunfo, setShowSelectUserForTriunfo] = useState(false)
  const [selectUserForTriunfoData, setSelectUserForTriunfoData] = useState(null)
  const [tempSelectedUsers, setTempSelectedUsers] = useState([])

  // Estados para VTT (Virtual Tabletop)
  const [battleView, setBattleView] = useState('rolagens') // 'rolagens' ou 'mapa'
  const [vttLocations, setVttLocations] = useState([]) // Array de localidades/mapas
  const [currentVttLocation, setCurrentVttLocation] = useState(null) // ID da localidade atual
  const [vttMapImage, setVttMapImage] = useState(null) // URL da imagem do mapa (deprecated, usar vttLocations)
  const [vttTokens, setVttTokens] = useState([]) // Array de tokens na camada de jogadores (visível para todos)
  const [vttGMTokens, setVttGMTokens] = useState([]) // Array de tokens na camada GM (só visível para mestre)
  const [vttMapTokens, setVttMapTokens] = useState([]) // Array de tokens na camada mapa (visível para todos, embaixo de tudo)
  const [vttCurrentLayer, setVttCurrentLayer] = useState('players') // Camada atual do mestre: 'map', 'gm', 'players'
  const [selectedToken, setSelectedToken] = useState(null) // Token selecionado (id)
  const [draggingToken, setDraggingToken] = useState(null) // Token sendo arrastado
  const [vttGridSize, setVttGridSize] = useState(50) // Tamanho da grid em pixels
  const [vttShowGrid, setVttShowGrid] = useState(true) // Mostrar/ocultar grid
  const [vttSnapToGrid, setVttSnapToGrid] = useState(true) // Snap to grid ativo/inativo
  const [showAddLocationModal, setShowAddLocationModal] = useState(false) // Modal para adicionar localidade
  const [newLocationName, setNewLocationName] = useState('') // Nome da nova localidade
  const [newLocationMapUrl, setNewLocationMapUrl] = useState('') // URL do mapa da nova localidade
  const [vttMapScale, setVttMapScale] = useState(100) // Escala da imagem do mapa (%)
  const [vttMapPosition, setVttMapPosition] = useState({ x: 0, y: 0 }) // Posição do mapa (offset do centro)
  const [vttDraggingMap, setVttDraggingMap] = useState(false) // Se está arrastando o mapa
  const [vttMapDragStart, setVttMapDragStart] = useState({ x: 0, y: 0 }) // Posição inicial do arrasto do mapa
  const [vttGridColumns, setVttGridColumns] = useState(16) // Número de quadrados na largura
  const [vttGridRows, setVttGridRows] = useState(16) // Número de quadrados na altura
  const [vttCanvasWidth, setVttCanvasWidth] = useState(800) // Largura do canvas em pixels
  const [vttCanvasHeight, setVttCanvasHeight] = useState(800) // Altura do canvas em pixels
  const [vttViewportZoom, setVttViewportZoom] = useState(1) // Zoom do viewport (1 = 100%)
  const [vttViewportOffset, setVttViewportOffset] = useState({ x: 0, y: 0 }) // Offset do pan
  const [vttIsPanning, setVttIsPanning] = useState(false) // Se está arrastando o mapa
  const [vttPanStart, setVttPanStart] = useState({ x: 0, y: 0 }) // Posição inicial do pan
  const [vttRulerActive, setVttRulerActive] = useState(false) // Se a régua está ativa
  const [vttRulerStart, setVttRulerStart] = useState({ x: 0, y: 0 }) // Posição inicial da régua
  const [vttRulerEnd, setVttRulerEnd] = useState({ x: 0, y: 0 }) // Posição atual/final da régua
  const [vttSettingsOpen, setVttSettingsOpen] = useState(false) // Menu de configurações do canvas aberto/fechado

  // Estados para Insígnias
  const [selectedRegion, setSelectedRegion] = useState(null) // Região selecionada: 'Kanto', 'Johto', etc.
  const [badges, setBadges] = useState({
    Kanto: [false, false, false, false, false, false, false, false, false],
    Johto: [false, false, false, false, false, false, false, false, false],
    Hoenn: [false, false, false, false, false, false, false, false, false],
    Sinnoh: [false, false, false, false, false, false, false, false, false],
    Unova: [false, false, false, false, false, false, false, false, false, false, false, false], // 12 insígnias (grid 3x4)
    Kalos: [false, false, false, false, false, false, false, false, false]
  })

  // Estados para modal de Configuração Pokémon Exótico
  const [showExoticConfigModal, setShowExoticConfigModal] = useState(false)
  const [exoticConfigSearch, setExoticConfigSearch] = useState('')
  const [selectedExoticConfig, setSelectedExoticConfig] = useState(null)

  // Estados para modal de Escanear Pokémon
  const [showScanPokemonModal, setShowScanPokemonModal] = useState(false)
  const [scanSearch, setScanSearch] = useState('')
  const [selectedScanPokemon, setSelectedScanPokemon] = useState(null)
  const [exoticConfigForm, setExoticConfigForm] = useState({
    dexNumber: '',
    altura: '',
    peso: '',
    genero: '',
    tipos: [],
    habitats: [],
    statusBasais: { saude: '', ataque: '', defesa: '', ataqueEsp: '', defesaEsp: '', velocidade: '' },
    habilidades: [],
    habilidadesAltas: [],
    habilidadesOcultas: [],
    minimoLevel: '',
    estagio: 'Básico',
    evolucaoDe: '',
    evolucaoModo: '',
    evolucaoLevel: '',
    evolucaoItem: ''
  })

  // Estados para Clima
  const [currentClima, setCurrentClima] = useState(null) // {name, image}
  const [desertoMode, setDesertoMode] = useState(false)

  // Estados para PokeApp
  const [pokeAppSubArea, setPokeAppSubArea] = useState('') // 'Concurso', 'Encontro', 'Sorteador', 'Backup'
  const [backupHistory, setBackupHistory] = useState([])
  const [selectedBackup, setSelectedBackup] = useState(null)
  const [numPokemons, setNumPokemons] = useState(3)
  const [numAppealRounds, setNumAppealRounds] = useState(3)
  const [contestPokemons, setContestPokemons] = useState([])
  const [showContestResults, setShowContestResults] = useState(false)

  // Estados para Encontro Pokémon
  const [encounterHours, setEncounterHours] = useState(0)
  const [encounterInvestigation, setEncounterInvestigation] = useState(0)
  const [encounterHelpers, setEncounterHelpers] = useState(0)
  const [encounterBait, setEncounterBait] = useState(false)
  const [encounterPokemonAttack, setEncounterPokemonAttack] = useState(false)
  const [encounterSpecific, setEncounterSpecific] = useState(false)
  const [encounterResult, setEncounterResult] = useState(null)

  // Estados para Sorteador de Itens
  const [sortedItems, setSortedItems] = useState({
    frutos: null,
    itensMantidos: null,
    melhoradores: null,
    pedrasEvolucao: null,
    itensCura: null,
    pokebolas: null,
    vitaminas: null,
    tms: null
  })

  // Estado do formulário de adicionar Pokémon
  const [pokemonForm, setPokemonForm] = useState({
    nickname: '',
    species: '',
    isCaptured: false,
    isExotic: false,
    level: 1,
    exoticSpecies: '',
    currentXP: 0
  })
  const [speciesSearch, setSpeciesSearch] = useState('')

  // Lista de naturezas
  const natures = [
    {nome:"Ousada", up:"Saúde", down:"Ataque", gosto:"Nenhum", desgosto:"Picante"},
    {nome:"Dócil", up:"Saúde", down:"Defesa", gosto:"Nenhum", desgosto:"Azedo"},
    {nome:"Orgulhosa", up:"Saúde", down:"Ataque Especial", gosto:"Nenhum", desgosto:"Seco"},
    {nome:"Excêcentrica", up:"Saúde", down:"Defesa Especial", gosto:"Nenhum", desgosto:"Amargo"},
    {nome:"Preguiçosa", up:"Saúde", down:"Velocidade", gosto:"Nenhum", desgosto:"Doce"},
    {nome:"Desesperada", up:"Ataque", down:"Saúde", gosto:"Picante", desgosto:"Nenhum"},
    {nome:"Solitária", up:"Ataque", down:"Defesa", gosto:"Picante", desgosto:"Azedo"},
    {nome:"Firme", up:"Ataque", down:"Ataque Especial", gosto:"Picante", desgosto:"Seco"},
    {nome:"Travessa", up:"Ataque", down:"Defesa Especial", gosto:"Picante", desgosto:"Amargo"},
    {nome:"Brava", up:"Ataque", down:"Velocidade", gosto:"Picante", desgosto:"Doce"},
    {nome:"Rígida", up:"Defesa", down:"Saúde", gosto:"Azedo", desgosto:"Nenhum"},
    {nome:"Arrojada", up:"Defesa", down:"Ataque", gosto:"Azedo", desgosto:"Picante"},
    {nome:"Endiabrada", up:"Defesa", down:"Ataque Especial", gosto:"Azedo", desgosto:"Seco"},
    {nome:"Negligente", up:"Defesa", down:"Defesa Especial", gosto:"Azedo", desgosto:"Amargo"},
    {nome:"Relaxada", up:"Defesa", down:"Velocidade", gosto:"Azedo", desgosto:"Doce"},
    {nome:"Tímida", up:"Ataque Especial", down:"Saúde", gosto:"Seco", desgosto:"Nenhum"},
    {nome:"Modesta", up:"Ataque Especial", down:"Ataque", gosto:"Seco", desgosto:"Picante"},
    {nome:"Amável", up:"Ataque Especial", down:"Defesa", gosto:"Seco", desgosto:"Azedo"},
    {nome:"Imprudente", up:"Ataque Especial", down:"Defesa Especial", gosto:"Seco", desgosto:"Amargo"},
    {nome:"Quieta", up:"Ataque Especial", down:"Velocidade", gosto:"Seco", desgosto:"Doce"},
    {nome:"Enjoada", up:"Defesa Especial", down:"Saúde", gosto:"Amargo", desgosto:"Nenhum"},
    {nome:"Calma", up:"Defesa Especial", down:"Ataque", gosto:"Amargo", desgosto:"Picante"},
    {nome:"Gentil", up:"Defesa Especial", down:"Defesa", gosto:"Amargo", desgosto:"Azedo"},
    {nome:"Meticulosa", up:"Defesa Especial", down:"Ataque Especial", gosto:"Amargo", desgosto:"Seco"},
    {nome:"Atrevida", up:"Defesa Especial", down:"Velocidade", gosto:"Amargo", desgosto:"Doce"},
    {nome:"Séria", up:"Velocidade", down:"Saúde", gosto:"Doce", desgosto:"Nenhum"},
    {nome:"Medrosa", up:"Velocidade", down:"Ataque", gosto:"Doce", desgosto:"Picante"},
    {nome:"Apressada", up:"Velocidade", down:"Defesa", gosto:"Doce", desgosto:"Azedo"},
    {nome:"Alegre", up:"Velocidade", down:"Ataque Especial", gosto:"Doce", desgosto:"Seco"},
    {nome:"Ingênua", up:"Velocidade", down:"Defesa Especial", gosto:"Doce", desgosto:"Amargo"},
    {nome:"Comedida", up:"Nenhum", down:"Nenhum", gosto:"Nenhum", desgosto:"Nenhum"},
    {nome:"Chata", up:"Nenhum", down:"Nenhum", gosto:"Nenhum", desgosto:"Nenhum"},
    {nome:"Paciente", up:"Nenhum", down:"Nenhum", gosto:"Nenhum", desgosto:"Nenhum"},
    {nome:"Sensata", up:"Nenhum", down:"Nenhum", gosto:"Nenhum", desgosto:"Nenhum"},
    {nome:"Estóica", up:"Nenhum", down:"Nenhum", gosto:"Nenhum", desgosto:"Nenhum"}
  ]

  // Lista de condições
  const condicoes = [
    {
      nome: "Atordoamento",
      descricao: "Esta Condição só dura uma rodada. Durante a rodada em que dura, o pokémon ou o humano não podem executar nenhuma Ação."
    },
    {
      nome: "Confusão",
      descricao: "Esta Condição afeta pokémons e humanos de maneiras diferentes. Para humanos, quando o turno do Humano Confuso começar, role 1d20. Um resultado menor que 11 indica que o humano não faz nenhuma Ação. Se o resultado for 11 ou mais, ele age normalmente naquela rodada. A Confusão é curada quando o humano repousar.",
      tabela: {
        titulo: "Confusão - Pokémon",
        colunas: ["Resultado da Rolagem", "Efeito"],
        linhas: [
          ["1 a 10", "O pokémon sofre dano (ignorando resistências, imunidades e vulnerabilidades, e sem aplicar Atributos) igual ao dobro de seu próprio Bônus Elemental."],
          ["11 a 15", "O pokémon executa aquela Ação normalmente."],
          ["16 a 20", "O pokémon está curado da Confusão."]
        ]
      }
    },
    {
      nome: "Congelamento",
      descricao: "Quando Congelado, não é possível fazer nenhuma Ação. Uma vez por rodada, você pode tentar se curar desta Condição rolando 1d20. Se o resultado for 16 ou mais, não se está mais Congelado. Um pokémon de Fogo, de Gelo ou Lutador só precisa de um resultado 11 ou mais neste teste para não estar mais com Congelamento. Um pokémon ou um humano Congelado atingido por um Golpe causador de dano de Fogo, Lutador, Metálico ou de Pedra é descongelado."
    },
    {
      nome: "Crítico",
      descricao: "O Crítico só dura por uma rolagem de dano e a Condição Crítico pode se acumular com outras duas Condições. Para a rolagem de dano Crítico, todo o Dano Basal da rolagem é feito duas vezes. Por exemplo, o Golpe Pulso do Dragão causa 3d12+10 de dano duas vezes quando se trata de um Crítico, para um total de 6d12+20."
    },
    {
      nome: "Paixão",
      descricao: "Apenas pokémons recebem esta Condição. Antes de usar um Golpe, role 1d20 e confira a tabela abaixo:",
      tabela: {
        titulo: "Paixão",
        colunas: ["Resultado da Rolagem", "Efeito"],
        linhas: [
          ["1 a 10", "O Golpe não pode ser mirado no pokémon ao qual está apaixonado (a menos que seja benéfico a ele)."],
          ["11 a 19", "O pokémon executa o Golpe normalmente."],
          ["20", "O pokémon está curado da Paixão."]
        ]
      }
    },
    {
      nome: "Paralisia",
      descricao: "Quando Paralisado, seu Atributo Velocidade é reduzido pela metade. A cada rodada Paralisado, role 1d20. Dependendo do resultado, você poderá agir ou não, conforme a quantidade de rodadas Paralisado:",
      tabela: {
        titulo: "Paralisia",
        colunas: ["Rodada Paralisado", "Resultado Mínimo para Agir"],
        linhas: [
          ["Primeira", "6"],
          ["Segunda", "7"],
          ["Terceira", "8"],
          ["Quarta", "9"],
          ["Quinta", "10"],
          ["Sexta", "11"],
          ["Sétima", "12"],
          ["Oitava", "13"],
          ["Nona", "14"],
          ["Décima", "15"],
          ["Rodadas Adiante", "16"]
        ]
      }
    },
    {
      nome: "Queimadura",
      descricao: "Um humano ou pokémon Queimado perde duas Fases de Defesa. Uma vez por turno, ele pode tentar rolar no chão para parar de se queimar, gastando sua Ação Padrão se for humano ou sua Ação de Golpe se for pokémon. Se optar por isso, ele rola 1d20. Se o resultado for 17 ou mais, ele não está mais Queimado. Um pokémon de Fogo só precisa de um resultado 13 ou mais neste teste para não estar mais Queimado. No final de cada rodada, um pokémon Queimado perde um décimo de seus Pontos de Vida máximos. Um humano perde apenas metade disso. Pokémons dentro da pokébola não sofrem os efeitos da Queimadura."
    },
    {
      nome: "Sono",
      descricao: "Se não conseguir acordar, o personagem com Sono simplesmente não faz nenhuma Ação. Se um pokémon for enviado para fora da pokébola com Sono, ele será considerado começando na Terceira rodada para fins da tabela acima. Note que um personagem que ganhou a Condição Sono em virtude do uso do Golpe Descansar sempre dorme por duas rodadas, e não faz nenhum teste para acordar. A cada rodada de Sono, role 1d20. Dependendo do resultado, acorda-se, removendo esta Condição, conforme a quantidade de rodadas dormindo:",
      tabela: {
        titulo: "Sono",
        colunas: ["Rodada com Sono", "Resultado Mínimo para Acordar"],
        linhas: [
          ["Primeira", "16"],
          ["Segunda", "14"],
          ["Terceira", "12"],
          ["Quarta", "10"],
          ["Quinta", "8"],
          ["Rodadas Adiante", "6"]
        ]
      }
    },
    {
      nome: "Veneno",
      descricao: "Enquanto na segurança da pokébola, um pokémon não sofre os efeitos do Veneno. Nem humanos nem pokémons sofrem os efeitos de Veneno se estiverem em repouso completo. Um humano ou pokémon Envenenado perde duas Fases de Defesa Especial. Uma vez por turno, ele pode tentar se curar do Veneno gastando sua Ação Padrão se for humano ou sua Ação de Golpe se for pokémon. Se optar por isso, ele rola 1d20. Se o resultado for 17 ou mais, ele não está mais Envenenado. Este teste para se curar é impossível se o Veneno for descrito como Mortal. Pokémons Metálicos e Venenosos são imunes a todos os Venenos. No final de cada rodada, um pokémon Envenenado perde um décimo de seus Pontos de Vida máximos. Um humano perde apenas metade disso. Se for um Veneno Mortal, a cada rodada há uma quantidade extra de Pontos de Vida perdidos, conforme a tabela abaixo:",
      tabela: {
        titulo: "Veneno Mortal",
        colunas: ["Rodada com Veneno Mortal", "Pontos de Vida Perdidos A Mais"],
        linhas: [
          ["Primeira", "5"],
          ["Segunda", "10"],
          ["Terceira", "20"],
          ["Quarta", "40"],
          ["Quinta", "80"],
          ["Sexta", "160"],
          ["Rodadas Adiante", "Dobre o número da rodada anterior."]
        ]
      }
    }
  ]

  const users = [
    { username: 'Mestre', type: 'mestre', gradient: 'linear-gradient(135deg, #FFD700, #FFA500, #FF8C00)' },
    { username: 'Alocin', type: 'treinador', gradient: 'linear-gradient(135deg, #000080, #4169E1, #87CEEB, #FFFFFF)' },
    { username: 'Lila', type: 'treinador', gradient: 'linear-gradient(135deg, #800080, #9370DB, #FF1493, #FF69B4)' },
    { username: 'Ludovic', type: 'treinador', gradient: 'linear-gradient(135deg, #8B0000, #DC143C, #FF6347, #2F4F4F)' },
    { username: 'Noryat', type: 'treinador', gradient: 'linear-gradient(135deg, #000000, #404040, #808080, #FFFFFF)' },
    { username: 'Pedro', type: 'treinador', gradient: 'linear-gradient(135deg, #0000CD, #4169E1, #00CED1, #32CD32)' }
  ]

  const mestreAreas = ['Gerador Pokémon', 'Árvore de Apricorns M', 'Batalha', 'Batalha Game Boy M', 'Bugigangas do Mestre', 'Cenários da Sessão', 'Central Niaypeta Rio Corp™ M', 'Clima', 'Enciclopédia M', 'Hub de Troca M', 'Interlúdio M', 'NPCs Arquivados', 'PokeApp', 'Pokémon NPC', 'Safari Staff', 'Times NPC', 'Treinador NPC', 'Objetivos M', 'Visão do Mestre', 'XP & Capturas M']
  const treinadorAreas = ['Treinador', 'Árvore de Apricorns', 'Batalha Game Boy', 'Batalha Pkm', 'Características & Talentos', 'Central Niaypeta Rio Corp™', 'Enciclopédia', 'Hub de Troca', 'Insígnias', 'Interlúdio', 'Mochila', 'PC', 'Pokédex', 'Pokéloja', 'Progressão', 'Safari', 'SmartPokefone']

  // ===== CONFIGURACOES SAFARI =====
  const SAFARI_TRAINERS = ['Alocin', 'Lila', 'Ludovic', 'Noryat', 'Pedro']
  const SAFARI_ENTRY_COST = 500

  const SAFARI_AREA_CONNECTIONS = {
    'Área Central': ['Área Leste', 'Área Oeste'],
    'Área Leste': ['Área Central', 'Área Nordeste'],
    'Área Oeste': ['Área Central', 'Área Noroeste'],
    'Área Nordeste': ['Área Leste', 'Área Norte'],
    'Área Noroeste': ['Área Oeste', 'Área Norte'],
    'Área Norte': ['Área Nordeste', 'Área Noroeste']
  }

  const SAFARI_AREA_TERRAIN = {
    'Área Central': { grama: 100, agua: 0 },
    'Área Leste': { grama: 50, agua: 50 },
    'Área Oeste': { grama: 50, agua: 50 },
    'Área Nordeste': { grama: 100, agua: 0 },
    'Área Noroeste': { grama: 20, agua: 70 },
    'Área Norte': { grama: 50, agua: 50 }
  }

  const SAFARI_SOLO_SPECIES = [
    'Scyther', 'Pinsir', 'Golduck', 'Lapras', 'Octillery', 'Froakie', 'Wobbuffet', 'Tympole', 'Tauros', 'Girafarig', 'Gligar', 'Quagsire', 'Miltank',
    'Shuckle', 'Xatu', 'Geodude'
  ]

  const SAFARI_ENCOUNTERS = [
    // Área Central - Grama
    { pokemon: 'Pikachu', chance: 5, level: '8-13', area: 'Área Central', terrain: 'Grama', isSkittish: false },
    { pokemon: 'Oddish', chance: 26, level: '8-13', area: 'Área Central', terrain: 'Grama', isSkittish: false },
    { pokemon: 'Doduo', chance: 19, level: '8-13', area: 'Área Central', terrain: 'Grama', isSkittish: false },
    { pokemon: 'Natu', chance: 12, level: '8-13', area: 'Área Central', terrain: 'Grama', isSkittish: false },
    { pokemon: 'Girafarig', chance: 5, level: '13', area: 'Área Central', terrain: 'Grama', isSkittish: false },
    { pokemon: 'Wobbuffet', chance: 5, level: '13', area: 'Área Central', terrain: 'Grama', isSkittish: false },
    { pokemon: 'Gastly', chance: 1, level: '5', area: 'Área Central', terrain: 'Grama', isSkittish: true },
    { pokemon: 'Tauros', chance: 1, level: '5', area: 'Área Central', terrain: 'Grama', isSkittish: true },
    { pokemon: 'Froakie', chance: 1, level: '5', area: 'Área Central', terrain: 'Grama', isSkittish: true },
    { pokemon: null, chance: 25, level: '-', area: 'Área Central', terrain: 'Grama', isSkittish: false },
    // Área Oeste - Grama
    { pokemon: 'Pikachu', chance: 10, level: '15-20', area: 'Área Oeste', terrain: 'Grama', isSkittish: false },
    { pokemon: 'Oddish', chance: 15, level: '15-20', area: 'Área Oeste', terrain: 'Grama', isSkittish: false },
    { pokemon: 'Gloom', chance: 8, level: '22-25', area: 'Área Oeste', terrain: 'Grama', isSkittish: false },
    { pokemon: 'Doduo', chance: 10, level: '13-18', area: 'Área Oeste', terrain: 'Grama', isSkittish: false },
    { pokemon: 'Natu', chance: 10, level: '13-18', area: 'Área Oeste', terrain: 'Grama', isSkittish: false },
    { pokemon: 'Girafarig', chance: 10, level: '23', area: 'Área Oeste', terrain: 'Grama', isSkittish: false },
    { pokemon: 'Wobbuffet', chance: 10, level: '23', area: 'Área Oeste', terrain: 'Grama', isSkittish: false },
    { pokemon: 'Tauros', chance: 1, level: '10', area: 'Área Oeste', terrain: 'Grama', isSkittish: true },
    { pokemon: 'Scyther', chance: 1, level: '10', area: 'Área Oeste', terrain: 'Grama', isSkittish: true },
    { pokemon: null, chance: 25, level: '-', area: 'Área Oeste', terrain: 'Grama', isSkittish: false },
    // Área Oeste - Água
    { pokemon: 'Lapras', chance: 1, level: '10', area: 'Área Oeste', terrain: 'Água', isSkittish: true },
    { pokemon: 'Tympole', chance: 1, level: '10', area: 'Área Oeste', terrain: 'Água', isSkittish: true },
    { pokemon: 'Froakie', chance: 1, level: '10', area: 'Área Oeste', terrain: 'Água', isSkittish: true },
    { pokemon: 'Psyduck', chance: 15, level: '15-20', area: 'Área Oeste', terrain: 'Água', isSkittish: false },
    { pokemon: 'Goldeen', chance: 15, level: '15-20', area: 'Área Oeste', terrain: 'Água', isSkittish: false },
    { pokemon: 'Magikarp', chance: 35, level: '5-10', area: 'Área Oeste', terrain: 'Água', isSkittish: false },
    { pokemon: 'Seaking', chance: 7, level: '30-33', area: 'Área Oeste', terrain: 'Água', isSkittish: false },
    { pokemon: null, chance: 25, level: '-', area: 'Área Oeste', terrain: 'Água', isSkittish: false },
    // Área Leste - Grama
    { pokemon: 'Hoothoot', chance: 5, level: '13-18', area: 'Área Leste', terrain: 'Grama', isSkittish: false },
    { pokemon: 'Spinarak', chance: 7, level: '13-18', area: 'Área Leste', terrain: 'Grama', isSkittish: false },
    { pokemon: 'Mareep', chance: 20, level: '13-18', area: 'Área Leste', terrain: 'Grama', isSkittish: false },
    { pokemon: 'Aipom', chance: 6, level: '23', area: 'Área Leste', terrain: 'Grama', isSkittish: false },
    { pokemon: 'Sunkern', chance: 20, level: '13-18', area: 'Área Leste', terrain: 'Grama', isSkittish: false },
    { pokemon: 'Gligar', chance: 5, level: '23', area: 'Área Leste', terrain: 'Grama', isSkittish: false },
    { pokemon: 'Snubbull', chance: 5, level: '13-18', area: 'Área Leste', terrain: 'Grama', isSkittish: false },
    { pokemon: 'Stantler', chance: 5, level: '23', area: 'Área Leste', terrain: 'Grama', isSkittish: false },
    { pokemon: 'Tauros', chance: 1, level: '10', area: 'Área Leste', terrain: 'Grama', isSkittish: true },
    { pokemon: 'Scyther', chance: 1, level: '10', area: 'Área Leste', terrain: 'Grama', isSkittish: true },
    { pokemon: null, chance: 25, level: '-', area: 'Área Leste', terrain: 'Grama', isSkittish: false },
    // Área Leste - Água
    { pokemon: 'Lapras', chance: 1, level: '10', area: 'Área Leste', terrain: 'Água', isSkittish: true },
    { pokemon: 'Tympole', chance: 1, level: '10', area: 'Área Leste', terrain: 'Água', isSkittish: true },
    { pokemon: 'Froakie', chance: 1, level: '10', area: 'Área Leste', terrain: 'Água', isSkittish: true },
    { pokemon: 'Marill', chance: 10, level: '13-18', area: 'Área Leste', terrain: 'Água', isSkittish: false },
    { pokemon: 'Wooper', chance: 10, level: '13-18', area: 'Área Leste', terrain: 'Água', isSkittish: false },
    { pokemon: 'Quagsire', chance: 1, level: '30-33', area: 'Área Leste', terrain: 'Água', isSkittish: false },
    { pokemon: 'Goldeen', chance: 10, level: '13-18', area: 'Área Leste', terrain: 'Água', isSkittish: false },
    { pokemon: 'Magikarp', chance: 30, level: '5-10', area: 'Área Leste', terrain: 'Água', isSkittish: false },
    { pokemon: 'Remoraid', chance: 10, level: '13-18', area: 'Área Leste', terrain: 'Água', isSkittish: false },
    { pokemon: 'Octillery', chance: 1, level: '30-33', area: 'Área Leste', terrain: 'Água', isSkittish: false },
    { pokemon: null, chance: 25, level: '-', area: 'Área Leste', terrain: 'Água', isSkittish: false },
    // Área Nordeste - Grama
    { pokemon: 'Hoothoot', chance: 5, level: '25-32', area: 'Área Nordeste', terrain: 'Grama', isSkittish: false },
    { pokemon: 'Ledyba', chance: 10, level: '25-32', area: 'Área Nordeste', terrain: 'Grama', isSkittish: false },
    { pokemon: 'Aipom', chance: 10, level: '39-42', area: 'Área Nordeste', terrain: 'Grama', isSkittish: false },
    { pokemon: 'Sunkern', chance: 14, level: '25-32', area: 'Área Nordeste', terrain: 'Grama', isSkittish: false },
    { pokemon: 'Pineco', chance: 9, level: '25-32', area: 'Área Nordeste', terrain: 'Grama', isSkittish: false },
    { pokemon: 'Teddiursa', chance: 9, level: '5-35', area: 'Área Nordeste', terrain: 'Grama', isSkittish: false },
    { pokemon: 'Houndour', chance: 5, level: '5-35', area: 'Área Nordeste', terrain: 'Grama', isSkittish: true },
    { pokemon: 'Miltank', chance: 4, level: '37-40', area: 'Área Nordeste', terrain: 'Grama', isSkittish: true },
    { pokemon: 'Shuckle', chance: 5, level: '20-40', area: 'Área Nordeste', terrain: 'Grama', isSkittish: false },
    { pokemon: 'Tauros', chance: 2, level: '15', area: 'Área Nordeste', terrain: 'Grama', isSkittish: true },
    { pokemon: 'Scyther', chance: 2, level: '15', area: 'Área Nordeste', terrain: 'Grama', isSkittish: true },
    { pokemon: null, chance: 25, level: '-', area: 'Área Nordeste', terrain: 'Grama', isSkittish: false },
    // Área Noroeste - Grama
    { pokemon: 'Oddish', chance: 20, level: '25-32', area: 'Área Noroeste', terrain: 'Grama', isSkittish: false },
    { pokemon: 'Gloom', chance: 15, level: '35-41', area: 'Área Noroeste', terrain: 'Grama', isSkittish: false },
    { pokemon: 'Doduo', chance: 20, level: '25-32', area: 'Área Noroeste', terrain: 'Grama', isSkittish: false },
    { pokemon: 'Dodrio', chance: 5, level: '35-41', area: 'Área Noroeste', terrain: 'Grama', isSkittish: true },
    { pokemon: 'Rhyhorn', chance: 10, level: '25-32', area: 'Área Noroeste', terrain: 'Grama', isSkittish: true },
    { pokemon: 'Pinsir', chance: 5, level: '37-40', area: 'Área Noroeste', terrain: 'Grama', isSkittish: true },
    { pokemon: null, chance: 25, level: '-', area: 'Área Noroeste', terrain: 'Grama', isSkittish: false },
    // Área Noroeste - Água
    { pokemon: 'Lapras', chance: 2, level: '15', area: 'Área Noroeste', terrain: 'Água', isSkittish: true },
    { pokemon: 'Tympole', chance: 2, level: '15', area: 'Área Noroeste', terrain: 'Água', isSkittish: true },
    { pokemon: 'Froakie', chance: 2, level: '15', area: 'Área Noroeste', terrain: 'Água', isSkittish: true },
    { pokemon: 'Psyduck', chance: 15, level: '20-35', area: 'Área Noroeste', terrain: 'Água', isSkittish: false },
    { pokemon: 'Golduck', chance: 5, level: '25-40', area: 'Área Noroeste', terrain: 'Água', isSkittish: true },
    { pokemon: 'Goldeen', chance: 15, level: '22-28', area: 'Área Noroeste', terrain: 'Água', isSkittish: false },
    { pokemon: 'Magikarp', chance: 25, level: '8-13', area: 'Área Noroeste', terrain: 'Água', isSkittish: false },
    { pokemon: 'Seaking', chance: 9, level: '25-40', area: 'Área Noroeste', terrain: 'Água', isSkittish: false },
    { pokemon: null, chance: 25, level: '-', area: 'Área Noroeste', terrain: 'Água', isSkittish: false },
    // Área Norte - Grama
    { pokemon: 'Oddish', chance: 22, level: '37-42', area: 'Área Norte', terrain: 'Grama', isSkittish: false },
    { pokemon: 'Gloom', chance: 5, level: '43-48', area: 'Área Norte', terrain: 'Grama', isSkittish: false },
    { pokemon: 'Natu', chance: 10, level: '37-42', area: 'Área Norte', terrain: 'Grama', isSkittish: false },
    { pokemon: 'Xatu', chance: 4, level: '45-50', area: 'Área Norte', terrain: 'Grama', isSkittish: true },
    { pokemon: 'Heracross', chance: 4, level: '15-46', area: 'Área Norte', terrain: 'Grama', isSkittish: true },
    { pokemon: 'Phanpy', chance: 5, level: '13-33', area: 'Área Norte', terrain: 'Grama', isSkittish: true },
    { pokemon: 'Geodude', chance: 15, level: '5-30', area: 'Área Norte', terrain: 'Grama', isSkittish: false },
    { pokemon: 'Tauros', chance: 5, level: '20', area: 'Área Norte', terrain: 'Grama', isSkittish: true },
    { pokemon: 'Scyther', chance: 5, level: '20', area: 'Área Norte', terrain: 'Grama', isSkittish: true },
    { pokemon: null, chance: 25, level: '-', area: 'Área Norte', terrain: 'Grama', isSkittish: false },
    // Área Norte - Água
    { pokemon: 'Lapras', chance: 5, level: '20', area: 'Área Norte', terrain: 'Água', isSkittish: true },
    { pokemon: 'Tympole', chance: 5, level: '20', area: 'Área Norte', terrain: 'Água', isSkittish: true },
    { pokemon: 'Froakie', chance: 5, level: '20', area: 'Área Norte', terrain: 'Água', isSkittish: true },
    { pokemon: 'Magikarp', chance: 35, level: '20-21', area: 'Área Norte', terrain: 'Água', isSkittish: false },
    { pokemon: 'Goldeen', chance: 25, level: '33-38', area: 'Área Norte', terrain: 'Água', isSkittish: false },
    { pokemon: null, chance: 25, level: '-', area: 'Área Norte', terrain: 'Água', isSkittish: false }
  ]

  const allClasses = [
    { name: 'Artista', color: '#87CEEB', isMaster: true }, { name: 'Beldade', color: '#87CEEB' },
    { name: 'Cativante', color: '#87CEEB' }, { name: 'Coreógrafo', color: '#87CEEB' },
    { name: 'Descolado', color: '#87CEEB' }, { name: 'Estilista', color: '#87CEEB' },
    { name: 'Nerd', color: '#87CEEB' }, { name: 'Parrudo', color: '#87CEEB' },
    { name: 'Captor', color: '#FFA500', isMaster: true }, { name: 'Artífice', color: '#FFA500' },
    { name: 'Colecionador', color: '#FFA500' }, { name: 'Domador', color: '#FFA500' },
    { name: 'Engenheiro', color: '#FFA500' }, { name: 'Ladrão', color: '#FFA500' },
    { name: 'Malabarista', color: '#FFA500' }, { name: 'Pokébolista', color: '#FFA500' },
    { name: 'Criador', color: '#FFC0CB', isMaster: true }, { name: 'Botânico', color: '#FFC0CB' },
    { name: 'Cozinheiro', color: '#FFC0CB' }, { name: 'Cuidador', color: '#FFC0CB' },
    { name: 'Evolucionista', color: '#FFC0CB' }, { name: 'Incubador', color: '#FFC0CB' },
    { name: 'Médico', color: '#FFC0CB' }, { name: 'Tutor', color: '#FFC0CB' },
    { name: 'Guerreiro', color: '#B8860B', isMaster: true }, { name: 'Artista Marcial', color: '#B8860B' },
    { name: 'Atleta', color: '#B8860B' }, { name: 'Áugure', color: '#B8860B' },
    { name: 'Bandido', color: '#B8860B' }, { name: 'Monge', color: '#B8860B' },
    { name: 'Ninja', color: '#B8860B' }, { name: 'Soldado', color: '#B8860B' },
    { name: 'Místico', color: '#800080', isMaster: true }, { name: 'Bardo', color: '#800080' },
    { name: 'Guardião', color: '#800080' }, { name: 'Ilusionista', color: '#800080' },
    { name: 'Médium', color: '#800080' }, { name: 'Orador', color: '#800080' },
    { name: 'Rúnico', color: '#800080' }, { name: 'Xamã', color: '#800080' },
    { name: 'Pesquisador', color: '#00008B', isMaster: true }, { name: 'Cientista', color: '#00008B' },
    { name: 'Fotógrafo', color: '#00008B' }, { name: 'Hipnólogo', color: '#00008B' },
    { name: 'Observador', color: '#00008B' }, { name: 'Ocultista', color: '#00008B' },
    { name: 'Petrologista', color: '#00008B' }, { name: 'Professor', color: '#00008B' },
    { name: 'Psíquico', color: '#8B4513', isMaster: true }, { name: 'Ardente', color: '#8B4513' },
    { name: 'Bruxo', color: '#8B4513' }, { name: 'Célio', color: '#8B4513' },
    { name: 'Empático', color: '#8B4513' }, { name: 'Nebuloso', color: '#8B4513' },
    { name: 'Terrulento', color: '#8B4513' }, { name: 'Vidente', color: '#8B4513' },
    { name: 'Ranger', color: '#228B22', isMaster: true }, { name: 'Aventureiro', color: '#228B22' },
    { name: 'Cavaleiro', color: '#228B22' }, { name: 'Detetive', color: '#228B22' },
    { name: 'Guia', color: '#228B22' }, { name: 'Oficial', color: '#228B22' },
    { name: 'Pactuário', color: '#228B22' }, { name: 'Policial', color: '#228B22' },
    { name: 'Treinador', color: '#DC143C', isMaster: true }, { name: 'Azarão', color: '#DC143C' },
    { name: 'Caçador', color: '#DC143C' }, { name: 'Elementalista', color: '#DC143C' },
    { name: 'Especialista', color: '#DC143C' }, { name: 'Estrategista', color: '#DC143C' },
    { name: 'Inquebrável', color: '#DC143C' }, { name: 'Síncrono', color: '#DC143C' }
  ]

  const skillsByAttribute = {
    saude: ['Apneia', 'Imunidade', 'Jejum', 'Resiliência'],
    ataque: ['Corrida', 'Força', 'Intimidação', 'Salto'],
    defesa: ['Concentração', 'Deflexão', 'Incansável', 'Regeneração'],
    ataqueEspecial: ['Engenharia', 'História', 'Investigação', 'Programação'],
    defesaEspecial: ['Empatia', 'Manha', 'Manipulação', 'Percepção'],
    velocidade: ['Acrobacia', 'Furtividade', 'Performance', 'Prestidigitação']
  }

  // Tabela de talentos por nível (incluindo características)
  const TALENTOS_POR_NIVEL = {
    1:3,2:4,3:5,4:6,5:7,6:8,7:9,8:10,9:11,10:12,11:13,12:13,13:14,14:14,15:15,16:15,17:16,18:16,19:17,20:17,
    21:18,22:18,23:19,24:19,25:20,26:20,27:21,28:21,29:22,30:22,31:23,32:23,33:24,34:24,35:25,36:25,37:26,
    38:26,39:27,40:27,41:28,42:28,43:29,44:29,45:30,46:30,47:31,48:31,49:32,50:32
  }

  // Função para gerar classes/subclasses aleatórias baseado no nível
  const generateRandomClasses = (level) => {
    let numClasses = 1
    if (level >= 5 && level <= 11) numClasses = 2
    else if (level >= 12 && level <= 23) numClasses = 3
    else if (level >= 24) numClasses = 4

    const selectedClasses = []
    const availableClasses = [...allClasses]

    for (let i = 0; i < numClasses; i++) {
      if (availableClasses.length === 0) break
      const randomIndex = Math.floor(Math.random() * availableClasses.length)
      selectedClasses.push(availableClasses[randomIndex].name)
      availableClasses.splice(randomIndex, 1)
    }

    return selectedClasses
  }

  // Função para obter características de uma classe
  const getClassCaracteristicas = (className) => {
    const caracteristicas = CARACTERISTICAS_DATA[className]
    if (!caracteristicas) return []
    return Object.entries(caracteristicas).map(([nome, data]) => ({
      nome,
      ...data,
      classe: className
    }))
  }

  // Função para gerar talentos aleatórios
  const generateRandomTalentos = (level, classes) => {
    const totalTalentos = TALENTOS_POR_NIVEL[level] || 3
    const selectedTalentos = []

    // Primeiro, adicionar todas as características das classes escolhidas
    classes.forEach(className => {
      const caracteristicas = getClassCaracteristicas(className)
      caracteristicas.forEach(carac => {
        selectedTalentos.push({ tipo: 'caracteristica', ...carac })
      })
    })

    // Calcular quantos talentos ainda faltam
    const talentosRestantes = totalTalentos - selectedTalentos.length

    if (talentosRestantes > 0) {
      // Coletar todos os talentos disponíveis das classes do NPC
      const availableTalentos = []

      classes.forEach(className => {
        if (TALENTOS_DATA[className]) {
          TALENTOS_DATA[className].forEach(talento => {
            availableTalentos.push({ tipo: 'talento', classe: className, ...talento })
          })
        }
      })

      // Adicionar talentos gerais
      if (TALENTOS_DATA['Geral']) {
        TALENTOS_DATA['Geral'].forEach(talento => {
          availableTalentos.push({ tipo: 'talento', classe: 'Geral', ...talento })
        })
      }

      // Selecionar talentos aleatórios
      for (let i = 0; i < talentosRestantes && availableTalentos.length > 0; i++) {
        const randomIndex = Math.floor(Math.random() * availableTalentos.length)
        selectedTalentos.push(availableTalentos[randomIndex])
        availableTalentos.splice(randomIndex, 1)
      }
    }

    return selectedTalentos
  }

  // Funções auxiliares
  const getModifier = (value) => {
    const map = {1:-9,2:-8,3:-7,4:-6,5:-5,6:-4,7:-3,8:-2,9:-1,10:0,11:0,12:1,13:1,14:2,15:2,16:3,17:3,18:4,19:4,20:5,21:5,22:6,23:6,24:7,25:7,26:8,27:8,28:9,29:9,30:10,31:10,32:11,33:11,34:12,35:12,36:13,37:13,38:14,39:14,40:15}
    return map[value] || 0
  }

  const getMaxHP = () => (level + attributes.saude) * 4

  const getDisplacement = () => {
    const modAtk = getModifier(attributes.ataque)
    const modDef = getModifier(attributes.defesa)
    const modSpd = getModifier(attributes.velocidade)
    return {
      terrestre: Math.max(5, 3 + Math.floor(Math.max(modAtk, modSpd) / 2)),
      natacao: Math.max(4, 2 + Math.floor(modDef / 2)),
      subaquatico: (modAtk >= 3 || modDef >= 3) ? 4 : 3
    }
  }

  const getEvasion = () => ({
    fisica: Math.floor(attributes.defesa / 5),
    especial: Math.floor(attributes.defesaEspecial / 5),
    veloz: Math.floor(attributes.velocidade / 5)
  })

  const getSkillCount = (attr, skill) => {
    if (!skills || !skills[attr]) return 0
    return skills[attr].filter(s => s === skill).length
  }

  const toggleSkill = (attr, skill) => {
    if (!skills || !skills[attr]) return
    const current = skills[attr]
    const count = current.filter(s => s === skill).length
    let newSkills
    if (count === 0) newSkills = [...current, skill]
    else if (count === 1) newSkills = [...current, skill]
    else newSkills = current.filter(s => s !== skill)
    setSkills({ ...skills, [attr]: newSkills })
  }

  const filteredSpecies = allSpecies.filter(s =>
    s.toLowerCase().includes(speciesSearch.toLowerCase())
  )

  // Funções de cálculo para Treinador NPC
  const calculateModifier = (attributeValue) => {
    const modifierMap = {
      1: -9, 2: -8, 3: -7, 4: -6, 5: -5, 6: -4, 7: -3, 8: -2, 9: -1,
      10: 0, 11: 0, 12: 1, 13: 1, 14: 2, 15: 2, 16: 3, 17: 3, 18: 4,
      19: 4, 20: 5, 21: 5, 22: 6, 23: 6, 24: 7, 25: 7, 26: 8, 27: 8,
      28: 9, 29: 9, 30: 10, 31: 10, 32: 11, 33: 11, 34: 12, 35: 12,
      36: 13, 37: 13, 38: 14, 39: 14, 40: 15
    }
    return modifierMap[attributeValue] || 0
  }

  const calculateNPCHP = (level, saudeAttribute) => {
    return (level + saudeAttribute) * 4
  }

  const calculateDisplacement = (attributes) => {
    const modAtaque = calculateModifier(attributes.ataque)
    const modDefesa = calculateModifier(attributes.defesa)
    const modVelocidade = calculateModifier(attributes.velocidade)

    // Terrestre: 3 + metade do maior entre mod ataque ou velocidade, mínimo 5
    const terrestre = Math.max(5, 3 + Math.floor(Math.max(modAtaque, modVelocidade) / 2))

    // Natação: 2 + metade do mod defesa, mínimo 4
    const natacao = Math.max(4, Math.floor(2 + modDefesa / 2))

    // Subaquático: 3, aumenta para 4 se mod ataque ou defesa >= 3
    const subaquatico = (modAtaque >= 3 || modDefesa >= 3) ? 4 : 3

    return { terrestre, natacao, subaquatico }
  }

  const calculateEvasion = (attributes) => {
    // Física: defesa / 5
    const fisica = Math.floor(attributes.defesa / 5)

    // Especial: defesa especial / 5
    const especial = Math.floor(attributes.defesaEspecial / 5)

    // Veloz: velocidade / 5
    const veloz = Math.floor(attributes.velocidade / 5)

    return { fisica, especial, veloz }
  }

  const distributeRandomAttributes = (level) => {
    // Nível 1 tem 66 pontos, cada nível adicional dá +1 ponto
    const totalPoints = 66 + (level - 1)
    const minPerAttribute = 6
    const numAttributes = 6

    // Garantir mínimo de 6 em cada atributo
    const attributes = {
      saude: minPerAttribute,
      ataque: minPerAttribute,
      defesa: minPerAttribute,
      ataqueEspecial: minPerAttribute,
      defesaEspecial: minPerAttribute,
      velocidade: minPerAttribute
    }

    // Pontos restantes após garantir o mínimo
    let remainingPoints = totalPoints - (minPerAttribute * numAttributes)

    // Distribuir pontos restantes aleatoriamente
    const attrKeys = Object.keys(attributes)
    while (remainingPoints > 0) {
      const randomAttr = attrKeys[Math.floor(Math.random() * attrKeys.length)]
      attributes[randomAttr]++
      remainingPoints--
    }

    return attributes
  }

  // Sistema de Rolagem de Dados - Versão Avançada
  // Rola um único dado XdY e retorna os valores individuais
  const rollSingleDiceNotation = (numDice, numSides) => {
    const rolls = []
    let sum = 0

    for (let i = 0; i < numDice; i++) {
      const roll = Math.floor(Math.random() * numSides) + 1
      rolls.push(roll)
      sum += roll
    }

    return { rolls, sum }
  }

  // Parser avançado que suporta expressões complexas: 2d4+4-4d3+1d6-5
  const rollDiceExpression = (expression) => {
    try {
      // Remove espaços em branco
      expression = expression.trim().replace(/\s/g, '')

      if (!expression) {
        return { error: 'Expressão vazia' }
      }

      // Validação básica de caracteres permitidos
      if (!/^[\dd\+\-]+$/i.test(expression)) {
        return { error: 'Expressão contém caracteres inválidos. Use apenas números, d, + e -' }
      }

      // Array para armazenar todos os detalhes das rolagens
      const rollDetails = []
      let expressionBreakdown = []

      // Divide a expressão em tokens (dados e números)
      // Suporta: 2d6, +3, -4d8, +1d4, etc.
      const tokens = expression.match(/[+-]?(\d+d\d+|\d+)/gi)

      if (!tokens || tokens.length === 0) {
        return { error: 'Nenhuma rolagem ou número válido encontrado' }
      }

      let total = 0

      tokens.forEach((token, index) => {
        // Determina o sinal (primeiro token é positivo por padrão)
        let sign = 1
        let cleanToken = token

        if (token.startsWith('+')) {
          sign = 1
          cleanToken = token.substring(1)
        } else if (token.startsWith('-')) {
          sign = -1
          cleanToken = token.substring(1)
        }

        // Verifica se é uma rolagem de dados (XdY)
        if (cleanToken.includes('d')) {
          const [numDiceStr, numSidesStr] = cleanToken.split('d')
          const numDice = parseInt(numDiceStr)
          const numSides = parseInt(numSidesStr)

          // Validações
          if (isNaN(numDice) || isNaN(numSides)) {
            throw new Error(`Formato inválido em: ${token}`)
          }

          if (numDice <= 0 || numDice > 100) {
            throw new Error(`Número de dados deve estar entre 1 e 100 em: ${token}`)
          }

          if (numSides <= 0 || numSides > 10000) {
            throw new Error(`Número de lados deve estar entre 1 e 10000 em: ${token}`)
          }

          // Rola os dados
          const { rolls, sum } = rollSingleDiceNotation(numDice, numSides)
          const value = sum * sign

          rollDetails.push({
            type: 'dice',
            notation: cleanToken,
            sign: sign > 0 ? '+' : '-',
            numDice,
            numSides,
            rolls,
            sum,
            value,
            display: `${sign > 0 && index > 0 ? '+' : sign < 0 ? '-' : ''}${cleanToken}[${rolls.join(', ')}]=${sum}`
          })

          expressionBreakdown.push({
            original: token,
            rolled: `[${rolls.join('+')}]`,
            sum: sum,
            signedSum: value
          })

          total += value

        } else {
          // É um número simples
          const num = parseInt(cleanToken)

          if (isNaN(num)) {
            throw new Error(`Número inválido: ${token}`)
          }

          const value = num * sign

          rollDetails.push({
            type: 'number',
            sign: sign > 0 ? '+' : '-',
            value,
            display: `${sign > 0 && index > 0 ? '+' : sign < 0 ? '-' : ''}${num}`
          })

          expressionBreakdown.push({
            original: token,
            value: value
          })

          total += value
        }
      })

      // Cria uma fórmula legível
      const formula = rollDetails.map(detail => detail.display).join(' ')

      // Cria breakdown detalhado
      const detailedFormula = expressionBreakdown.map(item => {
        if (item.rolled) {
          return `${item.original}${item.rolled}=${item.sum}`
        }
        return item.original
      }).join(' ')

      return {
        success: true,
        expression,
        total,
        rollDetails,
        formula,
        detailedFormula,
        breakdown: expressionBreakdown
      }

    } catch (error) {
      return {
        error: error.message || 'Erro ao processar expressão'
      }
    }
  }

  // Função legada mantida para compatibilidade (rolagem simples)
  const rollDice = (notation) => {
    const result = rollDiceExpression(notation)

    if (result.error) {
      return result
    }

    // Converte para o formato legado se for uma rolagem simples
    if (result.rollDetails.length === 1 && result.rollDetails[0].type === 'dice') {
      const detail = result.rollDetails[0]
      return {
        notation: detail.notation,
        numDice: detail.numDice,
        numSides: detail.numSides,
        modifier: 0,
        rolls: detail.rolls,
        sum: detail.sum,
        total: result.total,
        formula: result.formula
      }
    }

    return result
  }

  // Parser de texto para múltiplas expressões em um texto
  const parseDiceNotation = (text) => {
    const regex = /[\dd\+\-]+d[\dd\+\-]+/gi
    const matches = text.match(regex)

    if (!matches) {
      return null
    }

    return matches.map(expression => rollDiceExpression(expression))
  }

  // ==================== FUNÇÕES DE PERSISTÊNCIA (FIREBASE) ====================
  // As funções de Firebase são importadas de firebaseService.js
  // Funções locais mantidas para compatibilidade durante transição

  // Flag para controlar se estamos usando Firebase ou localStorage
  const useFirebase = true // Mude para false para voltar ao localStorage

  // Função auxiliar para salvar dados do treinador atual
  const saveCurrentTrainerData = useCallback(async (data) => {
    if (!currentUser || currentUser.type !== 'treinador') return
    if (useFirebase) {
      await saveTrainerData(currentUser.username, data)
    } else {
      localStorage.setItem(`trainer_${currentUser.username}`, JSON.stringify(data))
    }
  }, [currentUser])

  // Função auxiliar para carregar dados de um treinador
  const loadTrainerDataLocal = async (username) => {
    if (useFirebase) {
      return await loadTrainerData(username)
    } else {
      const saved = localStorage.getItem(`trainer_${username}`)
      return saved ? JSON.parse(saved) : null
    }
  }

  // ==================== FIM DAS FUNÇÕES DE PERSISTÊNCIA ====================

  // Funções para Interlúdio
  const handleToggleJN = (username) => {
    // Verifica se o usuário atual tem permissão
    if (!currentUser || currentUser.username !== username) return

    setInterludioPlayers(prevPlayers => prevPlayers.map(player =>
      player.username === username
        ? { ...player, jnChecked: !player.jnChecked, rtChecked: false }
        : player
    ))
  }

  const handleToggleRT = (username) => {
    // Verifica se o usuário atual tem permissão
    if (!currentUser || currentUser.username !== username) return

    setInterludioPlayers(prevPlayers => prevPlayers.map(player =>
      player.username === username
        ? { ...player, rtChecked: !player.rtChecked, jnChecked: false }
        : player
    ))
  }

  const handleAcaoJN = (username, acao) => {
    // Verifica se o usuário atual tem permissão
    if (!currentUser || currentUser.username !== username) return

    const player = interludioPlayers.find(p => p.username === username)
    if (!player || player.jnPoints < acao.custo) return

    // Deduz os pontos
    setInterludioPlayers(prevPlayers => prevPlayers.map(p =>
      p.username === username
        ? { ...p, jnPoints: p.jnPoints - acao.custo }
        : p
    ))

    // Envia mensagem ao chat
    const timestamp = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
    addChatMessage({
      username: username,
      text: `${acao.nome} (JN - ${acao.custo} pts)`,
      timestamp,
      isDiceRoll: false,
      isAction: true
    })

    // Rolagens automáticas para ações específicas
    if (acao.nome === 'Procurar Pokémon') {
      const d6Roll = Math.floor(Math.random() * 6) + 1
      const total = d6Roll + 1
      const rollTimestamp = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
      addChatMessage({
        username: username,
        text: `🎲 Procurar Pokémon - 1d6+1`,
        timestamp: rollTimestamp,
        isDiceRoll: true,
        diceResult: `1d6(${d6Roll}) + 1 = ${total} pokémons gerados`
      })
    } else if (acao.nome === 'Catalogar pokémon') {
      const d8Roll = Math.floor(Math.random() * 8) + 1
      const total = d8Roll + 2
      const rollTimestamp = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
      addChatMessage({
        username: username,
        text: `🎲 Catalogar pokémon - 1d8+2`,
        timestamp: rollTimestamp,
        isDiceRoll: true,
        diceResult: `1d8(${d8Roll}) + 2 = ${total} pokémons gerados`
      })
    } else if (acao.nome === 'Batalha com treinador') {
      const d4Treinadores = Math.floor(Math.random() * 4) + 1
      const d4Pokemons = Math.floor(Math.random() * 4) + 1
      const totalPokemons = d4Pokemons + 1
      const rollTimestamp = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
      addChatMessage({
        username: username,
        text: `🎲 Batalha com treinador`,
        timestamp: rollTimestamp,
        isDiceRoll: true,
        diceResult: `Treinadores: 1d4 = ${d4Treinadores} | Pokémons por treinador: 1d4(${d4Pokemons}) + 1 = ${totalPokemons}`
      })
    }
  }

  const handleAcaoRT = (username, acao) => {
    // Verifica se o usuário atual tem permissão
    if (!currentUser || currentUser.username !== username) return

    const player = interludioPlayers.find(p => p.username === username)
    if (!player || player.rtPoints < acao.custo) return

    // Deduz os pontos
    setInterludioPlayers(prevPlayers => prevPlayers.map(p =>
      p.username === username
        ? { ...p, rtPoints: p.rtPoints - acao.custo }
        : p
    ))

    // Envia mensagem ao chat
    const timestamp = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
    addChatMessage({
      username: username,
      text: `${acao.nome} (RT - ${acao.custo} pts)`,
      timestamp,
      isDiceRoll: false,
      isAction: true
    })
  }

  const handleResetPoints = (username) => {
    // Verifica se o usuário atual tem permissão
    if (!currentUser || currentUser.username !== username) return

    setInterludioPlayers(prevPlayers => prevPlayers.map(player =>
      player.username === username
        ? { ...player, jnPoints: 5, rtPoints: 5 }
        : player
    ))
  }

  const handleOpenCustomModal = (username, type) => {
    // Verifica se o usuário atual tem permissão
    if (!currentUser || currentUser.username !== username) return

    setCustomActionPlayer(username)
    setCustomActionType(type)
    setShowCustomModal(true)
  }

  const handleCustomActionSubmit = () => {
    if (!customActionName.trim() || !customActionCost) return

    const cost = parseInt(customActionCost)
    if (isNaN(cost) || cost <= 0) return

    const player = interludioPlayers.find(p => p.username === customActionPlayer)
    const pointsField = customActionType === 'jn' ? 'jnPoints' : 'rtPoints'

    if (!player || player[pointsField] < cost) return

    // Deduz os pontos
    setInterludioPlayers(prevPlayers => prevPlayers.map(p =>
      p.username === customActionPlayer
        ? { ...p, [pointsField]: p[pointsField] - cost }
        : p
    ))

    // Envia mensagem ao chat
    const timestamp = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
    const typeLabel = customActionType === 'jn' ? 'JN' : 'RT'
    addChatMessage({
      username: customActionPlayer,
      text: `${customActionName} (${typeLabel} - ${cost} pts)`,
      timestamp,
      isDiceRoll: false,
      isAction: true
    })

    // Fecha o modal e limpa os campos
    setShowCustomModal(false)
    setCustomActionName('')
    setCustomActionCost('')
    setCustomActionPlayer(null)
    setCustomActionType('')
  }

  const handleSendMessage = () => {
    if (!chatInput.trim()) return

    const message = chatInput.trim()
    const timestamp = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })

    // Verifica se a mensagem contém comandos @ ou expressões de dados
    const hasCommand = message.includes('@')
    const hasDiceExpression = /\d+d\d+/i.test(message)
    const isRollCommand = message.startsWith('/r ') || message.startsWith('/roll ')

    // Se é comando /r ou /roll, usar o sistema antigo
    if (isRollCommand) {
      const expression = message.replace(/^\/(r|roll)\s+/, '')
      const result = rollDiceExpression(expression)

      if (result.error) {
        addChatMessage({
          username: 'Sistema',
          text: `❌ Erro: ${result.error}`,
          timestamp,
          isDiceRoll: false
        })
      } else {
        addChatMessage({
          username: currentUser.username,
          text: `🎲 ${expression}`,
          timestamp,
          isDiceRoll: true,
          diceResult: result.total,
          diceDetails: result.formula
        })
      }
    }
    // Se tem comando @ ou expressão de dado, processar
    else if (hasCommand || hasDiceExpression) {
      const result = processCommandExpression(message)

      if (result) {
        // Construir mensagem formatada
        let formattedMessage = `🎲 ${result.original}\n`

        // Mostrar dados rolados
        if (result.diceResults.length > 0) {
          result.diceResults.forEach(dice => {
            formattedMessage += `${dice.original} = [${dice.rolls.join(', ')}] = ${dice.total}\n`
          })
        }

        // Mostrar substituições de comandos
        if (result.substitutions.length > 0) {
          result.substitutions.forEach(sub => {
            formattedMessage += `${sub.command} = ${sub.value}\n`
          })
        }

        formattedMessage += `\nTotal: ${result.finalResult}`

        addChatMessage({
          username: currentUser.username,
          text: formattedMessage,
          timestamp,
          isDiceRoll: true,
          diceResult: result.finalResult
        })
      } else {
        addChatMessage({
          username: 'Sistema',
          text: `❌ Erro ao processar expressão`,
          timestamp,
          isDiceRoll: false
        })
      }
    }
    // Mensagem normal
    else {
      addChatMessage({
        username: currentUser.username,
        text: message,
        timestamp,
        isDiceRoll: false
      })
    }

    setChatInput('')
  }

  // Função para usar golpe na batalha
  const handleUseBattleMove = (moveName) => {
    if (!selectedTeamPokemon) return

    const moveData = GOLPES_DATA[moveName]
    if (!moveData) return

    const timestamp = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
    const pokemonName = selectedTeamPokemon.nickname || selectedTeamPokemon.species

    // Verificar se o golpe tem acurácia automática
    const isAutoAccuracy = moveData.acuracia === 'Automática' || moveData.acuracia === 'Automático'

    // Enviar mensagem do uso do golpe
    addChatMessage({
      username: currentUser.username,
      text: `${pokemonName} usou ${moveName}!`,
      timestamp,
      isDiceRoll: false,
      isAction: true
    })

    // Se não for acurácia automática, rolar 1d20
    if (!isAutoAccuracy) {
      const accuracyRoll = Math.floor(Math.random() * 20) + 1

      // Obter fase de precisão do Pokémon
      const pokemonId = selectedTeamPokemon.id || `team-${selectedTeamPokemon.species}`
      const stages = pokemonStages[pokemonId] || {}
      const precisaoStage = stages.precisao || 0

      // Calcular resultado final com modificador de precisão
      const finalResult = accuracyRoll + precisaoStage
      let detailsParts = `1d20 = ${accuracyRoll}`
      if (precisaoStage !== 0) {
        detailsParts += ` | Fase Precisão: ${precisaoStage >= 0 ? '+' : ''}${precisaoStage}`
      }

      setTimeout(() => {
        addChatMessage({
          username: currentUser.username,
          text: `🎲 Teste de Acurácia: 1d20`,
          timestamp: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
          isDiceRoll: true,
          diceResult: finalResult,
          diceDetails: detailsParts
        })
      }, 100)
    }

    setShowBattleMoveModal(false)
  }

  // Função para rolar dano do golpe
  const handleRollMoveDamage = (moveName) => {
    // Determinar qual Pokémon está selecionado (treinador ou mestre)
    const activePokemon = selectedTeamPokemon || selectedMasterNpcPokemon
    if (!activePokemon) return

    const moveData = GOLPES_DATA[moveName]
    if (!moveData) return

    const timestamp = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })

    // Usar nome mascarado se o Pokémon NPC não estiver revelado
    const isNpcPokemon = activePokemon.isNpc || (selectedMasterNpcPokemon && selectedMasterNpcPokemon.id === activePokemon.id)
    const pokemonName = isNpcPokemon && !revealedNpcPokemon[activePokemon.id]
      ? (activePokemon.nomeFalso || activePokemon.nickname || activePokemon.nome || activePokemon.species || '???')
      : (activePokemon.nickname || activePokemon.nome || activePokemon.species)

    // Extrair dano basal
    const danoBasal = moveData.danoBasal
    if (!danoBasal || danoBasal === '-' || danoBasal === '') {
      addChatMessage({
        username: 'Sistema',
        text: `❌ Este golpe não possui dano basal`,
        timestamp,
        isDiceRoll: false
      })
      return
    }

    // Determinar se é físico ou especial baseado no campo danoBasal
    const isFisico = danoBasal.includes('Físico')
    const isEspecial = danoBasal.includes('Especial')

    // Pegar atributos do pokémon (verificar se é exótico ou NPC)
    let pokemonData
    const pokemonSpecies = activePokemon.species || activePokemon.especie

    if (activePokemon.isExotic) {
      // Buscar dados do exótico em globalExoticSpecies
      pokemonData = globalExoticSpecies.find(e => e.nome === pokemonSpecies)
    } else {
      // Buscar dados do pokémon normal em fullPokedexData
      pokemonData = fullPokedexData.find(p => p.nome === pokemonSpecies)
    }

    // Calcular ataque total (base + EVs + natureza)
    let ataqueTotalRaw = 0
    if (activePokemon.totalAttributes) {
      // Pokémon tem totalAttributes já calculado
      ataqueTotalRaw = isFisico ? activePokemon.totalAttributes.ataque : activePokemon.totalAttributes.ataqueEspecial
    } else if (activePokemon.baseAttributes && activePokemon.nature && activePokemon.levelPoints) {
      // Pokémon tem dados completos (do time do treinador) - calcular
      const attrKey = isFisico ? 'ataque' : 'ataqueEspecial'
      const attrLabel = isFisico ? 'Ataque' : 'Ataque Especial'
      ataqueTotalRaw = calculateTotalAttribute(activePokemon, attrKey, attrLabel)
    } else {
      // Pokémon antigo sem dados completos - usar apenas atributo base
      ataqueTotalRaw = isFisico ? (pokemonData?.statusBasais?.ataque || 0) : (pokemonData?.statusBasais?.ataqueEspecial || 0)
    }

    // Aplicar multiplicador de fase ao ataque total
    // Para Pokémon NPC (id começa com npc-pokemon-), usar o ID diretamente
    // Para Pokémon do time, buscar pelo originalId na batalha
    let battleId = activePokemon.id
    const idString = String(activePokemon.id || '')
    if (activePokemon.id && !idString.startsWith('npc-pokemon-')) {
      const teamPokemonId = activePokemon.id || `team-${activePokemon.species}`
      const pokemonInBattle = battlePokemonList.find(p => p.originalId === teamPokemonId)
      if (pokemonInBattle) {
        battleId = pokemonInBattle.id
      }
    }
    const stages = pokemonStages[battleId] || {}
    const ataqueStage = isFisico ? (stages.ataque || 0) : (stages.ataqueEspecial || 0)
    const ataqueMultiplier = getStageMultiplier(ataqueStage)
    const ataqueBase = Math.floor(ataqueTotalRaw * ataqueMultiplier)

    // Calcular bônus elemental (STAB)
    let bonusElemental = 0
    // Usar tipos customizados do pokémon (editados pelo Elementalista) se disponíveis,
    // caso contrário usar tipos padrão da espécie
    const pokemonTypes = activePokemon.types || pokemonData?.tipos || []
    const moveType = moveData.tipo
    if (pokemonTypes.includes(moveType)) {
      bonusElemental = calculateElementalBonus(activePokemon)
    }

    // Rolar os dados do dano basal (extrair apenas a parte numérica)
    const diceMatch = danoBasal.match(/(\d+)d(\d+)(?:\+(\d+))?/)
    if (diceMatch) {
      const [, numDice, diceSides, bonus] = diceMatch
      let total = 0
      let danoBasalText = ''

      if (isCritical) {
        // Modo CRIT: rolar dano basal duas vezes e mostrar separadamente
        const rolls1 = []
        const rolls2 = []
        let total1 = 0
        let total2 = 0

        // Primeira rolagem
        for (let i = 0; i < parseInt(numDice); i++) {
          const roll = Math.floor(Math.random() * parseInt(diceSides)) + 1
          rolls1.push(roll)
          total1 += roll
        }
        if (bonus) total1 += parseInt(bonus)

        // Segunda rolagem
        for (let i = 0; i < parseInt(numDice); i++) {
          const roll = Math.floor(Math.random() * parseInt(diceSides)) + 1
          rolls2.push(roll)
          total2 += roll
        }
        if (bonus) total2 += parseInt(bonus)

        total = total1 + total2
        danoBasalText = `CRÍTICO! Dano Basal: ${danoBasal} = [${rolls1.join('+')}${bonus ? `+${bonus}` : ''}] + [${rolls2.join('+')}${bonus ? `+${bonus}` : ''}] = ${total1} + ${total2} = ${total}`
      } else {
        // Modo normal: rolar uma vez
        const rolls = []
        for (let i = 0; i < parseInt(numDice); i++) {
          const roll = Math.floor(Math.random() * parseInt(diceSides)) + 1
          rolls.push(roll)
          total += roll
        }
        if (bonus) total += parseInt(bonus)
        danoBasalText = `Dano Basal: ${danoBasal} = ${rolls.join('+')}${bonus ? `+${bonus}` : ''} = ${total}`
      }

      // Adicionar ataque e bônus elemental
      let finalDamage = total + ataqueBase + bonusElemental

      // Calcular modificadores ativos - apenas do usuário atual
      let modifiersTotal = 0
      const modifierDetails = []
      const currentUserModifiers = userBattleModifiers[currentUser.username] || []
      const currentUserActiveIndexes = userActiveModifiers[currentUser.username] || []

      for (const modIndex of currentUserActiveIndexes) {
        const modifier = currentUserModifiers[modIndex]
        if (!modifier || !modifier.aplicarDano) continue

        const modValue = modifier.mod

        // Usar processCommandExpression para processar comandos @ e expressões
        const processedMod = processCommandExpression(modValue)

        if (processedMod) {
          modifiersTotal += processedMod.finalResult

          // Construir detalhes do modificador
          let detail = `${modifier.nome}: ${modValue}`
          if (processedMod.diceResults.length > 0) {
            const diceDetails = processedMod.diceResults.map(d =>
              `${d.original}=[${d.rolls.join('+')}]=${d.total}`
            ).join(' ')
            detail += ` → ${diceDetails}`
          }
          if (processedMod.substitutions.length > 0) {
            const subDetails = processedMod.substitutions.map(s =>
              `${s.command}=${s.value}`
            ).join(' ')
            detail += ` (${subDetails})`
          }
          detail += ` = ${processedMod.finalResult}`
          modifierDetails.push(detail)
        } else {
          // Fallback: tentar como número simples
          const numValue = parseInt(modValue)
          if (!isNaN(numValue)) {
            modifiersTotal += numValue
            modifierDetails.push(`${modifier.nome}: ${numValue >= 0 ? '+' : ''}${numValue}`)
          }
        }
      }

      finalDamage += modifiersTotal

      // Construir texto de ataque com informação de fase
      let ataqueText = isFisico ? `Ataque Físico: +${ataqueBase}` : `Ataque Especial: +${ataqueBase}`
      if (ataqueStage !== 0) {
        const percentual = Math.round(ataqueMultiplier * 100)
        ataqueText += ` [Fase ${ataqueStage > 0 ? '+' : ''}${ataqueStage} = ${percentual}% de ${ataqueTotalRaw}]`
      }

      const detailsParts = [
        danoBasalText,
        ataqueText,
        bonusElemental > 0 ? `Bônus Elemental (STAB): +${bonusElemental}` : null,
        ...modifierDetails
      ].filter(Boolean).join(' | ')

      addChatMessage({
        username: currentUser.username,
        text: `🎲 ${pokemonName} - Dano de ${moveName}${isCritical ? ' ⚡CRÍTICO⚡' : ''}`,
        timestamp,
        isDiceRoll: true,
        diceResult: finalDamage,
        diceDetails: detailsParts
      })
    }

    setShowBattleMoveModal(false)
  }

  // Função para enviar habilidade no chat
  const handleSendAbilityToChat = (abilityName) => {
    const abilityData = HABILIDADES_DATA[abilityName]
    if (!abilityData) return

    const timestamp = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
    const activePokemon = selectedTeamPokemon || selectedMasterNpcPokemon

    // Usar nome mascarado se o Pokémon NPC não estiver revelado
    const isNpcPokemon = activePokemon?.isNpc || (selectedMasterNpcPokemon && selectedMasterNpcPokemon.id === activePokemon?.id)
    const pokemonName = isNpcPokemon && !revealedNpcPokemon[activePokemon?.id]
      ? (activePokemon?.nomeFalso || activePokemon?.nickname || activePokemon?.nome || activePokemon?.species || '???')
      : (activePokemon?.nickname || activePokemon?.nome || activePokemon?.species || 'Pokémon')

    // Extrair descrição corretamente (pode ser string ou objeto com ativacao/efeito)
    let description = ''
    if (typeof abilityData === 'string') {
      description = abilityData
    } else if (abilityData.descricao) {
      description = abilityData.descricao
    } else if (abilityData.efeito) {
      description = `Ativação: ${abilityData.ativacao || 'N/A'}\n\nEfeito: ${abilityData.efeito}`
    }

    addChatMessage({
      username: currentUser.username,
      text: `📖 ${pokemonName} - Habilidade: ${abilityName}\n\n${description}`,
      timestamp,
      isDiceRoll: false
    })

    setShowBattleAbilityModal(false)
  }

  // Função para rolar teste de acurácia
  const handleRollAccuracy = (moveName, pokemonIdOverride = null) => {
    const moveData = GOLPES_DATA[moveName]
    if (!moveData) return

    const timestamp = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
    const activePokemon = selectedTeamPokemon || selectedMasterNpcPokemon

    // Usar nome mascarado se o Pokémon NPC não estiver revelado
    const isNpcPokemon = activePokemon?.isNpc || (selectedMasterNpcPokemon && selectedMasterNpcPokemon.id === activePokemon?.id)
    const pokemonName = isNpcPokemon && !revealedNpcPokemon[activePokemon?.id]
      ? (activePokemon?.nomeFalso || activePokemon?.nickname || activePokemon?.nome || activePokemon?.species || '???')
      : (activePokemon?.nickname || activePokemon?.nome || activePokemon?.species || 'Pokémon')

    // Verificar se é acerto automático
    if (moveData.acuracia === 'Automático' || moveData.acuracia === 'Automática' || moveData.acuracia === '—' || moveData.acuracia === '-') {
      addChatMessage({
        username: currentUser.username,
        text: `🎯 ${pokemonName} - ${moveName}: Acerto Automático`,
        timestamp,
        isDiceRoll: false
      })
      return
    }

    // Rolar 1d20
    const d20Roll = Math.floor(Math.random() * 20) + 1

    // Calcular modificadores de acurácia ativos
    let modifiersTotal = 0
    const modifierDetails = []
    const currentUserModifiers = userBattleModifiers[currentUser.username] || []
    const currentUserActiveIndexes = userActiveModifiers[currentUser.username] || []

    // Obter fase de precisão do Pokémon ativo
    // Usar pokemonIdOverride se fornecido, senão usar o ID do pokemon ativo
    const pokemonId = pokemonIdOverride || activePokemon?.id || (activePokemon ? `team-${activePokemon.species}` : null)
    const stages = pokemonId ? (pokemonStages[pokemonId] || {}) : {}
    const precisaoStage = stages.precisao || 0

    // Adicionar modificador de precisão (cada ponto de fase = +1 ou -1 na rolagem)
    if (precisaoStage !== 0) {
      modifiersTotal += precisaoStage
      modifierDetails.push(`Fase Precisão: ${precisaoStage >= 0 ? '+' : ''}${precisaoStage}`)
    }

    for (const modIndex of currentUserActiveIndexes) {
      const modifier = currentUserModifiers[modIndex]
      if (!modifier || !modifier.aplicarAcuracia) continue

      const modValue = modifier.mod

      // Usar processCommandExpression para processar comandos @ e expressões
      const processedMod = processCommandExpression(modValue)

      if (processedMod) {
        modifiersTotal += processedMod.finalResult

        // Construir detalhes do modificador
        let detail = `${modifier.nome}: ${modValue}`
        if (processedMod.diceResults.length > 0) {
          const diceDetails = processedMod.diceResults.map(d =>
            `${d.original}=[${d.rolls.join('+')}]=${d.total}`
          ).join(' ')
          detail += ` → ${diceDetails}`
        }
        if (processedMod.substitutions.length > 0) {
          const subDetails = processedMod.substitutions.map(s =>
            `${s.command}=${s.value}`
          ).join(' ')
          detail += ` (${subDetails})`
        }
        detail += ` = ${processedMod.finalResult}`
        modifierDetails.push(detail)
      } else {
        // Fallback: tentar como número simples
        const numValue = parseInt(modValue)
        if (!isNaN(numValue)) {
          modifiersTotal += numValue
          modifierDetails.push(`${modifier.nome}: ${numValue >= 0 ? '+' : ''}${numValue}`)
        }
      }
    }

    // Montar detalhes
    let detailsParts = `1d20 = ${d20Roll}`
    if (modifierDetails.length > 0) {
      detailsParts += ` | Modificadores: ${modifierDetails.join(', ')} = ${modifiersTotal >= 0 ? '+' : ''}${modifiersTotal}`
    }
    detailsParts += ` | Acurácia do Golpe: ${moveData.acuracia}`

    const finalResult = d20Roll + modifiersTotal

    // Mostrar resultado do d20 e a acurácia ao lado
    addChatMessage({
      username: currentUser.username,
      text: `🎯 ${pokemonName} - Teste de Acurácia: ${moveName}`,
      timestamp,
      isDiceRoll: true,
      diceResult: finalResult,
      diceDetails: detailsParts
    })
  }

  // Funções auxiliares para obter modificadores do usuário atual
  const getUserModifiers = () => {
    if (!currentUser) return []
    return userBattleModifiers[currentUser.username] || []
  }

  const getUserActiveModifiers = () => {
    if (!currentUser) return []
    return userActiveModifiers[currentUser.username] || []
  }

  const setUserModifiers = (modifiers) => {
    if (!currentUser) return
    setUserBattleModifiers({
      ...userBattleModifiers,
      [currentUser.username]: modifiers
    })
  }

  const setUserActiveModifiersForUser = (activeIndexes) => {
    if (!currentUser) return
    setUserActiveModifiers({
      ...userActiveModifiers,
      [currentUser.username]: activeIndexes
    })
  }

  // Funções para gerenciar modificadores de batalha
  const handleAddModifier = () => {
    setModifierForm({ nome: '', mod: '', descricao: '', aplicarAcuracia: false, aplicarDano: false, aplicarCaptura: false, usosACadaXLvl: '' })
    setEditingModifierIndex(null)
    setShowModifierModal(true)
  }

  const handleSaveModifier = () => {
    if (!modifierForm.nome || !modifierForm.mod || !currentUser) return

    const currentModifiers = getUserModifiers()

    if (editingModifierIndex !== null) {
      // Editar modificador existente
      const updatedModifiers = [...currentModifiers]
      updatedModifiers[editingModifierIndex] = modifierForm
      setUserModifiers(updatedModifiers)
    } else {
      // Adicionar novo modificador
      setUserModifiers([...currentModifiers, modifierForm])
    }

    setShowModifierModal(false)
    setModifierForm({ nome: '', mod: '', descricao: '', aplicarAcuracia: false, aplicarDano: false, aplicarCaptura: false, usosACadaXLvl: '' })
    setEditingModifierIndex(null)
  }

  const handleEditModifier = (index) => {
    const currentModifiers = getUserModifiers()
    setModifierForm(currentModifiers[index])
    setEditingModifierIndex(index)
    setShowModifierModal(true)
  }

  const handleDeleteModifier = (index) => {
    const currentModifiers = getUserModifiers()
    const currentActive = getUserActiveModifiers()
    setUserModifiers(currentModifiers.filter((_, i) => i !== index))
    setUserActiveModifiersForUser(currentActive.filter(i => i !== index))
  }

  const handleToggleModifier = (index) => {
    const currentActive = getUserActiveModifiers()
    if (currentActive.includes(index)) {
      setUserActiveModifiersForUser(currentActive.filter(i => i !== index))
    } else {
      setUserActiveModifiersForUser([...currentActive, index])
    }
  }

  // Funções para gerenciar talentinhos
  const handleAddTalentinho = () => {
    setTalentinhoForm({ nome: '', expressao: '', alvos: [], usosACadaXLvl: '' })
    setEditingTalentinhoIndex(null)
    setShowTalentinhoModal(true)
  }

  const handleSaveTalentinho = () => {
    if (!talentinhoForm.nome || !talentinhoForm.expressao) return

    // Filtrar alvos vazios antes de salvar (nova estrutura: {operador, valor})
    const talentinhoToSave = {
      ...talentinhoForm,
      alvos: (talentinhoForm.alvos || []).filter(alvo => alvo.valor && alvo.valor.trim() !== '')
    }

    if (editingTalentinhoIndex !== null) {
      // Editar talentinho existente
      const updatedTalentinhos = [...talentinhos]
      updatedTalentinhos[editingTalentinhoIndex] = talentinhoToSave
      setTalentinhos(updatedTalentinhos)
    } else {
      // Adicionar novo talentinho
      setTalentinhos([...talentinhos, talentinhoToSave])
    }

    setShowTalentinhoModal(false)
    setTalentinhoForm({ nome: '', expressao: '', alvos: [], usosACadaXLvl: '' })
    setEditingTalentinhoIndex(null)
  }

  const handleEditTalentinho = (index) => {
    setTalentinhoForm(talentinhos[index])
    setEditingTalentinhoIndex(index)
    setShowTalentinhoModal(true)
  }

  const handleDeleteTalentinho = (index) => {
    setTalentinhos(talentinhos.filter((_, i) => i !== index))
  }

  // Função para calcular o número total de usos baseado no level do treinador
  // Fórmula: 1 (uso base) + floor(level / usosACadaXLvl)
  const calcularUsosTotais = (usosACadaXLvl) => {
    if (!usosACadaXLvl || usosACadaXLvl <= 0) return null // null significa sem limite
    const bonusUsos = Math.floor(level / usosACadaXLvl)
    return 1 + bonusUsos
  }

  // Função para obter usos atuais de um modificador
  const getModifierUsosAtuais = (index) => {
    const modifier = getUserModifiers()[index]
    if (!modifier || !modifier.usosACadaXLvl || modifier.usosACadaXLvl <= 0) return null
    const total = calcularUsosTotais(modifier.usosACadaXLvl)
    // Se não há registro, retorna o total (usos ainda não gastos)
    return modifierUsosAtuais[index] !== undefined ? modifierUsosAtuais[index] : total
  }

  // Função para obter usos atuais de um talentinho
  const getTalentinhoUsosAtuais = (index) => {
    const talentinho = talentinhos[index]
    if (!talentinho || !talentinho.usosACadaXLvl || talentinho.usosACadaXLvl <= 0) return null
    const total = calcularUsosTotais(talentinho.usosACadaXLvl)
    // Se não há registro, retorna o total (usos ainda não gastos)
    return talentinhoUsosAtuais[index] !== undefined ? talentinhoUsosAtuais[index] : total
  }

  // Função para decrementar uso de um modificador
  const decrementarUsoModifier = (index) => {
    const modifier = getUserModifiers()[index]
    if (!modifier || !modifier.usosACadaXLvl || modifier.usosACadaXLvl <= 0) return
    const total = calcularUsosTotais(modifier.usosACadaXLvl)
    const atual = modifierUsosAtuais[index] !== undefined ? modifierUsosAtuais[index] : total
    if (atual > 0) {
      setModifierUsosAtuais({ ...modifierUsosAtuais, [index]: atual - 1 })
    }
  }

  // Função para decrementar uso de um talentinho
  const decrementarUsoTalentinho = (index) => {
    const talentinho = talentinhos[index]
    if (!talentinho || !talentinho.usosACadaXLvl || talentinho.usosACadaXLvl <= 0) return
    const total = calcularUsosTotais(talentinho.usosACadaXLvl)
    const atual = talentinhoUsosAtuais[index] !== undefined ? talentinhoUsosAtuais[index] : total
    if (atual > 0) {
      setTalentinhoUsosAtuais({ ...talentinhoUsosAtuais, [index]: atual - 1 })
    }
  }

  // Função para resetar uso de um modificador específico
  const resetarUsoModifier = (index) => {
    const modifier = getUserModifiers()[index]
    if (!modifier || !modifier.usosACadaXLvl || modifier.usosACadaXLvl <= 0) return
    const total = calcularUsosTotais(modifier.usosACadaXLvl)
    setModifierUsosAtuais({ ...modifierUsosAtuais, [index]: total })
  }

  // Função para resetar uso de um talentinho específico
  const resetarUsoTalentinho = (index) => {
    const talentinho = talentinhos[index]
    if (!talentinho || !talentinho.usosACadaXLvl || talentinho.usosACadaXLvl <= 0) return
    const total = calcularUsosTotais(talentinho.usosACadaXLvl)
    setTalentinhoUsosAtuais({ ...talentinhoUsosAtuais, [index]: total })
  }

  // Função para resetar todos os usos (modificadores, talentinhos e Shiny Charm)
  const resetarTodosOsUsos = () => {
    // Resetar modificadores
    const newModifierUsos = {}
    getUserModifiers().forEach((modifier, index) => {
      if (modifier.usosACadaXLvl && modifier.usosACadaXLvl > 0) {
        newModifierUsos[index] = calcularUsosTotais(modifier.usosACadaXLvl)
      }
    })
    setModifierUsosAtuais(newModifierUsos)

    // Resetar talentinhos
    const newTalentinhoUsos = {}
    talentinhos.forEach((talentinho, index) => {
      if (talentinho.usosACadaXLvl && talentinho.usosACadaXLvl > 0) {
        newTalentinhoUsos[index] = calcularUsosTotais(talentinho.usosACadaXLvl)
      }
    })
    setTalentinhoUsosAtuais(newTalentinhoUsos)

    // Resetar Shiny Charm
    setShinyCharmUsoDiario(true)

    // Resetar limites personalizados
    const newLimitesUsos = {}
    limitesUsoPersonalizados.forEach((limite, index) => {
      newLimitesUsos[index] = calcularUsosTotais(limite.usosACadaXLvl)
    })
    setLimitesUsoPersonalizadosUsosAtuais(newLimitesUsos)
  }

  // Função para usar o Shiny Charm (gasta o uso diário)
  const usarShinyCharm = () => {
    setShinyCharmUsoDiario(false)
  }

  // Funções para limites de uso personalizados
  const adicionarLimiteUsoPersonalizado = () => {
    if (!limiteUsoForm.nome.trim()) {
      alert('Por favor, insira um nome para o limite de uso.')
      return
    }
    if (!limiteUsoForm.usosACadaXLvl || limiteUsoForm.usosACadaXLvl <= 0) {
      alert('Por favor, insira um valor válido para o número de usos.')
      return
    }
    const novoLimite = {
      nome: limiteUsoForm.nome.trim(),
      usosACadaXLvl: parseInt(limiteUsoForm.usosACadaXLvl),
      fontes: { ...limiteUsoForm.fontes }
    }
    const newLimites = [...limitesUsoPersonalizados, novoLimite]
    setLimitesUsoPersonalizados(newLimites)
    // Inicializar usos atuais com o total
    const total = calcularUsosTotais(novoLimite.usosACadaXLvl)
    setLimitesUsoPersonalizadosUsosAtuais(prev => ({
      ...prev,
      [newLimites.length - 1]: total
    }))
    setLimiteUsoForm({ nome: '', usosACadaXLvl: '', fontes: { talento: false, item: false, outros: false } })
    setShowAddLimiteUsoModal(false)
  }

  const decrementarUsoLimitePersonalizado = (index) => {
    const limite = limitesUsoPersonalizados[index]
    if (!limite) return
    const total = calcularUsosTotais(limite.usosACadaXLvl)
    const atual = limitesUsoPersonalizadosUsosAtuais[index] !== undefined ? limitesUsoPersonalizadosUsosAtuais[index] : total
    if (atual > 0) {
      setLimitesUsoPersonalizadosUsosAtuais(prev => ({
        ...prev,
        [index]: atual - 1
      }))
    }
  }

  const resetarUsoLimitePersonalizado = (index) => {
    const limite = limitesUsoPersonalizados[index]
    if (!limite) return
    const total = calcularUsosTotais(limite.usosACadaXLvl)
    setLimitesUsoPersonalizadosUsosAtuais(prev => ({
      ...prev,
      [index]: total
    }))
  }

  const removerLimiteUsoPersonalizado = (index) => {
    const newLimites = limitesUsoPersonalizados.filter((_, i) => i !== index)
    setLimitesUsoPersonalizados(newLimites)
    // Reindexar os usos atuais
    const newUsosAtuais = {}
    newLimites.forEach((_, i) => {
      if (i < index) {
        newUsosAtuais[i] = limitesUsoPersonalizadosUsosAtuais[i]
      } else {
        newUsosAtuais[i] = limitesUsoPersonalizadosUsosAtuais[i + 1]
      }
    })
    setLimitesUsoPersonalizadosUsosAtuais(newUsosAtuais)
  }

  // Função para obter todos os itens com limite de uso
  const getItensComLimiteDeUso = () => {
    const itens = []

    // Adicionar modificadores com limite de uso
    getUserModifiers().forEach((modifier, index) => {
      if (modifier.usosACadaXLvl && modifier.usosACadaXLvl > 0) {
        const total = calcularUsosTotais(modifier.usosACadaXLvl)
        const atual = modifierUsosAtuais[index] !== undefined ? modifierUsosAtuais[index] : total
        itens.push({
          tipo: 'modificador',
          nome: modifier.nome,
          index,
          atual,
          total,
          decrementar: () => decrementarUsoModifier(index),
          resetar: () => resetarUsoModifier(index)
        })
      }
    })

    // Adicionar talentinhos com limite de uso
    talentinhos.forEach((talentinho, index) => {
      if (talentinho.usosACadaXLvl && talentinho.usosACadaXLvl > 0) {
        const total = calcularUsosTotais(talentinho.usosACadaXLvl)
        const atual = talentinhoUsosAtuais[index] !== undefined ? talentinhoUsosAtuais[index] : total
        itens.push({
          tipo: 'talentinho',
          nome: talentinho.nome,
          index,
          atual,
          total,
          decrementar: () => decrementarUsoTalentinho(index),
          resetar: () => resetarUsoTalentinho(index)
        })
      }
    })

    // Adicionar Shiny Charm se o usuário tiver
    const hasShinyCharm = keyItems.some(item => item.name === 'Shiny Charm')
    if (hasShinyCharm) {
      itens.push({
        tipo: 'shinyCharm',
        nome: 'Shiny Charm',
        index: -1,
        atual: shinyCharmUsoDiario ? 1 : 0,
        total: 1,
        decrementar: usarShinyCharm,
        resetar: () => setShinyCharmUsoDiario(true)
      })
    }

    // Adicionar limites de uso personalizados
    limitesUsoPersonalizados.forEach((limite, index) => {
      const total = calcularUsosTotais(limite.usosACadaXLvl)
      const atual = limitesUsoPersonalizadosUsosAtuais[index] !== undefined ? limitesUsoPersonalizadosUsosAtuais[index] : total
      // Determinar o tipo baseado nas fontes selecionadas
      let tipo = 'personalizado'
      if (limite.fontes.talento && !limite.fontes.item && !limite.fontes.outros) tipo = 'talentinho'
      else if (limite.fontes.item && !limite.fontes.talento && !limite.fontes.outros) tipo = 'shinyCharm'
      itens.push({
        tipo,
        nome: limite.nome,
        index,
        atual,
        total,
        decrementar: () => decrementarUsoLimitePersonalizado(index),
        resetar: () => resetarUsoLimitePersonalizado(index),
        isPersonalizado: true,
        fontes: limite.fontes
      })
    })

    return itens
  }

  const handleRollTalentinho = (talentinho) => {
    const result = processCommandExpression(talentinho.expressao)

    if (!result) {
      alert('Expressão inválida!')
      return
    }

    const timestamp = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })

    // Montar mensagem com detalhes da rolagem
    let messageText = `🎲 ${talentinho.nome}\n`

    if (result.substitutions && result.substitutions.length > 0) {
      const subs = result.substitutions.map(s => `${s.command} = ${s.value}`).join(', ')
      messageText += `${subs}\n`
    }

    if (result.diceResults && result.diceResults.length > 0) {
      const rolls = result.diceResults.map(r => `${r.original}: [${r.rolls.join(', ')}] = ${r.total}`).join(', ')
      messageText += `${rolls}\n`
    }

    messageText += `Total: ${result.finalResult}`

    // Processar alvos se existirem (nova estrutura: {operador, valor})
    if (talentinho.alvos && talentinho.alvos.length > 0) {
      messageText += `\n\n📍 Alvos:`
      talentinho.alvos.forEach((alvo, idx) => {
        // Suportar tanto a nova estrutura {operador, valor} quanto a antiga (string)
        let alvoExpr, operador
        if (typeof alvo === 'object' && alvo.valor) {
          alvoExpr = alvo.valor
          operador = alvo.operador || '>='
        } else {
          // Compatibilidade com formato antigo (string)
          alvoExpr = alvo
          operador = '>='
        }

        const alvoResult = processCommandExpression(alvoExpr)
        if (alvoResult) {
          const rolagem = result.finalResult
          const alvoValor = alvoResult.finalResult

          // Avaliar sucesso/falha baseado no operador
          let sucesso = false
          let operadorTexto = ''
          switch (operador) {
            case '>=':
              sucesso = rolagem >= alvoValor
              operadorTexto = 'maior ou igual a'
              break
            case '<=':
              sucesso = rolagem <= alvoValor
              operadorTexto = 'menor ou igual a'
              break
            case '>':
              sucesso = rolagem > alvoValor
              operadorTexto = 'maior que'
              break
            case '<':
              sucesso = rolagem < alvoValor
              operadorTexto = 'menor que'
              break
            case '==':
              sucesso = rolagem === alvoValor
              operadorTexto = 'igual a'
              break
            default:
              sucesso = rolagem >= alvoValor
              operadorTexto = 'maior ou igual a'
          }

          const comparison = sucesso ? '✅ SUCESSO' : '❌ FALHA'
          messageText += `\nAlvo ${idx + 1}: ${operadorTexto} ${alvoValor} - ${comparison}`
        } else {
          messageText += `\nAlvo ${idx + 1}: Expressão inválida`
        }
      })
    }

    addChatMessage({
      username: currentUser.username,
      text: messageText,
      timestamp,
      isDiceRoll: true,
      diceResult: messageText
    })
  }

  // Função para abrir modal de captura
  const handleOpenCaptureModal = (pokeballName) => {
    setSelectedPokeball(pokeballName)
    const modifiers = POKEBALL_MODIFIERS[pokeballName]

    if (modifiers === 'custom') {
      setCustomPokeballModifier('')
      setSelectedPokeballModifier('')
    } else if (modifiers && modifiers.length > 0) {
      setSelectedPokeballModifier(modifiers[0])
    }

    setShowCaptureModal(true)
  }

  // Função para lançar pokébola
  const handleThrowPokeball = () => {
    if (!selectedPokeball) return

    // Customball não precisa estar nos keyItems
    if (selectedPokeball !== 'Customball') {
      const pokeballKey = keyItems.find(item => item.name === selectedPokeball)
      if (!pokeballKey || pokeballKey.quantity <= 0) return

      // Diminuir quantidade da pokébola e remover se chegar a 0
      const updatedKeyItems = keyItems
        .map(item =>
          item.name === selectedPokeball
            ? { ...item, quantity: item.quantity - 1 }
            : item
        )
        .filter(item => item.quantity === undefined || item.quantity > 0) // Remove itens com quantidade 0, mas mantém itens sem quantidade (como Shiny Charm)
      setKeyItems(updatedKeyItems)
    }

    const timestamp = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })

    // Verificar se é Masterball (captura automática)
    if (selectedPokeballModifier === 'auto') {
      addChatMessage({
        username: currentUser.username,
        text: `🎯 Lançou ${selectedPokeball}!\n⚡ CAPTURA AUTOMÁTICA! ⚡`,
        timestamp,
        isDiceRoll: true,
        diceResult: 'AUTO'
      })
      setShowCaptureModal(false)
      return
    }

    // Obter modificador (custom ou selecionado)
    let modifier = selectedPokeball === 'Customball' ? customPokeballModifier : selectedPokeballModifier

    // Processar comandos @ no modificador
    const processedModifier = processCommandExpression(modifier)
    let modifierValue = 0
    let modifierDetails = ''

    if (processedModifier) {
      modifierValue = processedModifier.finalResult
      if (processedModifier.substitutions.length > 0) {
        modifierDetails = ` (${processedModifier.substitutions.map(s => `${s.command}=${s.value}`).join(' ')})`
      }
    } else {
      modifierValue = parseInt(modifier) || 0
    }

    // Aplicar modificadores de batalha ativos com aplicarCaptura
    let battleModifiersTotal = 0
    const battleModifierDetails = []
    const currentUserModifiers = userBattleModifiers[currentUser.username] || []
    const currentUserActiveIndexes = userActiveModifiers[currentUser.username] || []

    for (const modIndex of currentUserActiveIndexes) {
      const battleModifier = currentUserModifiers[modIndex]
      if (!battleModifier || !battleModifier.aplicarCaptura) continue

      const processedBattleMod = processCommandExpression(battleModifier.mod)
      if (processedBattleMod) {
        battleModifiersTotal += processedBattleMod.finalResult
        battleModifierDetails.push(`${battleModifier.nome}=${processedBattleMod.finalResult}`)
      } else {
        const numValue = parseInt(battleModifier.mod) || 0
        battleModifiersTotal += numValue
        battleModifierDetails.push(`${battleModifier.nome}=${numValue}`)
      }
    }

    // Rolar 1d100
    const d100Roll = Math.floor(Math.random() * 100) + 1

    // Calcular resultado final (modificadores de captura são SUBTRAÍDOS)
    const finalResult = d100Roll + modifierValue - battleModifiersTotal

    // Construir mensagem
    let message = `🎯 Lançou ${selectedPokeball}!\n1d100 = ${d100Roll}`
    message += ` | Mod: ${modifier}${modifierDetails} = ${modifierValue}`
    if (battleModifierDetails.length > 0) {
      message += ` | Captura: -${battleModifierDetails.join(', -')} = -${battleModifiersTotal}`
    }
    message += `\n\nTotal: ${finalResult}`

    addChatMessage({
      username: currentUser.username,
      text: message,
      timestamp,
      isDiceRoll: true,
      diceResult: finalResult
    })

    setShowCaptureModal(false)
  }

  // Funções para gerenciar fases de batalha
  const getStageMultiplier = (stage) => {
    const multipliers = {
      '-6': 0.40,
      '-5': 0.50,
      '-4': 0.60,
      '-3': 0.70,
      '-2': 0.80,
      '-1': 0.90,
      '0': 1.00,
      '1': 1.25,
      '2': 1.50,
      '3': 1.75,
      '4': 2.00,
      '5': 2.25,
      '6': 2.50
    }
    return multipliers[stage.toString()] || 1.00
  }

  // Função para calcular evasões com fases aplicadas
  // isTrainer: se true, usa velocidade/5 para evasão veloz; se false (Pokémon), usa velocidade/10
  const calcularEvasoes = (baseDefesa, baseDefesaEspecial, baseVelocidade, stages, isTrainer = false) => {
    const defesaMultiplier = getStageMultiplier(stages?.defesa || 0)
    const defesaEspecialMultiplier = getStageMultiplier(stages?.defesaEspecial || 0)
    const velocidadeMultiplier = getStageMultiplier(stages?.velocidade || 0)

    const defesaAdjusted = Math.floor(baseDefesa * defesaMultiplier)
    const defesaEspecialAdjusted = Math.floor(baseDefesaEspecial * defesaEspecialMultiplier)
    const velocidadeAdjusted = Math.floor(baseVelocidade * velocidadeMultiplier)

    return {
      evasaoFisica: Math.floor(defesaAdjusted / 5),
      evasaoEspecial: Math.floor(defesaEspecialAdjusted / 5),
      evasaoVeloz: Math.floor(velocidadeAdjusted / (isTrainer ? 5 : 10))
    }
  }

  // Função para calcular a estatística Contagem (para Colecionador)
  // Contagem = MV + Grupos de 8 (com pontuação: shiny=8, lendário=8, normal=1)
  const calcularContagem = () => {
    const MV = getModifier(attributes.velocidade)

    // Combinar todos os pokémons capturados (time + PC)
    const todosPokemon = [...mainTeam, ...pcPokemon]

    // Calcular pontos totais: cada shiny=8, cada lendário=8, cada normal=1
    let pontosTotais = 0
    todosPokemon.forEach(pokemon => {
      if (pokemon.shiny) {
        pontosTotais += 8
      }
      if (pokemon.legendary) {
        pontosTotais += 8
      }
      // Se não for shiny nem lendário, conta como 1
      if (!pokemon.shiny && !pokemon.legendary) {
        pontosTotais += 1
      }
    })

    // Calcular grupos de 8
    const gruposDe8 = Math.floor(pontosTotais / 8)

    return MV + gruposDe8
  }

  // Função para processar expressões com comandos @
  const processCommandExpression = (expression) => {
    if (!expression || typeof expression !== 'string') return null

    // Remove espaços para facilitar o processamento
    expression = expression.trim()

    // Obter modificadores e atributos do treinador
    const MA = getModifier(attributes.ataque)
    const MD = getModifier(attributes.defesa)
    const MAE = getModifier(attributes.ataqueEspecial)
    const MDE = getModifier(attributes.defesaEspecial)
    const MV = getModifier(attributes.velocidade)
    const MS = getModifier(attributes.saude)

    const At = attributes.ataque
    const Dt = attributes.defesa
    const AEt = attributes.ataqueEspecial
    const DEt = attributes.defesaEspecial
    const Vt = attributes.velocidade
    const St = attributes.saude

    // Calcular Contagem para o comando @Cont
    const Cont = calcularContagem()

    // Mapa de comandos
    const commandMap = {
      '@MA': MA,
      '@MD': MD,
      '@MAE': MAE,
      '@MDE': MDE,
      '@MV': MV,
      '@MS': MS,
      '@At': At,
      '@Dt': Dt,
      '@AEt': AEt,
      '@DEt': DEt,
      '@Vt': Vt,
      '@St': St,
      '@Cont': Cont
    }

    let processedExpression = expression
    let substitutions = []

    // PRIMEIRO: Processar sintaxe @COMMANDOdY (comando como quantidade de dados)
    // Precisa processar TODOS os comandos possíveis, em ordem de tamanho decrescente
    // para evitar que @MA seja processado antes de @MAE
    const sortedCommands = Object.keys(commandMap).sort((a, b) => b.length - a.length)

    sortedCommands.forEach(command => {
      // Buscar padrão @COMMANDOdNUM (ex: @MAEd6, @MDd8)
      const regex = new RegExp(command.replace('@', '\\@') + 'd(\\d+)', 'gi')
      let match
      while ((match = regex.exec(processedExpression)) !== null) {
        const sides = match[1]
        const value = commandMap[command]
        if (value !== undefined) {
          const numDice = Math.max(1, Math.abs(value)) // Garantir que seja positivo e mínimo 1
          const original = `${command}d${sides}`
          const replacement = `${numDice}d${sides}`
          processedExpression = processedExpression.replace(original, replacement)
          substitutions.push({ command: original, value: replacement })
        }
      }
    })

    // SEGUNDO: Substituir comandos @ simples pelos valores (que não foram usados como XdY)
    sortedCommands.forEach(command => {
      const regex = new RegExp(command.replace('@', '\\@') + '(?!d)', 'g')
      if (processedExpression.match(regex)) {
        const value = commandMap[command]
        substitutions.push({ command, value })
        processedExpression = processedExpression.replace(regex, value)
      }
    })

    // TERCEIRO: Encontrar expressões de dados (XdY) na expressão JÁ PROCESSADA
    const diceRegex = /(\d+)d(\d+)/gi
    const diceMatches = [...processedExpression.matchAll(diceRegex)]

    let results = []
    let processedForDice = processedExpression

    diceMatches.forEach(match => {
      const numDice = parseInt(match[1])
      const sides = parseInt(match[2])
      const rolls = []
      let total = 0

      for (let i = 0; i < numDice; i++) {
        const roll = Math.floor(Math.random() * sides) + 1
        rolls.push(roll)
        total += roll
      }

      results.push({
        original: match[0],
        numDice,
        sides,
        rolls,
        total
      })

      // Substituir XdY pelo total na expressão
      processedForDice = processedForDice.replace(match[0], total)
    })

    // Calcular o resultado final usando parser seguro (sem eval)
    let finalResult
    try {
      const cleanExpression = processedForDice.replace(/\s/g, '')
      finalResult = safeMathEval(cleanExpression)
      if (typeof finalResult === 'number' && !Number.isInteger(finalResult)) {
        finalResult = Math.round(finalResult * 100) / 100
      }
    } catch (e) {
      console.error('Erro ao avaliar expressão:', e, 'Expressão processada:', processedForDice)
      return null
    }

    return {
      original: expression,
      processed: processedExpression,
      substitutions,
      diceResults: results,
      finalResult
    }
  }

  const adjustTrainerStage = (trainerId, attribute, delta) => {
    const current = trainerStages[trainerId] || {
      ataque: 0,
      ataqueEspecial: 0,
      defesa: 0,
      defesaEspecial: 0,
      velocidade: 0,
      precisao: 0
    }
    const newValue = Math.max(-6, Math.min(6, (current[attribute] || 0) + delta))

    const newTrainerStages = {
      ...trainerStages,
      [trainerId]: { ...current, [attribute]: newValue }
    }

    setTrainerStages(newTrainerStages)

    // Salvar APENAS os stages no Firebase (path separado para sincronização em tempo real)
    if (useFirebase) {
      console.log('[DEBUG] Salvando trainerStages:', newTrainerStages)
      saveTrainerStages(newTrainerStages)
    }
  }

  const adjustPokemonStage = (pokemonId, attribute, delta) => {
    const current = pokemonStages[pokemonId] || {
      ataque: 0,
      ataqueEspecial: 0,
      defesa: 0,
      defesaEspecial: 0,
      velocidade: 0,
      precisao: 0
    }

    const newValue = Math.max(-6, Math.min(6, (current[attribute] || 0) + delta))

    const newPokemonStages = {
      ...pokemonStages,
      [pokemonId]: {
        ...current,
        [attribute]: newValue
      }
    }

    setPokemonStages(newPokemonStages)

    // Salvar APENAS os stages no Firebase (path separado para sincronização em tempo real)
    if (useFirebase) {
      console.log('[DEBUG] Salvando pokemonStages:', newPokemonStages)
      savePokemonStages(newPokemonStages)
    }
  }

  const handleShowModifierDetails = (modifier) => {
    setSelectedModifier(modifier)
    setShowModifierDetailsModal(true)
  }

  // Handlers para Account Data
  const handleDownloadAccountData = async () => {
    if (!currentUser) return

    let accountData = null

    try {
      if (currentUser.type === 'treinador') {
        const trainerData = useFirebase
          ? await loadTrainerData(currentUser.username)
          : JSON.parse(localStorage.getItem(`trainer_${currentUser.username}`) || 'null')

        if (trainerData) {
          const exotics = useFirebase
            ? await loadGlobalExoticSpecies()
            : JSON.parse(localStorage.getItem('globalExoticSpecies') || '[]')

          const combinedData = {
            ...trainerData,
            globalExoticSpecies: exotics || []
          }
          accountData = JSON.stringify(combinedData)
        }
      } else if (currentUser.type === 'mestre') {
        const mestreConfig = useFirebase
          ? await loadMestreConfig()
          : JSON.parse(localStorage.getItem('mestre_config') || 'null')

        const npcTrainersData = useFirebase
          ? await loadNpcTrainers(currentUser.username)
          : JSON.parse(localStorage.getItem(`npcTrainers_${currentUser.username}`) || '[]')

        const exotics = useFirebase
          ? await loadGlobalExoticSpecies()
          : JSON.parse(localStorage.getItem('globalExoticSpecies') || '[]')

        if (mestreConfig || npcTrainersData.length > 0 || exotics.length > 0) {
          const combinedData = {
            mestreConfig: mestreConfig || {},
            npcTrainers: npcTrainersData || [],
            globalExoticSpecies: exotics || []
          }
          accountData = JSON.stringify(combinedData)
        }
      }

      if (!accountData) {
        alert('Nenhum dado encontrado para download.')
        return
      }

      const blob = new Blob([accountData], { type: 'application/json' })
      const url = URL.createObjectURL(blob)
      const a = document.createElement('a')
      a.href = url
      a.download = `${currentUser.username}_backup.json`
      document.body.appendChild(a)
      a.click()
      document.body.removeChild(a)
      URL.revokeObjectURL(url)

      setShowAccountDataModal(false)
    } catch (error) {
      console.error('Erro ao baixar dados:', error)
      alert('Erro ao baixar dados da conta.')
    }
  }

  const handleUploadAccountData = (e) => {
    const file = e.target.files[0]
    if (!file || !currentUser) return

    const reader = new FileReader()
    reader.onload = async (event) => {
      try {
        const data = JSON.parse(event.target.result)

        // Restaurar globalExoticSpecies se existir nos dados
        if (data.globalExoticSpecies) {
          if (useFirebase) {
            await saveGlobalExoticSpecies(data.globalExoticSpecies)
          } else {
            localStorage.setItem('globalExoticSpecies', JSON.stringify(data.globalExoticSpecies))
          }
        }

        if (currentUser.type === 'treinador') {
          // Remover globalExoticSpecies antes de salvar dados do treinador
          const { globalExoticSpecies: exotics, ...trainerData } = data

          // Migrar XP dos Pokémon no time principal
          if (trainerData.mainTeam) {
            trainerData.mainTeam = trainerData.mainTeam.map(migratePokemonXP)
          }

          // Migrar XP dos Pokémon no PC
          if (trainerData.pcPokemon) {
            trainerData.pcPokemon = trainerData.pcPokemon.map(migratePokemonXP)
          }

          if (useFirebase) {
            await saveTrainerData(currentUser.username, trainerData)
          } else {
            localStorage.setItem(`trainer_${currentUser.username}`, JSON.stringify(trainerData))
          }
        } else if (currentUser.type === 'mestre') {
          // Para mestre, restaurar dados separados
          if (data.mestreConfig) {
            if (useFirebase) {
              await saveMestreConfig(data.mestreConfig)
            } else {
              localStorage.setItem('mestre_config', JSON.stringify(data.mestreConfig))
            }
          }
          if (data.npcTrainers) {
            // Migrar XP dos Pokémon dos NPCs
            const migratedNPCs = data.npcTrainers.map(npc => {
              if (npc.team) {
                npc.team = npc.team.map(migratePokemonXP)
              }
              return npc
            })
            if (useFirebase) {
              await saveNpcTrainers(currentUser.username, migratedNPCs)
            } else {
              localStorage.setItem(`npcTrainers_${currentUser.username}`, JSON.stringify(migratedNPCs))
            }
          }
        }

        alert('Dados restaurados com sucesso! XP dos Pokémon foi atualizado para o novo sistema. A página será recarregada.')
        window.location.reload()
      } catch (error) {
        console.error('Erro ao restaurar dados:', error)
        alert('Erro ao processar o arquivo. Certifique-se de que é um backup válido.')
      }
    }
    reader.readAsText(file)

    setShowAccountDataModal(false)
  }

  // Handlers para Treinador NPC
  const handleSaveCustomTrainer = () => {
    if (!customTrainerForm.name.trim()) {
      alert('Por favor, insira um nome para o treinador.')
      return
    }

    const modifiers = {
      saude: calculateModifier(customTrainerForm.attributes.saude),
      ataque: calculateModifier(customTrainerForm.attributes.ataque),
      defesa: calculateModifier(customTrainerForm.attributes.defesa),
      ataqueEspecial: calculateModifier(customTrainerForm.attributes.ataqueEspecial),
      defesaEspecial: calculateModifier(customTrainerForm.attributes.defesaEspecial),
      velocidade: calculateModifier(customTrainerForm.attributes.velocidade)
    }

    // Gerar características e talentos se classes foram selecionadas
    let caracteristicasETalentos = []
    if (customTrainerForm.classes.length > 0) {
      if (customTrainerForm.talentosMode === 'aleatorio') {
        caracteristicasETalentos = generateRandomTalentos(customTrainerForm.level, customTrainerForm.classes)
      } else {
        // Modo manual - adicionar características automáticas + talentos selecionados
        customTrainerForm.classes.forEach(className => {
          const caracteristicas = getClassCaracteristicas(className)
          caracteristicas.forEach(carac => {
            caracteristicasETalentos.push({ tipo: 'caracteristica', ...carac })
          })
        })
        caracteristicasETalentos.push(...customTrainerForm.selectedTalentos)
      }
    }

    const newTrainer = {
      id: Date.now(),
      name: customTrainerForm.name,
      level: customTrainerForm.level,
      attributes: customTrainerForm.attributes,
      modifiers: modifiers,
      hp: calculateNPCHP(customTrainerForm.level, customTrainerForm.attributes.saude),
      currentHP: calculateNPCHP(customTrainerForm.level, customTrainerForm.attributes.saude),
      displacement: calculateDisplacement(customTrainerForm.attributes),
      evasion: calculateEvasion(customTrainerForm.attributes),
      classes: customTrainerForm.classes,
      caracteristicasETalentos: caracteristicasETalentos,
      isRandom: false,
      imageUrl: customTrainerForm.imageUrl || ''
    }

    setNpcTrainers([...npcTrainers, newTrainer])
    setShowCustomTrainerModal(false)
    setCustomTrainerForm({
      name: '',
      level: 1,
      attributes: {
        saude: 6,
        ataque: 6,
        defesa: 6,
        ataqueEspecial: 6,
        defesaEspecial: 6,
        velocidade: 6
      },
      classes: [],
      talentosMode: 'aleatorio',
      selectedTalentos: [],
      imageUrl: ''
    })
  }

  const handleSaveRandomTrainer = () => {
    if (!randomTrainerForm.name.trim()) {
      alert('Por favor, insira um nome para o treinador.')
      return
    }

    const randomAttributes = distributeRandomAttributes(randomTrainerForm.level)

    const modifiers = {
      saude: calculateModifier(randomAttributes.saude),
      ataque: calculateModifier(randomAttributes.ataque),
      defesa: calculateModifier(randomAttributes.defesa),
      ataqueEspecial: calculateModifier(randomAttributes.ataqueEspecial),
      defesaEspecial: calculateModifier(randomAttributes.defesaEspecial),
      velocidade: calculateModifier(randomAttributes.velocidade)
    }

    // Gerar classes/subclasses aleatórias
    const randomClasses = generateRandomClasses(randomTrainerForm.level)

    // Gerar características e talentos
    const randomTalentos = generateRandomTalentos(randomTrainerForm.level, randomClasses)

    const newTrainer = {
      id: Date.now(),
      name: randomTrainerForm.name,
      level: randomTrainerForm.level,
      attributes: randomAttributes,
      modifiers: modifiers,
      hp: calculateNPCHP(randomTrainerForm.level, randomAttributes.saude),
      currentHP: calculateNPCHP(randomTrainerForm.level, randomAttributes.saude),
      displacement: calculateDisplacement(randomAttributes),
      evasion: calculateEvasion(randomAttributes),
      classes: randomClasses,
      caracteristicasETalentos: randomTalentos,
      isRandom: true,
      imageUrl: randomTrainerForm.imageUrl || ''
    }

    setNpcTrainers([...npcTrainers, newTrainer])
    setShowRandomTrainerModal(false)
    setRandomTrainerForm({
      name: '',
      level: 1,
      imageUrl: ''
    })
  }

  const handleDeleteNPC = (npcId) => {
    setNpcTrainers(npcTrainers.filter(npc => npc.id !== npcId))
  }

  // Função para arquivar Treinador NPC
  const archiveNpcTrainer = (npc) => {
    setArchivedNpcTrainers(prev => [...prev, { ...npc, archivedAt: new Date().toISOString() }])
    setNpcTrainers(prev => prev.filter(t => t.id !== npc.id))
  }

  // Função para desarquivar Treinador NPC (restaurar para área Treinador NPC)
  const unarchiveNpcTrainer = (npc) => {
    const { archivedAt, ...trainerWithoutArchiveDate } = npc
    setNpcTrainers(prev => [...prev, trainerWithoutArchiveDate])
    setArchivedNpcTrainers(prev => prev.filter(t => t.id !== npc.id))
  }

  // Função para remover Treinador NPC arquivado
  const removeArchivedNpcTrainer = (npcId) => {
    setArchivedNpcTrainers(prev => prev.filter(t => t.id !== npcId))
  }

  // Handlers para Tutoria de Golpes
  const handleOpenTutoria = (pokemon, type) => {
    setSelectedPokemonForTutoria(pokemon)
    setSelectedPokemonTypeForTutoria(type)
    // Extrair nomes dos golpes, tratando tanto formato antigo (string) quanto novo (objeto)
    const golpesNomes = (pokemon.golpes || [])
      .filter(g => g !== null)
      .map(g => typeof g === 'string' ? g : g?.nome)
      .filter(g => g)
    setTutoriaSelectedGolpes(golpesNomes)
    setTutoriaGolpesSearch('')
    setShowTutoriaModal(true)
  }

  const handleAddGolpeToSelected = (golpe) => {
    if (tutoriaSelectedGolpes.length >= 8) {
      alert('Máximo de 8 golpes atingido!')
      return
    }
    if (!tutoriaSelectedGolpes.includes(golpe)) {
      setTutoriaSelectedGolpes([...tutoriaSelectedGolpes, golpe])
    }
  }

  const handleRemoveGolpeFromSelected = (golpe) => {
    setTutoriaSelectedGolpes(tutoriaSelectedGolpes.filter(g => g !== golpe))
  }

  const handleSaveGolpes = () => {
    if (tutoriaSelectedGolpes.length < 1) {
      alert('Selecione pelo menos 1 golpe!')
      return
    }

    // Converter strings de golpes para objetos {nome, usos} e preencher até 8 slots
    const golpesArray = []
    for (let i = 0; i < 8; i++) {
      if (i < tutoriaSelectedGolpes.length) {
        golpesArray.push({
          nome: tutoriaSelectedGolpes[i],
          usos: null
        })
      } else {
        golpesArray.push(null)
      }
    }

    const updatedPokemon = { ...selectedPokemonForTutoria, golpes: golpesArray }

    if (selectedPokemonTypeForTutoria === 'team') {
      setMainTeam(mainTeam.map(p => p.id === selectedPokemonForTutoria.id ? updatedPokemon : p))
    } else {
      setPcPokemon(pcPokemon.map(p => p.id === selectedPokemonForTutoria.id ? updatedPokemon : p))
    }

    setShowTutoriaModal(false)
    setSelectedPokemonForTutoria(null)
    setSelectedPokemonTypeForTutoria(null)
    setTutoriaSelectedGolpes([])
  }

  const handleOpenGolpeDetail = (golpe) => {
    setSelectedGolpeForDetail(golpe)
    setShowGolpeDetailModal(true)
  }

  const handleOpenPCGolpes = (pokemon) => {
    setSelectedPokemonForPCGolpes(pokemon)
    setExpandedGolpeInPC(null)
    setShowPCGolpesModal(true)
  }

  // Funções de Habilidades
  const handleOpenHabilidades = (pokemon, type) => {
    // Verificar se os dados estão disponíveis
    if (!HABILIDADES_DATA || !HABILIDADES_NAMES || HABILIDADES_NAMES.length === 0) {
      alert('Dados de habilidades não disponíveis. Por favor, recarregue a página.')
      return
    }
    setSelectedPokemonForHabilidades(pokemon)
    setSelectedPokemonTypeForHabilidades(type)
    setHabilidadesSelectedList(pokemon.habilidades || [])
    setHabilidadesSearch('')
    setShowHabilidadesModal(true)
  }

  const handleOpenHabilidadesPC = (pokemon, type) => {
    // Verificar se os dados estão disponíveis
    if (!HABILIDADES_DATA || !HABILIDADES_NAMES || HABILIDADES_NAMES.length === 0) {
      alert('Dados de habilidades não disponíveis. Por favor, recarregue a página.')
      return
    }
    setSelectedPokemonForHabilidades(pokemon)
    setSelectedPokemonTypeForHabilidades(type)
    setHabilidadesSelectedList(pokemon.habilidades || [])
    setHabilidadesSearch('')
    setShowHabilidadesPCModal(true)
  }

  const handleAddHabilidadeToSelected = (habilidade) => {
    try {
      if (habilidadesSelectedList.length >= 2) {
        alert('Máximo de 2 habilidades atingido!')
        return
      }
      if (!habilidadesSelectedList.includes(habilidade)) {
        setHabilidadesSelectedList([...habilidadesSelectedList, habilidade])
      }
    } catch (error) {
      console.error('Erro ao adicionar habilidade:', error)
      alert('Erro ao adicionar habilidade. Por favor, tente novamente.')
    }
  }

  const handleRemoveHabilidadeFromSelected = (habilidade) => {
    try {
      setHabilidadesSelectedList(habilidadesSelectedList.filter(h => h !== habilidade))
    } catch (error) {
      console.error('Erro ao remover habilidade:', error)
      alert('Erro ao remover habilidade. Por favor, tente novamente.')
    }
  }

  const handleSaveHabilidades = () => {
    try {
      if (habilidadesSelectedList.length < 1) {
        alert('Selecione pelo menos 1 habilidade!')
        return
      }

      const updatedPokemon = { ...selectedPokemonForHabilidades, habilidades: habilidadesSelectedList }

      if (selectedPokemonTypeForHabilidades === 'team') {
        setMainTeam(mainTeam.map(p => p.id === selectedPokemonForHabilidades.id ? updatedPokemon : p))
      } else {
        setPcPokemon(pcPokemon.map(p => p.id === selectedPokemonForHabilidades.id ? updatedPokemon : p))
      }

      setShowHabilidadesModal(false)
      setShowHabilidadesPCModal(false)
      setSelectedPokemonForHabilidades(null)
      setSelectedPokemonTypeForHabilidades(null)
      setHabilidadesSelectedList([])
    } catch (error) {
      console.error('Erro ao salvar habilidades:', error)
      alert('Erro ao salvar habilidades. Por favor, tente novamente.')
      setShowHabilidadesModal(false)
      setShowHabilidadesPCModal(false)
    }
  }

  // Funções para sistema de Pokébolas
  const handleOpenPokeballModal = (pokemon, type) => {
    setSelectedPokemonForPokeball(pokemon)
    setSelectedPokemonTypeForPokeball(type)
    setSelectedPokeballForPC(pokemon.pokeball || '')
    setPokeballSearch('')
    setShowPokeballModal(true)
  }

  const handleOpenPokeballPC = (pokemon, type) => {
    setSelectedPokemonForPokeball(pokemon)
    setSelectedPokemonTypeForPokeball(type)
    setSelectedPokeballForPC(pokemon.pokeball || '')
    setPokeballSearch('')
    setShowPokeballPCModal(true)
  }

  // Handlers para Custom Pokeball (Time Principal)
  const handleSelectPokeball = (pokeball) => {
    if (pokeball === 'Custom Pokeball') {
      setShowCustomPokeballOptions(true)
    } else {
      setSelectedPokeballForPC(pokeball)
    }
  }

  const handleConfirmCustomPokeball = () => {
    if (customPokeballUploadType === 'link' && !customPokeballLink.trim()) {
      alert('Por favor, insira um link válido para a imagem da pokébola!')
      return
    }
    if (customPokeballUploadType === 'file' && !customPokeballFile) {
      alert('Por favor, selecione um arquivo de imagem!')
      return
    }
    setSelectedPokeballForPC('Custom Pokeball')
    setShowCustomPokeballOptions(false)
  }

  const handleCancelCustomPokeball = () => {
    setShowCustomPokeballOptions(false)
    setCustomPokeballLink('')
    setCustomPokeballFile(null)
    setCustomPokeballUploadType('link')
  }

  // Handlers para Custom Pokeball 2 (PC)
  const handleSelectPokeballPC = (pokeball) => {
    if (pokeball === 'Custom Pokeball 2') {
      setShowCustomPokeball2Options(true)
    } else {
      setSelectedPokeballForPC(pokeball)
    }
  }

  const handleConfirmCustomPokeball2 = () => {
    if (customPokeball2UploadType === 'link' && !customPokeball2Link.trim()) {
      alert('Por favor, insira um link válido para a imagem da pokébola!')
      return
    }
    if (customPokeball2UploadType === 'file' && !customPokeball2File) {
      alert('Por favor, selecione um arquivo de imagem!')
      return
    }
    setSelectedPokeballForPC('Custom Pokeball 2')
    setShowCustomPokeball2Options(false)
  }

  const handleCancelCustomPokeball2 = () => {
    setShowCustomPokeball2Options(false)
    setCustomPokeball2Link('')
    setCustomPokeball2File(null)
    setCustomPokeball2UploadType('link')
  }

  // Handler de salvamento único
  const handleSavePokeball = () => {
    if (!selectedPokeballForPC) return

    const updatedPokemon = { ...selectedPokemonForPokeball, pokeball: selectedPokeballForPC }

    // Custom Pokeball (Time Principal)
    if (selectedPokeballForPC === 'Custom Pokeball') {
      if (customPokeballUploadType === 'link') {
        updatedPokemon.customPokeballImage = customPokeballLink
      } else if (customPokeballFile) {
        const reader = new FileReader()
        reader.onloadend = () => {
          updatedPokemon.customPokeballImage = reader.result
          setMainTeam(mainTeam.map(p => p.id === selectedPokemonForPokeball.id ? updatedPokemon : p))
        }
        reader.readAsDataURL(customPokeballFile)
        setShowPokeballModal(false)
        setSelectedPokemonForPokeball(null)
        setSelectedPokeballForPC('')
        setPokeballSearch('')
        setCustomPokeballLink('')
        setCustomPokeballFile(null)
        setCustomPokeballUploadType('link')
        return
      }
    }

    // Custom Pokeball 2 (PC)
    if (selectedPokeballForPC === 'Custom Pokeball 2') {
      if (customPokeball2UploadType === 'link') {
        updatedPokemon.customPokeballImage = customPokeball2Link
      } else if (customPokeball2File) {
        const reader = new FileReader()
        reader.onloadend = () => {
          updatedPokemon.customPokeballImage = reader.result
          setPcPokemon(pcPokemon.map(p => p.id === selectedPokemonForPokeball.id ? updatedPokemon : p))
        }
        reader.readAsDataURL(customPokeball2File)
        setShowPokeballPCModal(false)
        setSelectedPokemonForPokeball(null)
        setSelectedPokeballForPC('')
        setPokeballSearch('')
        setCustomPokeball2Link('')
        setCustomPokeball2File(null)
        setCustomPokeball2UploadType('link')
        return
      }
    }

    // Pokébolas normais
    if (selectedPokemonTypeForPokeball === 'team') {
      setMainTeam(mainTeam.map(p => p.id === selectedPokemonForPokeball.id ? updatedPokemon : p))
    } else {
      setPcPokemon(pcPokemon.map(p => p.id === selectedPokemonForPokeball.id ? updatedPokemon : p))
    }

    setShowPokeballModal(false)
    setShowPokeballPCModal(false)
    setSelectedPokemonForPokeball(null)
    setSelectedPokeballForPC('')
    setPokeballSearch('')
    setCustomPokeballLink('')
    setCustomPokeballFile(null)
    setCustomPokeballUploadType('link')
    setCustomPokeball2Link('')
    setCustomPokeball2File(null)
    setCustomPokeball2UploadType('link')
  }

  // Funções para sistema de Held Items
  const handleOpenHeldItemModal = (pokemon, type) => {
    setSelectedPokemonForHeldItem(pokemon)
    setSelectedPokemonTypeForHeldItem(type)
    setHeldItemName(pokemon.heldItem?.name || '')
    setHeldItemDescription(pokemon.heldItem?.description || '')
    setShowHeldItemModal(true)
  }

  const handleOpenHeldItemPC = (pokemon, type) => {
    setSelectedPokemonForHeldItem(pokemon)
    setSelectedPokemonTypeForHeldItem(type)
    setHeldItemName(pokemon.heldItem?.name || '')
    setHeldItemDescription(pokemon.heldItem?.description || '')
    setShowHeldItemPCModal(true)
  }

  const handleSaveHeldItem = () => {
    if (!heldItemName.trim()) {
      alert('Por favor, insira o nome do item!')
      return
    }

    const updatedPokemon = {
      ...selectedPokemonForHeldItem,
      heldItem: {
        name: heldItemName.trim(),
        description: heldItemDescription.trim()
      }
    }

    if (selectedPokemonTypeForHeldItem === 'team') {
      setMainTeam(mainTeam.map(p => p.id === selectedPokemonForHeldItem.id ? updatedPokemon : p))
    } else {
      setPcPokemon(pcPokemon.map(p => p.id === selectedPokemonForHeldItem.id ? updatedPokemon : p))
    }

    setShowHeldItemModal(false)
    setSelectedPokemonForHeldItem(null)
    setSelectedPokemonTypeForHeldItem(null)
    setHeldItemName('')
    setHeldItemDescription('')
  }

  const handleOpenHeldItemDetail = (heldItem) => {
    setSelectedHeldItemForDetail(heldItem)
    setShowHeldItemDetailModal(true)
  }

  const getRandomNoItemPhrase = () => {
    return NO_HELD_ITEM_PHRASES[Math.floor(Math.random() * NO_HELD_ITEM_PHRASES.length)]
  }

  // Função para obter o nome correto do arquivo de imagem do item
  const getItemImagePath = (itemName) => {
    // Mapeamento de nomes de itens para nomes de arquivos
    const imageMap = {
      'Pokébola': 'pokeball',
      'Super Repel': 'superrepel',
      'Max Repel': 'maxrepel',
      'Rare Candy': 'rarecandy',
      'PP-up': 'ppup',
      'Hp-up': 'hpup',
      'Proteína': 'proteina',
      'Cálcio': 'calcio'
    }

    // Se existe um mapeamento específico, usa ele
    if (imageMap[itemName]) {
      return `/pokeballs/${imageMap[itemName]}.png`
    }

    // Caso contrário, converte para lowercase
    return `/pokeballs/${itemName.toLowerCase()}.png`
  }

  // Função para obter a descrição do item da PokéLoja
  const getItemDescription = (itemName) => {
    // Percorre todos os corredores da loja
    for (const corredor in POKELOJA_DATA) {
      const item = POKELOJA_DATA[corredor].find(i => i.name === itemName)
      if (item) {
        return item.description
      }
    }
    return 'Descrição não disponível'
  }

  // Função para obter descrição de um item da mochila (suporta custom items e puffins numerados)
  const getMochilaItemDescription = (item) => {
    if (item.description) return item.description
    // Para puffins com valor/aroma: strip e busca nome base
    if (item.name.startsWith('Puffin ')) {
      const baseName = item.name.replace(/\s*\([^)]+\)/g, '').replace(/\s+\d+$/, '').trim()
      const desc = getItemDescription(baseName)
      if (desc !== 'Descrição não disponível') return desc
    }
    // Para Pokesuco com qualidade
    if (item.name.startsWith('Pokesuco ')) {
      const baseName = item.name.replace(/\s+\d+$/, '').trim()
      const desc = getItemDescription(baseName)
      if (desc !== 'Descrição não disponível') return desc
    }
    return getItemDescription(item.name)
  }

  // Função para mostrar descrição do item chave
  const handleShowKeyItemDescription = (itemName) => {
    const description = getItemDescription(itemName)
    setSelectedItemForDescription({ name: itemName, description })
    setShowItemDescriptionModal(true)
  }

  // Funções para sistema de Mochila
  const handleAddKeyItem = () => {
    if (!selectedKeyItem) {
      alert('Selecione um item!')
      return
    }

    // Se for Pokeovo, abrir modal de seleção de espécie
    if (selectedKeyItem === 'Pokeovo') {
      setShowAddKeyItemModal(false)
      setShowPokeovoSpeciesModal(true)
      setSelectedPokeovoSpecies('Misterioso')
      setPokeovoSpeciesSearch('')
      return
    }

    // Se for Pokesuco, abrir modal de qualidade
    if (selectedKeyItem.startsWith('Pokesuco ')) {
      setShowAddKeyItemModal(false)
      setPokesucoQualidadeSelectedItem(selectedKeyItem)
      setPokesucoQualidadeValue(5)
      setShowPokesucoQualidadeModal(true)
      return
    }

    // Se for Custom Item Chave, abrir modal de nome/quantidade/imagem
    if (selectedKeyItem === 'Custom Item Chave') {
      setShowAddKeyItemModal(false)
      setCustomKeyItemName('')
      setCustomKeyItemQty(1)
      setCustomKeyItemImageUrl('')
      setShowCustomKeyItemModal(true)
      return
    }

    // Se for Puffin, abrir modal de valor e aroma
    if (selectedKeyItem.startsWith('Puffin ')) {
      setShowAddKeyItemModal(false)
      setPuffinValorSelectedItem(selectedKeyItem)
      setPuffinValorValue(5)
      setPuffinAromaFlavor(null)
      setShowPuffinValorModal(true)
      return
    }

    // Se for Shiny Charm, abrir modal para inserir número da sorte
    if (selectedKeyItem === 'Shiny Charm') {
      // Verificar se já existe um Shiny Charm
      const existingCharm = keyItems.find(item => item.name === 'Shiny Charm')
      if (existingCharm) {
        alert('Você já possui um Shiny Charm!')
        return
      }
      setShowAddKeyItemModal(false)
      setShowShinyCharmModal(true)
      setShinyCharmLuckyNumber('')
      return
    }

    const existingItem = keyItems.find(item => item.name === selectedKeyItem)
    if (existingItem) {
      setKeyItems(keyItems.map(item =>
        item.name === selectedKeyItem
          ? { ...item, quantity: item.quantity + keyItemQuantity }
          : item
      ))
    } else {
      setKeyItems([...keyItems, { name: selectedKeyItem, quantity: keyItemQuantity }])
    }

    setShowAddKeyItemModal(false)
    setSelectedKeyItem('')
    setKeyItemQuantity(1)
  }

  // Função para confirmar qualidade do Pokesuco ao adicionar pela mochila
  const handleConfirmPokesucoQualidade = () => {
    const qualidade = Math.max(1, Math.min(10, parseInt(pokesucoQualidadeValue) || 1))
    const nomeFinal = `${pokesucoQualidadeSelectedItem} ${qualidade}`
    const existingItem = keyItems.find(item => item.name === nomeFinal)
    if (existingItem) {
      setKeyItems(keyItems.map(item => item.name === nomeFinal ? { ...item, quantity: item.quantity + 1 } : item))
    } else {
      setKeyItems([...keyItems, { name: nomeFinal, quantity: 1 }])
    }
    setShowPokesucoQualidadeModal(false)
    setPokesucoQualidadeSelectedItem('')
    setPokesucoQualidadeValue(5)
    setSelectedKeyItem('')
    setKeyItemQuantity(1)
  }

  // Função para confirmar valor e aroma do Puffin ao adicionar pela mochila
  const handleConfirmPuffinValor = () => {
    const valor = Math.max(1, parseInt(puffinValorValue) || 1)
    const nomeFinal = puffinAromaFlavor
      ? `${puffinValorSelectedItem} (${puffinAromaFlavor}) ${valor}`
      : `${puffinValorSelectedItem} ${valor}`
    const existingItem = keyItems.find(item => item.name === nomeFinal)
    if (existingItem) {
      setKeyItems(keyItems.map(item => item.name === nomeFinal ? { ...item, quantity: item.quantity + 1 } : item))
    } else {
      setKeyItems([...keyItems, { name: nomeFinal, quantity: 1 }])
    }
    setShowPuffinValorModal(false)
    setPuffinValorSelectedItem('')
    setPuffinValorValue(5)
    setPuffinAromaFlavor(null)
    setSelectedKeyItem('')
    setKeyItemQuantity(1)
  }

  // Nomes reservados que conflitam com sistemas do jogo
  const RESERVED_KEY_ITEM_NAMES = ['Pokeovo', 'Shiny Charm', 'Safariball']
  const RESERVED_KEY_ITEM_PREFIXES = ['Puffin ', 'Pokesuco ']

  const handleConfirmCustomKeyItem = () => {
    const nome = customKeyItemName.trim()
    if (!nome) { alert('Digite um nome para o item!'); return }

    const conflictPrefix = RESERVED_KEY_ITEM_PREFIXES.find(p => nome.startsWith(p))
    if (conflictPrefix) {
      alert(`O nome não pode começar com "${conflictPrefix.trim()}" — esse prefixo é reservado pelo sistema.`)
      return
    }
    if (RESERVED_KEY_ITEM_NAMES.includes(nome)) {
      alert(`"${nome}" é um nome reservado pelo sistema. Escolha outro nome.`)
      return
    }

    const qty = Math.max(1, parseInt(customKeyItemQty) || 1)
    const image = customKeyItemImageUrl.trim() || '/pokeballs/placeholderitem.png'
    const description = customKeyItemDescription.trim()
    const existingItem = keyItems.find(item => item.name === nome)
    if (existingItem) {
      setKeyItems(keyItems.map(item => item.name === nome ? { ...item, quantity: item.quantity + qty } : item))
    } else {
      setKeyItems([...keyItems, { name: nome, quantity: qty, image, ...(description && { description }) }])
    }
    setShowCustomKeyItemModal(false)
    setCustomKeyItemName('')
    setCustomKeyItemQty(1)
    setCustomKeyItemImageUrl('')
    setCustomKeyItemDescription('')
    setSelectedKeyItem('')
    setKeyItemQuantity(1)
  }

  // Função para adicionar Pokeovo com espécie selecionada
  const handleAddPokeovo = () => {
    const speciesName = selectedPokeovoSpecies === 'Misterioso' ? '?!?!' : selectedPokeovoSpecies
    const randomImageIndex = Math.floor(Math.random() * POKEOVO_IMAGES.length)

    const newPokeovo = {
      id: `pokeovo-${Date.now()}-${Math.random()}`,
      species: selectedPokeovoSpecies,
      displayName: `Pokeovo de ${speciesName}`,
      imageIndex: randomImageIndex
    }

    setPokeovoList([...pokeovoList, newPokeovo])
    setShowPokeovoSpeciesModal(false)
    setSelectedKeyItem('')
    setKeyItemQuantity(1)
  }

  // Função para adicionar Shiny Charm com número da sorte
  const handleAddShinyCharm = () => {
    const luckyNum = parseInt(shinyCharmLuckyNumber)
    if (!luckyNum || luckyNum < 1 || luckyNum > 1365) {
      alert('Por favor, insira um número da sorte válido (1 a 1365)!')
      return
    }

    setKeyItems([...keyItems, { name: 'Shiny Charm', luckyNumber: luckyNum }])
    setShowShinyCharmModal(false)
    setSelectedKeyItem('')
    setShinyCharmLuckyNumber('')
  }

  // Função para editar número da sorte do Shiny Charm
  const handleEditShinyCharm = () => {
    const luckyNum = parseInt(shinyCharmLuckyNumber)
    if (!luckyNum || luckyNum < 1 || luckyNum > 1365) {
      alert('Por favor, insira um número da sorte válido (1 a 1365)!')
      return
    }

    setKeyItems(keyItems.map(item =>
      item.name === 'Shiny Charm'
        ? { ...item, luckyNumber: luckyNum }
        : item
    ))
    setShowEditShinyCharmModal(false)
    setShinyCharmToEdit(null)
    setShinyCharmLuckyNumber('')
  }

  // Função para rolar 1d1365 do Shiny Charm
  const handleShinyCharmRoll = async (luckyNumber) => {
    const roll = Math.floor(Math.random() * 1365) + 1
    const isSuccess = roll === luckyNumber

    const text = isSuccess
      ? `✨ SHINY CHARM ✨ ${currentUser?.username || 'Desconhecido'} rolou ${roll} - SUCESSO! Número da sorte: ${luckyNumber}`
      : `🎲 SHINY CHARM: ${currentUser?.username || 'Desconhecido'} rolou ${roll} - Fracasso. Número da sorte: ${luckyNumber}`

    const newMessage = {
      id: `${Date.now()}-${Math.random()}`,
      username: 'Sistema',
      text: text,
      timestamp: new Date().toISOString(),
      type: 'system'
    }

    if (useFirebase) {
      const currentMessages = await loadChatMessages()
      const updatedMessages = [...(currentMessages || []), newMessage].slice(-10)
      await saveChatMessages(updatedMessages)
    } else {
      setChatMessages(prev => [...prev, newMessage].slice(-10))
    }
  }

  // ===== FUNÇÕES DA POKÉOFICINA =====

  // Função para Criar Pokébola (talento Captor)
  const handleCriarPokebola = async () => {
    const modVelocidade = getModifier(attributes.velocidade)
    const roll = Math.floor(Math.random() * 20) + 1
    const total = roll + modVelocidade

    let pokeballType = ''
    if (total >= 1 && total <= 14) {
      pokeballType = 'Pokeball'
    } else if (total >= 15 && total <= 19) {
      pokeballType = 'Greatball'
    } else if (total >= 20) {
      pokeballType = 'Ultraball'
    }

    // Adicionar pokébola à mochila
    const existingItem = keyItems.find(item => item.name === pokeballType)
    if (existingItem) {
      setKeyItems(keyItems.map(item =>
        item.name === pokeballType
          ? { ...item, quantity: item.quantity + 1 }
          : item
      ))
    } else {
      setKeyItems([...keyItems, { name: pokeballType, quantity: 1 }])
    }

    // Mensagem no chat
    const timestamp = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
    const text = `🔧 Pokéoficina - Criar Pokébola: ${currentUser.username} rolou 1d20+${modVelocidade} = ${roll}+${modVelocidade} = ${total} → ${pokeballType} criada!`
    addChatMessage({ username: 'Sistema', text, timestamp, isDiceRoll: true })

    // Notificação para o usuário
    alert(`🎲 Criar Pokébola\n\nRolagem: ${roll} + ${modVelocidade} = ${total}\n\n✅ ${pokeballType} criada com sucesso!`)
  }

  // Função para abrir modal de Reparar Pokébola
  const handleRepararPokebola = () => {
    setShowRepairPokeballModal(true)
    setSelectedPokeballToRepair('')
    setRepairPokeballSearch('')
  }

  // Função para confirmar reparação de pokébola
  const handleConfirmRepairPokeball = async () => {
    if (!selectedPokeballToRepair) {
      alert('Selecione um tipo de pokébola!')
      return
    }

    const partsName = `Peças de ${selectedPokeballToRepair}`
    const partsItem = keyItems.find(item => item.name === partsName)

    if (!partsItem || partsItem.quantity <= 0) {
      const timestamp = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
      addChatMessage({ username: 'Sistema', text: 'Não há peças.', timestamp, isDiceRoll: false })
      setShowRepairPokeballModal(false)
      setSelectedPokeballToRepair('')
      return
    }

    const modVelocidade = getModifier(attributes.velocidade)
    const roll = Math.floor(Math.random() * 20) + 1
    const total = roll + modVelocidade

    const timestamp = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })

    // Consumir a peça primeiro
    let updatedKeyItems = keyItems.map(item =>
      item.name === partsName
        ? { ...item, quantity: item.quantity - 1 }
        : item
    ).filter(item => item.quantity === undefined || item.quantity > 0)

    if (total >= 16) {
      // Sucesso - adicionar pokébola ao array já atualizado (sem a peça)
      const existingBall = updatedKeyItems.find(item => item.name === selectedPokeballToRepair)
      if (existingBall) {
        updatedKeyItems = updatedKeyItems.map(item =>
          item.name === selectedPokeballToRepair
            ? { ...item, quantity: item.quantity + 1 }
            : item
        )
      } else {
        updatedKeyItems = [...updatedKeyItems, { name: selectedPokeballToRepair, quantity: 1 }]
      }

      // Atualizar o estado uma única vez com tudo
      setKeyItems(updatedKeyItems)

      const text = `🔧 Pokéoficina - Reparar Pokébola: ${currentUser.username} rolou 1d20+${modVelocidade} = ${roll}+${modVelocidade} = ${total} → SUCESSO! ${selectedPokeballToRepair} reparada!`
      addChatMessage({ username: 'Sistema', text, timestamp, isDiceRoll: true })

      // Aviso de sucesso
      alert(`✅ SUCESSO!\n\nRolagem: ${roll} + ${modVelocidade} = ${total}\n\n${selectedPokeballToRepair} foi reparada com sucesso!\nPeça consumida: 1x Peças de ${selectedPokeballToRepair}`)
    } else {
      // Falha - apenas atualizar o estado com a peça consumida
      setKeyItems(updatedKeyItems)

      const text = `🔧 Pokéoficina - Reparar Pokébola: ${currentUser.username} rolou 1d20+${modVelocidade} = ${roll}+${modVelocidade} = ${total} → Falha. Peça consumida.`
      addChatMessage({ username: 'Sistema', text, timestamp, isDiceRoll: true })

      // Aviso de falha
      alert(`❌ FALHA!\n\nRolagem: ${roll} + ${modVelocidade} = ${total}\n\nA reparação falhou. A peça foi consumida.\nPeça consumida: 1x Peças de ${selectedPokeballToRepair}`)
    }

    setShowRepairPokeballModal(false)
    setSelectedPokeballToRepair('')
    setRepairPokeballSearch('')
  }

  // Função para chocar ovo
  const handleHatchEgg = (pokeovo) => {
    // Se for ovo misterioso, abrir modal para escolher espécie
    if (pokeovo.species === 'Misterioso') {
      setSelectedPokeovoToHatch(pokeovo)
      setSelectedHatchSpecies('')
      setHatchSpeciesSearch('')
      setShowHatchMysteryEggModal(true)
      return
    }

    // Chocar ovo com espécie já definida
    hatchEggWithSpecies(pokeovo, pokeovo.species)
  }

  // Função para chocar ovo com espécie específica
  const hatchEggWithSpecies = (pokeovo, species) => {
    // Buscar dados da espécie
    const speciesData = pokedexData.find(p => p.nome.toLowerCase() === species.toLowerCase())

    // Gerar golpes para level 1 - passar o NOME da espécie (string), não o objeto
    const golpesAprendidos = generatePokemonMoves(species, 1)

    // Buscar habilidades da espécie e sortear uma
    const speciesAbilities = POKEMON_ABILITIES[species] || { habilidades: [], altasHabilidades: [] }
    const allAbilities = [...(speciesAbilities.habilidades || []), ...(speciesAbilities.altasHabilidades || [])]
    const habilidade1 = allAbilities.length > 0 ? allAbilities[Math.floor(Math.random() * allAbilities.length)] : null

    // Sortear natureza
    const randomNature = natures[Math.floor(Math.random() * natures.length)]

    // Sortear gênero baseado na distribuição da espécie
    let gender = null
    if (speciesData && speciesData.genero) {
      const genderParts = speciesData.genero.split('_')
      const malePercent = parseFloat(genderParts[0])
      const femalePercent = parseFloat(genderParts[1])

      if (malePercent === 0 && femalePercent === 0) {
        // Pokémon sem gênero (ex: Magnemite)
        gender = null
      } else if (malePercent === 100) {
        gender = 'Macho'
      } else if (femalePercent === 100) {
        gender = 'Fêmea'
      } else {
        // Sortear baseado na porcentagem
        const roll = Math.random() * 100
        gender = roll < malePercent ? 'Macho' : 'Fêmea'
      }
    }

    // Obter peso e altura da espécie (usar weight e height para compatibilidade com o formulário de edição)
    const weight = speciesData ? speciesData.peso : ''
    const height = speciesData ? speciesData.altura : ''

    // Criar novo pokémon level 1
    const newPokemon = {
      id: Date.now(),
      nickname: species,
      species: species,
      level: 1,
      totalXP: 0,
      isCaptured: true,
      isExotic: false,
      golpes: golpesAprendidos,
      habilidade1: habilidade1,
      habilidade2: null,
      habilidades: habilidade1 ? [habilidade1] : [], // Array para compatibilidade com modal de habilidades
      hatchedFromEgg: true,
      nature: randomNature.nome,
      gender: gender,
      weight: weight,
      height: height,
      displacement: POKEMON_DESLOCAMENTO_MAP[species] || null,
      capacities: (() => { const c = POKEMON_CAPACIDADE_MAP[species]; return c ? { forca: c.forca, inteligencia: c.inteligencia, salto: c.salto, others: [] } : null })()
    }

    // Adicionar à Pokédex como escaneado E capturado
    const existingEntry = pokedex.find(p => p.species === species)
    if (!existingEntry) {
      // Não existe na Pokédex, criar nova entrada como escaneado e capturado
      setPokedex([...pokedex, { species, isScanned: true, isCaptured: true }])
    } else {
      // Existe, marcar como escaneado e capturado
      setPokedex(pokedex.map(p => p.species === species ? { ...p, isScanned: true, isCaptured: true } : p))
    }

    // Adicionar ao time ou PC
    if (mainTeam.length < 6) {
      setMainTeam([...mainTeam, newPokemon])
      alert(`${species} nasceu do ovo e foi adicionado ao seu time!`)
    } else {
      setPcPokemon([...pcPokemon, newPokemon])
      alert(`${species} nasceu do ovo e foi enviado para o PC (time cheio)!`)
    }

    // Remover o pokeovo da lista
    setPokeovoList(pokeovoList.filter(p => p.id !== pokeovo.id))
    setShowHatchMysteryEggModal(false)
    setSelectedPokeovoToHatch(null)
  }

  // Função para confirmar chocar ovo misterioso
  const handleConfirmHatchMysteryEgg = () => {
    if (!selectedHatchSpecies) {
      alert('Selecione uma espécie!')
      return
    }
    hatchEggWithSpecies(selectedPokeovoToHatch, selectedHatchSpecies)
  }

  // Incrementar quantidade de item chave
  const handleIncrementKeyItem = (itemName) => {
    setKeyItems(keyItems.map(item =>
      item.name === itemName
        ? { ...item, quantity: item.quantity + 1 }
        : item
    ))
  }

  // Decrementar quantidade de item chave
  const handleDecrementKeyItem = (itemName) => {
    setKeyItems(keyItems.map(item =>
      item.name === itemName && item.quantity > 1
        ? { ...item, quantity: item.quantity - 1 }
        : item
    ).filter(item => item.quantity === undefined || item.quantity > 0))
  }

  // Abrir modal para editar quantidade de item chave
  const handleOpenEditKeyItemQuantity = (item) => {
    setSelectedKeyItemForEdit(item)
    setEditKeyItemQuantity(item.quantity)
    setShowEditKeyItemQuantityModal(true)
  }

  // Salvar quantidade editada de item chave
  const handleSaveEditKeyItemQuantity = () => {
    if (editKeyItemQuantity < 1) {
      alert('A quantidade deve ser pelo menos 1!')
      return
    }

    setKeyItems(keyItems.map(item =>
      item.name === selectedKeyItemForEdit.name
        ? { ...item, quantity: editKeyItemQuantity }
        : item
    ))

    setShowEditKeyItemQuantityModal(false)
    setSelectedKeyItemForEdit(null)
    setEditKeyItemQuantity(1)
  }

  // Abrir modal de confirmação de exclusão
  const handleOpenDeleteConfirm = (item, type) => {
    setItemToDelete(item)
    setDeleteType(type)
    setShowDeleteConfirmModal(true)
  }

  // Confirmar exclusão
  const handleConfirmDelete = () => {
    if (deleteType === 'keyItem') {
      setKeyItems(keyItems.filter(i => i.name !== itemToDelete))
    } else if (deleteType === 'customItem') {
      setCustomItems(customItems.filter((_, i) => i !== itemToDelete))
    }

    setShowDeleteConfirmModal(false)
    setItemToDelete(null)
    setDeleteType(null)
  }

  const handleAddCustomItem = () => {
    if (!customItemName.trim()) {
      alert('Insira o nome do item!')
      return
    }

    const existingItem = customItems.find(item => item.name === customItemName.trim())
    if (existingItem) {
      setCustomItems(customItems.map(item =>
        item.name === customItemName.trim()
          ? { ...item, quantity: item.quantity + customItemQuantity }
          : item
      ))
    } else {
      setCustomItems([...customItems, {
        name: customItemName.trim(),
        quantity: customItemQuantity,
        description: customItemDescription.trim()
      }])
    }

    setShowAddCustomItemModal(false)
    setCustomItemName('')
    setCustomItemQuantity(1)
    setCustomItemDescription('')
  }

  const handleGiveItemToPokemon = () => {
    if (!selectedPokemonToReceiveItem) {
      alert('Selecione um Pokémon!')
      return
    }

    // Buscar pokémon comparando tanto com string quanto com número
    const pokemon = mainTeam.find(p => p.id == selectedPokemonToReceiveItem)
    if (!pokemon) {
      alert('Pokémon não encontrado!')
      return
    }

    const updatedPokemon = {
      ...pokemon,
      heldItem: {
        name: selectedItemToGive.name,
        description: selectedItemToGive.description || ''
      }
    }

    setMainTeam(mainTeam.map(p => p.id == selectedPokemonToReceiveItem ? updatedPokemon : p))

    // Remover o item da mochila
    const updatedCustomItems = customItems.map(item =>
      item.name === selectedItemToGive.name
        ? { ...item, quantity: item.quantity - 1 }
        : item
    ).filter(item => item.quantity > 0)

    setCustomItems(updatedCustomItems)

    // Resetar estados e fechar modal
    setShowGiveItemModal(false)
    setSelectedItemToGive(null)
    setSelectedPokemonToReceiveItem(null)

    alert(`${selectedItemToGive.name} foi dado para ${pokemon.nickname}!`)
  }

  // Abrir modal para editar item customizado
  const handleOpenEditCustomItem = (item, index) => {
    setSelectedCustomItemForEdit(index)
    setEditCustomItemName(item.name)
    setEditCustomItemQuantity(item.quantity)
    setEditCustomItemDescription(item.description)
    setShowEditCustomItemModal(true)
  }

  // Salvar edição de item customizado
  const handleSaveEditCustomItem = () => {
    if (!editCustomItemName.trim()) {
      alert('O nome do item não pode estar vazio!')
      return
    }

    if (editCustomItemQuantity < 1) {
      alert('A quantidade deve ser pelo menos 1!')
      return
    }

    setCustomItems(customItems.map((item, idx) =>
      idx === selectedCustomItemForEdit
        ? {
            name: editCustomItemName.trim(),
            quantity: editCustomItemQuantity,
            description: editCustomItemDescription.trim()
          }
        : item
    ))

    setShowEditCustomItemModal(false)
    setSelectedCustomItemForEdit(null)
    setEditCustomItemName('')
    setEditCustomItemQuantity(1)
    setEditCustomItemDescription('')
  }

  // Funções para manipular Pokémonedas
  const handlePerdeuPokemonedas = () => {
    const value = parseInt(pokemonedasValue) || 0
    setPokemonedas(Math.max(0, pokemonedas - value))
    setShowPokemonedasModal(false)
    setPokemonedasValue('')
  }

  const handleSaldoPokemonedas = () => {
    const value = parseInt(pokemonedasValue) || 0
    setPokemonedas(Math.max(0, value))
    setShowPokemonedasModal(false)
    setPokemonedasValue('')
  }

  const handleAcheiPokemonedas = () => {
    const value = parseInt(pokemonedasValue) || 0
    setPokemonedas(pokemonedas + value)
    setShowPokemonedasModal(false)
    setPokemonedasValue('')
  }

  // ===== FUNÇÕES DO SEDEX ITEM =====

  // Função para verificar se pokemon veio shiny
  const handleShinyCheck = () => {
    if (!currentUser || currentUser.type !== 'treinador') {
      alert('Apenas treinadores podem usar esta função!')
      return
    }

    // Rolar 1d4092
    const roll = Math.floor(Math.random() * 4092) + 1
    const trainerLevel = level || 1

    // Comparar com o nível do treinador
    const isSuccess = roll === trainerLevel

    // Timestamp para a mensagem
    const timestamp = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })

    // Construir mensagem
    let message = `✨ Será que veio shiny?\n1d4092 = ${roll}`
    message += `\nNível do Treinador: ${trainerLevel}`
    message += `\n\n${isSuccess ? '🌟 SUCESSO! Veio shiny! 🌟' : '❌ Não veio shiny.'}`

    // Enviar mensagem ao chat
    addChatMessage({
      username: currentUser.username,
      text: message,
      timestamp,
      isDiceRoll: true,
      diceResult: isSuccess ? 'SHINY!' : roll
    })

    // Mostrar mensagem na tela do usuário
    const alertMessage = `Será que veio shiny?\n\nRolagem: ${roll}\nNível do Treinador: ${trainerLevel}\n\n${isSuccess ? '🌟 SUCESSO! Veio shiny! 🌟' : '❌ Não veio shiny.'}`
    alert(alertMessage)
  }

  // Função para abrir modal de Sedex Item e carregar treinadores
  const handleOpenSedexModal = () => {
    setShowSedexItemModal(true)
    setSedexItemSearch('')
    setSelectedSedexItem(null)
    setSelectedSedexTrainer('')

    // Filtrar treinadores do array local
    const trainers = users.filter(user =>
      user.type === 'treinador' && user.username !== currentUser?.username
    )
    setAvailableTrainers(trainers)
  }

  // Função para despachar item
  const handleDispatchItem = async () => {
    if (!selectedSedexItem) {
      alert('Selecione um item para enviar!')
      return
    }
    if (!selectedSedexTrainer) {
      alert('Selecione um treinador para receber o item!')
      return
    }

    if (!useFirebase || !currentUser) {
      alert('Você precisa estar logado para usar o Sedex Item!')
      return
    }

    try {
      // Buscar dados do treinador receptor no Firebase
      const receiverRef = ref(database, `trainers/${selectedSedexTrainer}`)
      const snapshot = await get(receiverRef)

      if (!snapshot.exists()) {
        alert('Dados do treinador não encontrados!')
        return
      }

      const receiverData = snapshot.val()

      // Remover item do remetente
      if (selectedSedexItem.type === 'key') {
        const updatedKeyItems = keyItems.map(item =>
          item.name === selectedSedexItem.name
            ? { ...item, quantity: item.quantity - 1 }
            : item
        ).filter(item => item.quantity === undefined || item.quantity > 0)
        setKeyItems(updatedKeyItems)

        // Salvar no Firebase do remetente
        await set(ref(database, `trainers/${currentUser.username}/keyItems`), updatedKeyItems)

        // Adicionar ao receptor
        const receiverKeyItems = receiverData.keyItems || []
        const existingItem = receiverKeyItems.find(item => item.name === selectedSedexItem.name)
        let updatedReceiverKeyItems

        if (existingItem) {
          updatedReceiverKeyItems = receiverKeyItems.map(item =>
            item.name === selectedSedexItem.name
              ? { ...item, quantity: item.quantity + 1 }
              : item
          )
        } else {
          updatedReceiverKeyItems = [...receiverKeyItems, { name: selectedSedexItem.name, quantity: 1 }]
        }

        // Salvar no Firebase do receptor
        await set(ref(database, `trainers/${selectedSedexTrainer}/keyItems`), updatedReceiverKeyItems)

      } else if (selectedSedexItem.type === 'custom') {
        const updatedCustomItems = customItems.map(item =>
          item.name === selectedSedexItem.name
            ? { ...item, quantity: item.quantity - 1 }
            : item
        ).filter(item => item.quantity > 0)
        setCustomItems(updatedCustomItems)

        // Salvar no Firebase do remetente
        await set(ref(database, `trainers/${currentUser.username}/customItems`), updatedCustomItems)

        // Adicionar ao receptor
        const receiverCustomItems = receiverData.customItems || []
        const existingItem = receiverCustomItems.find(item => item.name === selectedSedexItem.name)
        let updatedReceiverCustomItems

        if (existingItem) {
          updatedReceiverCustomItems = receiverCustomItems.map(item =>
            item.name === selectedSedexItem.name
              ? { ...item, quantity: item.quantity + 1 }
              : item
          )
        } else {
          updatedReceiverCustomItems = [...receiverCustomItems, {
            name: selectedSedexItem.name,
            quantity: 1,
            description: selectedSedexItem.description || ''
          }]
        }

        // Salvar no Firebase do receptor
        await set(ref(database, `trainers/${selectedSedexTrainer}/customItems`), updatedReceiverCustomItems)

      } else if (selectedSedexItem.type === 'fotografia') {
        // Remover fotografia do remetente
        const updatedFotografias = fotografias.filter(f => f.id !== selectedSedexItem.id)
        setFotografias(updatedFotografias)

        // Salvar no Firebase do remetente
        await set(ref(database, `trainers/${currentUser.username}/fotografias`), updatedFotografias)

        // Adicionar ao receptor
        const receiverFotografias = receiverData.fotografias || []
        const newFoto = {
          id: Date.now(),
          nome: selectedSedexItem.nome || '',
          url: selectedSedexItem.url,
          preco: selectedSedexItem.preco
        }
        const updatedReceiverFotografias = [...receiverFotografias, newFoto]

        // Salvar no Firebase do receptor
        await set(ref(database, `trainers/${selectedSedexTrainer}/fotografias`), updatedReceiverFotografias)
      }

      alert(`✅ Item "${selectedSedexItem.name}" enviado para ${selectedSedexTrainer} com sucesso!`)
      setShowSedexItemModal(false)
      setSedexItemSearch('')
      setSelectedSedexItem(null)
      setSelectedSedexTrainer('')

    } catch (error) {
      console.error('Erro ao despachar item:', error)
      alert('Erro ao enviar item. Tente novamente.')
    }
  }

  // ===== FUNÇÕES DO SEDEX PKM =====

  // Função para despachar pokémon
  const handleDispatchPokemon = async () => {
    if (!selectedSedexPkm) {
      alert('Selecione um Pokémon para enviar!')
      return
    }
    if (!selectedSedexPkmTrainer) {
      alert('Selecione um treinador para receber o Pokémon!')
      return
    }

    if (!useFirebase || !currentUser) {
      alert('Você precisa estar logado para usar o Sedex Pkm!')
      return
    }

    try {
      // Buscar dados do treinador receptor no Firebase
      const receiverRef = ref(database, `trainers/${selectedSedexPkmTrainer}`)
      const snapshot = await get(receiverRef)

      if (!snapshot.exists()) {
        alert('Dados do treinador não encontrados!')
        return
      }

      const receiverData = snapshot.val()

      // Remover pokémon do PC do remetente
      const updatedPcPokemon = pcPokemon.filter(pkm => pkm.id !== selectedSedexPkm.id)
      setPcPokemon(updatedPcPokemon)

      // Salvar no Firebase do remetente
      await set(ref(database, `trainers/${currentUser.username}/pcPokemon`), updatedPcPokemon)

      // Adicionar pokémon ao PC do receptor
      const receiverPcPokemon = receiverData.pcPokemon || []
      const updatedReceiverPcPokemon = [...receiverPcPokemon, selectedSedexPkm]

      // Atualizar Pokédex do receptor (adicionar como capturado e escaneado)
      const receiverPokedex = receiverData.pokedex || []
      const pokemonSpecies = selectedSedexPkm.species
      const existingPokedexEntry = receiverPokedex.find(p => p.species === pokemonSpecies)

      let updatedReceiverPokedex
      if (existingPokedexEntry) {
        // Se já existe na Pokédex, marcar como capturado
        updatedReceiverPokedex = receiverPokedex.map(p =>
          p.species === pokemonSpecies
            ? { ...p, isCaptured: true, isScanned: true }
            : p
        )
      } else {
        // Se não existe, adicionar como capturado e escaneado
        updatedReceiverPokedex = [...receiverPokedex, {
          species: pokemonSpecies,
          isScanned: true,
          isCaptured: true,
          isExotic: selectedSedexPkm.isExotic || false,
          exoticData: selectedSedexPkm.exoticData || null
        }]
      }

      // Salvar no Firebase do receptor
      await set(ref(database, `trainers/${selectedSedexPkmTrainer}/pcPokemon`), updatedReceiverPcPokemon)
      await set(ref(database, `trainers/${selectedSedexPkmTrainer}/pokedex`), updatedReceiverPokedex)

      alert(`✅ Pokémon "${selectedSedexPkm.nickname || selectedSedexPkm.species}" enviado para ${selectedSedexPkmTrainer} com sucesso!`)
      setShowSedexPkmModal(false)
      setSedexPkmSearch('')
      setSelectedSedexPkm(null)
      setSelectedSedexPkmTrainer('')

    } catch (error) {
      console.error('Erro ao despachar pokémon:', error)
      alert('Erro ao enviar pokémon. Tente novamente.')
    }
  }

  // Enviar held item de volta para a mochila
  const handleReturnItemToBackpack = (pokemon, isPC = false) => {
    if (!pokemon.heldItem) {
      alert('Este Pokémon não está segurando nenhum item!')
      return
    }

    const itemName = pokemon.heldItem.name
    const itemDescription = pokemon.heldItem.description

    // Remover o item do pokémon
    const updatedPokemon = { ...pokemon, heldItem: null }

    if (isPC) {
      setPcPokemon(pcPokemon.map(p => p.id === pokemon.id ? updatedPokemon : p))
    } else {
      setMainTeam(mainTeam.map(p => p.id === pokemon.id ? updatedPokemon : p))
    }

    // Adicionar o item de volta à mochila
    const existingItem = customItems.find(item => item.name === itemName)
    if (existingItem) {
      // Incrementar quantidade se já existe
      const updatedCustomItems = customItems.map(item =>
        item.name === itemName
          ? { ...item, quantity: item.quantity + 1 }
          : item
      )
      setCustomItems(updatedCustomItems)
    } else {
      // Adicionar novo item
      setCustomItems([...customItems, {
        name: itemName,
        quantity: 1,
        description: itemDescription
      }])
    }

    alert(`${itemName} foi devolvido para a mochila!`)
  }

  // Funções da PokéLoja
  const toggleCorredor = (corredor) => {
    setExpandedCorredores(prev => ({
      ...prev,
      [corredor]: !prev[corredor]
    }))
  }

  const handleOpenItemDescription = (item) => {
    setSelectedItemForDescription(item)
    setShowItemDescriptionModal(true)
  }

  const handleOpenBuyItemModal = (item) => {
    setSelectedItemToBuy(item)
    setBuyItemQuantity(1)
    setShowBuyItemModal(true)
  }

  const handleBuyItem = () => {
    if (!selectedItemToBuy) {
      alert('Nenhum item selecionado!')
      return
    }

    const itemPrice = customPrices[selectedItemToBuy.name] !== undefined ? customPrices[selectedItemToBuy.name] : selectedItemToBuy.price
    const totalPrice = itemPrice * buyItemQuantity

    if (pokemonedas < totalPrice) {
      alert(`Pokémoedas insuficientes! Você precisa de ${totalPrice}₽ mas tem apenas ${pokemonedas}₽`)
      return
    }

    // Descontar pokémoedas
    setPokemonedas(pokemonedas - totalPrice)

    // Adicionar item à mochila (keyItems)
    const existingItem = keyItems.find(item => item.name === selectedItemToBuy.name)
    if (existingItem) {
      const updatedKeyItems = keyItems.map(item =>
        item.name === selectedItemToBuy.name
          ? { ...item, quantity: item.quantity + buyItemQuantity }
          : item
      )
      setKeyItems(updatedKeyItems)
    } else {
      setKeyItems([...keyItems, {
        name: selectedItemToBuy.name,
        quantity: buyItemQuantity
      }])
    }

    alert(`Você comprou ${buyItemQuantity}x ${selectedItemToBuy.name} por ${totalPrice}₽!`)

    // Resetar estados
    setShowBuyItemModal(false)
    setSelectedItemToBuy(null)
    setBuyItemQuantity(1)
  }

  // ==================== FUNÇÕES DE POKESUCO ====================

  // Calcula informações do suco baseado nos slots, intensificar e dominante
  const calcPokesucoInfo = (slots, intensificar, dominante) => {
    const filledSlots = slots.filter(s => s !== null)
    const colors = filledSlots.map(s => APRICORN_COLOR_MAP[s])

    const hasRainbow = colors.includes('Arco-íris')
    const hasBlack = colors.includes('Preto')
    const hasWhite = colors.includes('Branco')
    const regularColors = colors.filter(c => !['Preto', 'Branco', 'Arco-íris'].includes(c))

    let sucoNome, dominantColor, imagePath, efeito

    if (hasRainbow) {
      // Prioridade 1: Arco-íris
      sucoNome = 'Pokesuco Arco-íris'
      dominantColor = 'Arco-íris'
      imagePath = POKESUCO_IMAGE_MAP['Arco-íris']
      efeito = POKESUCO_EFEITO_MAP['Arco-íris']
    } else if (hasBlack) {
      // Prioridade 2: Preto → Forte
      let Y
      if (intensificar) {
        Y = intensificar
      } else {
        Y = regularColors[0] || 'Vermelho'
      }
      sucoNome = `Pokesuco ${Y} Forte`
      dominantColor = Y
      imagePath = POKESUCO_IMAGE_MAP[Y] || POKESUCO_IMAGE_MAP['Branco']
      efeito = POKESUCO_EFEITO_MAP[Y] || POKESUCO_EFEITO_MAP['Fraco']
    } else if (hasWhite) {
      // Prioridade 3: Branco → Fraco
      imagePath = POKESUCO_IMAGE_MAP['Branco']
      efeito = POKESUCO_EFEITO_MAP['Fraco']
      const uniqueOrdered = []
      for (const c of regularColors) {
        if (!uniqueOrdered.includes(c)) uniqueOrdered.push(c)
      }
      if (uniqueOrdered.length >= 2) {
        const W = uniqueOrdered[0]
        const Z = uniqueOrdered[1]
        sucoNome = `Pokesuco ${W}/${Z} Fraco`
        dominantColor = W
      } else {
        const Y = uniqueOrdered[0] || 'Vermelho'
        sucoNome = `Pokesuco ${Y} Fraco`
        dominantColor = Y
      }
    } else {
      // Prioridade 4: Cores regulares
      let Y
      if (dominante) {
        Y = dominante
      } else if (regularColors.length === 1) {
        Y = regularColors[0]
      } else if (regularColors.length > 1) {
        const colorCounts = {}
        regularColors.forEach(c => { colorCounts[c] = (colorCounts[c] || 0) + 1 })
        Y = Object.entries(colorCounts).sort((a, b) => b[1] - a[1])[0][0]
      } else {
        Y = 'Vermelho'
      }
      sucoNome = `Pokesuco ${Y}`
      dominantColor = Y
      imagePath = POKESUCO_IMAGE_MAP[Y] || POKESUCO_IMAGE_MAP['Branco']
      efeito = POKESUCO_EFEITO_MAP[Y] || POKESUCO_EFEITO_MAP['Fraco']
    }

    return { sucoNome, dominantColor, imagePath, efeito, hasRainbow, hasBlack, hasWhite }
  }

  // Calcula a qualidade do suco
  const calcPokesucoQualidade = (roll, slots, dominantColor, hasRainbow) => {
    const filledSlots = slots.filter(s => s !== null)
    if (hasRainbow) {
      return Math.min(10, roll + filledSlots.length)
    } else {
      const matchCount = filledSlots.filter(s => APRICORN_COLOR_MAP[s] === dominantColor).length
      return Math.min(10, roll + matchCount)
    }
  }

  // Determina se o campo "Intensificar" deve aparecer
  const shouldShowIntensificar = (slots) => {
    const colors = slots.filter(s => s !== null).map(s => APRICORN_COLOR_MAP[s])
    const hasBlack = colors.includes('Preto')
    const hasRainbow = colors.includes('Arco-íris')
    if (!hasBlack || hasRainbow) return false
    const otherColors = [...new Set(colors.filter(c => c !== 'Preto' && c !== 'Branco'))]
    return otherColors.length >= 2
  }

  // Determina se o campo "Dominante" deve aparecer
  const shouldShowDominante = (slots) => {
    const colors = slots.filter(s => s !== null).map(s => APRICORN_COLOR_MAP[s])
    const hasBlack = colors.includes('Preto')
    const hasWhite = colors.includes('Branco')
    const hasRainbow = colors.includes('Arco-íris')
    if (hasBlack || hasWhite || hasRainbow) return false
    const distinctRegular = [...new Set(colors)]
    return distinctRegular.length === 2
  }

  // Retorna as cores disponíveis para Intensificar
  const getIntensificarColors = (slots) => {
    const colors = slots.filter(s => s !== null).map(s => APRICORN_COLOR_MAP[s])
    return [...new Set(colors.filter(c => c !== 'Preto' && c !== 'Branco' && c !== 'Arco-íris'))]
  }

  // Retorna as cores disponíveis para Dominante
  const getDominanteColors = (slots) => {
    const colors = slots.filter(s => s !== null).map(s => APRICORN_COLOR_MAP[s])
    return [...new Set(colors)]
  }

  // Verifica se um Apricorn pode ser adicionado a um slot específico
  const canAddApricorn = (apricornName, slots) => {
    const filledSlots = slots.filter(s => s !== null)
    const nextSlotIndex = filledSlots.length
    const color = APRICORN_COLOR_MAP[apricornName]

    // Verificar limite de slots
    if (nextSlotIndex >= slots.length) return { ok: false, reason: 'Todos os slots estão preenchidos.' }

    const existingColors = filledSlots.map(s => APRICORN_COLOR_MAP[s])
    const hasBlack = existingColors.includes('Preto')
    const hasWhite = existingColors.includes('Branco')

    // Preto e Branco não se misturam
    if (color === 'Branco' && hasBlack) return { ok: false, reason: 'Apricorn Preto e Branco não podem se misturar.' }
    if (color === 'Preto' && hasWhite) return { ok: false, reason: 'Apricorn Preto e Branco não podem se misturar.' }

    // Arco-íris só pode ser 3° ou posterior
    if (color === 'Arco-íris') {
      if (nextSlotIndex < 2) return { ok: false, reason: 'Arco-íris só pode ser adicionado como 3ª opção ou posterior.' }
      // Os dois primeiros devem ter cores diferentes
      if (filledSlots.length >= 2) {
        const color1 = APRICORN_COLOR_MAP[filledSlots[0]]
        const color2 = APRICORN_COLOR_MAP[filledSlots[1]]
        if (color1 === color2) return { ok: false, reason: 'Para usar Arco-íris no 3° slot, os dois primeiros devem ter cores diferentes.' }
      }
    }

    return { ok: true }
  }

  // Adiciona um Apricorn ao próximo slot disponível
  const handleAddApricornToSlot = (apricornName) => {
    const check = canAddApricorn(apricornName, pokesucoSlots)
    if (!check.ok) {
      alert(check.reason)
      return
    }
    const newSlots = [...pokesucoSlots]
    const nextEmpty = newSlots.findIndex(s => s === null)
    newSlots[nextEmpty] = apricornName
    setPokesucoSlots(newSlots)
    // Resetar campos dinâmicos quando slots mudam
    setPokesucoIntensificar(null)
    setPokesucoDominante(null)
  }

  // Remove um Apricorn de um slot
  const handleRemoveApricornFromSlot = (index) => {
    const newSlots = [...pokesucoSlots]
    newSlots[index] = null
    // Compactar: mover não-nulos para o início
    const compacted = newSlots.filter(s => s !== null)
    while (compacted.length < newSlots.length) compacted.push(null)
    setPokesucoSlots(compacted)
    setPokesucoIntensificar(null)
    setPokesucoDominante(null)
  }

  // Mexer o Suco
  const handleMexerSuco = async () => {
    const filledSlots = pokesucoSlots.filter(s => s !== null)
    if (filledSlots.length === 0) {
      alert('Adicione pelo menos um Apricorn ao suco!')
      return
    }

    // Verificar se Dominante deve ser selecionado
    if (shouldShowDominante(pokesucoSlots) && !pokesucoDominante) {
      alert('Selecione a cor Dominante antes de mexer o suco!')
      return
    }

    // Verificar se Intensificar deve ser selecionado
    if (shouldShowIntensificar(pokesucoSlots) && !pokesucoIntensificar) {
      alert('Selecione a cor Intensificar antes de mexer o suco!')
      return
    }

    // Calcular informações do suco
    const { sucoNome, dominantColor, imagePath, hasRainbow } = calcPokesucoInfo(pokesucoSlots, pokesucoIntensificar, pokesucoDominante)

    // Rolar 1d4 + modificador
    const d4Roll = Math.floor(Math.random() * 4) + 1
    const rollTotal = d4Roll + pokesucoModificador

    // Calcular qualidade
    const qualidade = calcPokesucoQualidade(rollTotal, pokesucoSlots, dominantColor, hasRainbow)

    // Nome final do suco
    const nomeFinal = `${sucoNome} ${qualidade}`
    const timestamp = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })

    // Enviar ao chat geral e de batalha
    await addChatMessage({
      username: currentUser.username,
      text: `🧃 ${currentUser.username} está fazendo um Pokesuco! (1d4+${pokesucoModificador})`,
      timestamp,
      isDiceRoll: true,
      diceResult: rollTotal,
      diceDetails: `1d4(${d4Roll}) + ${pokesucoModificador} = ${rollTotal} → Qualidade: ${qualidade} → ${nomeFinal}`
    })

    // Mensagem de sistema para o usuário
    alert(`🧃 Pokesuco feito!\n\nRolagem: 1d4(${d4Roll}) + ${pokesucoModificador} = ${rollTotal}\nQualidade: ${qualidade}/10\nSuco: ${nomeFinal}`)

    // Descontar Apricorns da mochila
    const apricornCounts = {}
    filledSlots.forEach(a => { apricornCounts[a] = (apricornCounts[a] || 0) + 1 })

    let updatedKeyItems = keyItems.map(item => {
      if (apricornCounts[item.name]) {
        return { ...item, quantity: item.quantity - apricornCounts[item.name] }
      }
      return item
    }).filter(item => item.quantity === undefined || item.quantity > 0)

    // Adicionar suco à mochila
    const existingSuco = updatedKeyItems.find(item => item.name === nomeFinal)
    if (existingSuco) {
      updatedKeyItems = updatedKeyItems.map(item =>
        item.name === nomeFinal ? { ...item, quantity: item.quantity + 1 } : item
      )
    } else {
      updatedKeyItems = [...updatedKeyItems, { name: nomeFinal, quantity: 1 }]
    }

    setKeyItems(updatedKeyItems)

    // Fechar modal e resetar estados
    setShowPokesucoModal(false)
    setPokesucoSlots([null, null, null])
    setPokesucoModificador(0)
    setPokesucoIntensificar(null)
    setPokesucoDominante(null)
  }

  // Criar Puffin
  const handleCriarPuffin = () => {
    const filledSlots = puffinSlots.filter(s => s !== null)
    if (filledSlots.length === 0) {
      alert('Adicione pelo menos uma fruta!')
      return
    }

    // Contar sabores das 5 primeiras frutas
    const first5 = puffinSlots.slice(0, 5).filter(s => s !== null)
    const flavorCounts = {}
    first5.forEach(fruitName => {
      getFruitFlavors(fruitName).forEach(f => {
        flavorCounts[f] = (flavorCounts[f] || 0) + 1
      })
    })

    if (Object.keys(flavorCounts).length === 0) {
      alert('As frutas selecionadas não possuem sabores reconhecidos!')
      return
    }

    const maxCount = Math.max(...Object.values(flavorCounts))
    const topFlavors = Object.keys(flavorCounts).filter(f => flavorCounts[f] === maxCount)
    const shuffled = [...topFlavors].sort(() => Math.random() - 0.5)
    const primaryFlavor = shuffled[0]
    const secondaryFlavor = shuffled.length >= 2 ? shuffled[1] : null

    // Verificar aroma das frutas além da 5ª
    let aroma = null
    const extraSlots = puffinSlots.slice(5).filter(s => s !== null)
    if (extraSlots.length > 0) {
      const totalCounts = { ...flavorCounts }
      extraSlots.forEach(fruitName => {
        getFruitFlavors(fruitName).forEach(f => {
          totalCounts[f] = (totalCounts[f] || 0) + 1
        })
      })
      const totalMax = Math.max(...Object.values(totalCounts))
      const totalTop = Object.keys(totalCounts).filter(f => totalCounts[f] === totalMax)
      const newDominant = totalTop[Math.floor(Math.random() * totalTop.length)]
      if (newDominant !== primaryFlavor) aroma = newDominant
    }

    // Montar nome do puffin
    let baseName = `Puffin ${primaryFlavor}`
    if (secondaryFlavor) baseName += ` ${secondaryFlavor}`
    let fullName = aroma ? `${baseName} (${aroma})` : baseName
    fullName = `${fullName} ${maxCount}`

    // Descontar frutas da mochila
    const fruitCounts = {}
    filledSlots.forEach(f => { fruitCounts[f] = (fruitCounts[f] || 0) + 1 })
    let updatedKeyItems = keyItems.map(item => {
      if (fruitCounts[item.name]) {
        return { ...item, quantity: item.quantity - fruitCounts[item.name] }
      }
      return item
    }).filter(item => item.quantity === undefined || item.quantity > 0)

    // Adicionar puffin à mochila
    const existing = updatedKeyItems.find(item => item.name === fullName)
    if (existing) {
      updatedKeyItems = updatedKeyItems.map(item =>
        item.name === fullName ? { ...item, quantity: item.quantity + 1 } : item
      )
    } else {
      updatedKeyItems = [...updatedKeyItems, { name: fullName, quantity: 1 }]
    }

    setKeyItems(updatedKeyItems)
    setShowFazerPuffinModal(false)
    setPuffinSlots([null, null, null, null, null])
    setPuffinSlotDropdown(null)
    alert(`🐦 Puffin criado!\n\n${fullName}`)
  }

  // Calcular ganhos de aptidão de um puffin para um pokémon específico
  const calculateSnackGains = (puffinName, pokemon) => {
    const { primaryFlavor, secondaryFlavor, aroma, valor } = parsePuffinName(puffinName)
    if (!primaryFlavor || valor === 0) return {}
    const nature = natures.find(n => n.nome === pokemon.nature)
    const favFlavor = pokemon.favoriteFlavor || nature?.gosto || 'Nenhum'
    const dislikeFlavor = pokemon.dislikedFlavor || nature?.desgosto || 'Nenhum'
    const isBase = !secondaryFlavor
    const isAromatized = !!aroma
    const gains = {}

    const applyGain = (aptKey, amount) => {
      if (!aptKey || amount <= 0) return
      gains[aptKey] = (gains[aptKey] || 0) + amount
    }

    if (isBase) {
      const apt = FLAVOR_TO_APTIDAO[primaryFlavor]
      if (isAromatized) {
        // O aroma domina o sabor: aptidão do sabor base, multiplicador determinado pelo aroma
        if (aroma === favFlavor && favFlavor !== 'Nenhum') applyGain(apt, valor + 1)
        else if (aroma === dislikeFlavor && dislikeFlavor !== 'Nenhum') applyGain(apt, Math.floor(valor / 2))
        else applyGain(apt, valor)
      } else {
        if (primaryFlavor === favFlavor && favFlavor !== 'Nenhum') applyGain(apt, valor + 1)
        else if (primaryFlavor === dislikeFlavor && dislikeFlavor !== 'Nenhum') applyGain(apt, Math.floor(valor / 2))
        else applyGain(apt, valor)
      }
    } else {
      // Meio a meio
      const aptP = FLAVOR_TO_APTIDAO[primaryFlavor]
      const aptS = FLAVOR_TO_APTIDAO[secondaryFlavor]
      if (isAromatized) {
        // Aroma determina o multiplicador; ambas aptidões dos sabores aumentam
        let gainP, gainS
        if (aroma === favFlavor && favFlavor !== 'Nenhum') {
          gainP = Math.floor(valor / 2) + 1
          gainS = Math.floor(valor / 2) + 1
        } else if (aroma === dislikeFlavor && dislikeFlavor !== 'Nenhum') {
          gainP = Math.floor(valor / 4)
          gainS = Math.floor(valor / 4)
        } else {
          gainP = Math.floor(valor / 2)
          gainS = Math.floor(valor / 2)
        }
        applyGain(aptP, gainP)
        applyGain(aptS, gainS)
      } else {
        // Sem aroma: cada sabor calculado individualmente
        const calcGain = (flavor) => {
          if (flavor === favFlavor && favFlavor !== 'Nenhum') return Math.floor(valor / 2) + 1
          if (flavor === dislikeFlavor && dislikeFlavor !== 'Nenhum') return Math.floor(valor / 4)
          return Math.floor(valor / 2)
        }
        applyGain(aptP, calcGain(primaryFlavor))
        applyGain(aptS, calcGain(secondaryFlavor))
      }
    }
    return gains
  }

  // Alimentar pokémon com puffin (Snack)
  const handleFeedSnack = (pokemonIndex, puffinName) => {
    const pokemon = mainTeam[pokemonIndex]
    const consumed = pokemon.puffinsConsumed || 0
    if (consumed >= 5) {
      alert('Este Pokémon já consumiu 5 puffins!')
      return
    }
    const gains = calculateSnackGains(puffinName, pokemon)
    const currentAptidoes = { estilo: 0, beleza: 0, ternura: 0, perspicacia: 0, vigor: 0, ...(pokemon.aptidoes || {}) }
    const newAptidoes = { ...currentAptidoes }
    for (const [key, gain] of Object.entries(gains)) {
      const cur = newAptidoes[key] || 0
      const currentTotal = Object.values(newAptidoes).reduce((s, v) => s + (v || 0), 0)
      const actual = Math.max(0, Math.min(gain, 12 - cur, 20 - currentTotal))
      newAptidoes[key] = cur + actual
    }
    const updatedKeyItems = keyItems.map(item =>
      item.name === puffinName ? { ...item, quantity: item.quantity - 1 } : item
    ).filter(item => item.quantity === undefined || item.quantity > 0)
    const updatedTeam = mainTeam.map((pkm, idx) =>
      idx === pokemonIndex ? { ...pkm, aptidoes: newAptidoes, puffinsConsumed: consumed + 1 } : pkm
    )
    setMainTeam(updatedTeam)
    setKeyItems(updatedKeyItems)
    setSnackDropdownPokemon(null)
  }


  // Sortear qualidade para todos os Pokesucos na Pokéloja
  const handleSortearQualidadeLoja = () => {
    const novasQualidades = {}
    POKESUCO_LOJA_TIPOS.forEach(color => {
      novasQualidades[color] = Math.floor(Math.random() * 10) + 1
    })
    setPokesucoLojaQualidades(novasQualidades)
  }

  // Comprar Pokesuco da Pokéloja
  const handleBuyPokesucoLoja = (item, quality) => {
    if (!quality) {
      alert('Qualidade não sorteada! Clique em "Sortear Qualidade" primeiro.')
      return
    }
    const price = quality * 150
    if (pokemonedas < price) {
      alert(`Pokémoedas insuficientes! Você precisa de ₽${price.toLocaleString()} mas tem apenas ₽${pokemonedas.toLocaleString()}`)
      return
    }

    const nomeFinal = `${item.name} ${quality}`
    setPokemonedas(pokemonedas - price)

    const existingItem = keyItems.find(i => i.name === nomeFinal)
    if (existingItem) {
      setKeyItems(keyItems.map(i => i.name === nomeFinal ? { ...i, quantity: i.quantity + 1 } : i))
    } else {
      setKeyItems([...keyItems, { name: nomeFinal, quantity: 1 }])
    }

    alert(`Você comprou ${nomeFinal} por ₽${price.toLocaleString()}!`)
  }

  // ==================== FIM FUNÇÕES DE POKESUCO ====================

  // Adicionar Pokémon
  const handleAddPokemon = () => {
    const species = pokemonForm.isExotic ? pokemonForm.exoticSpecies : pokemonForm.species

    if (!species) {
      alert('Selecione ou digite uma espécie!')
      return
    }

    if (pokemonForm.isCaptured && !pokemonForm.nickname) {
      alert('Pokémon capturado precisa de um nome!')
      return
    }

    // Se for exótico, verificar se já existe nos dados globais
    if (pokemonForm.isExotic) {
      const existingExotic = globalExoticSpecies.find(e => e.nome === species)

      if (existingExotic) {
        // Espécie exótica já existe - usar dados existentes
        const exoticFullData = existingExotic

        const newPokemon = {
          id: Date.now(),
          nickname: pokemonForm.nickname || species,
          species: species,
          level: pokemonForm.isCaptured ? pokemonForm.level : 1,
          totalXP: pokemonForm.isCaptured ? getTotalXPForLevel(pokemonForm.level) : 0,
          isCaptured: pokemonForm.isCaptured,
          isExotic: true,
          golpes: []
        }

        // Adicionar à Pokédex com dados completos
        if (!pokedex.find(p => p.species === species)) {
          setPokedex([...pokedex, {
            species,
            isCaptured: pokemonForm.isCaptured,
            isExotic: true,
            exoticData: exoticFullData
          }])
        } else {
          setPokedex(pokedex.map(p =>
            p.species === species
              ? { ...p, isCaptured: pokemonForm.isCaptured, exoticData: exoticFullData }
              : p
          ))
        }

        // Se capturado, adicionar ao time ou PC
        if (pokemonForm.isCaptured) {
          if (mainTeam.length < 6) {
            setMainTeam([...mainTeam, newPokemon])
          } else {
            setPcPokemon([...pcPokemon, newPokemon])
          }
        }

        // Resetar formulário
        setPokemonForm({
          nickname: '',
          species: '',
          isCaptured: false,
          isExotic: false,
          level: 1,
          exoticSpecies: '',
          currentXP: 0
        })
        setSpeciesSearch('')
        setShowAddPokemonModal(false)
        return
      } else {
        // Espécie exótica nova - abrir modal para coletar dados
        setExoticDataForm({
          dexNumber: '',
          altura: '',
          peso: '',
          genero: '',
          tipos: [],
          habitats: [''],
          catchRate: '',
          baseExp: '',
          evolucao: '',
          evolucaoNivel: '',
          evolucaoItem: '',
          statusBasais: {
            saude: '',
            ataque: '',
            defesa: '',
            ataqueEspecial: '',
            defesaEspecial: '',
            velocidade: ''
          }
        })
        setShowExoticDataModal(true)
        return
      }
    }

    const newPokemon = {
      id: Date.now(),
      nickname: pokemonForm.nickname || species,
      species: species,
      level: pokemonForm.isCaptured ? pokemonForm.level : 1,
      totalXP: pokemonForm.isCaptured ? getTotalXPForLevel(pokemonForm.level) : 0,
      isCaptured: pokemonForm.isCaptured,
      isExotic: pokemonForm.isExotic,
      golpes: [],
      displacement: POKEMON_DESLOCAMENTO_MAP[species] || null,
      capacities: (() => { const c = POKEMON_CAPACIDADE_MAP[species]; return c ? { forca: c.forca, inteligencia: c.inteligencia, salto: c.salto, others: [] } : null })()
    }

    // Adicionar à Pokédex
    if (!pokedex.find(p => p.species === species)) {
      setPokedex([...pokedex, { species, isCaptured: pokemonForm.isCaptured }])
    } else if (pokemonForm.isCaptured) {
      setPokedex(pokedex.map(p => p.species === species ? { ...p, isCaptured: true } : p))
    }

    // Se capturado, adicionar ao time ou PC
    if (pokemonForm.isCaptured) {
      if (mainTeam.length < 6) {
        setMainTeam([...mainTeam, newPokemon])
      } else {
        setPcPokemon([...pcPokemon, newPokemon])
      }
    }

    // Resetar formulário
    setPokemonForm({
      nickname: '',
      species: '',
      isCaptured: false,
      isExotic: false,
      level: 1,
      exoticSpecies: '',
      currentXP: 0
    })
    setSpeciesSearch('')
    setShowAddPokemonModal(false)
  }

  // Catalogar Pokémon (escanear)
  const catalogPokemon = () => {
    if (!selectedScanPokemon) {
      alert('Por favor, selecione uma espécie para catalogar.')
      return
    }

    const species = selectedScanPokemon.nome || selectedScanPokemon.species

    // Verificar se já existe na pokédex
    const existsInPokedex = pokedex.find(p => p.species === species)

    if (existsInPokedex) {
      alert(`${species} já está catalogado na Pokédex!`)
      return
    }

    // Verificar se é exótico
    const isExotic = selectedScanPokemon.isExotic || false
    const exoticData = isExotic ? selectedScanPokemon : null

    // Adicionar à pokédex como escaneado (não capturado)
    setPokedex([...pokedex, {
      species,
      isScanned: true,
      isCaptured: false,
      isExotic,
      exoticData
    }])

    // Limpar e fechar modal
    setScanSearch('')
    setSelectedScanPokemon(null)
    setShowScanPokemonModal(false)
  }

  // Excluir Pokémon
  const handleDeletePokemon = (index) => {
    if (confirm('Deseja realmente excluir este Pokémon do time?')) {
      const newTeam = mainTeam.filter((_, i) => i !== index)
      setMainTeam(newTeam)
    }
  }

  // Mover Pokémon do Time para o PC
  const moveToPc = (index) => {
    const pokemon = mainTeam[index]
    locallyRemovedFromTeamRef.current.add(pokemon.id)
    const newTeam = mainTeam.filter((_, i) => i !== index)
    const newPc = [...pcPokemon, pokemon]
    setMainTeam(newTeam)
    setPcPokemon(newPc)
    // Salva imediatamente para evitar race condition com subscription Firebase
    // mainTeam primeiro (remoção), depois pcPokemon (adição)
    if (useFirebase && currentUser?.type === 'treinador') {
      saveToFirebase(`trainers/${currentUser.username}/mainTeam`, newTeam)
      saveToFirebase(`trainers/${currentUser.username}/pcPokemon`, newPc)
    }
  }

  // Mover Pokémon do PC para o Time
  const moveToTeam = (index) => {
    if (mainTeam.length >= 6) {
      alert('Time Principal está cheio! Máximo de 6 Pokémon.')
      return
    }
    const pokemon = pcPokemon[index]
    locallyRemovedFromPcRef.current.add(pokemon.id)
    const newPc = pcPokemon.filter((_, i) => i !== index)
    const newTeam = [...mainTeam, pokemon]
    setPcPokemon(newPc)
    setMainTeam(newTeam)
    // Salva imediatamente para evitar race condition com subscription Firebase
    // pcPokemon primeiro (remoção), depois mainTeam (adição)
    if (useFirebase && currentUser?.type === 'treinador') {
      saveToFirebase(`trainers/${currentUser.username}/pcPokemon`, newPc)
      saveToFirebase(`trainers/${currentUser.username}/mainTeam`, newTeam)
    }
  }

  // Excluir Pokémon do PC
  const handleDeleteFromPc = (index) => {
    if (confirm('Deseja realmente excluir este Pokémon do PC?')) {
      const pokemon = pcPokemon[index]
      locallyRemovedFromPcRef.current.add(pokemon.id)
      const newPc = pcPokemon.filter((_, i) => i !== index)
      setPcPokemon(newPc)
      if (useFirebase && currentUser?.type === 'treinador') {
        saveToFirebase(`trainers/${currentUser.username}/pcPokemon`, newPc)
      }
    }
  }

  // Abrir modal de evolução
  const openEvolutionModal = (pokemon, location, index) => {
    setSelectedPokemonForEvolution(pokemon)
    setEvolutionLocation(location)
    setEvolutionPokemonIndex(index)
    setEvolutionSearch('')
    setSelectedEvolutionSpecies(null)
    setShowEvolutionModal(true)
  }

  // Obter lista de opções de evolução (todos os pokémons disponíveis)
  const getEvolutionOptions = () => {
    // Combinar pokémons normais com exóticos
    const allPokemon = [
      ...pokedexData.map(p => ({ nome: p.nome, isExotic: false })),
      ...globalExoticSpecies.map(p => ({ nome: p.nome, isExotic: true }))
    ]

    // Filtrar pela busca
    if (evolutionSearch.trim()) {
      return allPokemon.filter(p =>
        p.nome.toLowerCase().includes(evolutionSearch.toLowerCase())
      )
    }

    return allPokemon
  }

  // Executar evolução do Pokémon
  const handleEvolution = () => {
    if (!selectedEvolutionSpecies || !selectedPokemonForEvolution) return

    const newSpeciesName = selectedEvolutionSpecies.nome
    const isExotic = selectedEvolutionSpecies.isExotic

    // Buscar dados da nova espécie
    let newSpeciesData = null
    if (isExotic) {
      newSpeciesData = globalExoticSpecies.find(p => p.nome === newSpeciesName)
    } else {
      newSpeciesData = pokedexData.find(p => p.nome === newSpeciesName)
    }

    if (!newSpeciesData) {
      alert('Dados da espécie não encontrados!')
      return
    }

    // Criar os novos atributos basais
    const newBaseAttributes = {
      saude: newSpeciesData.statusBasais?.saude || '',
      ataque: newSpeciesData.statusBasais?.ataque || '',
      defesa: newSpeciesData.statusBasais?.defesa || '',
      ataqueEspecial: newSpeciesData.statusBasais?.ataqueEspecial || '',
      defesaEspecial: newSpeciesData.statusBasais?.defesaEspecial || '',
      velocidade: newSpeciesData.statusBasais?.velocidade || ''
    }

    // Atualizar o pokémon - apenas species, baseAttributes, height e weight
    const updatedPokemon = {
      ...selectedPokemonForEvolution,
      species: newSpeciesName,
      isExotic: isExotic,
      baseAttributes: newBaseAttributes,
      height: newSpeciesData.altura || '',
      weight: newSpeciesData.peso || ''
    }

    // Atualizar no time ou PC
    if (evolutionLocation === 'team') {
      setMainTeam(mainTeam.map((p, i) => i === evolutionPokemonIndex ? updatedPokemon : p))
    } else {
      setPcPokemon(pcPokemon.map((p, i) => i === evolutionPokemonIndex ? updatedPokemon : p))
    }

    // Adicionar nova espécie à Pokédex como escaneada e capturada
    const existingEntry = pokedex.find(p => p.species === newSpeciesName)
    if (!existingEntry) {
      // Não existe na Pokédex - adicionar como capturada
      if (isExotic) {
        setPokedex([...pokedex, {
          species: newSpeciesName,
          isCaptured: true,
          isExotic: true,
          exoticData: newSpeciesData
        }])
      } else {
        setPokedex([...pokedex, {
          species: newSpeciesName,
          isCaptured: true
        }])
      }
    } else if (!existingEntry.isCaptured) {
      // Já está escaneada - marcar como capturada
      setPokedex(pokedex.map(p =>
        p.species === newSpeciesName ? { ...p, isCaptured: true } : p
      ))
    }

    // Fechar modal
    setShowEvolutionModal(false)
    setSelectedPokemonForEvolution(null)
    setSelectedEvolutionSpecies(null)
    setEvolutionSearch('')
  }

  // Marcar Pokémon como capturado na Pokédex
  const markAsCaptured = (species) => {
    setPokedex(pokedex.map(p => p.species === species ? { ...p, isCaptured: true } : p))
  }

  // Remover Pokémon da Pokédex
  const removeFromPokedex = (species) => {
    if (confirm(`Tem certeza que deseja remover ${species} da Pokédex?`)) {
      setPokedex(pokedex.filter(p => p.species !== species))
    }
  }

  // Abrir modal de imagem para Pokémon
  const openImageModal = (pokemon) => {
    setSelectedPokemonForImage(pokemon)
    setImageUrl(pokemonImages[sanitizeFirebaseKey(pokemon.id)] || '')
    setImageUploadType('link')
    setShowImageModal(true)
  }

  // Abrir modal de imagem para Pokémon do PC
  const openImagePCModal = (pokemon) => {
    setSelectedPokemonForImage(pokemon)
    setImageUrl(pokemonImages[sanitizeFirebaseKey(pokemon.id)] || '')
    setImageUploadType('link')
    setShowImagePCModal(true)
  }

  // Salvar imagem do Pokémon
  const handleSaveImage = (isPC = false) => {
    const pokemonId = selectedPokemonForImage?.id
    if (!pokemonId) {
      console.error('[Image] Erro: pokemonId não encontrado')
      return
    }

    // Sanitizar o ID para uso como chave do Firebase
    const safeKey = sanitizeFirebaseKey(pokemonId)

    if (imageUploadType === 'link' && imageUrl.trim()) {
      try {
        console.log('[Image] Salvando imagem por URL para pokemon:', pokemonId, 'safeKey:', safeKey, 'URL:', imageUrl.substring(0, 50))
        const newPokemonImages = { ...pokemonImages, [safeKey]: imageUrl }
        setPokemonImages(newPokemonImages)
        setShowImageModal(false)
        setShowImagePCModal(false)
        setImageUrl('')
        setSelectedPokemonForImage(null)
        console.log('[Image] Imagem salva com sucesso!')

      } catch (error) {
        console.error('Erro ao salvar imagem:', error)
        alert('Erro ao salvar imagem. Tente com uma URL menor.')
      }
    } else if (imageUploadType === 'file') {
      // Para upload de arquivo local, usamos FileReader
      const fileInput = document.getElementById(isPC ? 'pokemon-image-file-pc' : 'pokemon-image-file')
      if (fileInput && fileInput.files && fileInput.files[0]) {
        const file = fileInput.files[0]

        // Criar um canvas para redimensionar a imagem
        const reader = new FileReader()
        reader.onload = (e) => {
          const img = new Image()
          img.onload = () => {
            // Redimensionar para no máximo 300x300 para economizar espaço
            const canvas = document.createElement('canvas')
            let width = img.width
            let height = img.height
            const maxSize = 300

            if (width > height && width > maxSize) {
              height = (height * maxSize) / width
              width = maxSize
            } else if (height > maxSize) {
              width = (width * maxSize) / height
              height = maxSize
            }

            canvas.width = width
            canvas.height = height
            const ctx = canvas.getContext('2d')
            ctx.drawImage(img, 0, 0, width, height)

            // Converter para base64 com compressão
            try {
              const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.5)
              console.log('[Image] Salvando imagem por arquivo para pokemon:', pokemonId, 'safeKey:', safeKey, 'Tamanho:', compressedDataUrl.length)
              const newPokemonImages = { ...pokemonImages, [safeKey]: compressedDataUrl }
              setPokemonImages(newPokemonImages)
              setShowImageModal(false)
              setShowImagePCModal(false)
              setImageUrl('')
              setSelectedPokemonForImage(null)

              // Base64 não é salvo no Firebase (apenas URLs persistem)
              console.log('[Image] Imagem base64 definida localmente (não persiste no Firebase)')
            } catch (error) {
              console.error('Erro ao salvar imagem:', error)
              alert('Erro ao salvar imagem. A imagem pode ser muito grande. Tente uma imagem menor ou use URL.')
            }
          }
          img.onerror = () => {
            alert('Erro ao carregar a imagem. Tente outro arquivo.')
          }
          img.src = e.target.result
        }
        reader.onerror = () => {
          alert('Erro ao ler o arquivo. Tente novamente.')
        }
        reader.readAsDataURL(file)
      }
    } else {
      console.log('[Image] Condição não atendida. imageUploadType:', imageUploadType, 'imageUrl:', imageUrl ? 'tem valor' : 'vazio')
    }
  }

  // Salvar dados do Pokémon exótico e adicionar
  const handleSaveExoticData = () => {
    const species = pokemonForm.exoticSpecies

    // Validações básicas
    const tiposValidos = exoticDataForm.tipos.filter(t => t && t.trim() !== '')
    if (!exoticDataForm.altura || !exoticDataForm.peso || tiposValidos.length === 0) {
      alert('Preencha pelo menos Altura, Peso e um Tipo!')
      return
    }

    // Criar objeto de dados completos do Pokémon exótico
    const exoticFullData = {
      nome: species,
      dexNumber: exoticDataForm.dexNumber || 9999,
      altura: parseFloat(exoticDataForm.altura) || 0,
      peso: parseFloat(exoticDataForm.peso) || 0,
      genero: exoticDataForm.genero || 'Desconhecido',
      tipos: exoticDataForm.tipos.filter(t => t.trim() !== ''),
      habitats: exoticDataForm.habitats.filter(h => h.trim() !== ''),
      catchRate: parseInt(exoticDataForm.catchRate) || 0,
      baseExp: parseInt(exoticDataForm.baseExp) || 0,
      evolucao: exoticDataForm.evolucao || null,
      evolucaoNivel: exoticDataForm.evolucaoNivel ? parseInt(exoticDataForm.evolucaoNivel) : null,
      evolucaoItem: exoticDataForm.evolucaoItem || null,
      statusBasais: {
        saude: parseInt(exoticDataForm.statusBasais.saude) || 0,
        ataque: parseInt(exoticDataForm.statusBasais.ataque) || 0,
        defesa: parseInt(exoticDataForm.statusBasais.defesa) || 0,
        ataqueEspecial: parseInt(exoticDataForm.statusBasais.ataqueEspecial) || 0,
        defesaEspecial: parseInt(exoticDataForm.statusBasais.defesaEspecial) || 0,
        velocidade: parseInt(exoticDataForm.statusBasais.velocidade) || 0
      }
    }

    // Adicionar espécie exótica à lista global se ainda não existir
    if (!globalExoticSpecies.find(e => e.nome === species)) {
      setGlobalExoticSpecies([...globalExoticSpecies, exoticFullData])
    } else {
      // Atualizar dados se já existe
      setGlobalExoticSpecies(globalExoticSpecies.map(e =>
        e.nome === species ? exoticFullData : e
      ))
    }

    const newPokemon = {
      id: Date.now(),
      nickname: pokemonForm.nickname || species,
      species: species,
      level: pokemonForm.isCaptured ? pokemonForm.level : 1,
      totalXP: pokemonForm.isCaptured ? getTotalXPForLevel(pokemonForm.level) : 0,
      isCaptured: pokemonForm.isCaptured,
      isExotic: true,
      golpes: []
    }

    // Adicionar à Pokédex com dados completos
    if (!pokedex.find(p => p.species === species)) {
      setPokedex([...pokedex, {
        species,
        isCaptured: pokemonForm.isCaptured,
        isExotic: true,
        exoticData: exoticFullData
      }])
    } else {
      setPokedex(pokedex.map(p =>
        p.species === species
          ? { ...p, isCaptured: pokemonForm.isCaptured, exoticData: exoticFullData }
          : p
      ))
    }

    // Se capturado, adicionar ao time ou PC
    if (pokemonForm.isCaptured) {
      if (mainTeam.length < 6) {
        setMainTeam([...mainTeam, newPokemon])
      } else {
        setPcPokemon([...pcPokemon, newPokemon])
      }
    }

    // Resetar formulários
    setPokemonForm({
      nickname: '',
      species: '',
      isCaptured: false,
      isExotic: false,
      level: 1,
      exoticSpecies: '',
      totalXP: 0
    })

    setShowExoticDataModal(false)
    alert(pokemonForm.isCaptured ? `${species} capturado e adicionado!` : `${species} escaneado e adicionado à Pokédex!`)
  }

  // Função para salvar configurações de Pokémon Exótico
  const handleSaveExoticConfig = () => {
    if (!selectedExoticConfig) return

    // Update exotic species in global list - usando mesma estrutura do exoticFullData
    const updatedExoticData = {
      nome: selectedExoticConfig,
      dexNumber: exoticConfigForm.dexNumber || 9999,
      altura: parseFloat(exoticConfigForm.altura) || 0,
      peso: parseFloat(exoticConfigForm.peso) || 0,
      genero: exoticConfigForm.genero || 'Desconhecido',
      tipos: Array.isArray(exoticConfigForm.tipos) ? exoticConfigForm.tipos.filter(t => t && t.trim() !== '') : [],
      habitats: Array.isArray(exoticConfigForm.habitats) ? exoticConfigForm.habitats.filter(h => h && h.trim() !== '') : [],
      catchRate: 0,
      baseExp: 0,
      evolucao: exoticConfigForm.evolucaoDe || null,
      evolucaoNivel: exoticConfigForm.evolucaoLevel ? parseInt(exoticConfigForm.evolucaoLevel) : null,
      evolucaoItem: exoticConfigForm.evolucaoItem || null,
      statusBasais: {
        saude: parseInt(exoticConfigForm.statusBasais.saude) || 0,
        ataque: parseInt(exoticConfigForm.statusBasais.ataque) || 0,
        defesa: parseInt(exoticConfigForm.statusBasais.defesa) || 0,
        ataqueEspecial: parseInt(exoticConfigForm.statusBasais.ataqueEsp) || 0,
        defesaEspecial: parseInt(exoticConfigForm.statusBasais.defesaEsp) || 0,
        velocidade: parseInt(exoticConfigForm.statusBasais.velocidade) || 0
      },
      habilidades: Array.isArray(exoticConfigForm.habilidades) ? exoticConfigForm.habilidades : [],
      habilidadesAltas: Array.isArray(exoticConfigForm.habilidadesAltas) ? exoticConfigForm.habilidadesAltas : [],
      habilidadesOcultas: Array.isArray(exoticConfigForm.habilidadesOcultas) ? exoticConfigForm.habilidadesOcultas : [],
      minimoLevel: parseInt(exoticConfigForm.minimoLevel) || 5,
      estagio: exoticConfigForm.estagio || 'Básico',
      evolucaoModo: exoticConfigForm.evolucaoModo || null
    }

    // Update global exotic species list
    setGlobalExoticSpecies(globalExoticSpecies.map(e =>
      e.nome === selectedExoticConfig ? updatedExoticData : e
    ))

    // Update all existing Pokémon of this species in team
    setMainTeam(mainTeam.map(pokemon => {
      if (pokemon.isExotic && (pokemon.species === selectedExoticConfig || pokemon.exoticSpecies === selectedExoticConfig)) {
        return {
          ...pokemon,
          exoticData: updatedExoticData
        }
      }
      return pokemon
    }))

    // Update all existing Pokémon of this species in PC
    setPcPokemon(pcPokemon.map(pokemon => {
      if (pokemon.isExotic && (pokemon.species === selectedExoticConfig || pokemon.exoticSpecies === selectedExoticConfig)) {
        return {
          ...pokemon,
          exoticData: updatedExoticData
        }
      }
      return pokemon
    }))

    // Update Pokédex entries
    setPokedex(pokedex.map(entry => {
      if (entry.isExotic && entry.species === selectedExoticConfig) {
        return {
          ...entry,
          exoticData: updatedExoticData
        }
      }
      return entry
    }))

    alert('Configurações da espécie exótica atualizadas! Todos os Pokémon desta espécie foram atualizados automaticamente.')
    setShowExoticConfigModal(false)
    setExoticConfigSearch('')
    setSelectedExoticConfig(null)
  }

  // Função para calcular HP máximo: (3 x Saúde Total) + Nível
  const calculateMaxHP = (pokemon) => {
    const saudeBase = parseInt(pokemon.baseAttributes?.saude) || 0
    const bonusVal = parseInt(pokemon.bonusPoints?.saude) || 0
    const selectedNature = natures.find(n => n.nome === pokemon.nature)
    const isIncreased = selectedNature?.up === 'Saúde'
    const isDecreased = selectedNature?.down === 'Saúde'
    const natureBonus = isIncreased ? 1 : isDecreased ? -1 : 0
    const saudePontos = parseInt(pokemon.levelPoints?.saude) || 0
    const saudeTotal = saudeBase + bonusVal + natureBonus + saudePontos
    return (3 * saudeTotal) + (pokemon.level || 1)
  }

  // Função auxiliar para calcular atributo total com natureza
  const calculateTotalAttribute = (pokemon, attributeKey, attributeLabel) => {
    const baseVal = parseInt(pokemon.baseAttributes?.[attributeKey]) || 0
    const bonusVal = parseInt(pokemon.bonusPoints?.[attributeKey]) || 0
    const selectedNature = natures.find(n => n.nome === pokemon.nature)
    const isIncreased = selectedNature?.up === attributeLabel
    const isDecreased = selectedNature?.down === attributeLabel
    const natureBonus = attributeKey === 'saude' ? (isIncreased ? 1 : isDecreased ? -1 : 0) : (isIncreased ? 2 : isDecreased ? -2 : 0)
    const levelPoints = parseInt(pokemon.levelPoints?.[attributeKey]) || 0
    return baseVal + bonusVal + natureBonus + levelPoints
  }

  // Função para buscar tipos do Pokémon do pokemonData
  const getPokemonTypes = (pokemon) => {
    if (!pokemon) return []

    // Priorizar tipos customizados (editados pelo Elementalista)
    if (pokemon.types && Array.isArray(pokemon.types) && pokemon.types.length > 0) {
      return pokemon.types
    }

    if (!pokemon.species) return []

    // Se for pokémon exótico, buscar tipos da pokédex
    if (pokemon.isExotic) {
      const pokedexEntry = pokedex.find(p => p.species === pokemon.species && p.isExotic)
      if (pokedexEntry && pokedexEntry.exoticData && pokedexEntry.exoticData.tipos) {
        return pokedexEntry.exoticData.tipos
      }
    }

    // Pokémon normal da pokedexData
    const foundPokemon = pokedexData.find(p => p.nome.toLowerCase() === pokemon.species.toLowerCase())
    if (foundPokemon && foundPokemon.tipos) {
      // Converter "Aço" para "Metal" conforme solicitado
      return foundPokemon.tipos.map(tipo => tipo === 'Aço' ? 'Metal' : tipo)
    }
    return []
  }

  // Função para calcular Evasão Física: Defesa / 5 (arredondado para baixo)
  const calculatePhysicalEvasion = (pokemon) => {
    const defesa = calculateTotalAttribute(pokemon, 'defesa', 'Defesa')
    return Math.floor(defesa / 5)
  }

  // Função para calcular Evasão Especial: Defesa Especial / 5 (arredondado para baixo)
  const calculateSpecialEvasion = (pokemon) => {
    const defesaEspecial = calculateTotalAttribute(pokemon, 'defesaEspecial', 'Defesa Especial')
    return Math.floor(defesaEspecial / 5)
  }

  // Função para calcular Evasão Veloz: Velocidade / 10 (arredondado para baixo)
  const calculateSpeedEvasion = (pokemon) => {
    const velocidade = calculateTotalAttribute(pokemon, 'velocidade', 'Velocidade')
    return Math.floor(velocidade / 10)
  }

  // Função para calcular Bônus Elemental: Nível / 5 (arredondado para baixo)
  const calculateElementalBonus = (pokemon) => {
    return Math.floor((pokemon.level || 1) / 5)
  }

  // Função para calcular felicidade máxima: Nível + 5
  const calculateMaxHappiness = (pokemon) => {
    return (pokemon.level || 1) + 5
  }

  // Função para abrir modal de felicidade
  const openHappinessModal = (pokemon, index) => {
    setSelectedPokemonHappinessIndex(index)
    setHappinessAmount('')
    setShowHappinessModal(true)
  }

  // Função para aumentar felicidade (botão Feliz)
  const handleIncreaseHappiness = () => {
    const amount = parseInt(happinessAmount) || 0
    if (amount <= 0) return

    const updatedTeam = [...mainTeam]
    const pokemon = updatedTeam[selectedPokemonHappinessIndex]
    const maxHappiness = calculateMaxHappiness(pokemon)

    pokemon.currentHappiness = Math.min(maxHappiness, (pokemon.currentHappiness || 0) + amount)

    setMainTeam(updatedTeam)
    setShowHappinessModal(false)
    setHappinessAmount('')
  }

  // Função para diminuir felicidade (botão Triste)
  const handleDecreaseHappiness = () => {
    const amount = parseInt(happinessAmount) || 0
    if (amount <= 0) return

    const updatedTeam = [...mainTeam]
    const pokemon = updatedTeam[selectedPokemonHappinessIndex]

    pokemon.currentHappiness = Math.max(0, (pokemon.currentHappiness || 0) - amount)

    setMainTeam(updatedTeam)
    setShowHappinessModal(false)
    setHappinessAmount('')
  }

  // Abrir modal de captura
  const openCaptureModal = (species) => {
    setPokemonToCapture(species)
    setCaptureForm({ nickname: '', level: 5 })
    setShowCaptureModal(true)
  }

  // Confirmar captura de Pokémon
  const handleCapturePokemon = () => {
    if (!captureForm.nickname.trim()) {
      alert('Por favor, digite um nome para o Pokémon!')
      return
    }

    const newPokemon = {
      id: Date.now(),
      nickname: captureForm.nickname,
      species: pokemonToCapture,
      level: captureForm.level,
      totalXP: getTotalXPForLevel(captureForm.level),
      currentHP: 0, // Será calculado depois
      currentHappiness: 0, // Felicidade inicial
      isCaptured: true,
      isExotic: false,
      golpes: []
    }

    // Calcular HP máximo e definir HP atual como máximo
    const maxHP = calculateMaxHP(newPokemon)
    newPokemon.currentHP = maxHP

    // Marcar como capturado na Pokédex
    markAsCaptured(pokemonToCapture)

    // Adicionar ao time ou PC
    if (mainTeam.length < 6) {
      setMainTeam([...mainTeam, newPokemon])
      alert(`${pokemonToCapture} capturado e adicionado ao Time Principal!`)
    } else {
      setPcPokemon([...pcPokemon, newPokemon])
      alert(`Time cheio! ${pokemonToCapture} capturado e enviado ao PC.`)
    }

    setShowCaptureModal(false)
    setCaptureForm({ nickname: '', level: 5 })
    setPokemonToCapture(null)
  }

  // Função para abrir modal de edição de Pokémon
  const openEditPokemonModal = (pokemon, location, index) => {
    setEditingPokemon({ ...pokemon, index })
    setEditingPokemonLocation(location)

    // Buscar atributos basais do pokemonData por espécie
    let baseAttributesFromData = {
      saude: '',
      ataque: '',
      defesa: '',
      ataqueEspecial: '',
      defesaEspecial: '',
      velocidade: ''
    }

    // Procurar o Pokémon na Pokédex pelo nome da espécie
    const pokemonSpecies = pokemon.species || pokemon.nickname

    // Verificar primeiro se é exótico
    if (pokemon.isExotic) {
      const exoticData = globalExoticSpecies.find(e => e.nome === pokemonSpecies)
      if (exoticData && exoticData.statusBasais) {
        baseAttributesFromData = {
          saude: exoticData.statusBasais.saude || '',
          ataque: exoticData.statusBasais.ataque || '',
          defesa: exoticData.statusBasais.defesa || '',
          ataqueEspecial: exoticData.statusBasais.ataqueEspecial || '',
          defesaEspecial: exoticData.statusBasais.defesaEspecial || '',
          velocidade: exoticData.statusBasais.velocidade || ''
        }
      }
    } else {
      const foundPokemon = pokedexData.find(p => p.nome.toLowerCase() === pokemonSpecies.toLowerCase())
      if (foundPokemon && foundPokemon.statusBasais) {
        baseAttributesFromData = {
          saude: foundPokemon.statusBasais.saude || '',
          ataque: foundPokemon.statusBasais.ataque || '',
          defesa: foundPokemon.statusBasais.defesa || '',
          ataqueEspecial: foundPokemon.statusBasais.ataqueEspecial || '',
          defesaEspecial: foundPokemon.statusBasais.defesaEspecial || '',
          velocidade: foundPokemon.statusBasais.velocidade || ''
        }
      }
    }

    // Buscar peso e altura da espécie se não existirem no pokémon
    let weightFromData = ''
    let heightFromData = ''
    if (pokemon.isExotic) {
      const exoticData = globalExoticSpecies.find(e => e.nome === pokemonSpecies)
      if (exoticData) {
        weightFromData = exoticData.peso || ''
        heightFromData = exoticData.altura || ''
      }
    } else {
      const foundPokemon = pokedexData.find(p => p.nome.toLowerCase() === pokemonSpecies.toLowerCase())
      if (foundPokemon) {
        weightFromData = foundPokemon.peso || ''
        heightFromData = foundPokemon.altura || ''
      }
    }

    // Preencher formulário com dados existentes ou buscar do pokemonData
    const rawDiet = pokemon.dieta || POKEMON_DIET_MAP[pokemon.species || pokemon.nickname] || ''
    const dietParts = rawDiet ? rawDiet.split(' e ').map(d => d.trim()) : []
    setPokemonEditForm({
      shiny: pokemon.shiny || false,
      legendary: pokemon.legendary || false,
      nature: pokemon.nature || '',
      gender: pokemon.gender || '',
      baseAttributes: pokemon.baseAttributes || baseAttributesFromData,
      levelPoints: pokemon.levelPoints || {
        saude: '',
        ataque: '',
        defesa: '',
        ataqueEspecial: '',
        defesaEspecial: '',
        velocidade: ''
      },
      bonusPoints: pokemon.bonusPoints || {
        saude: '',
        ataque: '',
        defesa: '',
        ataqueEspecial: '',
        defesaEspecial: '',
        velocidade: ''
      },
      displacement: pokemon.displacement || POKEMON_DESLOCAMENTO_MAP[pokemon.species || pokemon.nickname] || {
        terrestre: '',
        nadar: '',
        voar: '',
        cavar: '',
        submerso: ''
      },
      weight: pokemon.weight || weightFromData,
      height: pokemon.height || heightFromData,
      loyalty: pokemon.loyalty || '',
      capacities: {
        forca: pokemon.capacities?.forca || POKEMON_CAPACIDADE_MAP[pokemon.species || pokemon.nickname]?.forca || '',
        inteligencia: pokemon.capacities?.inteligencia || POKEMON_CAPACIDADE_MAP[pokemon.species || pokemon.nickname]?.inteligencia || '',
        salto: pokemon.capacities?.salto || POKEMON_CAPACIDADE_MAP[pokemon.species || pokemon.nickname]?.salto || '',
        others: pokemon.capacities?.others || []
      },
      dietaSlot1: dietParts[0] || '',
      dietaSlot2: dietParts[1] || ''
    })
    setNatureSearch('')
    setShowDietSlotDropdown(null)
    setShowEditPokemonModal(true)
  }

  // Função para abrir modal de edição de Pokémon do PC
  const openEditPokemonPCModal = (pokemon, index) => {
    setEditingPokemon({ ...pokemon, index })
    setEditingPokemonLocation('pc')

    // Buscar atributos basais do pokemonData por espécie
    let baseAttributesFromData = {
      saude: '',
      ataque: '',
      defesa: '',
      ataqueEspecial: '',
      defesaEspecial: '',
      velocidade: ''
    }

    // Procurar o Pokémon na Pokédex pelo nome da espécie
    const pokemonSpecies = pokemon.species || pokemon.nickname

    // Verificar primeiro se é exótico
    if (pokemon.isExotic) {
      const exoticData = globalExoticSpecies.find(e => e.nome === pokemonSpecies)
      if (exoticData && exoticData.statusBasais) {
        baseAttributesFromData = {
          saude: exoticData.statusBasais.saude || '',
          ataque: exoticData.statusBasais.ataque || '',
          defesa: exoticData.statusBasais.defesa || '',
          ataqueEspecial: exoticData.statusBasais.ataqueEspecial || '',
          defesaEspecial: exoticData.statusBasais.defesaEspecial || '',
          velocidade: exoticData.statusBasais.velocidade || ''
        }
      }
    } else {
      const foundPokemon = pokedexData.find(p => p.nome.toLowerCase() === pokemonSpecies.toLowerCase())
      if (foundPokemon && foundPokemon.statusBasais) {
        baseAttributesFromData = {
          saude: foundPokemon.statusBasais.saude || '',
          ataque: foundPokemon.statusBasais.ataque || '',
          defesa: foundPokemon.statusBasais.defesa || '',
          ataqueEspecial: foundPokemon.statusBasais.ataqueEspecial || '',
          defesaEspecial: foundPokemon.statusBasais.defesaEspecial || '',
          velocidade: foundPokemon.statusBasais.velocidade || ''
        }
      }
    }

    // Buscar peso e altura da espécie se não existirem no pokémon
    let weightFromData = ''
    let heightFromData = ''
    if (pokemon.isExotic) {
      const exoticData = globalExoticSpecies.find(e => e.nome === pokemonSpecies)
      if (exoticData) {
        weightFromData = exoticData.peso || ''
        heightFromData = exoticData.altura || ''
      }
    } else {
      const foundPokemon = pokedexData.find(p => p.nome.toLowerCase() === pokemonSpecies.toLowerCase())
      if (foundPokemon) {
        weightFromData = foundPokemon.peso || ''
        heightFromData = foundPokemon.altura || ''
      }
    }

    // Preencher formulário com dados existentes ou buscar do pokemonData
    const rawDiet = pokemon.dieta || POKEMON_DIET_MAP[pokemon.species || pokemon.nickname] || ''
    const dietParts = rawDiet ? rawDiet.split(' e ').map(d => d.trim()) : []
    setPokemonEditForm({
      shiny: pokemon.shiny || false,
      legendary: pokemon.legendary || false,
      nature: pokemon.nature || '',
      gender: pokemon.gender || '',
      baseAttributes: pokemon.baseAttributes || baseAttributesFromData,
      levelPoints: pokemon.levelPoints || {
        saude: '',
        ataque: '',
        defesa: '',
        ataqueEspecial: '',
        defesaEspecial: '',
        velocidade: ''
      },
      bonusPoints: pokemon.bonusPoints || {
        saude: '',
        ataque: '',
        defesa: '',
        ataqueEspecial: '',
        defesaEspecial: '',
        velocidade: ''
      },
      displacement: pokemon.displacement || POKEMON_DESLOCAMENTO_MAP[pokemon.species || pokemon.nickname] || {
        terrestre: '',
        nadar: '',
        voar: '',
        cavar: '',
        submerso: ''
      },
      weight: pokemon.weight || weightFromData,
      height: pokemon.height || heightFromData,
      loyalty: pokemon.loyalty || '',
      capacities: {
        forca: pokemon.capacities?.forca || POKEMON_CAPACIDADE_MAP[pokemon.species || pokemon.nickname]?.forca || '',
        inteligencia: pokemon.capacities?.inteligencia || POKEMON_CAPACIDADE_MAP[pokemon.species || pokemon.nickname]?.inteligencia || '',
        salto: pokemon.capacities?.salto || POKEMON_CAPACIDADE_MAP[pokemon.species || pokemon.nickname]?.salto || '',
        others: pokemon.capacities?.others || []
      },
      dietaSlot1: dietParts[0] || '',
      dietaSlot2: dietParts[1] || ''
    })
    setNatureSearch('')
    setShowDietSlotDropdown(null)
    setShowEditPokemonPCModal(true)
  }

  // Função para salvar edição de Pokémon
  const handleSaveEditPokemon = () => {
    const { dietaSlot1, dietaSlot2, ...formData } = pokemonEditForm
    const slotDiets = [dietaSlot1, dietaSlot2].filter(Boolean)
    const dieta = slotDiets.length > 0 ? slotDiets.join(' e ') : null
    const updatedPokemon = {
      ...editingPokemon,
      ...formData,
      dieta
    }

    if (editingPokemonLocation === 'team') {
      const updatedTeam = [...mainTeam]
      updatedTeam[editingPokemon.index] = updatedPokemon
      setMainTeam(updatedTeam)
    } else if (editingPokemonLocation === 'pc') {
      const updatedPc = [...pcPokemon]
      updatedPc[editingPokemon.index] = updatedPokemon
      setPcPokemon(updatedPc)
    }

    setShowEditPokemonModal(false)
    setEditingPokemon(null)
    setEditingPokemonLocation(null)
  }

  // Função para abrir modal de visualização de informações do Pokémon
  const openPokemonInfoModal = (pokemon) => {
    setViewingPokemon(pokemon)
    setShowPokemonInfoModal(true)
  }

  // Funções para modal de edição de Aptidões
  const openAptidoesModal = (pokemon, location, index) => {
    setAptidoesEditingPokemon({ pokemon, location, index })
    setAptidoesTempValues(pokemon.aptidoes || { estilo: 0, beleza: 0, ternura: 0, perspicacia: 0, vigor: 0 })
    setShowAptidoesModal(true)
  }

  const updateAptidao = (key, delta) => {
    setAptidoesTempValues(prev => {
      const current = prev[key] || 0
      const newVal = Math.max(0, Math.min(12, current + delta))
      const others = Object.entries(prev).filter(([k]) => k !== key).reduce((s, [, v]) => s + (v || 0), 0)
      const capped = Math.min(newVal, 20 - others)
      return { ...prev, [key]: capped }
    })
  }

  const saveAptidoes = () => {
    if (!aptidoesEditingPokemon) return
    const { pokemon, location, index } = aptidoesEditingPokemon
    const updatedPokemon = { ...pokemon, aptidoes: aptidoesTempValues }
    if (location === 'team') {
      const updatedTeam = [...mainTeam]
      updatedTeam[index] = updatedPokemon
      setMainTeam(updatedTeam)
    } else {
      const updatedPc = [...pcPokemon]
      updatedPc[index] = updatedPokemon
      setPcPokemon(updatedPc)
    }
    setShowAptidoesModal(false)
    setAptidoesEditingPokemon(null)
  }

  // Função para abrir modal de Dano/Cura de Pokémon
  const openPokemonHPModal = (pokemon, index) => {
    setSelectedPokemonHP(pokemon)
    setSelectedPokemonHPIndex(index)
    setHpAmount('')
    setShowPokemonHPModal(true)
  }

  // Função para aplicar dano ao Pokémon
  const handleDamagePokemon = () => {
    let damage = parseInt(hpAmount) || 0
    if (damage <= 0) return

    // Aplicar multiplicador de dano
    damage = applyDamageMultiplier(damage)

    const updatedTeam = [...mainTeam]
    const pokemon = updatedTeam[selectedPokemonHPIndex]

    let remainingDamage = damage
    
    // Primeiro, subtrair do HP Temporário
    if (pokemon.temporaryHP && pokemon.temporaryHP > 0) {
      if (pokemon.temporaryHP >= remainingDamage) {
        // HP Temporário absorve todo o dano
        pokemon.temporaryHP -= remainingDamage
        remainingDamage = 0
      } else {
        // HP Temporário absorve parte do dano
        remainingDamage -= pokemon.temporaryHP
        pokemon.temporaryHP = 0
      }
    }
    
    // Se ainda houver dano restante, aplicar ao HP normal
    if (remainingDamage > 0) {
      pokemon.currentHP = Math.max(0, (pokemon.currentHP || 0) - remainingDamage)
    }

    setMainTeam(updatedTeam)

    // Sincronizar HP com listas de batalha
    const syncedPkm = updatedTeam[selectedPokemonHPIndex]
    const newHPDmg = syncedPkm.currentHP
    const origIdDmg = syncedPkm.id || `team-${syncedPkm.species}`
    const matchDmg = (bp) => !bp.isNpc && (bp.originalId === origIdDmg || (bp.owner === currentUser?.username && bp.especie === syncedPkm.species && bp.nome === (syncedPkm.nickname || syncedPkm.species)))
    let updBP = battlePokemon
    let updBPL = battlePokemonList
    let changedDmg = false
    if (battlePokemon.some(matchDmg)) { updBP = battlePokemon.map(bp => matchDmg(bp) ? { ...bp, hp: newHPDmg } : bp); setBattlePokemon(updBP); changedDmg = true }
    if (battlePokemonList.some(matchDmg)) { updBPL = battlePokemonList.map(bp => matchDmg(bp) ? { ...bp, hp: newHPDmg } : bp); setBattlePokemonList(updBPL); changedDmg = true }
    if (changedDmg && useFirebase) { saveBattleData({ battleTrainers, battlePokemon: updBP, battleTrainersList, battlePokemonList: updBPL, currentTrainerTurn, currentPokemonTurn, trainerRound, pokemonRound, battlePokemonConditions, revealedNpcPokemon, revealedTrainers }) }

    setShowPokemonHPModal(false)
    setHpAmount('')
    setDamageMultiplier(null)
  }

  // Função para curar o Pokémon
  const handleHealPokemon = () => {
    const heal = parseInt(hpAmount) || 0
    if (heal <= 0) return

    const updatedTeam = [...mainTeam]
    const pokemon = updatedTeam[selectedPokemonHPIndex]
    const maxHP = calculateMaxHP(pokemon)
    pokemon.currentHP = Math.min(maxHP, (pokemon.currentHP || 0) + heal)

    setMainTeam(updatedTeam)

    // Sincronizar HP com listas de batalha
    const newHPHeal = pokemon.currentHP
    const origIdHeal = pokemon.id || `team-${pokemon.species}`
    const matchHeal = (bp) => !bp.isNpc && (bp.originalId === origIdHeal || (bp.owner === currentUser?.username && bp.especie === pokemon.species && bp.nome === (pokemon.nickname || pokemon.species)))
    let updBPH = battlePokemon
    let updBPLH = battlePokemonList
    let changedHeal = false
    if (battlePokemon.some(matchHeal)) { updBPH = battlePokemon.map(bp => matchHeal(bp) ? { ...bp, hp: newHPHeal } : bp); setBattlePokemon(updBPH); changedHeal = true }
    if (battlePokemonList.some(matchHeal)) { updBPLH = battlePokemonList.map(bp => matchHeal(bp) ? { ...bp, hp: newHPHeal } : bp); setBattlePokemonList(updBPLH); changedHeal = true }
    if (changedHeal && useFirebase) { saveBattleData({ battleTrainers, battlePokemon: updBPH, battleTrainersList, battlePokemonList: updBPLH, currentTrainerTurn, currentPokemonTurn, trainerRound, pokemonRound, battlePokemonConditions, revealedNpcPokemon, revealedTrainers }) }

    setShowPokemonHPModal(false)
    setHpAmount('')
  }
  // Função para abrir modal de HP Temporário
  const openTempHPModal = (pokemon, index) => {
    setSelectedPokemonForTempHP(pokemon)
    setSelectedPokemonTempHPIndex(index)
    setTempHPAmount(pokemon.temporaryHP || '')
    setShowTempHPModal(true)
  }

  // Função para salvar HP Temporário
  const handleSaveTempHP = () => {
    const tempHP = parseInt(tempHPAmount) || 0
    
    const updatedTeam = [...mainTeam]
    const pokemon = updatedTeam[selectedPokemonTempHPIndex]
    pokemon.temporaryHP = tempHP

    setMainTeam(updatedTeam)
    setShowTempHPModal(false)
    setTempHPAmount('')
  }

  // Função para curar todos os Pokémon do time (EstagiAyla Joy)
  const healAllPokemon = () => {
    const updatedTeam = mainTeam.map(pokemon => {
      const maxHP = calculateMaxHP(pokemon)
      return { ...pokemon, currentHP: maxHP }
    })
    setMainTeam(updatedTeam)
    alert('Todos os Pokémon foram curados pela EstagiAyla Joy! 💚')
  }

  // Adicionar XP
  const handleAddXP = () => {
    const baseXp = parseInt(xpToAdd) || 0
    if (baseXp <= 0) return

    // Calcular bônus
    let bonusXp = 0
    if (xpBonus) {
      const bonusStr = xpBonus.trim()
      if (bonusStr.endsWith('%')) {
        // É uma porcentagem
        const percentage = parseFloat(bonusStr.slice(0, -1)) || 0
        bonusXp = Math.floor((baseXp * percentage) / 100)
      } else {
        // É um valor inteiro
        bonusXp = parseInt(bonusStr) || 0
      }
    }

    const totalXp = baseXp + bonusXp

    const updatedTeam = [...mainTeam]
    const pokemon = updatedTeam[selectedPokemonIndex]

    const oldLevel = pokemon.level || 1
    const oldMaxHappiness = calculateMaxHappiness(pokemon)

    // Adiciona XP ao total acumulado
    const newTotalXP = (pokemon.totalXP || 0) + totalXp

    // Descobre qual nível o Pokémon deve estar com essa XP total
    let newLevel = oldLevel
    while (newLevel < 100 && newTotalXP >= getTotalXPForLevel(newLevel + 1)) {
      newLevel++
    }

    pokemon.level = newLevel
    pokemon.totalXP = newTotalXP

    // Lógica de felicidade quando sobe de nível
    if (newLevel > oldLevel) {
      const newMaxHappiness = calculateMaxHappiness(pokemon)
      const currentHappiness = pokemon.currentHappiness || 0

      // Se estava no máximo da felicidade, ajusta para o novo máximo
      if (currentHappiness >= oldMaxHappiness) {
        pokemon.currentHappiness = newMaxHappiness
      } else {
        // Se não estava no máximo, ganha 5 de felicidade
        pokemon.currentHappiness = Math.min(newMaxHappiness, currentHappiness + 5)
      }
    }

    updatedTeam[selectedPokemonIndex] = pokemon
    setMainTeam(updatedTeam)
    setXpToAdd('')
    setXpBonus('')
    setShowXPModal(false)
  }

  // Função para atribuir habilidades a um Pokémon NPC
  const assignAbilitiesToPokemon = (pokemon) => {
    // Usar 'species' ou 'name' como fallback
    const species = pokemon.species || pokemon.name
    const level = pokemon.level || 1
    const pokemonAbilities = POKEMON_ABILITIES[species]

    if (!pokemonAbilities) {
      console.warn(`Nenhuma habilidade encontrada para ${species}`)
      return pokemon
    }

    const { habilidades, altasHabilidades } = pokemonAbilities
    const allAbilities = []

    // Se level >= 40, pode ter altas habilidades
    if (level >= 40) {
      allAbilities.push(...habilidades, ...altasHabilidades)
    } else {
      // Abaixo do level 40, apenas habilidades normais
      allAbilities.push(...habilidades)
    }

    // Escolher aleatoriamente a primeira habilidade
    const habilidade1 = allAbilities.length > 0
      ? allAbilities[Math.floor(Math.random() * allAbilities.length)]
      : null

    // Segunda habilidade apenas se level >= 40
    let habilidade2 = null
    if (level >= 40 && allAbilities.length > 1) {
      // Filtrar para não repetir a primeira habilidade
      const remainingAbilities = allAbilities.filter(h => h !== habilidade1)
      if (remainingAbilities.length > 0) {
        habilidade2 = remainingAbilities[Math.floor(Math.random() * remainingAbilities.length)]
      }
    }

    return {
      ...pokemon,
      habilidade1,
      habilidade2
    }
  }

  // Determina a região de um pokémon pelo nome/dexNumber (portado do Pokedéx_RPG.html)
  const pegarRegiao = (pokemon) => {
    if (pokemon.nome.includes('Alola')) return 'Alola'
    if (pokemon.nome.includes('Galar')) return 'Galar'
    if (pokemon.nome.includes('Hisui')) return 'Sinnoh'
    if (pokemon.nome.includes('Paldea')) return 'Paldea'
    if (pokemon.nome.includes('Arceus')) return 'Sinnoh'
    const d = pokemon.dexNumber
    if (d <= 151) return 'Kanto'
    if (d <= 251) return 'Johto'
    if (d <= 386 || [10001,10002,10003].includes(d)) return 'Hoenn'
    if (d <= 493 || [10004,10005,10006,10007,10008,10009,10010,10011,10012,10229,10230,10231,10232,10233,10234,10235,10236,10237,10238,10239,10240,10241,10242,10243,10244].includes(d)) return 'Sinnoh'
    if (d <= 649) return 'Unova'
    if (d <= 721 || [10118,10120,10086].includes(d)) return 'Kalos'
    if (d <= 809 || [10091,10092,10100,10101,10102,10103,10104,10105,10106,10107,10108,10109,10110,10111,10112,10113,10114,10115].includes(d)) return 'Alola'
    if (d <= 905 || [10161,10162,10163,10164,10165,10166,10167,10168,10169,10170,10171,10172,10173,10174,10175,10176,10177,10178,10179,10180].includes(d)) return 'Galar'
    if (d <= 1025 || [10273,10274,10275,10250,10251,10252,10253,10276,10277].includes(d)) return 'Paldea'
    return 'Desconhecida'
  }

  // Gerar um Pokémon NPC completo para o Hub de Troca
  const TRADE_BANNED_POKEMON = new Set([
    'Arceus','Articuno','Azelf','Blacephalon','Buzzwole','Calyrex','Celebi','Celesteela',
    'Cobalion','Cosmoem','Cosmog','Cresselia','Darkrai','Deoxys','Dialga','Diancie',
    'Enamorus','Entei','Eternatus','G-Max Melmetal','G-Max Urshifu','Genesect','Giratina',
    'Glastrier','Groudon','Guzzlord','Heatran','Ho-oh','Hoopa','Jirachi','Kartana',
    'Keldeo','Kubfu','Kyogre','Kyurem','Landorus','Latias','Latios','Lugia','Lunala',
    'Magearna','Manaphy','Marshadow','Melmetal','Meloetta','Meltan','Mesprit','Mew',
    'Mewtwo','Moltres','Naganadel','Necrozma','Nihilego','Palkia','Pheromosa','Phione',
    'Poipole','Primal Groudon','Primal Kyogre','Raikou','Rayquaza','Regice','Regidrago',
    'Regieleki','Regigigas','Regirock','Registeel','Reshiram','Shaymin','Silvally',
    'Solgaleo','Spectrier','Stakataka','Suicune','Tapu Bulu','Tapu Fini','Tapu Koko',
    'Tapu Lele','Terrakion','Thundurus','Tornadus','Type: Null','Urshifu','Uxie',
    'Victini','Virizion','Volcanion','Xerneas','Xurkitree','Yveltal','Zacian',
    'Zamazenta','Zapdos','Zarude','Zekrom','Zeraora',
    'Gouging Fire','Raging Bolt','Walking Wake',
    'Wyrdeer','Kleavor','Ursaluna','Basculegion','Sneasler','Overqwil'
  ])

  const isTradeBanned = (name) => TRADE_BANNED_POKEMON.has(name) || name.includes('Arceus') || name.includes('Deoxys') || name.includes('Genesect') || name.includes('Shaymin') || name.includes('Zygarde') || name.includes('Giratina') || name.includes('Hisui')

  const generateRandomNpcPokemon = (level, filterBanned, pool = null) => {
    const src = pool && pool.length > 0 ? pool : pokedexData
    let species = src[Math.floor(Math.random() * src.length)]
    if (filterBanned) {
      while (isTradeBanned(species.nome)) {
        species = src[Math.floor(Math.random() * src.length)]
      }
    }
    const nature = NATURES[Math.floor(Math.random() * NATURES.length)]
    const baseStats = {...species.statusBasais}
    const statsWithNature = applyNature(baseStats, nature)
    const hierarchy = getStatHierarchy(statsWithNature)
    const finalStats = distributePoints(statsWithNature, hierarchy, level)
    const gender = generateGender(species.genero)
    const shiny = Math.random() < (1 / 4096)
    const baseExp = species.baseExp || 50
    const xpTotal = baseExp * level

    // Categoria de tamanho
    const r = Math.random() * 100
    let mult = 1.0
    if (r < 1) mult = 0.75 + Math.random() * 0.10
    else if (r < 8) mult = 0.85 + Math.random() * 0.10
    else if (r < 92) mult = 0.95 + Math.random() * 0.10
    else if (r < 99) mult = 1.05 + Math.random() * 0.10
    else mult = 1.15 + Math.random() * 0.10

    const imageUrl = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${shiny ? 'shiny/' : ''}${species.dexNumber}.png`

    const golpesAprendidos = generatePokemonMoves(species.nome, level, false, gender)

    const pokemon = {
      id: `trade-pkm-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
      species: species.nome,
      name: species.nome,
      level,
      types: species.tipos,
      nature,
      baseAttributes: species.statusBasais,
      attributes: finalStats,
      imageUrl,
      shiny,
      gender,
      dexNumber: species.dexNumber,
      catchRate: species.catchRate,
      experience: xpTotal,
      baseExp,
      totalXP: xpTotal,
      weight: parseFloat((species.peso * mult).toFixed(2)),
      height: parseFloat((species.altura * mult).toFixed(2)),
      habitats: species.habitats || [],
      golpesAprendidos,
      migration: false,
      migrationRegion: null
    }

    return assignAbilitiesToPokemon(pokemon)
  }

  // Gerar 20 ofertas de troca
  const generateTradeOffers = () => {
    const ofPool = (() => { const f = pokedexData.filter(p => tradeHubRegioesOferecidos.length === 0 || tradeHubRegioesOferecidos.includes(pegarRegiao(p))); return f.length > 0 ? f : pokedexData })()
    const reqPool = (() => { const f = pokedexData.filter(p => tradeHubRegioesExigidos.length === 0 || tradeHubRegioesExigidos.includes(pegarRegiao(p))); return f.length > 0 ? f : pokedexData })()
    const offers = []
    for (let i = 0; i < 20; i++) {
      const level = Math.floor(Math.random() * 20) + 1
      const offeredPokemon = generateRandomNpcPokemon(level, TRADE_BANNED_POKEMON, ofPool)

      // Pokémon necessário (espécie aleatória diferente, também não banido)
      let requiredSpecies = reqPool[Math.floor(Math.random() * reqPool.length)]
      while (requiredSpecies.nome === offeredPokemon.species || isTradeBanned(requiredSpecies.nome)) {
        requiredSpecies = reqPool[Math.floor(Math.random() * reqPool.length)]
      }

      offers.push({
        id: `trade-${Date.now()}-${i}-${Math.random().toString(36).substr(2, 5)}`,
        offeredPokemon,
        requiredSpecies: requiredSpecies.nome,
        requiredImageUrl: `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${requiredSpecies.dexNumber}.png`,
        requiredDexNumber: requiredSpecies.dexNumber
      })
    }
    setTradeHubOffers(offers)
    setTradeHubCompletedTrades({})
    setExpandedTradeCards({})
    setTradeHubAlfaStatus({})
    setTradeHubConditions({})
  }

  const resorteioTradeCard = (tradeId) => {
    const ofPool = (() => { const f = pokedexData.filter(p => tradeHubRegioesOferecidos.length === 0 || tradeHubRegioesOferecidos.includes(pegarRegiao(p))); return f.length > 0 ? f : pokedexData })()
    const reqPool = (() => { const f = pokedexData.filter(p => tradeHubRegioesExigidos.length === 0 || tradeHubRegioesExigidos.includes(pegarRegiao(p))); return f.length > 0 ? f : pokedexData })()
    const level = Math.floor(Math.random() * 20) + 1
    const newOfferedPokemon = generateRandomNpcPokemon(level, TRADE_BANNED_POKEMON, ofPool)
    let requiredSpecies = reqPool[Math.floor(Math.random() * reqPool.length)]
    while (requiredSpecies.nome === newOfferedPokemon.species || isTradeBanned(requiredSpecies.nome)) {
      requiredSpecies = reqPool[Math.floor(Math.random() * reqPool.length)]
    }
    setTradeHubOffers(prev => prev.map(t => t.id === tradeId ? {
      ...t,
      offeredPokemon: newOfferedPokemon,
      requiredSpecies: requiredSpecies.nome,
      requiredImageUrl: `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${requiredSpecies.dexNumber}.png`,
      requiredDexNumber: requiredSpecies.dexNumber
    } : t))
    setTradeHubCompletedTrades(prev => { const n = {...prev}; delete n[tradeId]; return n })
    setExpandedTradeCards(prev => { const n = {...prev}; delete n[tradeId]; return n })
  }

  // Aceitar uma troca no Hub de Troca (treinador)
  const acceptTrade = async (trade, userPokemon, location) => {
    const offered = trade.offeredPokemon

    // Remover pokémon do treinador
    if (location === 'mainTeam') {
      setMainTeam(prev => prev.filter(p => p.id !== userPokemon.id))
    } else {
      setPcPokemon(prev => prev.filter(p => p.id !== userPokemon.id))
    }

    // Converter pokémon oferecido (NPC format) para trainer format
    const nature = offered.nature
    const habilidadesArray = []
    if (offered.habilidade1) habilidadesArray.push(offered.habilidade1)
    if (offered.habilidade2) habilidadesArray.push(offered.habilidade2)

    const golpesArray = []
    if (offered.golpesAprendidos && offered.golpesAprendidos.length > 0) {
      for (let i = 0; i < 8; i++) {
        if (i < offered.golpesAprendidos.length) {
          golpesArray.push({ nome: offered.golpesAprendidos[i], usos: null })
        } else {
          golpesArray.push(null)
        }
      }
    } else {
      for (let i = 0; i < 8; i++) golpesArray.push(null)
    }

    const pokemonData = {
      id: `${Date.now()}-${Math.random()}`,
      species: offered.species,
      nickname: '',
      level: offered.level,
      totalXP: offered.totalXP || 0,
      nature: nature.nome,
      baseAttributes: offered.baseAttributes,
      levelPoints: {
        saude: offered.attributes.saude - offered.baseAttributes.saude - (nature.up === 'Saúde' ? 1 : nature.down === 'Saúde' ? -1 : 0),
        ataque: offered.attributes.ataque - offered.baseAttributes.ataque - (nature.up === 'Ataque' ? 2 : nature.down === 'Ataque' ? -2 : 0),
        defesa: offered.attributes.defesa - offered.baseAttributes.defesa - (nature.up === 'Defesa' ? 2 : nature.down === 'Defesa' ? -2 : 0),
        ataqueEspecial: offered.attributes.ataqueEspecial - offered.baseAttributes.ataqueEspecial - (nature.up === 'Ataque Especial' ? 2 : nature.down === 'Ataque Especial' ? -2 : 0),
        defesaEspecial: offered.attributes.defesaEspecial - offered.baseAttributes.defesaEspecial - (nature.up === 'Defesa Especial' ? 2 : nature.down === 'Defesa Especial' ? -2 : 0),
        velocidade: offered.attributes.velocidade - offered.baseAttributes.velocidade - (nature.up === 'Velocidade' ? 2 : nature.down === 'Velocidade' ? -2 : 0)
      },
      favoriteFlavor: nature.gosto,
      dislikedFlavor: nature.desgosto,
      weight: offered.weight,
      height: offered.height,
      happiness: 0,
      currentHP: (3 * offered.attributes.saude) + offered.level,
      imageUrl: offered.imageUrl || '',
      shiny: offered.shiny || false,
      gender: offered.gender,
      dexNumber: offered.dexNumber,
      habilidades: habilidadesArray,
      golpes: golpesArray,
      isAlpha: false
    }

    // Adicionar ao time ou PC
    if (mainTeam.length < 6) {
      setMainTeam(prev => [...prev, pokemonData])
    } else {
      setPcPokemon(prev => [...prev, pokemonData])
    }

    // Atualizar Pokédex
    const existingEntry = pokedex.find(p => p.species === offered.species)
    if (existingEntry) {
      setPokedex(prev => prev.map(p => p.species === offered.species ? { ...p, isCaptured: true } : p))
    } else {
      setPokedex(prev => [...prev, { species: offered.species, isCaptured: true }])
    }

    // Marcar troca como feita
    const updatedCompleted = { ...tradeHubCompletedTrades, [trade.id]: currentUser.username }
    setTradeHubCompletedTrades(updatedCompleted)

    // Salvar no Firebase imediatamente
    if (useFirebase) {
      await saveToFirebase('tradeHub/completedTrades', updatedCompleted)
    }

    // Fechar modais
    setShowTradeConfirmModal(false)
    setShowTradeSelectPokemonModal(false)
    setSelectedTradeOffer(null)
    setSelectedTradeUserPokemon(null)
  }

  const addToNpcList = (pokemonId) => {
    const pokemon = npcPokemonList.find(p => p.id === pokemonId)
    if (pokemon && !pokemon.addedToNpc) {
      // Atribuir habilidades ao pokémon
      const pokemonWithAbilities = assignAbilitiesToPokemon(pokemon)

      console.log('Pokémon sendo adicionado aos NPCs:', pokemonWithAbilities)
      console.log('Golpes do Pokémon:', pokemonWithAbilities.golpesAprendidos)

      setNpcPokemon(prev => [...prev, pokemonWithAbilities])
      setNpcPokemonList(prev => prev.map(p =>
        p.id === pokemonId ? { ...p, addedToNpc: true } : p
      ))
    }
  }

  // Função para remover Pokémon da lista de gerados recentemente
  const removeFromGeneratedList = (pokemonId) => {
    setNpcPokemonList(prev => prev.filter(p => p.id !== pokemonId))
    // Se o pokémon também estava na lista de NPCs, remove de lá também
    setNpcPokemon(prev => prev.filter(p => p.id !== pokemonId))
    setExpandedNpcCards(prev => prev.filter(id => id !== pokemonId))
  }

  // Função para remover Pokémon NPC
  const removeNpcPokemon = (pokemonId) => {
    setNpcPokemon(prev => prev.filter(p => p.id !== pokemonId))
    setNpcPokemonList(prev => prev.map(p =>
      p.id === pokemonId ? { ...p, addedToNpc: false } : p
    ))
    setExpandedNpcCards(prev => prev.filter(id => id !== pokemonId))
  }

  // Função para arquivar Pokémon NPC
  const archiveNpcPokemon = (pokemon) => {
    setArchivedNpcPokemon(prev => [...prev, { ...pokemon, archivedAt: new Date().toISOString() }])
    setNpcPokemon(prev => prev.filter(p => p.id !== pokemon.id))
    setNpcPokemonList(prev => prev.map(p =>
      p.id === pokemon.id ? { ...p, addedToNpc: false } : p
    ))
    setExpandedNpcCards(prev => prev.filter(id => id !== pokemon.id))
  }

  // Função para desarquivar Pokémon NPC (restaurar para área Pokémon NPC)
  const unarchiveNpcPokemon = (pokemon) => {
    const { archivedAt, ...pokemonWithoutArchiveDate } = pokemon
    setNpcPokemon(prev => [...prev, pokemonWithoutArchiveDate])
    setArchivedNpcPokemon(prev => prev.filter(p => p.id !== pokemon.id))
  }

  // Função para remover Pokémon NPC arquivado
  const removeArchivedNpcPokemon = (pokemonId) => {
    setArchivedNpcPokemon(prev => prev.filter(p => p.id !== pokemonId))
  }

  // Função para enviar XP para treinadores selecionados
  const enviarXpParaTreinadores = async () => {
    if (!selectedNpcPokemonForXp) return

    const trainersSelected = Object.entries(selectedTrainersForXp)
      .filter(([_, isSelected]) => isSelected)
      .map(([trainer]) => trainer)

    if (trainersSelected.length === 0) {
      alert('Selecione pelo menos um treinador.')
      return
    }

    const baseXp = selectedNpcPokemonForXp.experience
    const totalXp = npcAlfaStatus[selectedNpcPokemonForXp.id] ? baseXp * 2 : baseXp
    const xpPerTrainer = Math.floor(totalXp / trainersSelected.length)
    const speciesName = selectedNpcPokemonForXp.species || selectedNpcPokemonForXp.name || 'Pokémon'

    try {
      for (const trainer of trainersSelected) {
        // Carregar dados atuais do treinador
        const currentData = allTrainersXpCapturas[trainer] || { xpList: [], capturaList: [] }
        const newXpList = [
          ...(currentData.xpList || []),
          {
            value: xpPerTrainer,
            species: speciesName,
            fromNpc: true // Marcar que veio de NPC
          }
        ]

        if (useFirebase) {
          await saveXpCapturas(trainer, {
            xpList: newXpList,
            capturaList: currentData.capturaList || []
          })
        }
      }

      alert(`XP enviado com sucesso!\n${xpPerTrainer} XP para cada treinador: ${trainersSelected.join(', ')}`)
      setShowSendXpModal(false)
      setSelectedNpcPokemonForXp(null)
      setSelectedTrainersForXp({})
    } catch (error) {
      console.error('Erro ao enviar XP:', error)
      alert('Erro ao enviar XP. Tente novamente.')
    }
  }

  // Função para alternar expansão do card NPC
  const toggleNpcCard = (pokemonId) => {
    setExpandedNpcCards(prev => {
      if (prev.includes(pokemonId)) {
        return prev.filter(id => id !== pokemonId)
      } else {
        return [...prev, pokemonId]
      }
    })
  }

  // Função para aplicar dano ou cura ao Pokémon NPC
  const applyNpcDamage = (isDamage) => {
    if (!selectedNpcPokemon || !npcDamageAmount) return

    const amount = parseInt(npcDamageAmount)
    if (isNaN(amount) || amount <= 0) return

    setNpcPokemon(prev => prev.map(pokemon => {
      if (pokemon.id === selectedNpcPokemon.id) {
        const maxHP = (3 * pokemon.attributes.saude) + pokemon.level
        const currentHP = pokemon.currentHP !== undefined ? pokemon.currentHP : maxHP

        let newHP
        if (isDamage) {
          newHP = Math.max(0, currentHP - amount)
        } else {
          newHP = Math.min(maxHP, currentHP + amount)
        }

        return { ...pokemon, currentHP: newHP }
      }
      return pokemon
    }))

    setShowNpcDamageModal(false)
    setNpcDamageAmount('')
    setSelectedNpcPokemon(null)
  }

  // Função para aplicar dano ou cura ao Treinador em Batalha
  const applyTrainerBattleDamage = (isDamage) => {
    if (!trainerBattleDamageAmount) return

    const amount = parseInt(trainerBattleDamageAmount)
    if (isNaN(amount) || amount <= 0) return

    const maxHP = getMaxHP()
    let newHP

    if (isDamage) {
      newHP = Math.max(0, currentHP - amount)
    } else {
      newHP = Math.min(maxHP, currentHP + amount)
    }

    setCurrentHP(newHP)

    // Atualizar também na lista de batalha
    setBattleTrainersList(prev => prev.map(trainer => {
      if (trainer.nome === currentUser?.username) {
        return { ...trainer, hp: newHP }
      }
      return trainer
    }))

    setShowTrainerBattleDamageModal(false)
    setTrainerBattleDamageAmount('')
  }

  // Função para aplicar dano ou cura ao Treinador NPC em Batalha (Mestre)
  const applyNpcTrainerBattleDamage = (isDamage) => {
    if (!selectedNpcTrainerForDamage || !npcTrainerBattleDamageAmount) return

    const amount = parseInt(npcTrainerBattleDamageAmount)
    if (isNaN(amount) || amount <= 0) return

    const maxHP = selectedNpcTrainerForDamage.maxHP
    const currentTrainerHP = selectedNpcTrainerForDamage.hp !== undefined ? selectedNpcTrainerForDamage.hp : maxHP

    let newHP
    if (isDamage) {
      newHP = Math.max(0, currentTrainerHP - amount)
    } else {
      newHP = Math.min(maxHP, currentTrainerHP + amount)
    }

    // Atualizar o treinador NPC no card (usando npcId que é o ID original)
    const originalNpcId = selectedNpcTrainerForDamage.npcId
    if (originalNpcId) {
      setNpcTrainers(prev => prev.map(trainer => {
        if (trainer.id === originalNpcId) {
          return { ...trainer, currentHP: newHP }
        }
        return trainer
      }))
    }

    // Atualizar também na lista de batalha
    setBattleTrainersList(prev => prev.map(trainer => {
      if (trainer.id === selectedNpcTrainerForDamage.id) {
        return { ...trainer, hp: newHP }
      }
      return trainer
    }))

    setShowNpcTrainerBattleDamageModal(false)
    setNpcTrainerBattleDamageAmount('')
    setSelectedNpcTrainerForDamage(null)
  }

  // Função para aplicar dano ou cura ao Pokémon NPC em Batalha (Mestre)
  const applyNpcPokemonBattleDamage = (isDamage) => {
    if (!selectedNpcPokemonForDamage || !npcPokemonBattleDamageAmount) return

    const amount = parseInt(npcPokemonBattleDamageAmount)
    if (isNaN(amount) || amount <= 0) return

    const maxHP = selectedNpcPokemonForDamage.maxHP
    const currentPokemonHP = selectedNpcPokemonForDamage.hp !== undefined ? selectedNpcPokemonForDamage.hp : maxHP

    let newHP
    if (isDamage) {
      newHP = Math.max(0, currentPokemonHP - amount)
    } else {
      newHP = Math.min(maxHP, currentPokemonHP + amount)
    }

    // Atualizar o Pokémon NPC no card (usando npcId que é o ID original)
    const originalNpcId = selectedNpcPokemonForDamage.npcId
    if (originalNpcId) {
      setNpcPokemon(prev => prev.map(pokemon => {
        if (pokemon.id === originalNpcId) {
          return { ...pokemon, currentHP: newHP }
        }
        return pokemon
      }))
    }

    // Atualizar também na lista de batalha
    setBattlePokemonList(prev => prev.map(pokemon => {
      if (pokemon.id === selectedNpcPokemonForDamage.id) {
        return { ...pokemon, hp: newHP }
      }
      return pokemon
    }))

    setShowNpcPokemonBattleDamageModal(false)
    setNpcPokemonBattleDamageAmount('')
    setSelectedNpcPokemonForDamage(null)
  }

  // Função para aplicar dano com tipo (Físico/Especial/Puro) - subtrai defesa do dano
  const applyDamageWithType = (damageType) => {
    if (!pendingDamageContext || pendingDamageValue <= 0) return

    let defense = 0
    let finalDamage = pendingDamageValue

    // Obter defesa baseado no contexto (se não for dano puro)
    if (pendingDamageContext === 'battlePokemon' && selectedBattlePokemon) {
      // Pokémon do treinador em batalha - buscar atributos totais do battlePokemonList
      const pokemon = selectedBattlePokemon

      // Buscar o pokémon na lista de batalha para obter totalAttributes
      const battlePokemon = battlePokemonList.find(bp =>
        bp.especie === pokemon.species &&
        bp.nome === (pokemon.nickname || pokemon.species) &&
        bp.owner === currentUser?.username
      )

      if (damageType !== 'puro') {
        if (battlePokemon && battlePokemon.totalAttributes) {
          defense = damageType === 'fisico'
            ? (battlePokemon.totalAttributes.defesa || 0)
            : (battlePokemon.totalAttributes.defesaEspecial || 0)
        } else {
          // Fallback: calcular usando a função existente
          defense = damageType === 'fisico'
            ? calculateTotalAttribute(pokemon, 'defesa', 'Defesa')
            : calculateTotalAttribute(pokemon, 'defesaEspecial', 'Defesa Especial')
        }
      }

      finalDamage = Math.max(0, pendingDamageValue - defense)
      finalDamage = applyDamageMultiplier(finalDamage)

      const idx = mainTeam.findIndex(p => p === selectedBattlePokemon)
      if (idx !== -1) {
        const maxHP = calculateMaxHP(mainTeam[idx])
        const currentPkmHP = mainTeam[idx].currentHP !== undefined ? mainTeam[idx].currentHP : maxHP
        const newHP = Math.max(0, currentPkmHP - finalDamage)

        const updatedTeam = [...mainTeam]
        updatedTeam[idx] = { ...updatedTeam[idx], currentHP: newHP }
        setMainTeam(updatedTeam)

        // Atualizar na lista de batalha e salvar no Firebase
        const updatedBPL = battlePokemonList.map(battlePkmn => {
          if (battlePkmn.especie === selectedBattlePokemon.species &&
              battlePkmn.nome === (selectedBattlePokemon.nickname || selectedBattlePokemon.species)) {
            return { ...battlePkmn, hp: newHP }
          }
          return battlePkmn
        })
        setBattlePokemonList(updatedBPL)
        if (useFirebase) {
          saveBattleData({ battleTrainers, battlePokemon, battleTrainersList, battlePokemonList: updatedBPL, currentTrainerTurn, currentPokemonTurn, trainerRound, pokemonRound, battlePokemonConditions, revealedNpcPokemon, revealedTrainers })
        }
      }

      setShowBattleHPModal(false)
      setBattleHpValue('')

    } else if (pendingDamageContext === 'trainer') {
      // Treinador próprio (modal HP simples)
      if (damageType !== 'puro') {
        defense = damageType === 'fisico'
          ? (attributes.defesa || 0)
          : (attributes.defesaEspecial || 0)
      }

      finalDamage = Math.max(0, pendingDamageValue - defense)
      finalDamage = applyDamageMultiplier(finalDamage)
      const maxHP = getMaxHP()
      const newHP = Math.max(0, currentHP - finalDamage)

      setCurrentHP(newHP)
      setBattleTrainersList(prev => prev.map(t => t.nome === currentUser?.username ? { ...t, hp: newHP } : t))

      setShowHPModal(false)
      setHpValue('')

    } else if (pendingDamageContext === 'trainerBattle') {
      // Treinador em batalha
      if (damageType !== 'puro') {
        defense = damageType === 'fisico'
          ? (attributes.defesa || 0)
          : (attributes.defesaEspecial || 0)
      }

      finalDamage = Math.max(0, pendingDamageValue - defense)
      finalDamage = applyDamageMultiplier(finalDamage)
      const maxHP = getMaxHP()
      const newHP = Math.max(0, currentHP - finalDamage)

      setCurrentHP(newHP)
      setBattleTrainersList(prev => prev.map(trainer => {
        if (trainer.nome === currentUser?.username) {
          return { ...trainer, hp: newHP }
        }
        return trainer
      }))

      setShowTrainerBattleDamageModal(false)
      setTrainerBattleDamageAmount('')

    } else if (pendingDamageContext === 'npcPokemon' && selectedNpcPokemon) {
      // Pokémon NPC (mestre)
      if (damageType !== 'puro') {
        defense = damageType === 'fisico'
          ? (selectedNpcPokemon.attributes?.defesa || 0)
          : (selectedNpcPokemon.attributes?.defesaEspecial || 0)
      }

      finalDamage = Math.max(0, pendingDamageValue - defense)
      finalDamage = applyDamageMultiplier(finalDamage)

      setNpcPokemon(prev => prev.map(pokemon => {
        if (pokemon.id === selectedNpcPokemon.id) {
          const maxHP = (3 * pokemon.attributes.saude) + pokemon.level
          const currentPkmHP = pokemon.currentHP !== undefined ? pokemon.currentHP : maxHP
          const newHP = Math.max(0, currentPkmHP - finalDamage)
          return { ...pokemon, currentHP: newHP }
        }
        return pokemon
      }))

      setShowNpcDamageModal(false)
      setNpcDamageAmount('')
      setSelectedNpcPokemon(null)

    } else if (pendingDamageContext === 'npcPokemonBattle' && selectedNpcPokemonForDamage) {
      // Pokémon NPC em batalha (mestre) - usar atributos de totalAttributes
      if (damageType !== 'puro') {
        defense = damageType === 'fisico'
          ? (selectedNpcPokemonForDamage.totalAttributes?.defesa || 0)
          : (selectedNpcPokemonForDamage.totalAttributes?.defesaEspecial || 0)
      }

      finalDamage = Math.max(0, pendingDamageValue - defense)
      finalDamage = applyDamageMultiplier(finalDamage)

      const maxHP = selectedNpcPokemonForDamage.maxHP
      const currentPokemonHP = selectedNpcPokemonForDamage.hp !== undefined ? selectedNpcPokemonForDamage.hp : maxHP
      const newHP = Math.max(0, currentPokemonHP - finalDamage)

      // Atualizar o Pokémon NPC no card
      const originalNpcId = selectedNpcPokemonForDamage.npcId
      if (originalNpcId) {
        setNpcPokemon(prev => prev.map(pokemon => {
          if (pokemon.id === originalNpcId) {
            return { ...pokemon, currentHP: newHP }
          }
          return pokemon
        }))
      }

      // Atualizar na lista de batalha
      setBattlePokemonList(prev => prev.map(pokemon => {
        if (pokemon.id === selectedNpcPokemonForDamage.id) {
          return { ...pokemon, hp: newHP }
        }
        return pokemon
      }))

      setShowNpcPokemonBattleDamageModal(false)
      setNpcPokemonBattleDamageAmount('')
      setSelectedNpcPokemonForDamage(null)

    } else if (pendingDamageContext === 'npcTrainerBattle' && selectedNpcTrainerForDamage) {
      // Treinador NPC em batalha (mestre) - usar atributos de baseAttributes
      if (damageType !== 'puro') {
        defense = damageType === 'fisico'
          ? (selectedNpcTrainerForDamage.baseAttributes?.defesa || 0)
          : (selectedNpcTrainerForDamage.baseAttributes?.defesaEspecial || 0)
      }

      finalDamage = Math.max(0, pendingDamageValue - defense)
      finalDamage = applyDamageMultiplier(finalDamage)

      const maxHP = selectedNpcTrainerForDamage.maxHP
      const currentTrainerHP = selectedNpcTrainerForDamage.hp !== undefined ? selectedNpcTrainerForDamage.hp : maxHP
      const newHP = Math.max(0, currentTrainerHP - finalDamage)

      // Atualizar o Treinador NPC no card
      const originalNpcId = selectedNpcTrainerForDamage.npcId
      if (originalNpcId) {
        setNpcTrainers(prev => prev.map(trainer => {
          if (trainer.id === originalNpcId) {
            return { ...trainer, hp: newHP }
          }
          return trainer
        }))
      }

      // Atualizar na lista de batalha
      setBattleTrainersList(prev => prev.map(trainer => {
        if (trainer.id === selectedNpcTrainerForDamage.id) {
          return { ...trainer, hp: newHP }
        }
        return trainer
      }))

      setShowNpcTrainerBattleDamageModal(false)
      setNpcTrainerBattleDamageAmount('')
      setSelectedNpcTrainerForDamage(null)
    }

    // Resetar estados
    setShowDamageTypeButtons(false)
    setPendingDamageValue(0)
    setPendingDamageContext(null)
  }

  // Função helper para aplicar multiplicador de dano
  const applyDamageMultiplier = (damage) => {
    if (!damageMultiplier) return damage

    switch (damageMultiplier) {
      case 'x2':
        return Math.floor(damage * 2)
      case 'x4':
        return Math.floor(damage * 4)
      case '/2':
        return Math.floor(damage / 2)
      case '/4':
        return Math.floor(damage / 4)
      default:
        return damage
    }
  }

  // Função para iniciar dano com seleção de tipo
  const initiateDamageWithType = (value, context) => {
    setPendingDamageValue(value)
    setPendingDamageContext(context)
    setShowDamageTypeButtons(true)
  }

  // Função para cancelar seleção de tipo de dano
  const cancelDamageTypeSelection = () => {
    setShowDamageTypeButtons(false)
    setPendingDamageValue(0)
    setDamageMultiplier(null)
    setPendingDamageContext(null)
  }

  // Função para alternar condição de captura
  const toggleNpcCondition = (pokemonId, condition) => {
    setNpcConditions(prev => ({
      ...prev,
      [pokemonId]: {
        ...prev[pokemonId],
        [condition]: !prev[pokemonId]?.[condition]
      }
    }))
  }

  // Função para calcular o Valor de Captura
  const calculateCaptureValue = (pokemon) => {
    let total = 0

    // Catch Rate do pokémon
    const catchRate = pokemon.catchRate || 0
    total += catchRate

    // Bônus de condições
    const conditions = npcConditions[pokemon.id] || {}
    if (conditions.confusao) total += 5
    if (conditions.critico) total += 10
    if (conditions.paralisia) total += 7
    if (conditions.sono) total += 10
    if (conditions.atordoamento) total += 10
    if (conditions.congelamento) total += 15
    if (conditions.paixao) total += 3
    if (conditions.queimadura) total += 5
    if (conditions.veneno) total += 7

    // Bônus de HP
    const maxHP = (3 * pokemon.attributes.saude) + pokemon.level
    const currentHP = pokemon.currentHP !== undefined ? pokemon.currentHP : maxHP
    const hpPercentage = (currentHP / maxHP) * 100

    if (hpPercentage > 75) {
      total -= 15
    } else if (hpPercentage > 50) {
      total -= 5
    } else if (hpPercentage > 25) {
      total += 5
    } else if (currentHP >= 1) {
      total += 25
    }

    // Bônus de nível
    const level = pokemon.level
    if (level >= 1 && level <= 20) {
      total += 20
    } else if (level >= 21 && level <= 40) {
      total += 10
    } else if (level >= 41 && level <= 60) {
      total -= 5
    } else if (level >= 61 && level <= 80) {
      total -= 15
    } else if (level >= 81 && level <= 100) {
      total -= 30
    }

    // Penalidade Alfa (-30 no valor de captura)
    if (npcAlfaStatus[pokemon.id]) {
      total -= 30
    }

    return total
  }

  // Função para enviar pokémon NPC para treinador
  const sendPokemonToTrainer = async (trainerUsername) => {
    if (!pokemonToSend || !sendPokemonSpecies || !sendPokemonNature) {
      alert('Por favor, selecione a espécie e a natureza antes de enviar.')
      return
    }

    try {
      const trainerData = useFirebase
        ? await loadTrainerData(trainerUsername)
        : JSON.parse(localStorage.getItem(`trainer_${trainerUsername}`) || 'null')

      if (trainerData) {

        // Usar espécie e natureza editáveis
        const finalNature = sendPokemonNature

        // Preparar habilidades do pokémon NPC (manter as que já foram sorteadas)
        const habilidadesArray = []
        if (pokemonToSend.habilidade1) habilidadesArray.push(pokemonToSend.habilidade1)
        if (pokemonToSend.habilidade2) habilidadesArray.push(pokemonToSend.habilidade2)

        // Preparar golpes do pokémon NPC (slots vazios até 8)
        const golpesArray = []
        if (pokemonToSend.golpesAprendidos && pokemonToSend.golpesAprendidos.length > 0) {
          // Preencher até 8 slots com os golpes existentes
          for (let i = 0; i < 8; i++) {
            if (i < pokemonToSend.golpesAprendidos.length) {
              golpesArray.push({
                nome: pokemonToSend.golpesAprendidos[i],
                usos: null // null significa usos infinitos ou não aplicável
              })
            } else {
              golpesArray.push(null) // Slot vazio
            }
          }
        } else {
          // Se não tem golpes, criar 8 slots vazios
          for (let i = 0; i < 8; i++) {
            golpesArray.push(null)
          }
        }

        console.log('Golpes sendo enviados para o treinador:', golpesArray)

        // Preparar dados do pokémon para envio
        const pokemonData = {
          id: `${Date.now()}-${Math.random()}`,
          species: sendPokemonSpecies,
          nickname: '',
          level: pokemonToSend.level,
          totalXP: pokemonToSend.totalXP || 0, // Preserva XP atual do Pokémon
          nature: finalNature.nome,
          baseAttributes: pokemonToSend.baseAttributes,
          levelPoints: {
            saude: pokemonToSend.attributes.saude - pokemonToSend.baseAttributes.saude - (finalNature.up === 'Saúde' ? 1 : finalNature.down === 'Saúde' ? -1 : 0),
            ataque: pokemonToSend.attributes.ataque - pokemonToSend.baseAttributes.ataque - (finalNature.up === 'Ataque' ? 2 : finalNature.down === 'Ataque' ? -2 : 0),
            defesa: pokemonToSend.attributes.defesa - pokemonToSend.baseAttributes.defesa - (finalNature.up === 'Defesa' ? 2 : finalNature.down === 'Defesa' ? -2 : 0),
            ataqueEspecial: pokemonToSend.attributes.ataqueEspecial - pokemonToSend.baseAttributes.ataqueEspecial - (finalNature.up === 'Ataque Especial' ? 2 : finalNature.down === 'Ataque Especial' ? -2 : 0),
            defesaEspecial: pokemonToSend.attributes.defesaEspecial - pokemonToSend.baseAttributes.defesaEspecial - (finalNature.up === 'Defesa Especial' ? 2 : finalNature.down === 'Defesa Especial' ? -2 : 0),
            velocidade: pokemonToSend.attributes.velocidade - pokemonToSend.baseAttributes.velocidade - (finalNature.up === 'Velocidade' ? 2 : finalNature.down === 'Velocidade' ? -2 : 0)
          },
          favoriteFlavor: finalNature.gosto,
          dislikedFlavor: finalNature.desgosto,
          weight: pokemonToSend.weight,
          height: pokemonToSend.height,
          happiness: 0,
          currentHP: (3 * pokemonToSend.attributes.saude) + pokemonToSend.level,
          imageUrl: pokemonToSend.imageUrl || '',
          shiny: pokemonToSend.shiny || false,
          gender: pokemonToSend.gender,
          dexNumber: pokemonToSend.dexNumber,
          habilidades: habilidadesArray,
          golpes: golpesArray,
          isAlpha: npcAlfaStatus[pokemonToSend.id] || false,
          dieta: POKEMON_DIET_MAP[sendPokemonSpecies] || null,
          displacement: POKEMON_DESLOCAMENTO_MAP[sendPokemonSpecies] || null,
          capacities: (() => { const c = POKEMON_CAPACIDADE_MAP[sendPokemonSpecies]; return c ? { forca: c.forca, inteligencia: c.inteligencia, salto: c.salto, others: [] } : null })()
        }

        // Verificar se o time principal tem menos de 6 pokémons
        const mainTeam = trainerData.mainTeam || []
        const pcPokemon = trainerData.pcPokemon || []

        if (mainTeam.length < 6) {
          trainerData.mainTeam = [...mainTeam, pokemonData]
        } else {
          trainerData.pcPokemon = [...pcPokemon, pokemonData]
        }

        // Atualizar Pokédex: adicionar como capturado e escaneado
        const pokedex = trainerData.pokedex || []
        const existingEntry = pokedex.find(p => p.species === sendPokemonSpecies)

        if (existingEntry) {
          // Se já existe na Pokédex, marcar como capturado
          trainerData.pokedex = pokedex.map(p =>
            p.species === sendPokemonSpecies
              ? { ...p, isCaptured: true }
              : p
          )
        } else {
          // Se não existe, adicionar como capturado
          trainerData.pokedex = [...pokedex, {
            species: sendPokemonSpecies,
            isCaptured: true
          }]
        }

        // Salvar dados atualizados do treinador
        if (useFirebase) {
          await saveTrainerData(trainerUsername, trainerData)
        } else {
          localStorage.setItem(`trainer_${trainerUsername}`, JSON.stringify(trainerData))
        }

        // Adicionar à lista de captura e lista de XP do treinador
        if (useFirebase) {
          const currentXpCapturas = await loadXpCapturas(trainerUsername)
          const baseXp = pokemonToSend.experience || 0
          const pokemonXp = npcAlfaStatus[pokemonToSend.id] ? baseXp * 2 : baseXp

          // Adicionar à lista de captura
          const newCapturaList = [...(currentXpCapturas.capturaList || []), {
            species: sendPokemonSpecies,
            level: pokemonToSend.level,
            captureValue: calculateCaptureValue(pokemonToSend),
            experience: pokemonXp,
            addedAt: Date.now()
          }]

          // Adicionar XP à lista de XP (se tiver XP)
          const newXpList = pokemonXp > 0
            ? [...(currentXpCapturas.xpList || []), {
                value: pokemonXp,
                species: sendPokemonSpecies,
                addedAt: Date.now()
              }]
            : (currentXpCapturas.xpList || [])

          await saveXpCapturas(trainerUsername, {
            xpList: newXpList,
            capturaList: newCapturaList
          })
        }

        // Fechar modal e limpar estado
        setShowSendToTrainerModal(false)
        setPokemonToSend(null)

        alert(`Pokémon ${sendPokemonSpecies} enviado para ${trainerUsername}!`)
      } else {
        alert('Dados do treinador não encontrados.')
        setShowSendToTrainerModal(false)
        setPokemonToSend(null)
      }
    } catch (e) {
      console.error('Erro ao enviar pokémon:', e)
      alert('Erro ao enviar pokémon para o treinador.')
      setShowSendToTrainerModal(false)
      setPokemonToSend(null)
    }
  }

  // Funções para enviar para Batalha
  const sendPokemonToBattle = (pokemon) => {
    const maxHP = calculateMaxHP(pokemon)
    const totalVel = calculateTotalAttribute(pokemon, 'velocidade', 'Velocidade')
    const totalDef = calculateTotalAttribute(pokemon, 'defesa', 'Defesa')
    const totalDefEsp = calculateTotalAttribute(pokemon, 'defesaEspecial', 'Defesa Especial')
    const totalAtk = calculateTotalAttribute(pokemon, 'ataque', 'Ataque')
    const totalAtkEsp = calculateTotalAttribute(pokemon, 'ataqueEspecial', 'Ataque Especial')
    const tipos = getPokemonTypes(pokemon) || []

    // Gerar nome falso aleatório
    const fakeNames = ['Vulto', 'Sua Mãe', 'Carinha da esquina', 'Agumon', 'Gabumon', 'Mochi', 'Mewtwoo', 'Sua Vó', 'Claúdio', 'Biroliro', 'Flamengo', 'Chrmader', 'Seu Pai', 'Dois Reias']
    const fakeName = fakeNames[Math.floor(Math.random() * fakeNames.length)]

    const originalId = pokemon.id || `team-${pokemon.species}`
    const battleData = {
      id: `pokemon-${Date.now()}-${Math.random()}`,
      originalId: originalId,
      nome: pokemon.nickname || pokemon.species,
      especie: pokemon.species,
      tipos: tipos,
      hp: pokemon.currentHP !== undefined ? pokemon.currentHP : maxHP,
      maxHP: maxHP,
      velocidade: totalVel,
      evasaoFisica: Math.floor(totalDef / 5),
      evasaoEspecial: Math.floor(totalDefEsp / 5),
      evasaoVeloz: Math.floor(totalVel / 10),
      golpes: pokemon.moves || [],
      habilidades: pokemon.abilities || [],
      isExotic: pokemon.isExotic || false,
      isNpc: false,
      owner: currentUser?.username,
      // Armazenar atributos totais base para cálculo de fases
      totalAttributes: {
        ataque: totalAtk,
        ataqueEspecial: totalAtkEsp,
        defesa: totalDef,
        defesaEspecial: totalDefEsp,
        velocidade: totalVel
      }
    }
    const newBattlePokemon = [...battlePokemon, battleData]
    setBattlePokemon(newBattlePokemon)

    // Salvar no Firebase imediatamente (stages são salvos em paths separados)
    if (useFirebase) {
      saveBattleData({
        battleTrainers,
        battlePokemon: newBattlePokemon,
        battleTrainersList,
        battlePokemonList,
        currentTrainerTurn,
        currentPokemonTurn,
        trainerRound,
        pokemonRound,
        battlePokemonConditions,
        revealedNpcPokemon,
        revealedTrainers
      })
    }
    alert(`${battleData.nome} enviado para a Batalha!`)
  }

  const sendTrainerToBattle = async () => {
    const maxHP = getMaxHP()
    const evasion = getEvasion()

    // Gerar nome falso aleatório para treinador
    const fakeTrainerNames = ['Treinador A', 'Treinador B', 'Treinador C', 'Treinador D', 'Treinador E', 'Pessoa Misteriosa', 'Fulano', 'Ciclano', 'Beltrano', 'Aspirante', 'Novato', 'Veterano']
    const fakeTrainerName = fakeTrainerNames[Math.floor(Math.random() * fakeTrainerNames.length)]

    const battleData = {
      id: `trainer-${Date.now()}-${Math.random()}`,
      nome: currentUser.username,
      nomeFalso: fakeTrainerName,
      hp: currentHP,
      maxHP: maxHP,
      velocidade: attributes.velocidade,
      evasaoFisica: evasion.fisica,
      evasaoEspecial: evasion.especial,
      evasaoVeloz: evasion.veloz,
      level: level,
      ataque: attributes.ataque || 0,
      ataqueEspecial: attributes.ataqueEspecial || 0,
      baseAttributes: {
        defesa: attributes.defesa,
        defesaEspecial: attributes.defesaEspecial,
        velocidade: attributes.velocidade,
        ataque: attributes.ataque,
        ataqueEspecial: attributes.ataqueEspecial
      }
    }
    const newBattleTrainers = [...battleTrainers, battleData]
    setBattleTrainers(newBattleTrainers)

    // Salvar no Firebase imediatamente (stages são salvos em paths separados)
    if (useFirebase) {
      await saveBattleData({
        battleTrainers: newBattleTrainers,
        battlePokemon,
        battleTrainersList,
        battlePokemonList,
        currentTrainerTurn,
        currentPokemonTurn,
        trainerRound,
        pokemonRound,
        battlePokemonConditions,
        revealedNpcPokemon,
        revealedTrainers
      })
    }
    alert(`${battleData.nome} enviado para a Batalha!`)
  }

  const sendNpcPokemonToBattle = (pokemon) => {
    // Criar array de habilidades a partir de habilidade1 e habilidade2
    const habilidades = []
    if (pokemon.habilidade1) habilidades.push(pokemon.habilidade1)
    if (pokemon.habilidade2) habilidades.push(pokemon.habilidade2)

    // Gerar nome falso aleatório
    const fakeNames = ['Vulto', 'Sua Mãe', 'Carinha da esquina', 'Agumon', 'Gabumon', 'Mochi', 'Mewtwoo', 'Sua Vó', 'Claúdio', 'Biroliro', 'Flamengo', 'Chrmader', 'Seu Pai', 'Dois Reias']
    const fakeName = fakeNames[Math.floor(Math.random() * fakeNames.length)]

    // Bônus Alfa: +3 em todos os atributos
    const alfaBonus = npcAlfaStatus[pokemon.id] ? 3 : 0

    const battleData = {
      id: `npc-pokemon-${Date.now()}-${Math.random()}`,
      nome: pokemon.species || pokemon.name,
      nomeFalso: fakeName,
      especie: pokemon.species || pokemon.name,
      tipos: pokemon.types || [],
      hp: pokemon.currentHP !== undefined ? pokemon.currentHP : ((3 * (pokemon.attributes.saude + alfaBonus)) + pokemon.level),
      maxHP: (3 * (pokemon.attributes.saude + alfaBonus)) + pokemon.level,
      velocidade: pokemon.attributes.velocidade + alfaBonus,
      evasaoFisica: Math.floor((pokemon.attributes.defesa + alfaBonus) / 5),
      evasaoEspecial: Math.floor((pokemon.attributes.defesaEspecial + alfaBonus) / 5),
      evasaoVeloz: Math.floor((pokemon.attributes.velocidade + alfaBonus) / 10),
      golpes: pokemon.golpesAprendidos || pokemon.moves || [],
      habilidades: habilidades,
      isExotic: pokemon.isExotic || false,
      isNpc: true,
      npcId: pokemon.id,
      isAlpha: npcAlfaStatus[pokemon.id] || false,
      // Armazenar atributos totais base para cálculo de fases
      totalAttributes: {
        ataque: pokemon.attributes.ataque + alfaBonus,
        ataqueEspecial: pokemon.attributes.ataqueEspecial + alfaBonus,
        defesa: pokemon.attributes.defesa + alfaBonus,
        defesaEspecial: pokemon.attributes.defesaEspecial + alfaBonus,
        velocidade: pokemon.attributes.velocidade + alfaBonus
      }
    }
    setBattlePokemon(prev => [...prev, battleData])
    alert(`${battleData.nome} enviado para a Batalha!`)
  }

  // Enviar NPC para Batalha Game Boy
  const sendNpcToGBBattle = async (pokemon) => {
    const excludedBalls = ['Masterball', 'Dreamball', 'Beastball', 'Alphaball', 'Custom Pokeball']
    const availableBalls = POKEBALLS_LIST.filter(b => !excludedBalls.includes(b))
    const randomBall = availableBalls[Math.floor(Math.random() * availableBalls.length)]

    const alfaBonus = npcAlfaStatus[pokemon.id] ? 3 : 0
    const maxHP = (3 * (pokemon.attributes.saude + alfaBonus)) + pokemon.level

    const gbPokemon = {
      id: `gb-npc-${Date.now()}-${Math.random()}`,
      nome: pokemon.species || pokemon.name,
      especie: pokemon.species || pokemon.name,
      tipos: pokemon.types || [],
      hp: pokemon.currentHP !== undefined ? pokemon.currentHP : maxHP,
      maxHP: maxHP,
      level: pokemon.level || 1,
      gender: pokemon.gender || 'assexuado',
      pokeball: randomBall,
      imageUrl: pokemon.imageUrl || null,
      isNpc: true,
      isAlpha: npcAlfaStatus[pokemon.id] || false,
      golpes: pokemon.golpesAprendidos || pokemon.moves || [],
      attributes: {
        ataque: pokemon.attributes.ataque + alfaBonus,
        defesa: pokemon.attributes.defesa + alfaBonus,
        ataqueEspecial: pokemon.attributes.ataqueEspecial + alfaBonus,
        defesaEspecial: pokemon.attributes.defesaEspecial + alfaBonus,
        velocidade: pokemon.attributes.velocidade + alfaBonus,
        saude: pokemon.attributes.saude + alfaBonus
      },
      evasaoFisica: Math.floor((pokemon.attributes.defesa + alfaBonus) / 5),
      evasaoEspecial: Math.floor((pokemon.attributes.defesaEspecial + alfaBonus) / 5),
      evasaoVeloz: Math.floor((pokemon.attributes.velocidade + alfaBonus) / 10),
    }

    const updatedNpcList = [...(gbBattleData.npcPokemon || []), gbPokemon]
    const updatedData = { ...gbBattleData, npcPokemon: updatedNpcList }
    setGbBattleData(updatedData)
    if (useFirebase) await saveGBBattle(updatedData)
    alert(`${gbPokemon.nome} enviado para a Batalha Game Boy! (${randomBall})`)
  }

  // ===== FUNÇÕES DE BATALHA GAME BOY =====

  // Rolar dados genéricos (ex: "1d12+6" -> rola 1d12 e soma 6)
  const gbRollDice = (diceStr) => {
    const match = diceStr.match(/(\d+)d(\d+)([+-]\d+)?/)
    if (!match) return 0
    const numDice = parseInt(match[1])
    const diceSides = parseInt(match[2])
    const modifier = match[3] ? parseInt(match[3]) : 0
    let total = 0
    for (let i = 0; i < numDice; i++) {
      total += Math.floor(Math.random() * diceSides) + 1
    }
    return total + modifier
  }

  // Obter stages temporárias de um pokémon em batalha
  const gbGetStages = (pokemonId) => {
    return gbTempBattleStats[pokemonId]?.stages || {
      ataque: 0, defesa: 0, ataqueEspecial: 0, defesaEspecial: 0, velocidade: 0
    }
  }

  // Obter debuff de acurácia de um pokémon
  const gbGetAccuracyDebuff = (pokemonId) => {
    return gbTempBattleStats[pokemonId]?.accuracyDebuff || 0
  }

  // Calcular evasões com stages aplicadas
  const gbCalcEvasions = (pokemon) => {
    const stages = gbGetStages(pokemon.id)
    const defMult = getStageMultiplier(stages.defesa)
    const defEspMult = getStageMultiplier(stages.defesaEspecial)
    const velMult = getStageMultiplier(stages.velocidade)
    const baseDef = pokemon.attributes?.defesa || pokemon.evasaoFisica * 5
    const baseDefEsp = pokemon.attributes?.defesaEspecial || pokemon.evasaoEspecial * 5
    const baseVel = pokemon.attributes?.velocidade || pokemon.evasaoVeloz * 10
    return {
      fisica: Math.floor(Math.floor(baseDef * defMult) / 5),
      especial: Math.floor(Math.floor(baseDefEsp * defEspMult) / 5),
      veloz: Math.floor(Math.floor(baseVel * velMult) / 10)
    }
  }

  // Adicionar mensagem ao chat GB
  const addGBChatMessage = async (message) => {
    const newMessage = {
      ...message,
      id: `${Date.now()}-${Math.random()}`
    }
    if (useFirebase) {
      const updatedMessages = [...gbChatMessages, newMessage].slice(-20)
      await saveGBChatMessages(updatedMessages)
    } else {
      setGbChatMessages(prev => [...prev, newMessage].slice(-20))
    }
  }

  // Função principal: usar golpe na Batalha Game Boy
  const gbHandleUseMove = async (attacker, moveName, targets) => {
    const moveData = GOLPES_DATA[moveName]
    if (!moveData) return

    const timestamp = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })

    for (const target of targets) {
      // === ACURÁCIA ===
      const acuracia = moveData.acuracia
      const isAutomatic = acuracia === 'Automática' || acuracia === 'Auto' || !acuracia
      let hit = true
      let rollValue = 0

      if (!isAutomatic) {
        const accuracyValue = parseInt(acuracia) || 0
        const debuff = gbGetAccuracyDebuff(attacker.id)
        const adjustedAccuracy = accuracyValue + debuff // debuff aumenta a dificuldade
        const d20 = Math.floor(Math.random() * 20) + 1
        rollValue = d20 + adjustedAccuracy

        // Determinar evasão do alvo baseado no tipo do golpe
        const evasions = gbCalcEvasions(target)
        const danoBasal = moveData.danoBasal || ''
        let evasionTarget = evasions.veloz
        let evasionLabel = 'Evasão Veloz'
        if (danoBasal.includes('Físico')) {
          evasionTarget = evasions.fisica + evasions.veloz
          evasionLabel = 'Evasão Física + Veloz'
        } else if (danoBasal.includes('Especial')) {
          evasionTarget = evasions.especial + evasions.veloz
          evasionLabel = 'Evasão Especial + Veloz'
        }

        hit = rollValue >= evasionTarget
        const hitText = hit ? 'Acertou' : 'Errou'
        await addGBChatMessage({
          type: 'battle',
          user: attacker.owner || 'Mestre',
          text: `O ${attacker.nome} usou ${moveName} no ${target.nome} e ${hitText}: ${rollValue} (1d20[${d20}]+${adjustedAccuracy} vs ${evasionLabel}: ${evasionTarget})`,
          timestamp
        })
      } else {
        await addGBChatMessage({
          type: 'battle',
          user: attacker.owner || 'Mestre',
          text: `O ${attacker.nome} usou ${moveName} no ${target.nome} e Acertou: Automático`,
          timestamp
        })
      }

      // === DANO ===
      if (hit && moveData.danoBasal) {
        const danoBasal = moveData.danoBasal
        const isFisico = danoBasal.includes('Físico')
        const isEspecial = danoBasal.includes('Especial')

        // Rolar dados de dano
        const diceMatch = danoBasal.match(/(\d+d\d+[+-]?\d*)/)
        let baseDamage = 0
        if (diceMatch) {
          baseDamage = gbRollDice(diceMatch[1])
        }

        // Adicionar ataque do atacante (com stages)
        const atkStages = gbGetStages(attacker.id)
        let attackStat = 0
        if (isFisico) {
          const baseAtk = attacker.attributes?.ataque || 0
          attackStat = Math.floor(baseAtk * getStageMultiplier(atkStages.ataque))
        } else if (isEspecial) {
          const baseAtkEsp = attacker.attributes?.ataqueEspecial || 0
          attackStat = Math.floor(baseAtkEsp * getStageMultiplier(atkStages.ataqueEspecial))
        }

        // STAB (Same Type Attack Bonus)
        const attackerTypes = (attacker.tipos || []).map(normalizeType)
        const moveType = normalizeType(moveData.tipo)
        let stab = 0
        if (attackerTypes.includes(moveType)) {
          stab = Math.floor((attacker.attributes?.saude || 5) / 2)
        }

        // Subtrair defesa do alvo (com stages)
        const defStages = gbGetStages(target.id)
        let defenseStat = 0
        if (isFisico) {
          const baseDef = target.attributes?.defesa || 0
          defenseStat = Math.floor(baseDef * getStageMultiplier(defStages.defesa))
        } else if (isEspecial) {
          const baseDefEsp = target.attributes?.defesaEspecial || 0
          defenseStat = Math.floor(baseDefEsp * getStageMultiplier(defStages.defesaEspecial))
        }

        let damage = baseDamage + attackStat + stab - defenseStat

        // Aplicar multiplicador de tipo APÓS subtrair defesa
        const targetTypes = (target.tipos || []).map(normalizeType)
        const typeMultiplier = calcTypeMultiplier(moveData.tipo, target.tipos || [])

        if (typeMultiplier === 0) {
          await addGBChatMessage({
            type: 'battle',
            user: attacker.owner || 'Mestre',
            text: `${target.nome} é imune ao tipo ${moveData.tipo}! Nenhum dano causado.`,
            timestamp
          })
        } else {
          damage = Math.floor(damage * typeMultiplier)
          if (damage < 1) damage = 1

          let typeText = ''
          if (typeMultiplier >= 4) typeText = ' (x4 Super Efetivo!)'
          else if (typeMultiplier >= 2) typeText = ' (x2 Super Efetivo!)'
          else if (typeMultiplier <= 0.25) typeText = ' (x0.25 Pouco Efetivo)'
          else if (typeMultiplier <= 0.5) typeText = ' (x0.5 Pouco Efetivo)'

          await addGBChatMessage({
            type: 'damage',
            user: attacker.owner || 'Mestre',
            text: `Dano: ${damage}${typeText} (Base: ${baseDamage}, Ataque: +${attackStat}, STAB: +${stab}, Defesa: -${defenseStat})`,
            timestamp
          })

          // Atualizar HP do alvo
          gbApplyDamage(target, damage)
        }
      }

      // === EFEITOS DE GOLPE ===
      if (hit && moveData.efeito) {
        gbApplyMoveEffect(moveData, attacker, target, timestamp)
      }
    }
  }

  // Aplicar dano a um pokémon na batalha GB
  const gbApplyDamage = (target, damage) => {
    const newHP = Math.max(0, (target.hp || 0) - damage)

    // Atualizar HP em activePokemon (Firebase-synced, visível a todos)
    setGbBattleData(prev => {
      const ap = prev.activePokemon || {}
      let updatedAp = { ...ap }

      if (newHP <= 0) {
        // Remover de todas as listas
        for (const [user, pkList] of Object.entries(ap)) {
          updatedAp[user] = (pkList || []).filter(p => p.id !== target.id)
        }
      } else if (target.isNpc) {
        updatedAp['__npc__'] = (ap['__npc__'] || []).map(p =>
          p.id === target.id ? { ...p, hp: newHP } : p
        )
      } else {
        const ownerKey = target.owner || ''
        if (ownerKey) {
          updatedAp[ownerKey] = (ap[ownerKey] || []).map(p =>
            p.id === target.id ? { ...p, hp: newHP } : p
          )
        }
      }

      // Também atualizar no pool de NPCs
      const updatedNpc = target.isNpc
        ? (prev.npcPokemon || []).map(p => p.id === target.id ? { ...p, hp: newHP } : p)
        : (prev.npcPokemon || [])

      const updated = { ...prev, activePokemon: updatedAp, npcPokemon: updatedNpc }
      if (useFirebase) saveGBBattle(updated)
      return updated
    })

    // Também atualizar mainTeam local para o pokémon do usuário atual
    if (!target.isNpc) {
      setMainTeam(prev => prev.map(p => {
        const pkId = p.id || `team-${p.species}`
        if (pkId === target.originalId) {
          return { ...p, currentHP: newHP }
        }
        return p
      }))
    }

    if (newHP <= 0) {
      addGBChatMessage({
        type: 'system',
        user: 'Sistema',
        text: `${target.nome} foi nocauteado e retornou à Pokébola!`,
        timestamp: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
      })
    }
  }

  // Aplicar efeitos de golpe (mudanças de fases/atributos)
  const gbApplyMoveEffect = (moveData, attacker, target, timestamp) => {
    const efeito = typeof moveData.efeito === 'string' ? moveData.efeito :
      (moveData.efeito?.descricao || '')

    // Mapear palavras para números
    const numMap = { 'uma': 1, 'duas': 2, 'três': 3, 'um': 1, 'dois': 2 }

    // Padrão: "perde X Fase(s) de [Atributo]"
    const loseRegex = /perde\s+(uma|duas|três|um|dois)\s+Fases?\s+de\s+(Ataque Especial|Defesa Especial|Ataque|Defesa|Velocidade)/gi
    let match
    while ((match = loseRegex.exec(efeito)) !== null) {
      const amount = numMap[match[1].toLowerCase()] || 1
      const attr = match[2]
      const attrKey = attr === 'Ataque Especial' ? 'ataqueEspecial' :
        attr === 'Defesa Especial' ? 'defesaEspecial' :
        attr.toLowerCase()

      // Detectar se é "do usuário" ou do alvo
      const isUser = efeito.substring(Math.max(0, match.index - 30), match.index).includes('usuário')
      const targetPkmn = isUser ? attacker : target

      setGbTempBattleStats(prev => {
        const existing = prev[targetPkmn.id] || { stages: { ataque: 0, defesa: 0, ataqueEspecial: 0, defesaEspecial: 0, velocidade: 0 }, accuracyDebuff: 0 }
        const newStage = Math.max(-6, (existing.stages[attrKey] || 0) - amount)
        return {
          ...prev,
          [targetPkmn.id]: {
            ...existing,
            stages: { ...existing.stages, [attrKey]: newStage }
          }
        }
      })
      addGBChatMessage({
        type: 'effect',
        user: 'Sistema',
        text: `${targetPkmn.nome} perdeu ${amount} Fase(s) de ${attr}!`,
        timestamp
      })
    }

    // Padrão: "Eleva X Fase(s) de [Atributo]"
    const raiseRegex = /[Ee]leva\s+(uma|duas|três|um|dois)\s+Fases?\s+de\s+(Ataque Especial|Defesa Especial|Ataque|Defesa|Velocidade)/gi
    while ((match = raiseRegex.exec(efeito)) !== null) {
      const amount = numMap[match[1].toLowerCase()] || 1
      const attr = match[2]
      const attrKey = attr === 'Ataque Especial' ? 'ataqueEspecial' :
        attr === 'Defesa Especial' ? 'defesaEspecial' :
        attr.toLowerCase()

      const isUser = efeito.substring(Math.max(0, match.index - 30), match.index + match[0].length + 30).includes('usuário')
      const targetPkmn = isUser ? attacker : target

      setGbTempBattleStats(prev => {
        const existing = prev[targetPkmn.id] || { stages: { ataque: 0, defesa: 0, ataqueEspecial: 0, defesaEspecial: 0, velocidade: 0 }, accuracyDebuff: 0 }
        const newStage = Math.min(6, (existing.stages[attrKey] || 0) + amount)
        return {
          ...prev,
          [targetPkmn.id]: {
            ...existing,
            stages: { ...existing.stages, [attrKey]: newStage }
          }
        }
      })
      addGBChatMessage({
        type: 'effect',
        user: 'Sistema',
        text: `${targetPkmn.nome} ganhou ${amount} Fase(s) de ${attr}!`,
        timestamp
      })
    }

    // Padrão: redução de acurácia do oponente
    const accRegex = /[Rr]eduz.*[Dd]ificuldades?\s+de\s+[Aa]curácia/i
    if (accRegex.test(efeito)) {
      setGbTempBattleStats(prev => {
        const existing = prev[target.id] || { stages: { ataque: 0, defesa: 0, ataqueEspecial: 0, defesaEspecial: 0, velocidade: 0 }, accuracyDebuff: 0 }
        return {
          ...prev,
          [target.id]: {
            ...existing,
            accuracyDebuff: (existing.accuracyDebuff || 0) + 1
          }
        }
      })
      addGBChatMessage({
        type: 'effect',
        user: 'Sistema',
        text: `A acurácia dos golpes de ${target.nome} foi reduzida em 1!`,
        timestamp
      })
    }
  }

  const sendNpcTrainerToBattle = (trainer) => {
    const fakeTrainerNames = ['Treinador A', 'Treinador B', 'Treinador C', 'Treinador D', 'Treinador E', 'Pessoa Misteriosa', 'Fulano', 'Ciclano', 'Beltrano', 'Aspirante', 'Novato', 'Veterano']
    const fakeTrainerName = fakeTrainerNames[Math.floor(Math.random() * fakeTrainerNames.length)]

    const battleData = {
      id: `npc-trainer-${Date.now()}-${Math.random()}`,
      nome: trainer.name,
      nomeFalso: fakeTrainerName,
      hp: trainer.currentHP !== undefined ? trainer.currentHP : trainer.hp,
      maxHP: trainer.hp,
      velocidade: trainer.attributes.velocidade,
      evasaoFisica: Math.floor(trainer.attributes.defesa / 5),
      evasaoEspecial: Math.floor(trainer.attributes.defesaEspecial / 5),
      evasaoVeloz: Math.floor(trainer.attributes.velocidade / 5),
      isNpc: true,
      npcId: trainer.id,
      level: trainer.level || 1,
      ataque: trainer.attributes.ataque || 0,
      ataqueEspecial: trainer.attributes.ataqueEspecial || 0,
      baseAttributes: {
        defesa: trainer.attributes.defesa,
        defesaEspecial: trainer.attributes.defesaEspecial,
        velocidade: trainer.attributes.velocidade,
        ataque: trainer.attributes.ataque,
        ataqueEspecial: trainer.attributes.ataqueEspecial
      }
    }
    setBattleTrainers(prev => [...prev, battleData])
    alert(`${battleData.nome} enviado para a Batalha!`)
  }

  // Funções de controle da Batalha
  const sortBySpeed = (entities) => {
    // Ordena por velocidade decrescente
    return [...entities].sort((a, b) => b.velocidade - a.velocidade)
  }

  const mountTrainerBattle = async () => {
    if (battleTrainers.length === 0) {
      alert('Nenhum treinador para montar a batalha!')
      return
    }
    const sorted = sortBySpeed(battleTrainers)
    setBattleTrainersList(sorted)
    setBattleTrainers([])
    setCurrentTrainerTurn(0)
    setTrainerRound(1)

    // Salvar no Firebase imediatamente (stages são salvos em paths separados)
    if (useFirebase) {
      await saveBattleData({
        battleTrainers: [],
        battlePokemon,
        battleTrainersList: sorted,
        battlePokemonList,
        currentTrainerTurn: 0,
        currentPokemonTurn,
        trainerRound: 1,
        pokemonRound,
        battlePokemonConditions,
        revealedNpcPokemon,
        revealedTrainers
      })
    }
  }

  const mountPokemonBattle = async () => {
    if (battlePokemon.length === 0) {
      alert('Nenhum pokémon para montar a batalha!')
      return
    }
    const sorted = sortBySpeed(battlePokemon)
    setBattlePokemonList(sorted)
    setBattlePokemon([])
    setCurrentPokemonTurn(0)
    setPokemonRound(1)

    // Salvar no Firebase imediatamente (stages são salvos em paths separados)
    if (useFirebase) {
      await saveBattleData({
        battleTrainers,
        battlePokemon: [],
        battleTrainersList,
        battlePokemonList: sorted,
        currentTrainerTurn,
        currentPokemonTurn: 0,
        trainerRound,
        pokemonRound: 1,
        battlePokemonConditions,
        revealedNpcPokemon,
        revealedTrainers
      })
    }
  }

  const removeTrainerFromBattle = async (trainerId) => {
    // Remover o treinador da lista de batalha e ajustar o turno
    const newList = battleTrainersList.filter(t => t.id !== trainerId)
    let newTurn = currentTrainerTurn

    // Ajustar o turno atual se necessário
    if (currentTrainerTurn >= newList.length && newList.length > 0) {
      newTurn = newList.length - 1
      setCurrentTrainerTurn(newTurn)
    } else if (newList.length === 0) {
      newTurn = 0
      setCurrentTrainerTurn(0)
    }

    setBattleTrainersList(newList)

    // Limpar condições desse treinador
    const newConditions = { ...battleTrainerConditions }
    delete newConditions[trainerId]
    setBattleTrainerConditions(newConditions)

    // Limpar estágios desse treinador
    const newStages = { ...trainerStages }
    delete newStages[trainerId]
    setTrainerStages(newStages)
    if (useFirebase) {
      saveTrainerStages(newStages)
    }

    // Limpar estado revelado
    const newRevealed = { ...revealedTrainers }
    delete newRevealed[trainerId]
    setRevealedTrainers(newRevealed)

    // Salvar no Firebase para sincronizar em tempo real
    if (useFirebase) {
      await saveBattleData({
        battleTrainers,
        battlePokemon,
        battleTrainersList: newList,
        battlePokemonList,
        currentTrainerTurn: newTurn,
        currentPokemonTurn,
        trainerRound,
        pokemonRound,
        battlePokemonConditions,
        battleTrainerConditions: newConditions,
        revealedNpcPokemon,
        revealedTrainers: newRevealed
      })
    }
  }

  const removePokemonFromBattle = async (pokemonId) => {
    // Remover o pokémon da lista de batalha e ajustar o turno
    const newList = battlePokemonList.filter(p => p.id !== pokemonId)
    let newTurn = currentPokemonTurn

    // Ajustar o turno atual se necessário
    if (currentPokemonTurn >= newList.length && newList.length > 0) {
      newTurn = newList.length - 1
      setCurrentPokemonTurn(newTurn)
    } else if (newList.length === 0) {
      newTurn = 0
      setCurrentPokemonTurn(0)
    }

    setBattlePokemonList(newList)

    // Limpar condições desse pokémon
    const newConditions = { ...battlePokemonConditions }
    delete newConditions[pokemonId]
    setBattlePokemonConditions(newConditions)

    // Limpar estágios desse pokémon
    const newStages = { ...pokemonStages }
    delete newStages[pokemonId]
    setPokemonStages(newStages)
    if (useFirebase) {
      savePokemonStages(newStages)
    }

    // Limpar estado revelado se for NPC
    const newRevealed = { ...revealedNpcPokemon }
    delete newRevealed[pokemonId]
    setRevealedNpcPokemon(newRevealed)

    // Se era o pokémon selecionado, limpar seleção
    if (selectedMasterNpcPokemon?.id === pokemonId) {
      setSelectedMasterNpcPokemon(null)
    }

    // Salvar no Firebase para sincronizar em tempo real
    if (useFirebase) {
      await saveBattleData({
        battleTrainers,
        battlePokemon,
        battleTrainersList,
        battlePokemonList: newList,
        currentTrainerTurn,
        currentPokemonTurn: newTurn,
        trainerRound,
        pokemonRound,
        battlePokemonConditions: newConditions,
        battleTrainerConditions,
        revealedNpcPokemon: newRevealed,
        revealedTrainers
      })
    }
  }

  // Função para alternar estado de uma insígnia
  const toggleBadge = (region, index) => {
    setBadges(prev => ({
      ...prev,
      [region]: prev[region].map((collected, i) => i === index ? !collected : collected)
    }))
  }

  const addToTrainerBattle = () => {
    if (battleTrainers.length === 0) {
      alert('Nenhum treinador para adicionar!')
      return
    }
    // Combina a lista atual com os novos e reordena
    const combined = [...battleTrainersList, ...battleTrainers]
    const sorted = sortBySpeed(combined)
    setBattleTrainersList(sorted)
    setBattleTrainers([])
    // Mantém o turno atual se houver itens
    if (battleTrainersList.length === 0) {
      setCurrentTrainerTurn(0)
      setTrainerRound(1)
    }
  }

  const addToPokemonBattle = () => {
    if (battlePokemon.length === 0) {
      alert('Nenhum pokémon para adicionar!')
      return
    }
    // Combina a lista atual com os novos e reordena
    const combined = [...battlePokemonList, ...battlePokemon]
    const sorted = sortBySpeed(combined)
    setBattlePokemonList(sorted)
    setBattlePokemon([])
    // Mantém o turno atual se houver itens
    if (battlePokemonList.length === 0) {
      setCurrentPokemonTurn(0)
      setPokemonRound(1)
    }
  }

  const advanceTrainerTurn = () => {
    if (battleTrainersList.length === 0) return

    const nextTurn = currentTrainerTurn + 1
    if (nextTurn >= battleTrainersList.length) {
      // Volta para o início e incrementa a rodada
      setCurrentTrainerTurn(0)
      setTrainerRound(prev => prev + 1)
    } else {
      setCurrentTrainerTurn(nextTurn)
    }
  }

  const advancePokemonTurn = () => {
    if (battlePokemonList.length === 0) return

    const nextTurn = currentPokemonTurn + 1
    if (nextTurn >= battlePokemonList.length) {
      // Volta para o início e incrementa a rodada
      setCurrentPokemonTurn(0)
      setPokemonRound(prev => prev + 1)

      // Incrementar contador de rodadas de todas as condições
      const updatedConditions = {}
      Object.keys(battlePokemonConditions).forEach(pokemonId => {
        const conditions = battlePokemonConditions[pokemonId]
        updatedConditions[pokemonId] = conditions.map(cond => {
          if (cond !== null) {
            return { ...cond, rounds: cond.rounds + 1 }
          }
          return null
        })
      })
      setBattlePokemonConditions(updatedConditions)

      // Rolar para o primeiro Pokémon
      setTimeout(() => {
        if (pokemonBattleRefs.current[0]) {
          pokemonBattleRefs.current[0].scrollIntoView({
            behavior: 'smooth',
            block: 'center'
          })
        }
      }, 100)
    } else {
      setCurrentPokemonTurn(nextTurn)

      // Rolar para o próximo Pokémon
      setTimeout(() => {
        if (pokemonBattleRefs.current[nextTurn]) {
          pokemonBattleRefs.current[nextTurn].scrollIntoView({
            behavior: 'smooth',
            block: 'center'
          })
        }
      }, 100)
    }
  }

  // Carregar dados da Pokédex completa
  useEffect(() => {
    setFullPokedexData(pokedexData)
  }, [])

  // Escutar mensagens do iframe do gerador
  useEffect(() => {
    const handleMessage = (event) => {
      // Verificar se a mensagem vem do gerador de Pokémon
      if (event.data && event.data.type === 'POKEMON_GENERATED') {
        const pokemonData = event.data.pokemon
        console.log('Pokémon recebido do gerador:', pokemonData)
        console.log('Species:', pokemonData.species)
        console.log('Name:', pokemonData.name)

        // Gerar golpes automaticamente para o Pokémon NPC
        const speciesName = pokemonData.species || pokemonData.name
        console.log('Espécie para buscar golpes:', speciesName)
        console.log('Gênero do Pokémon:', pokemonData.gender)

        const generatedMoves = generatePokemonMoves(
          speciesName,
          pokemonData.level || 5,
          false, // includeEvolutionMove - pode ser ajustado conforme necessário
          pokemonData.gender // Passa o gênero para espécies como Meowstic
        )

        console.log('Golpes gerados:', generatedMoves)

        // Buscar dados da espécie na Pokédex para obter peso e altura
        const speciesData = pokedexData.find(p =>
          p.nome.toLowerCase() === speciesName.toLowerCase()
        )

        // Adicionar golpes, peso e altura ao pokemonData
        const pokemonWithMoves = {
          ...pokemonData,
          golpesAprendidos: generatedMoves,
          weight: pokemonData.weight || (speciesData ? speciesData.peso : 0),
          height: pokemonData.height || (speciesData ? speciesData.altura : 0),
          addedToNpc: false
        }

        // Armazenar na lista de Pokémon gerados recentemente
        setNpcPokemonList(prev => {
          // Evitar duplicatas verificando se já existe
          const exists = prev.some(p => p.id === pokemonData.id)
          if (exists) return prev
          return [...prev, pokemonWithMoves]
        })
      }
    }

    window.addEventListener('message', handleMessage)
    return () => window.removeEventListener('message', handleMessage)
  }, [])


  // Carregar dados do Firebase/LocalStorage
  useEffect(() => {
    // Resetar flag ao mudar de usuário para evitar salvar antes de carregar
    setDataLoaded(false)

    const loadData = async () => {
      if (currentUser?.type === 'treinador') {
        try {
          // Carregar do Firebase
          const data = useFirebase
            ? await loadTrainerData(currentUser.username)
            : JSON.parse(localStorage.getItem(`trainer_${currentUser.username}`) || 'null')

          if (data) {
            setLevel(data.level || 1)
            setImage(data.image || '')
            setClasses(data.classes || ['', '', '', ''])
            setAttributes(data.attributes || { saude: 10, ataque: 10, defesa: 10, ataqueEspecial: 10, defesaEspecial: 10, velocidade: 10 })
            setSkills({
              saude: data.skills?.saude || [],
              ataque: data.skills?.ataque || [],
              defesa: data.skills?.defesa || [],
              ataqueEspecial: data.skills?.ataqueEspecial || [],
              defesaEspecial: data.skills?.defesaEspecial || [],
              velocidade: data.skills?.velocidade || []
            })
            setCurrentHP(data.currentHP || 44)
            setMainTeam(data.mainTeam || [])
            setPcPokemon(data.pcPokemon || [])
            setPokedex(data.pokedex || [])
            setPokemonedas(data.pokemonedas || 0)
            setPokecaixinha(data.pokecaixinha || 0)
            setKeyItems(data.keyItems || [])
            setCustomItems(data.customItems || [])
            setPokeovoList(data.pokeovoList || [])
            setFotografias(data.fotografias || [])
            // Migração: converter talentos antigos (strings) para objetos
            const migratedTalentos = (data.talentosSelected || []).map(tal => {
              if (typeof tal === 'string') {
                // Procurar o talento completo nos dados
                let foundTalento = null
                Object.values(TALENTOS_DATA).forEach(classeTalentos => {
                  const found = classeTalentos.find(t => t.nome === tal)
                  if (found) foundTalento = found
                })
                return foundTalento || { nome: tal, descricao: '', efeito: '', frequencia: '' }
              }
              return tal
            })

            setCaracteristicasSelected(data.caracteristicasSelected || [])
            setTalentosSelected(migratedTalentos)
            setPokemonImages(data.pokemonImages || {})
            setBadges(data.badges || {
              Kanto: [false, false, false, false, false, false, false, false, false],
              Johto: [false, false, false, false, false, false, false, false, false],
              Hoenn: [false, false, false, false, false, false, false, false, false],
              Sinnoh: [false, false, false, false, false, false, false, false, false],
              Unova: [false, false, false, false, false, false, false, false, false, false, false, false],
              Kalos: [false, false, false, false, false, false, false, false, false]
            })
            setEstilizadorBattery(data.estilizadorBattery !== undefined ? data.estilizadorBattery : 10)
            setEstilizadorPolicialBattery(data.estilizadorPolicialBattery !== undefined ? data.estilizadorPolicialBattery : 30)
            setThunderStoneActive(data.thunderStoneActive || false)
            setBolsaTalento(data.bolsaTalento || 0)
            setOtherCapacities(data.otherCapacities || [])
            setVivencias(data.vivencias || [])
            setConquistas(data.conquistas || [])
            setCiclos(data.ciclos || [])
            setUserBattleModifiers(data.userBattleModifiers || {})
            setUserActiveModifiers(data.userActiveModifiers || {})
            setTalentinhos(data.talentinhos || [])
            setBackground(data.background || '')
            setLimitesUsoPersonalizados(data.limitesUsoPersonalizados || [])
            setLimitesUsoPersonalizadosUsosAtuais(data.limitesUsoPersonalizadosUsosAtuais || {})
          }
          // Marcar dados como carregados após carregar tudo
          setDataLoaded(true)
        } catch (e) {
          console.error('Erro ao carregar dados do treinador:', e)
          setDataLoaded(true) // Marcar como carregado mesmo com erro
        }
        // Carregar itens ocultos da Pokéloja (para exibir corretamente na loja)
        if (useFirebase) {
          try {
            const hiddenItems = await loadHiddenPokelojaItems()
            setHiddenPokelojaItems(hiddenItems || [])
          } catch (e) {
            console.error('Erro ao carregar itens ocultos da Pokéloja:', e)
          }
          // Carregar preços customizados da Pokéloja
          try {
            const prices = await loadCustomPrices()
            setCustomPrices(prices || {})
          } catch (e) {
            console.error('Erro ao carregar preços customizados:', e)
          }
        }
        // Definir área inicial como Treinador
        setCurrentArea('Treinador')
      } else if (currentUser?.type === 'mestre') {
        // Carregar configurações do mestre
        try {
          const data = useFirebase
            ? await loadMestreConfig()
            : JSON.parse(localStorage.getItem('mestre_config') || 'null')

          // Carregar itens ocultos da Pokéloja do caminho dedicado (se Firebase)
          if (useFirebase) {
            const hiddenItems = await loadHiddenPokelojaItems()
            setHiddenPokelojaItems(hiddenItems || [])
            // Carregar preços customizados da Pokéloja
            const prices = await loadCustomPrices()
            setCustomPrices(prices || {})
          } else if (data) {
            setHiddenPokelojaItems(data.hiddenPokelojaItems || [])
          }

          if (data) {
            setNpcPokemon(data.npcPokemon || [])
            setNpcPokemonList(data.npcPokemonList || [])
            setBattleTrainers(data.battleTrainers || [])
            setBattlePokemon(data.battlePokemon || [])
            setBattleTrainersList(data.battleTrainersList || [])
            setBattlePokemonList(data.battlePokemonList || [])
            setCurrentTrainerTurn(data.currentTrainerTurn || 0)
            setCurrentPokemonTurn(data.currentPokemonTurn || 0)
            setTrainerRound(data.trainerRound || 1)
            setPokemonRound(data.pokemonRound || 1)
            setNpcConditions(data.npcConditions || {})
            setExpandedNpcCards(data.expandedNpcCards || [])
            setRevealedNpcPokemon(data.revealedNpcPokemon || {})
            setRevealedTrainers(data.revealedTrainers || {})
            setBattlePokemonConditions(data.battlePokemonConditions || {})

            // Migrar stages antigos do mestre_config para paths separados (se existirem)
            if (useFirebase && (data.pokemonStages || data.trainerStages)) {
              const existingPokemonStages = await loadPokemonStages()
              const existingTrainerStages = await loadTrainerStages()

              // Só migra se os paths separados estiverem vazios
              if (data.pokemonStages && Object.keys(data.pokemonStages).length > 0 &&
                  (!existingPokemonStages || Object.keys(existingPokemonStages).length === 0)) {
                await savePokemonStages(data.pokemonStages)
              }
              if (data.trainerStages && Object.keys(data.trainerStages).length > 0 &&
                  (!existingTrainerStages || Object.keys(existingTrainerStages).length === 0)) {
                await saveTrainerStages(data.trainerStages)
              }
            }
            setBattleTrainerConditions(data.battleTrainerConditions || {})
            setUserBattleModifiers(data.userBattleModifiers || {})
            setUserActiveModifiers(data.userActiveModifiers || {})
            setPokemonImages(data.pokemonImages || {}) // Carregar imagens de Pokémon NPC
            setArchivedNpcTrainers(data.archivedNpcTrainers || []) // Carregar Treinadores NPC arquivados
            setArchivedNpcPokemon(data.archivedNpcPokemon || []) // Carregar Pokémon NPC arquivados
            setMasterItems(data.masterItems || []) // Carregar Bugigangas do Mestre
            setMasterItemsSent(data.masterItemsSent || []) // Carregar Bugigangas enviadas
          }
          // Carregar dados do Hub de Troca
          if (useFirebase) {
            try {
              const tradeData = await loadTradeHub()
              setTradeHubOffers(tradeData.trades || [])
              setTradeHubCompletedTrades(tradeData.completedTrades || {})
            } catch (e) {
              console.error('Erro ao carregar Hub de Troca:', e)
            }
          }
          // Marcar dados como carregados após carregar tudo
          setDataLoaded(true)
        } catch (e) {
          console.error('Erro ao carregar configurações do mestre:', e)
          setDataLoaded(true) // Marcar como carregado mesmo com erro
        }
      }
    }

    loadData()
  }, [currentUser])

  // Escutar mudanças em tempo real nos dados do treinador (para receber Pokémon NPC enviados pelo mestre)
  useEffect(() => {
    if (!useFirebase || !currentUser || currentUser.type !== 'treinador') return

    const unsubscribe = subscribeToTrainer(currentUser.username, (data) => {
      if (!data) return

      // Atualizar mainTeam se houver novos Pokémon
      if (data.mainTeam) {
        setMainTeam(prevTeam => {
          // Limpar IDs do ref quando Firebase confirmou a remoção
          for (const id of locallyRemovedFromTeamRef.current) {
            if (!data.mainTeam.some(p => p.id === id)) {
              locallyRemovedFromTeamRef.current.delete(id)
            }
          }
          const prevIds = new Set(prevTeam.map(p => p.id))
          // Ignorar IDs que foram removidos localmente (evita re-adição por dados stale do Firebase)
          const newPokemon = data.mainTeam.filter(p =>
            !prevIds.has(p.id) && !locallyRemovedFromTeamRef.current.has(p.id)
          )
          if (newPokemon.length > 0) {
            console.log('[Sync] Novos Pokémon recebidos no time:', newPokemon)
            return [...prevTeam, ...newPokemon]
          }
          return prevTeam
        })
      }

      // Atualizar pcPokemon se houver novos Pokémon
      if (data.pcPokemon) {
        setPcPokemon(prevPc => {
          // Limpar IDs do ref quando Firebase confirmou a remoção
          for (const id of locallyRemovedFromPcRef.current) {
            if (!data.pcPokemon.some(p => p.id === id)) {
              locallyRemovedFromPcRef.current.delete(id)
            }
          }
          const prevIds = new Set(prevPc.map(p => p.id))
          // Ignorar IDs que foram removidos localmente (evita re-adição por dados stale do Firebase)
          const newPokemon = data.pcPokemon.filter(p =>
            !prevIds.has(p.id) && !locallyRemovedFromPcRef.current.has(p.id)
          )
          if (newPokemon.length > 0) {
            console.log('[Sync] Novos Pokémon recebidos no PC:', newPokemon)
            return [...prevPc, ...newPokemon]
          }
          return prevPc
        })
      }

      // Atualizar pokédex se houver novos registros
      if (data.pokedex) {
        setPokedex(prevPokedex => {
          const prevSpecies = new Set(prevPokedex.map(p => p.species))
          const newEntries = data.pokedex.filter(p => !prevSpecies.has(p.species))

          if (newEntries.length > 0) {
            console.log('[Sync] Novas entradas na Pokédex:', newEntries)
            return data.pokedex
          }

          // Verificar se algum Pokémon foi marcado como capturado
          const hasNewCaptures = data.pokedex.some(p => {
            const local = prevPokedex.find(lp => lp.species === p.species)
            return local && !local.isCaptured && p.isCaptured
          })

          if (hasNewCaptures) {
            return data.pokedex
          }

          return prevPokedex
        })
      }
    })

    return () => unsubscribe()
  }, [currentUser, useFirebase])

  // Escutar mudanças na Batalha Game Boy em tempo real
  useEffect(() => {
    if (!useFirebase || !currentUser) return
    const unsubscribe = subscribeToGBBattle((data) => {
      if (!data) return
      setGbBattleData(data)
    })
    return () => unsubscribe()
  }, [currentUser, useFirebase])

  // Escutar mudanças no chat da Batalha Game Boy em tempo real
  useEffect(() => {
    if (!useFirebase || !currentUser) return
    const unsubscribe = subscribeToGBChatMessages((messages) => {
      setGbChatMessages(messages || [])
    })
    return () => unsubscribe()
  }, [currentUser, useFirebase])

  // Escutar mudanças nos Times NPC em tempo real
  useEffect(() => {
    if (!useFirebase || !currentUser || currentUser.type !== 'mestre') return
    const unsubscribe = subscribeToNpcTeams((data) => {
      npcTeamsSaveSkipRef.current = true
      setNpcTeams(data || [])
    })
    return () => unsubscribe()
  }, [currentUser, useFirebase])

  // Auto-save dos Times NPC
  useEffect(() => {
    if (!useFirebase || !currentUser || currentUser.type !== 'mestre') return
    if (npcTeamsSaveSkipRef.current) {
      npcTeamsSaveSkipRef.current = false
      return
    }
    saveNpcTeams(npcTeams)
  }, [npcTeams])

  // Escutar mudanças nos Cenários da Sessão em tempo real (mestre)
  useEffect(() => {
    if (!useFirebase || !currentUser || currentUser.type !== 'mestre') return
    const unsubscribe = subscribeToSessionScenarios((data) => {
      sessionScenariosSaveSkipRef.current = true
      setSessionScenarios(data || [])
    })
    return () => unsubscribe()
  }, [currentUser, useFirebase])

  // Auto-save dos Cenários da Sessão
  useEffect(() => {
    if (!useFirebase || !currentUser || currentUser.type !== 'mestre') return
    if (sessionScenariosSaveSkipRef.current) {
      sessionScenariosSaveSkipRef.current = false
      return
    }
    saveSessionScenarios(sessionScenarios)
  }, [sessionScenarios])

  // Escutar estado de exibição do cenário (todos os usuários)
  useEffect(() => {
    if (!useFirebase || !currentUser) return
    const unsubscribe = subscribeToScenarioDisplay((data) => {
      scenarioDisplaySaveSkipRef.current = true
      setScenarioDisplay(data)
      // Quando o mestre ativa o popup, abrir para jogadores
      if (data?.active && currentUser.type === 'treinador') {
        setPlayerScenarioPopupOpen(true)
      }
    })
    return () => unsubscribe()
  }, [currentUser, useFirebase])

  // Auto-save do estado de exibição do cenário (mestre)
  useEffect(() => {
    if (!useFirebase || !currentUser || currentUser.type !== 'mestre') return
    if (scenarioDisplaySaveSkipRef.current) {
      scenarioDisplaySaveSkipRef.current = false
      return
    }
    saveScenarioDisplay(scenarioDisplay)
  }, [scenarioDisplay])

  // Escutar mudanças no Hub de Troca em tempo real (para treinadores e mestre)
  useEffect(() => {
    if (!useFirebase || !currentUser) return

    const unsubscribe = subscribeToTradeHub((data) => {
      if (!data) return
      setTradeHubOffers(data.trades || [])
      setTradeHubCompletedTrades(data.completedTrades || {})
    })

    return () => unsubscribe()
  }, [currentUser, useFirebase])

  // Salvar no Firebase/LocalStorage
  useEffect(() => {
    // Não salvar se os dados ainda não foram carregados (evita sobrescrever com dados vazios)
    if (!dataLoaded) return

    const saveData = async () => {
      if (currentUser?.type === 'treinador') {
        // Filtrar pokemonImages: salvar apenas URLs, ignorar base64
        const urlOnlyPokemonImages = {}
        for (const [key, value] of Object.entries(pokemonImages)) {
          if (value && !value.startsWith('data:')) {
            urlOnlyPokemonImages[key] = value
          }
        }
        // Imagem do treinador: salvar apenas se for URL
        const imageToSave = (image && !image.startsWith('data:')) ? image : ''

        // Filtrar customPokeballImage base64 dos pokémon (manter apenas URLs)
        const filterPokeballBase64 = (pokemon) => {
          if (pokemon.customPokeballImage && pokemon.customPokeballImage.startsWith('data:')) {
            const { customPokeballImage, ...rest } = pokemon
            return rest
          }
          return pokemon
        }
        const filteredMainTeam = mainTeam.map(filterPokeballBase64)
        const filteredPcPokemon = pcPokemon.map(filterPokeballBase64)

        const data = {
          level, image: imageToSave, classes, attributes, skills, currentHP,
          mainTeam: filteredMainTeam, pcPokemon: filteredPcPokemon, pokedex,
          pokemonedas, pokecaixinha, keyItems, customItems, pokeovoList,
          caracteristicasSelected, talentosSelected,
          pokemonImages: urlOnlyPokemonImages, badges,
          estilizadorBattery, estilizadorPolicialBattery, thunderStoneActive,
          bolsaTalento, otherCapacities,
          vivencias, conquistas, ciclos,
          userBattleModifiers, userActiveModifiers,
          talentinhos,
          background,
          limitesUsoPersonalizados,
          limitesUsoPersonalizadosUsosAtuais,
          fotografias
        }
        try {
          if (useFirebase) {
            await saveTrainerData(currentUser.username, data)
            console.log('[Save] Dados salvos no Firebase (apenas URLs de imagens)')
          } else {
            localStorage.setItem(`trainer_${currentUser.username}`, JSON.stringify(data))
            console.log('[Save] Dados salvos no localStorage')
          }
        } catch (error) {
          console.error('Erro ao salvar dados do treinador:', error)
          if (error.name === 'QuotaExceededError') {
            alert('Espaço de armazenamento cheio! Remova algumas imagens de pokémon ou use URLs ao invés de arquivos locais.')
          }
        }
      } else if (currentUser?.type === 'mestre') {
        const data = {
          hiddenPokelojaItems,
          customPrices,
          npcPokemon,
          npcPokemonList,
          battleTrainers,
          battlePokemon,
          battleTrainersList,
          battlePokemonList,
          currentTrainerTurn,
          currentPokemonTurn,
          trainerRound,
          pokemonRound,
          npcConditions,
          expandedNpcCards,
          revealedNpcPokemon,
          revealedTrainers,
          // NOTA: pokemonStages e trainerStages são salvos em paths separados (battleStages/)
          battlePokemonConditions,
          battleTrainerConditions,
          userBattleModifiers,
          userActiveModifiers,
          pokemonImages: (() => {
            const filtered = {}
            for (const [key, value] of Object.entries(pokemonImages)) {
              if (value && !value.startsWith('data:')) {
                filtered[key] = value
              }
            }
            return filtered
          })(), // Salvar apenas URLs de imagens de Pokémon NPC
          archivedNpcTrainers, // Treinadores NPC arquivados
          archivedNpcPokemon, // Pokémon NPC arquivados
          masterItems, // Bugigangas do Mestre
          masterItemsSent // Bugigangas enviadas
        }
        try {
          if (useFirebase) {
            await saveMestreConfig(data)
          } else {
            localStorage.setItem('mestre_config', JSON.stringify(data))
          }
        } catch (error) {
          console.error('Erro ao salvar configurações do mestre:', error)
        }
      }
    }

    // Debounce para evitar muitas escritas
    const timeoutId = setTimeout(saveData, 500)
    return () => clearTimeout(timeoutId)
  }, [level, image, classes, attributes, skills, currentHP, mainTeam, pcPokemon, pokedex, pokemonedas, pokecaixinha, keyItems, customItems, pokeovoList, caracteristicasSelected, talentosSelected, pokemonImages, badges, estilizadorBattery, estilizadorPolicialBattery, thunderStoneActive, bolsaTalento, otherCapacities, vivencias, conquistas, ciclos, userBattleModifiers, userActiveModifiers, talentinhos, background, limitesUsoPersonalizados, limitesUsoPersonalizadosUsosAtuais, fotografias, hiddenPokelojaItems, customPrices, npcPokemon, npcPokemonList, battleTrainers, battlePokemon, battleTrainersList, battlePokemonList, currentTrainerTurn, currentPokemonTurn, trainerRound, pokemonRound, npcConditions, expandedNpcCards, revealedNpcPokemon, revealedTrainers, battlePokemonConditions, battleTrainerConditions, archivedNpcTrainers, archivedNpcPokemon, masterItems, masterItemsSent, currentUser])

  // Salvar Hub de Troca separadamente (mestre)
  const tradeHubSaveSkipRef = useRef(true)
  useEffect(() => {
    if (!dataLoaded || !currentUser || currentUser.type !== 'mestre' || !useFirebase) return
    if (tradeHubSaveSkipRef.current) {
      tradeHubSaveSkipRef.current = false
      return
    }
    const timeoutId = setTimeout(() => {
      saveTradeHub({ trades: tradeHubOffers, completedTrades: tradeHubCompletedTrades })
    }, 500)
    return () => clearTimeout(timeoutId)
  }, [tradeHubOffers, tradeHubCompletedTrades, dataLoaded, currentUser])

  // Salvar dados de batalha no mestre_config mesmo quando for treinador
  useEffect(() => {
    const saveBattleDataFromTrainer = async () => {
      if (currentUser?.type === 'treinador') {
        try {
          let mestreData = {}

          if (useFirebase) {
            mestreData = await loadMestreConfig() || {}
          } else {
            const saved = localStorage.getItem('mestre_config')
            if (saved) {
              mestreData = JSON.parse(saved)
            }
          }

          // Atualizar apenas os dados de batalha
          // NOTA: pokemonStages são salvos em paths separados (battleStages/)
          const updatedData = {
            ...mestreData,
            battleTrainers,
            battlePokemon,
            battleTrainersList,
            battlePokemonList,
            battlePokemonConditions,
            userBattleModifiers,
            userActiveModifiers,
            revealedNpcPokemon
          }

          if (useFirebase) {
            await saveMestreConfig(updatedData)
          } else {
            localStorage.setItem('mestre_config', JSON.stringify(updatedData))
          }
        } catch (error) {
          console.error('Erro ao salvar dados de batalha:', error)
        }
      }
    }

    const timeoutId = setTimeout(saveBattleDataFromTrainer, 500)
    return () => clearTimeout(timeoutId)
  }, [battleTrainers, battlePokemon, battleTrainersList, battlePokemonList, battlePokemonConditions, userBattleModifiers, userActiveModifiers, revealedNpcPokemon, currentUser])

  // Carregar dados de batalha na inicialização
  useEffect(() => {
    const loadBattleDataOnInit = async () => {
      if (currentUser) {
        try {
          // Carregar dados de batalha global do Firebase
          if (useFirebase) {
            const battleData = await loadBattleData()
            if (battleData) {
              if (Array.isArray(battleData.battleTrainers)) setBattleTrainers(battleData.battleTrainers)
              if (Array.isArray(battleData.battlePokemon)) setBattlePokemon(battleData.battlePokemon)
              if (Array.isArray(battleData.battleTrainersList)) setBattleTrainersList(battleData.battleTrainersList)
              if (Array.isArray(battleData.battlePokemonList)) setBattlePokemonList(battleData.battlePokemonList)
              if (battleData.currentTrainerTurn !== undefined) setCurrentTrainerTurn(battleData.currentTrainerTurn)
              if (battleData.currentPokemonTurn !== undefined) setCurrentPokemonTurn(battleData.currentPokemonTurn)
              if (battleData.trainerRound !== undefined) setTrainerRound(battleData.trainerRound)
              if (battleData.pokemonRound !== undefined) setPokemonRound(battleData.pokemonRound)
              // NOTA: stages são carregados de path separado
              if (battleData.battlePokemonConditions) setBattlePokemonConditions(battleData.battlePokemonConditions)
              if (battleData.revealedNpcPokemon) setRevealedNpcPokemon(battleData.revealedNpcPokemon)
              if (battleData.revealedTrainers) setRevealedTrainers(battleData.revealedTrainers)
            }

            // NOTA: stages são carregados automaticamente pelas subscriptions em tempo real
            // (subscribeToPokemonStages e subscribeToTrainerStages)
          } else {
            // Fallback para localStorage
            let data = null
            const key = currentUser.type === 'mestre' ? 'mestre_config' : `treinador_${currentUser.username}`
            const saved = localStorage.getItem(key)
            if (saved) {
              data = JSON.parse(saved)
            }

            if (data) {
              // Restaurar estados de batalha se existirem
              // NOTA: pokemonStages são carregados de paths separados (battleStages/)
              if (data.userBattleModifiers) setUserBattleModifiers(data.userBattleModifiers)
              if (data.userActiveModifiers) setUserActiveModifiers(data.userActiveModifiers)
              if (data.revealedNpcPokemon) setRevealedNpcPokemon(data.revealedNpcPokemon)
            }
          }
        } catch (e) {
          console.error('Erro ao carregar dados de batalha:', e)
        }
      }
    }

    loadBattleDataOnInit()
  }, [currentUser])

  // Fechar modais com ESC
  useEffect(() => {
    const handleEsc = (e) => {
      if (e.key === 'Escape') {
        // Pokémon Management
        setShowLevelModal(false)
        setShowClassModal(false)
        setShowImageModal(false)
        setShowImagePCModal(false)
        setShowHPModal(false)
        setShowBattleHPModal(false)
        setShowAddPokemonModal(false)
        setShowXPModal(false)
        setShowHappinessModal(false)
        setShowTrainerImageModal(false)
        setShowPokedexDetailModal(false)
        setShowCapacityInfoModal(false)
        setShowHabilidadesModal(false)
        setShowHabilidadeDetailModal(false)
        setShowTalentosModal(false)
        setShowBolsaTalentoModal(false)
        setShowElementalistaTypesModal(false)
        setShowPokemonTypeEditModal(false)
        setShowEvolutionModal(false)
        setShowEditPokemonModal(false)
        setShowEditPokemonPCModal(false)
        setShowHabilidadesPCModal(false)
        setShowPokemonInfoModal(false)
        setShowPokemonHPModal(false)
        setShowSwapPokemonModal(false)
        // Pokéballs & Items
        setShowPokeballModal(false)
        setShowPokeballPCModal(false)
        setShowCustomPokeballOptions(false)
        setShowCustomPokeball2Options(false)
        setShowHeldItemModal(false)
        setShowHeldItemPCModal(false)
        setShowHeldItemDetailModal(false)
        setShowAddKeyItemModal(false)
        setShowAddCustomItemModal(false)
        setShowGiveItemModal(false)
        setShowEditKeyItemQuantityModal(false)
        setShowDeleteConfirmModal(false)
        setShowEditCustomItemModal(false)
        setShowRepairPokeballModal(false)
        setShowPokemonedasModal(false)
        setShowSedexItemModal(false)
        setShowPokeovoSpeciesModal(false)
        setShowHatchMysteryEggModal(false)
        setShowShinyCharmModal(false)
        setShowEditShinyCharmModal(false)
        setShowItemDescriptionModal(false)
        setShowBuyItemModal(false)
        // Battle & Combat
        setShowNpcDamageModal(false)
        setShowSendToTrainerModal(false)
        setShowAbilityModal(false)
        setShowSendXpModal(false)
        setShowSedexPkmModal(false)
        setShowTrainerBattleDamageModal(false)
        setShowNpcTrainerBattleDamageModal(false)
        setShowNpcPokemonBattleDamageModal(false)
        setShowBattleMoveModal(false)
        setShowBattleAbilityModal(false)
        // Modifiers & Healing
        setShowModifierModal(false)
        setShowModifierDetailsModal(false)
        setShowHealingModal(false)
        // Talents
        setShowTalentinhoModal(false)
        setShowTalentinhoDetailModal(false)
        setShowAddLimiteUsoModal(false)
        // Capture & Exploration
        setShowCaptureModal(false)
        setShowAreaNavigationModal(false)
        setShowExoticConfigModal(false)
        setShowScanPokemonModal(false)
        // Commands & Narration
        setShowAcoesComandoModal(false)
        setShowGridModal(false)
        setShowPokecaixinhaModal(false)
        // Character & Progression
        setShowNovaVivenciaModal(false)
        setShowNovaConquistaModal(false)
        setShowFimCicloModal(false)
        setShowAddXpModal(false)
        setShowEditXpModal(false)
        setShowEditCapturaModal(false)
        setShowBackgroundModal(false)
        // Moves & Abilities
        setShowTutoriaModal(false)
        setShowGolpeDetailModal(false)
        setShowPCGolpesModal(false)
        setShowExoticDataModal(false)
        // Name & Info
        setShowNameRaterModal(false)
        setShowNameRaterPCModal(false)
        // Temp/Special
        setShowTempHPModal(false)
        setShowAccountDataModal(false)
        setShowAddLocationModal(false)
        // Trainer & NPC
        setShowCustomTrainerModal(false)
        setShowRandomTrainerModal(false)
        setShowNPCTalentosModal(false)
        setShowSelectTalentosModal(false)
        // Interlúdio/Safari
        setShowRegrasInterludioModal(false)
        setShowInterludioPokemonDamageModal(false)
        setShowInterludioTrainerDamageModal(false)
        setShowSafariNpcDamageModal(false)
        setShowMapaSafariCompletoModal(false)
        setSafariMapSelectedArea(null)
        // Fotografias
        setShowFotografiaModal(false)
      }
    }
    window.addEventListener('keydown', handleEsc)
    return () => window.removeEventListener('keydown', handleEsc)
  }, [])

  // Atualizar HP quando mudar nível ou saúde
  useEffect(() => {
    if (currentUser?.type === 'treinador') {
      const newMaxHP = getMaxHP()
      setCurrentHP(newMaxHP)
    }
  }, [level, attributes.saude, currentUser])

  // Persistir NPCs no Firebase/LocalStorage
  useEffect(() => {
    const loadNpcs = async () => {
      if (currentUser) {
        try {
          if (useFirebase) {
            const npcs = await loadNpcTrainers(currentUser.username)
            if (npcs && npcs.length > 0) {
              setNpcTrainers(npcs)
            }
          } else {
            const saved = localStorage.getItem(`npcTrainers_${currentUser.username}`)
            if (saved) {
              setNpcTrainers(JSON.parse(saved))
            }
          }
        } catch (e) {
          console.error('Erro ao carregar NPCs:', e)
        }
      }
    }
    loadNpcs()
  }, [currentUser])

  // Subscribe para mudanças em tempo real nos NPCs (Firebase)
  useEffect(() => {
    if (!useFirebase || !currentUser) return

    // Inscrever para receber atualizações em tempo real
    const unsubscribe = subscribeToNpcTrainers(currentUser.username, (npcs) => {
      setNpcTrainers(npcs || [])
    })

    // Cleanup: cancelar inscrição quando componente desmontar
    return () => {
      if (unsubscribe) unsubscribe()
    }
  }, [currentUser])

  // Subscribe to generated apricorn trees (for trainers and master)
  useEffect(() => {
    if (!useFirebase) return

    const unsubscribe = subscribeToGeneratedApricornTrees((trees) => {
      setGeneratedApricornTrees(trees || [])
    })

    return () => {
      if (unsubscribe) unsubscribe()
    }
  }, [useFirebase])

  // Subscribe to clima (weather) data
  useEffect(() => {
    if (!useFirebase) return
    const unsubClima = subscribeToFirebase('clima', (data) => {
      setCurrentClima(data || null)
    })
    const unsubDeserto = subscribeToFirebase('climaDesertoMode', (data) => {
      setDesertoMode(data || false)
    })
    return () => {
      if (unsubClima) unsubClima()
      if (unsubDeserto) unsubDeserto()
    }
  }, [useFirebase])

  // Load planted trees from trainer data
  useEffect(() => {
    if (currentUser?.type === 'treinador') {
      if (currentUser.plantedTrees) {
        setPlantedTrees(currentUser.plantedTrees)
      }
    }
  }, [currentUser])

  useEffect(() => {
    const saveNpcs = async () => {
      if (currentUser) {
        try {
          if (useFirebase) {
            await saveNpcTrainers(currentUser.username, npcTrainers)
          } else {
            localStorage.setItem(`npcTrainers_${currentUser.username}`, JSON.stringify(npcTrainers))
          }
        } catch (e) {
          console.error('Erro ao salvar NPCs:', e)
        }
      }
    }

    const timeoutId = setTimeout(saveNpcs, 500)
    return () => clearTimeout(timeoutId)
  }, [npcTrainers, currentUser])

  // Salvar espécies exóticas globais no Firebase/LocalStorage
  useEffect(() => {
    const saveExotics = async () => {
      try {
        if (useFirebase) {
          await saveGlobalExoticSpecies(globalExoticSpecies)
        } else {
          localStorage.setItem('globalExoticSpecies', JSON.stringify(globalExoticSpecies))
        }
      } catch (e) {
        console.error('Erro ao salvar espécies exóticas:', e)
      }
    }

    const timeoutId = setTimeout(saveExotics, 500)
    return () => clearTimeout(timeoutId)
  }, [globalExoticSpecies])

  // Carregar espécies exóticas globais na inicialização
  useEffect(() => {
    const loadExotics = async () => {
      try {
        if (useFirebase) {
          const exotics = await loadGlobalExoticSpecies()
          if (exotics && exotics.length > 0) {
            setGlobalExoticSpecies(exotics)
          }
        } else {
          const saved = localStorage.getItem('globalExoticSpecies')
          if (saved) {
            setGlobalExoticSpecies(JSON.parse(saved))
          }
        }
      } catch (e) {
        console.error('Erro ao carregar espécies exóticas:', e)
      }
    }
    loadExotics()
  }, [])

  // Carregar dados do treinador selecionado para visualizar diário
  useEffect(() => {
    const loadDiarioTrainerData = async () => {
      if (selectedDiarioTrainer) {
        try {
          const data = useFirebase
            ? await loadTrainerData(selectedDiarioTrainer)
            : JSON.parse(localStorage.getItem(`trainer_${selectedDiarioTrainer}`) || 'null')
          setSelectedDiarioData(data)
        } catch (e) {
          console.error('Erro ao carregar dados do treinador para diário:', e)
          setSelectedDiarioData(null)
        }
      } else {
        setSelectedDiarioData(null)
      }
    }
    loadDiarioTrainerData()
  }, [selectedDiarioTrainer])

  // Carregar dados do treinador selecionado para visualizar background
  useEffect(() => {
    const loadBackgroundTrainerData = async () => {
      if (selectedBackgroundTrainer) {
        try {
          const data = useFirebase
            ? await loadTrainerData(selectedBackgroundTrainer)
            : JSON.parse(localStorage.getItem(`trainer_${selectedBackgroundTrainer}`) || 'null')
          setSelectedBackgroundData(data)
        } catch (e) {
          console.error('Erro ao carregar dados do treinador para background:', e)
          setSelectedBackgroundData(null)
        }
      } else {
        setSelectedBackgroundData(null)
      }
    }
    loadBackgroundTrainerData()
  }, [selectedBackgroundTrainer])

  // Carregar dados do treinador selecionado para Visão do Mestre (tempo real)
  useEffect(() => {
    if (!selectedTrainer) {
      setSelectedTrainerData(null)
      return
    }

    if (useFirebase) {
      // Usar subscription para tempo real
      const unsubscribe = subscribeToTrainer(selectedTrainer, (data) => {
        setSelectedTrainerData(data)
      })
      return () => {
        if (unsubscribe) unsubscribe()
      }
    } else {
      // Fallback para localStorage
      const data = JSON.parse(localStorage.getItem(`trainer_${selectedTrainer}`) || 'null')
      setSelectedTrainerData(data)
    }
  }, [selectedTrainer])

  // Carregar dados do treinador selecionado para Interlúdio M (tempo real)
  useEffect(() => {
    if (!interludioMSelectedTrainer) {
      setInterludioMTrainerData(null)
      return
    }

    if (useFirebase) {
      const unsubscribe = subscribeToTrainer(interludioMSelectedTrainer, (data) => {
        setInterludioMTrainerData(data)
      })
      return () => {
        if (unsubscribe) unsubscribe()
      }
    } else {
      const data = JSON.parse(localStorage.getItem(`trainer_${interludioMSelectedTrainer}`) || 'null')
      setInterludioMTrainerData(data)
    }
  }, [interludioMSelectedTrainer])

  // Sincronizar chat em tempo real com Firebase
  useEffect(() => {
    if (!useFirebase) return

    // Inscrever para receber atualizações em tempo real
    const unsubscribe = subscribeToChatMessages((messages) => {
      setChatMessages(messages || [])
    })

    // Cleanup: cancelar inscrição quando componente desmontar
    return () => {
      if (unsubscribe) unsubscribe()
    }
  }, [])

  // Função para adicionar mensagem ao chat (Firebase)
  const addChatMessage = async (message) => {
    const newMessage = {
      ...message,
      id: `${Date.now()}-${Math.random()}`
    }

    if (useFirebase) {
      // Adicionar ao Firebase (que vai disparar o listener e atualizar o state)
      // Manter apenas as últimas 10 mensagens para economizar espaço
      const updatedMessages = [...chatMessages, newMessage].slice(-10)
      await saveChatMessages(updatedMessages)
    } else {
      // Fallback para state local - também limitar a 10 mensagens
      setChatMessages(prev => [...prev, newMessage].slice(-10))
    }
  }

  // ==================== FUNÇÕES DAS ÁRVORES DE APRICORN ====================

  const handleProcurarArvores = () => {
    const d6Roll = Math.floor(Math.random() * 6) + 1
    const total = d6Roll + 1
    const timestamp = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })

    // Add chat message
    addChatMessage({
      username: currentUser.username,
      text: `🌳 Procurar Árvores - 1d6+1`,
      timestamp,
      isDiceRoll: true,
      diceResult: `1d6(${d6Roll}) + 1 = ${total} árvores geradas`
    })

    // Generate trees using weighted randomization
    const newTrees = []
    for (let i = 0; i < total; i++) {
      const random = Math.random() * 100
      let cumulative = 0
      let selectedTree = null

      for (const tree of APRICORN_TREES) {
        cumulative += tree.chance
        if (random <= cumulative) {
          selectedTree = tree
          break
        }
      }

      newTrees.push({
        id: `${Date.now()}-${i}-${Math.random()}`,
        ...selectedTree,
        hasFruit: selectedTree.fruit !== null
      })
    }

    const updatedTrees = [...generatedApricornTrees, ...newTrees]
    setGeneratedApricornTrees(updatedTrees)

    if (useFirebase) {
      saveGeneratedApricornTrees(updatedTrees)
    }
  }

  const handleLimparArvores = () => {
    setGeneratedApricornTrees([])
    if (useFirebase) {
      saveGeneratedApricornTrees([])
    }
  }

  const handleColherArvore = (tree) => {
    const d6Roll = Math.floor(Math.random() * 6) + 1
    const timestamp = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })

    // Add to chat
    addChatMessage({
      username: currentUser.username,
      text: `🌳 Colher ${tree.fruit} - 1d6`,
      timestamp,
      isDiceRoll: true,
      diceResult: `1d6 = ${d6Roll} apricorns coletadas`
    })

    // Add apricorns to key items
    const updatedKeyItems = [...keyItems]
    const existingItem = updatedKeyItems.find(item => item.name === tree.fruit)

    if (existingItem) {
      existingItem.quantity += d6Roll
    } else {
      updatedKeyItems.push({ name: tree.fruit, quantity: d6Roll })
    }

    setKeyItems(updatedKeyItems)

    // Show alert
    alert(`Colheu ${d6Roll} ${tree.fruit}!`)

    // Save to Firebase
    if (useFirebase) {
      saveTrainerData(currentUser.username, {
        ...currentUser,
        keyItems: updatedKeyItems
      })
    }
  }

  const handlePlantarArvore = () => {
    if (!plantLocation || !selectedTreeToPlant) {
      alert('Preencha todos os campos!')
      return
    }

    // Verificar se o jogador possui a apricorn correspondente na mochila
    const fruitName = selectedTreeToPlant.fruit
    const apricornItem = keyItems.find(item => item.name === fruitName)
    if (!apricornItem || apricornItem.quantity < 1) {
      alert(`Você não possui ${fruitName} na mochila para plantar esta árvore!`)
      return
    }

    // Remover 1 unidade da apricorn da mochila
    const updatedKeyItems = keyItems
      .map(item =>
        item.name === fruitName
          ? { ...item, quantity: item.quantity - 1 }
          : item
      )
      .filter(item => item.quantity > 0)
    setKeyItems(updatedKeyItems)

    const newPlantedTree = {
      id: `${Date.now()}-${Math.random()}`,
      ...selectedTreeToPlant,
      location: plantLocation,
      isMatured: false,
      daysRemaining: 5,
      plantedDate: new Date().toISOString()
    }

    const updatedPlantedTrees = [...plantedTrees, newPlantedTree]
    setPlantedTrees(updatedPlantedTrees)

    // Save to Firebase
    if (useFirebase) {
      saveTrainerData(currentUser.username, {
        ...currentUser,
        keyItems: updatedKeyItems,
        plantedTrees: updatedPlantedTrees
      })
    }

    // Reset modal
    setShowPlantTreeModal(false)
    setPlantLocation('')
    setSelectedTreeToPlant(null)
    setTreeSearchQuery('')
  }

  const handlePassarDia = (plantedTree) => {
    if (plantedTree.daysRemaining <= 0) {
      alert('A árvore já está pronta para amadurecer!')
      return
    }

    const updatedPlantedTrees = plantedTrees.map(tree =>
      tree.id === plantedTree.id
        ? { ...tree, daysRemaining: tree.daysRemaining - 1 }
        : tree
    )
    setPlantedTrees(updatedPlantedTrees)

    // Save to Firebase
    if (useFirebase) {
      saveTrainerData(currentUser.username, {
        ...currentUser,
        plantedTrees: updatedPlantedTrees
      })
    }
  }

  const handleAmadurecerArvore = (plantedTree) => {
    if (plantedTree.daysRemaining > 0) {
      alert(`A árvore ainda precisa de ${plantedTree.daysRemaining} dias para amadurecer!`)
      return
    }

    // Roll 1d6 for initial harvest
    const d6Roll = Math.floor(Math.random() * 6) + 1
    const timestamp = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })

    // Add to chat
    addChatMessage({
      username: currentUser.username,
      text: `🌱 Árvore Amadureceu - Colheita Inicial 1d6`,
      timestamp,
      isDiceRoll: true,
      diceResult: `1d6 = ${d6Roll} ${plantedTree.fruit}`
    })

    // Add apricorns to key items
    const updatedKeyItems = [...keyItems]
    const existingItem = updatedKeyItems.find(item => item.name === plantedTree.fruit)

    if (existingItem) {
      existingItem.quantity += d6Roll
    } else {
      updatedKeyItems.push({ name: plantedTree.fruit, quantity: d6Roll })
    }

    setKeyItems(updatedKeyItems)

    // Update planted tree to matured
    const updatedPlantedTrees = plantedTrees.map(tree =>
      tree.id === plantedTree.id
        ? { ...tree, isMatured: true, daysRemaining: 0 }
        : tree
    )
    setPlantedTrees(updatedPlantedTrees)

    // Show alert
    alert(`Árvore amadureceu! Colheu ${d6Roll} ${plantedTree.fruit}!`)

    // Save to Firebase
    if (useFirebase) {
      saveTrainerData(currentUser.username, {
        ...currentUser,
        keyItems: updatedKeyItems,
        plantedTrees: updatedPlantedTrees
      })
    }
  }

  const handleColetarBonsai = (bonsai) => {
    const d3Roll = Math.floor(Math.random() * 3) + 1
    const timestamp = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })

    // Determine fruit based on bonsai name
    const bonsaiToFruit = {
      'Bonsai Vermelho': 'Apricorn Vermelha',
      'Bonsai Verde': 'Apricorn Verde',
      'Bonsai Azul': 'Apricorn Azul',
      'Bonsai Preto': 'Apricorn Preta',
      'Bonsai Amarelo': 'Apricorn Amarela',
      'Bonsai Rosa': 'Apricorn Rosa',
      'Bonsai Branco': 'Apricorn Branca',
      'Bonsai Arco-íris': 'Apricorn Arco-íris'
    }

    const fruit = bonsaiToFruit[bonsai.name]

    // Add to chat
    addChatMessage({
      username: currentUser.username,
      text: `🌿 Coletar de ${bonsai.name} - 1d3`,
      timestamp,
      isDiceRoll: true,
      diceResult: `1d3 = ${d3Roll} ${fruit}`
    })

    // Add apricorns to key items
    const updatedKeyItems = [...keyItems]
    const existingItem = updatedKeyItems.find(item => item.name === fruit)

    if (existingItem) {
      existingItem.quantity += d3Roll
    } else {
      updatedKeyItems.push({ name: fruit, quantity: d3Roll })
    }

    setKeyItems(updatedKeyItems)

    // Show alert
    alert(`Coletou ${d3Roll} ${fruit} do ${bonsai.name}!`)

    // Save to Firebase
    if (useFirebase) {
      saveTrainerData(currentUser.username, {
        ...currentUser,
        keyItems: updatedKeyItems
      })
    }
  }

  const handleExcluirArvore = (treeId) => {
    if (!confirm('Tem certeza que deseja excluir esta árvore plantada?')) {
      return
    }

    const updatedPlantedTrees = plantedTrees.filter(tree => tree.id !== treeId)
    setPlantedTrees(updatedPlantedTrees)

    // Save to Firebase
    if (useFirebase) {
      saveTrainerData(currentUser.username, {
        ...currentUser,
        plantedTrees: updatedPlantedTrees
      })
    }
  }

  // ==================== FUNÇÕES DE CLIMA ====================

  const handlePrevisaoDoTempo = async () => {
    const climasDisponiveis = CLIMA_LIST.filter(c => {
      if (desertoMode && (c.name === 'Neve' || c.name === 'Granizo')) return false
      if (!desertoMode && c.name === 'Tempestade de Areia') return false
      return true
    })
    const sorteado = climasDisponiveis[Math.floor(Math.random() * climasDisponiveis.length)]
    setCurrentClima(sorteado)
    if (useFirebase) {
      await saveToFirebase('clima', sorteado)
    }
  }

  const handleToggleDesertoMode = async (checked) => {
    setDesertoMode(checked)
    if (useFirebase) {
      await saveToFirebase('climaDesertoMode', checked)
    }
  }

  // ==================== FUNÇÕES DE BACKUP & RESTORE ====================

  const createBackup = async () => {
    try {
      const backupData = {
        timestamp: new Date().toISOString(),
        version: '1.0',
        data: {}
      }

      // Buscar todos os dados do Firebase
      if (useFirebase) {
        // Trainers data
        const trainers = {}
        for (const user of users) {
          if (user.type === 'treinador') {
            const trainerData = await loadTrainerData(user.username)
            if (trainerData) {
              trainers[user.username] = trainerData
            }
          }
        }
        backupData.data.trainers = trainers

        // Master config
        backupData.data.mestreConfig = await loadMestreConfig()

        // NPCs (usar username do mestre se disponível, senão 'Mestre')
        const mestreUsername = currentUser?.username || users.find(u => u.type === 'mestre')?.username || 'Mestre'
        backupData.data.npcTrainers = await loadNpcTrainers(mestreUsername)

        // Exotic species
        backupData.data.exoticSpecies = await loadGlobalExoticSpecies()

        // Battle data
        backupData.data.battle = await loadBattleData()

        // Chat messages
        backupData.data.chat = await loadChatMessages()

        // Interludio
        backupData.data.interludio = await loadInterludioData()

        // Pokeloja
        backupData.data.pokeloja = {
          hiddenItems: await loadHiddenPokelojaItems(),
          customPrices: await loadCustomPrices()
        }

        // XP & Capturas
        const xpCapturas = {}
        for (const user of users) {
          if (user.type === 'treinador') {
            xpCapturas[user.username] = await loadXpCapturas(user.username)
          }
        }
        backupData.data.xpCapturas = xpCapturas

        // Safari
        backupData.data.safari = await loadSafariData()

        // VTT
        backupData.data.vtt = await loadVTTData()

        // Apricorn Trees
        backupData.data.apricornTrees = await loadGeneratedApricornTrees()
      }

      return backupData
    } catch (error) {
      console.error('Erro ao criar backup:', error)
      alert('Erro ao criar backup: ' + error.message)
      return null
    }
  }

  const handleCreateBackup = async () => {
    const backup = await createBackup()
    if (!backup) return

    // Carregar backups existentes do Firebase
    const savedBackups = await loadBackups()
    savedBackups.unshift(backup)

    // Manter apenas os últimos 2 backups
    if (savedBackups.length > 2) {
      savedBackups.splice(2)
    }

    // Salvar no Firebase
    await saveBackups(savedBackups)
    setBackupHistory(savedBackups)

    console.log('🔄 Backup automático criado:', new Date().toLocaleTimeString())
    alert('✅ Backup criado com sucesso!')
  }

  const handleExportBackup = async () => {
    const backup = await createBackup()
    if (!backup) return

    // Download como arquivo JSON
    const dataStr = JSON.stringify(backup, null, 2)
    const dataBlob = new Blob([dataStr], { type: 'application/json' })
    const url = URL.createObjectURL(dataBlob)
    const link = document.createElement('a')
    link.href = url
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-')
    link.download = `pokeapp-backup-${timestamp}.json`
    document.body.appendChild(link)
    link.click()
    document.body.removeChild(link)
    URL.revokeObjectURL(url)

    alert('✅ Backup exportado com sucesso!')
  }

  const handleImportBackup = (event) => {
    const file = event.target.files[0]
    if (!file) return

    const reader = new FileReader()
    reader.onload = (e) => {
      try {
        const backup = JSON.parse(e.target.result)
        setSelectedBackup(backup)
        alert('Backup carregado! Clique em "Restaurar" para aplicar os dados.')
      } catch (error) {
        alert('Erro ao ler arquivo de backup: ' + error.message)
      }
    }
    reader.readAsText(file)
  }

  const handleRestoreBackup = async (backup) => {
    if (!confirm('⚠️ ATENÇÃO: Isso irá SUBSTITUIR todos os dados atuais pelos dados do backup. Tem certeza?')) {
      return
    }

    if (!backup) {
      alert('Nenhum backup selecionado!')
      return
    }

    try {
      const data = backup.data

      // Restaurar trainers
      if (data.trainers) {
        for (const [username, trainerData] of Object.entries(data.trainers)) {
          await saveTrainerData(username, trainerData)
        }
      }

      // Restaurar master config
      if (data.mestreConfig) {
        await saveMestreConfig(data.mestreConfig)
      }

      // Restaurar NPCs
      if (data.npcTrainers) {
        await saveNpcTrainers(currentUser.username, data.npcTrainers)
      }

      // Restaurar exotic species
      if (data.exoticSpecies) {
        await saveGlobalExoticSpecies(data.exoticSpecies)
      }

      // Restaurar battle
      if (data.battle) {
        await saveBattleData(data.battle)
      }

      // Restaurar chat
      if (data.chat) {
        await saveChatMessages(data.chat)
      }

      // Restaurar interludio
      if (data.interludio) {
        await saveInterludioData(data.interludio)
      }

      // Restaurar pokeloja
      if (data.pokeloja) {
        if (data.pokeloja.hiddenItems) {
          await saveHiddenPokelojaItems(data.pokeloja.hiddenItems)
        }
        if (data.pokeloja.customPrices) {
          await saveCustomPrices(data.pokeloja.customPrices)
        }
      }

      // Restaurar XP & Capturas
      if (data.xpCapturas) {
        for (const [username, xpData] of Object.entries(data.xpCapturas)) {
          await saveXpCapturas(username, xpData)
        }
      }

      // Restaurar Safari
      if (data.safari) {
        await saveSafariData(data.safari)
      }

      // Restaurar VTT
      if (data.vtt) {
        await saveVTTData(data.vtt)
      }

      // Restaurar Apricorn Trees
      if (data.apricornTrees) {
        await saveGeneratedApricornTrees(data.apricornTrees)
      }

      alert('✅ Backup restaurado com sucesso! Recarregue a página para ver as mudanças.')
      window.location.reload()
    } catch (error) {
      console.error('Erro ao restaurar backup:', error)
      alert('❌ Erro ao restaurar backup: ' + error.message)
    }
  }

  const handleDeleteBackup = async (index) => {
    if (!confirm('Tem certeza que deseja excluir este backup?')) return

    const savedBackups = await loadBackups()
    savedBackups.splice(index, 1)
    await saveBackups(savedBackups)
    setBackupHistory(savedBackups)
  }

  // Carregar backups do Firebase ao montar componente
  useEffect(() => {
    const loadBackupsFromFirebase = async () => {
      if (!useFirebase) return
      const savedBackups = await loadBackups()
      setBackupHistory(savedBackups)
    }
    loadBackupsFromFirebase()
  }, [useFirebase])

  // Subscrever para mudanças nos backups em tempo real
  useEffect(() => {
    if (!useFirebase) return
    const unsubscribe = subscribeToBackups((backups) => {
      setBackupHistory(backups || [])
    })
    return () => {
      if (unsubscribe) unsubscribe()
    }
  }, [useFirebase])

  // Backup periódico automático a cada 10 minutos
  useEffect(() => {
    if (!useFirebase) return

    const createPeriodicBackup = async () => {
      try {
        const backup = await createBackup()
        if (backup) {
          const savedBackups = await loadBackups()
          savedBackups.unshift(backup)

          // Manter apenas os últimos 5 backups
          if (savedBackups.length > 5) {
            savedBackups.splice(5)
          }

          await saveBackups(savedBackups)
          console.log('🔄 Backup periódico criado:', new Date().toLocaleTimeString())
        }
      } catch (error) {
        console.error('Erro ao criar backup periódico:', error)
      }
    }

    // Criar backup a cada 10 minutos (600000 ms)
    const intervalId = setInterval(createPeriodicBackup, 600000)

    // Limpar intervalo quando componente desmonta ou Firebase desativa
    return () => clearInterval(intervalId)
  }, [useFirebase])

  // Background da sessão
  useEffect(() => {
    if (sessionBg && currentUser) {
      document.body.style.backgroundImage = `url('${sessionBg}')`
      document.body.style.backgroundSize = 'cover'
      document.body.style.backgroundPosition = 'center'
      document.body.style.backgroundRepeat = 'no-repeat'
      document.body.style.backgroundAttachment = 'fixed'
    } else {
      document.body.style.backgroundImage = ''
      document.body.style.backgroundSize = ''
      document.body.style.backgroundPosition = ''
      document.body.style.backgroundRepeat = ''
      document.body.style.backgroundAttachment = ''
    }
  }, [sessionBg, currentUser])

  // Subscription PokeZap
  useEffect(() => {
    if (!useFirebase || !currentUser) return
    const unsub = subscribeToFirebase('pokezap', (data) => {
      setPokezapMessages(Array.isArray(data) ? data : Object.values(data || {}))
    })
    return () => unsub()
  }, [currentUser, useFirebase])

  // Função de logout com backup automático em background
  const handleLogout = () => {
    setCurrentUser(null)
    setCurrentArea('')
    setSessionBg(null)
    setShowPokezapPanel(false)
    setSpoilerMestreConfirmado(false)
    setShowBatalhaChat(false)
  }

  const handleSendPokezap = () => {
    if (!pokezapInput.trim() || !currentUser) return
    const msg = {
      id: `pkzap-${Date.now()}-${Math.random().toString(36).substr(2, 6)}`,
      text: pokezapInput.trim(),
      sender: currentUser.username,
      recipients: pokezapRecipients,
      timestamp: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
    }
    const updated = [...pokezapMessages, msg]
    setPokezapMessages(updated)
    if (useFirebase) saveToFirebase('pokezap', updated)
    setPokezapInput('')
  }

  // ==================== POKE AGENDA ====================

  const handleSaveAnotacao = () => {
    if (!anotacaoForm.titulo.trim() || !currentUser) return
    if (editingAnotacao) {
      const updated = anotacoes.map(a => a.id === editingAnotacao.id ? { ...a, titulo: anotacaoForm.titulo.trim(), descricao: anotacaoForm.descricao.trim() } : a)
      setAnotacoes(updated)
    } else {
      const nova = { id: `anot-${Date.now()}-${Math.random().toString(36).substr(2, 6)}`, titulo: anotacaoForm.titulo.trim(), descricao: anotacaoForm.descricao.trim() }
      setAnotacoes(prev => [...prev, nova])
    }
    setShowAddAnotacaoModal(false)
    setEditingAnotacao(null)
    setAnotacaoForm({ titulo: '', descricao: '' })
  }

  const handleDeleteAnotacao = (id) => {
    setAnotacoes(prev => prev.filter(a => a.id !== id))
  }

  const handleEnviarAnotacaoPokezap = (anotacao) => {
    if (!currentUser) return
    const text = `📋 ${anotacao.titulo}\n${anotacao.descricao}`
    const msg = {
      id: `pkzap-${Date.now()}-${Math.random().toString(36).substr(2, 6)}`,
      text,
      sender: currentUser.username,
      recipients: pokezapRecipients,
      timestamp: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
    }
    const updated = [...pokezapMessages, msg]
    setPokezapMessages(updated)
    if (useFirebase) saveToFirebase('pokezap', updated)
  }

  // ==================== FUNÇÕES DO SAFARI ====================

  // Sincronizar Safari em tempo real com Firebase
  useEffect(() => {
    if (!useFirebase) return
    const unsubscribe = subscribeToSafari((data) => {
      if (data) {
        if (data.runAreas) setSafariRunAreas(data.runAreas)
        if (data.runPermissions) setSafariRunPermissions(data.runPermissions)
        if (data.runEncounters) setSafariRunEncounters(data.runEncounters)
        if (data.runPaidUsers) setSafariRunPaidUsers(data.runPaidUsers)

        // Auto-cobrar pokemoedas de treinadores com permissão quando um run é iniciado
        if (data.runPaidUsers && currentUser?.username && currentUser.type === 'treinador') {
          for (const [runKey, paidUsers] of Object.entries(data.runPaidUsers)) {
            const arr = Array.isArray(paidUsers) ? paidUsers : []
            const perms = (data.runPermissions || {})[runKey] || {}
            if (perms[currentUser.username] && !arr.includes(currentUser.username) && !safariPaidRunsRef.current.has(runKey)) {
              safariPaidRunsRef.current.add(runKey)
              setPokemonedas(prev => prev - SAFARI_ENTRY_COST)
              const newPaidUsers = [...arr, currentUser.username]
              const newAllPaidUsers = { ...(data.runPaidUsers || {}), [runKey]: newPaidUsers }
              saveSafariData({ ...data, runPaidUsers: newAllPaidUsers })
              const ts = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
              addChatMessage({ username: 'Sistema', text: `${currentUser.username} foi cobrado ₽${SAFARI_ENTRY_COST} pela entrada no Safari (${runKey})`, timestamp: ts, isDiceRoll: false })
              break
            }
          }
        }
      }
    })
    return () => { if (unsubscribe) unsubscribe() }
  }, [useFirebase])

  // Sincronizar grids do Safari em tempo real (por run)
  useEffect(() => {
    if (!useFirebase) return
    const unsubscribe = subscribeToFirebase('safariGrids', (allGrids) => {
      const grids = allGrids || {}
      setSafariRunGrids(grids)
      if (safariActiveRun) {
        const runKey = `run-${safariActiveRun}`
        if (grids[runKey]) {
          setSafariGridData(grids[runKey])
        }
      }
    })
    return () => { if (unsubscribe) unsubscribe() }
  }, [useFirebase, safariActiveRun])

  // Sincronizar timers do Safari
  useEffect(() => {
    if (!useFirebase) return
    const unsubscribe = subscribeToFirebase('safariTimers', (timers) => {
      setSafariTimers(timers || {})
    })
    return () => { if (unsubscribe) unsubscribe() }
  }, [useFirebase])

  // Sincronizar Grid de Captura - NOVO
  useEffect(() => {
    if (!useFirebase) return
    const unsubscribe = subscribeToFirebase('mestre/gridCaptura', (data) => {
      console.log('Firebase gridCaptura received:', data)
      setGridCapturaConfig(data || null)
    })
    return () => { if (unsubscribe) unsubscribe() }
  }, [useFirebase])

  // Sincronizar Cards Revelados - NOVO
  useEffect(() => {
    if (!useFirebase) return
    const unsubscribe = subscribeToFirebase('mestre/gridCapturaRevealed', (data) => {
      console.log('Firebase gridCapturaRevealed received:', data)
      setRevealedCards(data || [])
    })
    return () => { if (unsubscribe) unsubscribe() }
  }, [useFirebase])

  // Sincronizar Estados dos Cards - NOVO
  useEffect(() => {
    if (!useFirebase) return
    const unsubscribe = subscribeToFirebase('mestre/gridCardStates', (data) => {
      console.log('Firebase gridCardStates received:', data)
      setGridCardStates(data || {})
    })
    return () => { if (unsubscribe) unsubscribe() }
  }, [useFirebase])

  // Salvar dados do Safari no Firebase
  const saveSafariToFirebase = async (overrides = {}) => {
    if (!useFirebase) return
    const data = {
      runAreas: overrides.runAreas !== undefined ? overrides.runAreas : safariRunAreas,
      runPermissions: overrides.runPermissions !== undefined ? overrides.runPermissions : safariRunPermissions,
      runEncounters: overrides.runEncounters !== undefined ? overrides.runEncounters : safariRunEncounters,
      runPaidUsers: overrides.runPaidUsers !== undefined ? overrides.runPaidUsers : safariRunPaidUsers,
    }
    await saveSafariData(data)
  }

  // Salvar grid de um run no Firebase
  const syncGridToRun = async (grid, runNumber) => {
    if (!useFirebase || !runNumber) return
    const runKey = `run-${runNumber}`
    try {
      setSafariRunGrids(prev => ({ ...prev, [runKey]: grid }))
      await saveToFirebase(`safariGrids/${runKey}`, grid)
    } catch (error) {
      console.error('Erro ao sincronizar grid:', error)
    }
  }

  // Atualizar timer de um run
  const updateSafariTimer = async (runNumber, minutes) => {
    if (!useFirebase) return
    const runKey = `run-${runNumber}`
    setSafariTimers(prev => ({ ...prev, [runKey]: minutes }))
    await saveToFirebase(`safariTimers/${runKey}`, minutes)
  }

  // Formatar timer do Safari (minutos -> HH:MM)
  const formatSafariTimer = (minutes) => {
    if (minutes === undefined || minutes === null) minutes = 600
    const hours = Math.floor(minutes / 60)
    const mins = minutes % 60
    return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`
  }

  // Gerar nível aleatório a partir de string "min-max" ou "valor"
  const parseSafariLevel = (levelStr) => {
    if (levelStr === '-') return 1
    if (levelStr.includes('-')) {
      const [min, max] = levelStr.split('-').map(Number)
      return Math.floor(Math.random() * (max - min + 1)) + min
    }
    return parseInt(levelStr) || 1
  }

  // Gerar terreno aleatório para uma área do Safari
  const getRandomSafariTerrain = (areaName) => {
    const terrain = SAFARI_AREA_TERRAIN[areaName]
    if (!terrain) return 'Grama'
    const total = terrain.grama + terrain.agua
    const roll = Math.floor(Math.random() * total) + 1
    return roll <= terrain.grama ? 'Grama' : 'Água'
  }

  // Selecionar pokémon aleatório baseado nas probabilidades
  const rollSafariEncounter = (areaName, terrain) => {
    const encounters = SAFARI_ENCOUNTERS.filter(e => e.area === areaName && e.terrain === terrain)
    if (encounters.length === 0) return null
    const totalChance = encounters.reduce((sum, e) => sum + e.chance, 0)
    let roll = Math.floor(Math.random() * totalChance) + 1
    for (const encounter of encounters) {
      roll -= encounter.chance
      if (roll <= 0) return encounter
    }
    return encounters[encounters.length - 1]
  }

  // Buscar dados do Pokémon via PokeAPI (imagem + tipos)
  const fetchSafariPokemonData = async (speciesName) => {
    try {
      const id = speciesName.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '')
      const response = await fetch(`https://pokeapi.co/api/v2/pokemon/${id}`)
      if (!response.ok) return { imageUrl: null, types: [] }
      const data = await response.json()
      const imageUrl = data.sprites.other['official-artwork'].front_default ||
        data.sprites.other['home'].front_default ||
        data.sprites.front_default
      const types = data.types.map(t => t.type.name)
      return { imageUrl, types }
    } catch (error) {
      return { imageUrl: null, types: [] }
    }
  }

  // Gerar Pokémon NPC completo para Safari (com atributos, golpes, habilidades)
  const generateSafariNpcPokemon = (speciesName, level, isSkittish, imageUrl, types) => {
    const speciesData = pokedexData.find(p => p.nome.toLowerCase() === speciesName.toLowerCase())
    const baseStats = speciesData?.statusBasais || { saude: 5, ataque: 5, defesa: 5, ataqueEspecial: 5, defesaEspecial: 5, velocidade: 5 }

    // Sortear natureza
    const nature = natures[Math.floor(Math.random() * natures.length)]

    // Distribuir pontos de nível aleatoriamente
    const statKeys = ['saude', 'ataque', 'defesa', 'ataqueEspecial', 'defesaEspecial', 'velocidade']
    const levelPts = { saude: 0, ataque: 0, defesa: 0, ataqueEspecial: 0, defesaEspecial: 0, velocidade: 0 }
    for (let i = 0; i < level; i++) {
      levelPts[statKeys[Math.floor(Math.random() * statKeys.length)]]++
    }

    // Mapa de natureza para chave de atributo
    const natureMap = { 'Saúde': 'saude', 'Ataque': 'ataque', 'Defesa': 'defesa', 'Ataque Especial': 'ataqueEspecial', 'Defesa Especial': 'defesaEspecial', 'Velocidade': 'velocidade' }
    const upKey = natureMap[nature.up]
    const downKey = natureMap[nature.down]

    // Calcular atributos totais
    const baseAttributes = { ...baseStats }
    const attributes = {}
    for (const key of statKeys) {
      let total = baseStats[key] + levelPts[key]
      if (key === upKey) total += key === 'saude' ? 1 : 2
      if (key === downKey) total -= key === 'saude' ? 1 : 2
      attributes[key] = total
    }

    // Gerar golpes
    const golpesAprendidos = generatePokemonMoves(speciesName, level, false, null)

    // Gênero
    let gender = null
    if (speciesData?.genero) {
      const gParts = speciesData.genero.split('_')
      const mP = parseFloat(gParts[0])
      const fP = parseFloat(gParts[1])
      if (mP === 0 && fP === 0) gender = null
      else if (mP === 100) gender = 'Macho'
      else if (fP === 100) gender = 'Fêmea'
      else gender = Math.random() * 100 < mP ? 'Macho' : 'Fêmea'
    }

    const pokemon = {
      id: `safari-${Date.now()}-${Math.random()}`,
      species: speciesName,
      name: speciesName,
      level,
      isSkittish,
      imageUrl,
      types: types || [],
      nature,
      baseAttributes,
      attributes,
      levelPoints: levelPts,
      golpesAprendidos,
      gender,
      dexNumber: speciesData?.dexNumber || 0,
      catchRate: speciesData?.catchRate || 0,
      experience: speciesData?.baseExp || 0,
      weight: speciesData?.peso || 0,
      height: speciesData?.altura || 0,
      shiny: false,
      currentHP: (3 * attributes.saude) + level,
      chanceFuga: isSkittish ? 70 : 90,
      chanceCaptura: 0,
      conditions: {}
    }

    return assignAbilitiesToPokemon(pokemon)
  }

  // Gerar grid 8x8 do Safari
  const generateSafariGrid = (areaName) => {
    const grid = []
    for (let row = 0; row < 8; row++) {
      const gridRow = []
      for (let col = 0; col < 8; col++) {
        const terrain = getRandomSafariTerrain(areaName)
        const encounter = rollSafariEncounter(areaName, terrain)
        let cell = { terrain, pokemon: null, quantity: 0, isSkittish: false, level: 0, levelRange: '-', revealed: false }
        if (encounter && encounter.pokemon) {
          const isSolo = SAFARI_SOLO_SPECIES.includes(encounter.pokemon)
          cell.pokemon = encounter.pokemon
          cell.quantity = isSolo ? 1 : Math.floor(Math.random() * 6) + 1
          cell.isSkittish = encounter.isSkittish
          cell.level = parseSafariLevel(encounter.level)
          cell.levelRange = encounter.level
        }
        gridRow.push(cell)
      }
      grid.push(gridRow)
    }
    return grid
  }

  // --- Ações Mestre Safari ---

  const handleToggleSafariRunPermission = (runNumber, username) => {
    const runKey = `run-${runNumber}`
    const currentPerms = safariRunPermissions[runKey] || {}
    const isCurrentlyChecked = !!currentPerms[username]

    // Se está marcando (tornando true), desmarcar esse treinador de todas as outras runs
    let newRunPermissions = { ...safariRunPermissions }

    if (!isCurrentlyChecked) {
      // Desmarcar o treinador de todas as runs
      for (let i = 1; i <= 5; i++) {
        const otherRunKey = `run-${i}`
        if (newRunPermissions[otherRunKey]) {
          newRunPermissions[otherRunKey] = { ...newRunPermissions[otherRunKey], [username]: false }
        }
      }
    }

    // Atualizar a run atual
    const newPerms = { ...newRunPermissions[runKey] || {}, [username]: !isCurrentlyChecked }
    newRunPermissions = { ...newRunPermissions, [runKey]: newPerms }

    setSafariRunPermissions(newRunPermissions)
    saveSafariToFirebase({ runPermissions: newRunPermissions })
  }

  const handleResetSafari = () => {
    setSafariRunGrids({})
    setSafariRunAreas({})
    setSafariTimers({})
    setSafariRunPermissions({})
    setSafariRunEncounters({})
    setSafariRunPaidUsers({})
    setSafariRunLastClicked({})
    setSafariStaffActiveRun(null)
    setSafariActiveRun(null) // Limpar run ativa do jogador
    setSafariGridData(null) // Limpar grid data do jogador
    safariPaidRunsRef.current = new Set()
    saveSafariToFirebase({ runAreas: {}, runPermissions: {}, runEncounters: {}, runPaidUsers: {} })
    saveToFirebase('safariGrids', null)
    saveToFirebase('safariTimers', null)
    const timestamp = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
    addChatMessage({ username: 'Sistema', text: 'O Safari foi resetado pelo Mestre!', timestamp, isDiceRoll: false })
  }

  const handleEquipeLimpeza = () => {
    setSafariRunEncounters({})
    saveSafariToFirebase({ runEncounters: {} })
  }

  const handleSafariChanceFugaRoll = (runNumber, pokemonId) => {
    const runKey = `run-${runNumber}`
    const encounters = safariRunEncounters[runKey] || []
    const pokemon = encounters.find(p => p.id === pokemonId)
    if (!pokemon) return

    const roll = Math.floor(Math.random() * 100) + 1
    const timestamp = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })

    if (roll >= pokemon.chanceFuga) {
      const newEncounters = encounters.filter(p => p.id !== pokemonId)
      const newRunEncounters = { ...safariRunEncounters, [runKey]: newEncounters }
      setSafariRunEncounters(newRunEncounters)
      saveSafariToFirebase({ runEncounters: newRunEncounters })
      addChatMessage({ username: 'Sistema', text: `🏃 ${pokemon.species} fugiu!`, timestamp, isDiceRoll: true, diceResult: roll, diceDetails: `1d100 = ${roll} vs Chance de Fuga ${pokemon.chanceFuga}% → Pokémon fugiu!` })
    } else {
      addChatMessage({ username: 'Sistema', text: `${pokemon.species} permanece!`, timestamp, isDiceRoll: true, diceResult: roll, diceDetails: `1d100 = ${roll} vs Chance de Fuga ${pokemon.chanceFuga}% → O pokémon Permanece` })
    }
  }

  const handleToggleSafariCondition = (runNumber, pokemonId, condition) => {
    const runKey = `run-${runNumber}`
    const encounters = safariRunEncounters[runKey] || []
    const newEncounters = encounters.map(p => {
      if (p.id !== pokemonId) return p
      const conds = p.conditions || {}
      return { ...p, conditions: { ...conds, [condition]: !conds[condition] } }
    })
    const newRunEncounters = { ...safariRunEncounters, [runKey]: newEncounters }
    setSafariRunEncounters(newRunEncounters)
    saveSafariToFirebase({ runEncounters: newRunEncounters })
  }

  // Função para remover pokémon Safari manualmente
  const handleRemoveSafariPokemon = (runNumber, pokemonId) => {
    const runKey = `run-${runNumber}`
    const encounters = safariRunEncounters[runKey] || []
    const newEncounters = encounters.filter(p => p.id !== pokemonId)
    const newRunEncounters = { ...safariRunEncounters, [runKey]: newEncounters }
    setSafariRunEncounters(newRunEncounters)
    saveSafariToFirebase({ runEncounters: newRunEncounters })
  }

  // Função para calcular o Valor de Captura do Safari considerando condições
  const calculateSafariCaptureValue = (pokemon) => {
    let total = 0

    // Catch Rate base + Chance Captura adicional
    total += (pokemon.catchRate || 0)
    total += (pokemon.chanceCaptura || 0)

    // Bônus de condições
    const conditions = pokemon.conditions || {}
    if (conditions.confusão) total += 5
    if (conditions.crítico) total += 10
    if (conditions.paralisia) total += 7
    if (conditions.sono) total += 10
    if (conditions.atordoamento) total += 10
    if (conditions.congelamento) total += 15
    if (conditions.paixão) total += 3
    if (conditions.queimadura) total += 5
    if (conditions.veneno) total += 7

    return total
  }

  const toggleSafariNpcCard = (pokemonId) => {
    setExpandedSafariNpcCards(prev =>
      prev.includes(pokemonId) ? prev.filter(id => id !== pokemonId) : [...prev, pokemonId]
    )
  }

  const applySafariNpcDamage = (isDamage) => {
    if (!selectedSafariNpcPokemon || !safariNpcDamageAmount || !safariNpcDamageRunNumber) return
    const amount = parseInt(safariNpcDamageAmount)
    if (isNaN(amount) || amount <= 0) return
    const runKey = `run-${safariNpcDamageRunNumber}`
    const encounters = safariRunEncounters[runKey] || []
    const newEncounters = encounters.map(p => {
      if (p.id !== selectedSafariNpcPokemon.id) return p
      const maxHP = (3 * p.attributes.saude) + p.level
      const currentHP = p.currentHP !== undefined ? p.currentHP : maxHP
      const newHP = isDamage ? Math.max(0, currentHP - amount) : Math.min(maxHP, currentHP + amount)
      return { ...p, currentHP: newHP }
    })
    const newRunEncounters = { ...safariRunEncounters, [runKey]: newEncounters }
    setSafariRunEncounters(newRunEncounters)
    saveSafariToFirebase({ runEncounters: newRunEncounters })
    setShowSafariNpcDamageModal(false)
    setSafariNpcDamageAmount('')
    setSelectedSafariNpcPokemon(null)
    setSafariNpcDamageRunNumber(null)
  }

  // --- Ações Treinador Safari ---

  const handleStartSafariRun = async (runNumber) => {
    const runKey = `run-${runNumber}`

    // Se o run já tem grid, apenas trocar para ele
    if (safariRunGrids[runKey]) {
      setSafariActiveRun(runNumber)
      setSafariGridData(safariRunGrids[runKey])
      setSafariCurrentArea(safariRunAreas[runKey] || 'Área Central')
      setSafariGridClickCount(0)
      setSafariSelectedPokemon(new Set())
      return
    }

    // Primeiro acesso: verificar permissão
    const permissions = safariRunPermissions[runKey] || {}
    if (!permissions[currentUser.username]) {
      alert('Você não tem permissão para iniciar esta run!')
      return
    }

    // Identificar TODOS os treinadores com permissão nesta run
    const trainersInRun = Object.keys(permissions).filter(username => permissions[username])

    // Verificar se TODOS os treinadores têm pokemoedas suficientes
    const trainersData = {}
    for (const trainerUsername of trainersInRun) {
      if (trainerUsername === currentUser.username) {
        if (pokemonedas < SAFARI_ENTRY_COST) {
          alert(`Você não tem ₽${SAFARI_ENTRY_COST} para entrar no Safari!`)
          return
        }
        trainersData[trainerUsername] = { pokemonedas }
      } else {
        // Carregar dados do outro treinador
        const data = useFirebase
          ? await loadTrainerData(trainerUsername)
          : JSON.parse(localStorage.getItem(`trainer_${trainerUsername}`) || 'null')

        if (!data || (data.pokemonedas || 0) < SAFARI_ENTRY_COST) {
          alert(`O treinador ${trainerUsername} não tem ₽${SAFARI_ENTRY_COST} suficientes para entrar no Safari!`)
          return
        }
        trainersData[trainerUsername] = data
      }
    }

    // Cobrar de TODOS os treinadores
    for (const trainerUsername of trainersInRun) {
      if (trainerUsername === currentUser.username) {
        // Cobrar do treinador atual
        setPokemonedas(prev => prev - SAFARI_ENTRY_COST)
      } else {
        // Cobrar do outro treinador
        const trainerData = trainersData[trainerUsername]
        const updatedData = {
          ...trainerData,
          pokemonedas: (trainerData.pokemonedas || 0) - SAFARI_ENTRY_COST
        }
        if (useFirebase) {
          await saveTrainerData(trainerUsername, updatedData)
        } else {
          localStorage.setItem(`trainer_${trainerUsername}`, JSON.stringify(updatedData))
        }
      }
    }

    safariPaidRunsRef.current.add(runKey)
    setSafariActiveRun(runNumber)
    setSafariCurrentArea('Área Central')
    setSafariGridClickCount(0)
    setSafariSelectedPokemon(new Set())

    // Resetar último clicado ao iniciar nova run
    setSafariRunLastClicked(prev => ({ ...prev, [runKey]: null }))

    const grid = generateSafariGrid('Área Central')
    setSafariGridData(grid)

    syncGridToRun(grid, runNumber)
    updateSafariTimer(runNumber, 600)
    const newRunAreas = { ...safariRunAreas, [runKey]: 'Área Central' }
    setSafariRunAreas(newRunAreas)
    // Marcar todos os treinadores como pagos
    const newRunPaidUsers = { ...safariRunPaidUsers, [runKey]: trainersInRun }
    setSafariRunPaidUsers(newRunPaidUsers)
    saveSafariToFirebase({ runAreas: newRunAreas, runPaidUsers: newRunPaidUsers })

    const timestamp = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
    const trainersList = trainersInRun.join(', ')
    addChatMessage({ username: 'Sistema', text: `${trainersList} entraram no Safari Run ${runNumber}! (-₽${SAFARI_ENTRY_COST} cada)`, timestamp, isDiceRoll: false })
  }

  const handleSafariNavigate = (targetArea) => {
    if (!safariActiveRun) return
    const runKey = `run-${safariActiveRun}`

    // Verificar timer
    const currentTimer = safariTimers[runKey] !== undefined ? safariTimers[runKey] : 600
    if (currentTimer <= 0) {
      alert('⏰ Tempo esgotado! Você não pode mais se movimentar no Safari.')
      return
    }

    // Verificar permissão
    const permissions = safariRunPermissions[runKey] || {}
    if (!permissions[currentUser?.username]) {
      alert('Você não tem permissão para navegar nesta run!')
      return
    }

    setSafariCurrentArea(targetArea)
    const grid = generateSafariGrid(targetArea)
    setSafariGridData(grid)
    setSafariGridClickCount(0)

    // Resetar último clicado ao mudar de área
    setSafariRunLastClicked(prev => ({ ...prev, [runKey]: null }))

    syncGridToRun(grid, safariActiveRun)
    if (currentTimer > 0) updateSafariTimer(safariActiveRun, currentTimer - 60)

    const newRunAreas = { ...safariRunAreas, [runKey]: targetArea }
    setSafariRunAreas(newRunAreas)
    saveSafariToFirebase({ runAreas: newRunAreas })

    setShowAreaNavigationModal(false)
    setSafariSelectedPokemon(new Set())

    const timestamp = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
    addChatMessage({ username: 'Sistema', text: `${currentUser.username} (Run ${safariActiveRun}) avançou para ${targetArea}!`, timestamp, isDiceRoll: false })
  }

  // Funções helper para validação de cliques no Safari
  const isEdgeCell = (row, col, gridSize = 8) => {
    return row === 0 || row === gridSize - 1 || col === 0 || col === gridSize - 1
  }

  const getAdjacentCells = (row, col, gridSize = 8) => {
    const adjacent = []
    // Ortogonais
    if (row > 0) adjacent.push({ row: row - 1, col }) // cima
    if (row < gridSize - 1) adjacent.push({ row: row + 1, col }) // baixo
    if (col > 0) adjacent.push({ row, col: col - 1 }) // esquerda
    if (col < gridSize - 1) adjacent.push({ row, col: col + 1 }) // direita
    // Diagonais
    if (row > 0 && col > 0) adjacent.push({ row: row - 1, col: col - 1 }) // cima-esquerda
    if (row > 0 && col < gridSize - 1) adjacent.push({ row: row - 1, col: col + 1 }) // cima-direita
    if (row < gridSize - 1 && col > 0) adjacent.push({ row: row + 1, col: col - 1 }) // baixo-esquerda
    if (row < gridSize - 1 && col < gridSize - 1) adjacent.push({ row: row + 1, col: col + 1 }) // baixo-direita
    return adjacent
  }

  const isAdjacentToCell = (row, col, targetRow, targetCol) => {
    const rowDiff = Math.abs(row - targetRow)
    const colDiff = Math.abs(col - targetCol)
    // Adjacente se diferença é no máximo 1 em ambas direções (inclui diagonais)
    return rowDiff <= 1 && colDiff <= 1 && (rowDiff > 0 || colDiff > 0)
  }

  const allAdjacentRevealed = (row, col, grid) => {
    const adjacent = getAdjacentCells(row, col, grid.length)
    return adjacent.every(({ row: r, col: c }) => grid[r][c].revealed)
  }

  const isAdjacentToAnyRevealed = (row, col, grid) => {
    const adjacent = getAdjacentCells(row, col, grid.length)
    return adjacent.some(({ row: r, col: c }) => grid[r][c].revealed)
  }

  const handleSafariCellClick = async (row, col) => {
    if (!safariGridData || !safariActiveRun) return
    const runKey = `run-${safariActiveRun}`

    // Verificar timer
    const currentTimer = safariTimers[runKey] !== undefined ? safariTimers[runKey] : 600
    if (currentTimer <= 0) {
      alert('⏰ Tempo esgotado! Você não pode mais interagir com o grid.')
      return
    }

    // Verificar permissão
    const permissions = safariRunPermissions[runKey] || {}
    if (!permissions[currentUser?.username]) return

    const cell = safariGridData[row][col]
    if (cell.revealed) return

    // Verificar regras de movimento no grid
    const revealedCells = safariGridData.flat().filter(c => c.revealed)
    const isFirstClick = revealedCells.length === 0
    const lastClicked = safariRunLastClicked[runKey]

    if (isFirstClick) {
      // Primeiro clique: deve ser na borda
      if (!isEdgeCell(row, col, safariGridData.length)) {
        alert('⚠️ O primeiro clique deve ser em um dos quadrados da borda do grid!')
        return
      }
    } else {
      // Cliques subsequentes: deve ser adjacente ao último clicado
      // OU se todos adjacentes ao último estão revelados, pode ser adjacente a qualquer revelado
      const isAdjacentToLast = lastClicked && isAdjacentToCell(row, col, lastClicked.row, lastClicked.col)
      const allLastAdjacentRevealed = lastClicked && allAdjacentRevealed(lastClicked.row, lastClicked.col, safariGridData)
      const isAdjacentToRevealed = isAdjacentToAnyRevealed(row, col, safariGridData)

      if (!isAdjacentToLast) {
        // Se não é adjacente ao último, verifica se todos adjacentes do último estão revelados
        if (!allLastAdjacentRevealed || !isAdjacentToRevealed) {
          if (!allLastAdjacentRevealed) {
            alert('⚠️ Você só pode clicar em quadrados adjacentes ao último clicado!')
          } else {
            alert('⚠️ Você só pode clicar em quadrados adjacentes aos já revelados!')
          }
          return
        }
      }
    }

    const newGrid = safariGridData.map((r, ri) =>
      r.map((c, ci) => (ri === row && ci === col ? { ...c, revealed: true } : c))
    )

    // Atualizar último clicado
    setSafariRunLastClicked(prev => ({ ...prev, [runKey]: { row, col } }))
    setSafariGridData(newGrid)
    syncGridToRun(newGrid, safariActiveRun)

    // Timer: decrementar 10 minutos a cada clique
    if (currentTimer > 0) {
      updateSafariTimer(safariActiveRun, currentTimer - 10)
    }

    const timestamp = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })

    if (!cell.pokemon) {
      addChatMessage({ username: 'Sistema', text: `${currentUser.username} explorou a ${cell.terrain === 'Grama' ? 'grama' : 'água'}, mas não encontrou nenhum pokémon.`, timestamp, isDiceRoll: false })
      return
    }

    // Buscar dados do pokemon (imagem + tipos)
    const pokemonData = await fetchSafariPokemonData(cell.pokemon)
    const imageUrl = pokemonData.imageUrl
    const types = pokemonData.types

    // Atualizar grid com imagem
    const gridWithImage = newGrid.map((r, ri) =>
      r.map((c, ci) => (ri === row && ci === col ? { ...c, imageUrl } : c))
    )
    setSafariGridData(gridWithImage)
    syncGridToRun(gridWithImage, safariActiveRun)

    // Limpar pokémons anteriores e gerar novos (novo quadrado substitui encontro anterior)
    const newEncounterPokemon = []
    for (let i = 0; i < cell.quantity; i++) {
      const npcPkm = generateSafariNpcPokemon(
        cell.pokemon,
        parseSafariLevel(cell.levelRange || cell.level.toString()),
        cell.isSkittish,
        imageUrl,
        types
      )
      newEncounterPokemon.push(npcPkm)
    }
    const newRunEncounters = { ...safariRunEncounters, [runKey]: newEncounterPokemon }
    setSafariRunEncounters(newRunEncounters)
    saveSafariToFirebase({ runEncounters: newRunEncounters })

    addChatMessage({ username: 'Sistema', text: `${currentUser.username} encontrou ${cell.quantity}x ${cell.pokemon} (Nv.${cell.level})${cell.isSkittish ? ' ⚠️ Arisco!' : ''} na ${cell.terrain}!`, timestamp, isDiceRoll: false })
  }

  const handleSafariIsca = () => {
    if (!safariActiveRun || safariSelectedPokemon.size === 0) return
    const runKey = `run-${safariActiveRun}`
    const encounters = safariRunEncounters[runKey] || []
    const newEncounters = encounters.map(p => {
      if (!safariSelectedPokemon.has(p.id)) return p
      return { ...p, chanceFuga: Math.min(100, p.chanceFuga + 25), chanceCaptura: p.chanceCaptura - 25 }
    })
    const newRunEncounters = { ...safariRunEncounters, [runKey]: newEncounters }
    setSafariRunEncounters(newRunEncounters)
    saveSafariToFirebase({ runEncounters: newRunEncounters })

    const selectedNames = encounters.filter(p => safariSelectedPokemon.has(p.id)).map(p => p.species).join(', ')
    const timestamp = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
    addChatMessage({ username: currentUser.username, text: `🍖 Jogou uma Isca em ${selectedNames}!`, timestamp, isDiceRoll: false, isAction: true })
  }

  const handleSafariSurpresa = () => {
    if (!safariActiveRun || safariSelectedPokemon.size === 0) return
    const runKey = `run-${safariActiveRun}`
    const encounters = safariRunEncounters[runKey] || []
    const newEncounters = encounters.map(p => {
      if (!safariSelectedPokemon.has(p.id)) return p
      return { ...p, chanceFuga: Math.max(0, p.chanceFuga - 25), chanceCaptura: p.chanceCaptura + 25 }
    })
    const newRunEncounters = { ...safariRunEncounters, [runKey]: newEncounters }
    setSafariRunEncounters(newRunEncounters)
    saveSafariToFirebase({ runEncounters: newRunEncounters })

    const selectedNames = encounters.filter(p => safariSelectedPokemon.has(p.id)).map(p => p.species).join(', ')
    const timestamp = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
    addChatMessage({ username: currentUser.username, text: `💥 Ação Surpresa em ${selectedNames}!`, timestamp, isDiceRoll: false, isAction: true })
  }

  const handleSafariBall = () => {
    const safariballItem = keyItems.find(item => item.name === 'Safariball')
    if (!safariballItem || safariballItem.quantity < 1) {
      alert('Você não tem Safariballs!')
      return
    }
    if (safariballItem.quantity === 1) {
      setKeyItems(keyItems.filter(item => item.name !== 'Safariball'))
    } else {
      setKeyItems(keyItems.map(item =>
        item.name === 'Safariball' ? { ...item, quantity: item.quantity - 1 } : item
      ))
    }

    // Usar mod captura do primeiro pokemon selecionado
    const runKey = safariActiveRun ? `run-${safariActiveRun}` : null
    const encounters = runKey ? (safariRunEncounters[runKey] || []) : []
    const selectedPkm = encounters.find(p => safariSelectedPokemon.has(p.id))
    const modCaptura = selectedPkm ? selectedPkm.chanceCaptura : 0

    // Calcular modificadores de captura do treinador (Safari Mod Captura)
    let safariModifiersTotal = 0
    const safariModifierDetails = []
    const currentUserModifiers = userBattleModifiers[currentUser.username] || []

    for (const modIndex of safariActiveCaptureModifiers) {
      const modifier = currentUserModifiers[modIndex]
      if (!modifier || !modifier.aplicarCaptura) continue

      const processedMod = processCommandExpression(modifier.mod)
      if (processedMod) {
        safariModifiersTotal += processedMod.finalResult
        safariModifierDetails.push(`${modifier.nome}=${processedMod.finalResult}`)
      }
    }

    const roll = Math.floor(Math.random() * 100) + 1
    const finalRoll = roll - safariModifiersTotal // SUBTRAIR modificadores da rolagem

    const timestamp = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
    const detailsParts = [`1d100 = ${roll}`]
    if (safariModifierDetails.length > 0) {
      detailsParts.push(`Mod. Safari: -${safariModifiersTotal} (${safariModifierDetails.join(', ')})`)
    }
    if (modCaptura !== 0) {
      detailsParts.push(`Mod. Pokémon: ${modCaptura >= 0 ? '+' : ''}${modCaptura}`)
    }
    detailsParts.push(`Total: ${finalRoll}`)

    addChatMessage({
      username: currentUser.username,
      text: `🎯 Lançou uma Safariball!`,
      timestamp,
      isDiceRoll: true,
      diceResult: finalRoll,
      diceDetails: detailsParts.join(' | ')
    })
  }

  const handleSafariFuga = () => {
    const hasCorreria = skills.ataque && skills.ataque.includes('Corrida')
    const runKey = safariActiveRun ? `run-${safariActiveRun}` : null
    const encounters = runKey ? (safariRunEncounters[runKey] || []) : []
    const numPokemon = encounters.length
    const dc = numPokemon + 8

    const roll = Math.floor(Math.random() * 20) + 1
    let total, diceDetails

    if (hasCorreria) {
      // Usar fórmula de perícia Corrida
      const count = skills.ataque.filter(s => s === 'Corrida').length
      const modAtaque = getModifier(attributes.ataque)

      let baseBonus, modifierMultiplier
      if (count === 1) {
        baseBonus = 2
        modifierMultiplier = 1
      } else {
        baseBonus = 4
        modifierMultiplier = 2
      }

      const modifierBonus = modifierMultiplier * modAtaque
      total = roll + baseBonus + modifierBonus
      diceDetails = `1d20 = ${roll} | ${baseBonus} + ${modifierMultiplier > 1 ? `${modifierMultiplier}x` : ''}Modificador(${modAtaque}) = ${modifierBonus} | Total: ${total} vs DC ${dc} (${numPokemon} pkm + 8) → ${total > dc ? '✅ Escapou!' : '❌ Falhou!'}`
    } else {
      // Fuga normal (sem perícia)
      const modVel = getModifier(attributes.velocidade)
      total = roll + modVel
      diceDetails = `1d20(${roll})+${modVel} = ${total} vs DC ${dc} (${numPokemon} pkm + 8) → ${total > dc ? '✅ Escapou!' : '❌ Falhou!'}`
    }

    const sucesso = total > dc

    const timestamp = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
    addChatMessage({
      username: currentUser.username,
      text: `🏃 ${hasCorreria ? 'Correria' : 'Fuga'}!`,
      timestamp,
      isDiceRoll: true,
      diceResult: total,
      diceDetails: diceDetails
    })

    if (sucesso) {
      setSafariSubarea('Mapa Safari')
    }
  }

  // ==================== FUNÇÕES DE MANIPULAÇÃO DE TOKENS VTT ====================

  // Função para iniciar o arrasto de um token
  const handleTokenMouseDown = (tokenId, layer, event) => {
    event.preventDefault()
    event.stopPropagation()

    // Verificar permissões
    const tokens = layer === 'gm' ? vttGMTokens : layer === 'map' ? vttMapTokens : vttTokens
    const token = tokens.find(t => t.id === tokenId)

    if (!token) return

    // Mestre pode arrastar qualquer token
    // Jogadores só podem arrastar tokens que pertencem a eles
    if (currentUser.type !== 'mestre' && token.owner !== currentUser.username) {
      return
    }

    // Pegar posição do canvas
    const canvas = event.currentTarget.closest('[data-vtt-canvas]')
    const rect = canvas ? canvas.getBoundingClientRect() : { left: 0, top: 0 }

    // Calcular posição do mouse relativa ao canvas, considerando zoom e offset
    const mouseX = (event.clientX - rect.left - vttViewportOffset.x) / vttViewportZoom
    const mouseY = (event.clientY - rect.top - vttViewportOffset.y) / vttViewportZoom

    // Offset é a diferença entre posição do mouse e posição do token
    const offsetX = mouseX - token.x
    const offsetY = mouseY - token.y

    // Calcular centro do token para a régua
    const tokenCenterX = token.x + token.size / 2
    const tokenCenterY = token.y + token.size / 2

    setSelectedToken(tokenId)
    setDraggingToken({ id: tokenId, layer, offsetX, offsetY, startX: tokenCenterX, startY: tokenCenterY })
    // Resetar régua ao iniciar novo arrasto
    setVttRulerActive(false)
  }

  // Função para ativar a régua com tecla "M" durante arrasto
  const activateRuler = () => {
    // Só ativa a régua se estiver arrastando um token
    if (!draggingToken) return

    // Pegar o token atual
    const tokens = draggingToken.layer === 'gm' ? vttGMTokens : draggingToken.layer === 'map' ? vttMapTokens : vttTokens
    const token = tokens.find(t => t.id === draggingToken.id)

    if (!token) return

    // Centro atual do token
    const tokenCenterX = token.x + token.size / 2
    const tokenCenterY = token.y + token.size / 2

    // Ativar régua a partir da posição inicial do token
    setVttRulerActive(true)
    setVttRulerStart({ x: draggingToken.startX, y: draggingToken.startY })
    setVttRulerEnd({ x: tokenCenterX, y: tokenCenterY })
  }

  // Função para mover o token durante o arrasto
  const handleTokenMouseMove = (event) => {
    if (!draggingToken) return

    event.preventDefault()

    const canvas = event.currentTarget
    const rect = canvas.getBoundingClientRect()

    // Calcular posição do mouse relativa ao canvas, considerando zoom e offset
    let newX = (event.clientX - rect.left - vttViewportOffset.x) / vttViewportZoom - draggingToken.offsetX
    let newY = (event.clientY - rect.top - vttViewportOffset.y) / vttViewportZoom - draggingToken.offsetY

    // Aplicar snap to grid se ativo
    if (vttSnapToGrid) {
      const cellWidth = vttCanvasWidth / vttGridColumns
      const cellHeight = vttCanvasHeight / vttGridRows
      newX = Math.round(newX / cellWidth) * cellWidth
      newY = Math.round(newY / cellHeight) * cellHeight
    }

    // Atualizar posição do token
    if (draggingToken.layer === 'gm') {
      setVttGMTokens(prev => prev.map(t =>
        t.id === draggingToken.id ? { ...t, x: newX, y: newY } : t
      ))
    } else if (draggingToken.layer === 'map') {
      setVttMapTokens(prev => prev.map(t =>
        t.id === draggingToken.id ? { ...t, x: newX, y: newY } : t
      ))
    } else {
      setVttTokens(prev => prev.map(t =>
        t.id === draggingToken.id ? { ...t, x: newX, y: newY } : t
      ))
    }

    // Atualizar posição final da régua se estiver ativa
    if (vttRulerActive) {
      // Pegar o tamanho do token para calcular o centro
      const tokens = draggingToken.layer === 'gm' ? vttGMTokens : draggingToken.layer === 'map' ? vttMapTokens : vttTokens
      const token = tokens.find(t => t.id === draggingToken.id)
      const tokenSize = token ? token.size : vttGridSize
      setVttRulerEnd({ x: newX + tokenSize / 2, y: newY + tokenSize / 2 })
    }
  }

  // Função para finalizar o arrasto
  const handleTokenMouseUp = () => {
    setDraggingToken(null)
    setVttDraggingMap(false)
    // Desativar a régua quando soltar o token
    setVttRulerActive(false)
  }

  // Funções para arrastar o mapa (quando na camada 'map')
  const handleMapImageMouseDown = (event) => {
    if (vttCurrentLayer !== 'map' || currentUser.type !== 'mestre') return
    event.preventDefault()
    event.stopPropagation()
    setVttDraggingMap(true)
    setVttMapDragStart({
      x: event.clientX - vttMapPosition.x,
      y: event.clientY - vttMapPosition.y
    })
  }

  const handleMapImageMouseMove = (event) => {
    if (!vttDraggingMap) return
    event.preventDefault()
    setVttMapPosition({
      x: event.clientX - vttMapDragStart.x,
      y: event.clientY - vttMapDragStart.y
    })
  }

  const handleMapImageMouseUp = () => {
    setVttDraggingMap(false)
  }

  // Callback ref para adicionar listener de wheel com passive: false (bloqueia scroll da página)
  const setCanvasRef = useCallback((node) => {
    // Remover listener do nó anterior se existir
    if (vttCanvasRef.current && vttCanvasRef.current._wheelHandler) {
      vttCanvasRef.current.removeEventListener('wheel', vttCanvasRef.current._wheelHandler)
    }

    // Adicionar listener ao novo nó
    if (node) {
      const wheelHandler = (event) => {
        // Só fazer zoom se a tecla Ctrl estiver pressionada
        if (!event.ctrlKey) return

        event.preventDefault()
        event.stopPropagation()

        const zoomSpeed = 0.1
        const delta = event.deltaY > 0 ? -zoomSpeed : zoomSpeed

        setVttViewportZoom(prevZoom => {
          const newZoom = prevZoom + delta
          // Limitar zoom entre 0.25 (25%) e 4 (400%)
          return Math.min(Math.max(newZoom, 0.25), 4)
        })
      }
      node._wheelHandler = wheelHandler
      node.addEventListener('wheel', wheelHandler, { passive: false })
    }

    vttCanvasRef.current = node
  }, [])

  // Funções para pan (arrastar a visualização com botão direito do mouse)
  const handlePanStart = (event) => {
    // Iniciar pan com botão direito do mouse (button === 2)
    if (event.button === 2) {
      event.preventDefault()
      setVttIsPanning(true)
      setVttPanStart({ x: event.clientX - vttViewportOffset.x, y: event.clientY - vttViewportOffset.y })
    }
  }

  const handlePanMove = (event) => {
    if (vttIsPanning) {
      setVttViewportOffset({
        x: event.clientX - vttPanStart.x,
        y: event.clientY - vttPanStart.y
      })
    }
  }

  const handlePanEnd = () => {
    setVttIsPanning(false)
  }

  // Resetar zoom e pan
  const resetViewport = () => {
    setVttViewportZoom(1)
    setVttViewportOffset({ x: 0, y: 0 })
  }

  // Adicionar listeners globais para drag e tecla M (régua)
  useEffect(() => {
    if (draggingToken) {
      // Handler para tecla M ativar a régua
      const handleKeyDown = (event) => {
        if (event.key === 'm' || event.key === 'M') {
          activateRuler()
        }
      }

      window.addEventListener('mouseup', handleTokenMouseUp)
      window.addEventListener('keydown', handleKeyDown)
      return () => {
        window.removeEventListener('mouseup', handleTokenMouseUp)
        window.removeEventListener('keydown', handleKeyDown)
      }
    }
  }, [draggingToken])

  // Scroll automático para última mensagem do chat (apenas dentro do container)
  useEffect(() => {
    if (chatContainerRef.current) {
      chatContainerRef.current.scrollTop = chatContainerRef.current.scrollHeight
    }
  }, [chatMessages])

  // Sincronizar VTT em tempo real com Firebase
  useEffect(() => {
    if (!useFirebase) return

    const unsubscribe = subscribeToVTT((data) => {
      setVttLocations(data.locations || [])
      setCurrentVttLocation(data.currentLocation || null)
      setVttGridSize(data.gridSize || 50)
      setVttShowGrid(data.showGrid !== undefined ? data.showGrid : true)
      setVttSnapToGrid(data.snapToGrid !== undefined ? data.snapToGrid : true)
      setVttGridColumns(data.gridColumns || 16)
      setVttGridRows(data.gridRows || 16)
      setVttCanvasWidth(data.canvasWidth || 800)
      setVttCanvasHeight(data.canvasHeight || 800)
    })

    return () => {
      if (unsubscribe) unsubscribe()
    }
  }, [])

  // Carregar tokens e mapa da localidade atual (apenas quando a localidade selecionada muda)
  useEffect(() => {
    if (!currentVttLocation || vttLocations.length === 0) {
      setVttMapImage(null)
      setVttTokens([])
      setVttGMTokens([])
      setVttMapTokens([])
      setVttMapPosition({ x: 0, y: 0 })
      return
    }

    const location = vttLocations.find(loc => loc.id === currentVttLocation)
    if (location) {
      // Marcar que estamos carregando para evitar que o effect de salvamento seja acionado
      isLoadingVttLocationRef.current = true

      setVttMapImage(location.mapUrl || null)
      setVttTokens(location.tokens || [])
      setVttGMTokens(location.gmTokens || [])
      setVttMapTokens(location.mapTokens || [])
      setVttMapPosition(location.mapPosition || { x: 0, y: 0 })

      // Resetar o flag após um pequeno delay para permitir que os states sejam atualizados
      setTimeout(() => {
        isLoadingVttLocationRef.current = false
      }, 100)
    }
  }, [currentVttLocation]) // IMPORTANTE: Apenas currentVttLocation, NÃO vttLocations

  // Salvar tokens e posição do mapa da localidade atual quando mudarem
  useEffect(() => {
    // Não salvar se estamos carregando dados de uma localidade
    if (isLoadingVttLocationRef.current) return
    if (!currentVttLocation || vttLocations.length === 0) return

    const currentLocation = vttLocations.find(loc => loc.id === currentVttLocation)
    if (!currentLocation) return

    // Verificar se realmente houve mudança em relação à localidade armazenada
    const currentTokensStr = JSON.stringify(currentLocation.tokens || [])
    const currentGmTokensStr = JSON.stringify(currentLocation.gmTokens || [])
    const currentMapTokensStr = JSON.stringify(currentLocation.mapTokens || [])
    const currentMapPosStr = JSON.stringify(currentLocation.mapPosition || { x: 0, y: 0 })

    const newTokensStr = JSON.stringify(vttTokens)
    const newGmTokensStr = JSON.stringify(vttGMTokens)
    const newMapTokensStr = JSON.stringify(vttMapTokens)
    const newMapPosStr = JSON.stringify(vttMapPosition)

    if (currentTokensStr === newTokensStr &&
        currentGmTokensStr === newGmTokensStr &&
        currentMapTokensStr === newMapTokensStr &&
        currentMapPosStr === newMapPosStr) {
      return // Nenhuma mudança real
    }

    const updatedLocations = vttLocations.map(loc => {
      if (loc.id === currentVttLocation) {
        return {
          ...loc,
          tokens: vttTokens,
          gmTokens: vttGMTokens,
          mapTokens: vttMapTokens,
          mapPosition: vttMapPosition
        }
      }
      return loc
    })

    setVttLocations(updatedLocations)
  }, [vttTokens, vttGMTokens, vttMapTokens, vttMapPosition])

  // Salvar dados do VTT no Firebase quando mudarem (com debounce)
  useEffect(() => {
    if (!useFirebase || !currentUser || currentUser.type !== 'mestre') return

    const timer = setTimeout(() => {
      const vttData = {
        locations: vttLocations,
        currentLocation: currentVttLocation,
        gridSize: vttGridSize,
        showGrid: vttShowGrid,
        snapToGrid: vttSnapToGrid,
        gridColumns: vttGridColumns,
        gridRows: vttGridRows,
        canvasWidth: vttCanvasWidth,
        canvasHeight: vttCanvasHeight
      }
      saveVTTData(vttData)
    }, 500)

    return () => clearTimeout(timer)
  }, [vttLocations, currentVttLocation, vttGridSize, vttShowGrid, vttSnapToGrid, vttGridColumns, vttGridRows, vttCanvasWidth, vttCanvasHeight])

  // Sincronizar itens ocultos da Pokéloja em tempo real com Firebase
  useEffect(() => {
    if (!useFirebase) return

    const unsubscribe = subscribeToHiddenPokelojaItems((items) => {
      setHiddenPokelojaItems(items || [])
    })

    return () => {
      if (unsubscribe) unsubscribe()
    }
  }, [])

  // Função para sortear aleatoriamente quais itens de um corredor serão escondidos
  // Baseado no peso de cada item (maior peso = maior chance de esconder)
  const sortearItensEscondidosCorredor = async (corredor, items) => {
    // Remover todos os itens deste corredor da lista de escondidos
    const itensDesteCorredor = items.map(item => item.name)
    let novosEscondidos = hiddenPokelojaItems.filter(name => !itensDesteCorredor.includes(name))

    // Para cada item, sortear se será escondido baseado no peso
    items.forEach(item => {
      const peso = POKELOJA_HIDE_WEIGHTS[item.name] || 3 // Peso padrão 3 se não definido
      // Probabilidade de esconder = peso * 10% (ex: peso 1 = 10%, peso 6 = 60%)
      const probabilidade = peso * 0.10
      const sorteio = Math.random()

      if (sorteio < probabilidade) {
        novosEscondidos.push(item.name)
      }
    })

    setHiddenPokelojaItems(novosEscondidos)
    if (useFirebase) {
      await saveHiddenPokelojaItems(novosEscondidos)
    }
  }

  // Função para resetar um corredor (remover escondidos e preços customizados)
  const resetarCorredor = async (corredor, items) => {
    const itensDesteCorredor = items.map(item => item.name)

    // Remover itens deste corredor da lista de escondidos
    const novosEscondidos = hiddenPokelojaItems.filter(name => !itensDesteCorredor.includes(name))
    setHiddenPokelojaItems(novosEscondidos)
    if (useFirebase) {
      await saveHiddenPokelojaItems(novosEscondidos)
    }

    // Remover preços customizados dos itens deste corredor
    const novosCustomPrices = { ...customPrices }
    itensDesteCorredor.forEach(itemName => {
      delete novosCustomPrices[itemName]
    })
    setCustomPrices(novosCustomPrices)
    if (useFirebase) {
      await saveCustomPrices(novosCustomPrices)
    }
  }

  // Sincronizar preços customizados da Pokéloja em tempo real com Firebase
  useEffect(() => {
    if (!useFirebase) return

    const unsubscribe = subscribeToCustomPrices((prices) => {
      setCustomPrices(prices || {})
    })

    return () => {
      if (unsubscribe) unsubscribe()
    }
  }, [])

  // Sincronizar dados de XP & Capturas em tempo real com Firebase (treinador)
  useEffect(() => {
    if (!useFirebase || !currentUser || currentUser.type !== 'treinador') return

    const unsubscribe = subscribeToXpCapturas(currentUser.username, (data) => {
      setXpList(data?.xpList || [])
      setCapturaList(data?.capturaList || [])
    })

    return () => {
      if (unsubscribe) unsubscribe()
    }
  }, [currentUser, useFirebase])

  // Sincronizar dados de XP & Capturas de TODOS os treinadores (para o mestre)
  useEffect(() => {
    if (!useFirebase || !currentUser || currentUser.type !== 'mestre') return

    const unsubscribe = subscribeToAllXpCapturas((data) => {
      setAllTrainersXpCapturas(data || {})
    })

    return () => {
      if (unsubscribe) unsubscribe()
    }
  }, [currentUser, useFirebase])

  // Sincronizar dados de batalha em tempo real com Firebase
  useEffect(() => {
    if (!useFirebase || !currentUser) return

    // Inscrever para receber atualizações em tempo real da batalha
    const unsubscribe = subscribeToBattle((data) => {
      if (data) {
        // Atualizar estados de batalha
        // Usar || [] para garantir que arrays vazios sejam aplicados quando o campo não existe no Firebase
        setBattleTrainers(Array.isArray(data.battleTrainers) ? data.battleTrainers : [])
        setBattlePokemon(Array.isArray(data.battlePokemon) ? data.battlePokemon : [])
        setBattleTrainersList(Array.isArray(data.battleTrainersList) ? data.battleTrainersList : [])
        setBattlePokemonList(Array.isArray(data.battlePokemonList) ? data.battlePokemonList : [])
        setCurrentTrainerTurn(data.currentTrainerTurn !== undefined ? data.currentTrainerTurn : 0)
        setCurrentPokemonTurn(data.currentPokemonTurn !== undefined ? data.currentPokemonTurn : 0)
        setTrainerRound(data.trainerRound !== undefined ? data.trainerRound : 1)
        setPokemonRound(data.pokemonRound !== undefined ? data.pokemonRound : 1)
        // NOTA: stages agora são carregados de path separado (battleStages/)
        setBattlePokemonConditions(data.battlePokemonConditions || {})
        setBattleTrainerConditions(data.battleTrainerConditions || {})
        setRevealedNpcPokemon(data.revealedNpcPokemon || {})
        setRevealedTrainers(data.revealedTrainers || {})
      } else {
        // Se data é null/undefined, significa que os dados foram limpos - resetar tudo
        setBattleTrainers([])
        setBattlePokemon([])
        setBattleTrainersList([])
        setBattlePokemonList([])
        setCurrentTrainerTurn(0)
        setCurrentPokemonTurn(0)
        setTrainerRound(1)
        setPokemonRound(1)
        setBattlePokemonConditions({})
        setBattleTrainerConditions({})
        setRevealedNpcPokemon({})
        setRevealedTrainers({})
      }
    })

    // Cleanup: cancelar inscrição quando componente desmontar
    return () => {
      if (unsubscribe) unsubscribe()
    }
  }, [currentUser])

  // Sincronizar stages em tempo real (path separado para evitar conflitos)
  useEffect(() => {
    if (!useFirebase || !currentUser) return

    console.log('[DEBUG] Iniciando subscriptions de stages para:', currentUser.username)

    // Inscrever para receber atualizações em tempo real dos stages
    const unsubscribePokemon = subscribeToPokemonStages((data) => {
      console.log('[DEBUG] subscribeToPokemonStages recebeu:', data)
      setPokemonStages(data || {})
    })

    const unsubscribeTrainer = subscribeToTrainerStages((data) => {
      console.log('[DEBUG] subscribeToTrainerStages recebeu:', data)
      setTrainerStages(data || {})
    })

    // Cleanup: cancelar inscrições quando componente desmontar
    return () => {
      if (unsubscribePokemon) unsubscribePokemon()
      if (unsubscribeTrainer) unsubscribeTrainer()
    }
  }, [currentUser])

  // Salvar dados de batalha no Firebase (apenas mestre pode salvar)
  // NOTA: stages são salvos em paths separados pelas funções adjust
  const saveBattleToFirebase = useCallback(async () => {
    if (!useFirebase) return

    const battleData = {
      battleTrainers,
      battlePokemon,
      battleTrainersList,
      battlePokemonList,
      currentTrainerTurn,
      currentPokemonTurn,
      trainerRound,
      pokemonRound,
      battlePokemonConditions,
      revealedNpcPokemon,
      revealedTrainers
    }

    await saveBattleData(battleData)
  }, [battleTrainers, battlePokemon, battleTrainersList, battlePokemonList, currentTrainerTurn, currentPokemonTurn, trainerRound, pokemonRound, battlePokemonConditions, revealedNpcPokemon, revealedTrainers])

  // Salvar dados de batalha automaticamente quando mestre faz alterações
  // NOTA: pokemonStages e trainerStages são salvos APENAS pelas funções adjustPokemonStage/adjustTrainerStage
  // em paths separados (battleStages/) para evitar conflitos de sincronização
  useEffect(() => {
    if (!useFirebase || !currentUser || currentUser.type !== 'mestre') return

    // Debounce para evitar muitas escritas
    const timeoutId = setTimeout(() => {
      saveBattleData({
        battleTrainers,
        battlePokemon,
        battleTrainersList,
        battlePokemonList,
        currentTrainerTurn,
        currentPokemonTurn,
        trainerRound,
        pokemonRound,
        // NOTA: stages NÃO são incluídos aqui - são salvos em paths separados
        battlePokemonConditions,
        revealedNpcPokemon,
        revealedTrainers
      })
    }, 500)

    return () => clearTimeout(timeoutId)
  }, [currentUser, battleTrainersList, battlePokemonList, currentTrainerTurn, currentPokemonTurn, trainerRound, pokemonRound, battlePokemonConditions, revealedNpcPokemon, revealedTrainers])

  // ===== QUESTS: Subscription (tempo real para todos) =====
  useEffect(() => {
    const unsub = subscribeToQuests((data) => {
      if (questsSaveSkipRef.current) { questsSaveSkipRef.current = false; setQuests(Array.isArray(data) ? data : Object.values(data || {})); return }
      setQuests(Array.isArray(data) ? data : Object.values(data || {}))
    })
    return () => unsub()
  }, [])

  // ===== QUESTS: Auto-save quando mudam (somente mestre salva) =====
  useEffect(() => {
    if (questsSaveSkipRef.current) return
    if (!currentUser || currentUser.type !== 'mestre') return
    saveQuests(quests)
  }, [quests])

  // ===== SMART POKEFONE: Subscription (somente treinador) =====
  useEffect(() => {
    if (!currentUser || currentUser.type !== 'treinador') return
    smartPokefoneSaveSkipRef.current = true
    const unsub = subscribeToSmartPokefoneMessages(currentUser.username, (data) => {
      if (smartPokefoneSaveSkipRef.current) { smartPokefoneSaveSkipRef.current = false; setSmartPokefoneMessages(Array.isArray(data) ? data : Object.values(data || {})); return }
      setSmartPokefoneMessages(Array.isArray(data) ? data : Object.values(data || {}))
    })
    return () => unsub()
  }, [currentUser])

  // ===== SMART POKEFONE: Auto-save =====
  useEffect(() => {
    if (smartPokefoneSaveSkipRef.current) return
    if (!currentUser || currentUser.type !== 'treinador') return
    saveSmartPokefoneMessages(currentUser.username, smartPokefoneMessages)
  }, [smartPokefoneMessages])

  // ===== OBJETIVOS GERAIS: Subscription =====
  useEffect(() => {
    triunfosGeraisSaveSkipRef.current = true
    const unsub = subscribeToTriunfosGerais((data) => {
      if (triunfosGeraisSaveSkipRef.current) { triunfosGeraisSaveSkipRef.current = false; setTriunfosGerais(Array.isArray(data) ? data : Object.values(data || {})); return }
      setTriunfosGerais(Array.isArray(data) ? data : Object.values(data || {}))
    })
    return () => unsub()
  }, [])

  useEffect(() => {
    if (triunfosGeraisSaveSkipRef.current) return
    if (!currentUser || currentUser.type !== 'mestre') return
    saveTriunfosGerais(triunfosGerais)
  }, [triunfosGerais])

  // ===== OBJETIVOS INDIVIDUAIS: Subscription =====
  useEffect(() => {
    triunfosIndividuaisSaveSkipRef.current = true
    const unsub = subscribeToTriunfosIndividuais((data) => {
      if (triunfosIndividuaisSaveSkipRef.current) { triunfosIndividuaisSaveSkipRef.current = false; setTriunfosIndividuais(data || {}); return }
      setTriunfosIndividuais(data || {})
    })
    return () => unsub()
  }, [])

  useEffect(() => {
    if (triunfosIndividuaisSaveSkipRef.current) return
    if (!currentUser || currentUser.type !== 'mestre') return
    saveTriunfosIndividuais(triunfosIndividuais)
  }, [triunfosIndividuais])

  // ===== MOSTRAR TRIUNFOS: Subscription (todos os usuários) =====
  useEffect(() => {
    if (!useFirebase || !currentUser) return
    const unsubscribe = subscribeToMostrarTriunfos((data) => {
      setMostrarTriunfosData(data)
      if (data?.ativo) {
        setMostrarTriunfosMinimized(false)
        if (currentUser.type === 'treinador') setMostrarTriunfosPlayerOpen(true)
      } else {
        if (currentUser.type === 'treinador') setMostrarTriunfosPlayerOpen(false)
      }
    })
    return () => unsubscribe()
  }, [currentUser, useFirebase])

  // ===== POKE AGENDA: Subscription =====
  useEffect(() => {
    if (!useFirebase || !currentUser) return
    anotacoesSaveSkipRef.current = true
    const unsub = subscribeToAnotacoes(currentUser.username, (data) => {
      if (anotacoesSaveSkipRef.current) { anotacoesSaveSkipRef.current = false; setAnotacoes(Array.isArray(data) ? data : Object.values(data || {})); return }
      setAnotacoes(Array.isArray(data) ? data : Object.values(data || {}))
    })
    return () => unsub()
  }, [currentUser, useFirebase])

  useEffect(() => {
    if (anotacoesSaveSkipRef.current) return
    if (!useFirebase || !currentUser) return
    saveAnotacoes(currentUser.username, anotacoes)
  }, [anotacoes])

  // Variável do modal de Account Data (reutilizável em todos os returns)
  const accountDataModal = currentUser ? (
    <AccountDataModal
      show={showAccountDataModal}
      onClose={() => setShowAccountDataModal(false)}
      darkMode={darkMode}
      currentUser={currentUser}
      handleDownloadAccountData={handleDownloadAccountData}
      handleUploadAccountData={handleUploadAccountData}
    />
  ) : null

  // Popup de exibição de cenário — aparece para mestre (quando ativo) e jogadores
  const scenarioPopupOverlay = (() => {
    const isMestre = currentUser?.type === 'mestre'
    if (isMestre) {
      if (!scenarioDisplay?.active) return null
    } else {
      if (!playerScenarioPopupOpen) return null
    }
    // Os dados do cenário são embutidos diretamente no scenarioDisplay para que jogadores
    // também os recebam via Firebase sem precisar assinar sessionScenarios
    const scenarioTitle = scenarioDisplay?.title || ''
    const scenarioImageUrls = scenarioDisplay?.imageUrls || []
    if (!scenarioTitle && scenarioImageUrls.length === 0) return null
    const totalImages = scenarioImageUrls.length
    const currentIdx = Math.max(0, Math.min(scenarioDisplay?.currentImageIndex || 0, totalImages - 1))
    const imageUrl = scenarioImageUrls[currentIdx]
    const canClose = !scenarioDisplay?.active // jogadores só fecham quando mestre fechar
    const handleNav = (newIdx) => {
      setScenarioDisplay(prev => ({ ...prev, currentImageIndex: newIdx }))
    }
    return (
      <div className="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-[200] p-4">
        <div className={`${darkMode ? 'bg-gray-800' : 'bg-gray-900'} rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col`}>
          {/* Header */}
          <div className="flex justify-between items-center px-5 py-3 border-b border-gray-700 flex-shrink-0">
            <h3 className="text-white text-lg font-bold truncate pr-4">{scenarioTitle}</h3>
            {isMestre && (
              <button
                onClick={() => setScenarioDisplay(prev => ({ ...prev, active: false }))}
                className="text-gray-400 hover:text-white flex-shrink-0"
              >
                <X size={22} />
              </button>
            )}
            {!isMestre && canClose && (
              <button
                onClick={() => setPlayerScenarioPopupOpen(false)}
                className="text-gray-400 hover:text-white flex-shrink-0"
              >
                <X size={22} />
              </button>
            )}
          </div>
          {/* Imagem */}
          <div className="flex-1 overflow-hidden flex items-center justify-center p-4 min-h-0">
            {imageUrl
              ? <img src={imageUrl} alt={scenarioTitle} className="max-w-full max-h-full object-contain rounded-lg" />
              : <span className="text-gray-500">Sem imagem</span>
            }
          </div>
          {/* Navegação */}
          {totalImages > 1 && (
            <div className="flex items-center justify-center gap-3 px-5 py-3 border-t border-gray-700 flex-shrink-0">
              {isMestre ? (
                <>
                  <button
                    onClick={() => handleNav(Math.max(0, currentIdx - 1))}
                    disabled={currentIdx === 0}
                    className="text-white disabled:text-gray-600 hover:text-blue-400 text-2xl font-bold w-8"
                  >←</button>
                  <div className="flex items-center gap-1">
                    <input
                      type="number"
                      min={1}
                      max={totalImages}
                      value={currentIdx + 1}
                      onChange={(e) => {
                        const val = parseInt(e.target.value) - 1
                        if (!isNaN(val) && val >= 0 && val < totalImages) handleNav(val)
                      }}
                      className="w-14 text-center bg-gray-700 text-white rounded px-2 py-1 text-sm border border-gray-600 focus:outline-none focus:border-blue-500"
                    />
                    <span className="text-gray-400 text-sm">/ {totalImages}</span>
                  </div>
                  <button
                    onClick={() => handleNav(Math.min(totalImages - 1, currentIdx + 1))}
                    disabled={currentIdx >= totalImages - 1}
                    className="text-white disabled:text-gray-600 hover:text-blue-400 text-2xl font-bold w-8"
                  >→</button>
                </>
              ) : (
                <span className="text-gray-400 text-sm">{currentIdx + 1} / {totalImages}</span>
              )}
            </div>
          )}
        </div>
      </div>
    )
  })()

  // ===== MOSTRAR TRIUNFOS OVERLAY (broadcast para todos os usuários) =====
  const mostrarTriunfosOverlay = (() => {
    const isMestre = currentUser?.type === 'mestre'
    if (isMestre) {
      if (!mostrarTriunfosData?.ativo) return null
    } else {
      if (!mostrarTriunfosPlayerOpen) return null
    }
    const tipo = mostrarTriunfosData?.tipo
    const usernameAlvo = mostrarTriunfosData.username

    if (mostrarTriunfosMinimized && !isMestre) {
      return (
        <div className="fixed bottom-4 right-20 z-[150]">
          <button
            onClick={() => setMostrarTriunfosMinimized(false)}
            className="bg-purple-700 hover:bg-purple-600 text-white px-4 py-2 rounded-full shadow-lg flex items-center gap-2 font-semibold text-sm"
          >
            <Trophy size={16} className="text-yellow-400" />
            Objetivos
          </button>
        </div>
      )
    }

    const lista = tipo === 'geral'
      ? triunfosGerais
      : (tipo === 'individual' && usernameAlvo ? triunfosIndividuais[usernameAlvo] || [] : [])

    return (
      <div className="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-[150] p-4">
        <div className="bg-gray-800 rounded-2xl shadow-2xl max-w-lg w-full max-h-[85vh] flex flex-col">
          <div className="flex justify-between items-center px-5 py-4 border-b border-gray-700 flex-shrink-0">
            <div className="flex items-center gap-2">
              <Trophy size={20} className="text-yellow-400" />
              <h3 className="text-white text-lg font-bold">
                {tipo === 'geral' ? 'Objetivos Gerais' : `Objetivos de ${usernameAlvo}`}
              </h3>
            </div>
            <div className="flex items-center gap-2">
              {!isMestre && (
                <button
                  onClick={() => setMostrarTriunfosMinimized(true)}
                  title="Minimizar"
                  className="text-gray-400 hover:text-white"
                >
                  <ChevronDown size={20} />
                </button>
              )}
              {isMestre && (
                <button
                  onClick={() => { setMostrarTriunfosData({ ativo: false }); saveMostrarTriunfos({ ativo: false }) }}
                  className="text-gray-400 hover:text-white"
                  title="Fechar para todos"
                >
                  <X size={20} />
                </button>
              )}
            </div>
          </div>
          <div className="overflow-y-auto flex-1 p-5">
            {lista.length === 0 ? (
              <p className="text-gray-400 text-center py-4">Nenhum objetivo.</p>
            ) : (
              <div className="space-y-3">
                {lista.map(t => {
                  const completo = tipo === 'geral' ? (t.realizadores || []).length >= t.vagas : t.realizado
                  const realizadores = tipo === 'geral' ? (t.realizadores || []) : (t.realizado ? [usernameAlvo] : [])
                  const trainerUsers = users.filter(u => u.type === 'treinador')
                  return (
                    <div key={t.id} className="p-3 rounded-xl border border-gray-700 bg-gray-900">
                      <p className={`font-semibold text-sm ${completo ? 'text-blue-400' : 'text-white'}`}>{t.texto}</p>
                      {tipo === 'geral' && (
                        <p className="text-xs text-gray-400 mt-1">{(t.realizadores || []).length}/{t.vagas} realizadores</p>
                      )}
                      {realizadores.length > 0 && (
                        <div className="flex flex-wrap gap-1 mt-2">
                          {realizadores.map(u => {
                            const uData = trainerUsers.find(usr => usr.username === u)
                            return (
                              <span key={u} className="text-xs font-bold text-white px-2 py-0.5 rounded-full" style={{ background: uData?.gradient || '#555' }}>
                                {u}
                              </span>
                            )
                          })}
                        </div>
                      )}
                    </div>
                  )
                })}
              </div>
            )}
          </div>
        </div>
      </div>
    )
  })()

  // ===== POKEZAP =====
  const pokezapOtherUsers = currentUser ? users.filter(u => u.username !== currentUser.username) : []
  const pokezapVisibleMessages = currentUser ? pokezapMessages.filter(msg =>
    msg.sender === currentUser.username ||
    (msg.recipients || []).includes(currentUser.username) ||
    currentUser.type === 'mestre'
  ) : []
  const pokezapBtn = currentUser ? (
    <button
      onClick={() => { setShowBatalhaChat(false); setShowPokeAgendaPanel(false); setShowPokezapPanel(prev => !prev) }}
      className={`p-1.5 sm:p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-200 text-gray-700'}`}
      title="PokeZap"
    >
      <img src="/logopokezapcerto.png" alt="PokeZap" className="w-5 h-5 sm:w-6 sm:h-6 object-contain" />
    </button>
  ) : null
  const pokeAgendaBtn = currentUser ? (
    <button
      onClick={() => { setShowBatalhaChat(false); setShowPokezapPanel(false); setShowPokeAgendaPanel(prev => !prev) }}
      className={`p-1.5 sm:p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-200 text-gray-700'}`}
      title="Poke Agenda"
    >
      <img src="/minipokeanotacao.png" alt="Poke Agenda" className="w-5 h-5 sm:w-6 sm:h-6 object-contain" />
    </button>
  ) : null
  const batalhaChatBtn = currentUser ? (
    <button
      onClick={() => { setShowPokezapPanel(false); setShowPokeAgendaPanel(false); setShowBatalhaChat(prev => !prev) }}
      className={`p-1.5 sm:p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-200 text-gray-700'}`}
      title="Chat de Batalha"
    >
      <img src="/minilogochatbatalha.png" alt="Chat de Batalha" className="w-5 h-5 sm:w-6 sm:h-6 object-contain" />
    </button>
  ) : null

  const batalhaChatPanel = currentUser && showBatalhaChat ? (
    <div className="fixed right-0 top-0 h-full w-80 z-50 flex flex-col shadow-2xl" style={{ background: darkMode ? '#1f2937' : '#ffffff', borderLeft: darkMode ? '1px solid #374151' : '1px solid #e5e7eb' }}>
      {/* Header */}
      <div className={`flex items-center justify-between p-3 border-b ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
        <div className="flex items-center gap-2">
          <img src="/minilogochatbatalha.png" alt="Chat de Batalha" className="w-6 h-6 object-contain" />
          <span className={`font-bold text-sm ${darkMode ? 'text-white' : 'text-gray-800'}`}>Chat de Batalha</span>
        </div>
        <button onClick={() => setShowBatalhaChat(false)} className={`p-1 rounded-lg text-sm font-bold ${darkMode ? 'hover:bg-gray-700 text-gray-400' : 'hover:bg-gray-100 text-gray-500'}`}>✕</button>
      </div>
      {/* Mensagens */}
      <div className="flex-1 overflow-y-auto p-3 flex flex-col gap-2">
        {chatMessages.length === 0 ? (
          <p className={`text-xs text-center mt-8 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>Nenhuma mensagem ainda...</p>
        ) : (
          chatMessages.map((msg, idx) => (
            <div key={idx} className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg p-2.5 border ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
              <div className="flex justify-between items-start mb-1">
                <span className={`font-bold text-xs ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>{msg.username}</span>
                <span className={`text-[10px] ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>{msg.timestamp}</span>
              </div>
              {msg.isDiceRoll ? (
                <div>
                  <p className={`text-xs ${darkMode ? 'text-gray-300' : 'text-gray-700'} whitespace-pre-line`}>{msg.text}</p>
                  {msg.diceResult !== undefined && typeof msg.diceResult === 'number' && (
                    <div className={`mt-1.5 p-1.5 rounded ${darkMode ? 'bg-green-900' : 'bg-green-100'}`}>
                      <p className={`font-bold text-sm ${darkMode ? 'text-green-400' : 'text-green-700'}`}>Resultado: {msg.diceResult}</p>
                      {msg.diceDetails && <p className={`text-[10px] ${darkMode ? 'text-green-300' : 'text-green-600'}`}>{msg.diceDetails}</p>}
                    </div>
                  )}
                </div>
              ) : msg.isAction ? (
                <p className="text-xs font-semibold text-yellow-500 whitespace-pre-line">{msg.text}</p>
              ) : (
                <p className={`text-xs ${darkMode ? 'text-gray-300' : 'text-gray-700'} whitespace-pre-line`}>{msg.text}</p>
              )}
            </div>
          ))
        )}
      </div>
      {/* Perícias (somente treinadores) */}
      {currentUser.type === 'treinador' && Object.values(skills).some(list => list.length > 0) && (
        <div className={`px-3 pt-2 pb-1 border-t ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
          <p className={`text-[10px] font-semibold mb-1.5 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Perícias:</p>
          <div className="grid grid-cols-2 gap-1 max-h-28 overflow-y-auto">
            {Object.entries(skills).map(([attr, skillList]) => {
              const attrNames = { saude: 'Saúde', ataque: 'Ataque', defesa: 'Defesa', ataqueEspecial: 'Ataque Especial', defesaEspecial: 'Defesa Especial', velocidade: 'Velocidade' }
              return skillList.map((skill, idx) => {
                const count = skillList.filter(s => s === skill).length
                const isFirst = skillList.indexOf(skill) === idx
                if (!isFirst) return null
                const modifier = getModifier(attributes[attr])
                return (
                  <button
                    key={`portatil-${attr}-${skill}-${idx}`}
                    onClick={() => {
                      const d20Roll = Math.floor(Math.random() * 20) + 1
                      const baseBonus = count === 1 ? 2 : 4
                      const modifierMultiplier = count === 1 ? 1 : 2
                      const modifierBonus = modifierMultiplier * modifier
                      const total = d20Roll + baseBonus + modifierBonus
                      const timestamp = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
                      const message = `🎲 ${skill} (${attrNames[attr]})\n1d20 = ${d20Roll} | ${baseBonus} + ${modifierMultiplier > 1 ? `${modifierMultiplier}x` : ''}Modificador(${modifier}) = ${modifierBonus}\nTotal: ${total}`
                      addChatMessage({ username: currentUser.username, text: message, timestamp, isDiceRoll: true, diceResult: message })
                    }}
                    className={`text-[10px] p-1.5 rounded ${darkMode ? 'bg-gray-800 hover:bg-gray-600 text-white' : 'bg-gray-100 hover:bg-gray-200 text-gray-800 border'}`}
                  >
                    {skill}{count > 1 && ` (x${count})`}
                  </button>
                )
              })
            })}
          </div>
        </div>
      )}
      {/* Rolagem Rápida */}
      <div className={`px-3 pt-2 pb-1 border-t ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
        <p className={`text-[10px] font-semibold mb-1.5 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Rolagem Rápida:</p>
        <div className="flex flex-wrap gap-1 mb-1.5">
          {[1,2,3,4,5,6,7,8,9,10].map(num => (
            <button key={num} onClick={() => setQuickRollNumDice(num)} className={`w-6 h-6 rounded text-xs font-bold transition-colors ${quickRollNumDice === num ? 'bg-blue-600 text-white' : darkMode ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>{num}</button>
          ))}
        </div>
        <div className="flex flex-wrap gap-1 mb-1.5">
          {['d4','d6','d8','d10','d12','d20'].map(dice => (
            <button key={dice} onClick={() => setQuickRollDiceType(dice)} className={`px-1.5 h-6 rounded text-[10px] font-bold transition-colors ${quickRollDiceType === dice ? 'bg-green-600 text-white' : darkMode ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>{dice}</button>
          ))}
        </div>
        <button
          onClick={() => {
            const diceNotation = `${quickRollNumDice}${quickRollDiceType}`
            const result = rollDiceExpression(diceNotation)
            if (result.error) { alert(result.error); return }
            const newMessage = {
              username: currentUser?.username || 'Anônimo',
              text: `🎲 Rolagem Rápida: ${diceNotation}`,
              timestamp: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
              isDiceRoll: true,
              diceResult: result.total,
              diceDetails: result.formula
            }
            setChatMessages(prev => [...prev, newMessage].slice(-10))
            if (useFirebase) {
              (async () => {
                const currentMessages = await loadChatMessages()
                await saveChatMessages([...(currentMessages || []), newMessage].slice(-10))
              })().catch(err => console.error('Erro ao salvar mensagem:', err))
            }
          }}
          className="w-full h-6 bg-purple-600 text-white rounded font-bold hover:bg-purple-700 transition-colors text-[10px]"
        >
          🎲 Rolar {quickRollNumDice}{quickRollDiceType}
        </button>
      </div>
      {/* Input de mensagem */}
      <div className="flex gap-2 p-3 pt-2">
        <input
          value={chatInput}
          onChange={e => setChatInput(e.target.value)}
          onKeyDown={e => { if (e.key === 'Enter' && chatInput.trim()) handleSendMessage() }}
          placeholder="Mensagem, 1d20+@MAE..."
          className={`flex-1 px-3 py-1.5 rounded-lg text-xs border ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'bg-white border-gray-300 text-gray-800'}`}
        />
        <button
          onClick={handleSendMessage}
          className="bg-blue-600 text-white px-3 py-1.5 rounded-lg text-xs hover:bg-blue-700 flex-shrink-0"
        >
          <Send size={14} />
        </button>
      </div>
    </div>
  ) : null

  const pokezapPanel = currentUser && showPokezapPanel ? (
    <div className="fixed right-0 top-0 h-full w-80 z-50 flex flex-col shadow-2xl" style={{ background: darkMode ? '#1f2937' : '#ffffff', borderLeft: darkMode ? '1px solid #374151' : '1px solid #e5e7eb' }}>
      {/* Header */}
      <div className={`flex items-center justify-between p-3 border-b ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
        <div className="flex items-center gap-2">
          <img src="/logopokezapcerto.png" alt="PokeZap" className="w-6 h-6 object-contain" />
          <span className={`font-bold text-sm ${darkMode ? 'text-white' : 'text-gray-800'}`}>PokeZap</span>
        </div>
        <button onClick={() => setShowPokezapPanel(false)} className={`p-1 rounded-lg text-sm font-bold ${darkMode ? 'hover:bg-gray-700 text-gray-400' : 'hover:bg-gray-100 text-gray-500'}`}>✕</button>
      </div>
      {/* Mensagens */}
      <div className="flex-1 overflow-y-auto p-3 flex flex-col gap-2">
        {pokezapVisibleMessages.length === 0 ? (
          <p className={`text-xs text-center mt-8 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>Nenhuma mensagem ainda...</p>
        ) : (
          pokezapVisibleMessages.map(msg => (
            <div key={msg.id} className={`flex flex-col ${msg.sender === currentUser.username ? 'items-end' : 'items-start'}`}>
              <div className={`px-3 py-2 rounded-2xl max-w-[85%] text-xs ${msg.sender === currentUser.username ? 'bg-green-500 text-white' : darkMode ? 'bg-gray-700 text-white' : 'bg-gray-100 text-gray-800'}`}>
                {msg.sender !== currentUser.username && <p className="font-bold text-[10px] mb-0.5 opacity-70">{msg.sender}</p>}
                <p>{msg.text}</p>
              </div>
              <span className={`text-[10px] mt-0.5 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>{msg.timestamp}</span>
            </div>
          ))
        )}
      </div>
      {/* Seletor de destinatários */}
      <div className="px-3 pt-2">
        <button
          onClick={() => setShowPokezapRecipientPicker(prev => !prev)}
          className={`text-xs px-3 py-1.5 rounded-lg mb-2 w-full text-left ${darkMode ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}
        >
          Enviar msg para... {pokezapRecipients.length > 0 ? `(${pokezapRecipients.length} selecionado${pokezapRecipients.length > 1 ? 's' : ''})` : ''}
        </button>
        {showPokezapRecipientPicker && (
          <div className={`mb-2 p-2 rounded-lg max-h-44 overflow-y-auto ${darkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
            <label className={`flex items-center gap-2 text-xs py-1 cursor-pointer mb-1 border-b ${darkMode ? 'border-gray-600' : 'border-gray-200'}`}>
              <input
                type="checkbox"
                checked={pokezapOtherUsers.length > 0 && pokezapRecipients.length === pokezapOtherUsers.length}
                onChange={e => setPokezapRecipients(e.target.checked ? pokezapOtherUsers.map(u => u.username) : [])}
                className="w-3 h-3"
              />
              <span className={`font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Todos</span>
            </label>
            {pokezapOtherUsers.map(u => (
              <label key={u.username} className="flex items-center gap-2 text-xs py-1 cursor-pointer">
                <input
                  type="checkbox"
                  checked={pokezapRecipients.includes(u.username)}
                  onChange={e => {
                    if (e.target.checked) setPokezapRecipients(prev => [...prev, u.username])
                    else setPokezapRecipients(prev => prev.filter(r => r !== u.username))
                  }}
                  className="w-3 h-3"
                />
                <span className={darkMode ? 'text-gray-300' : 'text-gray-700'}>{u.username}</span>
              </label>
            ))}
          </div>
        )}
      </div>
      {/* Input de mensagem */}
      <div className="flex gap-2 p-3 pt-0">
        <input
          value={pokezapInput}
          onChange={e => setPokezapInput(e.target.value)}
          onKeyDown={e => { if (e.key === 'Enter' && pokezapInput.trim()) handleSendPokezap() }}
          placeholder="Mensagem..."
          className={`flex-1 px-3 py-1.5 rounded-lg text-xs border ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'bg-white border-gray-300 text-gray-800'}`}
        />
        <button
          onClick={handleSendPokezap}
          className="bg-green-500 text-white px-3 py-1.5 rounded-lg text-xs hover:bg-green-600 flex-shrink-0"
        >
          <Send size={14} />
        </button>
      </div>
    </div>
  ) : null

  const pokeAgendaPanel = currentUser && showPokeAgendaPanel ? (
    <div className="fixed right-0 top-0 h-full w-80 z-50 flex flex-col shadow-2xl" style={{ background: darkMode ? '#1f2937' : '#ffffff', borderLeft: darkMode ? '1px solid #374151' : '1px solid #e5e7eb' }}>
      {/* Header */}
      <div className={`flex items-center justify-between p-3 border-b ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
        <div className="flex items-center gap-2">
          <img src="/minipokeanotacao.png" alt="Poke Agenda" className="w-6 h-6 object-contain" />
          <span className={`font-bold text-sm ${darkMode ? 'text-white' : 'text-gray-800'}`}>Poke Agenda</span>
        </div>
        <button onClick={() => setShowPokeAgendaPanel(false)} className={`p-1 rounded-lg text-sm font-bold ${darkMode ? 'hover:bg-gray-700 text-gray-400' : 'hover:bg-gray-100 text-gray-500'}`}>✕</button>
      </div>
      {/* Botão + Anotação */}
      <div className={`p-3 border-b ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
        <button
          onClick={() => { setEditingAnotacao(null); setAnotacaoForm({ titulo: '', descricao: '' }); setShowAddAnotacaoModal(true) }}
          className="w-full flex items-center justify-center gap-2 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-white text-sm font-semibold transition-colors"
        >
          <Plus size={15} /> Anotação
        </button>
      </div>
      {/* Lista de anotações */}
      <div className="flex-1 overflow-y-auto p-3 flex flex-col gap-2">
        {anotacoes.length === 0 ? (
          <p className={`text-xs text-center mt-8 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>Nenhuma anotação ainda...</p>
        ) : (
          anotacoes.map(a => (
            <div key={a.id} className={`rounded-xl border ${darkMode ? 'border-gray-700 bg-gray-900' : 'border-gray-200 bg-gray-50'}`}>
              {/* Título clicável */}
              <button
                onClick={() => setExpandedAnotacaoId(expandedAnotacaoId === a.id ? null : a.id)}
                className={`w-full flex items-center justify-between px-3 py-2.5 text-left gap-2`}
              >
                <span className={`font-semibold text-xs flex-1 truncate ${darkMode ? 'text-white' : 'text-gray-800'}`}>{a.titulo}</span>
                {expandedAnotacaoId === a.id ? <ChevronUp size={14} className={darkMode ? 'text-gray-400' : 'text-gray-500'} /> : <ChevronDown size={14} className={darkMode ? 'text-gray-400' : 'text-gray-500'} />}
              </button>
              {/* Conteúdo expandido */}
              {expandedAnotacaoId === a.id && (
                <div className={`px-3 pb-3 border-t ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
                  <p className={`text-xs mt-2 whitespace-pre-wrap ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>{a.descricao || <span className="italic opacity-50">Sem descrição.</span>}</p>
                  <div className="flex gap-1.5 mt-3">
                    <button
                      onClick={() => { setEditingAnotacao(a); setAnotacaoForm({ titulo: a.titulo, descricao: a.descricao }); setShowAddAnotacaoModal(true) }}
                      className="flex-1 flex items-center justify-center gap-1 py-1.5 rounded-lg bg-yellow-500 hover:bg-yellow-400 text-gray-900 text-xs font-semibold transition-colors"
                      title="Editar"
                    >
                      <Pencil size={12} /> Editar
                    </button>
                    <button
                      onClick={() => handleEnviarAnotacaoPokezap(a)}
                      className="flex-1 flex items-center justify-center gap-1 py-1.5 rounded-lg bg-green-600 hover:bg-green-500 text-white text-xs font-semibold transition-colors"
                      title="Enviar via Pokezap"
                    >
                      <Send size={12} /> Pokezap
                    </button>
                    <button
                      onClick={() => { handleDeleteAnotacao(a.id); if (expandedAnotacaoId === a.id) setExpandedAnotacaoId(null) }}
                      className="w-8 flex items-center justify-center py-1.5 rounded-lg bg-red-600 hover:bg-red-500 text-white transition-colors"
                      title="Excluir"
                    >
                      <X size={12} />
                    </button>
                  </div>
                </div>
              )}
            </div>
          ))
        )}
      </div>
      {/* Modal: Nova / Editar Anotação */}
      {showAddAnotacaoModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4" onClick={() => { setShowAddAnotacaoModal(false); setEditingAnotacao(null); setAnotacaoForm({ titulo: '', descricao: '' }) }}>
          <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-md w-full`} onClick={e => e.stopPropagation()}>
            <div className="p-5">
              <div className="flex justify-between items-center mb-4">
                <h3 className={`text-lg font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{editingAnotacao ? 'Editar Anotação' : 'Nova Anotação'}</h3>
                <button onClick={() => { setShowAddAnotacaoModal(false); setEditingAnotacao(null); setAnotacaoForm({ titulo: '', descricao: '' }) }} className={`${darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}`}><X size={20} /></button>
              </div>
              <div className="space-y-3">
                <input
                  type="text"
                  value={anotacaoForm.titulo}
                  onChange={e => setAnotacaoForm(prev => ({ ...prev, titulo: e.target.value }))}
                  placeholder="Título"
                  className={`w-full px-3 py-2 rounded-lg border text-sm ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'border-gray-300 bg-white'}`}
                />
                <textarea
                  value={anotacaoForm.descricao}
                  onChange={e => setAnotacaoForm(prev => ({ ...prev, descricao: e.target.value }))}
                  placeholder="Descrição"
                  rows={4}
                  className={`w-full px-3 py-2 rounded-lg border text-sm resize-none ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'border-gray-300 bg-white'}`}
                />
              </div>
              <div className="flex gap-3 mt-4">
                <button onClick={() => { setShowAddAnotacaoModal(false); setEditingAnotacao(null); setAnotacaoForm({ titulo: '', descricao: '' }) }} className={`flex-1 py-2.5 rounded-lg font-semibold text-sm ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}>Cancelar</button>
                <button onClick={handleSaveAnotacao} className="flex-1 py-2.5 rounded-lg font-semibold text-sm bg-blue-600 hover:bg-blue-500 text-white">Salvar</button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  ) : null

  // SIDEBAR DE NAVEGAÇÃO
  const mainBgClass = sessionBg ? 'bg-transparent' : (darkMode ? 'bg-gray-900' : 'bg-gradient-to-br from-blue-900 via-purple-900 to-red-900')
  const currentAreas = currentUser?.type === 'mestre' ? mestreAreas : treinadorAreas
  const LETTER_COLORS = {
    'A': { light: 'text-emerald-600', dark: 'text-emerald-400' },
    'B': { light: 'text-blue-600', dark: 'text-blue-400' },
    'C': { light: 'text-cyan-600', dark: 'text-cyan-400' },
    'E': { light: 'text-violet-600', dark: 'text-violet-400' },
    'G': { light: 'text-amber-600', dark: 'text-amber-400' },
    'H': { light: 'text-pink-600', dark: 'text-pink-400' },
    'I': { light: 'text-indigo-600', dark: 'text-indigo-400' },
    'M': { light: 'text-teal-600', dark: 'text-teal-400' },
    'N': { light: 'text-orange-600', dark: 'text-orange-400' },
    'P': { light: 'text-red-600', dark: 'text-red-400' },
    'S': { light: 'text-lime-600', dark: 'text-lime-400' },
    'T': { light: 'text-sky-600', dark: 'text-sky-400' },
    'V': { light: 'text-fuchsia-600', dark: 'text-fuchsia-400' },
    'X': { light: 'text-rose-600', dark: 'text-rose-400' },
  }
  const getAreaLetterColor = (area) => {
    const letter = area[0].normalize('NFD').replace(/[\u0300-\u036f]/g, '').toUpperCase()
    const colors = LETTER_COLORS[letter]
    return colors ? (darkMode ? colors.dark : colors.light) : (darkMode ? 'text-gray-300' : 'text-gray-700')
  }
  const sidebarNav = (
    <>
      {sidebarOpen && !sidebarPinned && <div className="fixed inset-0 bg-black/50 z-40" onClick={() => setSidebarOpen(false)} />}
      <div className={`fixed left-0 top-0 h-full z-50 w-64 transform transition-transform duration-300 ease-in-out ${sidebarOpen || sidebarPinned ? 'translate-x-0' : '-translate-x-full'} ${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-2xl flex flex-col`}>
        <div className={`flex items-center justify-between p-4 border-b ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
          <span className={`font-bold text-sm ${darkMode ? 'text-white' : 'text-gray-800'}`}>Áreas</span>
          <div className="flex items-center gap-1">
            <button onClick={() => { const next = !sidebarPinned; setSidebarPinned(next); localStorage.setItem('sidebarPinned', next) }} title={sidebarPinned ? 'Tornar colapsável' : 'Fixar menu'} className={`p-1 rounded-lg transition-colors ${sidebarPinned ? 'text-blue-500 bg-blue-100 dark:bg-blue-900/40' : darkMode ? 'hover:bg-gray-700 text-gray-400' : 'hover:bg-gray-200 text-gray-500'}`}><MapPin size={16} /></button>
            {!sidebarPinned && <button onClick={() => setSidebarOpen(false)} className={`p-1 rounded-lg ${darkMode ? 'hover:bg-gray-700 text-gray-400' : 'hover:bg-gray-200 text-gray-500'}`}><X size={20} /></button>}
          </div>
        </div>
        <div className="flex-1 overflow-y-auto p-3 flex flex-col gap-1.5">
          {currentAreas.map(area => (
            <button key={area} onClick={() => { setCurrentArea(area); if (!sidebarPinned) setSidebarOpen(false) }} className={`w-full text-left px-3 py-2 rounded-lg text-xs sm:text-sm font-semibold transition-colors ${area === currentArea ? 'bg-gradient-to-r from-blue-600 to-purple-700 text-white' : `${darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-100'} ${getAreaLetterColor(area)}`}`}>{area}</button>
          ))}
        </div>
      </div>
    </>
  )

  // TELA DE LOGIN
  if (!currentUser) {
    return (
      <div className={`min-h-screen ${mainBgClass} flex flex-col items-center justify-center p-4`}>
        <style>{`@keyframes gradient-shift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}.animated-gradient{background-size:300% 300%;animation:gradient-shift 4s ease infinite}`}</style>
        <div className="flex justify-center mb-4"><img src="/logo.png" alt="Logo" className="w-24 h-24 sm:w-32 sm:h-32 md:w-36 md:h-36 object-contain" /></div>
        <div className="rounded-2xl shadow-2xl relative overflow-hidden" style={{ width: '500px', height: '750px', maxWidth: '100%' }}>
          <img src="/pokesitebg1.png" alt="" className="absolute inset-0 w-full h-full object-cover rounded-2xl" />
          <div className="relative z-10 py-6 sm:py-8 md:py-12 px-3 sm:px-5 md:px-8">
          <div className="flex justify-end mb-4">
            <button onClick={() => setDarkMode(!darkMode)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-yellow-400' : 'bg-gray-200 text-gray-700'}`}>{darkMode ? <Sun size={20} /> : <Moon size={20} />}</button>
          </div>
          <div className="text-center mb-6">
            <h1 className="text-2xl sm:text-3xl font-bold text-gray-900 mb-2">Niaypeta Corp™</h1>
            <p className="text-gray-950 font-medium">O Professor Carvalho quer saber seu nome.</p>
          </div>
          <h2 className="text-center font-semibold text-gray-900 mb-3">Selecione o Usuário</h2>
          <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-6">
            {users.map(user => (
              <button key={user.username} onClick={() => { setSelectedUser(user); setError('') }} className={`animated-gradient p-3 rounded-lg text-white font-semibold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all flex items-center justify-center gap-2 opacity-80 ${selectedUser?.username === user.username ? 'ring-4 ring-blue-400 opacity-100' : ''}`} style={{ background: user.gradient }}>
                <User size={18} /><span className="text-base">{user.username}</span>
              </button>
            ))}
          </div>
          <div>
            <h2 className={`text-center font-semibold ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-3`}>Senha</h2>
            <div className="relative mb-4">
              <Lock className={`absolute left-3 top-1/2 transform -translate-y-1/2 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`} size={20} />
              <input type="password" value={password} onChange={e => setPassword(e.target.value)} onKeyPress={e => e.key === 'Enter' && selectedUser && password === 'DnD7MarPkm' && (setCurrentUser(selectedUser), setCurrentArea(selectedUser.type === 'treinador' ? 'Treinador' : ''), setSessionBg(BG_IMAGES[Math.floor(Math.random() * BG_IMAGES.length)]), setSelectedUser(null), setPassword(''))} placeholder="Digite a senha" disabled={!selectedUser} className={`w-full pl-12 pr-4 py-3 rounded-lg border-2 ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'bg-white border-gray-300 text-gray-800'} ${!selectedUser ? 'opacity-50 cursor-not-allowed' : ''}`} />
            </div>
            {error && <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4 text-center">{error}</div>}
            <button onClick={() => password === 'DnD7MarPkm' ? (setCurrentUser(selectedUser), setCurrentArea(selectedUser.type === 'treinador' ? 'Treinador' : ''), setSessionBg(BG_IMAGES[Math.floor(Math.random() * BG_IMAGES.length)]), setSelectedUser(null), setPassword('')) : setError('Senha incorreta!')} disabled={!selectedUser || !password} className="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 rounded-lg font-semibold hover:from-blue-600 hover:to-purple-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed">Entrar</button>
          </div>
          </div>
        </div>
      </div>
    )
  }

  // SELEÇÃO DE ÁREA (pula para treinadores)
  if (!currentArea && currentUser.type === 'mestre') {
    const areas = mestreAreas
    return (
      <>
        <div className={`min-h-screen ${mainBgClass}`}>
          {sidebarNav}
          <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-lg`}>
            <div className="max-w-7xl mx-auto px-4 py-4">
              <div className="flex justify-between items-center mb-4">
                <div className="flex items-center gap-3"><button onClick={() => setSidebarOpen(true)} className={`p-2 rounded-lg ${darkMode ? "hover:bg-gray-700 text-gray-400" : "hover:bg-gray-200 text-gray-500"}`}><Menu size={24} /></button><h2 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{currentUser.username} {currentUser.type === 'mestre' && '👑'}</h2></div>
                <div className="flex gap-2">
                  <button onClick={() => setShowAccountDataModal(true)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-200 text-gray-700'}`} title="Dados da Conta"><ArrowDownUp size={20} /></button>
                  <button onClick={() => setDarkMode(!darkMode)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-yellow-400' : 'bg-gray-200 text-gray-700'}`}>{darkMode ? <Sun size={20} /> : <Moon size={20} />}</button>
                  {pokezapBtn}{pokeAgendaBtn}{batalhaChatBtn}<button onClick={handleLogout} className="bg-red-500 text-white px-3 sm:px-5 md:px-6 py-2 rounded-lg hover:bg-red-600">Sair</button>
                </div>
              </div>
            </div>
          </div>
          <div className="max-w-7xl mx-auto px-4 py-3 sm:py-5 md:py-8">
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-8`}>
              <p className={`text-center text-lg ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>Selecione uma área no menu lateral</p>
            </div>
          </div>
        </div>
        {accountDataModal}
        {scenarioPopupOverlay}
        {mostrarTriunfosOverlay}
        {pokezapPanel}{pokeAgendaPanel}
        {batalhaChatPanel}
      </>
    )
  }

  // GERADOR POKÉMON (MESTRE)
  if (currentUser.type === 'mestre' && currentArea === 'Gerador Pokémon') {
    return (
      <>
        <div className={`min-h-screen ${mainBgClass}`}>
          {sidebarNav}
          <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-lg`}>
            <div className="max-w-7xl mx-auto px-4 py-4">
              <div className="flex justify-between items-center mb-4">
                <div className="flex items-center gap-3"><button onClick={() => setSidebarOpen(true)} className={`p-2 rounded-lg ${darkMode ? "hover:bg-gray-700 text-gray-400" : "hover:bg-gray-200 text-gray-500"}`}><Menu size={24} /></button><h2 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Gerador Pokémon 👑</h2></div>
                <div className="flex gap-2">
                  <button onClick={() => setShowAccountDataModal(true)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-200 text-gray-700'}`} title="Dados da Conta"><ArrowDownUp size={20} /></button>
                  <button onClick={() => setDarkMode(!darkMode)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-yellow-400' : 'bg-gray-200 text-gray-700'}`}>{darkMode ? <Sun size={20} /> : <Moon size={20} />}</button>
                  {pokezapBtn}{pokeAgendaBtn}{batalhaChatBtn}<button onClick={handleLogout} className="bg-red-500 text-white px-3 sm:px-5 md:px-6 py-2 rounded-lg hover:bg-red-600">Sair</button>
              </div>
            </div>
          </div>
        </div>
        
        <div className="max-w-7xl mx-auto px-4 py-3 sm:py-5 md:py-8">
          <iframe
            src="/Pokedéx_RPG.html"
            className="w-full rounded-2xl shadow-2xl border-0"
            style={{ height: 'calc(100vh - 200px)', minHeight: '800px' }}
            title="Gerador Pokémon"
          />

          {/* Lista de Pokémon gerados com botão para adicionar como NPC */}
          {npcPokemonList.length > 0 && (
            <div className={`mt-8 p-3 sm:p-5 md:p-6 rounded-2xl ${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-xl`}>
              <div className="flex justify-between items-center mb-4">
                <h3 className={`text-lg sm:text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  Pokémon Gerados Recentemente ({npcPokemonList.length})
                </h3>
                <button
                  onClick={() => {
                    if (confirm('Tem certeza que deseja limpar todos os Pokémon gerados recentemente?')) {
                      setNpcPokemonList([])
                    }
                  }}
                  className="flex items-center gap-2 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 font-semibold"
                  title="Limpar todos os Pokémon gerados"
                >
                  <Trash2 size={18} />
                  Limpar Todos
                </button>
              </div>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 sm:gap-3 md:gap-4">
                {npcPokemonList.map(pokemon => (
                  <div
                    key={pokemon.id}
                    className={`p-4 rounded-lg border-2 relative ${
                      pokemon.addedToNpc
                        ? darkMode ? 'bg-green-900/30 border-green-600' : 'bg-green-50 border-green-400'
                        : darkMode ? 'bg-gray-700 border-gray-600' : 'bg-gray-50 border-gray-300'
                    }`}
                  >
                    {/* Botão de exclusão */}
                    <button
                      onClick={() => removeFromGeneratedList(pokemon.id)}
                      className="absolute top-2 right-2 bg-red-500 text-white p-1.5 rounded-lg hover:bg-red-600 z-10"
                      title="Remover da lista"
                    >
                      <X size={16} />
                    </button>

                    {pokemon.imageUrl && (
                      <div className="flex justify-center mb-3">
                        <img
                          src={pokemon.imageUrl}
                          alt={pokemon.name || pokemon.species}
                          className="w-24 h-24 object-contain"
                        />
                      </div>
                    )}

                    <div className="flex justify-between items-start mb-2">
                      <div>
                        <h4 className={`font-bold text-lg ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                          {pokemon.species} {pokemon.shiny && '✨'} {pokemon.legendary && '👑'}
                        </h4>
                        <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                          Nível {pokemon.level} • {pokemon.gender}
                        </p>
                        <p className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>
                          {pokemon.weight ? `${pokemon.weight} kg` : 'N/A'} • {pokemon.height ? `${pokemon.height} m` : 'N/A'}
                        </p>
                      </div>
                      <div className="flex gap-1 mr-6">
                        {pokemon.types.map((type, idx) => (
                          <span
                            key={idx}
                            className={`text-xs px-2 py-1 rounded ${darkMode ? 'bg-gray-600 text-white' : 'bg-gray-200 text-gray-700'}`}
                          >
                            {type}
                          </span>
                        ))}
                      </div>
                    </div>

                    <div className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-2`}>
                      <span className="font-semibold">Espécie:</span> {pokemon.species}
                    </div>

                    <button
                      onClick={() => addToNpcList(pokemon.id)}
                      disabled={pokemon.addedToNpc}
                      className={`w-full mt-3 px-4 py-2 rounded-lg font-semibold ${
                        pokemon.addedToNpc
                          ? darkMode ? 'bg-gray-600 text-gray-400 cursor-not-allowed' : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                          : 'bg-gradient-to-r from-blue-600 to-purple-700 text-white hover:from-blue-700 hover:to-purple-800'
                      }`}
                    >
                      {pokemon.addedToNpc ? '✓ Adicionado aos NPCs' : 'Pokémon NPC'}
                    </button>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
        </div>
        {accountDataModal}
        {scenarioPopupOverlay}
        {mostrarTriunfosOverlay}
        {pokezapPanel}{pokeAgendaPanel}
        {batalhaChatPanel}
      </>
    )
  }

  // ÁREA CLIMA
  if (currentUser.type === 'mestre' && currentArea === 'Clima') {
    return (
      <>
        <div className={`min-h-screen ${mainBgClass}`}>
          {sidebarNav}
          <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-lg`}>
            <div className="max-w-7xl mx-auto px-4 py-4">
              <div className="flex justify-between items-center mb-4">
                <div className="flex items-center gap-3"><button onClick={() => setSidebarOpen(true)} className={`p-2 rounded-lg ${darkMode ? "hover:bg-gray-700 text-gray-400" : "hover:bg-gray-200 text-gray-500"}`}><Menu size={24} /></button><h2 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Clima</h2></div>
                <div className="flex gap-2">
                  <button onClick={() => setShowAccountDataModal(true)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-200 text-gray-700'}`} title="Dados da Conta"><ArrowDownUp size={20} /></button>
                  <button onClick={() => setDarkMode(!darkMode)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-yellow-400' : 'bg-gray-200 text-gray-700'}`}>{darkMode ? <Sun size={20} /> : <Moon size={20} />}</button>
                  {pokezapBtn}{pokeAgendaBtn}{batalhaChatBtn}<button onClick={handleLogout} className="bg-red-500 text-white px-3 sm:px-5 md:px-6 py-2 rounded-lg hover:bg-red-600">Sair</button>
                </div>
              </div>
            </div>
          </div>

          <div className="max-w-7xl mx-auto px-4 py-3 sm:py-5 md:py-8">
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-8`}>
              <h3 className={`text-lg sm:text-xl font-bold mb-6 ${darkMode ? 'text-white' : 'text-gray-800'}`}>Previsao do Tempo</h3>

              {currentClima && (
                <div className="flex flex-col items-center mb-8">
                  <img src={`/pokeballs/${currentClima.image}`} alt={currentClima.name} className="w-32 h-32 mb-3" />
                  <span className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{currentClima.name}</span>
                </div>
              )}

              {!currentClima && (
                <div className={`text-center mb-8 py-3 sm:py-5 md:py-8 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                  <p className="text-lg">Nenhum clima definido. Clique no botao abaixo para sortear.</p>
                </div>
              )}

              <div className="flex flex-col items-center gap-2 sm:gap-3 md:gap-4">
                <button
                  onClick={handlePrevisaoDoTempo}
                  className="bg-gradient-to-r from-blue-600 to-cyan-600 text-white px-4 sm:px-3 sm:px-5 md:px-6 md:px-8 py-4 rounded-lg hover:from-blue-700 hover:to-cyan-700 font-semibold text-lg shadow-lg"
                >
                  Previsao do Tempo
                </button>

                {currentClima && (
                  <button
                    onClick={async () => {
                      setCurrentClima(null)
                      if (useFirebase) { await saveToFirebase('clima', null) }
                    }}
                    className="bg-gradient-to-r from-red-500 to-red-600 text-white px-3 sm:px-5 md:px-6 py-3 rounded-lg hover:from-red-600 hover:to-red-700 font-semibold shadow-lg"
                  >
                    Limpar Clima
                  </button>
                )}

                <label className={`flex items-center gap-2 mt-4 cursor-pointer ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                  <input
                    type="checkbox"
                    checked={desertoMode}
                    onChange={(e) => handleToggleDesertoMode(e.target.checked)}
                    className="w-5 h-5 rounded border-gray-400 text-yellow-600 focus:ring-yellow-500"
                  />
                  <span className="font-semibold">Deserto</span>
                  <span className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>(habilita Tempestade de Areia, desabilita Neve e Granizo)</span>
                </label>
              </div>
            </div>
          </div>
        </div>
        {accountDataModal}
        {scenarioPopupOverlay}
        {mostrarTriunfosOverlay}
        {pokezapPanel}{pokeAgendaPanel}
        {batalhaChatPanel}
      </>
    )
  }

  // ÁREA HUB DE TROCA M
  if (currentUser.type === 'mestre' && currentArea === 'Hub de Troca M') {
    return (
      <>
        <div className={`min-h-screen ${mainBgClass}`}>
          {sidebarNav}
        <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-lg`}>
          <div className="max-w-7xl mx-auto px-4 py-4">
            <div className="flex justify-between items-center mb-4">
              <div className="flex items-center gap-3"><button onClick={() => setSidebarOpen(true)} className={`p-2 rounded-lg ${darkMode ? "hover:bg-gray-700 text-gray-400" : "hover:bg-gray-200 text-gray-500"}`}><Menu size={24} /></button><h2 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Hub de Troca M 👑</h2></div>
              <div className="flex gap-2">
                <button onClick={() => setShowAccountDataModal(true)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-200 text-gray-700'}`} title="Dados da Conta"><ArrowDownUp size={20} /></button>
                <button onClick={() => setDarkMode(!darkMode)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-yellow-400' : 'bg-gray-200 text-gray-700'}`}>{darkMode ? <Sun size={20} /> : <Moon size={20} />}</button>
                {pokezapBtn}{pokeAgendaBtn}{batalhaChatBtn}<button onClick={handleLogout} className="bg-red-500 text-white px-3 sm:px-5 md:px-6 py-2 rounded-lg hover:bg-red-600">Sair</button>
              </div>
            </div>
          </div>
        </div>

        <div className="max-w-7xl mx-auto px-4 py-3 sm:py-5 md:py-8">
          <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-8 mb-6`}>
            <div className="flex flex-wrap gap-2 mb-6">
              <button
                onClick={() => generateTradeOffers()}
                className="bg-gradient-to-r from-blue-600 to-purple-700 text-white px-3 py-2 rounded-lg hover:from-blue-700 hover:to-purple-800 font-semibold text-xs sm:text-sm"
              >
                Ofertas de Troca
              </button>
              <button
                onClick={() => {
                  setTradeHubOffers([])
                  setTradeHubCompletedTrades({})
                  setExpandedTradeCards({})
                  setTradeHubAlfaStatus({})
                  setTradeHubConditions({})
                }}
                className="bg-gradient-to-r from-red-600 to-pink-700 text-white px-3 py-2 rounded-lg hover:from-red-700 hover:to-pink-800 font-semibold text-xs sm:text-sm"
              >
                Limpar Ofertas
              </button>
              <button
                onClick={() => setShowTradeRegioesModal(true)}
                className={`px-3 py-2 rounded-lg font-semibold text-xs sm:text-sm border-2 ${
                  tradeHubRegioesOferecidos.length === ALL_TRADE_REGIOES.length && tradeHubRegioesExigidos.length === ALL_TRADE_REGIOES.length
                    ? darkMode ? 'bg-gray-700 border-gray-500 text-gray-200' : 'bg-gray-100 border-gray-400 text-gray-700'
                    : 'bg-gradient-to-r from-green-600 to-teal-600 border-transparent text-white'
                }`}
              >
                Regiões {(tradeHubRegioesOferecidos.length < ALL_TRADE_REGIOES.length || tradeHubRegioesExigidos.length < ALL_TRADE_REGIOES.length) ? `(O:${tradeHubRegioesOferecidos.length} E:${tradeHubRegioesExigidos.length})` : ''}
              </button>
            </div>

            {/* Modal de Regiões */}
            {showTradeRegioesModal && (
              <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
                <div className={`${darkMode ? 'bg-gray-800 text-white' : 'bg-white text-gray-800'} rounded-2xl shadow-2xl p-6 w-full max-w-lg`}>
                  <h3 className="text-lg font-bold mb-4 text-center">Filtro de Regiões</h3>
                  <div className="grid grid-cols-2 gap-4 mb-5">
                    {/* Coluna Esquerda — Oferecidos */}
                    <div>
                      <p className="font-bold text-sm mb-2 text-blue-500">Pokémon Oferecido</p>
                      <label className="flex items-center gap-2 mb-2 cursor-pointer font-semibold text-sm">
                        <input
                          type="checkbox"
                          checked={tradeHubRegioesOferecidos.length === ALL_TRADE_REGIOES.length}
                          onChange={(e) => setTradeHubRegioesOferecidos(e.target.checked ? [...ALL_TRADE_REGIOES] : [])}
                          className="w-4 h-4 accent-blue-500"
                        />
                        Marcar Todas
                      </label>
                      <div className="border-t border-gray-400 mb-2" />
                      <div className="flex flex-col gap-1.5">
                        {ALL_TRADE_REGIOES.map(regiao => (
                          <label key={regiao} className="flex items-center gap-2 cursor-pointer text-sm">
                            <input
                              type="checkbox"
                              checked={tradeHubRegioesOferecidos.includes(regiao)}
                              onChange={(e) => setTradeHubRegioesOferecidos(prev =>
                                e.target.checked ? [...prev, regiao] : prev.filter(r => r !== regiao)
                              )}
                              className="w-4 h-4 accent-blue-500"
                            />
                            {regiao}
                          </label>
                        ))}
                      </div>
                    </div>
                    {/* Coluna Direita — Exigidos */}
                    <div>
                      <p className="font-bold text-sm mb-2 text-orange-500">Pokémon Exigido</p>
                      <label className="flex items-center gap-2 mb-2 cursor-pointer font-semibold text-sm">
                        <input
                          type="checkbox"
                          checked={tradeHubRegioesExigidos.length === ALL_TRADE_REGIOES.length}
                          onChange={(e) => setTradeHubRegioesExigidos(e.target.checked ? [...ALL_TRADE_REGIOES] : [])}
                          className="w-4 h-4 accent-orange-500"
                        />
                        Marcar Todas
                      </label>
                      <div className="border-t border-gray-400 mb-2" />
                      <div className="flex flex-col gap-1.5">
                        {ALL_TRADE_REGIOES.map(regiao => (
                          <label key={regiao} className="flex items-center gap-2 cursor-pointer text-sm">
                            <input
                              type="checkbox"
                              checked={tradeHubRegioesExigidos.includes(regiao)}
                              onChange={(e) => setTradeHubRegioesExigidos(prev =>
                                e.target.checked ? [...prev, regiao] : prev.filter(r => r !== regiao)
                              )}
                              className="w-4 h-4 accent-orange-500"
                            />
                            {regiao}
                          </label>
                        ))}
                      </div>
                    </div>
                  </div>
                  <button
                    onClick={() => setShowTradeRegioesModal(false)}
                    className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg"
                  >
                    Confirmar
                  </button>
                </div>
              </div>
            )}

            {tradeHubOffers.length === 0 ? (
              <div className="text-center py-8">
                <p className={`text-lg ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                  Nenhuma oferta de troca disponível. Clique em "Ofertas de Troca" para gerar.
                </p>
              </div>
            ) : (
              <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4">
                {tradeHubOffers.map(trade => {
                  const pokemon = trade.offeredPokemon
                  const isExpanded = expandedTradeCards[trade.id] || false
                  const isCompleted = tradeHubCompletedTrades[trade.id]

                  return (
                    <div
                      key={trade.id}
                      className={`${darkMode ? 'bg-gray-700' : 'bg-gray-50'} rounded-2xl shadow-lg overflow-hidden transition-all ${
                        isExpanded ? 'sm:col-span-2 lg:col-span-2' : ''
                      }`}
                    >
                      {/* Pokemon NPC Card */}
                      {!isExpanded ? (
                        /* Card compacto */
                        <div className="relative group">
                          <div
                            onClick={() => setExpandedTradeCards(prev => ({ ...prev, [trade.id]: true }))}
                            className="cursor-pointer p-3 sm:p-4 flex flex-col items-center"
                          >
                            {pokemon.imageUrl && (
                              <img
                                src={pokemon.imageUrl}
                                alt={pokemon.name || pokemon.species}
                                className="w-20 h-20 sm:w-24 sm:h-24 md:w-28 md:h-28 object-contain mb-2"
                              />
                            )}
                            <p className={`text-sm font-bold text-center ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                              {pokemon.species || pokemon.name || 'Pokemon'} {pokemon.shiny && '✨'} {pokemon.legendary && '👑'}
                            </p>
                            <div className="flex items-center gap-1 mt-1">
                              <p className={`text-xs text-center ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                Nivel {pokemon.level}
                              </p>
                              {(pokemon.habilidade1 || pokemon.habilidade2) && (
                                <div className="flex gap-1">
                                  {pokemon.habilidade1 && (
                                    <span className={`px-1.5 py-0.5 rounded text-[10px] font-semibold ${darkMode ? 'bg-blue-900 text-blue-300' : 'bg-blue-500 text-white'}`}>
                                      {pokemon.habilidade1}
                                    </span>
                                  )}
                                  {pokemon.habilidade2 && (
                                    <span className={`px-1.5 py-0.5 rounded text-[10px] font-semibold ${darkMode ? 'bg-purple-900 text-purple-300' : 'bg-purple-500 text-white'}`}>
                                      {pokemon.habilidade2}
                                    </span>
                                  )}
                                </div>
                              )}
                            </div>
                          </div>
                          <div className="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button
                              onClick={(e) => {
                                e.stopPropagation()
                                sendNpcPokemonToBattle(pokemon)
                              }}
                              className="bg-cyan-500 text-white p-1.5 rounded-lg hover:bg-cyan-600"
                              title="Enviar para Batalha"
                            >
                              <ArrowRightCircle size={14} />
                            </button>
                            <button
                              onClick={(e) => { e.stopPropagation(); resorteioTradeCard(trade.id) }}
                              className="bg-purple-500 text-white p-1.5 rounded-lg hover:bg-purple-600"
                              title="Sortear Novamente"
                            >
                              <Shuffle size={14} />
                            </button>
                          </div>
                        </div>
                      ) : (
                        /* Card expandido */
                        <div className="p-3 sm:p-4">
                          {/* Variavel de bonus Alfa */}
                          {(() => { pokemon._alfaBonus = tradeHubAlfaStatus[pokemon.id] ? 3 : 0; return null })()}
                          <div className="flex justify-between items-start mb-3">
                            <div
                              onClick={() => setExpandedTradeCards(prev => ({ ...prev, [trade.id]: false }))}
                              className="cursor-pointer flex-1"
                            >
                              {pokemon.imageUrl && (
                                <div className="flex justify-center mb-2">
                                  <img
                                    src={pokemon.imageUrl}
                                    alt={pokemon.name || pokemon.species}
                                    className="w-20 h-20 object-contain"
                                  />
                                </div>
                              )}
                              <div className="text-center mb-2">
                                <p className={`text-sm font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                  {pokemon.species || pokemon.name} {pokemon.shiny && '✨'} {pokemon.legendary && '👑'}
                                </p>
                                <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                  #{String(pokemon.dexNumber).padStart(4, '0')} • Nivel {pokemon.level}
                                </p>
                              </div>
                            </div>
                            <div className="flex gap-2">
                              <button
                                onClick={() => sendNpcPokemonToBattle(pokemon)}
                                className="bg-cyan-500 text-white p-1.5 rounded-lg hover:bg-cyan-600"
                                title="Enviar para Batalha"
                              >
                                <ArrowRightCircle size={14} />
                              </button>
                              <button
                                onClick={() => resorteioTradeCard(trade.id)}
                                className="bg-purple-500 text-white p-1.5 rounded-lg hover:bg-purple-600"
                                title="Sortear Novamente"
                              >
                                <Shuffle size={14} />
                              </button>
                            </div>
                          </div>

                          {/* Checkbox Alfa */}
                          <div className="mb-2">
                            <label className={`flex items-center gap-2 cursor-pointer p-2 rounded-lg border-2 transition-all ${
                              tradeHubAlfaStatus[pokemon.id]
                                ? 'border-red-500 bg-gradient-to-r from-gray-300 to-white dark:from-gray-600 dark:to-gray-400'
                                : darkMode ? 'border-gray-600 bg-gray-700' : 'border-gray-300 bg-gray-50'
                            }`}>
                              <input
                                type="checkbox"
                                checked={tradeHubAlfaStatus[pokemon.id] || false}
                                onChange={() => setTradeHubAlfaStatus(prev => ({
                                  ...prev,
                                  [pokemon.id]: !prev[pokemon.id]
                                }))}
                                className="w-4 h-4 accent-red-500"
                              />
                              <span className={`text-sm font-bold ${tradeHubAlfaStatus[pokemon.id] ? 'text-red-600' : darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                Alfa
                              </span>
                              {tradeHubAlfaStatus[pokemon.id] && (
                                <span className="text-xs text-red-500 ml-auto font-semibold">ATR +3 | Captura -10 | XP x2</span>
                              )}
                            </label>
                          </div>

                          {/* Condicoes de Captura */}
                          <div className="mb-2">
                            <h4 className={`text-xs font-semibold mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Condicoes</h4>
                            <div className="grid grid-cols-3 gap-1">
                              {[
                                { key: 'confusao', icon: BadgeHelp, color: 'text-purple-400', label: 'Confusao' },
                                { key: 'critico', icon: Clover, color: 'text-green-600', label: 'Critico' },
                                { key: 'paralisia', icon: Zap, color: 'text-yellow-500', label: 'Paralisia' },
                                { key: 'sono', icon: Moon, color: 'text-blue-500', label: 'Sono' },
                                { key: 'atordoamento', icon: Shell, color: 'text-gray-500', label: 'Atordoamento' },
                                { key: 'congelamento', icon: Snowflake, color: 'text-blue-400', label: 'Congelamento' },
                                { key: 'paixao', icon: Heart, color: 'text-red-500', label: 'Paixao' },
                                { key: 'queimadura', icon: Flame, color: 'text-orange-500', label: 'Queimadura' },
                                { key: 'veneno', icon: Droplet, color: 'text-purple-600', label: 'Veneno' }
                              ].map(condition => {
                                const Icon = condition.icon
                                const isChecked = tradeHubConditions[pokemon.id]?.[condition.key] || false
                                return (
                                  <label key={condition.key} className="flex items-center gap-1 cursor-pointer">
                                    <input
                                      type="checkbox"
                                      checked={isChecked}
                                      onChange={() => setTradeHubConditions(prev => ({...prev, [pokemon.id]: {...(prev[pokemon.id] || {}), [condition.key]: !(prev[pokemon.id]?.[condition.key])}}))}
                                      className="w-3 h-3"
                                    />
                                    <Icon size={14} className={condition.color} title={condition.label} />
                                  </label>
                                )
                              })}
                            </div>
                          </div>

                          {/* Tipos e Valor de Captura */}
                          <div className="mb-2">
                            <h4 className={`text-xs font-semibold mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Tipos & Habilidades</h4>
                            <div className="flex items-center justify-between mb-2">
                              <div className="flex gap-1 flex-wrap">
                                {pokemon.types.map((type, idx) => (
                                  <span key={idx} className="px-2 py-0.5 text-xs rounded-lg bg-gradient-to-r from-blue-600 to-purple-700 text-white font-semibold">
                                    {type}
                                  </span>
                                ))}
                                {pokemon.habilidade1 && (
                                  <span
                                    onClick={() => {
                                      setSelectedAbility(pokemon.habilidade1)
                                      setShowAbilityModal(true)
                                    }}
                                    className={`px-2 py-0.5 text-xs rounded-lg font-semibold cursor-pointer hover:opacity-80 transition-opacity ${darkMode ? 'bg-blue-900 text-blue-300' : 'bg-blue-500 text-white'}`}>
                                    {pokemon.habilidade1}
                                  </span>
                                )}
                                {pokemon.habilidade2 && (
                                  <span
                                    onClick={() => {
                                      setSelectedAbility(pokemon.habilidade2)
                                      setShowAbilityModal(true)
                                    }}
                                    className={`px-2 py-0.5 text-xs rounded-lg font-semibold cursor-pointer hover:opacity-80 transition-opacity ${darkMode ? 'bg-purple-900 text-purple-300' : 'bg-purple-500 text-white'}`}>
                                    {pokemon.habilidade2}
                                  </span>
                                )}
                              </div>
                            </div>
                            <div className="flex justify-end">
                              <div className={`px-3 py-1 rounded-lg font-bold text-sm ${
                                pokemon.catchRate >= 0
                                  ? 'bg-green-600 text-white'
                                  : 'bg-red-600 text-white'
                              }`}>
                                Captura: {pokemon.catchRate >= 0 ? '+' : ''}{pokemon.catchRate}
                              </div>
                            </div>
                          </div>

                          {/* HP e Evasoes */}
                          <div className={`mb-2 p-2 sm:p-3 rounded-lg ${darkMode ? 'bg-gray-600' : 'bg-gray-100'}`}>
                            <div className="flex flex-col xs:flex-row items-start xs:items-center justify-between gap-2 mb-2">
                              <div className="flex-1">
                                <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>HP</p>
                                <p className={`text-sm font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                  {pokemon.currentHP !== undefined ? pokemon.currentHP : ((3 * (pokemon.attributes.saude + pokemon._alfaBonus)) + pokemon.level)} / {(3 * (pokemon.attributes.saude + pokemon._alfaBonus)) + pokemon.level}
                                </p>
                              </div>
                              <button
                                onClick={() => {
                                  setSelectedNpcPokemon(pokemon)
                                  setShowNpcDamageModal(true)
                                }}
                                className="flex items-center gap-1 bg-gradient-to-r from-red-600 to-pink-600 text-white px-2 sm:px-3 py-1.5 rounded-lg hover:from-red-700 hover:to-pink-700 font-semibold text-xs whitespace-nowrap"
                                title="Dano/Cura PkmNpc"
                              >
                                <Sword size={12} />
                                <Heart size={12} />
                              </button>
                            </div>

                            <div className="grid grid-cols-3 gap-2">
                              <div>
                                <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Ev. Fisica</p>
                                <p className={`text-xs font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                  {Math.floor((pokemon.attributes.defesa + pokemon._alfaBonus) / 5)}
                                </p>
                              </div>
                              <div>
                                <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Ev. Especial</p>
                                <p className={`text-xs font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                  {Math.floor((pokemon.attributes.defesaEspecial + pokemon._alfaBonus) / 5)}
                                </p>
                              </div>
                              <div>
                                <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Ev. Veloz</p>
                                <p className={`text-xs font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                  {Math.floor((pokemon.attributes.velocidade + pokemon._alfaBonus) / 10)}
                                </p>
                              </div>
                            </div>
                          </div>

                          {/* Informacoes Basicas */}
                          <div className={`grid grid-cols-2 gap-2 mb-2 p-2 sm:p-3 rounded-lg ${darkMode ? 'bg-gray-600' : 'bg-gray-100'}`}>
                            <div>
                              <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Especie</p>
                              <p className={`text-xs font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{pokemon.species || pokemon.name}</p>
                            </div>
                            <div>
                              <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Catch Rate</p>
                              <p className={`text-xs font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{pokemon.catchRate}</p>
                            </div>
                            <div>
                              <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Experiencia</p>
                              <p className={`text-xs font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{pokemon.experience} XP</p>
                            </div>
                            <div>
                              <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Genero</p>
                              <p className={`text-xs font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{pokemon.gender}</p>
                            </div>
                            <div>
                              <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Peso</p>
                              <p className={`text-xs font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{pokemon.weight ? `${pokemon.weight} kg` : 'N/A'}</p>
                            </div>
                            <div>
                              <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Altura</p>
                              <p className={`text-xs font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{pokemon.height ? `${pokemon.height} m` : 'N/A'}</p>
                            </div>
                          </div>

                          {/* Natureza */}
                          <div className="mb-2">
                            <h4 className={`text-xs font-semibold mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Natureza</h4>
                            <p className={`text-xs ${darkMode ? 'text-gray-300' : 'text-gray-800'}`}>
                              {pokemon.nature.nome} <span className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-600'}`}>
                                ({pokemon.nature.up && `↑${pokemon.nature.up}`} {pokemon.nature.down && `↓${pokemon.nature.down}`})
                              </span>
                            </p>
                          </div>

                          {/* Atributos */}
                          <div>
                            <h4 className={`text-xs font-semibold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Atributos</h4>
                            <div className="space-y-1">
                              {[
                                { label: 'Saude', key: 'saude' },
                                { label: 'Ataque', key: 'ataque' },
                                { label: 'Defesa', key: 'defesa' },
                                { label: 'Ataque Especial', key: 'ataqueEspecial' },
                                { label: 'Defesa Especial', key: 'defesaEspecial' },
                                { label: 'Velocidade', key: 'velocidade' }
                              ].map(attr => {
                                const isIncreased = pokemon.nature.up === attr.label
                                const isDecreased = pokemon.nature.down === attr.label
                                return (
                                  <div key={attr.key} className={`flex justify-between items-center p-1 rounded text-xs ${
                                    isIncreased ? (darkMode ? 'bg-green-900/30' : 'bg-green-50') :
                                    isDecreased ? (darkMode ? 'bg-red-900/30' : 'bg-red-50') :
                                    (darkMode ? 'bg-gray-600' : 'bg-gray-100')
                                  }`}>
                                    <span className={`${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                      {attr.label} {isIncreased && '↑'} {isDecreased && '↓'}
                                    </span>
                                    <div className="flex gap-2">
                                      <span className={`${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>
                                        Base: {pokemon.baseAttributes[attr.key]}
                                      </span>
                                      <span className={`font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                        Total: {pokemon.attributes[attr.key] + pokemon._alfaBonus}
                                        {pokemon._alfaBonus > 0 && <span className="text-red-500 ml-1">(+{pokemon._alfaBonus})</span>}
                                      </span>
                                    </div>
                                  </div>
                                )
                              })}
                            </div>
                          </div>

                          {/* Golpes */}
                          {pokemon.golpesAprendidos && pokemon.golpesAprendidos.length > 0 && (
                            <div className="mt-2">
                              <h4 className={`text-xs font-semibold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Golpes</h4>
                              <div className="flex flex-wrap gap-1">
                                {pokemon.golpesAprendidos.map((golpe, idx) => (
                                  <span
                                    key={idx}
                                    onClick={() => {
                                      setSelectedGolpeForDetail(golpe)
                                      setShowGolpeDetailModal(true)
                                    }}
                                    className={`px-2 py-1 text-xs rounded-lg font-medium cursor-pointer hover:opacity-80 transition-opacity ${
                                      darkMode ? 'bg-indigo-900 text-indigo-300' : 'bg-indigo-500 text-white'
                                    }`}
                                    title="Clique para ver detalhes"
                                  >
                                    {golpe}
                                  </span>
                                ))}
                              </div>
                            </div>
                          )}

                          {/* Informacoes Adicionais */}
                          {(pokemon.migration || pokemon.habitats?.length > 0) && (
                            <div className={`mt-2 pt-2 border-t ${darkMode ? 'border-gray-600' : 'border-gray-200'}`}>
                              {pokemon.migration && (
                                <p className={`text-xs ${darkMode ? 'text-purple-400' : 'text-purple-700'} mb-1`}>
                                  🌍 Migracao de {pokemon.migrationRegion}
                                </p>
                              )}
                              {pokemon.habitats?.length > 0 && (
                                <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                  Habitats: {pokemon.habitats.join(', ')}
                                </p>
                              )}
                            </div>
                          )}
                        </div>
                      )}

                      {/* Separador - Troca por */}
                      <div className={`flex items-center justify-center py-2 px-3 ${darkMode ? 'bg-gray-600' : 'bg-gray-200'}`}>
                        <span className={`text-xs font-bold ${darkMode ? 'text-yellow-400' : 'text-yellow-700'}`}>⇅ troca por ⇅</span>
                      </div>

                      {/* Pokemon Requerido */}
                      <div className="p-3 flex flex-col items-center">
                        <img
                          src={trade.requiredImageUrl}
                          alt={trade.requiredSpecies}
                          className="w-16 h-16 sm:w-20 sm:h-20 object-contain mb-1"
                        />
                        <p className={`text-sm font-bold text-center ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                          {trade.requiredSpecies}
                        </p>
                        <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                          #{String(trade.requiredDexNumber).padStart(4, '0')}
                        </p>
                      </div>

                      {/* Status da Troca */}
                      {isCompleted && (
                        <div className={`px-3 pb-3`}>
                          <div className="bg-green-600 text-white text-xs font-bold text-center py-2 rounded-lg">
                            Troca ja feita. ({isCompleted})
                          </div>
                        </div>
                      )}
                    </div>
                  )
                })}
              </div>
            )}
          </div>
        </div>
        </div>
        {accountDataModal}
        {scenarioPopupOverlay}
        {mostrarTriunfosOverlay}
        {pokezapPanel}{pokeAgendaPanel}
        {batalhaChatPanel}
      </>
    )
  }

  // ÁREA TREINADOR NPC
  if (currentUser.type === 'mestre' && currentArea === 'Treinador NPC') {
    if (!spoilerMestreConfirmado) return (
      <>
        <div className={`min-h-screen ${mainBgClass}`}>
          {sidebarNav}
          <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-lg`}>
            <div className="max-w-7xl mx-auto px-4 py-4">
              <div className="flex justify-between items-center mb-4">
                <div className="flex items-center gap-3"><button onClick={() => setSidebarOpen(true)} className={`p-2 rounded-lg ${darkMode ? "hover:bg-gray-700 text-gray-400" : "hover:bg-gray-200 text-gray-500"}`}><Menu size={24} /></button><h2 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Treinador NPC 👑</h2></div>
                <div className="flex gap-2">
                  <button onClick={() => setShowAccountDataModal(true)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-200 text-gray-700'}`} title="Dados da Conta"><ArrowDownUp size={20} /></button>
                  <button onClick={() => setDarkMode(!darkMode)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-yellow-400' : 'bg-gray-200 text-gray-700'}`}>{darkMode ? <Sun size={20} /> : <Moon size={20} />}</button>
                  {pokezapBtn}{pokeAgendaBtn}{batalhaChatBtn}<button onClick={handleLogout} className="bg-red-500 text-white px-3 sm:px-5 md:px-6 py-2 rounded-lg hover:bg-red-600">Sair</button>
                </div>
              </div>
            </div>
          </div>
          <div className="max-w-7xl mx-auto px-4 py-3 sm:py-5 md:py-8 flex flex-col items-center justify-center min-h-[60vh] text-center gap-6">
            <div className="text-6xl">⚠️</div>
            <h2 className={`text-3xl font-bold ${darkMode ? 'text-yellow-400' : 'text-yellow-600'}`}>Alerta de Spoiler</h2>
            <p className={`text-base max-w-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
              Esta área contém informações confidenciais do Arco. Prossiga apenas se tiver certeza.
            </p>
            <button
              onClick={() => setSpoilerMestreConfirmado(true)}
              className="bg-yellow-500 hover:bg-yellow-600 text-black font-bold px-8 py-3 rounded-xl text-lg transition-colors"
            >
              Sou o mestre do Arco.
            </button>
          </div>
        </div>
      </>
    )
    return (
      <>
        <div className={`min-h-screen ${mainBgClass}`}>
          {sidebarNav}
        <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-lg`}>
          <div className="max-w-7xl mx-auto px-4 py-4">
            <div className="flex justify-between items-center mb-4">
              <div className="flex items-center gap-3"><button onClick={() => setSidebarOpen(true)} className={`p-2 rounded-lg ${darkMode ? "hover:bg-gray-700 text-gray-400" : "hover:bg-gray-200 text-gray-500"}`}><Menu size={24} /></button><h2 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Treinador NPC 👑</h2></div>
              <div className="flex gap-2">
                <button onClick={() => setShowAccountDataModal(true)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-200 text-gray-700'}`} title="Dados da Conta"><ArrowDownUp size={20} /></button>
                <button onClick={() => setDarkMode(!darkMode)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-yellow-400' : 'bg-gray-200 text-gray-700'}`}>{darkMode ? <Sun size={20} /> : <Moon size={20} />}</button>
                {pokezapBtn}{pokeAgendaBtn}{batalhaChatBtn}<button onClick={handleLogout} className="bg-red-500 text-white px-3 sm:px-5 md:px-6 py-2 rounded-lg hover:bg-red-600">Sair</button>
              </div>
            </div>
          </div>
        </div>

        <div className="max-w-7xl mx-auto px-4 py-3 sm:py-5 md:py-8">
          <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-8 mb-6`}>
            <div className="flex flex-col sm:flex-row gap-2 sm:gap-3 md:gap-4 mb-6">
              <button
                onClick={() => setShowCustomTrainerModal(true)}
                className="w-full sm:flex-1 bg-gradient-to-r from-blue-600 to-purple-700 text-white px-3 sm:px-5 md:px-6 py-3 sm:py-4 rounded-lg hover:from-blue-700 hover:to-purple-800 font-semibold text-sm sm:text-base md:text-lg"
              >
                Treinador Personalizado
              </button>
              <button
                onClick={() => setShowRandomTrainerModal(true)}
                className="w-full sm:flex-1 bg-gradient-to-r from-green-600 to-teal-700 text-white px-3 sm:px-5 md:px-6 py-3 sm:py-4 rounded-lg hover:from-green-700 hover:to-teal-800 font-semibold text-sm sm:text-base md:text-lg"
              >
                Treinador Aleatório
              </button>
            </div>

            {/* Cards de NPCs */}
            {npcTrainers.length === 0 ? (
              <div className={`text-center py-12 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                <p className="text-lg">Nenhum treinador NPC criado ainda</p>
              </div>
            ) : (
              <div className="grid grid-cols-1 sm:grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4 md:gap-6">
                {npcTrainers.map(npc => (
                  <div key={npc.id} className={`p-3 sm:p-4 md:p-6 rounded-lg border-2 ${darkMode ? 'bg-gray-700 border-blue-500' : 'bg-blue-50 border-blue-300'}`}>
                    <div className="flex flex-col sm:flex-row justify-between items-start gap-3 mb-4">
                      <div className="flex flex-col xs:flex-row items-start xs:items-center gap-2 xs:gap-3 w-full sm:w-auto">
                        <h3 className={`text-lg sm:text-xl md:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{npc.name}</h3>
                        {npc.isRandom && npc.caracteristicasETalentos && (
                          <button
                            onClick={() => {
                              setSelectedNPCForTalentos(npc)
                              setShowNPCTalentosModal(true)
                            }}
                            className="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-2 sm:px-3 py-1 rounded-lg hover:from-purple-700 hover:to-pink-700 font-semibold text-xs sm:text-sm whitespace-nowrap"
                            title="Ver Características e Talentos"
                          >
                            Talento R NPC
                          </button>
                        )}
                        {!npc.isRandom && npc.caracteristicasETalentos && npc.caracteristicasETalentos.length > 0 && (
                          <button
                            onClick={() => {
                              setSelectedNPCForTalentos(npc)
                              setShowNPCTalentosModal(true)
                            }}
                            className="bg-gradient-to-r from-blue-600 to-cyan-600 text-white px-2 sm:px-3 py-1 rounded-lg hover:from-blue-700 hover:to-cyan-700 font-semibold text-xs sm:text-sm whitespace-nowrap"
                            title="Ver Características e Talentos"
                          >
                            Treinador T Personalizado
                          </button>
                        )}
                      </div>
                      <div className="flex gap-2 flex-shrink-0">
                        <button
                          onClick={() => sendNpcTrainerToBattle(npc)}
                          className="bg-cyan-500 text-white p-2 rounded hover:bg-cyan-600"
                          title="Enviar para Batalha Treinador NPC"
                        >
                          <PlusCircle size={18} />
                        </button>
                        <button
                          onClick={() => archiveNpcTrainer(npc)}
                          className="bg-amber-500 text-white p-2 rounded hover:bg-amber-600"
                          title="Arquivar Treinador NPC"
                        >
                          <Save size={18} />
                        </button>
                        <button
                          onClick={() => handleDeleteNPC(npc.id)}
                          className="bg-red-500 text-white p-2 rounded hover:bg-red-600"
                        >
                          <Trash2 size={18} />
                        </button>
                      </div>
                    </div>

                    <div className={`mb-4 text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      <p className="mb-2"><span className="font-semibold">Nível:</span> {npc.level}</p>
                      <p className="mb-2"><span className="font-semibold">Vida:</span> {npc.currentHP}/{npc.hp}</p>
                    </div>

                    {/* Tabela de Atributos */}
                    <div className="mb-4">
                      <h4 className={`font-bold mb-2 text-sm sm:text-base ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>Atributos</h4>
                      <div className="overflow-x-auto -mx-3 px-3 sm:mx-0 sm:px-0">
                        <table className={`w-full text-xs sm:text-sm min-w-[280px] ${darkMode ? 'bg-gray-600' : 'bg-white'}`}>
                          <thead>
                            <tr className={darkMode ? 'bg-gray-500' : 'bg-gray-200'}>
                              <th className={`border p-2 text-left ${darkMode ? 'border-gray-400' : 'border-gray-300'}`}>Atributo</th>
                              <th className={`border p-2 text-center ${darkMode ? 'border-gray-400' : 'border-gray-300'}`}>Valor</th>
                              <th className={`border p-2 text-center ${darkMode ? 'border-gray-400' : 'border-gray-300'}`}>Modificador</th>
                            </tr>
                          </thead>
                          <tbody className={darkMode ? 'text-gray-200' : 'text-gray-800'}>
                            <tr><td className={`border p-2 ${darkMode ? 'border-gray-400' : 'border-gray-300'}`}>Saúde</td><td className={`border p-2 text-center ${darkMode ? 'border-gray-400' : 'border-gray-300'}`}>{npc.attributes.saude}</td><td className={`border p-2 text-center ${darkMode ? 'border-gray-400' : 'border-gray-300'}`}>{npc.modifiers.saude}</td></tr>
                            <tr><td className={`border p-2 ${darkMode ? 'border-gray-400' : 'border-gray-300'}`}>Ataque</td><td className={`border p-2 text-center ${darkMode ? 'border-gray-400' : 'border-gray-300'}`}>{npc.attributes.ataque}</td><td className={`border p-2 text-center ${darkMode ? 'border-gray-400' : 'border-gray-300'}`}>{npc.modifiers.ataque}</td></tr>
                            <tr><td className={`border p-2 ${darkMode ? 'border-gray-400' : 'border-gray-300'}`}>Defesa</td><td className={`border p-2 text-center ${darkMode ? 'border-gray-400' : 'border-gray-300'}`}>{npc.attributes.defesa}</td><td className={`border p-2 text-center ${darkMode ? 'border-gray-400' : 'border-gray-300'}`}>{npc.modifiers.defesa}</td></tr>
                            <tr><td className={`border p-2 ${darkMode ? 'border-gray-400' : 'border-gray-300'}`}>Ataque Especial</td><td className={`border p-2 text-center ${darkMode ? 'border-gray-400' : 'border-gray-300'}`}>{npc.attributes.ataqueEspecial}</td><td className={`border p-2 text-center ${darkMode ? 'border-gray-400' : 'border-gray-300'}`}>{npc.modifiers.ataqueEspecial}</td></tr>
                            <tr><td className={`border p-2 ${darkMode ? 'border-gray-400' : 'border-gray-300'}`}>Defesa Especial</td><td className={`border p-2 text-center ${darkMode ? 'border-gray-400' : 'border-gray-300'}`}>{npc.attributes.defesaEspecial}</td><td className={`border p-2 text-center ${darkMode ? 'border-gray-400' : 'border-gray-300'}`}>{npc.modifiers.defesaEspecial}</td></tr>
                            <tr><td className={`border p-2 ${darkMode ? 'border-gray-400' : 'border-gray-300'}`}>Velocidade</td><td className={`border p-2 text-center ${darkMode ? 'border-gray-400' : 'border-gray-300'}`}>{npc.attributes.velocidade}</td><td className={`border p-2 text-center ${darkMode ? 'border-gray-400' : 'border-gray-300'}`}>{npc.modifiers.velocidade}</td></tr>
                          </tbody>
                        </table>
                      </div>
                    </div>

                    {/* Deslocamento */}
                    <div className="mb-4">
                      <h4 className={`font-bold mb-2 text-sm sm:text-base ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>Deslocamento</h4>
                      <div className={`grid grid-cols-1 xs:grid-cols-3 gap-2 text-xs sm:text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                        <div className={`p-2 rounded ${darkMode ? 'bg-gray-600' : 'bg-gray-100'}`}><span className="font-semibold">Terrestre:</span> {npc.displacement.terrestre}</div>
                        <div className={`p-2 rounded ${darkMode ? 'bg-gray-600' : 'bg-gray-100'}`}><span className="font-semibold">Natação:</span> {npc.displacement.natacao}</div>
                        <div className={`p-2 rounded ${darkMode ? 'bg-gray-600' : 'bg-gray-100'}`}><span className="font-semibold">Subaquático:</span> {npc.displacement.subaquatico}</div>
                      </div>
                    </div>

                    {/* Evasão */}
                    <div>
                      <h4 className={`font-bold mb-2 text-sm sm:text-base ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>Evasão</h4>
                      <div className={`grid grid-cols-1 xs:grid-cols-3 gap-2 text-xs sm:text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                        <div className={`p-2 rounded ${darkMode ? 'bg-gray-600' : 'bg-gray-100'}`}><span className="font-semibold">Física:</span> {npc.evasion.fisica}</div>
                        <div className={`p-2 rounded ${darkMode ? 'bg-gray-600' : 'bg-gray-100'}`}><span className="font-semibold">Especial:</span> {npc.evasion.especial}</div>
                        <div className={`p-2 rounded ${darkMode ? 'bg-gray-600' : 'bg-gray-100'}`}><span className="font-semibold">Veloz:</span> {npc.evasion.veloz}</div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>

        {/* MODAL TREINADOR PERSONALIZADO */}
        {showCustomTrainerModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-2 sm:p-4" onClick={() => setShowCustomTrainerModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-[95vw] sm:max-w-2xl md:max-w-4xl w-full max-h-[90vh] overflow-y-auto`} onClick={(e) => e.stopPropagation()}>
              <div className="p-3 sm:p-5 md:p-6">
                <div className="flex justify-between items-center mb-6">
                  <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                    Criar Treinador Personalizado
                  </h3>
                  <button onClick={() => setShowCustomTrainerModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                    <X size={24} />
                  </button>
                </div>

                {/* Nome */}
                <div className="mb-6">
                  <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>1. Nome</label>
                  <input
                    type="text"
                    value={customTrainerForm.name}
                    onChange={(e) => setCustomTrainerForm({...customTrainerForm, name: e.target.value})}
                    className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                    placeholder="Nome do treinador"
                  />
                </div>

                {/* Imagem do Treinador */}
                <div className="mb-6">
                  <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>2. Imagem (URL)</label>
                  <input
                    type="text"
                    value={customTrainerForm.imageUrl}
                    onChange={(e) => setCustomTrainerForm({...customTrainerForm, imageUrl: e.target.value})}
                    className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                    placeholder="Cole o link da imagem do treinador"
                  />
                  {customTrainerForm.imageUrl && (
                    <div className="mt-3 flex justify-center">
                      <img
                        src={customTrainerForm.imageUrl}
                        alt="Preview do treinador"
                        className="max-w-32 max-h-32 object-contain rounded-lg border-2 border-gray-300"
                        onError={(e) => e.target.style.display = 'none'}
                      />
                    </div>
                  )}
                </div>

                {/* Nível */}
                <div className="mb-6">
                  <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>3. Nível</label>
                  <input
                    type="number"
                    min="1"
                    value={customTrainerForm.level}
                    onChange={(e) => setCustomTrainerForm({...customTrainerForm, level: parseInt(e.target.value) || 1})}
                    className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                  />
                </div>

                {/* Tabela de Atributos */}
                <div className="mb-6">
                  <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>4. Atributos</label>
                  <div className="overflow-x-auto -mx-3 px-3 sm:mx-0 sm:px-0">
                    <table className={`w-full min-w-[280px] text-xs sm:text-sm ${darkMode ? 'bg-gray-700' : 'bg-white'}`}>
                      <thead>
                        <tr className={darkMode ? 'bg-gray-600' : 'bg-gray-200'}>
                          <th className={`border p-2 text-left ${darkMode ? 'border-gray-500 text-white' : 'border-gray-300'}`}>Atributo</th>
                          <th className={`border p-2 text-center ${darkMode ? 'border-gray-500 text-white' : 'border-gray-300'}`}>Valor</th>
                          <th className={`border p-2 text-center ${darkMode ? 'border-gray-500 text-white' : 'border-gray-300'}`}>Modificador</th>
                        </tr>
                      </thead>
                      <tbody className={darkMode ? 'text-gray-200' : 'text-gray-800'}>
                        {[
                          { label: 'Saúde', key: 'saude' },
                          { label: 'Ataque', key: 'ataque' },
                          { label: 'Defesa', key: 'defesa' },
                          { label: 'Ataque Especial', key: 'ataqueEspecial' },
                          { label: 'Defesa Especial', key: 'defesaEspecial' },
                          { label: 'Velocidade', key: 'velocidade' }
                        ].map(attr => (
                          <tr key={attr.key}>
                            <td className={`border p-2 ${darkMode ? 'border-gray-500' : 'border-gray-300'}`}>{attr.label}</td>
                            <td className={`border p-2 ${darkMode ? 'border-gray-500' : 'border-gray-300'}`}>
                              <input
                                type="number"
                                min="1"
                                max="40"
                                value={customTrainerForm.attributes[attr.key]}
                                onChange={(e) => setCustomTrainerForm({
                                  ...customTrainerForm,
                                  attributes: {...customTrainerForm.attributes, [attr.key]: parseInt(e.target.value) || 1}
                                })}
                                className={`w-full px-2 py-1 text-center ${darkMode ? 'bg-gray-600 text-white' : 'bg-white'}`}
                              />
                            </td>
                            <td className={`border p-2 text-center font-bold ${darkMode ? 'border-gray-500' : 'border-gray-300'}`}>
                              {calculateModifier(customTrainerForm.attributes[attr.key])}
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>

                {/* Vida Calculada */}
                <div className={`mb-6 p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-blue-50'}`}>
                  <p className={`text-lg font-bold ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>
                    Vida: {calculateNPCHP(customTrainerForm.level, customTrainerForm.attributes.saude)}
                  </p>
                </div>

                {/* Classes e Subclasses */}
                <div className="mb-6">
                  <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    5. Classes & Subclasses (Opcional)
                  </label>
                  <div className="mb-3 flex flex-wrap gap-2">
                    {customTrainerForm.classes.map((className, idx) => {
                      const classInfo = allClasses.find(c => c.name === className)
                      return (
                        <span
                          key={idx}
                          className="px-3 py-1 rounded-lg font-semibold text-white text-sm flex items-center gap-2"
                          style={{ backgroundColor: classInfo?.color || '#666' }}
                        >
                          {className}
                          <button
                            onClick={() => {
                              const newClasses = customTrainerForm.classes.filter((_, i) => i !== idx)
                              setCustomTrainerForm({...customTrainerForm, classes: newClasses})
                            }}
                            className="hover:bg-white/20 rounded px-1"
                          >
                            ×
                          </button>
                        </span>
                      )
                    })}
                  </div>
                  <select
                    value=""
                    onChange={(e) => {
                      if (e.target.value && !customTrainerForm.classes.includes(e.target.value)) {
                        setCustomTrainerForm({
                          ...customTrainerForm,
                          classes: [...customTrainerForm.classes, e.target.value]
                        })
                      }
                    }}
                    className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                  >
                    <option value="">Selecionar classe/subclasse...</option>
                    {allClasses
                      .filter(c => !customTrainerForm.classes.includes(c.name))
                      .map(c => (
                        <option key={c.name} value={c.name}>{c.name}</option>
                      ))
                    }
                  </select>
                </div>

                {/* Modo de Talentos */}
                {customTrainerForm.classes.length > 0 && (
                  <div className="mb-6">
                    <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      6. Talentos
                    </label>
                    <div className="flex flex-col xs:flex-row gap-2 sm:gap-3 md:gap-4 mb-4">
                      <label className="flex items-center gap-2 cursor-pointer">
                        <input
                          type="radio"
                          checked={customTrainerForm.talentosMode === 'aleatorio'}
                          onChange={() => setCustomTrainerForm({...customTrainerForm, talentosMode: 'aleatorio', selectedTalentos: []})}
                          className="w-4 h-4"
                        />
                        <span className={`text-sm sm:text-base ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Aleatório</span>
                      </label>
                      <label className="flex items-center gap-2 cursor-pointer">
                        <input
                          type="radio"
                          checked={customTrainerForm.talentosMode === 'manual'}
                          onChange={() => setCustomTrainerForm({...customTrainerForm, talentosMode: 'manual'})}
                          className="w-4 h-4"
                        />
                        <span className={`text-sm sm:text-base ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Escolher Manualmente</span>
                      </label>
                    </div>

                    {customTrainerForm.talentosMode === 'manual' && (
                      <div>
                        <p className={`text-xs mb-2 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                          Total necessário: {TALENTOS_POR_NIVEL[customTrainerForm.level] || 3} (Características automáticas + Talentos selecionados)
                        </p>
                        <p className={`text-xs mb-3 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                          Selecionados: {customTrainerForm.classes.reduce((acc, className) => {
                            const caracs = getClassCaracteristicas(className)
                            return acc + caracs.length
                          }, 0)} características + {customTrainerForm.selectedTalentos.length} talentos
                        </p>
                        <button
                          onClick={() => setShowSelectTalentosModal(true)}
                          className="w-full bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 font-semibold text-sm sm:text-base"
                        >
                          Selecionar Talentos
                        </button>
                      </div>
                    )}
                  </div>
                )}

                {/* Botões */}
                <div className="flex flex-col sm:flex-row gap-2 sm:gap-3 pt-4">
                  <button
                    onClick={() => setShowCustomTrainerModal(false)}
                    className={`w-full sm:flex-1 py-2 sm:py-3 rounded-lg font-semibold text-sm sm:text-base ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                  >
                    Cancelar
                  </button>
                  <button
                    onClick={handleSaveCustomTrainer}
                    className="w-full sm:flex-1 bg-blue-500 text-white py-2 sm:py-3 rounded-lg hover:bg-blue-600 font-semibold text-sm sm:text-base"
                  >
                    Salvar
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* MODAL TREINADOR ALEATÓRIO */}
        {showRandomTrainerModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-2 sm:p-4" onClick={() => setShowRandomTrainerModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-[95vw] sm:max-w-md w-full`} onClick={(e) => e.stopPropagation()}>
              <div className="p-3 sm:p-5 md:p-6">
                <div className="flex justify-between items-center mb-6">
                  <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                    Criar Treinador Aleatório
                  </h3>
                  <button onClick={() => setShowRandomTrainerModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                    <X size={24} />
                  </button>
                </div>

                {/* Nome */}
                <div className="mb-4">
                  <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Nome</label>
                  <input
                    type="text"
                    value={randomTrainerForm.name}
                    onChange={(e) => setRandomTrainerForm({...randomTrainerForm, name: e.target.value})}
                    className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                    placeholder="Nome do treinador"
                  />
                </div>

                {/* Imagem do Treinador */}
                <div className="mb-4">
                  <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Imagem (URL)</label>
                  <input
                    type="text"
                    value={randomTrainerForm.imageUrl}
                    onChange={(e) => setRandomTrainerForm({...randomTrainerForm, imageUrl: e.target.value})}
                    className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                    placeholder="Cole o link da imagem do treinador"
                  />
                  {randomTrainerForm.imageUrl && (
                    <div className="mt-3 flex justify-center">
                      <img
                        src={randomTrainerForm.imageUrl}
                        alt="Preview do treinador"
                        className="max-w-32 max-h-32 object-contain rounded-lg border-2 border-gray-300"
                        onError={(e) => e.target.style.display = 'none'}
                      />
                    </div>
                  )}
                </div>

                {/* Nível */}
                <div className="mb-6">
                  <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Nível</label>
                  <input
                    type="number"
                    min="1"
                    value={randomTrainerForm.level}
                    onChange={(e) => setRandomTrainerForm({...randomTrainerForm, level: parseInt(e.target.value) || 1})}
                    className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                  />
                </div>

                {/* Botões */}
                <div className="flex flex-col sm:flex-row gap-2 sm:gap-3 pt-4">
                  <button
                    onClick={() => setShowRandomTrainerModal(false)}
                    className={`w-full sm:flex-1 py-2 sm:py-3 rounded-lg font-semibold text-sm sm:text-base ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                  >
                    Cancelar
                  </button>
                  <button
                    onClick={handleSaveRandomTrainer}
                    className="w-full sm:flex-1 bg-green-500 text-white py-2 sm:py-3 rounded-lg hover:bg-green-600 font-semibold text-sm sm:text-base"
                  >
                    Gerar
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* MODAL TALENTOS NPC */}
        {showNPCTalentosModal && selectedNPCForTalentos && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-2 sm:p-4" onClick={() => setShowNPCTalentosModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-[95vw] sm:max-w-2xl md:max-w-4xl w-full max-h-[90vh] overflow-y-auto`} onClick={(e) => e.stopPropagation()}>
              <div className="p-3 sm:p-5 md:p-6">
                <div className="flex justify-between items-center mb-6">
                  <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                    Características & Talentos - {selectedNPCForTalentos.name}
                  </h3>
                  <button onClick={() => setShowNPCTalentosModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                    <X size={24} />
                  </button>
                </div>

                {/* Classes */}
                {selectedNPCForTalentos.classes && selectedNPCForTalentos.classes.length > 0 && (
                  <div className="mb-6">
                    <h4 className={`text-lg font-bold mb-3 ${darkMode ? 'text-blue-400' : 'text-blue-700'}`}>
                      Classes & Subclasses
                    </h4>
                    <div className="flex flex-wrap gap-2">
                      {selectedNPCForTalentos.classes.map((className, idx) => {
                        const classInfo = allClasses.find(c => c.name === className)
                        return (
                          <span
                            key={idx}
                            className="px-3 py-1 rounded-lg font-semibold text-white text-sm"
                            style={{ backgroundColor: classInfo?.color || '#666' }}
                          >
                            {className}
                          </span>
                        )
                      })}
                    </div>
                  </div>
                )}

                {/* Características e Talentos */}
                {selectedNPCForTalentos.caracteristicasETalentos && selectedNPCForTalentos.caracteristicasETalentos.length > 0 && (
                  <div>
                    <h4 className={`text-lg font-bold mb-3 ${darkMode ? 'text-purple-400' : 'text-purple-700'}`}>
                      Características & Talentos ({selectedNPCForTalentos.caracteristicasETalentos.length})
                    </h4>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-2 sm:gap-3 md:gap-4">
                      {selectedNPCForTalentos.caracteristicasETalentos.map((item, idx) => {
                        const isCaracteristica = item.tipo === 'caracteristica'
                        return (
                          <div
                            key={idx}
                            className={`p-4 rounded-lg border-2 ${
                              isCaracteristica
                                ? darkMode ? 'bg-blue-900/30 border-blue-500' : 'bg-blue-50 border-blue-300'
                                : darkMode ? 'bg-purple-900/30 border-purple-500' : 'bg-purple-50 border-purple-300'
                            }`}
                          >
                            <div className="flex items-start justify-between mb-2">
                              <h5 className={`font-bold text-sm ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                {item.nome}
                              </h5>
                              <span className={`text-xs px-2 py-0.5 rounded ml-2 flex-shrink-0 ${
                                isCaracteristica
                                  ? darkMode ? 'bg-blue-700 text-blue-200' : 'bg-blue-200 text-blue-800'
                                  : darkMode ? 'bg-purple-700 text-purple-200' : 'bg-purple-200 text-purple-800'
                              }`}>
                                {item.classe}
                              </span>
                            </div>
                            <div className="space-y-1 text-xs">
                              {item.requisitos && (
                                <p className={darkMode ? 'text-gray-300' : 'text-gray-700'}>
                                  <span className="font-semibold">Requisitos:</span> {item.requisitos}
                                </p>
                              )}
                              <p className={darkMode ? 'text-gray-300' : 'text-gray-700'}>
                                <span className="font-semibold">Frequência:</span> {item.frequencia}
                              </p>
                              <p className={darkMode ? 'text-gray-300' : 'text-gray-700'}>
                                <span className="font-semibold">Referência:</span> {item.referencia}
                              </p>
                              {item.alvo && (
                                <p className={darkMode ? 'text-gray-300' : 'text-gray-700'}>
                                  <span className="font-semibold">Alvo:</span> {item.alvo}
                                </p>
                              )}
                              {item.gatilho && (
                                <p className={darkMode ? 'text-gray-300' : 'text-gray-700'}>
                                  <span className="font-semibold">Gatilho:</span> {item.gatilho}
                                </p>
                              )}
                              <p className={`mt-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                <span className="font-semibold">Efeito:</span> {item.efeito}
                              </p>
                              {item.especial && (
                                <p className={`mt-2 italic ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                  {item.especial}
                                </p>
                              )}
                            </div>
                          </div>
                        )
                      })}
                    </div>
                  </div>
                )}
              </div>
            </div>
          </div>
        )}

        {/* Modal de Seleção Manual de Talentos */}
        {showSelectTalentosModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowSelectTalentosModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-5xl w-full max-h-[90vh] overflow-y-auto`} onClick={(e) => e.stopPropagation()}>
              <div className="p-3 sm:p-5 md:p-6">
                <div className="flex justify-between items-center mb-6">
                  <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                    Selecionar Talentos
                  </h3>
                  <button onClick={() => setShowSelectTalentosModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                    <X size={24} />
                  </button>
                </div>

                {/* Resumo de Seleção */}
                <div className={`mb-6 p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                  <div className="flex justify-between items-center mb-2">
                    <span className={`font-semibold ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      Progresso da Seleção
                    </span>
                    <span className={`text-lg font-bold ${
                      (customTrainerForm.classes.reduce((acc, className) => {
                        const caracs = getClassCaracteristicas(className)
                        return acc + caracs.length
                      }, 0) + customTrainerForm.selectedTalentos.length) >= (TALENTOS_POR_NIVEL[customTrainerForm.level] || 3)
                        ? 'text-green-500'
                        : 'text-yellow-500'
                    }`}>
                      {customTrainerForm.classes.reduce((acc, className) => {
                        const caracs = getClassCaracteristicas(className)
                        return acc + caracs.length
                      }, 0) + customTrainerForm.selectedTalentos.length} / {TALENTOS_POR_NIVEL[customTrainerForm.level] || 3}
                    </span>
                  </div>
                  <div className="text-xs space-y-1">
                    <p className={darkMode ? 'text-gray-400' : 'text-gray-600'}>
                      Características (automáticas): {customTrainerForm.classes.reduce((acc, className) => {
                        const caracs = getClassCaracteristicas(className)
                        return acc + caracs.length
                      }, 0)}
                    </p>
                    <p className={darkMode ? 'text-gray-400' : 'text-gray-600'}>
                      Talentos selecionados: {customTrainerForm.selectedTalentos.length}
                    </p>
                  </div>
                </div>

                {/* Talentos Selecionados */}
                {customTrainerForm.selectedTalentos.length > 0 && (
                  <div className="mb-6">
                    <h4 className={`text-lg font-bold mb-3 ${darkMode ? 'text-purple-400' : 'text-purple-700'}`}>
                      Talentos Selecionados ({customTrainerForm.selectedTalentos.length})
                    </h4>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                      {customTrainerForm.selectedTalentos.map((talento, idx) => (
                        <div
                          key={idx}
                          className={`p-3 rounded-lg border-2 ${darkMode ? 'bg-purple-900/30 border-purple-500' : 'bg-purple-50 border-purple-300'}`}
                        >
                          <div className="flex items-start justify-between mb-2">
                            <h5 className={`font-bold text-sm ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                              {talento.nome}
                            </h5>
                            <div className="flex items-center gap-2">
                              <span className={`text-xs px-2 py-0.5 rounded flex-shrink-0 ${darkMode ? 'bg-purple-700 text-purple-200' : 'bg-purple-200 text-purple-800'}`}>
                                {talento.classe}
                              </span>
                              <button
                                onClick={() => {
                                  setCustomTrainerForm({
                                    ...customTrainerForm,
                                    selectedTalentos: customTrainerForm.selectedTalentos.filter((_, i) => i !== idx)
                                  })
                                }}
                                className="text-red-500 hover:text-red-700 font-bold"
                              >
                                ×
                              </button>
                            </div>
                          </div>
                          <p className={`text-xs ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                            <span className="font-semibold">Efeito:</span> {talento.efeito}
                          </p>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {/* Talentos Disponíveis */}
                <div>
                  <h4 className={`text-lg font-bold mb-3 ${darkMode ? 'text-blue-400' : 'text-blue-700'}`}>
                    Talentos Disponíveis
                  </h4>

                  {/* Talentos das Classes Selecionadas */}
                  {customTrainerForm.classes.map(className => {
                    const classTalentos = TALENTOS_DATA[className] || []
                    if (classTalentos.length === 0) return null

                    const classInfo = allClasses.find(c => c.name === className)

                    return (
                      <div key={className} className="mb-6">
                        <h5 className={`text-md font-bold mb-3 flex items-center gap-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                          <span className="px-3 py-1 rounded-lg font-semibold text-white text-sm"
                            style={{ backgroundColor: classInfo?.color || '#666' }}>
                            {className}
                          </span>
                          <span className="text-sm">({classTalentos.length} talentos)</span>
                        </h5>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                          {classTalentos.map((talento, idx) => {
                            const isSelected = customTrainerForm.selectedTalentos.some(t => t.nome === talento.nome && t.classe === className)

                            return (
                              <div
                                key={idx}
                                className={`p-3 rounded-lg border-2 cursor-pointer transition-all ${
                                  isSelected
                                    ? darkMode ? 'bg-purple-900/50 border-purple-400' : 'bg-purple-100 border-purple-400'
                                    : darkMode ? 'bg-gray-700 border-gray-600 hover:border-purple-500' : 'bg-white border-gray-300 hover:border-purple-400'
                                }`}
                                onClick={() => {
                                  if (isSelected) {
                                    setCustomTrainerForm({
                                      ...customTrainerForm,
                                      selectedTalentos: customTrainerForm.selectedTalentos.filter(t => !(t.nome === talento.nome && t.classe === className))
                                    })
                                  } else {
                                    setCustomTrainerForm({
                                      ...customTrainerForm,
                                      selectedTalentos: [...customTrainerForm.selectedTalentos, { tipo: 'talento', classe: className, ...talento }]
                                    })
                                  }
                                }}
                              >
                                <div className="flex items-start justify-between mb-2">
                                  <h6 className={`font-bold text-xs ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                    {talento.nome}
                                  </h6>
                                  {isSelected && (
                                    <span className="text-green-500 font-bold">✓</span>
                                  )}
                                </div>
                                <div className="space-y-1 text-xs">
                                  {talento.requisitos && (
                                    <p className={darkMode ? 'text-gray-300' : 'text-gray-700'}>
                                      <span className="font-semibold">Req:</span> {talento.requisitos}
                                    </p>
                                  )}
                                  <p className={darkMode ? 'text-gray-300' : 'text-gray-700'}>
                                    <span className="font-semibold">Freq:</span> {talento.frequencia}
                                  </p>
                                  <p className={`mt-1 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                    {talento.efeito.substring(0, 80)}{talento.efeito.length > 80 ? '...' : ''}
                                  </p>
                                </div>
                              </div>
                            )
                          })}
                        </div>
                      </div>
                    )
                  })}

                  {/* Talentos Gerais */}
                  {TALENTOS_DATA['Geral'] && TALENTOS_DATA['Geral'].length > 0 && (
                    <div className="mb-6">
                      <h5 className={`text-md font-bold mb-3 flex items-center gap-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                        <span className="px-3 py-1 rounded-lg font-semibold text-white text-sm bg-gray-600">
                          Geral
                        </span>
                        <span className="text-sm">({TALENTOS_DATA['Geral'].length} talentos)</span>
                      </h5>
                      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                        {TALENTOS_DATA['Geral'].map((talento, idx) => {
                          const isSelected = customTrainerForm.selectedTalentos.some(t => t.nome === talento.nome && t.classe === 'Geral')

                          return (
                            <div
                              key={idx}
                              className={`p-3 rounded-lg border-2 cursor-pointer transition-all ${
                                isSelected
                                  ? darkMode ? 'bg-purple-900/50 border-purple-400' : 'bg-purple-100 border-purple-400'
                                  : darkMode ? 'bg-gray-700 border-gray-600 hover:border-purple-500' : 'bg-white border-gray-300 hover:border-purple-400'
                              }`}
                              onClick={() => {
                                if (isSelected) {
                                  setCustomTrainerForm({
                                    ...customTrainerForm,
                                    selectedTalentos: customTrainerForm.selectedTalentos.filter(t => !(t.nome === talento.nome && t.classe === 'Geral'))
                                  })
                                } else {
                                  setCustomTrainerForm({
                                    ...customTrainerForm,
                                    selectedTalentos: [...customTrainerForm.selectedTalentos, { tipo: 'talento', classe: 'Geral', ...talento }]
                                  })
                                }
                              }}
                            >
                              <div className="flex items-start justify-between mb-2">
                                <h6 className={`font-bold text-xs ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                  {talento.nome}
                                </h6>
                                {isSelected && (
                                  <span className="text-green-500 font-bold">✓</span>
                                )}
                              </div>
                              <div className="space-y-1 text-xs">
                                {talento.requisitos && (
                                  <p className={darkMode ? 'text-gray-300' : 'text-gray-700'}>
                                    <span className="font-semibold">Req:</span> {talento.requisitos}
                                  </p>
                                )}
                                <p className={darkMode ? 'text-gray-300' : 'text-gray-700'}>
                                  <span className="font-semibold">Freq:</span> {talento.frequencia}
                                </p>
                                <p className={`mt-1 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                  {talento.efeito.substring(0, 80)}{talento.efeito.length > 80 ? '...' : ''}
                                </p>
                              </div>
                            </div>
                          )
                        })}
                      </div>
                    </div>
                  )}
                </div>

                {/* Botão Confirmar */}
                <div className="flex gap-3 pt-4 mt-6 border-t border-gray-300">
                  <button
                    onClick={() => setShowSelectTalentosModal(false)}
                    className={`flex-1 py-3 rounded-lg font-semibold ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                  >
                    Cancelar
                  </button>
                  <button
                    onClick={() => setShowSelectTalentosModal(false)}
                    className="flex-1 bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 font-semibold"
                  >
                    Confirmar Seleção
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}
        </div>
        {accountDataModal}
        {scenarioPopupOverlay}
        {mostrarTriunfosOverlay}
        {pokezapPanel}{pokeAgendaPanel}
        {batalhaChatPanel}
      </>
    )
  }


  // ÁREA POKÉMON NPC (MESTRE)
  if (currentUser.type === 'mestre' && currentArea === 'Pokémon NPC') {
    if (!spoilerMestreConfirmado) return (
      <>
        <div className={`min-h-screen ${mainBgClass}`}>
          {sidebarNav}
          <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-lg`}>
            <div className="max-w-7xl mx-auto px-4 py-4">
              <div className="flex justify-between items-center mb-4">
                <div className="flex items-center gap-3"><button onClick={() => setSidebarOpen(true)} className={`p-2 rounded-lg ${darkMode ? "hover:bg-gray-700 text-gray-400" : "hover:bg-gray-200 text-gray-500"}`}><Menu size={24} /></button><h2 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Pokémon NPC 👑</h2></div>
                <div className="flex gap-2">
                  <button onClick={() => setShowAccountDataModal(true)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-200 text-gray-700'}`} title="Dados da Conta"><ArrowDownUp size={20} /></button>
                  <button onClick={() => setDarkMode(!darkMode)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-yellow-400' : 'bg-gray-200 text-gray-700'}`}>{darkMode ? <Sun size={20} /> : <Moon size={20} />}</button>
                  {pokezapBtn}{pokeAgendaBtn}{batalhaChatBtn}<button onClick={handleLogout} className="bg-red-500 text-white px-3 sm:px-5 md:px-6 py-2 rounded-lg hover:bg-red-600">Sair</button>
                </div>
              </div>
            </div>
          </div>
          <div className="max-w-7xl mx-auto px-4 py-3 sm:py-5 md:py-8 flex flex-col items-center justify-center min-h-[60vh] text-center gap-6">
            <div className="text-6xl">⚠️</div>
            <h2 className={`text-3xl font-bold ${darkMode ? 'text-yellow-400' : 'text-yellow-600'}`}>Alerta de Spoiler</h2>
            <p className={`text-base max-w-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
              Esta área contém informações confidenciais do Arco. Prossiga apenas se tiver certeza.
            </p>
            <button
              onClick={() => setSpoilerMestreConfirmado(true)}
              className="bg-yellow-500 hover:bg-yellow-600 text-black font-bold px-8 py-3 rounded-xl text-lg transition-colors"
            >
              Sou o mestre do Arco.
            </button>
          </div>
        </div>
      </>
    )
    return (
      <>
        <div className={`min-h-screen ${mainBgClass}`}>
          {sidebarNav}
        <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-lg`}>
          <div className="max-w-7xl mx-auto px-4 py-4">
            <div className="flex justify-between items-center mb-4">
              <div className="flex items-center gap-3"><button onClick={() => setSidebarOpen(true)} className={`p-2 rounded-lg ${darkMode ? "hover:bg-gray-700 text-gray-400" : "hover:bg-gray-200 text-gray-500"}`}><Menu size={24} /></button><h2 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Pokémon NPC 👑</h2></div>
              <div className="flex gap-2">
                <button onClick={() => setShowAccountDataModal(true)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-200 text-gray-700'}`} title="Dados da Conta"><ArrowDownUp size={20} /></button>
                <button onClick={() => setDarkMode(!darkMode)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-yellow-400' : 'bg-gray-200 text-gray-700'}`}>{darkMode ? <Sun size={20} /> : <Moon size={20} />}</button>
                {pokezapBtn}{pokeAgendaBtn}{batalhaChatBtn}<button onClick={handleLogout} className="bg-red-500 text-white px-3 sm:px-5 md:px-6 py-2 rounded-lg hover:bg-red-600">Sair</button>
              </div>
            </div>
          </div>
        </div>

        <div className="max-w-7xl mx-auto px-4 py-3 sm:py-5 md:py-8">
          {npcPokemon.length === 0 ? (
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-8 text-center`}>
              <p className={`text-lg ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                Nenhum Pokémon NPC adicionado ainda. Gere Pokémon no Gerador e adicione-os como NPCs.
              </p>
            </div>
          ) : (
            <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-2 sm:gap-3 md:gap-4">
              {npcPokemon.map(pokemon => {
                const isExpanded = expandedNpcCards.includes(pokemon.id)

                return (
                  <div
                    key={pokemon.id}
                    className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl overflow-hidden transition-all ${
                      isExpanded ? 'col-span-2 sm:col-span-2 md:col-span-2 lg:col-span-3 xl:col-span-3' : ''
                    }`}
                  >
                    {!isExpanded ? (
                      // Card compacto - apenas imagem
                      <div className="relative group">
                        <div
                          onClick={() => toggleNpcCard(pokemon.id)}
                          className="cursor-pointer p-3 sm:p-4 flex flex-col items-center"
                        >
                          {pokemon.imageUrl && (
                            <img
                              src={pokemon.imageUrl}
                              alt={pokemon.name || pokemon.species}
                              className="w-20 h-20 sm:w-24 sm:h-24 md:w-28 md:h-28 object-contain mb-2"
                            />
                          )}
                          <p className={`text-sm font-bold text-center ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                            {pokemon.species || pokemon.name || 'Pokémon'} {pokemon.shiny && '✨'} {pokemon.legendary && '👑'}
                          </p>
                          <div className="flex justify-center mt-1">
                            <DietIcons speciesName={pokemon.species || pokemon.name} size={18} />
                          </div>
                          {(() => {
                            const d = POKEMON_DESLOCAMENTO_MAP[pokemon.species || pokemon.name]
                            if (!d) return null
                            const LABELS = { terrestre: 'Ter', nadar: 'Nat', voar: 'Voo', cavar: 'Esc', submerso: 'Sub' }
                            const parts = Object.entries(LABELS).filter(([k]) => d[k] !== '' && d[k] != null).map(([k, l]) => `${l} ${d[k]}`)
                            if (!parts.length) return null
                            return <p className={`text-[10px] text-center mt-0.5 ${darkMode ? 'text-blue-300' : 'text-blue-600'}`}>{parts.join(' · ')}</p>
                          })()}
                          {(() => {
                            const c = POKEMON_CAPACIDADE_MAP[pokemon.species || pokemon.name]
                            if (!c) return null
                            const parts = [
                              c.forca !== '' && c.forca != null ? `For ${c.forca}` : null,
                              c.inteligencia !== '' && c.inteligencia != null ? `Int ${c.inteligencia}` : null,
                              c.salto !== '' && c.salto != null ? `Sal ${c.salto}` : null,
                            ].filter(Boolean)
                            if (!parts.length) return null
                            return <p className={`text-[10px] text-center mt-0.5 ${darkMode ? 'text-orange-300' : 'text-orange-600'}`}>{parts.join(' · ')}</p>
                          })()}
                          <div className="flex items-center gap-1 mt-1">
                            <p className={`text-xs text-center ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                              Nível {pokemon.level}
                            </p>
                            {(pokemon.habilidade1 || pokemon.habilidade2) && (
                              <div className="flex gap-1">
                                {pokemon.habilidade1 && (
                                  <span className={`px-1.5 py-0.5 rounded text-[10px] font-semibold ${darkMode ? 'bg-blue-900 text-blue-300' : 'bg-blue-500 text-white'}`}>
                                    {pokemon.habilidade1}
                                  </span>
                                )}
                                {pokemon.habilidade2 && (
                                  <span className={`px-1.5 py-0.5 rounded text-[10px] font-semibold ${darkMode ? 'bg-purple-900 text-purple-300' : 'bg-purple-500 text-white'}`}>
                                    {pokemon.habilidade2}
                                  </span>
                                )}
                              </div>
                            )}
                          </div>
                        </div>
                        <div className="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                          <button
                            onClick={(e) => {
                              e.stopPropagation()
                              sendNpcPokemonToBattle(pokemon)
                            }}
                            className="bg-cyan-500 text-white p-1.5 rounded-lg hover:bg-cyan-600"
                            title="Enviar para Batalha"
                          >
                            <ArrowRightCircle size={14} />
                          </button>
                          <button
                            onClick={(e) => {
                              e.stopPropagation()
                              sendNpcToGBBattle(pokemon)
                            }}
                            className="bg-green-600 text-white p-1.5 rounded-lg hover:bg-green-700"
                            title="Enviar para Batalha Game Boy"
                          >
                            <Gamepad2 size={14} />
                          </button>
                          <button
                            onClick={(e) => {
                              e.stopPropagation()
                              archiveNpcPokemon(pokemon)
                            }}
                            className="bg-amber-500 text-white p-1.5 rounded-lg hover:bg-amber-600"
                            title="Arquivar Pkm NPC"
                          >
                            <Save size={14} />
                          </button>
                          <button
                            onClick={(e) => {
                              e.stopPropagation()
                              removeNpcPokemon(pokemon.id)
                            }}
                            className="bg-red-500 text-white p-1.5 rounded-lg hover:bg-red-600"
                            title="Remover NPC"
                          >
                            <Trash2 size={14} />
                          </button>
                        </div>
                      </div>
                    ) : (
                      // Card expandido - todas as informações
                      <div className="p-3 sm:p-4">
                        {/* Variável de bônus Alfa */}
                        {(() => { pokemon._alfaBonus = npcAlfaStatus[pokemon.id] ? 3 : 0; return null })()}
                        <div className="flex justify-between items-start mb-3">
                          <div
                            onClick={() => toggleNpcCard(pokemon.id)}
                            className="cursor-pointer flex-1"
                          >
                            {pokemon.imageUrl && (
                              <div className="flex justify-center mb-2">
                                <img
                                  src={pokemon.imageUrl}
                                  alt={pokemon.name || pokemon.species}
                                  className="w-20 h-20 object-contain"
                                />
                              </div>
                            )}
                            <div className="text-center mb-2">
                              <p className={`text-sm font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                {pokemon.species || pokemon.name} {pokemon.shiny && '✨'} {pokemon.legendary && '👑'}
                              </p>
                              <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                #{String(pokemon.dexNumber).padStart(4, '0')} • Nível {pokemon.level}
                              </p>
                              <div className="flex justify-center mt-1">
                                <DietIcons speciesName={pokemon.species || pokemon.name} size={20} />
                              </div>
                              {(() => {
                                const d = POKEMON_DESLOCAMENTO_MAP[pokemon.species || pokemon.name]
                                if (!d) return null
                                const LABELS = { terrestre: 'Terrestre', nadar: 'Natação', voar: 'Voo', cavar: 'Escavação', submerso: 'Subaquático' }
                                const parts = Object.entries(LABELS).filter(([k]) => d[k] !== '' && d[k] != null).map(([k, l]) => `${l} ${d[k]}`)
                                if (!parts.length) return null
                                return <p className={`text-[10px] text-center mt-1 ${darkMode ? 'text-blue-300' : 'text-blue-600'}`}>{parts.join(' · ')}</p>
                              })()}
                              {(() => {
                                const c = POKEMON_CAPACIDADE_MAP[pokemon.species || pokemon.name]
                                if (!c) return null
                                const parts = [
                                  c.forca !== '' && c.forca != null ? `Força ${c.forca}` : null,
                                  c.inteligencia !== '' && c.inteligencia != null ? `Inteligência ${c.inteligencia}` : null,
                                  c.salto !== '' && c.salto != null ? `Salto ${c.salto}` : null,
                                ].filter(Boolean)
                                if (!parts.length) return null
                                return <p className={`text-[10px] text-center mt-1 ${darkMode ? 'text-orange-300' : 'text-orange-600'}`}>{parts.join(' · ')}</p>
                              })()}
                            </div>
                          </div>
                          <div className="flex gap-2">
                            <button
                              onClick={() => sendNpcPokemonToBattle(pokemon)}
                              className="bg-cyan-500 text-white p-1.5 rounded-lg hover:bg-cyan-600"
                              title="Enviar para Batalha"
                            >
                              <ArrowRightCircle size={14} />
                            </button>
                            <button
                              onClick={() => archiveNpcPokemon(pokemon)}
                              className="bg-amber-500 text-white p-1.5 rounded-lg hover:bg-amber-600"
                              title="Arquivar Pkm NPC"
                            >
                              <Save size={14} />
                            </button>
                            <button
                              onClick={() => removeNpcPokemon(pokemon.id)}
                              className="bg-red-500 text-white p-1.5 rounded-lg hover:bg-red-600"
                              title="Remover NPC"
                            >
                              <Trash2 size={14} />
                            </button>
                          </div>
                        </div>

                        {/* Checkbox Alfa */}
                        <div className="mb-2">
                          <label className={`flex items-center gap-2 cursor-pointer p-2 rounded-lg border-2 transition-all ${
                            npcAlfaStatus[pokemon.id]
                              ? 'border-red-500 bg-gradient-to-r from-gray-300 to-white dark:from-gray-600 dark:to-gray-400'
                              : darkMode ? 'border-gray-600 bg-gray-700' : 'border-gray-300 bg-gray-50'
                          }`}>
                            <input
                              type="checkbox"
                              checked={npcAlfaStatus[pokemon.id] || false}
                              onChange={() => setNpcAlfaStatus(prev => ({
                                ...prev,
                                [pokemon.id]: !prev[pokemon.id]
                              }))}
                              className="w-4 h-4 accent-red-500"
                            />
                            <span className={`text-sm font-bold ${npcAlfaStatus[pokemon.id] ? 'text-red-600' : darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                              Alfa
                            </span>
                            {npcAlfaStatus[pokemon.id] && (
                              <span className="text-xs text-red-500 ml-auto font-semibold">ATR +3 | Captura -10 | XP x2</span>
                            )}
                          </label>
                        </div>

                        {/* Condições de Captura */}
                        <div className="mb-2">
                          <h4 className={`text-xs font-semibold mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Condições</h4>
                          <div className="grid grid-cols-3 gap-1">
                            {[
                              { key: 'confusao', icon: BadgeHelp, color: 'text-purple-400', label: 'Confusão' },
                              { key: 'critico', icon: Clover, color: 'text-green-600', label: 'Crítico' },
                              { key: 'paralisia', icon: Zap, color: 'text-yellow-500', label: 'Paralisia' },
                              { key: 'sono', icon: Moon, color: 'text-blue-500', label: 'Sono' },
                              { key: 'atordoamento', icon: Shell, color: 'text-gray-500', label: 'Atordoamento' },
                              { key: 'congelamento', icon: Snowflake, color: 'text-blue-400', label: 'Congelamento' },
                              { key: 'paixao', icon: Heart, color: 'text-red-500', label: 'Paixão' },
                              { key: 'queimadura', icon: Flame, color: 'text-orange-500', label: 'Queimadura' },
                              { key: 'veneno', icon: Droplet, color: 'text-purple-600', label: 'Veneno' }
                            ].map(condition => {
                              const Icon = condition.icon
                              const isChecked = npcConditions[pokemon.id]?.[condition.key] || false
                              return (
                                <label key={condition.key} className="flex items-center gap-1 cursor-pointer">
                                  <input
                                    type="checkbox"
                                    checked={isChecked}
                                    onChange={() => toggleNpcCondition(pokemon.id, condition.key)}
                                    className="w-3 h-3"
                                  />
                                  <Icon size={14} className={condition.color} title={condition.label} />
                                </label>
                              )
                            })}
                          </div>
                        </div>

                        {/* Tipos e Valor de Captura */}
                        <div className="mb-2">
                          <h4 className={`text-xs font-semibold mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Tipos & Habilidades</h4>
                          <div className="flex items-center justify-between mb-2">
                            <div className="flex gap-1 flex-wrap">
                              {pokemon.types.map((type, idx) => (
                                <span key={idx} className="px-2 py-0.5 text-xs rounded-lg bg-gradient-to-r from-blue-600 to-purple-700 text-white font-semibold">
                                  {type}
                                </span>
                              ))}
                              {pokemon.habilidade1 && (
                                <span
                                  onClick={() => {
                                    setSelectedAbility(pokemon.habilidade1)
                                    setShowAbilityModal(true)
                                  }}
                                  className={`px-2 py-0.5 text-xs rounded-lg font-semibold cursor-pointer hover:opacity-80 transition-opacity ${darkMode ? 'bg-blue-900 text-blue-300' : 'bg-blue-500 text-white'}`}>
                                  {pokemon.habilidade1}
                                </span>
                              )}
                              {pokemon.habilidade2 && (
                                <span
                                  onClick={() => {
                                    setSelectedAbility(pokemon.habilidade2)
                                    setShowAbilityModal(true)
                                  }}
                                  className={`px-2 py-0.5 text-xs rounded-lg font-semibold cursor-pointer hover:opacity-80 transition-opacity ${darkMode ? 'bg-purple-900 text-purple-300' : 'bg-purple-500 text-white'}`}>
                                  {pokemon.habilidade2}
                                </span>
                              )}
                            </div>
                          </div>
                          <div className="flex justify-end">
                            <div className={`px-3 py-1 rounded-lg font-bold text-sm ${
                              calculateCaptureValue(pokemon) >= 0
                                ? 'bg-green-600 text-white'
                                : 'bg-red-600 text-white'
                            }`}>
                              Captura: {calculateCaptureValue(pokemon) >= 0 ? '+' : ''}{calculateCaptureValue(pokemon)}
                            </div>
                          </div>
                        </div>

                        {/* HP e Evasões */}
                        <div className={`mb-2 p-2 sm:p-3 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                          <div className="flex flex-col xs:flex-row items-start xs:items-center justify-between gap-2 mb-2">
                            <div className="flex-1">
                              <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>HP</p>
                              <p className={`text-sm font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                {pokemon.currentHP !== undefined ? pokemon.currentHP : ((3 * (pokemon.attributes.saude + pokemon._alfaBonus)) + pokemon.level)} / {(3 * (pokemon.attributes.saude + pokemon._alfaBonus)) + pokemon.level}
                              </p>
                            </div>
                            <button
                              onClick={() => {
                                setSelectedNpcPokemon(pokemon)
                                setShowNpcDamageModal(true)
                              }}
                              className="flex items-center gap-1 bg-gradient-to-r from-red-600 to-pink-600 text-white px-2 sm:px-3 py-1.5 rounded-lg hover:from-red-700 hover:to-pink-700 font-semibold text-xs whitespace-nowrap"
                              title="Dano/Cura PkmNpc"
                            >
                              <Sword size={12} />
                              <Heart size={12} />
                            </button>
                          </div>

                          <div className="grid grid-cols-3 gap-2">
                            <div>
                              <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Ev. Física</p>
                              <p className={`text-xs font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                {Math.floor((pokemon.attributes.defesa + pokemon._alfaBonus) / 5)}
                              </p>
                            </div>
                            <div>
                              <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Ev. Especial</p>
                              <p className={`text-xs font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                {Math.floor((pokemon.attributes.defesaEspecial + pokemon._alfaBonus) / 5)}
                              </p>
                            </div>
                            <div>
                              <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Ev. Veloz</p>
                              <p className={`text-xs font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                {Math.floor((pokemon.attributes.velocidade + pokemon._alfaBonus) / 10)}
                              </p>
                            </div>
                          </div>
                        </div>

                        {/* Informações Básicas */}
                        <div className={`grid grid-cols-2 gap-2 mb-2 p-2 sm:p-3 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                          <div>
                            <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Espécie</p>
                            <p className={`text-xs font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{pokemon.species || pokemon.name}</p>
                          </div>
                          <div>
                            <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Catch Rate</p>
                            <p className={`text-xs font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{pokemon.catchRate}</p>
                          </div>
                          <div>
                            <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Experiência</p>
                            <p className={`text-xs font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{pokemon.experience} XP</p>
                          </div>
                          <div>
                            <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Gênero</p>
                            <p className={`text-xs font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{pokemon.gender}</p>
                          </div>
                          <div>
                            <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Peso</p>
                            <p className={`text-xs font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{pokemon.weight ? `${pokemon.weight} kg` : 'N/A'}</p>
                          </div>
                          <div>
                            <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Altura</p>
                            <p className={`text-xs font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{pokemon.height ? `${pokemon.height} m` : 'N/A'}</p>
                          </div>
                        </div>

                        {/* Natureza */}
                        <div className="mb-2">
                          <h4 className={`text-xs font-semibold mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Natureza</h4>
                          <p className={`text-xs ${darkMode ? 'text-gray-300' : 'text-gray-800'}`}>
                            {pokemon.nature.nome} <span className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-600'}`}>
                              ({pokemon.nature.up && `↑${pokemon.nature.up}`} {pokemon.nature.down && `↓${pokemon.nature.down}`})
                            </span>
                          </p>
                        </div>

                        {/* Atributos */}
                        <div>
                          <h4 className={`text-xs font-semibold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Atributos</h4>
                          <div className="space-y-1">
                            {[
                              { label: 'Saúde', key: 'saude' },
                              { label: 'Ataque', key: 'ataque' },
                              { label: 'Defesa', key: 'defesa' },
                              { label: 'Ataque Especial', key: 'ataqueEspecial' },
                              { label: 'Defesa Especial', key: 'defesaEspecial' },
                              { label: 'Velocidade', key: 'velocidade' }
                            ].map(attr => {
                              const isIncreased = pokemon.nature.up === attr.label
                              const isDecreased = pokemon.nature.down === attr.label
                              return (
                                <div key={attr.key} className={`flex justify-between items-center p-1 rounded text-xs ${
                                  isIncreased ? (darkMode ? 'bg-green-900/30' : 'bg-green-50') :
                                  isDecreased ? (darkMode ? 'bg-red-900/30' : 'bg-red-50') :
                                  (darkMode ? 'bg-gray-700' : 'bg-gray-100')
                                }`}>
                                  <span className={`${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                    {attr.label} {isIncreased && '↑'} {isDecreased && '↓'}
                                  </span>
                                  <div className="flex gap-2">
                                    <span className={`${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>
                                      Base: {pokemon.baseAttributes[attr.key]}
                                    </span>
                                    <span className={`font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                      Total: {pokemon.attributes[attr.key] + pokemon._alfaBonus}
                                      {pokemon._alfaBonus > 0 && <span className="text-red-500 ml-1">(+{pokemon._alfaBonus})</span>}
                                    </span>
                                  </div>
                                </div>
                              )
                            })}
                          </div>
                        </div>

                        {/* Golpes */}
                        {(() => {
                          console.log('Renderizando card de:', pokemon.species || pokemon.name)
                          console.log('Golpes disponíveis:', pokemon.golpesAprendidos)
                          console.log('Tem golpes?', pokemon.golpesAprendidos && pokemon.golpesAprendidos.length > 0)
                          return null
                        })()}
                        {pokemon.golpesAprendidos && pokemon.golpesAprendidos.length > 0 && (
                          <div className="mt-2">
                            <h4 className={`text-xs font-semibold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Golpes</h4>
                            <div className="flex flex-wrap gap-1">
                              {pokemon.golpesAprendidos.map((golpe, idx) => (
                                <span
                                  key={idx}
                                  onClick={() => {
                                    setSelectedGolpeForDetail(golpe)
                                    setShowGolpeDetailModal(true)
                                  }}
                                  className={`px-2 py-1 text-xs rounded-lg font-medium cursor-pointer hover:opacity-80 transition-opacity ${
                                    darkMode ? 'bg-indigo-900 text-indigo-300' : 'bg-indigo-500 text-white'
                                  }`}
                                  title="Clique para ver detalhes"
                                >
                                  {golpe}
                                </span>
                              ))}
                            </div>
                          </div>
                        )}

                        {/* Informações Adicionais */}
                        {(pokemon.migration || pokemon.habitats?.length > 0) && (
                          <div className={`mt-2 pt-2 border-t ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
                            {pokemon.migration && (
                              <p className={`text-xs ${darkMode ? 'text-purple-400' : 'text-purple-700'} mb-1`}>
                                🌍 Migração de {pokemon.migrationRegion}
                              </p>
                            )}
                            {pokemon.habitats?.length > 0 && (
                              <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                Habitats: {pokemon.habitats.join(', ')}
                              </p>
                            )}
                          </div>
                        )}

                        {/* Botão Enviar para... */}
                        <button
                          onClick={() => {
                            setPokemonToSend(pokemon)
                            setSendPokemonSpecies(pokemon.species || pokemon.name || '')
                            setSendPokemonNature(pokemon.nature || null)
                            setSpeciesSearchSend('')
                            setNatureSearchSend('')
                            setShowSendToTrainerModal(true)
                          }}
                          className="w-full mt-3 bg-gradient-to-r from-green-600 to-emerald-600 text-white py-2 sm:py-2.5 rounded-lg hover:from-green-700 hover:to-emerald-700 font-semibold text-xs sm:text-sm"
                        >
                          Enviar para...
                        </button>

                        {/* Botão Enviar XP para... */}
                        <button
                          onClick={() => {
                            setSelectedNpcPokemonForXp(pokemon)
                            setSelectedTrainersForXp({})
                            setShowSendXpModal(true)
                          }}
                          className="w-full mt-2 bg-gradient-to-r from-yellow-500 to-orange-500 text-white py-2 sm:py-2.5 rounded-lg hover:from-yellow-600 hover:to-orange-600 font-semibold text-xs sm:text-sm"
                        >
                          Enviar XP para...
                        </button>
                      </div>
                    )}
                  </div>
                )
              })}
            </div>
          )}
        </div>

        {/* Modal de Dano/Cura Pokémon NPC */}
        {showNpcDamageModal && selectedNpcPokemon && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-2 sm:p-4" onClick={() => { setShowNpcDamageModal(false); cancelDamageTypeSelection(); }}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-[95vw] sm:max-w-md w-full`} onClick={(e) => e.stopPropagation()}>
              <div className="p-3 sm:p-5 md:p-6">
                <div className="flex justify-between items-center mb-6">
                  <h3 className={`text-lg sm:text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                    Dano/Cura - {selectedNpcPokemon.species}
                  </h3>
                  <button onClick={() => { setShowNpcDamageModal(false); cancelDamageTypeSelection(); }} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                    <X size={24} />
                  </button>
                </div>

                {/* Informação de HP Atual */}
                <div className={`mb-6 p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                  <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>HP Atual</p>
                  <p className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                    {selectedNpcPokemon.currentHP !== undefined ? selectedNpcPokemon.currentHP : ((3 * selectedNpcPokemon.attributes.saude) + selectedNpcPokemon.level)} / {(3 * selectedNpcPokemon.attributes.saude) + selectedNpcPokemon.level}
                  </p>
                </div>

                {/* Input de Quantidade */}
                <div className="mb-6">
                  <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Quantidade
                  </label>
                  <input
                    type="number"
                    value={npcDamageAmount}
                    onChange={(e) => setNpcDamageAmount(e.target.value)}
                    placeholder="Digite a quantidade..."
                    className={`w-full px-3 py-2 sm:px-4 sm:py-3 border-2 rounded-lg text-sm sm:text-base text-lg ${
                      darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'border-gray-300 placeholder-gray-400'
                    }`}
                    min="1"
                    disabled={showDamageTypeButtons && pendingDamageContext === 'npcPokemon'}
                  />
                </div>

                {/* Botões de Ação */}
                {!showDamageTypeButtons || pendingDamageContext !== 'npcPokemon' ? (
                  <div className="flex flex-col sm:flex-row gap-2 sm:gap-3">
                    <button
                      onClick={() => {
                        const v = parseInt(npcDamageAmount) || 0;
                        if (v > 0) {
                          initiateDamageWithType(v, 'npcPokemon');
                        }
                      }}
                      disabled={!npcDamageAmount || parseInt(npcDamageAmount) <= 0}
                      className="w-full sm:flex-1 flex items-center justify-center gap-2 bg-gradient-to-r from-red-600 to-red-700 text-white py-2 sm:py-3 rounded-lg hover:from-red-700 hover:to-red-800 font-semibold text-sm sm:text-base disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      <Sword size={18} />
                      Aplicar Dano
                    </button>
                    <button
                      onClick={() => applyNpcDamage(false)}
                      disabled={!npcDamageAmount || parseInt(npcDamageAmount) <= 0}
                      className="w-full sm:flex-1 flex items-center justify-center gap-2 bg-gradient-to-r from-green-600 to-green-700 text-white py-2 sm:py-3 rounded-lg hover:from-green-700 hover:to-green-800 font-semibold text-sm sm:text-base disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      <Heart size={18} />
                      Curar
                    </button>
                  </div>
                ) : (
                  <div className="space-y-3">
                    <p className={`text-center text-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                      Dano: {pendingDamageValue}
                    </p>

                    {/* Multiplicadores de Dano */}
                    <div className={`p-3 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                      <p className={`text-xs font-semibold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>Multiplicadores:</p>
                      <div className="grid grid-cols-2 xs:grid-cols-4 gap-2">
                        {['x2', 'x4', '/2', '/4'].map(mult => (
                          <label key={mult} className={`flex items-center justify-center gap-1 px-2 py-1 rounded cursor-pointer transition-colors ${
                            damageMultiplier === mult
                              ? 'bg-blue-500 text-white'
                              : darkMode ? 'bg-gray-600 text-gray-200 hover:bg-gray-500' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                          }`}>
                            <input
                              type="checkbox"
                              checked={damageMultiplier === mult}
                              onChange={(e) => setDamageMultiplier(e.target.checked ? mult : null)}
                              className="hidden"
                            />
                            <span className="text-sm font-semibold">{mult}</span>
                          </label>
                        ))}
                      </div>
                    </div>

                    <p className={`text-center text-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                      Selecione o tipo de dano:
                    </p>
                    <div className="grid grid-cols-1 xs:grid-cols-3 gap-2 sm:gap-3">
                      <button
                        onClick={() => applyDamageWithType('fisico')}
                        className="flex items-center justify-center gap-2 bg-orange-500 text-white py-2 sm:py-3 rounded-lg hover:bg-orange-600 font-semibold text-sm sm:text-base"
                      >
                        <Sword size={18} />Físico
                      </button>
                      <button
                        onClick={() => applyDamageWithType('puro')}
                        className="flex items-center justify-center gap-2 bg-gray-500 text-white py-2 sm:py-3 rounded-lg hover:bg-gray-600 font-semibold text-sm sm:text-base"
                      >
                        <Minus size={18} />Puro
                      </button>
                      <button
                        onClick={() => applyDamageWithType('especial')}
                        className="flex items-center justify-center gap-2 bg-purple-500 text-white py-2 sm:py-3 rounded-lg hover:bg-purple-600 font-semibold text-sm sm:text-base"
                      >
                        <Zap size={18} />Especial
                      </button>
                    </div>
                    <button
                      onClick={cancelDamageTypeSelection}
                      className={`w-full py-2 rounded-lg font-semibold ${darkMode ? 'bg-gray-600 text-gray-200 hover:bg-gray-500' : 'bg-gray-300 text-gray-700 hover:bg-gray-400'}`}
                    >
                      Cancelar
                    </button>
                  </div>
                )}
              </div>
            </div>
          </div>
        )}

        {/* Modal de Detalhes da Habilidade */}
        {showAbilityModal && selectedAbility && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-2 sm:p-4" onClick={() => setShowAbilityModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-[95vw] sm:max-w-lg w-full max-h-[90vh] overflow-y-auto`} onClick={(e) => e.stopPropagation()}>
              <div className="p-3 sm:p-5 md:p-6">
                <div className="flex justify-between items-center mb-6">
                  <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                    {selectedAbility}
                  </h3>
                  <button onClick={() => setShowAbilityModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                    <X size={24} />
                  </button>
                </div>

                {/* Informações da Habilidade */}
                {(() => {
                  const abilityData = HABILIDADES_DATA_IMPORTED[selectedAbility]

                  if (!abilityData) {
                    return (
                      <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                        <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                          Informações da habilidade não encontradas.
                        </p>
                      </div>
                    )
                  }

                  return (
                    <div className="space-y-4">
                      {/* Ativação */}
                      {abilityData.ativacao && (
                        <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                          <h4 className={`text-sm font-bold mb-2 ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>
                            Ativação
                          </h4>
                          <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'} whitespace-pre-line`}>
                            {abilityData.ativacao}
                          </p>
                        </div>
                      )}

                      {/* Efeito */}
                      {abilityData.efeito && (
                        <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                          <h4 className={`text-sm font-bold mb-2 ${darkMode ? 'text-purple-400' : 'text-purple-600'}`}>
                            Efeito
                          </h4>
                          <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'} whitespace-pre-line`}>
                            {abilityData.efeito}
                          </p>
                        </div>
                      )}

                      {/* Tabela da Habilidade (se houver) */}
                      {abilityData.tabela && (
                        <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                          <div className="overflow-x-auto -mx-3 px-3 sm:mx-0 sm:px-0">
                            <table className={`w-full text-xs sm:text-sm border-collapse min-w-[280px] ${
                              darkMode ? 'border-gray-600' : 'border-gray-300'
                            }`}>
                              <thead>
                                <tr className={darkMode ? 'bg-gray-800' : 'bg-teal-100'}>
                                  {Object.keys(abilityData.tabela[0]).map(key => (
                                    <th key={key} className={`border p-2 font-semibold text-left ${
                                      darkMode ? 'border-gray-600 text-teal-300' : 'border-gray-300 text-teal-900'
                                    }`}>
                                      {key === 'resultado' ? 'Resultado' :
                                       key === 'efeito' ? 'Efeito' :
                                       key === 'item' ? 'Item' :
                                       key === 'clima' ? 'Clima' :
                                       key === 'tipo' ? 'Tipo' :
                                       key === 'dado' ? 'Dado' :
                                       key.charAt(0).toUpperCase() + key.slice(1)}
                                    </th>
                                  ))}
                                </tr>
                              </thead>
                              <tbody>
                                {abilityData.tabela.map((linha, idx) => (
                                  <tr key={idx} className={idx % 2 === 0
                                    ? (darkMode ? 'bg-gray-750' : 'bg-white')
                                    : (darkMode ? 'bg-gray-700' : 'bg-teal-50')
                                  }>
                                    {Object.keys(linha).map(key => (
                                      <td key={key} className={`border p-2 ${
                                        key === 'resultado'
                                          ? `font-bold ${darkMode ? 'border-gray-600 text-teal-400' : 'border-gray-300 text-teal-700'}`
                                          : `${darkMode ? 'border-gray-600 text-gray-300' : 'border-gray-300 text-gray-700'}`
                                      }`}>
                                        {linha[key]}
                                      </td>
                                    ))}
                                  </tr>
                                ))}
                              </tbody>
                            </table>
                          </div>
                        </div>
                      )}
                    </div>
                  )
                })()}
              </div>
            </div>
          </div>
        )}

        {/* Modal de Detalhes do Golpe */}
        {showGolpeDetailModal && selectedGolpeForDetail && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-2 sm:p-4">
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-[95vw] sm:max-w-md md:max-w-2xl w-full max-h-[90vh] flex flex-col`}>
              {/* Header Fixo */}
              <div className="p-3 sm:p-5 md:p-6 border-b border-gray-700">
                <div className="flex justify-between items-center">
                  <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                    {selectedGolpeForDetail}
                  </h3>
                  <button
                    onClick={() => setShowGolpeDetailModal(false)}
                    className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}
                  >
                    <X size={24} />
                  </button>
                </div>
              </div>

              {/* Conteúdo Scrollável */}
              <div className="overflow-y-auto flex-1 p-3 sm:p-5 md:p-6">
                {(() => {
                  const golpeData = GOLPES_DATA_IMPORTED[selectedGolpeForDetail]

                  if (!golpeData) {
                    return (
                      <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                        <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                          Informações do golpe não encontradas.
                        </p>
                      </div>
                    )
                  }

                  return (
                    <div className="space-y-4">
                      {/* Informações Básicas */}
                      <div className={`p-3 sm:p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                        <div className="grid grid-cols-1 xs:grid-cols-2 gap-2 sm:gap-3">
                          {golpeData.tipo && (
                            <div>
                              <h4 className={`text-xs font-bold mb-1 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Tipo</h4>
                              <p className={`text-sm font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{golpeData.tipo}</p>
                            </div>
                          )}
                          {golpeData.aptidao && (
                            <div>
                              <h4 className={`text-xs font-bold mb-1 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Aptidão</h4>
                              <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>{golpeData.aptidao}</p>
                            </div>
                          )}
                          {golpeData.danoBasal && (
                            <div>
                              <h4 className={`text-xs font-bold mb-1 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Dano Basal</h4>
                              <p className={`text-sm font-semibold ${darkMode ? 'text-red-400' : 'text-red-600'}`}>{golpeData.danoBasal}</p>
                            </div>
                          )}
                          {golpeData.acuracia && (
                            <div>
                              <h4 className={`text-xs font-bold mb-1 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Acurácia</h4>
                              <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>{golpeData.acuracia}</p>
                            </div>
                          )}
                          {golpeData.alcance && (
                            <div>
                              <h4 className={`text-xs font-bold mb-1 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Alcance</h4>
                              <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>{golpeData.alcance}</p>
                            </div>
                          )}
                          {golpeData.frequencia && (
                            <div>
                              <h4 className={`text-xs font-bold mb-1 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Frequência</h4>
                              <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>{golpeData.frequencia}</p>
                            </div>
                          )}
                          {golpeData.descritores && (
                            <div className="col-span-2">
                              <h4 className={`text-xs font-bold mb-1 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Descritores</h4>
                              <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>{golpeData.descritores}</p>
                            </div>
                          )}
                          {golpeData.tagConcurso && (
                            <div>
                              <h4 className={`text-xs font-bold mb-1 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Tag Concurso</h4>
                              <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>{golpeData.tagConcurso}</p>
                            </div>
                          )}
                        </div>
                      </div>

                      {/* Efeito */}
                      {golpeData.efeito && (
                        <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                          <h4 className={`text-sm font-bold mb-2 ${darkMode ? 'text-purple-400' : 'text-purple-600'}`}>
                            Efeito
                          </h4>
                          <div className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                            {renderGolpeEfeito(golpeData.efeito, darkMode)}
                          </div>
                        </div>
                      )}
                    </div>
                  )
                })()}
              </div>

              {/* Footer Fixo */}
              <div className="p-3 sm:p-5 md:p-6 border-t border-gray-700">
                <button
                  onClick={() => setShowGolpeDetailModal(false)}
                  className="w-full bg-gradient-to-r from-blue-600 to-purple-700 text-white py-3 rounded-lg hover:from-blue-700 hover:to-purple-800 font-semibold"
                >
                  Fechar
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Modal de Envio para Treinador */}
        {showSendToTrainerModal && pokemonToSend && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-2 sm:p-4" onClick={() => setShowSendToTrainerModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-[95vw] sm:max-w-md w-full max-h-[90vh] overflow-y-auto`} onClick={(e) => e.stopPropagation()}>
              <div className="p-3 sm:p-5 md:p-6">
                <div className="flex justify-between items-center mb-6">
                  <h3 className={`text-lg sm:text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                    Enviar Pokémon NPC
                  </h3>
                  <button onClick={() => setShowSendToTrainerModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                    <X size={24} />
                  </button>
                </div>

                {/* Imagem do Pokémon */}
                {pokemonToSend.imageUrl && (
                  <div className="flex justify-center mb-4">
                    <img src={pokemonToSend.imageUrl} alt={pokemonToSend.species} className="w-24 h-24 object-contain" />
                  </div>
                )}

                {/* Barra de Pesquisa de Espécie */}
                <div className="mb-4">
                  <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>
                    Espécie do Pokémon *
                  </label>
                  <div className="relative mb-2">
                    <Search className={`absolute left-3 top-1/2 transform -translate-y-1/2 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`} size={18} />
                    <input
                      type="text"
                      value={speciesSearchSend}
                      onChange={e => setSpeciesSearchSend(e.target.value)}
                      placeholder="Pesquisar espécie..."
                      className={`w-full pl-10 pr-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-500' : 'border-gray-300'}`}
                    />
                  </div>
                  <div className={`max-h-48 overflow-y-auto border-2 rounded-lg ${darkMode ? 'border-gray-600' : 'border-gray-300'}`}>
                    {pokedexData
                      .filter(p => speciesSearchSend === '' || p.nome.toLowerCase().includes(speciesSearchSend.toLowerCase()))
                      .slice(0, 50)
                      .map(p => (
                        <button
                          key={p.nome}
                          onClick={() => {
                            setSendPokemonSpecies(p.nome)
                            setSpeciesSearchSend('')
                          }}
                          className={`w-full px-4 py-2 text-left hover:bg-opacity-80 ${
                            sendPokemonSpecies === p.nome
                              ? darkMode ? 'bg-blue-600 text-white' : 'bg-blue-200'
                              : darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-white hover:bg-gray-100'
                          }`}
                        >
                          {p.nome}
                        </button>
                      ))}
                  </div>
                  {sendPokemonSpecies && (
                    <p className={`mt-2 text-sm ${darkMode ? 'text-green-400' : 'text-green-600'}`}>
                      ✓ Selecionado: {sendPokemonSpecies}
                    </p>
                  )}
                </div>

                {/* Barra de Pesquisa de Natureza */}
                <div className="mb-4">
                  <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>
                    Natureza do Pokémon *
                  </label>
                  <input
                    type="text"
                    placeholder="Buscar natureza..."
                    value={natureSearchSend}
                    onChange={(e) => setNatureSearchSend(e.target.value)}
                    className={`w-full px-4 py-2 border-2 rounded-lg mb-2 ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-500' : 'border-gray-300'}`}
                  />
                  <select
                    value={sendPokemonNature ? sendPokemonNature.nome : ''}
                    onChange={(e) => {
                      const selectedNature = natures.find(n => n.nome === e.target.value)
                      setSendPokemonNature(selectedNature || null)
                    }}
                    className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                  >
                    <option value="">Selecione uma natureza</option>
                    {natures
                      .filter(n => natureSearchSend === '' || n.nome.toLowerCase().includes(natureSearchSend.toLowerCase()))
                      .map((nature, idx) => (
                        <option key={idx} value={nature.nome}>
                          {nature.nome} {nature.up !== 'Nenhum' && `(↑${nature.up} ↓${nature.down})`}
                        </option>
                      ))}
                  </select>
                  {sendPokemonNature && (
                    <p className={`mt-2 text-sm ${darkMode ? 'text-green-400' : 'text-green-600'}`}>
                      ✓ Selecionado: {sendPokemonNature.nome}
                    </p>
                  )}
                </div>

                {/* Informações adicionais */}
                <div className={`mb-4 p-3 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                  <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                    Nível: <strong>{pokemonToSend.level}</strong> • Gênero: <strong>{pokemonToSend.gender}</strong>
                  </p>
                  <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                    Peso: <strong>{pokemonToSend.weight ? `${pokemonToSend.weight} kg` : 'N/A'}</strong> • Altura: <strong>{pokemonToSend.height ? `${pokemonToSend.height} m` : 'N/A'}</strong>
                  </p>
                  {pokemonToSend.shiny && (
                    <p className={`text-sm ${darkMode ? 'text-yellow-400' : 'text-yellow-600'}`}>
                      ✨ Shiny
                    </p>
                  )}
                  {(pokemonToSend.habilidade1 || pokemonToSend.habilidade2) && (
                    <div className="mt-2">
                      <p className={`text-xs font-semibold mb-1 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                        Habilidades:
                      </p>
                      <div className="flex gap-1 flex-wrap">
                        {pokemonToSend.habilidade1 && (
                          <span className={`px-2 py-0.5 text-xs rounded-lg font-semibold ${darkMode ? 'bg-blue-900 text-blue-300' : 'bg-blue-500 text-white'}`}>
                            {pokemonToSend.habilidade1}
                          </span>
                        )}
                        {pokemonToSend.habilidade2 && (
                          <span className={`px-2 py-0.5 text-xs rounded-lg font-semibold ${darkMode ? 'bg-purple-900 text-purple-300' : 'bg-purple-500 text-white'}`}>
                            {pokemonToSend.habilidade2}
                          </span>
                        )}
                      </div>
                    </div>
                  )}
                </div>

                {/* Lista de Treinadores - Enviar para Time */}
                <div className="mb-4">
                  <h4 className={`text-sm font-bold mb-3 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Enviar para o Time:
                  </h4>
                  <div className="space-y-2">
                    {users.filter(u => u.type === 'treinador').map(trainer => (
                      <button
                        key={trainer.username}
                        onClick={() => sendPokemonToTrainer(trainer.username)}
                        className={`w-full px-4 py-3 rounded-lg font-semibold text-white transition-all hover:scale-105`}
                        style={{ background: trainer.gradient }}
                      >
                        {trainer.username}
                      </button>
                    ))}
                  </div>
                </div>

                {/* Botão Cancelar */}
                <button
                  onClick={() => setShowSendToTrainerModal(false)}
                  className={`w-full py-3 rounded-lg font-semibold ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                >
                  Cancelar
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Modal de Envio de XP para Treinadores */}
        {showSendXpModal && selectedNpcPokemonForXp && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-2 sm:p-4" onClick={() => setShowSendXpModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-[95vw] sm:max-w-md w-full`} onClick={(e) => e.stopPropagation()}>
              <div className="p-3 sm:p-5 md:p-6">
                <div className="flex justify-between items-center mb-6">
                  <h3 className={`text-lg sm:text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                    Enviar XP para...
                  </h3>
                  <button onClick={() => setShowSendXpModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                    <X size={24} />
                  </button>
                </div>

                {/* Imagem e informações do Pokémon */}
                <div className="flex items-center gap-2 sm:gap-3 md:gap-4 mb-4">
                  {selectedNpcPokemonForXp.imageUrl && (
                    <img src={selectedNpcPokemonForXp.imageUrl} alt={selectedNpcPokemonForXp.species} className="w-20 h-20 object-contain" />
                  )}
                  <div>
                    <p className={`font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                      {selectedNpcPokemonForXp.species || selectedNpcPokemonForXp.name}
                    </p>
                    <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                      Nível {selectedNpcPokemonForXp.level}
                    </p>
                  </div>
                </div>

                {/* Valor de XP */}
                <div className={`mb-6 p-4 rounded-lg ${darkMode ? 'bg-yellow-900/30' : 'bg-yellow-100'}`}>
                  <p className={`text-sm ${darkMode ? 'text-yellow-400' : 'text-yellow-700'}`}>XP Concedido:</p>
                  <p className={`text-2xl sm:text-3xl font-bold ${darkMode ? 'text-yellow-300' : 'text-yellow-600'}`}>
                    {selectedNpcPokemonForXp.experience} XP
                  </p>
                  {Object.values(selectedTrainersForXp).filter(v => v).length > 1 && (
                    <p className={`text-sm mt-2 ${darkMode ? 'text-yellow-400' : 'text-yellow-700'}`}>
                      Dividido por {Object.values(selectedTrainersForXp).filter(v => v).length} treinadores: {' '}
                      <strong>{Math.floor(selectedNpcPokemonForXp.experience / Object.values(selectedTrainersForXp).filter(v => v).length)} XP</strong> cada
                    </p>
                  )}
                </div>

                {/* Checkboxes dos Treinadores */}
                <div className="mb-6">
                  <h4 className={`text-sm font-bold mb-3 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Selecione os treinadores:
                  </h4>
                  <div className="space-y-2">
                    {['Alocin', 'Lila', 'Ludovic', 'Noryat', 'Pedro'].map(trainer => {
                      const user = users.find(u => u.username === trainer)
                      return (
                        <label
                          key={trainer}
                          className={`flex items-center gap-3 p-3 rounded-lg cursor-pointer transition-all ${
                            selectedTrainersForXp[trainer]
                              ? darkMode ? 'bg-blue-900/50 border-2 border-blue-500' : 'bg-blue-100 border-2 border-blue-500'
                              : darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-100 hover:bg-gray-200'
                          }`}
                        >
                          <input
                            type="checkbox"
                            checked={selectedTrainersForXp[trainer] || false}
                            onChange={(e) => {
                              setSelectedTrainersForXp(prev => ({
                                ...prev,
                                [trainer]: e.target.checked
                              }))
                            }}
                            className="w-5 h-5 rounded"
                          />
                          <span
                            className="font-semibold text-white px-3 py-1 rounded"
                            style={{ background: user?.gradient || 'gray' }}
                          >
                            {trainer}
                          </span>
                        </label>
                      )
                    })}
                  </div>
                </div>

                {/* Botões */}
                <div className="flex flex-col sm:flex-row gap-2 sm:gap-3">
                  <button
                    onClick={() => setShowSendXpModal(false)}
                    className={`w-full sm:flex-1 py-2 sm:py-3 rounded-lg font-semibold text-sm sm:text-base ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                  >
                    Cancelar
                  </button>
                  <button
                    onClick={() => enviarXpParaTreinadores()}
                    disabled={Object.values(selectedTrainersForXp).filter(v => v).length === 0}
                    className={`w-full sm:flex-1 py-2 sm:py-3 rounded-lg font-semibold text-sm sm:text-base transition-all ${
                      Object.values(selectedTrainersForXp).filter(v => v).length === 0
                        ? 'bg-gray-400 text-gray-600 cursor-not-allowed'
                        : 'bg-gradient-to-r from-yellow-500 to-orange-500 text-white hover:from-yellow-600 hover:to-orange-600'
                    }`}
                  >
                    Salvar
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}
        </div>
        {accountDataModal}
        {scenarioPopupOverlay}
        {mostrarTriunfosOverlay}
        {pokezapPanel}{pokeAgendaPanel}
        {batalhaChatPanel}
      </>
    )
  }

  // ÁREA NPCs ARQUIVADOS (MESTRE)
  if (currentUser.type === 'mestre' && currentArea === 'NPCs Arquivados') {
    return (
      <>
        <div className={`min-h-screen ${mainBgClass}`}>
          {sidebarNav}
        <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-lg`}>
          <div className="max-w-7xl mx-auto px-4 py-4">
            <div className="flex justify-between items-center mb-4">
              <div className="flex items-center gap-3"><button onClick={() => setSidebarOpen(true)} className={`p-2 rounded-lg ${darkMode ? "hover:bg-gray-700 text-gray-400" : "hover:bg-gray-200 text-gray-500"}`}><Menu size={24} /></button><h2 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>NPCs Arquivados 👑</h2></div>
              <div className="flex gap-2">
                <button onClick={() => setShowAccountDataModal(true)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-200 text-gray-700'}`} title="Dados da Conta"><ArrowDownUp size={20} /></button>
                <button onClick={() => setDarkMode(!darkMode)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-yellow-400' : 'bg-gray-200 text-gray-700'}`}>{darkMode ? <Sun size={20} /> : <Moon size={20} />}</button>
                {pokezapBtn}{pokeAgendaBtn}{batalhaChatBtn}<button onClick={handleLogout} className="bg-red-500 text-white px-3 sm:px-5 md:px-6 py-2 rounded-lg hover:bg-red-600">Sair</button>
              </div>
            </div>
          </div>
        </div>

          <div className="max-w-7xl mx-auto px-4 py-3 sm:py-5 md:py-8">
            {/* Seção Treinadores NPC Arquivados */}
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-6 mb-8`}>
              <h3 className={`text-lg sm:text-xl font-bold mb-4 flex items-center gap-2 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                <Archive size={24} className="text-amber-500" />
                Treinadores NPC Arquivados ({archivedNpcTrainers.length})
              </h3>

              {archivedNpcTrainers.length === 0 ? (
                <div className={`text-center py-3 sm:py-5 md:py-8 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                  <p>Nenhum treinador NPC arquivado ainda.</p>
                  <p className="text-sm mt-2">Use o botão de arquivar na área Treinador NPC para salvar treinadores aqui.</p>
                </div>
              ) : (
                <div className="grid grid-cols-1 md:grid-cols-2 gap-2 sm:gap-3 md:gap-4">
                  {archivedNpcTrainers.map(npc => (
                    <div key={npc.id} className={`p-3 sm:p-4 md:p-5 rounded-lg border-2 ${darkMode ? 'bg-gray-700 border-amber-500' : 'bg-amber-50 border-amber-300'}`}>
                      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-4">
                        <div className="flex items-center gap-2 sm:gap-3 flex-wrap">
                          <h3 className={`text-lg sm:text-xl md:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{npc.name}</h3>
                          {npc.isRandom && npc.caracteristicasETalentos && (
                            <button
                              onClick={() => {
                                setSelectedNPCForTalentos(npc)
                                setShowNPCTalentosModal(true)
                              }}
                              className="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-2 sm:px-3 py-1 rounded-lg hover:from-purple-700 hover:to-pink-700 font-semibold text-xs sm:text-sm whitespace-nowrap"
                              title="Ver Características e Talentos"
                            >
                              Talento R NPC
                            </button>
                          )}
                          {!npc.isRandom && npc.caracteristicasETalentos && npc.caracteristicasETalentos.length > 0 && (
                            <button
                              onClick={() => {
                                setSelectedNPCForTalentos(npc)
                                setShowNPCTalentosModal(true)
                              }}
                              className="bg-gradient-to-r from-blue-600 to-cyan-600 text-white px-2 sm:px-3 py-1 rounded-lg hover:from-blue-700 hover:to-cyan-700 font-semibold text-xs sm:text-sm whitespace-nowrap"
                              title="Ver Características e Talentos"
                            >
                              Treinador T Personalizado
                            </button>
                          )}
                        </div>
                        <div className="flex gap-1.5 sm:gap-2">
                          <button
                            onClick={() => sendNpcTrainerToBattle(npc)}
                            className="bg-cyan-500 text-white p-1.5 sm:p-2 rounded hover:bg-cyan-600"
                            title="Enviar para Batalha Treinador NPC"
                          >
                            <PlusCircle size={16} className="sm:w-[18px] sm:h-[18px]" />
                          </button>
                          <button
                            onClick={() => unarchiveNpcTrainer(npc)}
                            className="bg-green-500 text-white p-1.5 sm:p-2 rounded hover:bg-green-600"
                            title="Restaurar para área Treinador NPC"
                          >
                            <RotateCcw size={16} className="sm:w-[18px] sm:h-[18px]" />
                          </button>
                          <button
                            onClick={() => removeArchivedNpcTrainer(npc.id)}
                            className="bg-red-500 text-white p-1.5 sm:p-2 rounded hover:bg-red-600"
                            title="Remover permanentemente"
                          >
                            <Trash2 size={16} className="sm:w-[18px] sm:h-[18px]" />
                          </button>
                        </div>
                      </div>

                      <div className={`mb-4 text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                        <p className="mb-2"><span className="font-semibold">Nível:</span> {npc.level}</p>
                        <p className="mb-2"><span className="font-semibold">Vida:</span> {npc.currentHP}/{npc.hp}</p>
                      </div>

                      {/* Tabela de Atributos */}
                      <div className="mb-4">
                        <h4 className={`font-bold mb-2 text-xs sm:text-sm ${darkMode ? 'text-amber-400' : 'text-amber-600'}`}>Atributos</h4>
                        <div className="overflow-x-auto -mx-3 px-3 sm:mx-0 sm:px-0">
                          <table className={`w-full text-xs sm:text-sm min-w-[280px] ${darkMode ? 'bg-gray-600' : 'bg-white'}`}>
                            <thead>
                              <tr className={darkMode ? 'bg-gray-500' : 'bg-gray-200'}>
                                <th className={`border p-1.5 sm:p-2 text-left ${darkMode ? 'border-gray-400' : 'border-gray-300'}`}>Atributo</th>
                                <th className={`border p-1.5 sm:p-2 text-center ${darkMode ? 'border-gray-400' : 'border-gray-300'}`}>Valor</th>
                                <th className={`border p-1.5 sm:p-2 text-center ${darkMode ? 'border-gray-400' : 'border-gray-300'}`}>Modificador</th>
                              </tr>
                            </thead>
                            <tbody className={darkMode ? 'text-gray-200' : 'text-gray-800'}>
                              <tr><td className={`border p-1.5 sm:p-2 ${darkMode ? 'border-gray-400' : 'border-gray-300'}`}>Saúde</td><td className={`border p-1.5 sm:p-2 text-center ${darkMode ? 'border-gray-400' : 'border-gray-300'}`}>{npc.attributes.saude}</td><td className={`border p-1.5 sm:p-2 text-center ${darkMode ? 'border-gray-400' : 'border-gray-300'}`}>{npc.modifiers.saude}</td></tr>
                              <tr><td className={`border p-1.5 sm:p-2 ${darkMode ? 'border-gray-400' : 'border-gray-300'}`}>Ataque</td><td className={`border p-1.5 sm:p-2 text-center ${darkMode ? 'border-gray-400' : 'border-gray-300'}`}>{npc.attributes.ataque}</td><td className={`border p-1.5 sm:p-2 text-center ${darkMode ? 'border-gray-400' : 'border-gray-300'}`}>{npc.modifiers.ataque}</td></tr>
                              <tr><td className={`border p-1.5 sm:p-2 ${darkMode ? 'border-gray-400' : 'border-gray-300'}`}>Defesa</td><td className={`border p-1.5 sm:p-2 text-center ${darkMode ? 'border-gray-400' : 'border-gray-300'}`}>{npc.attributes.defesa}</td><td className={`border p-1.5 sm:p-2 text-center ${darkMode ? 'border-gray-400' : 'border-gray-300'}`}>{npc.modifiers.defesa}</td></tr>
                              <tr><td className={`border p-1.5 sm:p-2 ${darkMode ? 'border-gray-400' : 'border-gray-300'}`}>Ataque Especial</td><td className={`border p-1.5 sm:p-2 text-center ${darkMode ? 'border-gray-400' : 'border-gray-300'}`}>{npc.attributes.ataqueEspecial}</td><td className={`border p-1.5 sm:p-2 text-center ${darkMode ? 'border-gray-400' : 'border-gray-300'}`}>{npc.modifiers.ataqueEspecial}</td></tr>
                              <tr><td className={`border p-1.5 sm:p-2 ${darkMode ? 'border-gray-400' : 'border-gray-300'}`}>Defesa Especial</td><td className={`border p-1.5 sm:p-2 text-center ${darkMode ? 'border-gray-400' : 'border-gray-300'}`}>{npc.attributes.defesaEspecial}</td><td className={`border p-1.5 sm:p-2 text-center ${darkMode ? 'border-gray-400' : 'border-gray-300'}`}>{npc.modifiers.defesaEspecial}</td></tr>
                              <tr><td className={`border p-1.5 sm:p-2 ${darkMode ? 'border-gray-400' : 'border-gray-300'}`}>Velocidade</td><td className={`border p-1.5 sm:p-2 text-center ${darkMode ? 'border-gray-400' : 'border-gray-300'}`}>{npc.attributes.velocidade}</td><td className={`border p-1.5 sm:p-2 text-center ${darkMode ? 'border-gray-400' : 'border-gray-300'}`}>{npc.modifiers.velocidade}</td></tr>
                            </tbody>
                          </table>
                        </div>
                      </div>

                      {/* Deslocamento */}
                      <div className="mb-4">
                        <h4 className={`font-bold mb-2 text-xs sm:text-sm ${darkMode ? 'text-amber-400' : 'text-amber-600'}`}>Deslocamento</h4>
                        <div className={`grid grid-cols-1 xs:grid-cols-3 gap-1.5 sm:gap-2 text-xs sm:text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                          <div className={`p-1.5 sm:p-2 rounded ${darkMode ? 'bg-gray-600' : 'bg-gray-100'}`}><span className="font-semibold">Terrestre:</span> {npc.displacement.terrestre}</div>
                          <div className={`p-1.5 sm:p-2 rounded ${darkMode ? 'bg-gray-600' : 'bg-gray-100'}`}><span className="font-semibold">Natação:</span> {npc.displacement.natacao}</div>
                          <div className={`p-1.5 sm:p-2 rounded ${darkMode ? 'bg-gray-600' : 'bg-gray-100'}`}><span className="font-semibold">Subaquático:</span> {npc.displacement.subaquatico}</div>
                        </div>
                      </div>

                      {/* Evasão */}
                      <div>
                        <h4 className={`font-bold mb-2 text-xs sm:text-sm ${darkMode ? 'text-amber-400' : 'text-amber-600'}`}>Evasão</h4>
                        <div className={`grid grid-cols-1 xs:grid-cols-3 gap-1.5 sm:gap-2 text-xs sm:text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                          <div className={`p-1.5 sm:p-2 rounded ${darkMode ? 'bg-gray-600' : 'bg-gray-100'}`}><span className="font-semibold">Física:</span> {npc.evasion.fisica}</div>
                          <div className={`p-1.5 sm:p-2 rounded ${darkMode ? 'bg-gray-600' : 'bg-gray-100'}`}><span className="font-semibold">Especial:</span> {npc.evasion.especial}</div>
                          <div className={`p-1.5 sm:p-2 rounded ${darkMode ? 'bg-gray-600' : 'bg-gray-100'}`}><span className="font-semibold">Veloz:</span> {npc.evasion.veloz}</div>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>

            {/* Seção Pokémon NPC Arquivados */}
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-6`}>
              <h3 className={`text-lg sm:text-xl font-bold mb-4 flex items-center gap-2 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                <Archive size={24} className="text-amber-500" />
                Pokémon NPC Arquivados ({archivedNpcPokemon.length})
              </h3>

              {archivedNpcPokemon.length === 0 ? (
                <div className={`text-center py-3 sm:py-5 md:py-8 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                  <p>Nenhum Pokémon NPC arquivado ainda.</p>
                  <p className="text-sm mt-2">Use o botão de arquivar na área Pokémon NPC para salvar pokémons aqui.</p>
                </div>
              ) : (
                <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-2 sm:gap-3 md:gap-4">
                  {archivedNpcPokemon.map(pokemon => {
                    const isExpanded = expandedNpcCards.includes(pokemon.id)

                    return (
                      <div
                        key={pokemon.id}
                        className={`${darkMode ? 'bg-gray-700' : 'bg-amber-50'} rounded-2xl shadow-lg overflow-hidden transition-all border-2 ${darkMode ? 'border-amber-500' : 'border-amber-300'} ${
                          isExpanded ? 'col-span-2 sm:col-span-2 md:col-span-2 lg:col-span-3 xl:col-span-3' : ''
                        }`}
                      >
                        {!isExpanded ? (
                          // Card compacto - apenas imagem
                          <div className="relative group">
                            <div
                              onClick={() => toggleNpcCard(pokemon.id)}
                              className="cursor-pointer p-3 sm:p-4 flex flex-col items-center"
                            >
                              {pokemon.imageUrl && (
                                <img
                                  src={pokemon.imageUrl}
                                  alt={pokemon.name || pokemon.species}
                                  className="w-20 h-20 sm:w-24 sm:h-24 md:w-28 md:h-28 object-contain mb-2"
                                />
                              )}
                              <p className={`text-sm font-bold text-center ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                {pokemon.species || pokemon.name || 'Pokémon'} {pokemon.shiny && '✨'} {pokemon.legendary && '👑'}
                              </p>
                              <div className="flex items-center gap-1 mt-1">
                                <p className={`text-xs text-center ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                  Nível {pokemon.level}
                                </p>
                                {(pokemon.habilidade1 || pokemon.habilidade2) && (
                                  <div className="flex gap-1">
                                    {pokemon.habilidade1 && (
                                      <span className={`px-1.5 py-0.5 rounded text-[10px] font-semibold ${darkMode ? 'bg-blue-900 text-blue-300' : 'bg-blue-500 text-white'}`}>
                                        {pokemon.habilidade1}
                                      </span>
                                    )}
                                    {pokemon.habilidade2 && (
                                      <span className={`px-1.5 py-0.5 rounded text-[10px] font-semibold ${darkMode ? 'bg-purple-900 text-purple-300' : 'bg-purple-500 text-white'}`}>
                                        {pokemon.habilidade2}
                                      </span>
                                    )}
                                  </div>
                                )}
                              </div>
                            </div>
                            <div className="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                              <button
                                onClick={(e) => {
                                  e.stopPropagation()
                                  sendNpcPokemonToBattle(pokemon)
                                }}
                                className="bg-cyan-500 text-white p-1.5 rounded-lg hover:bg-cyan-600"
                                title="Enviar para Batalha"
                              >
                                <ArrowRightCircle size={14} />
                              </button>
                              <button
                                onClick={(e) => {
                                  e.stopPropagation()
                                  sendNpcToGBBattle(pokemon)
                                }}
                                className="bg-green-600 text-white p-1.5 rounded-lg hover:bg-green-700"
                                title="Enviar para Batalha Game Boy"
                              >
                                <Gamepad2 size={14} />
                              </button>
                              <button
                                onClick={(e) => {
                                  e.stopPropagation()
                                  unarchiveNpcPokemon(pokemon)
                                }}
                                className="bg-green-500 text-white p-1.5 rounded-lg hover:bg-green-600"
                                title="Restaurar para área Pokémon NPC"
                              >
                                <RotateCcw size={14} />
                              </button>
                              <button
                                onClick={(e) => {
                                  e.stopPropagation()
                                  removeArchivedNpcPokemon(pokemon.id)
                                }}
                                className="bg-red-500 text-white p-1.5 rounded-lg hover:bg-red-600"
                                title="Remover permanentemente"
                              >
                                <Trash2 size={14} />
                              </button>
                            </div>
                          </div>
                        ) : (
                          // Card expandido - todas as informações
                          <div className="p-3 sm:p-4">
                            <div className="flex flex-col xs:flex-row justify-between items-start gap-2 mb-3">
                              <div
                                onClick={() => toggleNpcCard(pokemon.id)}
                                className="cursor-pointer flex-1 w-full xs:w-auto"
                              >
                                {pokemon.imageUrl && (
                                  <div className="flex justify-center mb-2">
                                    <img
                                      src={pokemon.imageUrl}
                                      alt={pokemon.name || pokemon.species}
                                      className="w-16 h-16 sm:w-20 sm:h-20 object-contain"
                                    />
                                  </div>
                                )}
                                <div className="text-center mb-2">
                                  <p className={`text-sm font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                    {pokemon.species || pokemon.name} {pokemon.shiny && '✨'} {pokemon.legendary && '👑'}
                                  </p>
                                  <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                    #{String(pokemon.dexNumber).padStart(4, '0')} • Nível {pokemon.level}
                                  </p>
                                </div>
                              </div>
                              <div className="flex gap-2">
                                <button
                                  onClick={() => sendNpcPokemonToBattle(pokemon)}
                                  className="bg-cyan-500 text-white p-1.5 rounded-lg hover:bg-cyan-600"
                                  title="Enviar para Batalha"
                                >
                                  <ArrowRightCircle size={14} />
                                </button>
                                <button
                                  onClick={() => unarchiveNpcPokemon(pokemon)}
                                  className="bg-green-500 text-white p-1.5 rounded-lg hover:bg-green-600"
                                  title="Restaurar para área Pokémon NPC"
                                >
                                  <RotateCcw size={14} />
                                </button>
                                <button
                                  onClick={() => removeArchivedNpcPokemon(pokemon.id)}
                                  className="bg-red-500 text-white p-1.5 rounded-lg hover:bg-red-600"
                                  title="Remover permanentemente"
                                >
                                  <Trash2 size={14} />
                                </button>
                              </div>
                            </div>

                            {/* Condições de Captura */}
                            <div className="mb-2">
                              <h4 className={`text-xs font-semibold mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Condições</h4>
                              <div className="grid grid-cols-3 xs:grid-cols-4 sm:grid-cols-5 gap-1">
                                {[
                                  { key: 'confusao', icon: BadgeHelp, color: 'text-purple-400', label: 'Confusão' },
                                  { key: 'critico', icon: Clover, color: 'text-green-600', label: 'Crítico' },
                                  { key: 'paralisia', icon: Zap, color: 'text-yellow-500', label: 'Paralisia' },
                                  { key: 'sono', icon: Moon, color: 'text-blue-500', label: 'Sono' },
                                  { key: 'atordoamento', icon: Shell, color: 'text-gray-500', label: 'Atordoamento' },
                                  { key: 'congelamento', icon: Snowflake, color: 'text-blue-400', label: 'Congelamento' },
                                  { key: 'paixao', icon: Heart, color: 'text-red-500', label: 'Paixão' },
                                  { key: 'queimadura', icon: Flame, color: 'text-orange-500', label: 'Queimadura' },
                                  { key: 'veneno', icon: Droplet, color: 'text-purple-600', label: 'Veneno' }
                                ].map(condition => {
                                  const Icon = condition.icon
                                  const isChecked = npcConditions[pokemon.id]?.[condition.key] || false
                                  return (
                                    <label key={condition.key} className="flex items-center gap-1 cursor-pointer">
                                      <input
                                        type="checkbox"
                                        checked={isChecked}
                                        onChange={() => toggleNpcCondition(pokemon.id, condition.key)}
                                        className="w-3 h-3"
                                      />
                                      <Icon size={14} className={condition.color} title={condition.label} />
                                    </label>
                                  )
                                })}
                              </div>
                            </div>

                            {/* Tipos e Habilidades */}
                            <div className="mb-2">
                              <h4 className={`text-xs font-semibold mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Tipos & Habilidades</h4>
                              <div className="flex items-center justify-between mb-2">
                                <div className="flex gap-1 flex-wrap">
                                  {pokemon.types.map((type, idx) => (
                                    <span key={idx} className="px-2 py-0.5 text-xs rounded-lg bg-gradient-to-r from-amber-600 to-yellow-700 text-white font-semibold">
                                      {type}
                                    </span>
                                  ))}
                                  {pokemon.habilidade1 && (
                                    <span
                                      onClick={() => {
                                        setSelectedAbility(pokemon.habilidade1)
                                        setShowAbilityModal(true)
                                      }}
                                      className={`px-2 py-0.5 text-xs rounded-lg font-semibold cursor-pointer hover:opacity-80 transition-opacity ${darkMode ? 'bg-blue-900 text-blue-300' : 'bg-blue-500 text-white'}`}>
                                      {pokemon.habilidade1}
                                    </span>
                                  )}
                                  {pokemon.habilidade2 && (
                                    <span
                                      onClick={() => {
                                        setSelectedAbility(pokemon.habilidade2)
                                        setShowAbilityModal(true)
                                      }}
                                      className={`px-2 py-0.5 text-xs rounded-lg font-semibold cursor-pointer hover:opacity-80 transition-opacity ${darkMode ? 'bg-purple-900 text-purple-300' : 'bg-purple-500 text-white'}`}>
                                      {pokemon.habilidade2}
                                    </span>
                                  )}
                                </div>
                              </div>
                              <div className="flex justify-end">
                                <div className={`px-3 py-1 rounded-lg font-bold text-sm ${
                                  calculateCaptureValue(pokemon) >= 0
                                    ? 'bg-green-600 text-white'
                                    : 'bg-red-600 text-white'
                                }`}>
                                  Captura: {calculateCaptureValue(pokemon) >= 0 ? '+' : ''}{calculateCaptureValue(pokemon)}
                                </div>
                              </div>
                            </div>

                            {/* HP */}
                            <div className="mb-2">
                              <h4 className={`text-xs font-semibold mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>HP</h4>
                              <div className="flex items-center gap-2">
                                <div className="flex-1 h-3 bg-gray-300 rounded-full overflow-hidden">
                                  <div
                                    className={`h-full transition-all ${
                                      (pokemon.currentHP / pokemon.hp) > 0.5 ? 'bg-green-500' :
                                      (pokemon.currentHP / pokemon.hp) > 0.25 ? 'bg-yellow-500' : 'bg-red-500'
                                    }`}
                                    style={{ width: `${Math.max(0, (pokemon.currentHP / pokemon.hp) * 100)}%` }}
                                  />
                                </div>
                                <span className={`text-xs font-bold ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                  {pokemon.currentHP}/{pokemon.hp}
                                </span>
                              </div>
                            </div>

                            {/* Atributos */}
                            <div className="mb-2">
                              <h4 className={`text-xs font-semibold mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Atributos</h4>
                              <div className="grid grid-cols-2 xs:grid-cols-3 gap-1 text-[10px]">
                                <div className={`p-1 rounded ${darkMode ? 'bg-gray-600' : 'bg-gray-100'}`}>
                                  <span className="font-semibold">ATK:</span> {pokemon.totalAttributes?.ataque || pokemon.ataque}
                                </div>
                                <div className={`p-1 rounded ${darkMode ? 'bg-gray-600' : 'bg-gray-100'}`}>
                                  <span className="font-semibold">DEF:</span> {pokemon.totalAttributes?.defesa || pokemon.defesa}
                                </div>
                                <div className={`p-1 rounded ${darkMode ? 'bg-gray-600' : 'bg-gray-100'}`}>
                                  <span className="font-semibold">ATK.E:</span> {pokemon.totalAttributes?.ataqueEspecial || pokemon.ataqueEspecial}
                                </div>
                                <div className={`p-1 rounded ${darkMode ? 'bg-gray-600' : 'bg-gray-100'}`}>
                                  <span className="font-semibold">DEF.E:</span> {pokemon.totalAttributes?.defesaEspecial || pokemon.defesaEspecial}
                                </div>
                                <div className={`p-1 rounded ${darkMode ? 'bg-gray-600' : 'bg-gray-100'}`}>
                                  <span className="font-semibold">VEL:</span> {pokemon.totalAttributes?.velocidade || pokemon.velocidade}
                                </div>
                              </div>
                            </div>

                            {/* Golpes */}
                            {pokemon.golpes && pokemon.golpes.length > 0 && (
                              <div>
                                <h4 className={`text-xs font-semibold mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Golpes</h4>
                                <div className="flex flex-wrap gap-1">
                                  {pokemon.golpes.filter(g => g).map((golpe, idx) => {
                                    const golpeNome = typeof golpe === 'string' ? golpe : golpe?.nome
                                    return golpeNome ? (
                                      <span
                                        key={idx}
                                        onClick={() => {
                                          const golpeData = GOLPES_DATA_IMPORTED[golpeNome]
                                          if (golpeData) {
                                            setSelectedBattleMove(golpeData)
                                            setShowBattleMoveModal(true)
                                          }
                                        }}
                                        className={`px-2 py-0.5 text-[10px] rounded-lg font-semibold cursor-pointer hover:opacity-80 transition-opacity ${darkMode ? 'bg-gray-600 text-gray-200' : 'bg-gray-200 text-gray-700'}`}
                                      >
                                        {golpeNome}
                                      </span>
                                    ) : null
                                  })}
                                </div>
                              </div>
                            )}
                          </div>
                        )}
                      </div>
                    )
                  })}
                </div>
              )}
            </div>
          </div>
        </div>
        {accountDataModal}
        {scenarioPopupOverlay}
        {mostrarTriunfosOverlay}
        {pokezapPanel}{pokeAgendaPanel}
        {batalhaChatPanel}
      </>
    )
  }

  // ÁREA BATALHA
  if (currentUser.type === 'mestre' && currentArea === 'Batalha') {
    // Garantir que os estados existem
    const safeTrainers = Array.isArray(battleTrainers) ? battleTrainers : []
    const safePokemon = Array.isArray(battlePokemon) ? battlePokemon : []
    const safeTrainersList = Array.isArray(battleTrainersList) ? battleTrainersList : []
    const safePokemonList = Array.isArray(battlePokemonList) ? battlePokemonList : []

    return (
      <>
        <div className={`min-h-screen ${mainBgClass}`}>
          {sidebarNav}
        <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-lg`}>
          <div className="max-w-7xl mx-auto px-4 py-4">
            <div className="flex justify-between items-center mb-4">
              <div className="flex items-center gap-3"><button onClick={() => setSidebarOpen(true)} className={`p-2 rounded-lg ${darkMode ? "hover:bg-gray-700 text-gray-400" : "hover:bg-gray-200 text-gray-500"}`}><Menu size={24} /></button><h2 className={`text-lg sm:text-xl md:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Batalha 👑</h2></div>
              <div className="flex gap-1.5 sm:gap-2 items-center flex-shrink-0">
                <button onClick={() => setShowAccountDataModal(true)} className={`p-1.5 sm:p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-200 text-gray-700'}`} title="Dados da Conta"><ArrowDownUp size={18} className="sm:w-5 sm:h-5" /></button>
                <button onClick={() => setDarkMode(!darkMode)} className={`p-1.5 sm:p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-yellow-400' : 'bg-gray-200 text-gray-700'}`}>{darkMode ? <Sun size={18} className="sm:w-5 sm:h-5" /> : <Moon size={18} className="sm:w-5 sm:h-5" />}</button>
                {pokezapBtn}{pokeAgendaBtn}{batalhaChatBtn}<button onClick={handleLogout} className="bg-red-500 text-white px-2 sm:px-5 md:px-6 py-1.5 sm:py-2 rounded-lg hover:bg-red-600 text-sm sm:text-base">Sair</button>
              </div>
            </div>
          </div>
        </div>

        <div className="max-w-7xl mx-auto px-4 py-3 sm:py-5 md:py-8">
          {/* Navegação Mapa/Rolagens (Mestre) */}
          <div className="mb-6 flex gap-2 sm:gap-3 md:gap-4 justify-center">
            <button
              onClick={() => setBattleView('mapa')}
              className={`px-3 sm:px-5 md:px-6 py-3 rounded-lg font-semibold transition-all ${
                battleView === 'mapa'
                  ? 'bg-gradient-to-r from-green-600 to-teal-600 text-white shadow-lg'
                  : darkMode
                  ? 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                  : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
              }`}
            >
              Mapa Mestre
            </button>
            <button
              onClick={() => setBattleView('rolagens')}
              className={`px-3 sm:px-5 md:px-6 py-3 rounded-lg font-semibold transition-all ${
                battleView === 'rolagens'
                  ? 'bg-gradient-to-r from-blue-600 to-purple-700 text-white shadow-lg'
                  : darkMode
                  ? 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                  : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
              }`}
            >
              Rolagens Mestre
            </button>
          </div>

          {/* Botão Limpar Lista e Envios */}
          {battleView === 'rolagens' && (
          <div className="mb-6 flex justify-center">
            <button
              onClick={async () => {
                setBattleTrainers([])
                setBattlePokemon([])
                setBattleTrainersList([])
                setBattlePokemonList([])
                setCurrentTrainerTurn(0)
                setCurrentPokemonTurn(0)
                setTrainerRound(1)
                setPokemonRound(1)
                setBattlePokemonConditions({})
                setBattleTrainerConditions({})
                setPokemonStages({})
                setTrainerStages({})
                // Salvar no Firebase
                if (useFirebase) {
                  await saveBattleData({
                    battleTrainers: [],
                    battlePokemon: [],
                    battleTrainersList: [],
                    battlePokemonList: [],
                    currentTrainerTurn: 0,
                    currentPokemonTurn: 0,
                    trainerRound: 1,
                    pokemonRound: 1,
                    battlePokemonConditions: {},
                    battleTrainerConditions: {},
                    revealedNpcPokemon: {},
                    revealedTrainers: {}
                  })
                  await savePokemonStages({})
                  await saveTrainerStages({})
                }
              }}
              className="bg-red-600 text-white px-3 sm:px-5 md:px-6 py-3 rounded-lg hover:bg-red-700 font-semibold flex items-center gap-2"
            >
              <X size={20} />
              Limpar Lista e Envios
            </button>
          </div>
          )}

          {/* Layout de Duas Colunas */}
          {battleView === 'rolagens' && (
          <div className="grid grid-cols-1 md:grid-cols-2 gap-3 sm:p-5 md:p-6">

            {/* TRACKER TREINADORES */}
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-6`}>
              <h3 className={`text-xl sm:text-2xl font-bold mb-6 text-center ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>
                Tracker Treinadores
              </h3>

              {/* Box de Enviados */}
              <div className="mb-6">
                <h4 className={`text-lg font-semibold mb-3 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  Enviados ({safeTrainers.length})
                </h4>
                <div className={`p-4 rounded-lg border-2 min-h-[150px] max-h-[200px] overflow-y-auto ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-gray-50 border-gray-300'}`}>
                  {safeTrainers.length === 0 ? (
                    <p className={`text-center ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                      Nenhum treinador enviado
                    </p>
                  ) : (
                    <div className="space-y-2">
                      {safeTrainers.map(trainer => {
                        const evasoes = calcularEvasoes(
                          trainer.baseAttributes?.defesa || 0,
                          trainer.baseAttributes?.defesaEspecial || 0,
                          trainer.baseAttributes?.velocidade || trainer.velocidade || 0,
                          null,
                          true
                        )
                        return (
                          <div key={trainer.id} className={`p-3 rounded-lg ${darkMode ? 'bg-gray-600' : 'bg-white'} border ${darkMode ? 'border-gray-500' : 'border-gray-300'}`}>
                            <div className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{trainer.nome}</div>
                            <div className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                              HP: {trainer.hp}/{trainer.maxHP} | Vel: {trainer.velocidade}
                            </div>
                            <div className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                              Evasões - F: {evasoes.evasaoFisica} | E: {evasoes.evasaoEspecial} | V: {evasoes.evasaoVeloz}
                            </div>
                          </div>
                        )
                      })}
                    </div>
                  )}
                </div>
              </div>

              {/* Botões de Controle */}
              <div className="flex gap-2 sm:gap-3 mb-6">
                <button
                  onClick={mountTrainerBattle}
                  className="flex-1 bg-purple-600 text-white px-2 sm:px-4 py-2 sm:py-3 rounded-lg hover:bg-purple-700 font-semibold flex items-center justify-center gap-1 sm:gap-2 text-xs sm:text-sm"
                >
                  <HandMetal size={16} className="sm:w-5 sm:h-5" />
                  Montar Batalha
                </button>
                <button
                  onClick={addToTrainerBattle}
                  className="flex-1 bg-green-600 text-white px-2 sm:px-4 py-2 sm:py-3 rounded-lg hover:bg-green-700 font-semibold flex items-center justify-center gap-1 sm:gap-2 text-xs sm:text-sm"
                >
                  <MapPin size={16} className="sm:w-5 sm:h-5" />
                  Adicionar
                </button>
              </div>

              {/* Box Em Batalha */}
              <div>
                <div className="flex items-center justify-between mb-3">
                  <h4 className={`text-lg font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                    Em Batalha - Rodada {trainerRound}
                  </h4>
                  {safeTrainersList.length > 0 && (
                    <button
                      onClick={advanceTrainerTurn}
                      className="bg-blue-600 text-white px-3 py-1 rounded-lg hover:bg-blue-700 font-semibold text-sm"
                    >
                      Avançar Turno
                    </button>
                  )}
                </div>
                <div className={`p-4 rounded-lg border-2 min-h-[250px] max-h-[400px] overflow-y-auto ${darkMode ? 'bg-gray-700 border-blue-500' : 'bg-blue-50 border-blue-300'}`}>
                  {safeTrainersList.length === 0 ? (
                    <p className={`text-center ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                      Nenhum treinador em batalha
                    </p>
                  ) : (
                    <div className="space-y-2">
                      {safeTrainersList.map((trainer, idx) => {
                        const trainerConditions = battleTrainerConditions[trainer.id] || [null, null, null]
                        const stages = trainerStages[trainer.id] || { ataque: 0, ataqueEspecial: 0, defesa: 0, defesaEspecial: 0, velocidade: 0, precisao: 0 }

                        return (
                          <div
                            key={trainer.id}
                            className={`p-3 rounded-lg border-2 ${
                              idx === currentTrainerTurn
                                ? darkMode ? 'bg-yellow-900 border-yellow-500' : 'bg-yellow-100 border-yellow-500'
                                : darkMode ? 'bg-gray-600 border-gray-500' : 'bg-white border-gray-300'
                            }`}
                          >
                            <div className="flex items-center justify-between">
                              <div className={`font-semibold ${idx === currentTrainerTurn ? 'text-yellow-600' : darkMode ? 'text-white' : 'text-gray-800'}`}>
                                {idx === currentTrainerTurn && '▶ '}{trainer.nome}
                              </div>
                              <div className="flex items-center gap-2">
                                <span className={`text-xs px-2 py-1 rounded ${darkMode ? 'bg-gray-700 text-gray-300' : 'bg-gray-200 text-gray-600'}`}>
                                  Vel: {trainer.velocidade}
                                </span>
                                <button
                                  onClick={() => removeTrainerFromBattle(trainer.id)}
                                  className="p-1 rounded hover:bg-red-600 transition-colors bg-red-500 text-white"
                                  title="Remover da batalha"
                                >
                                  <Trash2 size={14} />
                                </button>
                              </div>
                            </div>
                            <div className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                              HP: {trainer.hp}/{trainer.maxHP}
                            </div>
                            {(() => {
                              const evasoes = calcularEvasoes(
                                trainer.baseAttributes?.defesa || 0,
                                trainer.baseAttributes?.defesaEspecial || 0,
                                trainer.baseAttributes?.velocidade || trainer.velocidade || 0,
                                stages,
                                true
                              )
                              return (
                                <div className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                                  Evasões - F: {evasoes.evasaoFisica} | E: {evasoes.evasaoEspecial} | V: {evasoes.evasaoVeloz}
                                </div>
                              )
                            })()}

                            {/* Botão Dano/Cura NPC Treinador */}
                            {trainer.isNpc && (
                              <button
                                onClick={() => {
                                  setSelectedNpcTrainerForDamage(trainer)
                                  setShowNpcTrainerBattleDamageModal(true)
                                }}
                                className={`w-full mt-2 flex items-center justify-center gap-1 py-2 rounded-lg font-semibold text-sm ${darkMode ? 'bg-gradient-to-r from-red-700 to-green-700 hover:from-red-600 hover:to-green-600' : 'bg-gradient-to-r from-red-500 to-green-500 hover:from-red-600 hover:to-green-600'} text-white`}
                              >
                                <Sword size={14} />
                                Dano/Cura
                                <Heart size={14} />
                              </button>
                            )}

                            {/* Botões Acurácia e Dano NPC Treinador */}
                            {trainer.isNpc && (
                              <div className="flex gap-2 mt-2">
                                <button
                                  onClick={() => {
                                    const d20Roll = Math.floor(Math.random() * 20) + 1
                                    const timestamp = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })

                                    // Obter fase de precisão do treinador NPC
                                    const trainerNpcStages = trainerStages[trainer.id] || { precisao: 0 }
                                    const precisaoStage = trainerNpcStages.precisao || 0

                                    // Calcular resultado final com modificador de precisão
                                    const finalResult = d20Roll + precisaoStage
                                    let detailsParts = `1d20 = ${d20Roll}`
                                    if (precisaoStage !== 0) {
                                      detailsParts += ` | Fase Precisão: ${precisaoStage >= 0 ? '+' : ''}${precisaoStage}`
                                    }

                                    // Usar nome mascarado se o treinador NPC não estiver revelado
                                    const displayName = trainer.isNpc && !revealedTrainers[trainer.id]
                                      ? (trainer.nomeFalso || 'NPC')
                                      : trainer.nome
                                    const message = `🎲 Acurácia ${displayName}\n${detailsParts}\nTotal: ${finalResult}`

                                    addChatMessage({
                                      username: 'Mestre',
                                      text: message,
                                      timestamp,
                                      isDiceRoll: true,
                                      diceResult: finalResult
                                    })
                                  }}
                                  className={`flex-1 flex items-center justify-center gap-1 py-2 rounded-lg font-semibold text-sm ${darkMode ? 'bg-purple-700 hover:bg-purple-600' : 'bg-purple-500 hover:bg-purple-600'} text-white`}
                                  title="Rolar Acurácia"
                                >
                                  <Dices size={14} />
                                  Acurácia
                                </button>
                                <button
                                  onClick={() => {
                                    const timestamp = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })

                                    // Obter nível e ataque base do treinador NPC
                                    const trainerLevel = trainer.level || 1
                                    const ataqueBase = trainer.baseAttributes?.ataque || trainer.ataque || 0

                                    // Aplicar fase de ataque ao atributo
                                    const trainerNpcStages = trainerStages[trainer.id] || { ataque: 0 }
                                    const ataqueStage = trainerNpcStages.ataque || 0
                                    const ataqueMultiplier = getStageMultiplier(ataqueStage)
                                    const ataqueTotal = Math.floor(ataqueBase * ataqueMultiplier)

                                    let damageRoll, damageBonus, diceType

                                    // Determinar dano baseado no nível (mesma lógica dos treinadores)
                                    if (trainerLevel >= 1 && trainerLevel <= 6) {
                                      diceType = '1d10+4'
                                      damageRoll = Math.floor(Math.random() * 10) + 1
                                      damageBonus = 4
                                    } else if (trainerLevel >= 7 && trainerLevel <= 14) {
                                      diceType = '1d12+6'
                                      damageRoll = Math.floor(Math.random() * 12) + 1
                                      damageBonus = 6
                                    } else {
                                      diceType = '2d8+6'
                                      const dice1 = Math.floor(Math.random() * 8) + 1
                                      const dice2 = Math.floor(Math.random() * 8) + 1
                                      damageRoll = dice1 + dice2
                                      damageBonus = 6
                                    }

                                    const baseDamage = damageRoll + damageBonus
                                    const totalDamage = baseDamage + ataqueTotal

                                    let stageInfo = ''
                                    if (ataqueStage !== 0) {
                                      stageInfo = ` [Fase ATQ: ${ataqueStage > 0 ? '+' : ''}${ataqueStage} → ${ataqueBase}→${ataqueTotal}]`
                                    }

                                    // Usar nome mascarado se o treinador NPC não estiver revelado
                                    const displayName = trainer.isNpc && !revealedTrainers[trainer.id]
                                      ? (trainer.nomeFalso || 'NPC')
                                      : trainer.nome
                                    const message = `⚔️ ${displayName} atacou!\n${diceType} = ${damageRoll} + ${damageBonus} + ${ataqueTotal} (Ataque Total)${stageInfo} = ${totalDamage} de dano`

                                    addChatMessage({
                                      username: 'Mestre',
                                      text: message,
                                      timestamp,
                                      isDiceRoll: true,
                                      diceResult: totalDamage
                                    })
                                  }}
                                  className={`flex-1 flex items-center justify-center gap-1 py-2 rounded-lg font-semibold text-sm ${darkMode ? 'bg-orange-700 hover:bg-orange-600' : 'bg-orange-500 hover:bg-orange-600'} text-white`}
                                  title="Rolar Dano"
                                >
                                  <Sword size={14} />
                                  Dano
                                </button>
                              </div>
                            )}

                            {/* Checkbox Revelar Nome - só para NPC */}
                            {trainer.isNpc && (
                              <div className={`mt-2 pt-2 border-t ${darkMode ? 'border-gray-500' : 'border-gray-300'}`}>
                                <label className="flex items-center gap-2 cursor-pointer mb-2">
                                  <input
                                    type="checkbox"
                                    checked={revealedTrainers[trainer.id] || false}
                                    onChange={async (e) => {
                                      const newRevealedTrainers = {
                                        ...revealedTrainers,
                                        [trainer.id]: e.target.checked
                                      }
                                      setRevealedTrainers(newRevealedTrainers)
                                      if (useFirebase) {
                                        await saveBattleData({
                                          battleTrainers,
                                          battlePokemon,
                                          battleTrainersList,
                                          battlePokemonList,
                                          currentTrainerTurn,
                                          currentPokemonTurn,
                                          trainerRound,
                                          pokemonRound,
                                          battlePokemonConditions,
                                          revealedNpcPokemon,
                                          revealedTrainers: newRevealedTrainers
                                        })
                                      }
                                    }}
                                    className="w-4 h-4 cursor-pointer"
                                  />
                                  <span className={`text-xs font-semibold ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                    Revelar Nome
                                  </span>
                                </label>
                              </div>
                            )}

                            {/* Dropdown e Caixas de Condições */}
                            <div className={`mt-2 pt-2 border-t ${darkMode ? 'border-gray-500' : 'border-gray-300'}`}>
                              <label className={`text-xs font-semibold mb-1 block ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                Condições:
                              </label>
                              <select
                                className={`w-full text-xs px-2 py-1 rounded mb-2 ${darkMode ? 'bg-gray-700 text-white border-gray-600' : 'bg-white text-gray-800 border-gray-300'} border`}
                                onChange={(e) => {
                                  if (e.target.value) {
                                    const newConditions = [...trainerConditions]
                                    const emptySlot = newConditions.findIndex(c => c === null)
                                    if (emptySlot !== -1) {
                                      newConditions[emptySlot] = { condition: e.target.value, rounds: 1 }
                                      setBattleTrainerConditions({
                                        ...battleTrainerConditions,
                                        [trainer.id]: newConditions
                                      })
                                    }
                                    e.target.value = ''
                                  }
                                }}
                                value=""
                              >
                                <option value="">Selecione uma condição</option>
                                <option value="confusao">😵 Confusão</option>
                                <option value="critico">🍀 Crítico</option>
                                <option value="paralisia">⚡ Paralisia</option>
                                <option value="sono">💤 Sono</option>
                                <option value="atordoamento">🌀 Atordoamento</option>
                                <option value="congelamento">❄️ Congelamento</option>
                                <option value="paixao">❤️ Paixão</option>
                                <option value="queimadura">🔥 Queimadura</option>
                                <option value="veneno">☠️ Veneno</option>
                              </select>

                              {/* Caixas de Condições */}
                              <div className="grid grid-cols-3 gap-1">
                                {trainerConditions.map((cond, slotIdx) => (
                                  <div
                                    key={slotIdx}
                                    className={`relative text-center p-2 rounded border-2 ${
                                      cond
                                        ? darkMode ? 'bg-gray-700 border-blue-500' : 'bg-blue-50 border-blue-400'
                                        : darkMode ? 'bg-gray-800 border-gray-600' : 'bg-gray-100 border-gray-300'
                                    }`}
                                  >
                                    {cond ? (
                                      <>
                                        <button
                                          onClick={() => {
                                            const newConditions = [...trainerConditions]
                                            newConditions[slotIdx] = null
                                            setBattleTrainerConditions({
                                              ...battleTrainerConditions,
                                              [trainer.id]: newConditions
                                            })
                                          }}
                                          className="absolute -top-1 -right-1 w-4 h-4 bg-red-500 text-white rounded-full text-xs flex items-center justify-center hover:bg-red-600"
                                        >
                                          ×
                                        </button>
                                        <div className="text-lg mb-1">
                                          {cond.condition === 'confusao' && '😵'}
                                          {cond.condition === 'critico' && '🍀'}
                                          {cond.condition === 'paralisia' && '⚡'}
                                          {cond.condition === 'sono' && '💤'}
                                          {cond.condition === 'atordoamento' && '🌀'}
                                          {cond.condition === 'congelamento' && '❄️'}
                                          {cond.condition === 'paixao' && '❤️'}
                                          {cond.condition === 'queimadura' && '🔥'}
                                          {cond.condition === 'veneno' && '☠️'}
                                        </div>
                                        <div className="flex items-center justify-center gap-1">
                                          <button
                                            onClick={() => {
                                              const newConditions = [...trainerConditions]
                                              newConditions[slotIdx].rounds = Math.max(0, newConditions[slotIdx].rounds - 1)
                                              setBattleTrainerConditions({
                                                ...battleTrainerConditions,
                                                [trainer.id]: newConditions
                                              })
                                            }}
                                            className={`w-5 h-5 rounded text-xs font-bold ${darkMode ? 'bg-gray-600 hover:bg-gray-500 text-white' : 'bg-gray-300 hover:bg-gray-400 text-gray-800'}`}
                                          >
                                            -
                                          </button>
                                          <span className={`text-xs font-bold min-w-[20px] ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                            {cond.rounds}
                                          </span>
                                          <button
                                            onClick={() => {
                                              const newConditions = [...trainerConditions]
                                              newConditions[slotIdx].rounds += 1
                                              setBattleTrainerConditions({
                                                ...battleTrainerConditions,
                                                [trainer.id]: newConditions
                                              })
                                            }}
                                            className={`w-5 h-5 rounded text-xs font-bold ${darkMode ? 'bg-gray-600 hover:bg-gray-500 text-white' : 'bg-gray-300 hover:bg-gray-400 text-gray-800'}`}
                                          >
                                            +
                                          </button>
                                        </div>
                                      </>
                                    ) : (
                                      <div className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>-</div>
                                    )}
                                  </div>
                                ))}
                              </div>
                            </div>

                            {/* Fases - só para treinadores NPC */}
                            {trainer.isNpc && (
                              <div className={`mt-2 pt-2 border-t ${darkMode ? 'border-gray-500' : 'border-gray-300'}`}>
                                <label className={`text-xs font-semibold mb-2 block ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                  Fases (-6 a +6):
                                </label>
                                <div className="grid grid-cols-3 gap-2 text-xs">
                                  {/* Ataque */}
                                  <div className={`flex items-center justify-between p-2 rounded ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                                    <span className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>ATQ</span>
                                    <div className="flex items-center gap-1">
                                      <button
                                        onClick={() => adjustTrainerStage(trainer.id, 'ataque', -1)}
                                        className={`w-6 h-6 rounded flex items-center justify-center ${darkMode ? 'bg-gray-600 hover:bg-gray-500 text-white' : 'bg-gray-300 hover:bg-gray-400 text-gray-800'}`}
                                      >
                                        ▼
                                      </button>
                                      <span className={`min-w-[24px] text-center font-bold ${stages.ataque > 0 ? 'text-green-500' : stages.ataque < 0 ? 'text-red-500' : darkMode ? 'text-white' : 'text-gray-800'}`}>
                                        {stages.ataque > 0 ? `+${stages.ataque}` : stages.ataque}
                                      </span>
                                      <button
                                        onClick={() => adjustTrainerStage(trainer.id, 'ataque', 1)}
                                        className={`w-6 h-6 rounded flex items-center justify-center ${darkMode ? 'bg-gray-600 hover:bg-gray-500 text-white' : 'bg-gray-300 hover:bg-gray-400 text-gray-800'}`}
                                      >
                                        ▲
                                      </button>
                                    </div>
                                  </div>

                                  {/* Ataque Especial */}
                                  <div className={`flex items-center justify-between p-2 rounded ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                                    <span className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>ATE</span>
                                    <div className="flex items-center gap-1">
                                      <button
                                        onClick={() => adjustTrainerStage(trainer.id, 'ataqueEspecial', -1)}
                                        className={`w-6 h-6 rounded flex items-center justify-center ${darkMode ? 'bg-gray-600 hover:bg-gray-500 text-white' : 'bg-gray-300 hover:bg-gray-400 text-gray-800'}`}
                                      >
                                        ▼
                                      </button>
                                      <span className={`min-w-[24px] text-center font-bold ${stages.ataqueEspecial > 0 ? 'text-green-500' : stages.ataqueEspecial < 0 ? 'text-red-500' : darkMode ? 'text-white' : 'text-gray-800'}`}>
                                        {stages.ataqueEspecial > 0 ? `+${stages.ataqueEspecial}` : stages.ataqueEspecial}
                                      </span>
                                      <button
                                        onClick={() => adjustTrainerStage(trainer.id, 'ataqueEspecial', 1)}
                                        className={`w-6 h-6 rounded flex items-center justify-center ${darkMode ? 'bg-gray-600 hover:bg-gray-500 text-white' : 'bg-gray-300 hover:bg-gray-400 text-gray-800'}`}
                                      >
                                        ▲
                                      </button>
                                    </div>
                                  </div>

                                  {/* Defesa */}
                                  <div className={`flex items-center justify-between p-2 rounded ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                                    <span className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>DEF</span>
                                    <div className="flex items-center gap-1">
                                      <button
                                        onClick={() => adjustTrainerStage(trainer.id, 'defesa', -1)}
                                        className={`w-6 h-6 rounded flex items-center justify-center ${darkMode ? 'bg-gray-600 hover:bg-gray-500 text-white' : 'bg-gray-300 hover:bg-gray-400 text-gray-800'}`}
                                      >
                                        ▼
                                      </button>
                                      <span className={`min-w-[24px] text-center font-bold ${stages.defesa > 0 ? 'text-green-500' : stages.defesa < 0 ? 'text-red-500' : darkMode ? 'text-white' : 'text-gray-800'}`}>
                                        {stages.defesa > 0 ? `+${stages.defesa}` : stages.defesa}
                                      </span>
                                      <button
                                        onClick={() => adjustTrainerStage(trainer.id, 'defesa', 1)}
                                        className={`w-6 h-6 rounded flex items-center justify-center ${darkMode ? 'bg-gray-600 hover:bg-gray-500 text-white' : 'bg-gray-300 hover:bg-gray-400 text-gray-800'}`}
                                      >
                                        ▲
                                      </button>
                                    </div>
                                  </div>

                                  {/* Defesa Especial */}
                                  <div className={`flex items-center justify-between p-2 rounded ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                                    <span className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>DEE</span>
                                    <div className="flex items-center gap-1">
                                      <button
                                        onClick={() => adjustTrainerStage(trainer.id, 'defesaEspecial', -1)}
                                        className={`w-6 h-6 rounded flex items-center justify-center ${darkMode ? 'bg-gray-600 hover:bg-gray-500 text-white' : 'bg-gray-300 hover:bg-gray-400 text-gray-800'}`}
                                      >
                                        ▼
                                      </button>
                                      <span className={`min-w-[24px] text-center font-bold ${stages.defesaEspecial > 0 ? 'text-green-500' : stages.defesaEspecial < 0 ? 'text-red-500' : darkMode ? 'text-white' : 'text-gray-800'}`}>
                                        {stages.defesaEspecial > 0 ? `+${stages.defesaEspecial}` : stages.defesaEspecial}
                                      </span>
                                      <button
                                        onClick={() => adjustTrainerStage(trainer.id, 'defesaEspecial', 1)}
                                        className={`w-6 h-6 rounded flex items-center justify-center ${darkMode ? 'bg-gray-600 hover:bg-gray-500 text-white' : 'bg-gray-300 hover:bg-gray-400 text-gray-800'}`}
                                      >
                                        ▲
                                      </button>
                                    </div>
                                  </div>

                                  {/* Velocidade */}
                                  <div className={`flex items-center justify-between p-2 rounded ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                                    <span className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>VEL</span>
                                    <div className="flex items-center gap-1">
                                      <button
                                        onClick={() => adjustTrainerStage(trainer.id, 'velocidade', -1)}
                                        className={`w-6 h-6 rounded flex items-center justify-center ${darkMode ? 'bg-gray-600 hover:bg-gray-500 text-white' : 'bg-gray-300 hover:bg-gray-400 text-gray-800'}`}
                                      >
                                        ▼
                                      </button>
                                      <span className={`min-w-[24px] text-center font-bold ${stages.velocidade > 0 ? 'text-green-500' : stages.velocidade < 0 ? 'text-red-500' : darkMode ? 'text-white' : 'text-gray-800'}`}>
                                        {stages.velocidade > 0 ? `+${stages.velocidade}` : stages.velocidade}
                                      </span>
                                      <button
                                        onClick={() => adjustTrainerStage(trainer.id, 'velocidade', 1)}
                                        className={`w-6 h-6 rounded flex items-center justify-center ${darkMode ? 'bg-gray-600 hover:bg-gray-500 text-white' : 'bg-gray-300 hover:bg-gray-400 text-gray-800'}`}
                                      >
                                        ▲
                                      </button>
                                    </div>
                                  </div>

                                  {/* Precisão */}
                                  <div className={`flex items-center justify-between p-2 rounded ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                                    <span className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>PREC</span>
                                    <div className="flex items-center gap-1">
                                      <button
                                        onClick={() => adjustTrainerStage(trainer.id, 'precisao', -1)}
                                        className={`w-6 h-6 rounded flex items-center justify-center ${darkMode ? 'bg-gray-600 hover:bg-gray-500 text-white' : 'bg-gray-300 hover:bg-gray-400 text-gray-800'}`}
                                      >
                                        ▼
                                      </button>
                                      <span className={`min-w-[24px] text-center font-bold ${stages.precisao > 0 ? 'text-green-500' : stages.precisao < 0 ? 'text-red-500' : darkMode ? 'text-white' : 'text-gray-800'}`}>
                                        {stages.precisao > 0 ? `+${stages.precisao}` : stages.precisao}
                                      </span>
                                      <button
                                        onClick={() => adjustTrainerStage(trainer.id, 'precisao', 1)}
                                        className={`w-6 h-6 rounded flex items-center justify-center ${darkMode ? 'bg-gray-600 hover:bg-gray-500 text-white' : 'bg-gray-300 hover:bg-gray-400 text-gray-800'}`}
                                      >
                                        ▲
                                      </button>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            )}
                          </div>
                        )
                      })}
                    </div>
                  )}
                </div>
              </div>
            </div>

            {/* TRACKER POKÉMON */}
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-6`}>
              <h3 className={`text-xl sm:text-2xl font-bold mb-6 text-center ${darkMode ? 'text-red-400' : 'text-red-600'}`}>
                Tracker Pokémon
              </h3>

              {/* Box de Enviados */}
              <div className="mb-6">
                <h4 className={`text-lg font-semibold mb-3 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  Enviados ({safePokemon.length})
                </h4>
                <div className={`p-4 rounded-lg border-2 min-h-[150px] max-h-[200px] overflow-y-auto ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-gray-50 border-gray-300'}`}>
                  {safePokemon.length === 0 ? (
                    <p className={`text-center ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                      Nenhum pokémon enviado
                    </p>
                  ) : (
                    <div className="space-y-2">
                      {safePokemon.map(pokemon => {
                        const evasoes = calcularEvasoes(
                          pokemon.totalAttributes?.defesa || 0,
                          pokemon.totalAttributes?.defesaEspecial || 0,
                          pokemon.totalAttributes?.velocidade || pokemon.velocidade || 0,
                          null
                        )
                        return (
                          <div key={pokemon.id} className={`p-3 rounded-lg ${darkMode ? 'bg-gray-600' : 'bg-white'} border ${darkMode ? 'border-gray-500' : 'border-gray-300'}`}>
                            <div className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{pokemon.nome}</div>
                            <div className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                              {pokemon.especie} | HP: {pokemon.hp}/{pokemon.maxHP} | Vel: {pokemon.velocidade}
                            </div>
                            <div className={`text-xs flex gap-1 mt-1`}>
                              {(pokemon.tipos || []).map((tipo, i) => (
                                <span key={i} className="px-2 py-0.5 rounded text-white text-xs" style={{ backgroundColor: TYPE_COLORS[tipo] || '#777' }}>
                                  {tipo}
                                </span>
                              ))}
                            </div>
                            <div className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                              Evasões - F: {evasoes.evasaoFisica} | E: {evasoes.evasaoEspecial} | V: {evasoes.evasaoVeloz}
                            </div>
                          </div>
                        )
                      })}
                    </div>
                  )}
                </div>
              </div>

              {/* Botões de Controle */}
              <div className="flex gap-2 sm:gap-3 mb-6">
                <button
                  onClick={mountPokemonBattle}
                  className="flex-1 bg-purple-600 text-white px-2 sm:px-4 py-2 sm:py-3 rounded-lg hover:bg-purple-700 font-semibold flex items-center justify-center gap-1 sm:gap-2 text-xs sm:text-sm"
                >
                  <HandMetal size={16} className="sm:w-5 sm:h-5" />
                  Montar Batalha
                </button>
                <button
                  onClick={addToPokemonBattle}
                  className="flex-1 bg-green-600 text-white px-2 sm:px-4 py-2 sm:py-3 rounded-lg hover:bg-green-700 font-semibold flex items-center justify-center gap-1 sm:gap-2 text-xs sm:text-sm"
                >
                  <MapPin size={16} className="sm:w-5 sm:h-5" />
                  Adicionar
                </button>
              </div>

              {/* Box Em Batalha */}
              <div>
                <div className="flex items-center justify-between mb-3">
                  <h4 className={`text-lg font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                    Em Batalha - Rodada {pokemonRound}
                  </h4>
                  {safePokemonList.length > 0 && (
                    <button
                      onClick={advancePokemonTurn}
                      className="bg-blue-600 text-white px-3 py-1 rounded-lg hover:bg-blue-700 font-semibold text-sm"
                    >
                      Avançar Turno
                    </button>
                  )}
                </div>
                <div className={`p-4 rounded-lg border-2 min-h-[250px] max-h-[400px] overflow-y-auto ${darkMode ? 'bg-gray-700 border-red-500' : 'bg-red-50 border-red-300'}`}>
                  {safePokemonList.length === 0 ? (
                    <p className={`text-center ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                      Nenhum pokémon em batalha
                    </p>
                  ) : (
                    <div className="space-y-2">
                      {safePokemonList.map((pokemon, idx) => {
                        const pokemonConditions = battlePokemonConditions[pokemon.id] || [null, null, null]
                        const stages = pokemonStages[pokemon.id] || { ataque: 0, ataqueEspecial: 0, defesa: 0, defesaEspecial: 0, velocidade: 0, precisao: 0 }

                        // Calcular evasões com fases
                        const evasoes = calcularEvasoes(
                          pokemon.totalAttributes?.defesa || 0,
                          pokemon.totalAttributes?.defesaEspecial || 0,
                          pokemon.totalAttributes?.velocidade || pokemon.velocidade || 0,
                          stages
                        )

                        return (
                          <div
                            key={pokemon.id}
                            ref={(el) => (pokemonBattleRefs.current[idx] = el)}
                            className={`p-3 rounded-lg border-2 ${
                              idx === currentPokemonTurn
                                ? darkMode ? 'bg-yellow-900 border-yellow-500' : 'bg-yellow-100 border-yellow-500'
                                : darkMode ? 'bg-gray-600 border-gray-500' : 'bg-white border-gray-300'
                            }`}
                          >
                            <div className="flex items-center justify-between">
                              <div className={`font-semibold ${idx === currentPokemonTurn ? 'text-yellow-600' : darkMode ? 'text-white' : 'text-gray-800'}`}>
                                {idx === currentPokemonTurn && '▶ '}{pokemon.nome}
                              </div>
                              <div className="flex items-center gap-2">
                                <span className={`text-xs px-2 py-1 rounded ${darkMode ? 'bg-gray-700 text-gray-300' : 'bg-gray-200 text-gray-600'}`}>
                                  Vel: {pokemon.velocidade}
                                </span>
                                <button
                                  onClick={() => removePokemonFromBattle(pokemon.id)}
                                  className="p-1 rounded hover:bg-red-600 transition-colors bg-red-500 text-white"
                                  title="Remover da batalha"
                                >
                                  <Trash2 size={14} />
                                </button>
                              </div>
                            </div>
                            <div className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                              {pokemon.especie} | HP: {pokemon.hp}/{pokemon.maxHP}
                            </div>
                            <div className={`text-xs flex gap-1 mt-1`}>
                              {(pokemon.tipos || []).map((tipo, i) => (
                                <span key={i} className="px-2 py-0.5 rounded text-white text-xs" style={{ backgroundColor: TYPE_COLORS[tipo] || '#777' }}>
                                  {tipo}
                                </span>
                              ))}
                            </div>
                            <div className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                              Evasões - F: {evasoes.evasaoFisica} | E: {evasoes.evasaoEspecial} | V: {evasoes.evasaoVeloz}
                            </div>

                            {/* Botão Dano/Cura NPC Pokémon */}
                            {pokemon.isNpc && (
                              <button
                                onClick={() => {
                                  setSelectedNpcPokemonForDamage(pokemon)
                                  setShowNpcPokemonBattleDamageModal(true)
                                }}
                                className={`w-full mt-2 flex items-center justify-center gap-1 py-2 rounded-lg font-semibold text-sm ${darkMode ? 'bg-gradient-to-r from-red-700 to-green-700 hover:from-red-600 hover:to-green-600' : 'bg-gradient-to-r from-red-500 to-green-500 hover:from-red-600 hover:to-green-600'} text-white`}
                              >
                                <Sword size={14} />
                                Dano/Cura
                                <Heart size={14} />
                              </button>
                            )}

                            {/* Checkbox Nome/Tipo - Apenas para NPCs */}
                            {String(pokemon.id).startsWith('npc-pokemon-') && (
                              <div className={`mt-2 pt-2 border-t ${darkMode ? 'border-gray-500' : 'border-gray-300'}`}>
                                <label className="flex items-center gap-2 cursor-pointer mb-2">
                                  <input
                                    type="checkbox"
                                    checked={revealedNpcPokemon[pokemon.id] || false}
                                    onChange={async (e) => {
                                      const newRevealedNpcPokemon = {
                                        ...revealedNpcPokemon,
                                        [pokemon.id]: e.target.checked
                                      }
                                      setRevealedNpcPokemon(newRevealedNpcPokemon)
                                      if (useFirebase) {
                                        await saveBattleData({
                                          battleTrainers,
                                          battlePokemon,
                                          battleTrainersList,
                                          battlePokemonList,
                                          currentTrainerTurn,
                                          currentPokemonTurn,
                                          trainerRound,
                                          pokemonRound,
                                          battlePokemonConditions,
                                          revealedNpcPokemon: newRevealedNpcPokemon,
                                          revealedTrainers
                                        })
                                      }
                                    }}
                                    className="w-4 h-4 cursor-pointer"
                                  />
                                  <span className={`text-xs font-semibold ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                    Revelar Nome/Tipo
                                  </span>
                                </label>
                              </div>
                            )}

                            {/* Dropdown e Caixas de Condições */}
                            <div className={`mt-2 pt-2 border-t ${darkMode ? 'border-gray-500' : 'border-gray-300'}`}>
                              <label className={`text-xs font-semibold mb-1 block ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                Condições:
                              </label>
                              <select
                                className={`w-full text-xs px-2 py-1 rounded mb-2 ${darkMode ? 'bg-gray-700 text-white border-gray-600' : 'bg-white text-gray-800 border-gray-300'} border`}
                                onChange={(e) => {
                                  if (e.target.value) {
                                    const newConditions = [...pokemonConditions]
                                    const emptySlot = newConditions.findIndex(c => c === null)
                                    if (emptySlot !== -1) {
                                      newConditions[emptySlot] = { condition: e.target.value, rounds: 1 }
                                      setBattlePokemonConditions({
                                        ...battlePokemonConditions,
                                        [pokemon.id]: newConditions
                                      })
                                    }
                                    e.target.value = ''
                                  }
                                }}
                                value=""
                              >
                                <option value="">Selecione uma condição</option>
                                <option value="confusao">😵 Confusão</option>
                                <option value="critico">🍀 Crítico</option>
                                <option value="paralisia">⚡ Paralisia</option>
                                <option value="sono">💤 Sono</option>
                                <option value="atordoamento">🌀 Atordoamento</option>
                                <option value="congelamento">❄️ Congelamento</option>
                                <option value="paixao">❤️ Paixão</option>
                                <option value="queimadura">🔥 Queimadura</option>
                                <option value="veneno">☠️ Veneno</option>
                              </select>

                              {/* Caixas de Condições */}
                              <div className="grid grid-cols-3 gap-1">
                                {pokemonConditions.map((cond, slotIdx) => (
                                  <div
                                    key={slotIdx}
                                    className={`relative text-center p-2 rounded border-2 ${
                                      cond
                                        ? darkMode ? 'bg-gray-700 border-blue-500' : 'bg-blue-50 border-blue-400'
                                        : darkMode ? 'bg-gray-800 border-gray-600' : 'bg-gray-100 border-gray-300'
                                    }`}
                                  >
                                    {cond ? (
                                      <>
                                        <button
                                          onClick={() => {
                                            const newConditions = [...pokemonConditions]
                                            newConditions[slotIdx] = null
                                            setBattlePokemonConditions({
                                              ...battlePokemonConditions,
                                              [pokemon.id]: newConditions
                                            })
                                          }}
                                          className="absolute -top-1 -right-1 w-4 h-4 bg-red-500 text-white rounded-full text-xs flex items-center justify-center hover:bg-red-600"
                                        >
                                          ×
                                        </button>
                                        <div className="text-lg mb-1">
                                          {cond.condition === 'confusao' && '😵'}
                                          {cond.condition === 'critico' && '🍀'}
                                          {cond.condition === 'paralisia' && '⚡'}
                                          {cond.condition === 'sono' && '💤'}
                                          {cond.condition === 'atordoamento' && '🌀'}
                                          {cond.condition === 'congelamento' && '❄️'}
                                          {cond.condition === 'paixao' && '❤️'}
                                          {cond.condition === 'queimadura' && '🔥'}
                                          {cond.condition === 'veneno' && '☠️'}
                                        </div>
                                        <div className="flex items-center justify-center gap-1">
                                          <button
                                            onClick={() => {
                                              const newConditions = [...pokemonConditions]
                                              newConditions[slotIdx].rounds = Math.max(0, newConditions[slotIdx].rounds - 1)
                                              setBattlePokemonConditions({
                                                ...battlePokemonConditions,
                                                [pokemon.id]: newConditions
                                              })
                                            }}
                                            className={`w-5 h-5 rounded text-xs font-bold ${darkMode ? 'bg-gray-600 hover:bg-gray-500 text-white' : 'bg-gray-300 hover:bg-gray-400 text-gray-800'}`}
                                          >
                                            -
                                          </button>
                                          <span className={`text-xs font-bold min-w-[20px] ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                            {cond.rounds}
                                          </span>
                                          <button
                                            onClick={() => {
                                              const newConditions = [...pokemonConditions]
                                              newConditions[slotIdx].rounds += 1
                                              setBattlePokemonConditions({
                                                ...battlePokemonConditions,
                                                [pokemon.id]: newConditions
                                              })
                                            }}
                                            className={`w-5 h-5 rounded text-xs font-bold ${darkMode ? 'bg-gray-600 hover:bg-gray-500 text-white' : 'bg-gray-300 hover:bg-gray-400 text-gray-800'}`}
                                          >
                                            +
                                          </button>
                                        </div>
                                      </>
                                    ) : (
                                      <div className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>-</div>
                                    )}
                                  </div>
                                ))}
                              </div>
                            </div>

                            {/* Fases - Apenas para Pokémon NPC */}
                            {pokemon.isNpc && (
                              <div className={`mt-2 pt-2 border-t ${darkMode ? 'border-gray-500' : 'border-gray-300'}`}>
                                <label className={`text-xs font-semibold mb-2 block ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                  Fases (-6 a +6):
                                </label>
                                <div className="grid grid-cols-2 gap-2 text-xs">
                                  {/* Ataque */}
                                  <div className={`flex items-center justify-between p-2 rounded ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                                    <span className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>ATQ</span>
                                    <div className="flex items-center gap-1">
                                      <button
                                        onClick={() => adjustPokemonStage(pokemon.id, 'ataque', -1)}
                                        className={`w-6 h-6 rounded flex items-center justify-center ${darkMode ? 'bg-gray-600 hover:bg-gray-500 text-white' : 'bg-gray-300 hover:bg-gray-400 text-gray-800'}`}
                                      >
                                        ▼
                                      </button>
                                      <span className={`min-w-[24px] text-center font-bold ${stages.ataque > 0 ? 'text-green-500' : stages.ataque < 0 ? 'text-red-500' : darkMode ? 'text-white' : 'text-gray-800'}`}>
                                        {stages.ataque > 0 ? `+${stages.ataque}` : stages.ataque}
                                      </span>
                                      <button
                                        onClick={() => adjustPokemonStage(pokemon.id, 'ataque', 1)}
                                        className={`w-6 h-6 rounded flex items-center justify-center ${darkMode ? 'bg-gray-600 hover:bg-gray-500 text-white' : 'bg-gray-300 hover:bg-gray-400 text-gray-800'}`}
                                      >
                                        ▲
                                      </button>
                                    </div>
                                  </div>

                                  {/* Ataque Especial */}
                                  <div className={`flex items-center justify-between p-2 rounded ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                                    <span className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>ATQ ESP</span>
                                    <div className="flex items-center gap-1">
                                      <button
                                        onClick={() => adjustPokemonStage(pokemon.id, 'ataqueEspecial', -1)}
                                        className={`w-6 h-6 rounded flex items-center justify-center ${darkMode ? 'bg-gray-600 hover:bg-gray-500 text-white' : 'bg-gray-300 hover:bg-gray-400 text-gray-800'}`}
                                      >
                                        ▼
                                      </button>
                                      <span className={`min-w-[24px] text-center font-bold ${stages.ataqueEspecial > 0 ? 'text-green-500' : stages.ataqueEspecial < 0 ? 'text-red-500' : darkMode ? 'text-white' : 'text-gray-800'}`}>
                                        {stages.ataqueEspecial > 0 ? `+${stages.ataqueEspecial}` : stages.ataqueEspecial}
                                      </span>
                                      <button
                                        onClick={() => adjustPokemonStage(pokemon.id, 'ataqueEspecial', 1)}
                                        className={`w-6 h-6 rounded flex items-center justify-center ${darkMode ? 'bg-gray-600 hover:bg-gray-500 text-white' : 'bg-gray-300 hover:bg-gray-400 text-gray-800'}`}
                                      >
                                        ▲
                                      </button>
                                    </div>
                                  </div>

                                  {/* Defesa */}
                                  <div className={`flex items-center justify-between p-2 rounded ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                                    <span className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>DEF</span>
                                    <div className="flex items-center gap-1">
                                      <button
                                        onClick={() => adjustPokemonStage(pokemon.id, 'defesa', -1)}
                                        className={`w-6 h-6 rounded flex items-center justify-center ${darkMode ? 'bg-gray-600 hover:bg-gray-500 text-white' : 'bg-gray-300 hover:bg-gray-400 text-gray-800'}`}
                                      >
                                        ▼
                                      </button>
                                      <span className={`min-w-[24px] text-center font-bold ${stages.defesa > 0 ? 'text-green-500' : stages.defesa < 0 ? 'text-red-500' : darkMode ? 'text-white' : 'text-gray-800'}`}>
                                        {stages.defesa > 0 ? `+${stages.defesa}` : stages.defesa}
                                      </span>
                                      <button
                                        onClick={() => adjustPokemonStage(pokemon.id, 'defesa', 1)}
                                        className={`w-6 h-6 rounded flex items-center justify-center ${darkMode ? 'bg-gray-600 hover:bg-gray-500 text-white' : 'bg-gray-300 hover:bg-gray-400 text-gray-800'}`}
                                      >
                                        ▲
                                      </button>
                                    </div>
                                  </div>

                                  {/* Defesa Especial */}
                                  <div className={`flex items-center justify-between p-2 rounded ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                                    <span className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>DEF ESP</span>
                                    <div className="flex items-center gap-1">
                                      <button
                                        onClick={() => adjustPokemonStage(pokemon.id, 'defesaEspecial', -1)}
                                        className={`w-6 h-6 rounded flex items-center justify-center ${darkMode ? 'bg-gray-600 hover:bg-gray-500 text-white' : 'bg-gray-300 hover:bg-gray-400 text-gray-800'}`}
                                      >
                                        ▼
                                      </button>
                                      <span className={`min-w-[24px] text-center font-bold ${stages.defesaEspecial > 0 ? 'text-green-500' : stages.defesaEspecial < 0 ? 'text-red-500' : darkMode ? 'text-white' : 'text-gray-800'}`}>
                                        {stages.defesaEspecial > 0 ? `+${stages.defesaEspecial}` : stages.defesaEspecial}
                                      </span>
                                      <button
                                        onClick={() => adjustPokemonStage(pokemon.id, 'defesaEspecial', 1)}
                                        className={`w-6 h-6 rounded flex items-center justify-center ${darkMode ? 'bg-gray-600 hover:bg-gray-500 text-white' : 'bg-gray-300 hover:bg-gray-400 text-gray-800'}`}
                                      >
                                        ▲
                                      </button>
                                    </div>
                                  </div>

                                  {/* Velocidade */}
                                  <div className={`flex items-center justify-between p-2 rounded ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                                    <span className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>VEL</span>
                                    <div className="flex items-center gap-1">
                                      <button
                                        onClick={() => adjustPokemonStage(pokemon.id, 'velocidade', -1)}
                                        className={`w-6 h-6 rounded flex items-center justify-center ${darkMode ? 'bg-gray-600 hover:bg-gray-500 text-white' : 'bg-gray-300 hover:bg-gray-400 text-gray-800'}`}
                                      >
                                        ▼
                                      </button>
                                      <span className={`min-w-[24px] text-center font-bold ${stages.velocidade > 0 ? 'text-green-500' : stages.velocidade < 0 ? 'text-red-500' : darkMode ? 'text-white' : 'text-gray-800'}`}>
                                        {stages.velocidade > 0 ? `+${stages.velocidade}` : stages.velocidade}
                                      </span>
                                      <button
                                        onClick={() => adjustPokemonStage(pokemon.id, 'velocidade', 1)}
                                        className={`w-6 h-6 rounded flex items-center justify-center ${darkMode ? 'bg-gray-600 hover:bg-gray-500 text-white' : 'bg-gray-300 hover:bg-gray-400 text-gray-800'}`}
                                      >
                                        ▲
                                      </button>
                                    </div>
                                  </div>

                                  {/* Precisão */}
                                  <div className={`flex items-center justify-between p-2 rounded ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                                    <span className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>PREC</span>
                                    <div className="flex items-center gap-1">
                                      <button
                                        onClick={() => adjustPokemonStage(pokemon.id, 'precisao', -1)}
                                        className={`w-6 h-6 rounded flex items-center justify-center ${darkMode ? 'bg-gray-600 hover:bg-gray-500 text-white' : 'bg-gray-300 hover:bg-gray-400 text-gray-800'}`}
                                      >
                                        ▼
                                      </button>
                                      <span className={`min-w-[24px] text-center font-bold ${stages.precisao > 0 ? 'text-green-500' : stages.precisao < 0 ? 'text-red-500' : darkMode ? 'text-white' : 'text-gray-800'}`}>
                                        {stages.precisao > 0 ? `+${stages.precisao}` : stages.precisao}
                                      </span>
                                      <button
                                        onClick={() => adjustPokemonStage(pokemon.id, 'precisao', 1)}
                                        className={`w-6 h-6 rounded flex items-center justify-center ${darkMode ? 'bg-gray-600 hover:bg-gray-500 text-white' : 'bg-gray-300 hover:bg-gray-400 text-gray-800'}`}
                                      >
                                        ▲
                                      </button>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            )}
                          </div>
                        )
                      })}
                    </div>
                  )}
                </div>
              </div>
            </div>

          </div>
          )}

          {/* Nova Seção: Pokémon NPC e Chat */}
          {battleView === 'rolagens' && (
          <div className="mt-6 space-y-6">

            {/* Pokémon NPC em Batalha */}
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-6`}>
              <h3 className={`text-xl sm:text-2xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                Pokémon NPC em Batalha
              </h3>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-3 sm:p-5 md:p-6">
                {/* Coluna Esquerda: Lista de Pokémon NPC */}
                <div className={`${darkMode ? 'bg-gray-900' : 'bg-gray-50'} rounded-lg p-4`}>
                  <h4 className={`text-sm font-bold mb-3 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Pokémon ({safePokemonList.length})
                  </h4>
                  {safePokemonList.length === 0 ? (
                    <p className={`text-center text-sm ${darkMode ? 'text-gray-500' : 'text-gray-400'} py-3 sm:py-5 md:py-8`}>
                      Nenhum Pokémon NPC em batalha
                    </p>
                  ) : (
                    <div className="space-y-2 max-h-[400px] overflow-y-auto">
                      {safePokemonList.filter(pkmn => String(pkmn.id).startsWith('npc-pokemon-')).map((pkmn, idx) => (
                        <button
                          key={pkmn.id || idx}
                          onClick={() => setSelectedMasterNpcPokemon(pkmn)}
                          className={`w-full text-left p-3 rounded-lg transition-colors ${
                            selectedMasterNpcPokemon?.id === pkmn.id
                              ? darkMode ? 'bg-blue-700 border-2 border-blue-500' : 'bg-blue-200 border-2 border-blue-500'
                              : darkMode ? 'bg-gray-800 hover:bg-gray-700' : 'bg-white hover:bg-gray-100'
                          }`}
                        >
                          <div className="flex items-center justify-between">
                            <span className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                              {pkmn.nome}
                            </span>
                            <span className={`text-xs px-2 py-1 rounded ${darkMode ? 'bg-gray-700 text-gray-300' : 'bg-gray-200 text-gray-600'}`}>
                              Vel: {pkmn.velocidade}
                            </span>
                          </div>
                          <div className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                            {pkmn.especie} | HP: {pkmn.hp}/{pkmn.maxHP}
                          </div>
                          <div className="flex gap-1 mt-1">
                            {(pkmn.tipos || []).map((tipo, i) => (
                              <span key={i} className="px-2 py-0.5 rounded text-white text-xs" style={{ backgroundColor: TYPE_COLORS[tipo] || '#777' }}>
                                {tipo}
                              </span>
                            ))}
                          </div>
                        </button>
                      ))}
                    </div>
                  )}
                </div>

                {/* Coluna Direita: Detalhes do Pokémon NPC */}
                <div className={`${darkMode ? 'bg-gray-900' : 'bg-gray-50'} rounded-lg p-4`}>
                  <div className="flex justify-between items-center mb-3">
                    <h4 className={`text-sm font-bold ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      Detalhes
                    </h4>
                    {selectedMasterNpcPokemon && (
                      <label className="flex items-center gap-2 cursor-pointer">
                        <input
                          type="checkbox"
                          checked={isCritical}
                          onChange={(e) => setIsCritical(e.target.checked)}
                          className="w-4 h-4 cursor-pointer"
                        />
                        <span className="text-sm font-bold text-red-600">CRIT</span>
                      </label>
                    )}
                  </div>
                  {!selectedMasterNpcPokemon ? (
                    <p className={`text-center text-sm ${darkMode ? 'text-gray-500' : 'text-gray-400'} py-3 sm:py-5 md:py-8`}>
                      Selecione um Pokémon NPC para ver seus detalhes
                    </p>
                  ) : (
                    <div className="space-y-3">
                      {/* Habilidades */}
                      <div>
                        <h5 className={`text-xs font-semibold mb-2 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                          Habilidades:
                        </h5>
                        <div className="space-y-1">
                          {selectedMasterNpcPokemon.habilidades && selectedMasterNpcPokemon.habilidades.length > 0 ? (
                            selectedMasterNpcPokemon.habilidades.map((ability, idx) => (
                              <button
                                key={idx}
                                onClick={() => {
                                  setSelectedBattleAbility(ability)
                                  setShowBattleAbilityModal(true)
                                }}
                                className={`w-full text-left p-2 rounded transition-colors ${darkMode ? 'bg-gray-800 hover:bg-gray-700' : 'bg-white hover:bg-gray-100'}`}
                              >
                                <span className={`text-sm font-semibold ${darkMode ? 'text-blue-400' : 'text-blue-600'} cursor-pointer hover:underline`}>
                                  {ability}
                                </span>
                              </button>
                            ))
                          ) : (
                            <p className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                              Nenhuma habilidade
                            </p>
                          )}
                        </div>
                      </div>

                      {/* Golpes */}
                      <div>
                        <h5 className={`text-xs font-semibold mb-2 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                          Golpes:
                        </h5>
                        <div className="space-y-1 max-h-[250px] overflow-y-auto">
                          {selectedMasterNpcPokemon.golpes && selectedMasterNpcPokemon.golpes.length > 0 ? (
                            selectedMasterNpcPokemon.golpes.map((move, idx) => {
                              if (!move) return null
                              const moveName = typeof move === 'string' ? move : (move.nome || move.name || '')

                              return (
                                <div
                                  key={idx}
                                  className={`flex items-center gap-2 p-2 rounded ${darkMode ? 'bg-gray-800' : 'bg-white'}`}
                                >
                                  <button
                                    onClick={() => {
                                      setSelectedBattleMove(moveName)
                                      setShowBattleMoveModal(true)
                                    }}
                                    className={`flex-1 text-left text-sm font-semibold ${darkMode ? 'text-green-400 hover:text-green-300' : 'text-green-600 hover:text-green-700'}`}
                                  >
                                    {moveName}
                                  </button>
                                  <button
                                    onClick={() => handleRollAccuracy(moveName, selectedMasterNpcPokemon?.id)}
                                    className={`p-1.5 rounded transition-colors ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-blue-400' : 'bg-gray-200 hover:bg-gray-300 text-blue-600'}`}
                                    title="Teste de Acurácia"
                                  >
                                    <Dices size={14} />
                                  </button>
                                  <button
                                    onClick={() => handleRollMoveDamage(moveName)}
                                    className={`p-1.5 rounded transition-colors ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-yellow-400' : 'bg-gray-200 hover:bg-gray-300 text-yellow-600'}`}
                                    title="Rolar dano"
                                  >
                                    <Hand size={14} />
                                  </button>
                                </div>
                              )
                            })
                          ) : (
                            <p className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                              Nenhum golpe
                            </p>
                          )}
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              </div>
            </div>

            {/* Chat de Batalha */}
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-6`}>
              <h3 className={`text-xl sm:text-2xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                Chat de Batalha
              </h3>

              {/* Menu de Rolagem Rápida */}
              <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} rounded-lg p-4 mb-4`}>
                <h4 className={`text-sm font-bold mb-3 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                  Rolagem Rápida
                </h4>
                <div className="flex flex-wrap items-center gap-2 sm:gap-3">
                  {/* Primeira Parte: Número de dados */}
                  <div className="flex items-center gap-1.5 sm:gap-2">
                    <span className={`text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Qtd:</span>
                    <div className="flex flex-wrap gap-1">
                      {[1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(num => (
                        <button
                          key={num}
                          onClick={() => setQuickRollNumDice(num)}
                          className={`w-7 h-7 sm:w-8 sm:h-8 rounded text-xs sm:text-sm font-bold transition-colors ${
                            quickRollNumDice === num
                              ? 'bg-blue-600 text-white'
                              : darkMode
                              ? 'bg-gray-600 text-gray-300 hover:bg-gray-500'
                              : 'bg-white text-gray-700 hover:bg-gray-200'
                          }`}
                        >
                          {num}
                        </button>
                      ))}
                    </div>
                  </div>

                  {/* Segunda Parte: Tipo de dado */}
                  <div className="flex items-center gap-1.5 sm:gap-2">
                    <span className={`text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Dado:</span>
                    <div className="flex flex-wrap gap-1">
                      {['d4', 'd6', 'd8', 'd10', 'd12', 'd20'].map(dice => (
                        <button
                          key={dice}
                          onClick={() => setQuickRollDiceType(dice)}
                          className={`px-2 sm:px-3 h-7 sm:h-8 rounded text-xs sm:text-sm font-bold transition-colors ${
                            quickRollDiceType === dice
                              ? 'bg-green-600 text-white'
                              : darkMode
                              ? 'bg-gray-600 text-gray-300 hover:bg-gray-500'
                              : 'bg-white text-gray-700 hover:bg-gray-200'
                          }`}
                        >
                          {dice}
                        </button>
                      ))}
                    </div>
                  </div>

                  {/* Botão Rolar */}
                  <button
                    onClick={() => {
                      const diceNotation = `${quickRollNumDice}${quickRollDiceType}`
                      const result = rollDiceExpression(diceNotation)
                      if (result.error) {
                        alert(result.error)
                        return
                      }
                      const newMessage = {
                        username: currentUser?.username || 'Anônimo',
                        text: `🎲 Rolagem Rápida: ${diceNotation}`,
                        timestamp: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
                        isDiceRoll: true,
                        diceResult: result.total,
                        diceDetails: result.formula
                      }
                      setChatMessages(prev => [...prev, newMessage])
                      if (useFirebase) {
                        (async () => {
                          const currentMessages = await loadChatMessages()
                          await saveChatMessages([...(currentMessages || []), newMessage])
                        })().catch(err => console.error('Erro ao salvar mensagem:', err))
                      }
                    }}
                    className="px-3 sm:px-5 md:px-6 h-7 sm:h-8 bg-purple-600 text-white rounded font-bold hover:bg-purple-700 transition-colors text-xs sm:text-sm"
                  >
                    🎲 Rolar
                  </button>
                </div>
              </div>

              <div className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-4 space-y-1`}>
                <p>Use /r ou /roll para rolar dados. Exemplo: /r 1d20+5, /roll 2d6</p>
                <p>Use comandos @ para referenciar seus atributos: <span className="font-mono">1d20+@MAE</span>, <span className="font-mono">2d6+@MA+@MV</span></p>
                <p className="text-[10px]">Comandos: @MA @MD @MAE @MDE @MV @MS @At @Dt @AEt @DEt @Vt @St @Cont</p>
              </div>

              {/* Área de Mensagens */}
              <div ref={chatContainerRef} className={`${darkMode ? 'bg-gray-900' : 'bg-gray-50'} rounded-lg p-4 h-96 overflow-y-auto mb-4`}>
                {chatMessages.length === 0 ? (
                  <p className={`text-center ${darkMode ? 'text-gray-500' : 'text-gray-400'} py-3 sm:py-5 md:py-8`}>
                    Nenhuma mensagem ainda. Seja o primeiro a falar!
                  </p>
                ) : (
                  <div className="space-y-3">
                    {chatMessages.map((msg, idx) => (
                      <div key={idx} className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg p-3`}>
                        <div className="flex justify-between items-start mb-1">
                          <span className={`font-bold text-sm ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>
                            {msg.username}
                          </span>
                          <span className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                            {msg.timestamp}
                          </span>
                        </div>
                        {msg.isDiceRoll ? (
                          <div>
                            <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                              {msg.text}
                            </p>
                            <div className={`mt-2 p-2 rounded ${darkMode ? 'bg-green-900' : 'bg-green-100'}`}>
                              <p className={`font-bold text-lg ${darkMode ? 'text-green-400' : 'text-green-700'}`}>
                                Resultado: {msg.diceResult}
                              </p>
                              <p className={`text-xs ${darkMode ? 'text-green-300' : 'text-green-600'}`}>
                                {msg.diceDetails}
                              </p>
                            </div>
                          </div>
                        ) : msg.isAction ? (
                          <p className={`text-sm font-semibold text-yellow-500`}>
                            {msg.text}
                          </p>
                        ) : (
                          <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                            {msg.text}
                          </p>
                        )}
                      </div>
                    ))}
                  </div>
                )}
              </div>

              {/* Input de Mensagem */}
              <div className="flex gap-2">
                <input
                  type="text"
                  value={chatInput}
                  onChange={(e) => setChatInput(e.target.value)}
                  onKeyPress={(e) => {
                    if (e.key === 'Enter') {
                      handleSendMessage()
                    }
                  }}
                  placeholder="Digite sua mensagem, 1d20+@MAE, ou /r 1d20..."
                  className={`flex-1 px-4 py-3 rounded-lg border-2 ${
                    darkMode
                      ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-500'
                      : 'bg-white border-gray-300 text-gray-800 placeholder-gray-400'
                  } focus:outline-none focus:border-blue-500`}
                />
                <button
                  onClick={handleSendMessage}
                  className="px-3 sm:px-5 md:px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold"
                >
                  Enviar
                </button>
              </div>
            </div>

          </div>
          )}

        </div>
        {/* Modal de Golpe - Área Batalha Mestre */}
        {showBattleMoveModal && selectedBattleMove && (
          <div
            className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
            onClick={() => setShowBattleMoveModal(false)}
          >
            <div
              className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg p-3 sm:p-5 md:p-6 max-w-[95vw] sm:max-w-xl md:max-w-2xl w-full max-h-[90vh] overflow-y-auto`}
              onClick={(e) => e.stopPropagation()}
            >
              <div className="flex justify-between items-center mb-4">
                <h3 className={`text-lg sm:text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  {selectedBattleMove}
                </h3>
                <button
                  onClick={() => setShowBattleMoveModal(false)}
                  className={`${darkMode ? 'text-gray-400 hover:text-white' : 'text-gray-600 hover:text-gray-800'}`}
                >
                  <X size={24} />
                </button>
              </div>

              {(() => {
                const moveData = GOLPES_DATA[selectedBattleMove]
                if (!moveData) {
                  return <p className={`${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Golpe não encontrado</p>
                }

                return (
                  <div className="space-y-3">
                    <div className="grid grid-cols-2 gap-2 sm:gap-3 md:gap-4">
                      <div>
                        <span className={`text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Tipo:</span>
                        <p className={`${darkMode ? 'text-white' : 'text-gray-800'}`}>{moveData.tipo}</p>
                      </div>
                      <div>
                        <span className={`text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Aptidão:</span>
                        <p className={`${darkMode ? 'text-white' : 'text-gray-800'}`}>{moveData.aptidao}</p>
                      </div>
                      <div>
                        <span className={`text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Dano Basal:</span>
                        <p className={`${darkMode ? 'text-white' : 'text-gray-800'}`}>{moveData.danoBasal || '-'}</p>
                      </div>
                      <div>
                        <span className={`text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Acurácia:</span>
                        <p className={`${darkMode ? 'text-white' : 'text-gray-800'}`}>{moveData.acuracia}</p>
                      </div>
                      <div>
                        <span className={`text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Alcance:</span>
                        <p className={`${darkMode ? 'text-white' : 'text-gray-800'}`}>{moveData.alcance}</p>
                      </div>
                      <div>
                        <span className={`text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Frequência:</span>
                        <p className={`${darkMode ? 'text-white' : 'text-gray-800'}`}>{moveData.frequencia}</p>
                      </div>
                    </div>

                    {moveData.descritores && (
                      <div>
                        <span className={`text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Descritores:</span>
                        <p className={`${darkMode ? 'text-white' : 'text-gray-800'}`}>{moveData.descritores}</p>
                      </div>
                    )}

                    <div>
                      <span className={`text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Efeito:</span>
                      <p className={`${darkMode ? 'text-gray-300' : 'text-gray-700'} whitespace-pre-wrap`}>
                        {moveData.efeito}
                      </p>
                    </div>
                  </div>
                )
              })()}
            </div>
          </div>
        )}

        {/* Modal de Habilidade - Área Batalha Mestre */}
        {showBattleAbilityModal && selectedBattleAbility && (
          <div
            className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
            onClick={() => setShowBattleAbilityModal(false)}
          >
            <div
              className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg p-3 sm:p-5 md:p-6 max-w-[95vw] sm:max-w-xl md:max-w-2xl w-full max-h-[90vh] overflow-y-auto`}
              onClick={(e) => e.stopPropagation()}
            >
              <div className="flex justify-between items-center mb-4">
                <h3 className={`text-lg sm:text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  {selectedBattleAbility}
                </h3>
                <button
                  onClick={() => setShowBattleAbilityModal(false)}
                  className={`${darkMode ? 'text-gray-400 hover:text-white' : 'text-gray-600 hover:text-gray-800'}`}
                >
                  <X size={24} />
                </button>
              </div>

              {(() => {
                const abilityData = HABILIDADES_DATA[selectedBattleAbility]
                if (!abilityData) {
                  return <p className={`${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Habilidade não encontrada</p>
                }

                // Extrair descrição corretamente (pode ser string ou objeto com ativacao/efeito)
                let description = ''
                if (typeof abilityData === 'string') {
                  description = abilityData
                } else if (abilityData.descricao) {
                  description = abilityData.descricao
                } else if (abilityData.efeito) {
                  description = `Ativação: ${abilityData.ativacao || 'N/A'}\n\nEfeito: ${abilityData.efeito}`
                }

                return (
                  <div className="space-y-3">
                    <div>
                      <span className={`text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Descrição:</span>
                      <p className={`${darkMode ? 'text-gray-300' : 'text-gray-700'} whitespace-pre-wrap`}>
                        {description}
                      </p>
                    </div>

                    <button
                      onClick={() => handleSendAbilityToChat(selectedBattleAbility)}
                      className="w-full mt-4 bg-blue-600 text-white px-3 sm:px-5 md:px-6 py-3 rounded-lg hover:bg-blue-700 font-semibold"
                    >
                      Enviar no Chat
                    </button>
                  </div>
                )
              })()}
            </div>
          </div>
        )}

        {/* Modal de Dano/Cura Treinador NPC em Batalha */}
        {showNpcTrainerBattleDamageModal && selectedNpcTrainerForDamage && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => { setShowNpcTrainerBattleDamageModal(false); cancelDamageTypeSelection(); }}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-md w-full`} onClick={(e) => e.stopPropagation()}>
              <div className="p-3 sm:p-5 md:p-6">
                <div className="flex justify-between items-center mb-6">
                  <h3 className={`text-lg sm:text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                    Dano/Cura - {selectedNpcTrainerForDamage.nome}
                  </h3>
                  <button onClick={() => { setShowNpcTrainerBattleDamageModal(false); cancelDamageTypeSelection(); }} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                    <X size={24} />
                  </button>
                </div>

                {/* Informação de HP Atual */}
                <div className={`mb-6 p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                  <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>HP Atual</p>
                  <p className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                    {selectedNpcTrainerForDamage.hp} / {selectedNpcTrainerForDamage.maxHP}
                  </p>
                </div>

                {/* Input de Quantidade */}
                <div className="mb-6">
                  <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Quantidade
                  </label>
                  <input
                    type="number"
                    value={npcTrainerBattleDamageAmount}
                    onChange={(e) => setNpcTrainerBattleDamageAmount(e.target.value)}
                    placeholder="Digite a quantidade..."
                    className={`w-full px-3 py-2 sm:px-4 sm:py-3 border-2 rounded-lg text-sm sm:text-base text-lg ${
                      darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'border-gray-300 placeholder-gray-400'
                    }`}
                    min="1"
                    disabled={showDamageTypeButtons && pendingDamageContext === 'npcTrainerBattle'}
                  />
                </div>

                {/* Botões de Ação */}
                {!showDamageTypeButtons || pendingDamageContext !== 'npcTrainerBattle' ? (
                  <div className="flex gap-3">
                    <button
                      onClick={() => {
                        const v = parseInt(npcTrainerBattleDamageAmount) || 0;
                        if (v > 0) {
                          initiateDamageWithType(v, 'npcTrainerBattle');
                        }
                      }}
                      disabled={!npcTrainerBattleDamageAmount || parseInt(npcTrainerBattleDamageAmount) <= 0}
                      className="flex-1 flex items-center justify-center gap-2 bg-gradient-to-r from-red-600 to-red-700 text-white py-3 rounded-lg hover:from-red-700 hover:to-red-800 font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      <Sword size={18} />
                      Aplicar Dano
                    </button>
                    <button
                      onClick={() => applyNpcTrainerBattleDamage(false)}
                      disabled={!npcTrainerBattleDamageAmount || parseInt(npcTrainerBattleDamageAmount) <= 0}
                      className="flex-1 flex items-center justify-center gap-2 bg-gradient-to-r from-green-600 to-green-700 text-white py-3 rounded-lg hover:from-green-700 hover:to-green-800 font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      <Heart size={18} />
                      Curar
                    </button>
                  </div>
                ) : (
                  <div className="space-y-3">
                    <p className={`text-center text-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                      Dano: {pendingDamageValue}
                    </p>

                    {/* Multiplicadores de Dano */}
                    <div className={`p-3 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                      <p className={`text-xs font-semibold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>Multiplicadores:</p>
                      <div className="grid grid-cols-2 xs:grid-cols-4 gap-2">
                        {['x2', 'x4', '/2', '/4'].map(mult => (
                          <label key={mult} className={`flex items-center justify-center gap-1 px-2 py-1 rounded cursor-pointer transition-colors ${
                            damageMultiplier === mult
                              ? 'bg-blue-500 text-white'
                              : darkMode ? 'bg-gray-600 text-gray-200 hover:bg-gray-500' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                          }`}>
                            <input
                              type="checkbox"
                              checked={damageMultiplier === mult}
                              onChange={(e) => setDamageMultiplier(e.target.checked ? mult : null)}
                              className="hidden"
                            />
                            <span className="text-sm font-semibold">{mult}</span>
                          </label>
                        ))}
                      </div>
                    </div>

                    <p className={`text-center text-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                      Selecione o tipo de dano:
                    </p>
                    <div className="grid grid-cols-1 xs:grid-cols-3 gap-2 sm:gap-3">
                      <button
                        onClick={() => applyDamageWithType('fisico')}
                        className="flex items-center justify-center gap-2 bg-orange-500 text-white py-2 sm:py-3 rounded-lg hover:bg-orange-600 font-semibold text-sm sm:text-base"
                      >
                        <Sword size={18} />Físico
                      </button>
                      <button
                        onClick={() => applyDamageWithType('puro')}
                        className="flex items-center justify-center gap-2 bg-gray-500 text-white py-2 sm:py-3 rounded-lg hover:bg-gray-600 font-semibold text-sm sm:text-base"
                      >
                        <Minus size={18} />Puro
                      </button>
                      <button
                        onClick={() => applyDamageWithType('especial')}
                        className="flex items-center justify-center gap-2 bg-purple-500 text-white py-2 sm:py-3 rounded-lg hover:bg-purple-600 font-semibold text-sm sm:text-base"
                      >
                        <Zap size={18} />Especial
                      </button>
                    </div>
                    <button
                      onClick={cancelDamageTypeSelection}
                      className={`w-full py-2 rounded-lg font-semibold ${darkMode ? 'bg-gray-600 text-gray-200 hover:bg-gray-500' : 'bg-gray-300 text-gray-700 hover:bg-gray-400'}`}
                    >
                      Cancelar
                    </button>
                  </div>
                )}
              </div>
            </div>
          </div>
        )}

        {/* Modal de Dano/Cura Pokémon NPC em Batalha */}
        {showNpcPokemonBattleDamageModal && selectedNpcPokemonForDamage && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => { setShowNpcPokemonBattleDamageModal(false); cancelDamageTypeSelection(); }}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-md w-full`} onClick={(e) => e.stopPropagation()}>
              <div className="p-3 sm:p-5 md:p-6">
                <div className="flex justify-between items-center mb-6">
                  <h3 className={`text-lg sm:text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                    Dano/Cura - {selectedNpcPokemonForDamage.nome}
                  </h3>
                  <button onClick={() => { setShowNpcPokemonBattleDamageModal(false); cancelDamageTypeSelection(); }} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                    <X size={24} />
                  </button>
                </div>

                {/* Informação de HP Atual */}
                <div className={`mb-6 p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                  <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>HP Atual</p>
                  <p className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                    {selectedNpcPokemonForDamage.hp} / {selectedNpcPokemonForDamage.maxHP}
                  </p>
                </div>

                {/* Input de Quantidade */}
                <div className="mb-6">
                  <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Quantidade
                  </label>
                  <input
                    type="number"
                    value={npcPokemonBattleDamageAmount}
                    onChange={(e) => setNpcPokemonBattleDamageAmount(e.target.value)}
                    placeholder="Digite a quantidade..."
                    className={`w-full px-3 py-2 sm:px-4 sm:py-3 border-2 rounded-lg text-sm sm:text-base text-lg ${
                      darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'border-gray-300 placeholder-gray-400'
                    }`}
                    min="1"
                    disabled={showDamageTypeButtons && pendingDamageContext === 'npcPokemonBattle'}
                  />
                </div>

                {/* Botões de Ação */}
                {!showDamageTypeButtons || pendingDamageContext !== 'npcPokemonBattle' ? (
                  <div className="flex gap-3">
                    <button
                      onClick={() => {
                        const v = parseInt(npcPokemonBattleDamageAmount) || 0;
                        if (v > 0) {
                          initiateDamageWithType(v, 'npcPokemonBattle');
                        }
                      }}
                      disabled={!npcPokemonBattleDamageAmount || parseInt(npcPokemonBattleDamageAmount) <= 0}
                      className="flex-1 flex items-center justify-center gap-2 bg-gradient-to-r from-red-600 to-red-700 text-white py-3 rounded-lg hover:from-red-700 hover:to-red-800 font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      <Sword size={18} />
                      Aplicar Dano
                    </button>
                    <button
                      onClick={() => applyNpcPokemonBattleDamage(false)}
                      disabled={!npcPokemonBattleDamageAmount || parseInt(npcPokemonBattleDamageAmount) <= 0}
                      className="flex-1 flex items-center justify-center gap-2 bg-gradient-to-r from-green-600 to-green-700 text-white py-3 rounded-lg hover:from-green-700 hover:to-green-800 font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      <Heart size={18} />
                      Curar
                    </button>
                  </div>
                ) : (
                  <div className="space-y-3">
                    <p className={`text-center text-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                      Dano: {pendingDamageValue}
                    </p>

                    {/* Multiplicadores de Dano */}
                    <div className={`p-3 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                      <p className={`text-xs font-semibold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>Multiplicadores:</p>
                      <div className="grid grid-cols-2 xs:grid-cols-4 gap-2">
                        {['x2', 'x4', '/2', '/4'].map(mult => (
                          <label key={mult} className={`flex items-center justify-center gap-1 px-2 py-1 rounded cursor-pointer transition-colors ${
                            damageMultiplier === mult
                              ? 'bg-blue-500 text-white'
                              : darkMode ? 'bg-gray-600 text-gray-200 hover:bg-gray-500' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                          }`}>
                            <input
                              type="checkbox"
                              checked={damageMultiplier === mult}
                              onChange={(e) => setDamageMultiplier(e.target.checked ? mult : null)}
                              className="hidden"
                            />
                            <span className="text-sm font-semibold">{mult}</span>
                          </label>
                        ))}
                      </div>
                    </div>

                    <p className={`text-center text-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                      Selecione o tipo de dano:
                    </p>
                    <div className="grid grid-cols-1 xs:grid-cols-3 gap-2 sm:gap-3">
                      <button
                        onClick={() => applyDamageWithType('fisico')}
                        className="flex items-center justify-center gap-2 bg-orange-500 text-white py-2 sm:py-3 rounded-lg hover:bg-orange-600 font-semibold text-sm sm:text-base"
                      >
                        <Sword size={18} />Físico
                      </button>
                      <button
                        onClick={() => applyDamageWithType('puro')}
                        className="flex items-center justify-center gap-2 bg-gray-500 text-white py-2 sm:py-3 rounded-lg hover:bg-gray-600 font-semibold text-sm sm:text-base"
                      >
                        <Minus size={18} />Puro
                      </button>
                      <button
                        onClick={() => applyDamageWithType('especial')}
                        className="flex items-center justify-center gap-2 bg-purple-500 text-white py-2 sm:py-3 rounded-lg hover:bg-purple-600 font-semibold text-sm sm:text-base"
                      >
                        <Zap size={18} />Especial
                      </button>
                    </div>
                    <button
                      onClick={cancelDamageTypeSelection}
                      className={`w-full py-2 rounded-lg font-semibold ${darkMode ? 'bg-gray-600 text-gray-200 hover:bg-gray-500' : 'bg-gray-300 text-gray-700 hover:bg-gray-400'}`}
                    >
                      Cancelar
                    </button>
                  </div>
                )}
              </div>
            </div>
          </div>
        )}

          {/* ÁREA DO MAPA (VTT) - MESTRE */}
          {battleView === 'mapa' && (
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-8`}>
              <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 sm:mb-6 gap-2">
                <h3 className={`text-xl sm:text-2xl md:text-3xl font-bold ${darkMode ? 'text-green-400' : 'text-green-600'}`}>
                  Mapa de Batalha 👑
                </h3>
                <div className="flex gap-1.5 sm:gap-3">
                  <button
                    onClick={() => setVttShowGrid(!vttShowGrid)}
                    className={`px-2 sm:px-4 py-1.5 sm:py-2 rounded-lg font-semibold text-xs sm:text-sm ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                  >
                    {vttShowGrid ? 'Ocultar Grid' : 'Mostrar Grid'}
                  </button>
                  <button
                    onClick={() => setVttSnapToGrid(!vttSnapToGrid)}
                    className={`px-2 sm:px-4 py-1.5 sm:py-2 rounded-lg font-semibold text-xs sm:text-sm ${
                      vttSnapToGrid
                        ? 'bg-green-600 text-white'
                        : darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                    }`}
                  >
                    Snap: {vttSnapToGrid ? 'ON' : 'OFF'}
                  </button>
                </div>
              </div>

              {/* Menu Colapsável de Configurações do Canvas e Mapa */}
              <div className={`mb-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                {/* Botão para abrir/fechar o menu */}
                <button
                  onClick={() => setVttSettingsOpen(!vttSettingsOpen)}
                  className={`w-full flex items-center justify-between p-4 rounded-lg font-semibold transition-all ${darkMode ? 'hover:bg-gray-600 text-gray-300' : 'hover:bg-gray-200 text-gray-700'}`}
                >
                  <span className="flex items-center gap-2">
                    <Settings2 size={18} />
                    Configurações do Mapa
                  </span>
                  {vttSettingsOpen ? <ChevronUp size={20} /> : <ChevronDown size={20} />}
                </button>

                {/* Conteúdo do menu (colapsável) */}
                {vttSettingsOpen && (
                  <div className="p-4 pt-2">
                    {/* Gerenciamento de Localidades */}
                    <div className="mb-4">
                      <div className="flex justify-between items-center mb-3">
                        <label className={`text-sm font-bold ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                          Localidades
                        </label>
                        <button
                          onClick={() => setShowAddLocationModal(true)}
                          className="bg-gradient-to-r from-green-600 to-teal-600 text-white px-3 py-1 rounded-lg hover:from-green-700 hover:to-teal-700 font-semibold text-sm"
                        >
                          + Nova Localidade
                        </button>
                      </div>

                      {vttLocations.length > 0 ? (
                        <div className="flex gap-2 flex-wrap">
                          {vttLocations.map(location => (
                            <button
                              key={location.id}
                              onClick={() => setCurrentVttLocation(location.id)}
                              className={`px-3 py-1 rounded-lg font-semibold text-sm transition-all ${
                                currentVttLocation === location.id
                                  ? 'bg-gradient-to-r from-blue-600 to-purple-700 text-white shadow-lg'
                                  : darkMode
                                  ? 'bg-gray-600 text-gray-300 hover:bg-gray-500'
                                  : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                              }`}
                            >
                              {location.name}
                            </button>
                          ))}
                        </div>
                      ) : (
                        <div className={`text-center py-3 text-sm ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                          Nenhuma localidade criada. Clique em "+ Nova Localidade" para começar.
                        </div>
                      )}
                    </div>

                    {/* Upload de Mapa - Só aparece se houver localidade selecionada */}
                    {currentVttLocation && (
                      <div className="mb-4">
                        <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                          URL do Mapa - {vttLocations.find(loc => loc.id === currentVttLocation)?.name}
                        </label>
                        <div className="flex gap-2">
                          <input
                            type="text"
                            value={vttMapImage || ''}
                            onChange={(e) => {
                              setVttMapImage(e.target.value)
                              setVttLocations(prev => prev.map(loc =>
                                loc.id === currentVttLocation
                                  ? { ...loc, mapUrl: e.target.value }
                                  : loc
                              ))
                            }}
                            placeholder="Cole a URL da imagem do mapa"
                            className={`flex-1 px-3 py-2 rounded-lg border-2 text-sm ${darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'border-gray-300 bg-white text-gray-800'}`}
                          />
                          <button
                            onClick={() => {
                              setVttMapImage(null)
                              setVttLocations(prev => prev.map(loc =>
                                loc.id === currentVttLocation
                                  ? { ...loc, mapUrl: null }
                                  : loc
                              ))
                            }}
                            className="bg-red-600 text-white px-3 py-2 rounded-lg hover:bg-red-700 font-semibold text-sm"
                          >
                            Limpar
                          </button>
                          <button
                            onClick={() => {
                              if (window.confirm(`Deseja deletar a localidade "${vttLocations.find(loc => loc.id === currentVttLocation)?.name}"?`)) {
                                setVttLocations(prev => prev.filter(loc => loc.id !== currentVttLocation))
                                setCurrentVttLocation(null)
                                setVttMapImage(null)
                                setVttTokens([])
                                setVttGMTokens([])
                              }
                            }}
                            className="bg-red-700 text-white px-3 py-2 rounded-lg hover:bg-red-800 font-semibold text-sm"
                          >
                            🗑️ Deletar
                          </button>
                        </div>
                      </div>
                    )}

                    {!currentVttLocation && vttLocations.length > 0 && (
                      <div className={`mb-4 text-center py-3 text-sm ${darkMode ? 'bg-gray-600 text-gray-300' : 'bg-gray-200 text-gray-600'} rounded-lg`}>
                        Selecione uma localidade acima para editar
                      </div>
                    )}

                    {/* Controle de Escala da Imagem */}
                    {currentVttLocation && vttMapImage && (
                      <div className="mb-4">
                        <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                          Escala da Imagem: {vttMapScale}%
                        </label>
                        <input
                          type="range"
                          min="10"
                          max="200"
                          value={vttMapScale}
                          onChange={(e) => setVttMapScale(parseInt(e.target.value))}
                          className="w-full"
                        />
                      </div>
                    )}

                    {/* Dimensões do Canvas */}
                    {currentVttLocation && (
                      <>
                      <h4 className={`text-sm font-bold mb-3 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                        Dimensões do Canvas
                      </h4>
                      <div className="grid grid-cols-2 gap-2 sm:gap-3 md:gap-4 mb-3">
                        <div>
                          <label className={`block text-sm font-semibold mb-2 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                            Largura (px)
                          </label>
                          <div className="flex gap-2 items-center">
                            <input
                              type="range"
                              min="400"
                              max="15000"
                              step="50"
                              value={vttCanvasWidth}
                              onChange={(e) => setVttCanvasWidth(parseInt(e.target.value))}
                              className="flex-1"
                            />
                            <input
                              type="number"
                              min="400"
                              max="15000"
                              step="50"
                              value={vttCanvasWidth}
                              onChange={(e) => {
                                const val = parseInt(e.target.value) || 400
                                setVttCanvasWidth(Math.min(Math.max(val, 400), 15000))
                              }}
                              className={`w-20 px-2 py-1 rounded border text-center ${darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'bg-white border-gray-300 text-gray-800'}`}
                            />
                          </div>
                        </div>
                        <div>
                          <label className={`block text-sm font-semibold mb-2 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                            Altura (px)
                          </label>
                          <div className="flex gap-2 items-center">
                            <input
                              type="range"
                              min="400"
                              max="15000"
                              step="50"
                              value={vttCanvasHeight}
                              onChange={(e) => setVttCanvasHeight(parseInt(e.target.value))}
                              className="flex-1"
                            />
                            <input
                              type="number"
                              min="400"
                              max="15000"
                              step="50"
                              value={vttCanvasHeight}
                              onChange={(e) => {
                                const val = parseInt(e.target.value) || 400
                                setVttCanvasHeight(Math.min(Math.max(val, 400), 15000))
                              }}
                              className={`w-20 px-2 py-1 rounded border text-center ${darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'bg-white border-gray-300 text-gray-800'}`}
                            />
                          </div>
                        </div>
                      </div>

                      {/* Número de Quadrados */}
                      <h4 className={`text-sm font-bold mb-3 mt-4 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                        Número de Quadrados
                      </h4>
                      <div className="grid grid-cols-2 gap-2 sm:gap-3 md:gap-4">
                        <div>
                          <label className={`block text-sm font-semibold mb-2 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                            Colunas
                          </label>
                          <div className="flex gap-2 items-center">
                            <input
                              type="range"
                              min="5"
                              max="100"
                              value={vttGridColumns}
                              onChange={(e) => setVttGridColumns(parseInt(e.target.value))}
                              className="flex-1"
                            />
                            <input
                              type="number"
                              min="5"
                              max="100"
                              value={vttGridColumns}
                              onChange={(e) => {
                                const val = parseInt(e.target.value) || 5
                                setVttGridColumns(Math.min(Math.max(val, 5), 100))
                              }}
                              className={`w-16 px-2 py-1 rounded border text-center ${darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'bg-white border-gray-300 text-gray-800'}`}
                            />
                          </div>
                        </div>
                        <div>
                          <label className={`block text-sm font-semibold mb-2 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                            Linhas
                          </label>
                          <div className="flex gap-2 items-center">
                            <input
                              type="range"
                              min="5"
                              max="100"
                              value={vttGridRows}
                              onChange={(e) => setVttGridRows(parseInt(e.target.value))}
                              className="flex-1"
                            />
                            <input
                              type="number"
                              min="5"
                              max="100"
                              value={vttGridRows}
                              onChange={(e) => {
                                const val = parseInt(e.target.value) || 5
                                setVttGridRows(Math.min(Math.max(val, 5), 100))
                              }}
                              className={`w-16 px-2 py-1 rounded border text-center ${darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'bg-white border-gray-300 text-gray-800'}`}
                            />
                          </div>
                        </div>
                      </div>
                      </>
                    )}
                  </div>
                )}
              </div>

              {/* Indicador de Zoom */}
              <div className={`mb-2 flex items-center justify-between ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                <span className="text-sm">Zoom: {Math.round(vttViewportZoom * 100)}%</span>
                <button
                  onClick={resetViewport}
                  className={`text-xs px-2 py-1 rounded ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'}`}
                >
                  Resetar Zoom
                </button>
              </div>

              {/* Container com scroll para o Canvas */}
              <div
                className={`overflow-auto mb-4 rounded-lg border-2 ${darkMode ? 'border-gray-600' : 'border-gray-300'}`}
                style={{
                  width: '100%',
                  height: 'min(80vh, 600px)',
                  maxWidth: '100%'
                }}
              >
                {/* Canvas do Mapa - Dimensões Customizáveis */}
                <div
                  ref={setCanvasRef}
                  data-vtt-canvas="true"
                  className={`relative ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}
                  style={{
                    width: `${vttCanvasWidth}px`,
                    height: `${vttCanvasHeight}px`,
                    cursor: vttIsPanning ? 'grabbing' : 'default'
                  }}
                  onMouseDown={handlePanStart}
                  onMouseMove={(e) => {
                    handlePanMove(e)
                    if (!vttIsPanning) handleTokenMouseMove(e)
                  }}
                  onMouseUp={(e) => {
                    handlePanEnd()
                    handleTokenMouseUp(e)
                  }}
                  onMouseLeave={handlePanEnd}
                  onContextMenu={(e) => e.preventDefault()}
                >
                {/* Viewport com zoom e pan */}
                <div
                  className="absolute"
                  style={{
                    width: `${vttCanvasWidth}px`,
                    height: `${vttCanvasHeight}px`,
                    transform: `translate(${vttViewportOffset.x}px, ${vttViewportOffset.y}px) scale(${vttViewportZoom})`,
                    transformOrigin: 'center center'
                  }}
                >
                  {vttMapImage && (
                    <img
                      src={vttMapImage}
                      alt="Mapa"
                      className="absolute"
                      onMouseDown={handleMapImageMouseDown}
                      onMouseMove={handleMapImageMouseMove}
                      onMouseUp={handleMapImageMouseUp}
                      onMouseLeave={handleMapImageMouseUp}
                      style={{
                        left: '50%',
                        top: '50%',
                        transform: `translate(calc(-50% + ${vttMapPosition.x}px), calc(-50% + ${vttMapPosition.y}px)) scale(${vttMapScale / 100})`,
                        transformOrigin: 'center center',
                        maxWidth: 'none',
                        maxHeight: 'none',
                        cursor: vttCurrentLayer === 'map' ? (vttDraggingMap ? 'grabbing' : 'grab') : 'default',
                        opacity: vttCurrentLayer === 'map' ? 1 : 0.6,
                        outline: vttCurrentLayer === 'map' ? '3px dashed #f59e0b' : 'none',
                        outlineOffset: '2px',
                        zIndex: 0
                      }}
                    />
                  )}
                  {!vttMapImage && (
                    <div className={`flex items-center justify-center h-full ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                      <p className="text-lg sm:text-xl">Cole a URL de um mapa acima para começar</p>
                    </div>
                  )}

                  {/* Grid Overlay */}
                  {vttShowGrid && vttMapImage && (() => {
                    const cellWidth = vttCanvasWidth / vttGridColumns
                    const cellHeight = vttCanvasHeight / vttGridRows
                    return (
                      <svg className="absolute inset-0 w-full h-full pointer-events-none" style={{ opacity: 0.3 }}>
                        {Array.from({ length: vttGridRows }).map((_, row) =>
                          Array.from({ length: vttGridColumns }).map((_, col) => (
                            <rect
                              key={`grid-${row}-${col}`}
                              x={col * cellWidth}
                              y={row * cellHeight}
                              width={cellWidth}
                              height={cellHeight}
                              fill="none"
                              stroke={darkMode ? '#ffffff' : '#000000'}
                              strokeWidth="1"
                            />
                          ))
                        )}
                      </svg>
                    )
                  })()}

                  {/* Régua de Medição */}
                  {vttRulerActive && (() => {
                    const cellWidth = vttCanvasWidth / vttGridColumns
                    const cellHeight = vttCanvasHeight / vttGridRows
                    // Calcular distância em pixels
                    const dx = vttRulerEnd.x - vttRulerStart.x
                    const dy = vttRulerEnd.y - vttRulerStart.y
                    const distancePixels = Math.sqrt(dx * dx + dy * dy)
                    // Converter para metros (1 quadrado = 1 metro)
                    const avgCellSize = (cellWidth + cellHeight) / 2
                    const distanceMeters = distancePixels / avgCellSize
                    // Posição do texto (meio da linha)
                    const midX = (vttRulerStart.x + vttRulerEnd.x) / 2
                    const midY = (vttRulerStart.y + vttRulerEnd.y) / 2
                    return (
                      <svg className="absolute inset-0 w-full h-full pointer-events-none" style={{ zIndex: 1000 }}>
                        {/* Linha da régua */}
                        <line
                          x1={vttRulerStart.x}
                          y1={vttRulerStart.y}
                          x2={vttRulerEnd.x}
                          y2={vttRulerEnd.y}
                          stroke="#ffcc00"
                          strokeWidth="3"
                          strokeDasharray="8,4"
                        />
                        {/* Círculo no início */}
                        <circle
                          cx={vttRulerStart.x}
                          cy={vttRulerStart.y}
                          r="6"
                          fill="#ffcc00"
                          stroke="#000"
                          strokeWidth="2"
                        />
                        {/* Círculo no fim */}
                        <circle
                          cx={vttRulerEnd.x}
                          cy={vttRulerEnd.y}
                          r="6"
                          fill="#ffcc00"
                          stroke="#000"
                          strokeWidth="2"
                        />
                        {/* Fundo do texto */}
                        <rect
                          x={midX - 35}
                          y={midY - 14}
                          width="70"
                          height="28"
                          rx="4"
                          fill="rgba(0,0,0,0.8)"
                        />
                        {/* Texto com distância */}
                        <text
                          x={midX}
                          y={midY + 5}
                          textAnchor="middle"
                          fill="#ffcc00"
                          fontSize="16"
                          fontWeight="bold"
                          style={{ userSelect: 'none' }}
                        >
                          {distanceMeters.toFixed(1)}m
                        </text>
                      </svg>
                    )
                  })()}

                  {/* Tokens da camada MAPA (embaixo de tudo, visível para todos) */}
                  {vttMapTokens.map(token => (
                    <div
                      key={token.id}
                      className="absolute"
                      onMouseDown={(e) => vttCurrentLayer === 'map' && handleTokenMouseDown(token.id, 'map', e)}
                      style={{
                        left: `${token.x}px`,
                        top: `${token.y}px`,
                        width: `${token.size}px`,
                        height: `${token.size}px`,
                        cursor: vttCurrentLayer === 'map' ? 'move' : 'default',
                        border: selectedToken === token.id ? '3px solid yellow' : '2px solid #b45309',
                        borderRadius: '50%',
                        overflow: 'hidden',
                        opacity: vttCurrentLayer === 'map' ? 1 : 0.4,
                        transform: `rotate(${token.rotation || 0}deg)`,
                        userSelect: 'none',
                        pointerEvents: vttCurrentLayer === 'map' ? 'auto' : 'none',
                        zIndex: 1
                      }}
                    >
                      {token.image && (
                        <img
                          src={token.image}
                          alt={token.name}
                          className="w-full h-full object-cover"
                          style={token.npcType === 'trainer' ? { objectPosition: 'center 20%' } : {}}
                        />
                      )}
                      {!token.image && (
                        <div className="w-full h-full bg-amber-600 flex items-center justify-center text-white font-bold">
                          {token.name?.charAt(0) || 'M'}
                        </div>
                      )}
                      <div className="absolute bottom-0 left-0 right-0 bg-amber-900 bg-opacity-90 text-white text-xs text-center px-1 truncate">
                        {token.name}
                      </div>
                    </div>
                  ))}

                  {/* Tokens da camada GM (só visível para o mestre) */}
                  {vttGMTokens.map(token => (
                    <div
                      key={token.id}
                      className="absolute"
                      onMouseDown={(e) => vttCurrentLayer === 'gm' && handleTokenMouseDown(token.id, 'gm', e)}
                      style={{
                        left: `${token.x}px`,
                        top: `${token.y}px`,
                        width: `${token.size}px`,
                        height: `${token.size}px`,
                        cursor: vttCurrentLayer === 'gm' ? 'move' : 'default',
                        border: selectedToken === token.id ? '3px solid yellow' : '2px solid purple',
                        borderRadius: '50%',
                        overflow: 'hidden',
                        opacity: vttCurrentLayer === 'gm' ? 0.8 : 0.3,
                        transform: `rotate(${token.rotation || 0}deg)`,
                        userSelect: 'none',
                        pointerEvents: vttCurrentLayer === 'gm' ? 'auto' : 'none',
                        zIndex: 2
                      }}
                    >
                      {token.image && (
                        <img
                          src={token.image}
                          alt={token.name}
                          className="w-full h-full object-cover"
                          style={token.npcType === 'trainer' ? { objectPosition: 'center 20%' } : {}}
                        />
                      )}
                      {!token.image && (
                        <div className="w-full h-full bg-purple-500 flex items-center justify-center text-white font-bold">
                          {token.name?.charAt(0) || 'G'}
                        </div>
                      )}
                      <div className="absolute bottom-0 left-0 right-0 bg-purple-900 bg-opacity-90 text-white text-xs text-center px-1 truncate">
                        {token.name}
                      </div>
                    </div>
                  ))}

                  {/* Tokens da camada de JOGADORES (visível para todos) */}
                  {vttTokens.map(token => (
                    <div
                      key={token.id}
                      className="absolute"
                      onMouseDown={(e) => vttCurrentLayer === 'players' && handleTokenMouseDown(token.id, 'tokens', e)}
                      style={{
                        left: `${token.x}px`,
                        top: `${token.y}px`,
                        width: `${token.size}px`,
                        height: `${token.size}px`,
                        cursor: vttCurrentLayer === 'players' ? 'move' : 'default',
                        border: selectedToken === token.id ? '3px solid yellow' : '2px solid black',
                        borderRadius: '50%',
                        overflow: 'hidden',
                        opacity: vttCurrentLayer === 'players' ? 1 : 0.4,
                        transform: `rotate(${token.rotation || 0}deg)`,
                        userSelect: 'none',
                        pointerEvents: vttCurrentLayer === 'players' ? 'auto' : 'none',
                        zIndex: 3
                      }}
                    >
                      {token.image && (
                        <img
                          src={token.image}
                          alt={token.name}
                          className="w-full h-full object-cover"
                          style={token.npcType === 'trainer' ? { objectPosition: 'center 20%' } : {}}
                        />
                      )}
                      {!token.image && (
                        <div className="w-full h-full bg-blue-500 flex items-center justify-center text-white font-bold">
                          {token.name?.charAt(0) || 'T'}
                        </div>
                      )}
                      <div className="absolute bottom-0 left-0 right-0 bg-black bg-opacity-70 text-white text-xs text-center px-1 truncate">
                        {token.name}
                      </div>
                    </div>
                  ))}
                  </div>
                </div>
              </div>

              {/* Seleção de Camada */}
              <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-50'} rounded-lg p-4 mb-4`}>
                <h4 className={`text-lg font-bold mb-3 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  Camadas
                </h4>
                <div className="grid grid-cols-3 gap-2">
                  <button
                    onClick={() => setVttCurrentLayer('map')}
                    className={`px-4 py-3 rounded-lg font-semibold transition-all ${
                      vttCurrentLayer === 'map'
                        ? 'bg-amber-600 text-white ring-2 ring-amber-400'
                        : darkMode
                          ? 'bg-gray-600 text-gray-300 hover:bg-gray-500'
                          : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                    }`}
                  >
                    Mapa
                  </button>
                  <button
                    onClick={() => setVttCurrentLayer('gm')}
                    className={`px-4 py-3 rounded-lg font-semibold transition-all ${
                      vttCurrentLayer === 'gm'
                        ? 'bg-purple-600 text-white ring-2 ring-purple-400'
                        : darkMode
                          ? 'bg-gray-600 text-gray-300 hover:bg-gray-500'
                          : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                    }`}
                  >
                    GM
                  </button>
                  <button
                    onClick={() => setVttCurrentLayer('players')}
                    className={`px-4 py-3 rounded-lg font-semibold transition-all ${
                      vttCurrentLayer === 'players'
                        ? 'bg-blue-600 text-white ring-2 ring-blue-400'
                        : darkMode
                          ? 'bg-gray-600 text-gray-300 hover:bg-gray-500'
                          : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                    }`}
                  >
                    Jogadores
                  </button>
                </div>
                <p className={`text-xs mt-3 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                  {vttCurrentLayer === 'map' && 'Camada Mapa: Objetos ficam embaixo de tudo, visíveis para todos'}
                  {vttCurrentLayer === 'gm' && 'Camada GM: Objetos visíveis apenas para o Mestre'}
                  {vttCurrentLayer === 'players' && 'Camada Jogadores: Objetos visíveis para todos'}
                </p>
              </div>

              {/* Token Treinador NPC */}
              <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-50'} rounded-lg p-4 mb-4`}>
                <h4 className={`text-lg font-bold mb-3 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  Token Treinador NPC
                </h4>
                {npcTrainers.length === 0 ? (
                  <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                    Nenhum treinador NPC criado. Crie treinadores na área "Treinador NPC".
                  </p>
                ) : (
                  <div className="flex flex-wrap gap-2 max-h-40 overflow-y-auto">
                    {npcTrainers.map(trainer => (
                      <button
                        key={trainer.id}
                        onClick={() => {
                          const centerX = (vttCanvasWidth / 2) - (vttGridSize / 2)
                          const centerY = (vttCanvasHeight / 2) - (vttGridSize / 2)
                          const newToken = {
                            id: `gm-token-trainer-${trainer.id}-${Date.now()}`,
                            name: trainer.name,
                            x: centerX,
                            y: centerY,
                            size: vttGridSize,
                            rotation: 0,
                            image: trainer.imageUrl || null,
                            owner: null,
                            npcType: 'trainer',
                            npcId: trainer.id
                          }
                          setVttGMTokens([...vttGMTokens, newToken])
                        }}
                        className={`w-12 h-12 rounded-full border-2 transition-all hover:scale-110 overflow-hidden ${darkMode ? 'border-purple-500 bg-gray-600' : 'border-purple-400 bg-white'}`}
                        title={trainer.name}
                      >
                        {trainer.imageUrl ? (
                          <img
                            src={trainer.imageUrl}
                            alt={trainer.name}
                            className="w-full h-full object-cover object-top"
                            style={{ objectPosition: 'center 20%' }}
                          />
                        ) : (
                          <div className={`w-full h-full flex items-center justify-center text-lg font-bold ${darkMode ? 'bg-purple-700 text-white' : 'bg-purple-200 text-purple-800'}`}>
                            {trainer.name?.charAt(0) || 'T'}
                          </div>
                        )}
                      </button>
                    ))}
                  </div>
                )}
              </div>

              {/* Token Pkm NPC */}
              <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-50'} rounded-lg p-4`}>
                <h4 className={`text-lg font-bold mb-3 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  Token Pkm NPC
                </h4>
                {npcPokemon.length === 0 ? (
                  <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                    Nenhum Pokémon NPC criado. Crie pokémons na área "Pokémon NPC".
                  </p>
                ) : (
                  <div className="grid grid-cols-4 gap-2 max-h-40 overflow-y-auto">
                    {npcPokemon.map(pokemon => (
                      <button
                        key={pokemon.id}
                        onClick={() => {
                          const centerX = (vttCanvasWidth / 2) - (vttGridSize / 2)
                          const centerY = (vttCanvasHeight / 2) - (vttGridSize / 2)
                          const newToken = {
                            id: `gm-token-pokemon-${pokemon.id}-${Date.now()}`,
                            name: pokemon.pokemonName || pokemon.name,
                            x: centerX,
                            y: centerY,
                            size: vttGridSize,
                            rotation: 0,
                            image: pokemon.image || null,
                            owner: null,
                            npcType: 'pokemon',
                            npcId: pokemon.id
                          }
                          setVttGMTokens([...vttGMTokens, newToken])
                        }}
                        className={`p-1 rounded-lg border-2 transition-all hover:scale-105 ${darkMode ? 'border-gray-600 hover:border-blue-500 bg-gray-600' : 'border-gray-300 hover:border-blue-500 bg-white'}`}
                        title={`Adicionar ${pokemon.pokemonName || pokemon.name} ao mapa`}
                      >
                        <div className="w-full aspect-square rounded overflow-hidden">
                          {pokemon.image ? (
                            <img src={pokemon.image} alt={pokemon.pokemonName || pokemon.name} className="w-full h-full object-cover" />
                          ) : (
                            <div className={`w-full h-full flex items-center justify-center text-lg font-bold ${darkMode ? 'bg-blue-700 text-white' : 'bg-blue-200 text-blue-800'}`}>
                              {(pokemon.pokemonName || pokemon.name)?.charAt(0) || 'P'}
                            </div>
                          )}
                        </div>
                        <p className={`text-xs mt-1 truncate text-center ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                          {pokemon.pokemonName || pokemon.name}
                        </p>
                      </button>
                    ))}
                  </div>
                )}
              </div>
            </div>
          )}

          {/* Modal para Adicionar Nova Localidade - VTT */}
          {showAddLocationModal && (
            <div className="fixed inset-0 flex items-center justify-center z-[9999] bg-black bg-opacity-70">
              <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl p-3 sm:p-5 md:p-8 shadow-2xl max-w-md w-full mx-4`}>
                <h3 className={`text-xl sm:text-2xl font-bold mb-6 ${darkMode ? 'text-green-400' : 'text-green-600'}`}>
                  Nova Localidade
                </h3>

                <div className="space-y-4 mb-6">
                  <div>
                    <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      Nome da Localidade
                    </label>
                    <input
                      type="text"
                      value={newLocationName}
                      onChange={(e) => setNewLocationName(e.target.value)}
                      placeholder="Ex: Floresta Viridian, Caverna Cerulean..."
                      className={`w-full px-3 py-2 sm:px-4 rounded-lg border-2 text-sm sm:text-base ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300 bg-white text-gray-800'}`}
                    />
                  </div>

                  <div>
                    <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      URL do Mapa (opcional)
                    </label>
                    <input
                      type="text"
                      value={newLocationMapUrl}
                      onChange={(e) => setNewLocationMapUrl(e.target.value)}
                      placeholder="Cole a URL da imagem do mapa"
                      className={`w-full px-3 py-2 sm:px-4 rounded-lg border-2 text-sm sm:text-base ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300 bg-white text-gray-800'}`}
                    />
                  </div>
                </div>

                <div className="flex gap-2 sm:gap-3 md:gap-4">
                  <button
                    onClick={() => {
                      setShowAddLocationModal(false)
                      setNewLocationName('')
                      setNewLocationMapUrl('')
                    }}
                    className={`flex-1 px-4 py-2 rounded-lg font-semibold ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                  >
                    Cancelar
                  </button>
                  <button
                    onClick={() => {
                      if (!newLocationName.trim()) {
                        alert('Por favor, insira um nome para a localidade.')
                        return
                      }

                      const newLocation = {
                        id: `location-${Date.now()}`,
                        name: newLocationName.trim(),
                        mapUrl: newLocationMapUrl.trim() || null,
                        tokens: [],
                        gmTokens: []
                      }

                      setVttLocations([...vttLocations, newLocation])
                      setCurrentVttLocation(newLocation.id)
                      setShowAddLocationModal(false)
                      setNewLocationName('')
                      setNewLocationMapUrl('')
                    }}
                    disabled={!newLocationName.trim()}
                    className={`flex-1 px-4 py-2 rounded-lg font-semibold ${
                      !newLocationName.trim()
                        ? 'bg-gray-400 text-gray-200 cursor-not-allowed'
                        : 'bg-gradient-to-r from-green-600 to-teal-600 text-white hover:from-green-700 hover:to-teal-700'
                    }`}
                  >
                    Criar Localidade
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
        {accountDataModal}
        {scenarioPopupOverlay}
        {mostrarTriunfosOverlay}
        {pokezapPanel}{pokeAgendaPanel}
        {batalhaChatPanel}
      </>
    )
  }

  // ÁREA ENCICLOPÉDIA M
  if (currentUser.type === 'mestre' && currentArea === 'Enciclopédia M') {
    return (
      <>
        <div className={`min-h-screen ${mainBgClass}`}>
          {sidebarNav}
        <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-lg`}>
          <div className="max-w-7xl mx-auto px-4 py-4">
            <div className="flex justify-between items-center mb-4">
              <div className="flex items-center gap-3"><button onClick={() => setSidebarOpen(true)} className={`p-2 rounded-lg ${darkMode ? "hover:bg-gray-700 text-gray-400" : "hover:bg-gray-200 text-gray-500"}`}><Menu size={24} /></button><h2 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Enciclopédia M 👑</h2></div>
              <div className="flex gap-2">
                <button onClick={() => setShowAccountDataModal(true)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-200 text-gray-700'}`} title="Dados da Conta"><ArrowDownUp size={20} /></button>
                <button onClick={() => setDarkMode(!darkMode)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-yellow-400' : 'bg-gray-200 text-gray-700'}`}>{darkMode ? <Sun size={20} /> : <Moon size={20} />}</button>
                {pokezapBtn}{pokeAgendaBtn}{batalhaChatBtn}<button onClick={handleLogout} className="bg-red-500 text-white px-3 sm:px-5 md:px-6 py-2 rounded-lg hover:bg-red-600">Sair</button>
              </div>
            </div>
          </div>
        </div>

        <div className="max-w-7xl mx-auto px-4 py-3 sm:py-5 md:py-8">
          <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-8`}>
            {/* Menu de Navegação das Subáreas */}
            <div className="mb-6">
              <div className="flex flex-wrap gap-2 justify-center">
                <button
                  onClick={() => setEncyclopediaMSection('Golpedex M')}
                  className={`px-3 py-2 rounded-lg text-sm font-semibold transition-all flex items-center gap-1.5 ${
                    encyclopediaMSection === 'Golpedex M'
                      ? 'bg-gradient-to-r from-red-600 to-orange-600 text-white shadow-lg transform scale-105'
                      : darkMode
                      ? 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                      : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                  }`}
                >
                  <Sparkles size={16} />
                  Golpedex M
                </button>
                <button
                  onClick={() => setEncyclopediaMSection('Descritordex M')}
                  className={`px-3 py-2 rounded-lg text-sm font-semibold transition-all flex items-center gap-1.5 ${
                    encyclopediaMSection === 'Descritordex M'
                      ? 'bg-gradient-to-r from-purple-600 to-indigo-600 text-white shadow-lg transform scale-105'
                      : darkMode
                      ? 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                      : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                  }`}
                >
                  <BookOpenText size={16} />
                  Descritordex M
                </button>
                <button
                  onClick={() => setEncyclopediaMSection('Tag de Concursodex M')}
                  className={`px-3 py-2 rounded-lg text-sm font-semibold transition-all flex items-center gap-1.5 ${
                    encyclopediaMSection === 'Tag de Concursodex M'
                      ? 'bg-gradient-to-r from-pink-600 to-rose-600 text-white shadow-lg transform scale-105'
                      : darkMode
                      ? 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                      : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                  }`}
                >
                  <Crown size={16} />
                  Tag de Concursodex M
                </button>
                <button
                  onClick={() => setEncyclopediaMSection('Períciadex M')}
                  className={`px-3 py-2 rounded-lg text-sm font-semibold transition-all flex items-center gap-1.5 ${
                    encyclopediaMSection === 'Períciadex M'
                      ? 'bg-gradient-to-r from-blue-600 to-cyan-600 text-white shadow-lg transform scale-105'
                      : darkMode
                      ? 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                      : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                  }`}
                >
                  <Zap size={16} />
                  Períciadex M
                </button>
                <button
                  onClick={() => setEncyclopediaMSection('Habilidadedex M')}
                  className={`px-3 py-2 rounded-lg text-sm font-semibold transition-all flex items-center gap-1.5 ${
                    encyclopediaMSection === 'Habilidadedex M'
                      ? 'bg-gradient-to-r from-teal-600 to-emerald-600 text-white shadow-lg transform scale-105'
                      : darkMode
                      ? 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                      : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                  }`}
                >
                  <Sparkles size={16} />
                  Habilidadedex M
                </button>
                <button
                  onClick={() => setEncyclopediaMSection('Capacidadex M')}
                  className={`px-3 py-2 rounded-lg text-sm font-semibold transition-all flex items-center gap-1.5 ${
                    encyclopediaMSection === 'Capacidadex M'
                      ? 'bg-gradient-to-r from-indigo-600 to-violet-600 text-white shadow-lg transform scale-105'
                      : darkMode
                      ? 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                      : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                  }`}
                >
                  <Zap size={16} />
                  Capacidadex M
                </button>
                <button
                  onClick={() => setEncyclopediaMSection('Condiçõesdex M')}
                  className={`px-3 py-2 rounded-lg text-sm font-semibold transition-all flex items-center gap-1.5 ${
                    encyclopediaMSection === 'Condiçõesdex M'
                      ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white shadow-lg transform scale-105'
                      : darkMode
                      ? 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                      : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                  }`}
                >
                  <ShieldPlus size={16} />
                  Condiçõesdex M
                </button>
                <button
                  onClick={() => setEncyclopediaMSection('Itendex M')}
                  className={`px-3 py-2 rounded-lg text-sm font-semibold transition-all flex items-center gap-1.5 ${
                    encyclopediaMSection === 'Itendex M'
                      ? 'bg-gradient-to-r from-amber-600 to-yellow-600 text-white shadow-lg transform scale-105'
                      : darkMode
                      ? 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                      : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                  }`}
                >
                  <Package size={16} />
                  Itendex M
                </button>
              </div>
            </div>

            {/* GOLPEDEX M */}
            {encyclopediaMSection === 'Golpedex M' && (
              <div>
                <h3 className={`text-xl sm:text-2xl font-bold mb-6 text-center ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  Golpedex M
                </h3>
                <p className={`mb-6 text-center ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                  Pesquise até 8 golpes simultaneamente para comparar suas características
                </p>

                {/* Grid 4x2 de Barras de Pesquisa */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-3 sm:p-5 md:p-6 mb-8">
                  {golpedexMSearches.map((search, index) => (
                    <div key={index} className="relative">
                      <label className={`block text-sm font-semibold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                        Golpe #{index + 1}
                      </label>
                      <div className="relative">
                        <Search className={`absolute left-3 top-1/2 transform -translate-y-1/2 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`} size={20} />
                        <input
                          type="text"
                          value={search}
                          onChange={(e) => {
                            const newSearches = [...golpedexMSearches]
                            newSearches[index] = e.target.value
                            setGolpedexMSearches(newSearches)
                          }}
                          placeholder="Digite o nome do golpe..."
                          className={`w-full pl-10 pr-4 py-3 rounded-lg border-2 ${
                            darkMode
                              ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-500 focus:border-purple-500'
                              : 'bg-white border-gray-300 text-gray-800 placeholder-gray-400 focus:border-purple-500'
                          } focus:outline-none transition-all`}
                          list={`golpes-datalist-m-${index}`}
                        />
                        <datalist id={`golpes-datalist-m-${index}`}>
                          {GOLPES_NAMES.filter(nome =>
                            nome.toLowerCase().includes(search.toLowerCase())
                          ).slice(0, 50).map(nome => (
                            <option key={nome} value={nome} />
                          ))}
                        </datalist>
                        {search && (
                          <button
                            onClick={() => {
                              const newSearches = [...golpedexMSearches]
                              newSearches[index] = ''
                              setGolpedexMSearches(newSearches)
                            }}
                            className={`absolute right-3 top-1/2 transform -translate-y-1/2 ${
                              darkMode ? 'text-gray-500 hover:text-gray-300' : 'text-gray-400 hover:text-gray-600'
                            }`}
                          >
                            <X size={20} />
                          </button>
                        )}
                      </div>

                      {/* Exibir informações do golpe se selecionado */}
                      {search && GOLPES_DATA[search] && (
                        <div className={`mt-3 p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                          <div className="space-y-2">
                            <div className="flex items-center gap-2">
                              <span className={`px-3 py-1 rounded-full text-xs font-bold ${TYPE_STYLES[GOLPES_DATA[search].tipo] || 'bg-gray-500'} text-white`}>
                                {GOLPES_DATA[search].tipo}
                              </span>
                              <span className={`px-2 py-1 rounded text-xs font-semibold ${darkMode ? 'bg-gray-600 text-gray-200' : 'bg-white text-gray-700'}`}>
                                {GOLPES_DATA[search].aptidao}
                              </span>
                            </div>

                            <div className="grid grid-cols-2 gap-2 text-sm">
                              <div>
                                <span className={`font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Acurácia:</span>
                                <span className={`ml-2 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                  {GOLPES_DATA[search].acuracia || 'N/A'}
                                </span>
                              </div>
                              <div>
                                <span className={`font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Dano:</span>
                                <span className={`ml-2 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                  {GOLPES_DATA[search].danoBasal || 'N/A'}
                                </span>
                              </div>
                              <div>
                                <span className={`font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Alcance:</span>
                                <span className={`ml-2 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                  {GOLPES_DATA[search].alcance || 'N/A'}
                                </span>
                              </div>
                              <div>
                                <span className={`font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Frequência:</span>
                                <span className={`ml-2 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                  {GOLPES_DATA[search].frequencia || 'N/A'}
                                </span>
                              </div>
                            </div>

                            {GOLPES_DATA[search].descritores && (
                              <div>
                                <span className={`font-semibold text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                  Descritores:
                                </span>
                                <span className={`ml-2 text-sm ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                  {GOLPES_DATA[search].descritores}
                                </span>
                              </div>
                            )}

                            {GOLPES_DATA[search].tagConcurso && (
                              <div>
                                <span className={`font-semibold text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                  Tag Concurso:
                                </span>
                                <span className={`ml-2 text-sm ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                  {GOLPES_DATA[search].tagConcurso}
                                </span>
                              </div>
                            )}

                            <div className={`pt-2 border-t ${darkMode ? 'border-gray-600' : 'border-gray-300'}`}>
                              <div className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                <span className="font-semibold">Efeito:</span> {renderGolpeEfeito(GOLPES_DATA[search].efeito, darkMode)}
                              </div>
                            </div>
                          </div>
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* DESCRITORDEX M */}
            {encyclopediaMSection === 'Descritordex M' && (
              <div>
                <h3 className={`text-xl sm:text-2xl font-bold mb-6 text-center ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  Descritordex M
                </h3>
                <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 sm:gap-3 md:gap-4">
                  {DESCRITORES_DATA.map((descritor) => (
                    <div key={descritor.nome}>
                      <button
                        onClick={() => {
                          if (expandedDescritorM === descritor.nome) {
                            setExpandedDescritorM(null)
                          } else {
                            setExpandedDescritorM(descritor.nome)
                          }
                        }}
                        className={`w-full px-4 py-3 rounded-xl font-semibold transition-all flex items-center justify-between ${
                          expandedDescritorM === descritor.nome
                            ? 'bg-gradient-to-r from-purple-600 to-indigo-600 text-white shadow-lg'
                            : darkMode
                            ? 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                            : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                        }`}
                      >
                        <span>{descritor.nome}</span>
                        <ChevronDown
                          size={20}
                          className={`transition-transform ${
                            expandedDescritorM === descritor.nome ? 'rotate-180' : ''
                          }`}
                        />
                      </button>

                      {expandedDescritorM === descritor.nome && (
                        <div className={`mt-2 p-4 rounded-xl ${
                          darkMode ? 'bg-gray-700' : 'bg-purple-50'
                        } border-2 border-purple-600`}>
                          <h4 className={`font-bold text-lg mb-2 ${darkMode ? 'text-purple-400' : 'text-purple-700'}`}>
                            {descritor.nome}
                          </h4>
                          <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                            {descritor.efeito}
                          </p>
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* TAG DE CONCURSODEX M */}
            {encyclopediaMSection === 'Tag de Concursodex M' && (
              <div>
                <h3 className={`text-xl sm:text-2xl font-bold mb-6 text-center ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  Tag de Concursodex M
                </h3>
                <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 sm:gap-3 md:gap-4">
                  {TAGS_CONCURSO_DATA.map((tag) => (
                    <div key={tag.nome}>
                      <button
                        onClick={() => {
                          if (expandedTagConcursoM === tag.nome) {
                            setExpandedTagConcursoM(null)
                          } else {
                            setExpandedTagConcursoM(tag.nome)
                          }
                        }}
                        className={`w-full px-4 py-3 rounded-xl font-semibold transition-all ${
                          expandedTagConcursoM === tag.nome
                            ? 'bg-gradient-to-r from-pink-600 to-rose-600 text-white shadow-lg'
                            : darkMode
                            ? 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                            : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                        }`}
                      >
                        <div className="flex items-center justify-between">
                          <span>{tag.nome}</span>
                          <ChevronDown
                            size={20}
                            className={`transition-transform ${
                              expandedTagConcursoM === tag.nome ? 'rotate-180' : ''
                            }`}
                          />
                        </div>
                        <div className={`text-xs mt-1 ${
                          expandedTagConcursoM === tag.nome ? 'text-pink-100' : darkMode ? 'text-gray-400' : 'text-gray-500'
                        }`}>
                          Pontuação Basal: {tag.pontuacaoBasal}
                        </div>
                      </button>

                      {expandedTagConcursoM === tag.nome && (
                        <div className={`mt-2 p-4 rounded-xl ${
                          darkMode ? 'bg-gray-700' : 'bg-pink-50'
                        } border-2 border-pink-600`}>
                          <h4 className={`font-bold text-lg mb-2 ${darkMode ? 'text-pink-400' : 'text-pink-700'}`}>
                            {tag.nome}
                          </h4>
                          <p className={`text-sm font-semibold mb-2 ${darkMode ? 'text-pink-300' : 'text-pink-600'}`}>
                            Pontuação Basal: {tag.pontuacaoBasal}
                          </p>
                          <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                            {tag.efeito}
                          </p>
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* PERÍCIADEX M */}
            {encyclopediaMSection === 'Períciadex M' && (
              <div>
                <h3 className={`text-xl sm:text-2xl font-bold mb-6 text-center ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  Períciadex M
                </h3>
                <div className="space-y-4 max-w-sm sm:max-w-2xl md:max-w-4xl mx-auto">
                  {ATRIBUTOS_PERICIAS_DATA.map((atributo) => (
                    <div
                      key={atributo.nome}
                      className={`rounded-xl overflow-hidden ${
                        darkMode ? 'bg-gray-700' : 'bg-blue-50'
                      } border-2 ${
                        expandedAtributoM === atributo.nome ? 'border-blue-600' : 'border-transparent'
                      }`}
                    >
                      <button
                        onClick={() => {
                          if (expandedAtributoM === atributo.nome) {
                            setExpandedAtributoM(null)
                          } else {
                            setExpandedAtributoM(atributo.nome)
                          }
                        }}
                        className={`w-full px-3 sm:px-5 md:px-6 py-4 transition-all flex items-center justify-between ${
                          expandedAtributoM === atributo.nome
                            ? 'bg-gradient-to-r from-blue-600 to-cyan-600 text-white'
                            : darkMode
                            ? 'bg-gray-600 text-gray-300 hover:bg-gray-500'
                            : 'bg-blue-100 text-gray-800 hover:bg-blue-200'
                        }`}
                      >
                        <div className="text-left flex-1">
                          <h4 className="text-lg sm:text-xl font-bold">{atributo.nome}</h4>
                          <p className={`text-sm mt-1 ${
                            expandedAtributoM === atributo.nome ? 'text-blue-100' : darkMode ? 'text-gray-400' : 'text-gray-600'
                          }`}>
                            {atributo.explicacao}
                          </p>
                        </div>
                        <ChevronRight
                          size={24}
                          className={`transition-transform ml-4 ${
                            expandedAtributoM === atributo.nome ? 'rotate-90' : ''
                          }`}
                        />
                      </button>

                      {expandedAtributoM === atributo.nome && (
                        <div className={`px-3 sm:px-5 md:px-6 py-4 space-y-3 ${darkMode ? 'bg-gray-700' : 'bg-white'}`}>
                          {atributo.pericias.map((pericia, index) => (
                            <div
                              key={pericia.nome}
                              className={`p-4 rounded-lg ${
                                darkMode ? 'bg-gray-600' : 'bg-blue-50'
                              }`}
                            >
                              <h6 className={`font-bold text-lg mb-2 ${darkMode ? 'text-blue-400' : 'text-blue-700'}`}>
                                {pericia.nome}
                              </h6>
                              <p className={`text-sm mb-3 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                {pericia.descricao}
                              </p>

                              {/* Tabela da Perícia (se houver) */}
                              {pericia.tabela && (
                                <div className="mt-3 overflow-x-auto">
                                  <table className={`w-full text-sm border-collapse ${
                                    darkMode ? 'border-gray-500' : 'border-gray-300'
                                  }`}>
                                    <thead>
                                      <tr className={darkMode ? 'bg-gray-700' : 'bg-blue-100'}>
                                        <th className={`border p-2 font-semibold text-left ${
                                          darkMode ? 'border-gray-500 text-blue-200' : 'border-gray-300 text-blue-900'
                                        }`}>
                                          Resultado
                                        </th>
                                        {/* Cabeçalhos dinâmicos baseados nas colunas da tabela */}
                                        {Object.keys(pericia.tabela[0])
                                          .filter(key => key !== 'resultado')
                                          .map(key => (
                                            <th key={key} className={`border p-2 font-semibold text-left ${
                                              darkMode ? 'border-gray-500 text-blue-200' : 'border-gray-300 text-blue-900'
                                            }`}>
                                              {key === 'efeito' ? 'Efeito' :
                                               key === 'altura' ? 'Altura' :
                                               key === 'horizontal' ? 'Horizontal' :
                                               key === 'equilibrio' ? 'Equilíbrio' :
                                               key === 'escalada' ? 'Escalada' : key}
                                            </th>
                                          ))}
                                      </tr>
                                    </thead>
                                    <tbody>
                                      {pericia.tabela.map((linha, idx) => (
                                        <tr key={idx} className={idx % 2 === 0
                                          ? (darkMode ? 'bg-gray-650' : 'bg-white')
                                          : (darkMode ? 'bg-gray-600' : 'bg-blue-50')
                                        }>
                                          <td className={`border p-2 font-bold ${
                                            darkMode ? 'border-gray-500 text-blue-300' : 'border-gray-300 text-blue-700'
                                          }`}>
                                            {linha.resultado}
                                          </td>
                                          {Object.keys(linha)
                                            .filter(key => key !== 'resultado')
                                            .map(key => (
                                              <td key={key} className={`border p-2 ${
                                                darkMode ? 'border-gray-500 text-gray-300' : 'border-gray-300 text-gray-700'
                                              }`}>
                                                {linha[key]}
                                              </td>
                                            ))}
                                        </tr>
                                      ))}
                                    </tbody>
                                  </table>
                                </div>
                              )}
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* HABILIDADEDEX M */}
            {encyclopediaMSection === 'Habilidadedex M' && (
              <div>
                <h3 className={`text-xl sm:text-2xl font-bold mb-6 text-center ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  Habilidadedex M
                </h3>
                <p className={`mb-6 text-center ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                  Pesquise até 8 habilidades simultaneamente para comparar suas características
                </p>

                {/* Grid 4x2 de Barras de Pesquisa */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-3 sm:p-5 md:p-6 mb-8">
                  {habilidadedexMSearches.map((search, index) => (
                    <div key={index} className="relative">
                      <label className={`block text-sm font-semibold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                        Habilidade #{index + 1}
                      </label>
                      <div className="relative">
                        <Search className={`absolute left-3 top-1/2 transform -translate-y-1/2 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`} size={20} />
                        <input
                          type="text"
                          value={search}
                          onChange={(e) => {
                            const newSearches = [...habilidadedexMSearches]
                            newSearches[index] = e.target.value
                            setHabilidadedexMSearches(newSearches)
                          }}
                          placeholder="Digite o nome da habilidade..."
                          className={`w-full pl-10 pr-4 py-3 rounded-lg border-2 ${
                            darkMode
                              ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-500 focus:border-teal-500'
                              : 'bg-white border-gray-300 text-gray-800 placeholder-gray-400 focus:border-teal-500'
                          } focus:outline-none transition-all`}
                          list={`habilidades-datalist-m-${index}`}
                        />
                        <datalist id={`habilidades-datalist-m-${index}`}>
                          {HABILIDADES_NAMES.filter(nome =>
                            nome.toLowerCase().includes(search.toLowerCase())
                          ).slice(0, 50).map(nome => (
                            <option key={nome} value={nome} />
                          ))}
                        </datalist>
                        {search && (
                          <button
                            onClick={() => {
                              const newSearches = [...habilidadedexMSearches]
                              newSearches[index] = ''
                              setHabilidadedexMSearches(newSearches)
                            }}
                            className={`absolute right-3 top-1/2 transform -translate-y-1/2 ${
                              darkMode ? 'text-gray-500 hover:text-gray-300' : 'text-gray-400 hover:text-gray-600'
                            }`}
                          >
                            <X size={20} />
                          </button>
                        )}
                      </div>

                      {/* Exibir informações da habilidade se selecionada */}
                      {search && HABILIDADES_DATA[search] && (
                        <div className={`mt-3 p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                          <div className="space-y-2">
                            <div className="flex items-center gap-2">
                              <span className={`px-3 py-1 rounded-full text-xs font-bold ${darkMode ? 'bg-teal-900 text-teal-300' : 'bg-teal-100 text-teal-800'}`}>
                                {HABILIDADES_DATA[search].ativacao || 'N/A'}
                              </span>
                            </div>

                            <div className={`pt-2 border-t ${darkMode ? 'border-gray-600' : 'border-gray-300'}`}>
                              <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                <span className="font-semibold">Efeito:</span> {HABILIDADES_DATA[search].efeito}
                              </p>

                              {/* Tabela da Habilidade (se houver) */}
                              {HABILIDADES_DATA[search].tabela && (
                                <div className="mt-3 overflow-x-auto">
                                  <table className={`w-full text-sm border-collapse ${
                                    darkMode ? 'border-gray-600' : 'border-gray-300'
                                  }`}>
                                    <thead>
                                      <tr className={darkMode ? 'bg-gray-800' : 'bg-teal-100'}>
                                        {/* Cabeçalhos dinâmicos baseados nas colunas da tabela */}
                                        {Object.keys(HABILIDADES_DATA[search].tabela[0]).map(key => (
                                          <th key={key} className={`border p-2 font-semibold text-left ${
                                            darkMode ? 'border-gray-600 text-teal-300' : 'border-gray-300 text-teal-900'
                                          }`}>
                                            {key === 'resultado' ? 'Resultado' :
                                             key === 'efeito' ? 'Efeito' :
                                             key === 'item' ? 'Item' :
                                             key === 'clima' ? 'Clima' :
                                             key === 'tipo' ? 'Tipo' :
                                             key === 'dado' ? 'Dado' :
                                             key.charAt(0).toUpperCase() + key.slice(1)}
                                          </th>
                                        ))}
                                      </tr>
                                    </thead>
                                    <tbody>
                                      {HABILIDADES_DATA[search].tabela.map((linha, idx) => (
                                        <tr key={idx} className={idx % 2 === 0
                                          ? (darkMode ? 'bg-gray-750' : 'bg-white')
                                          : (darkMode ? 'bg-gray-700' : 'bg-teal-50')
                                        }>
                                          {Object.keys(linha).map(key => (
                                            <td key={key} className={`border p-2 ${
                                              key === 'resultado'
                                                ? `font-bold ${darkMode ? 'border-gray-600 text-teal-400' : 'border-gray-300 text-teal-700'}`
                                                : `${darkMode ? 'border-gray-600 text-gray-300' : 'border-gray-300 text-gray-700'}`
                                            }`}>
                                              {linha[key]}
                                            </td>
                                          ))}
                                        </tr>
                                      ))}
                                    </tbody>
                                  </table>
                                </div>
                              )}
                            </div>
                          </div>
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* CAPACIDADEX M */}
            {encyclopediaMSection === 'Capacidadex M' && (
              <div>
                <h3 className={`text-xl sm:text-2xl font-bold mb-6 text-center ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  Capacidadex M
                </h3>
                <p className={`mb-6 text-center ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                  Pesquise até 8 capacidades simultaneamente para comparar suas características
                </p>

                {/* Grid 4x2 de Barras de Pesquisa */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-3 sm:p-5 md:p-6 mb-8">
                  {capacidadexMSearches.map((search, index) => (
                    <div key={index} className="relative">
                      <label className={`block text-sm font-semibold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                        Capacidade #{index + 1}
                      </label>
                      <div className="relative">
                        <Search className={`absolute left-3 top-1/2 transform -translate-y-1/2 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`} size={20} />
                        <input
                          type="text"
                          value={search}
                          onChange={(e) => {
                            const newSearches = [...capacidadexMSearches]
                            newSearches[index] = e.target.value
                            setCapacidadexMSearches(newSearches)
                          }}
                          placeholder="Digite o nome da capacidade..."
                          className={`w-full pl-10 pr-4 py-3 rounded-lg border-2 ${
                            darkMode
                              ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-500 focus:border-indigo-500'
                              : 'bg-white border-gray-300 text-gray-800 placeholder-gray-400 focus:border-indigo-500'
                          } focus:outline-none transition-all`}
                          list={`capacidades-datalist-m-${index}`}
                        />
                        <datalist id={`capacidades-datalist-m-${index}`}>
                          {CAPACIDADES_NAMES.filter(nome =>
                            nome.toLowerCase().includes(search.toLowerCase())
                          ).slice(0, 50).map(nome => (
                            <option key={nome} value={nome} />
                          ))}
                        </datalist>
                        {search && (
                          <button
                            onClick={() => {
                              const newSearches = [...capacidadexMSearches]
                              newSearches[index] = ''
                              setCapacidadexMSearches(newSearches)
                            }}
                            className={`absolute right-3 top-1/2 transform -translate-y-1/2 ${
                              darkMode ? 'text-gray-500 hover:text-gray-300' : 'text-gray-400 hover:text-gray-600'
                            }`}
                          >
                            <X size={20} />
                          </button>
                        )}
                      </div>

                      {/* Exibir informações da capacidade se selecionada */}
                      {search && CAPACIDADES_DATA[search] && (
                        <div className={`mt-3 p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                          <div className="space-y-2">
                            <div className={`pt-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                              <p className={`text-sm leading-relaxed`}>
                                {typeof CAPACIDADES_DATA[search] === 'string'
                                  ? CAPACIDADES_DATA[search]
                                  : CAPACIDADES_DATA[search].descricao}
                              </p>

                              {/* Tabela da Capacidade (se houver) */}
                              {typeof CAPACIDADES_DATA[search] === 'object' && CAPACIDADES_DATA[search].tabela && (
                                <div className="mt-3 overflow-x-auto">
                                  <table className={`w-full text-sm border-collapse ${
                                    darkMode ? 'border-gray-600' : 'border-gray-300'
                                  }`}>
                                    <thead>
                                      <tr className={darkMode ? 'bg-gray-800' : 'bg-teal-100'}>
                                        {/* Cabeçalhos dinâmicos baseados nas colunas da tabela */}
                                        {Object.keys(CAPACIDADES_DATA[search].tabela[0]).map(key => (
                                          <th key={key} className={`border p-2 font-semibold text-left ${
                                            darkMode ? 'border-gray-600 text-teal-300' : 'border-gray-300 text-teal-900'
                                          }`}>
                                            {key === 'força' ? 'Força' :
                                             key === 'peso' ? 'Peso Erguido' :
                                             key === 'inteligência' ? 'Inteligência' :
                                             key === 'intelecto' ? 'Intelecto' :
                                             key === 'pensamentos' ? 'Pensamentos' :
                                             key === 'salto' ? 'Salto' :
                                             key === 'altura' ? 'Altura' :
                                             key === 'resultado' ? 'Resultado' :
                                             key === 'área' ? 'Área' :
                                             key === 'par' ? 'Par de Espécies' :
                                             key === 'condição' ? 'Condição' :
                                             key.charAt(0).toUpperCase() + key.slice(1)}
                                          </th>
                                        ))}
                                      </tr>
                                    </thead>
                                    <tbody>
                                      {CAPACIDADES_DATA[search].tabela.map((linha, idx) => (
                                        <tr key={idx} className={idx % 2 === 0
                                          ? (darkMode ? 'bg-gray-750' : 'bg-white')
                                          : (darkMode ? 'bg-gray-700' : 'bg-teal-50')
                                        }>
                                          {Object.keys(linha).map(key => (
                                            <td key={key} className={`border p-2 ${
                                              ['força', 'inteligência', 'salto', 'resultado'].includes(key)
                                                ? `font-bold ${darkMode ? 'border-gray-600 text-teal-400' : 'border-gray-300 text-teal-700'}`
                                                : `${darkMode ? 'border-gray-600 text-gray-300' : 'border-gray-300 text-gray-700'}`
                                            }`}>
                                              {linha[key]}
                                            </td>
                                          ))}
                                        </tr>
                                      ))}
                                    </tbody>
                                  </table>
                                </div>
                              )}
                            </div>
                          </div>
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* CONDIÇÕESDEX M */}
            {encyclopediaMSection === 'Condiçõesdex M' && (
              <div>
                <h3 className={`text-xl sm:text-2xl font-bold mb-6 text-center ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  Condiçõesdex M
                </h3>
                <p className={`mb-6 text-center ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                  Clique em uma condição para expandir e ver suas informações detalhadas
                </p>

                {/* Lista de Condições em coluna única */}
                <div className="grid grid-cols-1 gap-2 sm:gap-3 md:gap-4">
                  {condicoes.map((condicao) => {
                    const isExpanded = expandedCondicoesM.includes(condicao.nome)

                    return (
                      <div
                        key={condicao.nome}
                        className={`${
                          darkMode ? 'bg-gray-700' : 'bg-gray-100'
                        } rounded-lg overflow-hidden transition-all`}
                      >
                        <button
                          onClick={() => {
                            if (isExpanded) {
                              setExpandedCondicoesM(expandedCondicoesM.filter(nome => nome !== condicao.nome))
                            } else {
                              setExpandedCondicoesM([...expandedCondicoesM, condicao.nome])
                            }
                          }}
                          className={`w-full p-4 text-left flex justify-between items-center ${
                            darkMode ? 'hover:bg-gray-600' : 'hover:bg-gray-200'
                          } transition-colors`}
                        >
                          <span className={`font-bold text-lg ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                            {condicao.nome}
                          </span>
                          {isExpanded ? (
                            <ChevronUp className={darkMode ? 'text-gray-300' : 'text-gray-600'} size={24} />
                          ) : (
                            <ChevronDown className={darkMode ? 'text-gray-300' : 'text-gray-600'} size={24} />
                          )}
                        </button>

                        {isExpanded && (
                          <div className={`p-3 sm:p-5 md:p-6 ${darkMode ? 'bg-gray-750' : 'bg-white'} border-t ${darkMode ? 'border-gray-600' : 'border-gray-300'}`}>
                            <p className={`${darkMode ? 'text-gray-300' : 'text-gray-700'} leading-relaxed mb-4`}>
                              {condicao.descricao}
                            </p>

                            {condicao.tabela && (
                              <div className="mt-4">
                                <h4 className={`font-bold text-lg mb-3 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                  {condicao.tabela.titulo}
                                </h4>
                                <div className="overflow-x-auto">
                                  <table className={`w-full border ${darkMode ? 'border-gray-600' : 'border-gray-300'}`}>
                                    <thead>
                                      <tr className={darkMode ? 'bg-gray-600' : 'bg-gray-200'}>
                                        {condicao.tabela.colunas.map((coluna, idx) => (
                                          <th
                                            key={idx}
                                            className={`px-4 py-2 text-left font-semibold ${
                                              darkMode ? 'text-white' : 'text-gray-800'
                                            } border ${darkMode ? 'border-gray-600' : 'border-gray-300'}`}
                                          >
                                            {coluna}
                                          </th>
                                        ))}
                                      </tr>
                                    </thead>
                                    <tbody>
                                      {condicao.tabela.linhas.map((linha, idx) => (
                                        <tr
                                          key={idx}
                                          className={`${
                                            idx % 2 === 0
                                              ? darkMode ? 'bg-gray-700' : 'bg-gray-50'
                                              : darkMode ? 'bg-gray-750' : 'bg-white'
                                          }`}
                                        >
                                          {linha.map((celula, cellIdx) => (
                                            <td
                                              key={cellIdx}
                                              className={`px-4 py-2 ${
                                                darkMode ? 'text-gray-300' : 'text-gray-700'
                                              } border ${darkMode ? 'border-gray-600' : 'border-gray-300'}`}
                                            >
                                              {celula}
                                            </td>
                                          ))}
                                        </tr>
                                      ))}
                                    </tbody>
                                  </table>
                                </div>
                              </div>
                            )}
                          </div>
                        )}
                      </div>
                    )
                  })}
                </div>
              </div>
            )}

            {/* ITENDEX M */}
            {encyclopediaMSection === 'Itendex M' && (
              <div>
                <h3 className={`text-xl sm:text-2xl font-bold mb-6 text-center ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  Itendex M
                </h3>
                <p className={`mb-6 text-center ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                  Catálogo completo de itens disponíveis na Pokéloja. Clique em um corredor para expandir.
                </p>

                {/* Lista de itens por corredor */}
                <div className="space-y-4">
                  {Object.entries(POKELOJA_DATA).map(([corredor, itens]) => {
                    const isExpanded = expandedItendexCorredoresM.includes(corredor)
                    return (
                      <div key={corredor} className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} rounded-lg overflow-hidden`}>
                        <button
                          onClick={() => {
                            if (isExpanded) {
                              setExpandedItendexCorredoresM(expandedItendexCorredoresM.filter(c => c !== corredor))
                            } else {
                              setExpandedItendexCorredoresM([...expandedItendexCorredoresM, corredor])
                            }
                          }}
                          className={`w-full p-4 text-left flex justify-between items-center ${darkMode ? 'hover:bg-gray-600' : 'hover:bg-gray-200'} transition-colors`}
                        >
                          <h4 className={`text-lg sm:text-xl font-bold ${darkMode ? 'text-purple-400' : 'text-purple-600'}`}>
                            Corredor de {corredor}
                            <span className={`ml-2 text-sm font-normal ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                              ({itens.length} itens)
                            </span>
                          </h4>
                          {isExpanded ? (
                            <ChevronUp className={darkMode ? 'text-gray-300' : 'text-gray-600'} size={24} />
                          ) : (
                            <ChevronDown className={darkMode ? 'text-gray-300' : 'text-gray-600'} size={24} />
                          )}
                        </button>

                        {isExpanded && (
                          <div className={`p-4 border-t ${darkMode ? 'border-gray-600 bg-gray-750' : 'border-gray-300 bg-white'}`}>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 sm:gap-3 md:gap-4">
                              {itens.map((item) => (
                                <div
                                  key={item.name}
                                  className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} rounded-lg p-4 flex gap-2 sm:gap-3 md:gap-4`}
                                >
                                  <img
                                    src={item.image}
                                    alt={item.name}
                                    className="w-16 h-16 object-contain flex-shrink-0"
                                    onError={(e) => { e.target.src = '/pokeballs/pokeball.png' }}
                                  />
                                  <div className="flex-1 min-w-0">
                                    <h5 className={`font-bold text-lg ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                      {item.name}{item.realName ? ` (${item.realName})` : ''}
                                    </h5>
                                    {item.price != null && (
                                      <p className={`text-sm ${darkMode ? 'text-yellow-400' : 'text-yellow-600'} font-semibold`}>
                                        ₽ {(customPrices[item.name] !== undefined ? customPrices[item.name] : item.price).toLocaleString()}
                                      </p>
                                    )}
                                    {item.description && (
                                      <p className={`text-sm mt-2 ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                                        {renderDescriptionWithFlavors(item.description)}
                                      </p>
                                    )}
                                  </div>
                                </div>
                              ))}
                            </div>
                          </div>
                        )}
                      </div>
                    )
                  })}
                </div>
              </div>
            )}
          </div>
        </div>
        </div>

        {accountDataModal}
        {scenarioPopupOverlay}
        {mostrarTriunfosOverlay}
        {pokezapPanel}{pokeAgendaPanel}
        {batalhaChatPanel}
      </>
    )
  }

  // ÁREA VISÃO DO MESTRE
  if (currentUser.type === 'mestre' && currentArea === 'Visão do Mestre') {
    // Filtrar apenas contas de treinadores
    const treinadores = users.filter(u => u.type === 'treinador')

    // Usar dados do treinador carregados pelo useEffect
    const trainerData = selectedTrainerData

    // Função para calcular HP máximo do pokémon: (3 x Saúde Total) + Nível
    const calculatePokemonMaxHP = (pokemon) => {
      const saudeBase = parseInt(pokemon.baseAttributes?.saude) || 0
      const bonusVal = parseInt(pokemon.bonusPoints?.saude) || 0
      const selectedNature = natures.find(n => n.nome === pokemon.nature)
      const isIncreased = selectedNature?.up === 'Saúde'
      const isDecreased = selectedNature?.down === 'Saúde'
      const natureBonus = isIncreased ? 1 : isDecreased ? -1 : 0
      const saudePontos = parseInt(pokemon.levelPoints?.saude) || 0
      const saudeTotal = saudeBase + bonusVal + natureBonus + saudePontos
      return (3 * saudeTotal) + (pokemon.level || 1)
    }

    return (
      <>
        <div className={`min-h-screen ${mainBgClass}`}>
          {sidebarNav}
        <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-lg`}>
          <div className="max-w-7xl mx-auto px-4 py-4">
            <div className="flex justify-between items-center mb-4">
              <div className="flex items-center gap-3"><button onClick={() => setSidebarOpen(true)} className={`p-2 rounded-lg ${darkMode ? "hover:bg-gray-700 text-gray-400" : "hover:bg-gray-200 text-gray-500"}`}><Menu size={24} /></button><h2 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Visão do Mestre 👑</h2></div>
              <div className="flex gap-2">
                <button onClick={() => setShowAccountDataModal(true)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-200 text-gray-700'}`} title="Dados da Conta"><ArrowDownUp size={20} /></button>
                <button onClick={() => setDarkMode(!darkMode)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-yellow-400' : 'bg-gray-200 text-gray-700'}`}>{darkMode ? <Sun size={20} /> : <Moon size={20} />}</button>
                {pokezapBtn}{pokeAgendaBtn}{batalhaChatBtn}<button onClick={handleLogout} className="bg-red-500 text-white px-3 sm:px-5 md:px-6 py-2 rounded-lg hover:bg-red-600">Sair</button>
              </div>
            </div>
          </div>
        </div>

        <div className="max-w-7xl mx-auto px-4 py-3 sm:py-5 md:py-8">
          <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-8`}>
            {/* Menu de Navegação das Subáreas */}
            <div className="mb-6">
              <div className="flex flex-wrap gap-3 justify-center">
                <button
                  onClick={() => {
                    setVisaoMestreSection('Perfis')
                    setSelectedTrainer(null)
                  }}
                  className={`px-3 sm:px-5 md:px-6 py-3 rounded-xl font-semibold transition-all flex items-center gap-2 ${
                    visaoMestreSection === 'Perfis'
                      ? 'bg-gradient-to-r from-blue-600 to-cyan-600 text-white shadow-lg transform scale-105'
                      : darkMode
                      ? 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                      : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                  }`}
                >
                  <Users size={20} />
                  Perfis
                </button>
                <button
                  onClick={() => {
                    setVisaoMestreSection('Pokéloja Config')
                    setSelectedTrainer(null)
                  }}
                  className={`px-3 sm:px-5 md:px-6 py-3 rounded-xl font-semibold transition-all flex items-center gap-2 ${
                    visaoMestreSection === 'Pokéloja Config'
                      ? 'bg-gradient-to-r from-green-600 to-emerald-600 text-white shadow-lg transform scale-105'
                      : darkMode
                      ? 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                      : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                  }`}
                >
                  <ShoppingBag size={20} />
                  Pokéloja Config
                </button>
              </div>
            </div>

            {/* POKÉLOJA CONFIG */}
            {visaoMestreSection === 'Pokéloja Config' && (
              <div>
                <h3 className={`text-xl sm:text-2xl font-bold mb-6 text-center ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  Configuração da Pokéloja
                </h3>
                <p className={`text-center mb-6 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                  Marque "Esconder" para ocultar itens da Pokéloja para todos os treinadores
                </p>

                {/* Corredores da Pokéloja */}
                <div className="space-y-8">
                  {Object.entries(POKELOJA_DATA).map(([corredor, items]) => (
                    <div key={corredor} className={`p-3 sm:p-5 md:p-6 rounded-xl ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                      <div className="flex flex-col xs:flex-row items-start xs:items-center justify-between gap-2 xs:gap-3 mb-4">
                        <h4 className={`text-base sm:text-lg md:text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                          {corredor}
                        </h4>
                        <div className="flex items-center gap-1.5 sm:gap-2 flex-wrap">
                          <button
                            onClick={() => sortearItensEscondidosCorredor(corredor, items)}
                            className={`flex items-center gap-1 sm:gap-2 px-2 sm:px-3 py-1.5 rounded-lg text-xs sm:text-sm font-medium transition-all whitespace-nowrap ${
                              darkMode
                                ? 'bg-purple-600 hover:bg-purple-700 text-white'
                                : 'bg-purple-500 hover:bg-purple-600 text-white'
                            }`}
                            title="Sortear aleatoriamente quais itens serão escondidos neste corredor"
                          >
                            <Dices size={14} className="sm:w-4 sm:h-4" />
                            <span className="hidden xs:inline">Sortear Escondidos</span>
                            <span className="xs:hidden">Sortear</span>
                          </button>
                          <button
                            onClick={() => resetarCorredor(corredor, items)}
                            className={`flex items-center gap-1 sm:gap-2 px-2 sm:px-3 py-1.5 rounded-lg text-xs sm:text-sm font-medium transition-all whitespace-nowrap ${
                              darkMode
                                ? 'bg-orange-600 hover:bg-orange-700 text-white'
                                : 'bg-orange-500 hover:bg-orange-600 text-white'
                            }`}
                            title="Resetar corredor: remover itens escondidos e preços customizados"
                          >
                            <RotateCw size={14} className="sm:w-4 sm:h-4" />
                            Resetar
                          </button>
                        </div>
                      </div>
                      <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 sm:gap-3 md:gap-4">
                        {items.map((item) => {
                          const isHidden = hiddenPokelojaItems.includes(item.name)
                          const currentPrice = customPrices[item.name] !== undefined ? customPrices[item.name] : item.price
                          const hasCustomPrice = customPrices[item.name] !== undefined
                          const isEditing = editingPriceItem === item.name
                          return (
                            <div
                              key={item.name}
                              className={`p-3 sm:p-4 rounded-lg border-2 transition-all ${
                                isHidden
                                  ? darkMode ? 'bg-gray-800 border-red-500 opacity-60' : 'bg-gray-200 border-red-400 opacity-60'
                                  : darkMode ? 'bg-gray-600 border-gray-500' : 'bg-white border-gray-300'
                              }`}
                            >
                              <div className="text-center mb-3">
                                <h5 className={`font-bold text-sm mb-1 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                  {item.name}
                                </h5>
                                {/* Preço com edição */}
                                <div className="flex items-center justify-center gap-2 mb-2">
                                  {isEditing ? (
                                    <div className="flex items-center gap-1">
                                      <span className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>₽</span>
                                      <input
                                        type="number"
                                        value={editingPriceValue}
                                        onChange={(e) => setEditingPriceValue(e.target.value)}
                                        className={`w-20 px-2 py-1 text-xs rounded border ${darkMode ? 'bg-gray-700 border-gray-500 text-white' : 'bg-white border-gray-300 text-gray-800'}`}
                                        autoFocus
                                        onKeyDown={async (e) => {
                                          if (e.key === 'Enter') {
                                            const newPrice = parseInt(editingPriceValue)
                                            if (!isNaN(newPrice) && newPrice >= 0) {
                                              const newCustomPrices = { ...customPrices, [item.name]: newPrice }
                                              setCustomPrices(newCustomPrices)
                                              if (useFirebase) {
                                                await saveCustomPrices(newCustomPrices)
                                              }
                                            }
                                            setEditingPriceItem(null)
                                            setEditingPriceValue('')
                                          } else if (e.key === 'Escape') {
                                            setEditingPriceItem(null)
                                            setEditingPriceValue('')
                                          }
                                        }}
                                      />
                                      <button
                                        onClick={async () => {
                                          const newPrice = parseInt(editingPriceValue)
                                          if (!isNaN(newPrice) && newPrice >= 0) {
                                            const newCustomPrices = { ...customPrices, [item.name]: newPrice }
                                            setCustomPrices(newCustomPrices)
                                            if (useFirebase) {
                                              await saveCustomPrices(newCustomPrices)
                                            }
                                          }
                                          setEditingPriceItem(null)
                                          setEditingPriceValue('')
                                        }}
                                        className="p-1 rounded bg-green-500 hover:bg-green-600 text-white"
                                        title="Confirmar"
                                      >
                                        <Check size={12} />
                                      </button>
                                      <button
                                        onClick={() => {
                                          setEditingPriceItem(null)
                                          setEditingPriceValue('')
                                        }}
                                        className="p-1 rounded bg-red-500 hover:bg-red-600 text-white"
                                        title="Cancelar"
                                      >
                                        <X size={12} />
                                      </button>
                                    </div>
                                  ) : (
                                    <>
                                      <p className={`text-xs ${hasCustomPrice ? 'text-green-500 font-bold' : darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                        ₽{currentPrice}
                                        {hasCustomPrice && (
                                          <span className={`ml-1 line-through ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                                            ₽{item.price}
                                          </span>
                                        )}
                                      </p>
                                      <button
                                        onClick={() => {
                                          setEditingPriceItem(item.name)
                                          setEditingPriceValue(currentPrice.toString())
                                        }}
                                        className={`p-1 rounded ${darkMode ? 'hover:bg-gray-500 text-blue-400' : 'hover:bg-gray-200 text-blue-600'}`}
                                        title="Editar preço"
                                      >
                                        <Edit size={12} />
                                      </button>
                                      {hasCustomPrice && (
                                        <button
                                          onClick={async () => {
                                            const newCustomPrices = { ...customPrices }
                                            delete newCustomPrices[item.name]
                                            setCustomPrices(newCustomPrices)
                                            if (useFirebase) {
                                              await saveCustomPrices(newCustomPrices)
                                            }
                                          }}
                                          className={`p-1 rounded ${darkMode ? 'hover:bg-gray-500 text-orange-400' : 'hover:bg-gray-200 text-orange-600'}`}
                                          title="Resetar preço"
                                        >
                                          <RotateCw size={12} />
                                        </button>
                                      )}
                                    </>
                                  )}
                                </div>
                                <p className={`text-xs ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                  {item.description}
                                </p>
                              </div>
                              <div className="flex items-center justify-center gap-2 mt-3">
                                <input
                                  type="checkbox"
                                  id={`hide-${item.name}`}
                                  checked={isHidden}
                                  onChange={async (e) => {
                                    let newHiddenItems
                                    if (e.target.checked) {
                                      newHiddenItems = [...hiddenPokelojaItems, item.name]
                                    } else {
                                      newHiddenItems = hiddenPokelojaItems.filter(name => name !== item.name)
                                    }
                                    setHiddenPokelojaItems(newHiddenItems)
                                    if (useFirebase) {
                                      await saveHiddenPokelojaItems(newHiddenItems)
                                    }
                                  }}
                                  className="w-4 h-4 cursor-pointer"
                                />
                                <label
                                  htmlFor={`hide-${item.name}`}
                                  className={`text-xs cursor-pointer ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}
                                >
                                  Esconder
                                </label>
                              </div>
                            </div>
                          )
                        })}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* PERFIS */}
            {visaoMestreSection === 'Perfis' && (
              <div>
                <h3 className={`text-xl sm:text-2xl font-bold mb-6 text-center ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  Perfis dos Treinadores
                </h3>

                {/* Botões dos Treinadores */}
                {!selectedTrainer && (
                  <div className="flex flex-wrap gap-2 sm:gap-3 justify-center mb-8">
                    {treinadores.map(treinador => (
                      <button
                        key={treinador.username}
                        onClick={() => setSelectedTrainer(treinador.username)}
                        className={`px-4 sm:px-5 md:px-6 py-3 sm:py-4 rounded-xl font-bold text-sm sm:text-base text-white shadow-lg hover:shadow-xl transition-all transform hover:scale-105`}
                        style={{ background: treinador.gradient }}
                      >
                        {treinador.username}
                      </button>
                    ))}
                  </div>
                )}

                {/* Card do Treinador Selecionado */}
                {selectedTrainer && (
                  <div>
                    {/* Botão Voltar */}
                    <button
                      onClick={() => {
                        setSelectedTrainer(null)
                        setExpandedTeamPokemon(null)
                        setShowMestreBackgroundModal(false)
                        setShowMestreInsigniasModal(false)
                      }}
                      className={`mb-6 px-4 py-2 rounded-lg flex items-center gap-2 ${
                        darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                      }`}
                    >
                      <ChevronLeft size={20} />
                      Voltar
                    </button>

                    {/* Informações do Treinador */}
                    <div className="space-y-6">
                      {/* Card Principal */}
                      <div className={`p-3 sm:p-5 md:p-6 rounded-xl ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                        <h4 className={`text-xl sm:text-2xl font-bold mb-6 text-center ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                          {selectedTrainer}
                        </h4>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-2 sm:gap-3 md:gap-4">
                          {/* De olho nas informações */}
                          <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-600' : 'bg-white'}`}>
                            <h5 className={`text-lg font-bold mb-3 flex items-center gap-2 ${darkMode ? 'text-blue-400' : 'text-blue-700'}`}>
                              <Info size={20} />
                              De olho nas informações
                            </h5>
                            <div className="space-y-2 text-sm">
                              <div className="flex justify-between">
                                <span className={darkMode ? 'text-gray-400' : 'text-gray-600'}>Nível:</span>
                                <span className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                  {trainerData?.level || 1}
                                </span>
                              </div>
                              <div className="flex justify-between">
                                <span className={darkMode ? 'text-gray-400' : 'text-gray-600'}>Classes&Subclasses:</span>
                                <span className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                  {trainerData?.classes && trainerData.classes.length > 0
                                    ? trainerData.classes.join(', ')
                                    : '-'}
                                </span>
                              </div>
                              <div className="flex justify-between">
                                <span className={darkMode ? 'text-gray-400' : 'text-gray-600'}>HP:</span>
                                <span className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                  {trainerData?.currentHP || 0} / {trainerData ? ((trainerData.level + trainerData.attributes.saude) * 4) : 0}
                                </span>
                              </div>
                            </div>
                          </div>

                          {/* De olho nas estatísticas */}
                          <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-600' : 'bg-white'}`}>
                            <h5 className={`text-lg font-bold mb-3 flex items-center gap-2 ${darkMode ? 'text-purple-400' : 'text-purple-700'}`}>
                              <BarChart3 size={20} />
                              De olho nas estatísticas
                            </h5>
                            <div className="space-y-2 text-sm">
                              <div className="flex justify-between">
                                <span className={darkMode ? 'text-gray-400' : 'text-gray-600'}>Pokémon Capturados:</span>
                                <span className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                  {trainerData?.pokedex?.filter(p => p.isCaptured).length || 0}
                                </span>
                              </div>
                              <div className="flex justify-between">
                                <span className={darkMode ? 'text-gray-400' : 'text-gray-600'}>Pokémon Escaneados:</span>
                                <span className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                  {trainerData?.pokedex?.length || 0}
                                </span>
                              </div>
                            </div>
                          </div>
                        </div>

                        {/* Botões de Ação */}
                        <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2 sm:gap-3 mt-6">
                          {/* De olho no time */}
                          <button
                            onClick={() => setExpandedTeamPokemon(expandedTeamPokemon === null ? 0 : null)}
                            className={`p-3 sm:p-4 rounded-lg text-left transition-all ${
                              expandedTeamPokemon !== null
                                ? 'bg-gradient-to-r from-green-600 to-emerald-600 text-white'
                                : darkMode
                                ? 'bg-gray-600 text-gray-300 hover:bg-gray-500'
                                : 'bg-white text-gray-700 hover:bg-gray-50'
                            }`}
                          >
                            <div className="flex items-center gap-2 mb-1">
                              <Users size={16} className="sm:w-[18px] sm:h-[18px]" />
                              <span className="font-bold text-sm sm:text-base">De olho no time</span>
                            </div>
                            <p className="text-xs opacity-75">Ver equipe principal</p>
                          </button>

                          {/* De olho nos Carac&Tale */}
                          <button
                            onClick={() => setShowCaracTaleModal(true)}
                            className={`p-3 sm:p-4 rounded-lg text-left transition-all ${
                              darkMode
                                ? 'bg-gray-600 text-gray-300 hover:bg-gray-500'
                                : 'bg-white text-gray-700 hover:bg-gray-50'
                            }`}
                          >
                            <div className="flex items-center gap-2 mb-1">
                              <Sparkles size={16} className="sm:w-[18px] sm:h-[18px]" />
                              <span className="font-bold text-sm sm:text-base">De olho nos Carac&Tale</span>
                            </div>
                            <p className="text-xs opacity-75">Ver habilidades</p>
                          </button>

                          {/* De olho na Mochila */}
                          <button
                            onClick={() => setShowMochilaModal(true)}
                            className={`p-3 sm:p-4 rounded-lg text-left transition-all ${
                              darkMode
                                ? 'bg-gray-600 text-gray-300 hover:bg-gray-500'
                                : 'bg-white text-gray-700 hover:bg-gray-50'
                            }`}
                          >
                            <div className="flex items-center gap-2 mb-1">
                              <Package size={16} className="sm:w-[18px] sm:h-[18px]" />
                              <span className="font-bold text-sm sm:text-base">De olho na Mochila</span>
                            </div>
                            <p className="text-xs opacity-75">Ver itens</p>
                          </button>

                          {/* De olho nas vivências */}
                          <button
                            onClick={() => setShowVivenciasModal(true)}
                            className={`p-3 sm:p-4 rounded-lg text-left transition-all ${
                              darkMode
                                ? 'bg-gray-600 text-gray-300 hover:bg-gray-500'
                                : 'bg-white text-gray-700 hover:bg-gray-50'
                            }`}
                          >
                            <div className="flex items-center gap-2 mb-1">
                              <BookOpen size={16} className="sm:w-[18px] sm:h-[18px]" />
                              <span className="font-bold text-sm sm:text-base">De olho nas vivências</span>
                            </div>
                            <p className="text-xs opacity-75">Ver vivências</p>
                          </button>

                          {/* De olho no Background */}
                          <button
                            onClick={() => setShowMestreBackgroundModal(true)}
                            className={`p-3 sm:p-4 rounded-lg text-left transition-all ${
                              darkMode
                                ? 'bg-gray-600 text-gray-300 hover:bg-gray-500'
                                : 'bg-white text-gray-700 hover:bg-gray-50'
                            }`}
                          >
                            <div className="flex items-center gap-2 mb-1">
                              <FileText size={16} className="sm:w-[18px] sm:h-[18px]" />
                              <span className="font-bold text-sm sm:text-base">De olho no Background</span>
                            </div>
                            <p className="text-xs opacity-75">Ver história</p>
                          </button>

                          {/* De olho nas Insígnias */}
                          <button
                            onClick={() => setShowMestreInsigniasModal(true)}
                            className={`p-3 sm:p-4 rounded-lg text-left transition-all ${
                              darkMode
                                ? 'bg-gray-600 text-gray-300 hover:bg-gray-500'
                                : 'bg-white text-gray-700 hover:bg-gray-50'
                            }`}
                          >
                            <div className="flex items-center gap-2 mb-1">
                              <Award size={16} className="sm:w-[18px] sm:h-[18px]" />
                              <span className="font-bold text-sm sm:text-base">De olho nas Insígnias</span>
                            </div>
                            <p className="text-xs opacity-75">Ver insígnias</p>
                          </button>
                        </div>

                        {/* Time Expandido */}
                        {expandedTeamPokemon !== null && (
                          <div className={`mt-6 p-3 sm:p-4 rounded-lg ${darkMode ? 'bg-gray-600' : 'bg-white'}`}>
                            <h5 className={`text-base sm:text-lg font-bold mb-3 sm:mb-4 ${darkMode ? 'text-green-400' : 'text-green-700'}`}>
                              Time Principal
                            </h5>
                            {trainerData?.mainTeam && trainerData.mainTeam.length > 0 ? (
                              <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2 sm:gap-3">
                                {trainerData.mainTeam.map((pokemon, index) => {
                                  const maxHP = calculatePokemonMaxHP(pokemon)
                                  return (
                                    <div key={index} className={`p-2 sm:p-3 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'} text-center`}>
                                      {pokemon.isAlpha && (
                                        <span
                                          className="inline-block px-2 py-0.5 rounded-md text-xs font-bold text-red-600 mb-1"
                                          style={{ background: 'linear-gradient(135deg, #C0C0C0, #FFFFFF)' }}
                                        >
                                          Alpha
                                        </span>
                                      )}
                                      <h6 className={`font-bold text-sm mb-1 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                        {pokemon.nickname || pokemon.species}
                                      </h6>
                                      {pokemon.nickname && (
                                        <p className={`text-xs mb-2 italic ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                          {pokemon.species}
                                        </p>
                                      )}
                                      <div className="space-y-1 text-xs mt-2">
                                        <div>
                                          <span className={darkMode ? 'text-gray-400' : 'text-gray-600'}>HP: </span>
                                          <span className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                            {pokemon.currentHP !== undefined ? pokemon.currentHP : '-'}/{maxHP}
                                          </span>
                                        </div>
                                        <div>
                                          <span className={darkMode ? 'text-gray-400' : 'text-gray-600'}>Nível: </span>
                                          <span className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                            {pokemon.level || 1}
                                          </span>
                                        </div>
                                      </div>
                                    </div>
                                  )
                                })}
                              </div>
                            ) : (
                              <div className={`text-center p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                                <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                  Nenhum Pokémon no time
                                </p>
                              </div>
                            )}
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                )}
              </div>
            )}
          </div>
        </div>

        {/* Modal de Características & Talentos */}
        {showCaracTaleModal && selectedTrainer && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-2 sm:p-4">
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-[95vw] sm:max-w-2xl md:max-w-4xl w-full max-h-[90vh] overflow-y-auto`}>
              <div className={`sticky top-0 ${darkMode ? 'bg-gray-800' : 'bg-white'} p-3 sm:p-4 md:p-5 border-b ${darkMode ? 'border-gray-700' : 'border-gray-200'} flex justify-between items-center`}>
                <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  Características & Talentos - {selectedTrainer}
                </h3>
                <button
                  onClick={() => setShowCaracTaleModal(false)}
                  className={`p-2 rounded-lg ${darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-100'}`}
                >
                  <X size={24} className={darkMode ? 'text-gray-400' : 'text-gray-600'} />
                </button>
              </div>
              <div className="p-3 sm:p-4 md:p-5 space-y-4 sm:space-y-6">
                {/* Características de Classe */}
                <div>
                  <h4 className={`text-base sm:text-lg md:text-xl font-bold mb-3 sm:mb-4 ${darkMode ? 'text-blue-400' : 'text-blue-700'}`}>
                    Características de Classe
                  </h4>
                  {(() => {
                    // Obter características das classes/subclasses do usuário
                    const userCaracteristicas = []
                    if (trainerData?.classes) {
                      trainerData.classes.forEach(className => {
                        if (className && CARACTERISTICAS_DATA[className]) {
                          const caracteristicasObj = CARACTERISTICAS_DATA[className]
                          // Verificar se é um array ou objeto
                          if (Array.isArray(caracteristicasObj)) {
                            // Se for array, iterar diretamente
                            caracteristicasObj.forEach(carac => {
                              userCaracteristicas.push({
                                name: carac.nome || 'Sem nome',
                                frequencia: carac.frequencia || 'N/A',
                                referencia: carac.referencia || 'N/A',
                                alvo: carac.alvo || null,
                                gatilho: carac.gatilho || null,
                                efeito: carac.efeito || 'N/A',
                                especial: carac.especial || null,
                                className
                              })
                            })
                          } else {
                            // Se for objeto, usar Object.entries
                            Object.entries(caracteristicasObj).forEach(([name, data]) => {
                              userCaracteristicas.push({
                                name,
                                frequencia: data.frequencia || 'N/A',
                                referencia: data.referencia || 'N/A',
                                alvo: data.alvo || null,
                                gatilho: data.gatilho || null,
                                efeito: data.efeito || 'N/A',
                                especial: data.especial || null,
                                className
                              })
                            })
                          }
                        }
                      })
                    }

                    if (userCaracteristicas.length === 0) {
                      return (
                        <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                          <p className={`text-center text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                            Nenhuma classe selecionada
                          </p>
                        </div>
                      )
                    }

                    return (
                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-2 sm:gap-3 md:gap-4">
                        {userCaracteristicas.map((carac, index) => (
                          <div key={index} className={`p-3 sm:p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-blue-50'} border-2 ${darkMode ? 'border-blue-500' : 'border-blue-300'}`}>
                            <div className="flex items-start justify-between mb-2">
                              <h5 className={`font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                {typeof carac.name === 'string' ? carac.name : 'Característica'}
                              </h5>
                              <span className={`text-xs px-2 py-1 rounded ml-2 flex-shrink-0 ${darkMode ? 'bg-blue-900 text-blue-300' : 'bg-blue-100 text-blue-700'}`}>
                                {typeof carac.className === 'string' ? carac.className : 'Classe'}
                              </span>
                            </div>
                            <div className="space-y-1 text-sm">
                              {carac.frequencia && typeof carac.frequencia === 'string' && (
                                <p className={darkMode ? 'text-gray-300' : 'text-gray-700'}>
                                  <span className="font-semibold">Frequência:</span> {carac.frequencia}
                                </p>
                              )}
                              {carac.referencia && typeof carac.referencia === 'string' && (
                                <p className={darkMode ? 'text-gray-300' : 'text-gray-700'}>
                                  <span className="font-semibold">Referência:</span> {carac.referencia}
                                </p>
                              )}
                              {carac.alvo && typeof carac.alvo === 'string' && (
                                <p className={darkMode ? 'text-gray-300' : 'text-gray-700'}>
                                  <span className="font-semibold">Alvo:</span> {carac.alvo}
                                </p>
                              )}
                              {carac.gatilho && typeof carac.gatilho === 'string' && (
                                <p className={darkMode ? 'text-gray-300' : 'text-gray-700'}>
                                  <span className="font-semibold">Gatilho:</span> {carac.gatilho}
                                </p>
                              )}
                              {carac.efeito && typeof carac.efeito === 'string' && (
                                <p className={`mt-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                  <span className="font-semibold">Efeito:</span> {carac.efeito}
                                </p>
                              )}
                            </div>
                          </div>
                        ))}
                      </div>
                    )
                  })()}
                </div>

                {/* Talentos Selecionados */}
                <div>
                  <h4 className={`text-base sm:text-lg md:text-xl font-bold mb-3 sm:mb-4 ${darkMode ? 'text-purple-400' : 'text-purple-700'}`}>
                    Talentos Selecionados
                  </h4>
                  {trainerData?.talentosSelected && trainerData.talentosSelected.length > 0 ? (
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-2 sm:gap-3 md:gap-4">
                      {trainerData.talentosSelected.map((talentoItem, index) => {
                        // Se talentoItem é um objeto, usar diretamente
                        // Se é uma string, buscar os dados
                        let talentoData = null
                        let talentoNome = ''

                        if (typeof talentoItem === 'string') {
                          talentoNome = talentoItem
                          // Buscar dados completos do talento pelo nome
                          Object.values(TALENTOS_DATA).forEach(talentosList => {
                            const found = talentosList.find(t => t.nome === talentoNome)
                            if (found) talentoData = found
                          })
                        } else if (typeof talentoItem === 'object' && talentoItem !== null) {
                          // Se já é um objeto, usar diretamente
                          talentoData = talentoItem
                          talentoNome = talentoItem.nome || 'Talento sem nome'
                        }

                        if (!talentoData) {
                          return (
                            <div key={index} className={`p-3 sm:p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-purple-50'} border-2 ${darkMode ? 'border-purple-500' : 'border-purple-300'}`}>
                              <h5 className={`font-bold mb-2 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                {typeof talentoNome === 'string' ? talentoNome : 'Talento desconhecido'}
                              </h5>
                              <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                Detalhes não disponíveis
                              </p>
                            </div>
                          )
                        }

                        return (
                          <div key={index} className={`p-3 sm:p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-purple-50'} border-2 ${darkMode ? 'border-purple-500' : 'border-purple-300'}`}>
                            <h5 className={`font-bold mb-2 text-sm sm:text-base ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                              {typeof talentoData.nome === 'string' ? talentoData.nome : 'Talento'}
                            </h5>
                            <div className="space-y-1 text-sm">
                              {talentoData.requisitos && typeof talentoData.requisitos === 'string' && (
                                <p className={darkMode ? 'text-gray-300' : 'text-gray-700'}>
                                  <span className="font-semibold">Requisitos:</span> {talentoData.requisitos}
                                </p>
                              )}
                              {talentoData.frequencia && typeof talentoData.frequencia === 'string' && (
                                <p className={darkMode ? 'text-gray-300' : 'text-gray-700'}>
                                  <span className="font-semibold">Frequência:</span> {talentoData.frequencia}
                                </p>
                              )}
                              {talentoData.referencia && typeof talentoData.referencia === 'string' && (
                                <p className={darkMode ? 'text-gray-300' : 'text-gray-700'}>
                                  <span className="font-semibold">Referência:</span> {talentoData.referencia}
                                </p>
                              )}
                              {talentoData.alvo && typeof talentoData.alvo === 'string' && (
                                <p className={darkMode ? 'text-gray-300' : 'text-gray-700'}>
                                  <span className="font-semibold">Alvo:</span> {talentoData.alvo}
                                </p>
                              )}
                              {talentoData.efeito && typeof talentoData.efeito === 'string' && (
                                <p className={`mt-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                  <span className="font-semibold">Efeito:</span> {talentoData.efeito}
                                </p>
                              )}
                              {talentoData.especial && typeof talentoData.especial === 'string' && (
                                <p className={`mt-2 italic ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                  {talentoData.especial}
                                </p>
                              )}
                            </div>
                          </div>
                        )
                      })}
                    </div>
                  ) : (
                    <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                      <p className={`text-center text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                        Nenhum talento selecionado
                      </p>
                    </div>
                  )}
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Modal da Mochila */}
        {showMochilaModal && selectedTrainer && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-2 sm:p-4">
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-[95vw] sm:max-w-2xl w-full max-h-[90vh] overflow-y-auto`}>
              <div className={`sticky top-0 ${darkMode ? 'bg-gray-800' : 'bg-white'} p-3 sm:p-4 md:p-5 border-b ${darkMode ? 'border-gray-700' : 'border-gray-200'} flex justify-between items-center`}>
                <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  Mochila - {selectedTrainer}
                </h3>
                <button
                  onClick={() => setShowMochilaModal(false)}
                  className={`p-2 rounded-lg ${darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-100'}`}
                >
                  <X size={24} className={darkMode ? 'text-gray-400' : 'text-gray-600'} />
                </button>
              </div>
              <div className="p-3 sm:p-4 md:p-5 space-y-4 sm:space-y-6">
                {/* Itens Chave */}
                <div>
                  <h4 className={`text-base sm:text-lg font-bold mb-3 ${darkMode ? 'text-yellow-400' : 'text-yellow-700'}`}>
                    Itens Chave
                  </h4>
                  {trainerData?.keyItems && trainerData.keyItems.length > 0 ? (
                    <div className="space-y-2">
                      {trainerData.keyItems.map((item, index) => (
                        <div key={index} className={`p-3 rounded-lg flex justify-between items-center ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                          <span className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                            {item.name}
                          </span>
                          <span className={`px-3 py-1 rounded-full text-xs font-bold ${darkMode ? 'bg-yellow-600' : 'bg-yellow-500'} text-white`}>
                            x{item.quantity}
                          </span>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                      <p className={`text-center text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                        Nenhum item chave
                      </p>
                    </div>
                  )}
                </div>

                {/* Itens Customizados */}
                <div>
                  <h4 className={`text-base sm:text-lg font-bold mb-3 ${darkMode ? 'text-blue-400' : 'text-blue-700'}`}>
                    Itens Customizados {trainerData?.customItems ? `(${trainerData.customItems.length})` : ''}
                  </h4>
                  {(() => {
                    console.log('TrainerData customItems:', trainerData?.customItems)
                    return null
                  })()}
                  {trainerData?.customItems && trainerData.customItems.length > 0 ? (
                    <div className="space-y-2 overflow-x-auto -mx-3 px-3 sm:mx-0 sm:px-0">
                      {/* Cabeçalho da tabela */}
                      <div className={`grid grid-cols-12 gap-2 px-3 py-2 rounded-lg min-w-[500px] ${darkMode ? 'bg-gray-600' : 'bg-gray-200'}`}>
                        <div className="col-span-5">
                          <span className={`text-xs font-bold ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Item</span>
                        </div>
                        <div className="col-span-5">
                          <span className={`text-xs font-bold ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Descrição</span>
                        </div>
                        <div className="col-span-1 text-center">
                          <span className={`text-xs font-bold ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Qtd</span>
                        </div>
                        <div className="col-span-1 text-center">
                          <span className={`text-xs font-bold ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Bolso</span>
                        </div>
                      </div>

                      {/* Linhas de itens */}
                      {trainerData.customItems.map((item, index) => (
                        <div key={index} className={`grid grid-cols-12 gap-2 p-3 rounded-lg min-w-[500px] ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                          <div className="col-span-5 flex items-center">
                            <span className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                              {item.name}
                            </span>
                          </div>
                          <div className="col-span-5 flex items-center">
                            {item.description && (
                              <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                {item.description}
                              </p>
                            )}
                          </div>
                          <div className="col-span-1 flex items-center justify-center">
                            <span className={`px-2 py-1 rounded-full text-xs font-bold ${darkMode ? 'bg-blue-600' : 'bg-blue-500'} text-white`}>
                              x{item.quantity}
                            </span>
                          </div>
                          <div className="col-span-1 flex flex-col items-center justify-center gap-1">
                            <button
                              onClick={async () => {
                                if (index > 0 && trainerData) {
                                  const items = [...trainerData.customItems]
                                  // Trocar posição com o item anterior
                                  const temp = items[index]
                                  items[index] = items[index - 1]
                                  items[index - 1] = temp
                                  const updatedData = { ...trainerData, customItems: items }
                                  // Salvar no Firebase/localStorage
                                  if (useFirebase) {
                                    await saveTrainerData(selectedTrainer, updatedData)
                                  } else {
                                    localStorage.setItem(`trainer_${selectedTrainer}`, JSON.stringify(updatedData))
                                  }
                                  // Atualizar estado
                                  setSelectedTrainerData(updatedData)
                                }
                              }}
                              disabled={index === 0}
                              className={`px-2 py-1 rounded text-sm font-bold transition-colors ${
                                index === 0
                                  ? 'opacity-30 cursor-not-allowed text-gray-400'
                                  : darkMode
                                  ? 'hover:bg-gray-600 text-gray-300 hover:text-white'
                                  : 'hover:bg-gray-200 text-gray-700 hover:text-black'
                              }`}
                              title="Mover para cima"
                            >
                              ▲
                            </button>
                            <button
                              onClick={async () => {
                                if (index < trainerData.customItems.length - 1 && trainerData) {
                                  const items = [...trainerData.customItems]
                                  // Trocar posição com o próximo item
                                  const temp = items[index]
                                  items[index] = items[index + 1]
                                  items[index + 1] = temp
                                  const updatedData = { ...trainerData, customItems: items }
                                  // Salvar no Firebase/localStorage
                                  if (useFirebase) {
                                    await saveTrainerData(selectedTrainer, updatedData)
                                  } else {
                                    localStorage.setItem(`trainer_${selectedTrainer}`, JSON.stringify(updatedData))
                                  }
                                  // Atualizar estado
                                  setSelectedTrainerData(updatedData)
                                }
                              }}
                              disabled={index === trainerData.customItems.length - 1}
                              className={`px-2 py-1 rounded text-sm font-bold transition-colors ${
                                index === trainerData.customItems.length - 1
                                  ? 'opacity-30 cursor-not-allowed text-gray-400'
                                  : darkMode
                                  ? 'hover:bg-gray-600 text-gray-300 hover:text-white'
                                  : 'hover:bg-gray-200 text-gray-700 hover:text-black'
                              }`}
                              title="Mover para baixo"
                            >
                              ▼
                            </button>
                          </div>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                      <p className={`text-center text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                        Nenhum item customizado
                      </p>
                    </div>
                  )}
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Modal de Vivências */}
        {showVivenciasModal && selectedTrainer && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-2 sm:p-4">
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-[95vw] sm:max-w-3xl w-full max-h-[90vh] overflow-y-auto`}>
              <div className={`sticky top-0 ${darkMode ? 'bg-gray-800' : 'bg-white'} p-3 sm:p-4 md:p-5 border-b ${darkMode ? 'border-gray-700' : 'border-gray-200'} flex justify-between items-center`}>
                <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  Vivências - {selectedTrainer}
                </h3>
                <button
                  onClick={() => setShowVivenciasModal(false)}
                  className={`p-2 rounded-lg ${darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-100'}`}
                >
                  <X size={24} className={darkMode ? 'text-gray-400' : 'text-gray-600'} />
                </button>
              </div>
              <div className="p-3 sm:p-4 md:p-5">
                {trainerData?.vivencias && trainerData.vivencias.length > 0 ? (
                  <div className="grid grid-cols-1 sm:grid-cols-2 gap-2 sm:gap-3 md:gap-4">
                    {trainerData.vivencias.map((vivencia) => (
                      <div key={vivencia.id} className={`p-3 sm:p-4 rounded-lg border-2 ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-200'}`}>
                        <h4 className={`font-bold text-lg mb-3 ${darkMode ? 'text-green-400' : 'text-green-700'}`}>
                          {vivencia.nome}
                        </h4>
                        <div className="space-y-2">
                          {vivencia.frequencia && (
                            <div>
                              <span className={`text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Frequência:</span>
                              <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>{vivencia.frequencia}</p>
                            </div>
                          )}
                          {vivencia.alvo && (
                            <div>
                              <span className={`text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Alvo:</span>
                              <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>{vivencia.alvo}</p>
                            </div>
                          )}
                          {vivencia.gatilho && (
                            <div>
                              <span className={`text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Gatilho:</span>
                              <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>{vivencia.gatilho}</p>
                            </div>
                          )}
                          {vivencia.efeito && (
                            <div>
                              <span className={`text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Efeito:</span>
                              <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>{vivencia.efeito}</p>
                            </div>
                          )}
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className={`p-3 sm:p-5 md:p-8 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                    <p className={`text-center ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                      Este treinador não possui vivências cadastradas.
                    </p>
                  </div>
                )}
              </div>
            </div>
          </div>
        )}

        {/* Modal de Background */}
        {showMestreBackgroundModal && selectedTrainer && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-2 sm:p-4">
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-[95vw] sm:max-w-3xl w-full max-h-[90vh] overflow-y-auto`}>
              <div className={`sticky top-0 ${darkMode ? 'bg-gray-800' : 'bg-white'} p-3 sm:p-4 md:p-5 border-b ${darkMode ? 'border-gray-700' : 'border-gray-200'} flex justify-between items-center`}>
                <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  Background - {selectedTrainer}
                </h3>
                <button
                  onClick={() => setShowMestreBackgroundModal(false)}
                  className={`p-2 rounded-lg ${darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-100'}`}
                >
                  <X size={24} className={darkMode ? 'text-gray-400' : 'text-gray-600'} />
                </button>
              </div>
              <div className="p-3 sm:p-4 md:p-5">
                {trainerData?.background ? (
                  <div className={`p-3 sm:p-4 md:p-5 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                    <p className={`whitespace-pre-wrap leading-relaxed ${darkMode ? 'text-gray-200' : 'text-gray-700'}`}>
                      {trainerData.background}
                    </p>
                  </div>
                ) : (
                  <div className={`p-3 sm:p-5 md:p-8 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                    <p className={`text-center ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                      Este treinador não possui background cadastrado.
                    </p>
                  </div>
                )}
              </div>
            </div>
          </div>
        )}

        {/* Modal de Insígnias */}
        {showMestreInsigniasModal && selectedTrainer && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-2 sm:p-4">
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-[95vw] sm:max-w-2xl md:max-w-4xl w-full max-h-[90vh] overflow-y-auto`}>
              <div className={`sticky top-0 ${darkMode ? 'bg-gray-800' : 'bg-white'} p-3 sm:p-4 md:p-5 border-b ${darkMode ? 'border-gray-700' : 'border-gray-200'} flex justify-between items-center`}>
                <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  Insígnias - {selectedTrainer}
                </h3>
                <button
                  onClick={() => setShowMestreInsigniasModal(false)}
                  className={`p-2 rounded-lg ${darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-100'}`}
                >
                  <X size={24} className={darkMode ? 'text-gray-400' : 'text-gray-600'} />
                </button>
              </div>
              <div className="p-3 sm:p-4 md:p-5">
                {trainerData?.badges ? (
                  <div className="space-y-2 sm:space-y-3">
                    {['Kanto', 'Johto', 'Hoenn', 'Sinnoh', 'Unova', 'Kalos']
                      .filter(region => trainerData.badges[region])
                      .map((region) => {
                        const regionBadges = trainerData.badges[region]
                        const badgeCount = region === 'Unova' ? 12 : 9
                        const collectedCount = regionBadges.filter((c, i) => c && (region === 'Unova' ? (i !== 4 && i !== 9) : i !== 4)).length
                        const totalBadges = region === 'Unova' ? 10 : 8
                        const isExpanded = expandedMestreInsignias.includes(region)
                        return (
                          <div key={region} className={`rounded-lg overflow-hidden ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                            {/* Header clicável */}
                            <button
                              onClick={() => {
                                if (isExpanded) {
                                  setExpandedMestreInsignias(expandedMestreInsignias.filter(r => r !== region))
                                } else {
                                  setExpandedMestreInsignias([...expandedMestreInsignias, region])
                                }
                              }}
                              className={`w-full p-3 sm:p-4 flex justify-between items-center ${darkMode ? 'hover:bg-gray-600' : 'hover:bg-gray-200'} transition-colors`}
                            >
                              <div className="flex items-center gap-2 sm:gap-3">
                                <h4 className={`text-base sm:text-lg md:text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                  {region}
                                </h4>
                                <span className={`text-xs sm:text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                  ({collectedCount} / {totalBadges})
                                </span>
                              </div>
                              {isExpanded ? (
                                <ChevronUp size={24} className={darkMode ? 'text-gray-400' : 'text-gray-600'} />
                              ) : (
                                <ChevronDown size={24} className={darkMode ? 'text-gray-400' : 'text-gray-600'} />
                              )}
                            </button>
                            {/* Conteúdo expandível */}
                            {isExpanded && (
                              <div className={`p-3 sm:p-4 border-t ${darkMode ? 'border-gray-600' : 'border-gray-300'}`}>
                                {/* Imagem com grid sobreposto */}
                                <div className="relative max-w-md mx-auto">
                                  <img
                                    src={`/badges/${region.toLowerCase()}.png`}
                                    alt={`Insígnias de ${region}`}
                                    className="w-full rounded-lg"
                                    onError={(e) => { e.target.style.display = 'none' }}
                                  />
                                  {/* Grid sobreposto para escurecer insígnias não coletadas */}
                                  {region === 'Unova' ? (
                                    <div className="absolute inset-0 grid grid-cols-3 grid-rows-4 gap-0 rounded-lg overflow-hidden">
                                      {Array.from({ length: 12 }, (_, i) => i).map((index) => {
                                        const isFixed = index === 4 || index === 9
                                        const badgesArray = [...(regionBadges || []), ...Array(12).fill(false)].slice(0, 12)
                                        const isCollected = badgesArray[index]
                                        const shouldShowDark = !isCollected && !isFixed
                                        return (
                                          <div
                                            key={index}
                                            style={{
                                              backgroundColor: shouldShowDark ? 'rgba(0, 0, 0, 0.8)' : 'transparent',
                                              backdropFilter: shouldShowDark ? 'blur(2px)' : 'none'
                                            }}
                                          />
                                        )
                                      })}
                                    </div>
                                  ) : (
                                    <div className="absolute inset-0 grid grid-cols-3 grid-rows-3 gap-0 rounded-lg overflow-hidden">
                                      {regionBadges.slice(0, 9).map((collected, index) => (
                                        <div
                                          key={index}
                                          style={{
                                            backgroundColor: collected || index === 4 ? 'transparent' : 'rgba(0, 0, 0, 0.8)',
                                            backdropFilter: collected || index === 4 ? 'none' : 'blur(2px)'
                                          }}
                                        />
                                      ))}
                                    </div>
                                  )}
                                </div>
                              </div>
                            )}
                          </div>
                        )
                      })}
                  </div>
                ) : (
                  <div className={`p-3 sm:p-5 md:p-8 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                    <p className={`text-center ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                      Este treinador não possui insígnias cadastradas.
                    </p>
                  </div>
                )}
              </div>
            </div>
          </div>
        )}

        {accountDataModal}
        {pokezapPanel}{pokeAgendaPanel}
        {batalhaChatPanel}
        </div>
      </>
    )
  }

  // ÁREA XP & CAPTURAS M (MESTRE)
  if (currentUser.type === 'mestre' && currentArea === 'XP & Capturas M') {
    // Ordenar treinadores para a lista: Alocin, Lila, Ludovic, Noryat, Pedro
    const trainerOrder = ['Alocin', 'Lila', 'Ludovic', 'Noryat', 'Pedro']

    // Calcular ranking de XP
    const xpRanking = trainerOrder
      .map(username => {
        const data = allTrainersXpCapturas[username] || { xpList: [], capturaList: [] }
        const totalXp = (data.xpList || []).reduce((sum, xp) => sum + (xp.value || 0), 0)
        return { username, totalXp, hasData: (data.xpList || []).length > 0 }
      })
      .filter(t => t.hasData)
      .sort((a, b) => b.totalXp - a.totalXp)

    // Atribuir posições de ranking (com empates)
    let currentRank = 1
    xpRanking.forEach((trainer, index) => {
      if (index > 0 && trainer.totalXp === xpRanking[index - 1].totalXp) {
        trainer.rank = xpRanking[index - 1].rank
      } else {
        trainer.rank = currentRank
      }
      currentRank++
    })

    // Lista de captura geral ordenada por treinador
    const capturaGeralList = []
    trainerOrder.forEach(username => {
      const data = allTrainersXpCapturas[username] || { xpList: [], capturaList: [] }
      const capturas = data.capturaList || []
      if (capturas.length > 0) {
        capturas.forEach((pokemon, idx) => {
          capturaGeralList.push({
            ...pokemon,
            trainer: username,
            globalIndex: capturaGeralList.length
          })
        })
      }
    })

    return (
      <>
        <div className={`min-h-screen ${mainBgClass}`}>
          {sidebarNav}
          <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-lg`}>
            <div className="max-w-7xl mx-auto px-4 py-4">
              <div className="flex justify-between items-center mb-4">
                <div className="flex items-center gap-3"><button onClick={() => setSidebarOpen(true)} className={`p-2 rounded-lg ${darkMode ? "hover:bg-gray-700 text-gray-400" : "hover:bg-gray-200 text-gray-500"}`}><Menu size={24} /></button><h2 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>XP & Capturas M 👑</h2></div>
                <div className="flex gap-2">
                  <button onClick={() => setDarkMode(!darkMode)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-yellow-400' : 'bg-gray-200 text-gray-700'}`}>
                    {darkMode ? <Sun size={20} /> : <Moon size={20} />}
                  </button>
                  {pokezapBtn}{pokeAgendaBtn}{batalhaChatBtn}<button onClick={handleLogout} className="bg-red-500 text-white px-3 sm:px-5 md:px-6 py-2 rounded-lg hover:bg-red-600">Sair</button>
                </div>
              </div>
            </div>
          </div>

          <div className="max-w-7xl mx-auto px-4 py-3 sm:py-5 md:py-8">
            {/* Grid com Ranking de XP e Lista de Captura Geral */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-3 sm:p-5 md:p-6 mb-6">
              {/* Ranking de XP (Esquerda) */}
              <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-6`}>
                <h3 className={`text-lg sm:text-xl font-bold mb-4 flex items-center gap-2 ${darkMode ? 'text-yellow-400' : 'text-yellow-600'}`}>
                  <Trophy size={24} />
                  Ranking de XP
                </h3>

                {xpRanking.length === 0 ? (
                  <p className={`text-center ${darkMode ? 'text-gray-500' : 'text-gray-400'} italic py-3 sm:py-5 md:py-8`}>
                    Nenhum treinador com XP registrada.
                  </p>
                ) : (
                  <div className="space-y-3">
                    {xpRanking.filter(t => t.rank <= 5).map((trainer, index) => (
                      <div key={trainer.username} className={`flex items-center justify-between p-3 rounded-lg ${
                        trainer.rank === 1 ? 'bg-gradient-to-r from-yellow-500 to-amber-500 text-white' :
                        trainer.rank === 2 ? 'bg-gradient-to-r from-gray-400 to-gray-500 text-white' :
                        trainer.rank === 3 ? 'bg-gradient-to-r from-orange-600 to-orange-700 text-white' :
                        darkMode ? 'bg-gray-700' : 'bg-gray-100'
                      }`}>
                        <div className="flex items-center gap-3">
                          <span className={`text-xl sm:text-2xl font-bold ${trainer.rank <= 3 ? 'text-white' : darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                            #{trainer.rank}
                          </span>
                          <span className={`font-semibold ${trainer.rank <= 3 ? 'text-white' : darkMode ? 'text-white' : 'text-gray-800'}`}>
                            {trainer.username}
                          </span>
                        </div>
                        <span className={`font-bold ${trainer.rank <= 3 ? 'text-white' : darkMode ? 'text-cyan-400' : 'text-cyan-600'}`}>
                          {trainer.totalXp} XP
                        </span>
                      </div>
                    ))}
                  </div>
                )}
              </div>

              {/* Lista de Captura Geral (Direita) */}
              <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-6`}>
                <div className="flex justify-between items-center mb-4">
                  <h3 className={`text-lg sm:text-xl font-bold flex items-center gap-2 ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>
                    <Target size={24} />
                    Lista de Captura Geral
                  </h3>
                  <div className="flex gap-2">
                    {/* Botão Grid de Captura - NOVO */}
                    <button
                      onClick={() => setShowGridModal(true)}
                      className="bg-gradient-to-r from-purple-600 to-blue-600 text-white px-3 py-2 rounded-lg hover:from-purple-700 hover:to-blue-700 font-semibold text-sm flex items-center gap-1"
                      title="Grid de Captura"
                    >
                      <Target size={16} />
                      Grid de Captura
                    </button>

                    {/* Botão Sortear Encontro */}
                    <button
                      onClick={() => {
                        const availablePokemon = capturaGeralList.filter(p => !p.status)
                        if (availablePokemon.length === 0) {
                          alert('Não há pokémons disponíveis para sortear!')
                          return
                        }
                        const randomIndex = Math.floor(Math.random() * availablePokemon.length)
                        const sortedPokemon = availablePokemon[randomIndex]

                        // Enviar mensagem no chat
                        const newMessage = {
                          id: Date.now(),
                          username: 'Sistema',
                          message: `🎲 Encontro sorteado: ${sortedPokemon.species} (Nv. ${sortedPokemon.level}) - Captura: ${sortedPokemon.captureValue} - Treinador: ${sortedPokemon.trainer}`,
                          timestamp: new Date().toISOString(),
                          type: 'system'
                        }
                        const updatedMessages = [...chatMessages, newMessage]
                        setChatMessages(updatedMessages)
                        if (useFirebase) {
                          saveChatMessages(updatedMessages)
                        }

                        alert(`Encontro sorteado: ${sortedPokemon.species} (Nv. ${sortedPokemon.level})\nCaptura: ${sortedPokemon.captureValue}\nTreinador: ${sortedPokemon.trainer}`)
                      }}
                      className="bg-gradient-to-r from-green-600 to-emerald-600 text-white px-3 py-2 rounded-lg hover:from-green-700 hover:to-emerald-700 font-semibold text-sm flex items-center gap-1"
                    >
                      <Shuffle size={16} />
                      Sortear
                    </button>
                    {/* Botão Ações de Comando */}
                    <button
                      onClick={() => setShowAcoesComandoModal(true)}
                      className="bg-gradient-to-r from-purple-600 to-indigo-600 text-white p-2 rounded-lg hover:from-purple-700 hover:to-indigo-700"
                      title="Ações de Comando"
                    >
                      <ClipboardCheck size={20} />
                    </button>
                  </div>
                </div>

                {capturaGeralList.length === 0 ? (
                  <p className={`text-center ${darkMode ? 'text-gray-500' : 'text-gray-400'} italic py-3 sm:py-5 md:py-8`}>
                    Nenhum pokémon nas listas de captura.
                  </p>
                ) : (
                  <div className="space-y-2 max-h-[400px] overflow-y-auto">
                    {capturaGeralList.map((pokemon, index) => (
                      <div key={`${pokemon.trainer}-${index}`} className={`flex justify-between items-center p-2 rounded ${darkMode ? 'bg-gray-700' : 'bg-gray-100'} ${
                        pokemon.status === 'capturado' ? 'border-l-4 border-green-500' :
                        pokemon.status === 'batalha' ? 'border-l-4 border-orange-500' :
                        pokemon.status === 'block' ? 'border-l-4 border-red-500' : ''
                      }`}>
                        <div className="flex-1">
                          <span className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>{index + 1}. </span>
                          <span className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                            {pokemon.species}
                          </span>
                          <span className={`ml-2 text-sm ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                            Nv. {pokemon.level} | Cap: {pokemon.captureValue}
                          </span>
                          <span className={`ml-2 text-xs px-2 py-0.5 rounded ${darkMode ? 'bg-gray-600 text-gray-300' : 'bg-gray-200 text-gray-600'}`}>
                            {pokemon.trainer}
                          </span>
                          {pokemon.status && (
                            <span className={`ml-2 text-xs px-2 py-0.5 rounded ${
                              pokemon.status === 'capturado' ? 'bg-green-500 text-white' :
                              pokemon.status === 'batalha' ? 'bg-orange-500 text-white' :
                              'bg-red-500 text-white'
                            }`}>
                              {pokemon.status === 'capturado' ? 'Capturado' :
                               pokemon.status === 'batalha' ? 'Vencido' : 'Bloqueado'}
                            </span>
                          )}
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            </div>

            {/* App de Combate Expandível */}
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl overflow-hidden mb-6`}>
              <button
                onClick={() => setShowCombateXpCapturas(!showCombateXpCapturas)}
                className={`w-full p-4 flex justify-between items-center ${darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-50'}`}
              >
                <h3 className={`text-lg sm:text-xl font-bold flex items-center gap-2 ${darkMode ? 'text-orange-400' : 'text-orange-600'}`}>
                  <Sword size={24} />
                  App de Combate
                </h3>
                {showCombateXpCapturas ? <ChevronUp size={24} /> : <ChevronDown size={24} />}
              </button>

              {showCombateXpCapturas && (
                <div className="p-3 sm:p-5 md:p-6 border-t border-gray-700">
                  <CombateInterludioApp darkMode={darkMode} />
                </div>
              )}
            </div>

            {/* Chat (independente do App de Combate) */}
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-6`}>
              <h3 className={`text-xl sm:text-2xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-800'}`}>Chat</h3>

              {/* Menu de Rolagem Rápida */}
              <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} rounded-lg p-4 mb-4`}>
                <h4 className={`text-sm font-bold mb-3 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                  Rolagem Rápida
                </h4>
                <div className="flex flex-wrap items-center gap-2 sm:gap-3">
                  {/* Primeira Parte: Número de dados */}
                  <div className="flex items-center gap-1.5 sm:gap-2">
                    <span className={`text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Qtd:</span>
                    <div className="flex flex-wrap gap-1">
                      {[1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(num => (
                        <button
                          key={num}
                          onClick={() => setQuickRollNumDice(num)}
                          className={`w-7 h-7 sm:w-8 sm:h-8 rounded text-xs sm:text-sm font-bold transition-colors ${
                            quickRollNumDice === num
                              ? 'bg-blue-600 text-white'
                              : darkMode
                              ? 'bg-gray-600 text-gray-300 hover:bg-gray-500'
                              : 'bg-white text-gray-700 hover:bg-gray-200'
                          }`}
                        >
                          {num}
                        </button>
                      ))}
                    </div>
                  </div>

                  {/* Segunda Parte: Tipo de dado */}
                  <div className="flex items-center gap-1.5 sm:gap-2">
                    <span className={`text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Dado:</span>
                    <div className="flex flex-wrap gap-1">
                      {['d4', 'd6', 'd8', 'd10', 'd12', 'd20'].map(dice => (
                        <button
                          key={dice}
                          onClick={() => setQuickRollDiceType(dice)}
                          className={`px-2 sm:px-3 h-7 sm:h-8 rounded text-xs sm:text-sm font-bold transition-colors ${
                            quickRollDiceType === dice
                              ? 'bg-green-600 text-white'
                              : darkMode
                              ? 'bg-gray-600 text-gray-300 hover:bg-gray-500'
                              : 'bg-white text-gray-700 hover:bg-gray-200'
                          }`}
                        >
                          {dice}
                        </button>
                      ))}
                    </div>
                  </div>

                  {/* Botão Rolar */}
                  <button
                    onClick={() => {
                      const diceNotation = `${quickRollNumDice}${quickRollDiceType}`
                      const result = rollDiceExpression(diceNotation)
                      if (result.error) {
                        alert(result.error)
                        return
                      }
                      const newMessage = {
                        username: currentUser?.username || 'Anônimo',
                        text: `🎲 Rolagem Rápida: ${diceNotation}`,
                        timestamp: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
                        isDiceRoll: true,
                        diceResult: result.total,
                        diceDetails: result.formula
                      }
                      setChatMessages(prev => [...prev, newMessage])
                      if (useFirebase) {
                        (async () => {
                          const currentMessages = await loadChatMessages()
                          await saveChatMessages([...(currentMessages || []), newMessage])
                        })().catch(err => console.error('Erro ao salvar mensagem:', err))
                      }
                    }}
                    className="px-3 sm:px-5 md:px-6 h-7 sm:h-8 bg-purple-600 text-white rounded font-bold hover:bg-purple-700 transition-colors text-xs sm:text-sm"
                  >
                    🎲 Rolar
                  </button>
                </div>
              </div>

              <div className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-4`}>
                <p>Use /r ou /roll para rolar dados. Ex: /r 1d20+5</p>
                <p>Use comandos @ para acessar atributos. Ex: 1d20+@MAE</p>
              </div>

              {/* Área de Mensagens */}
              <div ref={chatContainerRef} className={`${darkMode ? 'bg-gray-900' : 'bg-gray-50'} rounded-lg p-4 h-96 overflow-y-auto mb-4`}>
                {chatMessages.length === 0 ? (
                  <p className={`text-center ${darkMode ? 'text-gray-500' : 'text-gray-400'} py-3 sm:py-5 md:py-8`}>
                    Nenhuma mensagem ainda. Seja o primeiro a falar!
                  </p>
                ) : (
                  <div className="space-y-3">
                    {chatMessages.map((msg, idx) => (
                      <div key={idx} className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg p-3`}>
                        <div className="flex justify-between items-start mb-1">
                          <span className={`font-bold text-sm ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>
                            {msg.username}
                          </span>
                          <span className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                            {msg.timestamp}
                          </span>
                        </div>
                        {msg.isDiceRoll ? (
                          <div>
                            <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                              {msg.text}
                            </p>
                            <div className={`mt-2 p-2 rounded ${darkMode ? 'bg-green-900' : 'bg-green-100'}`}>
                              <p className={`font-bold text-lg ${darkMode ? 'text-green-400' : 'text-green-700'}`}>
                                Resultado: {msg.diceResult}
                              </p>
                              <p className={`text-xs ${darkMode ? 'text-green-300' : 'text-green-600'}`}>
                                {msg.diceDetails}
                              </p>
                            </div>
                          </div>
                        ) : msg.isAction ? (
                          <p className={`text-sm font-semibold text-yellow-500`}>
                            {msg.text}
                          </p>
                        ) : (
                          <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                            {msg.text}
                          </p>
                        )}
                      </div>
                    ))}
                  </div>
                )}
              </div>

              {/* Input de Mensagem */}
              <div className="flex gap-2">
                <input
                  type="text"
                  value={chatInput}
                  onChange={(e) => setChatInput(e.target.value)}
                  onKeyPress={(e) => {
                    if (e.key === 'Enter') {
                      handleSendMessage()
                    }
                  }}
                  placeholder="Digite sua mensagem, 1d20+@MAE, ou /r 1d20..."
                  className={`flex-1 px-4 py-3 rounded-lg border-2 ${
                    darkMode
                      ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-500'
                      : 'bg-white border-gray-300 text-gray-800 placeholder-gray-400'
                  } focus:outline-none focus:border-blue-500`}
                />
                <button
                  onClick={handleSendMessage}
                  className="px-3 sm:px-5 md:px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold"
                >
                  Enviar
                </button>
              </div>
            </div>
          </div>

          {/* Modal Ações de Comando */}
          {showAcoesComandoModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowAcoesComandoModal(false)}>
              <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-md w-full`} onClick={(e) => e.stopPropagation()}>
                <div className="p-3 sm:p-5 md:p-6">
                  <div className="flex justify-between items-center mb-6">
                    <h3 className={`text-lg sm:text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                      Ações de Comando
                    </h3>
                    <button onClick={() => setShowAcoesComandoModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                      <X size={24} />
                    </button>
                  </div>

                  {/* Dropdown de Pokémon */}
                  <div className="mb-4">
                    <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      Selecione o Pokémon:
                    </label>
                    <select
                      value={selectedAcaoComandoPokemon}
                      onChange={(e) => setSelectedAcaoComandoPokemon(e.target.value)}
                      className={`w-full px-3 py-2 sm:px-4 rounded-lg border-2 text-sm sm:text-base ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                    >
                      <option value="">Selecione...</option>
                      {capturaGeralList.map((pokemon, index) => (
                        <option key={`${pokemon.trainer}-${index}`} value={`${pokemon.trainer}-${index}`}>
                          {index + 1}. {pokemon.species} (Nv. {pokemon.level}) - {pokemon.trainer}
                        </option>
                      ))}
                    </select>
                  </div>

                  {/* Checkboxes de Ação */}
                  <div className="mb-6 space-y-3">
                    <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      Marcar como:
                    </label>
                    <label className={`flex items-center gap-3 p-3 rounded-lg cursor-pointer ${acaoComandoType === 'capturado' ? 'bg-green-500 text-white' : darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-100 hover:bg-gray-200'}`}>
                      <input
                        type="checkbox"
                        checked={acaoComandoType === 'capturado'}
                        onChange={() => setAcaoComandoType(acaoComandoType === 'capturado' ? '' : 'capturado')}
                        className="w-5 h-5"
                      />
                      <span className="font-semibold">Captura</span>
                    </label>
                    <label className={`flex items-center gap-3 p-3 rounded-lg cursor-pointer ${acaoComandoType === 'batalha' ? 'bg-orange-500 text-white' : darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-100 hover:bg-gray-200'}`}>
                      <input
                        type="checkbox"
                        checked={acaoComandoType === 'batalha'}
                        onChange={() => setAcaoComandoType(acaoComandoType === 'batalha' ? '' : 'batalha')}
                        className="w-5 h-5"
                      />
                      <span className="font-semibold">Batalha</span>
                    </label>
                    <label className={`flex items-center gap-3 p-3 rounded-lg cursor-pointer ${acaoComandoType === 'block' ? 'bg-red-500 text-white' : darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-100 hover:bg-gray-200'}`}>
                      <input
                        type="checkbox"
                        checked={acaoComandoType === 'block'}
                        onChange={() => setAcaoComandoType(acaoComandoType === 'block' ? '' : 'block')}
                        className="w-5 h-5"
                      />
                      <span className="font-semibold">Block</span>
                    </label>
                  </div>

                  {/* Botão Confirmar */}
                  <button
                    onClick={async () => {
                      if (!selectedAcaoComandoPokemon || !acaoComandoType) {
                        alert('Selecione um pokémon e uma ação!')
                        return
                      }

                      // Parse do valor selecionado
                      const [trainer, indexStr] = selectedAcaoComandoPokemon.split('-')
                      const index = parseInt(indexStr)

                      // Encontrar o pokémon na lista do treinador
                      const trainerData = allTrainersXpCapturas[trainer] || { xpList: [], capturaList: [] }
                      const capturaList = [...(trainerData.capturaList || [])]

                      // Encontrar o índice correto no capturaList do treinador
                      let trainerPokemonIndex = 0
                      let globalCounter = 0
                      for (const t of trainerOrder) {
                        const tData = allTrainersXpCapturas[t] || { xpList: [], capturaList: [] }
                        const tCapturas = tData.capturaList || []
                        for (let i = 0; i < tCapturas.length; i++) {
                          if (globalCounter === index && t === trainer) {
                            trainerPokemonIndex = i
                            break
                          }
                          globalCounter++
                        }
                      }

                      // Atualizar status (toggle: se já tiver o mesmo status, remove)
                      if (capturaList[trainerPokemonIndex]) {
                        const currentStatus = capturaList[trainerPokemonIndex].status
                        const newStatus = currentStatus === acaoComandoType ? undefined : acaoComandoType

                        capturaList[trainerPokemonIndex] = {
                          ...capturaList[trainerPokemonIndex],
                          status: newStatus
                        }

                        // Se for batalha, adicionar XP à lista de XP do treinador
                        if (newStatus === 'batalha' && capturaList[trainerPokemonIndex].experience) {
                          const xpList = [...(trainerData.xpList || []), {
                            value: capturaList[trainerPokemonIndex].experience,
                            species: capturaList[trainerPokemonIndex].species
                          }]

                          if (useFirebase) {
                            await saveXpCapturas(trainer, { xpList, capturaList })
                          }
                        } else {
                          if (useFirebase) {
                            await saveXpCapturas(trainer, { xpList: trainerData.xpList || [], capturaList })
                          }
                        }
                      }

                      setShowAcoesComandoModal(false)
                      setSelectedAcaoComandoPokemon('')
                      setAcaoComandoType('')
                    }}
                    disabled={!selectedAcaoComandoPokemon || !acaoComandoType}
                    className="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-3 rounded-lg hover:from-purple-700 hover:to-indigo-700 font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    Confirmar Ação
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Modal Grid de Captura */}
          {showGridModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowGridModal(false)}>
              <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-md w-full`} onClick={(e) => e.stopPropagation()}>
                <div className="p-3 sm:p-5 md:p-6">
                  <div className="flex justify-between items-center mb-6">
                    <h3 className={`text-lg sm:text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                      Grid de Captura
                    </h3>
                    <button onClick={() => setShowGridModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                      <X size={24} />
                    </button>
                  </div>

                  {/* Input Linhas */}
                  <div className="mb-4">
                    <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      Número de Linhas:
                    </label>
                    <input
                      type="number"
                      min="1"
                      max="10"
                      value={gridRows}
                      onChange={(e) => setGridRows(e.target.value)}
                      className={`w-full px-3 py-2 sm:px-4 rounded-lg border-2 text-sm sm:text-base ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                      placeholder="Ex: 5"
                    />
                  </div>

                  {/* Input Colunas */}
                  <div className="mb-4">
                    <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      Número de Colunas:
                    </label>
                    <input
                      type="number"
                      min="1"
                      max="10"
                      value={gridCols}
                      onChange={(e) => setGridCols(e.target.value)}
                      className={`w-full px-3 py-2 sm:px-4 rounded-lg border-2 text-sm sm:text-base ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                      placeholder="Ex: 5"
                    />
                  </div>

                  {/* Seleção de Treinador */}
                  <div className="mb-6">
                    <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      Selecione o Treinador:
                    </label>
                    <div className="space-y-2">
                      {['Alocin', 'Lila', 'Ludovic', 'Noryat', 'Pedro'].map(trainer => {
                        const hasGrid = gridCapturaConfig && gridCapturaConfig.trainer === trainer
                        return (
                          <label
                            key={trainer}
                            className={`flex items-center gap-3 p-3 rounded-lg transition-all ${
                              hasGrid
                                ? 'opacity-50 cursor-not-allowed bg-gray-400'
                                : gridTrainer === trainer
                                  ? 'bg-blue-500 text-white cursor-pointer'
                                  : darkMode
                                    ? 'bg-gray-700 hover:bg-gray-600 cursor-pointer'
                                    : 'bg-gray-100 hover:bg-gray-200 cursor-pointer'
                            }`}
                          >
                            <input
                              type="checkbox"
                              checked={gridTrainer === trainer}
                              onChange={() => setGridTrainer(gridTrainer === trainer ? '' : trainer)}
                              disabled={hasGrid}
                              className="w-5 h-5"
                            />
                            <span className="font-semibold">
                              {trainer}
                              {hasGrid && <span className="ml-2 text-xs">(já possui grid)</span>}
                            </span>
                          </label>
                        )
                      })}
                    </div>
                  </div>

                  {/* Botões */}
                  <div className="space-y-3">
                    <button
                      onClick={() => {
                        if (!gridRows || !gridCols || !gridTrainer) {
                          alert('Preencha todos os campos!')
                          return
                        }

                        // Validar números
                        const rows = parseInt(gridRows)
                        const cols = parseInt(gridCols)
                        if (isNaN(rows) || isNaN(cols) || rows < 1 || cols < 1 || rows > 10 || cols > 10) {
                          alert('Linhas e Colunas devem ser números entre 1 e 10!')
                          return
                        }

                        console.log('Grid Creation Debug:')
                        console.log('- Selected Trainer (viewer):', gridTrainer)
                        console.log('- Total capturaGeralList:', capturaGeralList.length)
                        console.log('- Grid Size:', rows, 'x', cols, '=', rows * cols)

                        if (capturaGeralList.length === 0) {
                          alert('Não há pokémons capturados na Lista de Captura Geral!')
                          return
                        }

                        // Criar grid com TODOS os pokémons da Lista de Captura Geral
                        const totalCells = rows * cols
                        const pokemons = []
                        for (let i = 0; i < totalCells; i++) {
                          if (i < capturaGeralList.length) {
                            pokemons.push({
                              species: capturaGeralList[i].species,
                              level: capturaGeralList[i].level,
                              captureValue: capturaGeralList[i].captureValue,
                              imageUrl: capturaGeralList[i].imageUrl,
                              types: capturaGeralList[i].types || [],
                              trainer: capturaGeralList[i].trainer,
                              localIndex: i
                            })
                          } else {
                            pokemons.push(null)
                          }
                        }

                        // Criar configuração do grid
                        const gridConfig = {
                          rows,
                          cols,
                          trainer: gridTrainer,
                          pokemons
                        }

                        console.log('Grid Config:', gridConfig)

                        // Salvar no Firebase
                        setGridCapturaConfig(gridConfig)
                        setRevealedCards([])
                        setGridCardStates({})
                        if (useFirebase) {
                          saveToFirebase('mestre/gridCaptura', gridConfig)
                            .then((success) => {
                              console.log('Firebase save gridCaptura:', success)
                            })
                          saveToFirebase('mestre/gridCapturaRevealed', [])
                            .then((success) => {
                              console.log('Firebase save gridCapturaRevealed:', success)
                            })
                          saveToFirebase('mestre/gridCardStates', {})
                            .then((success) => {
                              console.log('Firebase save gridCardStates:', success)
                            })
                        }

                        // Limpar e fechar
                        setShowGridModal(false)
                        setGridRows('')
                        setGridCols('')
                        setGridTrainer('')
                        alert('Grid criado com sucesso!')
                      }}
                      disabled={!gridRows || !gridCols || !gridTrainer}
                      className="w-full bg-gradient-to-r from-blue-600 to-cyan-600 text-white py-3 rounded-lg hover:from-blue-700 hover:to-cyan-700 font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      Criar Grid
                    </button>

                    <button
                      onClick={() => {
                        if (window.confirm('Tem certeza que deseja desfazer o Grid de Captura?')) {
                          setGridCapturaConfig(null)
                          setRevealedCards([])
                          setGridCardStates({})
                          if (useFirebase) {
                            saveToFirebase('mestre/gridCaptura', null)
                            saveToFirebase('mestre/gridCapturaRevealed', [])
                            saveToFirebase('mestre/gridCardStates', {})
                          }
                          alert('Grid removido!')
                        }
                      }}
                      className="w-full bg-gradient-to-r from-red-600 to-red-700 text-white py-3 rounded-lg hover:from-red-700 hover:to-red-800 font-semibold"
                    >
                      Desfazer Grid de Captura
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {accountDataModal}
          {scenarioPopupOverlay}
        {mostrarTriunfosOverlay}
          {pokezapPanel}{pokeAgendaPanel}
        {batalhaChatPanel}
        </div>
      </>
    )
  }

  // ÁREA POKEAPP (MESTRE)
  if (currentUser.type === 'mestre' && currentArea === 'PokeApp') {
    return (
      <>
        <div className={`min-h-screen ${mainBgClass}`}>
          {sidebarNav}
          <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-lg`}>
            <div className="max-w-7xl mx-auto px-4 py-4">
              <div className="flex justify-between items-center mb-4">
                <div className="flex items-center gap-3"><button onClick={() => setSidebarOpen(true)} className={`p-2 rounded-lg ${darkMode ? "hover:bg-gray-700 text-gray-400" : "hover:bg-gray-200 text-gray-500"}`}><Menu size={24} /></button><h2 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>PokeApp 👑</h2></div>
                <div className="flex gap-2">
                  <button onClick={() => setShowAccountDataModal(true)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-200 text-gray-700'}`} title="Dados da Conta"><ArrowDownUp size={20} /></button>
                  <button onClick={() => setDarkMode(!darkMode)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-yellow-400' : 'bg-gray-200 text-gray-700'}`}>{darkMode ? <Sun size={20} /> : <Moon size={20} />}</button>
                  {pokezapBtn}{pokeAgendaBtn}{batalhaChatBtn}<button onClick={handleLogout} className="bg-red-500 text-white px-3 sm:px-5 md:px-6 py-2 rounded-lg hover:bg-red-600">Sair</button>
                </div>
              </div>
            </div>
          </div>

          <div className="max-w-7xl mx-auto px-4 py-3 sm:py-5 md:py-8">
            {!pokeAppSubArea && (
              <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-4 md:p-5`}>
                <h3 className={`text-lg sm:text-xl md:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'} mb-4 sm:mb-5 md:mb-6`}>Selecione uma aplicação</h3>
                <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 sm:gap-3 md:gap-4">
                  <button
                    onClick={() => setPokeAppSubArea('Concurso')}
                    className="p-4 sm:p-5 md:p-6 rounded-xl bg-gradient-to-br from-yellow-500 to-orange-600 text-white hover:from-yellow-600 hover:to-orange-700 transition-all transform hover:scale-105 shadow-lg"
                  >
                    <h4 className="text-base sm:text-lg md:text-xl font-bold mb-2">🏆 Concurso Pokémon</h4>
                    <p className="text-xs sm:text-sm opacity-90">Calculadora de pontuação para concursos</p>
                  </button>
                  <button
                    onClick={() => setPokeAppSubArea('Encontro')}
                    className="p-4 sm:p-5 md:p-6 rounded-xl bg-gradient-to-br from-blue-500 to-purple-600 text-white hover:from-blue-600 hover:to-purple-700 transition-all transform hover:scale-105 shadow-lg"
                  >
                    <h4 className="text-base sm:text-lg md:text-xl font-bold mb-2">🔍 Encontro</h4>
                    <p className="text-xs sm:text-sm opacity-90">Em desenvolvimento</p>
                  </button>
                  <button
                    onClick={() => setPokeAppSubArea('Sorteador')}
                    className="p-4 sm:p-5 md:p-6 rounded-xl bg-gradient-to-br from-green-500 to-teal-600 text-white hover:from-green-600 hover:to-teal-700 transition-all transform hover:scale-105 shadow-lg"
                  >
                    <h4 className="text-base sm:text-lg md:text-xl font-bold mb-2">🎲 Sorteador</h4>
                    <p className="text-xs sm:text-sm opacity-90">Em desenvolvimento</p>
                  </button>
                  <button
                    onClick={() => setPokeAppSubArea('Backup')}
                    className="p-4 sm:p-5 md:p-6 rounded-xl bg-gradient-to-br from-red-500 to-pink-600 text-white hover:from-red-600 hover:to-pink-700 transition-all transform hover:scale-105 shadow-lg"
                  >
                    <h4 className="text-base sm:text-lg md:text-xl font-bold mb-2">💾 Backup & Restore</h4>
                    <p className="text-xs sm:text-sm opacity-90">Proteção contra perda de dados</p>
                  </button>
                </div>
              </div>
            )}

            {pokeAppSubArea && (
              <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-4 md:p-5`}>
                <div className="flex flex-col xs:flex-row justify-between items-start xs:items-center gap-3 mb-4 sm:mb-5 md:mb-6">
                  <h3 className={`text-lg sm:text-xl md:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{pokeAppSubArea}</h3>
                  <button
                    onClick={() => {
                      setPokeAppSubArea('')
                      setShowContestResults(false)
                      setContestPokemons([])
                    }}
                    className="bg-gray-500 text-white px-3 sm:px-4 py-2 rounded-lg hover:bg-gray-600 text-sm sm:text-base w-full xs:w-auto"
                  >
                    ← Voltar
                  </button>
                </div>

                {pokeAppSubArea === 'Encontro' && (
                  <div>
                    {/* Imagem Pokémon */}
                    <div className="flex justify-center mb-6">
                      <div className={`w-32 h-32 rounded-full ${darkMode ? 'bg-gradient-to-br from-gray-700 to-gray-600' : 'bg-gradient-to-br from-gray-300 to-gray-200'} flex items-center justify-center text-6xl border-4 ${darkMode ? 'border-gray-500' : 'border-gray-400'} shadow-lg`}>
                        ⚡
                      </div>
                    </div>

                    {/* Campos de entrada */}
                    <div className="space-y-6 mb-6">
                      {/* Horas de Procura */}
                      <div>
                        <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>
                          Horas de Procura:
                        </label>
                        <div className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-2`}>
                          1 hora = 10% de chance (0-100 horas)
                        </div>
                        <input
                          type="number"
                          min="0"
                          max="100"
                          value={encounterHours}
                          onChange={(e) => {
                            const val = Math.max(0, Math.min(100, parseInt(e.target.value) || 0))
                            setEncounterHours(val)
                          }}
                          className={`w-full px-3 py-2 sm:px-4 sm:py-3 border-2 rounded-lg text-sm sm:text-base ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'bg-white border-gray-300'}`}
                          placeholder="Digite as horas (0-100)"
                        />
                        <div className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-500'} mt-1 italic`}>
                          0 horas = 0% de chance
                        </div>
                      </div>

                      {/* Rolagem de Investigação */}
                      <div>
                        <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>
                          Rolagem de Investigação/Percepção:
                        </label>
                        <div className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-2`}>
                          5 pontos = 5% de chance (0-100 pontos)
                        </div>
                        <input
                          type="number"
                          min="0"
                          max="100"
                          value={encounterInvestigation}
                          onChange={(e) => {
                            const val = Math.max(0, Math.min(100, parseInt(e.target.value) || 0))
                            setEncounterInvestigation(val)
                          }}
                          className={`w-full px-3 py-2 sm:px-4 sm:py-3 border-2 rounded-lg text-sm sm:text-base ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'bg-white border-gray-300'}`}
                          placeholder="Digite os pontos (0-100)"
                        />
                        <div className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-500'} mt-1 italic`}>
                          0 pontos = 0% de chance
                        </div>
                      </div>

                      {/* Ajudantes Pokémon */}
                      <div>
                        <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>
                          Ajudantes Pokémon:
                        </label>
                        <div className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-2`}>
                          1 Pokémon ajudante = 4% de chance (0-100 ajudantes)
                        </div>
                        <input
                          type="number"
                          min="0"
                          max="100"
                          value={encounterHelpers}
                          onChange={(e) => {
                            const val = Math.max(0, Math.min(100, parseInt(e.target.value) || 0))
                            setEncounterHelpers(val)
                          }}
                          className={`w-full px-3 py-2 sm:px-4 sm:py-3 border-2 rounded-lg text-sm sm:text-base ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'bg-white border-gray-300'}`}
                          placeholder="Digite os ajudantes (0-100)"
                        />
                        <div className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-500'} mt-1 italic`}>
                          0 ajudantes = 0% de chance
                        </div>
                      </div>

                      {/* Bônus de Encontro */}
                      <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-3 sm:p-4 md:p-5 rounded-lg`}>
                        <h4 className={`text-base sm:text-lg font-bold ${darkMode ? 'text-blue-400' : 'text-blue-600'} mb-3 sm:mb-4`}>
                          Bônus de Encontro
                        </h4>

                        <div className="space-y-3">
                          <label className="flex items-center cursor-pointer">
                            <input
                              type="checkbox"
                              checked={encounterBait}
                              onChange={(e) => setEncounterBait(e.target.checked)}
                              className="w-5 h-5 mr-3 accent-blue-500"
                            />
                            <span className={`${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                              Usar Isca (+10% de chance)
                            </span>
                          </label>

                          <label className="flex items-center cursor-pointer">
                            <input
                              type="checkbox"
                              checked={encounterPokemonAttack}
                              onChange={(e) => setEncounterPokemonAttack(e.target.checked)}
                              className="w-5 h-5 mr-3 accent-blue-500"
                            />
                            <span className={`${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                              Usar Golpe Pokémon (+7% de chance)
                            </span>
                          </label>
                        </div>
                      </div>

                      {/* Pokémon Específico */}
                      <div>
                        <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-3`}>
                          Pokémon Específico:
                        </label>
                        <div className="flex gap-4 sm:gap-6">
                          <label className="flex items-center cursor-pointer">
                            <input
                              type="radio"
                              checked={encounterSpecific}
                              onChange={() => setEncounterSpecific(true)}
                              className="w-5 h-5 mr-2 accent-blue-500"
                            />
                            <span className={`${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                              Sim (-20% de chance)
                            </span>
                          </label>
                          <label className="flex items-center cursor-pointer">
                            <input
                              type="radio"
                              checked={!encounterSpecific}
                              onChange={() => setEncounterSpecific(false)}
                              className="w-5 h-5 mr-2 accent-blue-500"
                            />
                            <span className={`${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                              Não
                            </span>
                          </label>
                        </div>
                      </div>
                    </div>

                    {/* Botão Procurar */}
                    <button
                      onClick={() => {
                        // Calcular chance total
                        let totalChance = 0

                        // Horas: 10% por hora
                        const hoursChance = encounterHours * 10
                        totalChance += hoursChance

                        // Investigação: 5% a cada 5 pontos
                        const investigationChance = Math.floor(encounterInvestigation / 5) * 5
                        totalChance += investigationChance

                        // Ajudantes: 4% por ajudante
                        const helpersChance = encounterHelpers * 4
                        totalChance += helpersChance

                        // Isca: +10%
                        if (encounterBait) totalChance += 10

                        // Golpe Pokémon: +7%
                        if (encounterPokemonAttack) totalChance += 7

                        // Pokémon específico: -20%
                        if (encounterSpecific) totalChance -= 20

                        // Limitar entre 0 e 100
                        totalChance = Math.max(0, Math.min(100, totalChance))

                        // Rolar dado
                        const roll = Math.random() * 100

                        setEncounterResult({
                          chance: totalChance,
                          success: roll <= totalChance && totalChance > 0,
                          breakdown: [
                            { label: `Horas (${encounterHours}h)`, value: hoursChance },
                            { label: `Investigação (${encounterInvestigation}pts)`, value: investigationChance },
                            { label: `Ajudantes (${encounterHelpers}pkm)`, value: helpersChance },
                            ...(encounterBait ? [{ label: 'Isca', value: 10 }] : []),
                            ...(encounterPokemonAttack ? [{ label: 'Golpe Pokémon', value: 7 }] : []),
                            ...(encounterSpecific ? [{ label: 'Pokémon específico', value: -20 }] : [])
                          ]
                        })
                      }}
                      className="w-full bg-gradient-to-r from-yellow-400 to-yellow-500 text-blue-800 px-4 sm:px-5 md:px-6 py-3 sm:py-4 rounded-full text-base sm:text-lg font-bold hover:from-yellow-500 hover:to-yellow-600 shadow-lg transform transition-transform hover:-translate-y-1"
                    >
                      Procurar Pokémon!
                    </button>

                    {/* Display de Chance */}
                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-3 sm:p-4 md:p-5 rounded-lg mt-6`}>
                      <div className="text-center">
                        <div className={`text-base sm:text-lg md:text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                          Chance de Encontro: <span className="text-blue-500">
                            {(() => {
                              let chance = 0
                              chance += encounterHours * 10
                              chance += Math.floor(encounterInvestigation / 5) * 5
                              chance += encounterHelpers * 4
                              if (encounterBait) chance += 10
                              if (encounterPokemonAttack) chance += 7
                              if (encounterSpecific) chance -= 20
                              return Math.max(0, Math.min(100, chance)).toFixed(1)
                            })()}%
                          </span>
                        </div>

                        {/* Detalhamento */}
                        <div className={`mt-4 text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'} text-left`}>
                          <div className="font-bold mb-2">Detalhamento:</div>
                          {encounterHours > 0 && <div>Horas ({encounterHours}h): {encounterHours * 10}%</div>}
                          {encounterInvestigation > 0 && <div>Investigação ({encounterInvestigation}pts): {Math.floor(encounterInvestigation / 5) * 5}%</div>}
                          {encounterHelpers > 0 && <div>Ajudantes ({encounterHelpers}pkm): {encounterHelpers * 4}%</div>}
                          {encounterBait && <div>Isca: +10%</div>}
                          {encounterPokemonAttack && <div>Golpe Pokémon: +7%</div>}
                          {encounterSpecific && <div>Pokémon específico: -20%</div>}
                          {encounterHours === 0 && encounterInvestigation === 0 && encounterHelpers === 0 && !encounterBait && !encounterPokemonAttack && (
                            <div className="italic">Adicione valores para calcular a chance</div>
                          )}
                        </div>
                      </div>
                    </div>

                    {/* Resultado */}
                    {encounterResult && (
                      <div className={`mt-6 p-3 sm:p-4 md:p-5 rounded-lg border-2 ${
                        encounterResult.chance === 0
                          ? `${darkMode ? 'bg-red-900/20 border-red-500/50' : 'bg-red-50 border-red-300'}`
                          : encounterResult.success
                          ? `${darkMode ? 'bg-green-900/20 border-green-500/50' : 'bg-green-50 border-green-300'}`
                          : `${darkMode ? 'bg-red-900/20 border-red-500/50' : 'bg-red-50 border-red-300'}`
                      }`}>
                        <div className="text-center">
                          <div className="text-4xl sm:text-5xl mb-3 sm:mb-4">
                            {encounterResult.chance === 0 ? '❌' : encounterResult.success ? '🎉' : '😢'}
                          </div>
                          <div className={`text-base sm:text-lg md:text-xl font-bold mb-2 ${
                            encounterResult.chance === 0
                              ? 'text-red-500'
                              : encounterResult.success
                              ? 'text-green-500'
                              : 'text-red-500'
                          }`}>
                            {encounterResult.chance === 0
                              ? 'Impossível encontrar Pokémon!'
                              : encounterResult.success
                              ? 'Parabéns! Você encontrou um Pokémon!'
                              : 'Que pena! O Pokémon escapou desta vez.'}
                          </div>
                          <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                            {encounterResult.chance === 0
                              ? 'Sua chance é de 0%. Aumente os valores para ter uma chance.'
                              : `Sua chance era de ${encounterResult.chance.toFixed(1)}%`}
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {pokeAppSubArea === 'Sorteador' && (
                  <div>
                    <p className={`text-center text-sm sm:text-base ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-4 sm:mb-6`}>
                      Clique nos botões para sortear itens aleatórios de cada categoria
                    </p>

                    <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 sm:gap-3 md:gap-4">
                      {/* Frutos */}
                      {(() => {
                        const sortearFruto = () => {
                          const frutos = [
                            { nome: "Persim (Caqui)", preco: 45, efeito: "Restaura Confusão", sabores: ["Azedo", "Doce", "Picante", "Seco"] },
                            { nome: "Oran (Laranja)", preco: 90, efeito: "Recupera 1d8 PV.", sabores: ["Amargo", "Azedo", "Picante", "Seco"] },
                            { nome: "Sitrus (Toranja)", preco: 155, efeito: "Recupera 2d8 PV.", sabores: ["Amargo", "Azedo", "Doce", "Seco"] },
                            { nome: "Chesto (Castanha)", preco: 225, efeito: "Restaura Sono.", sabores: ["Seco"] },
                            { nome: "Cheri (Cereja)", preco: 225, efeito: "Restaura Paralisia.", sabores: ["Picante"] },
                            { nome: "Pecha (Pêssego)", preco: 225, efeito: "Restaura Veneno.", sabores: ["Doce"] },
                            { nome: "Lum (Ameka)", preco: 555, efeito: "Restaura qualquer Condição.", sabores: ["Azedo"] }
                          ]
                          const resultado = frutos[Math.floor(Math.random() * frutos.length)]
                          setSortedItems(prev => ({ ...prev, frutos: resultado }))
                        }

                        return (
                          <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} rounded-lg p-3 sm:p-4 border ${darkMode ? 'border-gray-600' : 'border-gray-300'} hover:shadow-lg transition-shadow`}>
                            <h3 className={`text-base sm:text-lg font-bold ${darkMode ? 'text-yellow-400' : 'text-yellow-600'} mb-2 sm:mb-3 pb-2 border-b-2 ${darkMode ? 'border-blue-500' : 'border-blue-400'}`}>
                              Frutos
                            </h3>
                            <div className={`min-h-[100px] sm:min-h-[120px] mb-3 p-2 sm:p-3 ${darkMode ? 'bg-gray-800' : 'bg-white'} rounded border ${darkMode ? 'border-gray-600' : 'border-gray-300'} text-xs sm:text-sm`}>
                              {sortedItems.frutos ? (
                                <>
                                  <p className="font-bold text-yellow-400 mb-1">{sortedItems.frutos.nome}</p>
                                  <p className="text-red-400 font-bold mb-1">Preço: {sortedItems.frutos.preco}</p>
                                  <p className={`${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-1`}><span className="font-bold">Sabores:</span> {sortedItems.frutos.sabores.join(", ")}</p>
                                  <p className={`${darkMode ? 'text-gray-300' : 'text-gray-700'}`}><span className="font-bold">Efeito:</span> {sortedItems.frutos.efeito}</p>
                                </>
                              ) : (
                                <p className={`${darkMode ? 'text-gray-500' : 'text-gray-400'} text-center pt-10`}>Clique em sortear</p>
                              )}
                            </div>
                            <button
                              onClick={sortearFruto}
                              className="w-full bg-gradient-to-b from-red-500 to-red-700 text-white px-4 py-2 rounded font-bold hover:from-red-600 hover:to-red-800 shadow-md transition-all"
                            >
                              Sortear
                            </button>
                          </div>
                        )
                      })()}

                      {/* Itens Mantidos */}
                      {(() => {
                        const sortearItemMantido = () => {
                          const itensMantidos = [
                            { nome: "Amuleto da Sorte", preco: 2400, efeito: "Até o fim do encontro, o número mínimo necessário no Teste de Acurácia para se obter um Crítico é reduzido em 3." },
                            { nome: "Restos", preco: 2000, efeito: "O usuário recupera uma quantidade de Pontos de Vida por rodada igual a 1/16 de seus PV máximos até o fim do encontro." },
                            { nome: "Cinturão do Campeão", preco: 6000, efeito: "Quando causar dano superefeitvo, adicione ao dano (antes de aplicar a vulnerabilidade) uma quantidade igual ao Bônus Elemental." }
                          ]
                          const resultado = itensMantidos[Math.floor(Math.random() * itensMantidos.length)]
                          setSortedItems(prev => ({ ...prev, itensMantidos: resultado }))
                        }

                        return (
                          <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} rounded-lg p-3 sm:p-4 border ${darkMode ? 'border-gray-600' : 'border-gray-300'} hover:shadow-lg transition-shadow`}>
                            <h3 className={`text-base sm:text-lg font-bold ${darkMode ? 'text-yellow-400' : 'text-yellow-600'} mb-2 sm:mb-3 pb-2 border-b-2 ${darkMode ? 'border-blue-500' : 'border-blue-400'}`}>
                              Itens Mantidos
                            </h3>
                            <div className={`min-h-[100px] sm:min-h-[120px] mb-3 p-2 sm:p-3 ${darkMode ? 'bg-gray-800' : 'bg-white'} rounded border ${darkMode ? 'border-gray-600' : 'border-gray-300'} text-xs sm:text-sm overflow-y-auto`}>
                              {sortedItems.itensMantidos ? (
                                <>
                                  <p className="font-bold text-yellow-400 mb-1">{sortedItems.itensMantidos.nome}</p>
                                  <p className="text-red-400 font-bold mb-1">Preço: {sortedItems.itensMantidos.preco}</p>
                                  <p className={`${darkMode ? 'text-gray-300' : 'text-gray-700'}`}><span className="font-bold">Efeito:</span> {sortedItems.itensMantidos.efeito}</p>
                                </>
                              ) : (
                                <p className={`${darkMode ? 'text-gray-500' : 'text-gray-400'} text-center pt-10`}>Clique em sortear</p>
                              )}
                            </div>
                            <button
                              onClick={sortearItemMantido}
                              className="w-full bg-gradient-to-b from-red-500 to-red-700 text-white px-4 py-2 rounded font-bold hover:from-red-600 hover:to-red-800 shadow-md transition-all"
                            >
                              Sortear
                            </button>
                          </div>
                        )
                      })()}

                      {/* Melhoradores */}
                      {(() => {
                        const sortearMelhorador = () => {
                          const melhoradores = [
                            { nome: "X-Ataque", preco: 80, efeito: "Eleva uma Fase de Ataque." },
                            { nome: "X-Defesa", preco: 80, efeito: "Eleva uma Fase de Defesa." },
                            { nome: "X-Velocidade", preco: 80, efeito: "Eleva uma Fase de Velocidade." },
                            { nome: "Golpe Atroz", preco: 80, efeito: "Obtém Críticos em resultados 18 a 20 nos Testes de Acurácia." }
                          ]
                          const resultado = melhoradores[Math.floor(Math.random() * melhoradores.length)]
                          setSortedItems(prev => ({ ...prev, melhoradores: resultado }))
                        }

                        return (
                          <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} rounded-lg p-3 sm:p-4 border ${darkMode ? 'border-gray-600' : 'border-gray-300'} hover:shadow-lg transition-shadow`}>
                            <h3 className={`text-base sm:text-lg font-bold ${darkMode ? 'text-yellow-400' : 'text-yellow-600'} mb-2 sm:mb-3 pb-2 border-b-2 ${darkMode ? 'border-blue-500' : 'border-blue-400'}`}>
                              Melhoradores
                            </h3>
                            <div className={`min-h-[100px] sm:min-h-[120px] mb-3 p-2 sm:p-3 ${darkMode ? 'bg-gray-800' : 'bg-white'} rounded border ${darkMode ? 'border-gray-600' : 'border-gray-300'} text-xs sm:text-sm`}>
                              {sortedItems.melhoradores ? (
                                <>
                                  <p className="font-bold text-yellow-400 mb-1">{sortedItems.melhoradores.nome}</p>
                                  <p className="text-red-400 font-bold mb-1">Preço: {sortedItems.melhoradores.preco}</p>
                                  <p className={`${darkMode ? 'text-gray-300' : 'text-gray-700'}`}><span className="font-bold">Efeito:</span> {sortedItems.melhoradores.efeito}</p>
                                </>
                              ) : (
                                <p className={`${darkMode ? 'text-gray-500' : 'text-gray-400'} text-center pt-10`}>Clique em sortear</p>
                              )}
                            </div>
                            <button
                              onClick={sortearMelhorador}
                              className="w-full bg-gradient-to-b from-red-500 to-red-700 text-white px-4 py-2 rounded font-bold hover:from-red-600 hover:to-red-800 shadow-md transition-all"
                            >
                              Sortear
                            </button>
                          </div>
                        )
                      })()}

                      {/* Pedras de Evolução */}
                      {(() => {
                        const sortearPedraEvolucao = () => {
                          const pedrasEvolucao = [
                            "Pedra Brilhante", "Pedra da Água", "Pedra da Alvorada", "Pedra da Folha",
                            "Pedra da Lua", "Pedra do Crepúsculo", "Pedra do Fogo", "Pedra do Frio",
                            "Pedra do Sol", "Pedra do Trovão"
                          ]
                          const resultado = pedrasEvolucao[Math.floor(Math.random() * pedrasEvolucao.length)]
                          setSortedItems(prev => ({ ...prev, pedrasEvolucao: resultado }))
                        }

                        return (
                          <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} rounded-lg p-3 sm:p-4 border ${darkMode ? 'border-gray-600' : 'border-gray-300'} hover:shadow-lg transition-shadow`}>
                            <h3 className={`text-base sm:text-lg font-bold ${darkMode ? 'text-yellow-400' : 'text-yellow-600'} mb-2 sm:mb-3 pb-2 border-b-2 ${darkMode ? 'border-blue-500' : 'border-blue-400'}`}>
                              Pedras de Evolução
                            </h3>
                            <div className={`min-h-[100px] sm:min-h-[120px] mb-3 p-2 sm:p-3 ${darkMode ? 'bg-gray-800' : 'bg-white'} rounded border ${darkMode ? 'border-gray-600' : 'border-gray-300'} text-xs sm:text-sm`}>
                              {sortedItems.pedrasEvolucao ? (
                                <p className="font-bold text-yellow-400 text-center pt-10">{sortedItems.pedrasEvolucao}</p>
                              ) : (
                                <p className={`${darkMode ? 'text-gray-500' : 'text-gray-400'} text-center pt-10`}>Clique em sortear</p>
                              )}
                            </div>
                            <button
                              onClick={sortearPedraEvolucao}
                              className="w-full bg-gradient-to-b from-red-500 to-red-700 text-white px-4 py-2 rounded font-bold hover:from-red-600 hover:to-red-800 shadow-md transition-all"
                            >
                              Sortear
                            </button>
                          </div>
                        )
                      })()}

                      {/* Itens de Cura */}
                      {(() => {
                        const sortearItemCura = () => {
                          const itensCura = [
                            { nome: "Poção", preco: 200, efeito: "Restaura 2d12+10 PV" },
                            { nome: "Superpoção", preco: 350, efeito: "Restaura 3d12+20 PV" },
                            { nome: "Hiperpoção", preco: 450, efeito: "Restaura 4d12+30 PV" },
                            { nome: "Antídoto", preco: 250, efeito: "Restaura Veneno" },
                            { nome: "Panaceia", preco: 500, efeito: "Restaura todas as Condições" },
                            { nome: "Revivente", preco: 300, efeito: "Restaura um pokémon inconsciente a 20 Pontos de Vida" }
                          ]
                          const resultado = itensCura[Math.floor(Math.random() * itensCura.length)]
                          setSortedItems(prev => ({ ...prev, itensCura: resultado }))
                        }

                        return (
                          <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} rounded-lg p-3 sm:p-4 border ${darkMode ? 'border-gray-600' : 'border-gray-300'} hover:shadow-lg transition-shadow`}>
                            <h3 className={`text-base sm:text-lg font-bold ${darkMode ? 'text-yellow-400' : 'text-yellow-600'} mb-2 sm:mb-3 pb-2 border-b-2 ${darkMode ? 'border-blue-500' : 'border-blue-400'}`}>
                              Itens de Cura
                            </h3>
                            <div className={`min-h-[100px] sm:min-h-[120px] mb-3 p-2 sm:p-3 ${darkMode ? 'bg-gray-800' : 'bg-white'} rounded border ${darkMode ? 'border-gray-600' : 'border-gray-300'} text-xs sm:text-sm`}>
                              {sortedItems.itensCura ? (
                                <>
                                  <p className="font-bold text-yellow-400 mb-1">{sortedItems.itensCura.nome}</p>
                                  <p className="text-red-400 font-bold mb-1">Preço: {sortedItems.itensCura.preco}</p>
                                  <p className={`${darkMode ? 'text-gray-300' : 'text-gray-700'}`}><span className="font-bold">Efeito:</span> {sortedItems.itensCura.efeito}</p>
                                </>
                              ) : (
                                <p className={`${darkMode ? 'text-gray-500' : 'text-gray-400'} text-center pt-10`}>Clique em sortear</p>
                              )}
                            </div>
                            <button
                              onClick={sortearItemCura}
                              className="w-full bg-gradient-to-b from-red-500 to-red-700 text-white px-4 py-2 rounded font-bold hover:from-red-600 hover:to-red-800 shadow-md transition-all"
                            >
                              Sortear
                            </button>
                          </div>
                        )
                      })()}

                      {/* Pokébolas */}
                      {(() => {
                        const sortearPokebola = () => {
                          const pokebolas = [
                            { nome: "Pokébola Básica", preco: 200, efeito: "Modificador: 15" },
                            { nome: "Superbola", preco: 500, efeito: "Modificador: 5" },
                            { nome: "Ultrabola", preco: 1000, efeito: "Modificador: -5" },
                            { nome: "Pokébola de Nível", preco: 2000, efeito: "+5; ou -15 se o Nível do alvo é menor que a metade do Nível do seu pokémon." },
                            { nome: "Pokébola Amigável", preco: 2000, efeito: "-5. A Lealdade do alvo começará 2." }
                          ]
                          const resultado = pokebolas[Math.floor(Math.random() * pokebolas.length)]
                          setSortedItems(prev => ({ ...prev, pokebolas: resultado }))
                        }

                        return (
                          <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} rounded-lg p-3 sm:p-4 border ${darkMode ? 'border-gray-600' : 'border-gray-300'} hover:shadow-lg transition-shadow`}>
                            <h3 className={`text-base sm:text-lg font-bold ${darkMode ? 'text-yellow-400' : 'text-yellow-600'} mb-2 sm:mb-3 pb-2 border-b-2 ${darkMode ? 'border-blue-500' : 'border-blue-400'}`}>
                              Pokébolas
                            </h3>
                            <div className={`min-h-[100px] sm:min-h-[120px] mb-3 p-2 sm:p-3 ${darkMode ? 'bg-gray-800' : 'bg-white'} rounded border ${darkMode ? 'border-gray-600' : 'border-gray-300'} text-xs sm:text-sm`}>
                              {sortedItems.pokebolas ? (
                                <>
                                  <p className="font-bold text-yellow-400 mb-1">{sortedItems.pokebolas.nome}</p>
                                  <p className="text-red-400 font-bold mb-1">Preço: {sortedItems.pokebolas.preco}</p>
                                  <p className={`${darkMode ? 'text-gray-300' : 'text-gray-700'}`}><span className="font-bold">Efeito:</span> {sortedItems.pokebolas.efeito}</p>
                                </>
                              ) : (
                                <p className={`${darkMode ? 'text-gray-500' : 'text-gray-400'} text-center pt-10`}>Clique em sortear</p>
                              )}
                            </div>
                            <button
                              onClick={sortearPokebola}
                              className="w-full bg-gradient-to-b from-red-500 to-red-700 text-white px-4 py-2 rounded font-bold hover:from-red-600 hover:to-red-800 shadow-md transition-all"
                            >
                              Sortear
                            </button>
                          </div>
                        )
                      })()}

                      {/* Vitaminas */}
                      {(() => {
                        const sortearVitamina = () => {
                          const vitaminas = [
                            { nome: "Imunizante", preco: 4900, efeito: "Aumenta a Saúde Basal em 1." },
                            { nome: "Proteína", preco: 4900, efeito: "Aumenta o Ataque Basal em 1." },
                            { nome: "Ferro", preco: 4900, efeito: "Aumenta a Defesa Basal em 1." },
                            { nome: "Cálcio", preco: 4900, efeito: "Aumenta o Ataque Especial Basal em 1." },
                            { nome: "Zinco", preco: 4900, efeito: "Aumenta a Defesa Especial Basal em 1." },
                            { nome: "Carburante", preco: 4900, efeito: "Aumenta a Velocidade Basal em 1." }
                          ]
                          const resultado = vitaminas[Math.floor(Math.random() * vitaminas.length)]
                          setSortedItems(prev => ({ ...prev, vitaminas: resultado }))
                        }

                        return (
                          <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} rounded-lg p-3 sm:p-4 border ${darkMode ? 'border-gray-600' : 'border-gray-300'} hover:shadow-lg transition-shadow`}>
                            <h3 className={`text-base sm:text-lg font-bold ${darkMode ? 'text-yellow-400' : 'text-yellow-600'} mb-2 sm:mb-3 pb-2 border-b-2 ${darkMode ? 'border-blue-500' : 'border-blue-400'}`}>
                              Vitaminas
                            </h3>
                            <div className={`min-h-[100px] sm:min-h-[120px] mb-3 p-2 sm:p-3 ${darkMode ? 'bg-gray-800' : 'bg-white'} rounded border ${darkMode ? 'border-gray-600' : 'border-gray-300'} text-xs sm:text-sm`}>
                              {sortedItems.vitaminas ? (
                                <>
                                  <p className="font-bold text-yellow-400 mb-1">{sortedItems.vitaminas.nome}</p>
                                  <p className="text-red-400 font-bold mb-1">Preço: {sortedItems.vitaminas.preco}</p>
                                  <p className={`${darkMode ? 'text-gray-300' : 'text-gray-700'}`}><span className="font-bold">Efeito:</span> {sortedItems.vitaminas.efeito}</p>
                                </>
                              ) : (
                                <p className={`${darkMode ? 'text-gray-500' : 'text-gray-400'} text-center pt-10`}>Clique em sortear</p>
                              )}
                            </div>
                            <button
                              onClick={sortearVitamina}
                              className="w-full bg-gradient-to-b from-red-500 to-red-700 text-white px-4 py-2 rounded font-bold hover:from-red-600 hover:to-red-800 shadow-md transition-all"
                            >
                              Sortear
                            </button>
                          </div>
                        )
                      })()}

                      {/* TMs */}
                      {(() => {
                        const sortearTM = () => {
                          const tms = [
                            { nome: "Cascata", tipo: "Água" },
                            { nome: "Relâmpago", tipo: "Elétrico" },
                            { nome: "Lança-Chamas", tipo: "Fogo" },
                            { nome: "Raio de Gelo", tipo: "Gelo" },
                            { nome: "Terremoto", tipo: "Terra" },
                            { nome: "Psicochoque", tipo: "Psíquico" },
                            { nome: "Garra do Dragão", tipo: "Dragão" },
                            { nome: "Pulso Sombrio", tipo: "Trevas" }
                          ]
                          const resultado = tms[Math.floor(Math.random() * tms.length)]
                          setSortedItems(prev => ({ ...prev, tms: resultado }))
                        }

                        return (
                          <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} rounded-lg p-3 sm:p-4 border ${darkMode ? 'border-gray-600' : 'border-gray-300'} hover:shadow-lg transition-shadow`}>
                            <h3 className={`text-base sm:text-lg font-bold ${darkMode ? 'text-yellow-400' : 'text-yellow-600'} mb-2 sm:mb-3 pb-2 border-b-2 ${darkMode ? 'border-blue-500' : 'border-blue-400'}`}>
                              TMs
                            </h3>
                            <div className={`min-h-[100px] sm:min-h-[120px] mb-3 p-2 sm:p-3 ${darkMode ? 'bg-gray-800' : 'bg-white'} rounded border ${darkMode ? 'border-gray-600' : 'border-gray-300'} text-xs sm:text-sm`}>
                              {sortedItems.tms ? (
                                <>
                                  <p className="font-bold text-yellow-400 mb-1">{sortedItems.tms.nome}</p>
                                  <p className={`${darkMode ? 'text-gray-300' : 'text-gray-700'}`}><span className="font-bold">Tipo:</span> {sortedItems.tms.tipo}</p>
                                </>
                              ) : (
                                <p className={`${darkMode ? 'text-gray-500' : 'text-gray-400'} text-center pt-10`}>Clique em sortear</p>
                              )}
                            </div>
                            <button
                              onClick={sortearTM}
                              className="w-full bg-gradient-to-b from-red-500 to-red-700 text-white px-4 py-2 rounded font-bold hover:from-red-600 hover:to-red-800 shadow-md transition-all"
                            >
                              Sortear
                            </button>
                          </div>
                        )
                      })()}
                    </div>
                  </div>
                )}

                {pokeAppSubArea === 'Backup' && (
                  <div>
                    {/* Ações de Backup */}
                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-3 sm:p-4 md:p-5 rounded-lg mb-4 sm:mb-6`}>
                      <h4 className={`text-base sm:text-lg font-bold ${darkMode ? 'text-white' : 'text-gray-800'} mb-3 sm:mb-4`}>Ações Rápidas</h4>
                      <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2 sm:gap-3 md:gap-4">
                        <button
                          onClick={handleCreateBackup}
                          className="flex flex-col items-center justify-center p-4 sm:p-5 md:p-6 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-all transform hover:scale-105 shadow-lg"
                        >
                          <span className="text-3xl sm:text-4xl mb-2">💾</span>
                          <span className="font-bold text-sm sm:text-base">Criar Backup</span>
                          <span className="text-xs opacity-80 mt-1">Salva estado atual</span>
                        </button>

                        <button
                          onClick={handleExportBackup}
                          className="flex flex-col items-center justify-center p-4 sm:p-5 md:p-6 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-all transform hover:scale-105 shadow-lg"
                        >
                          <span className="text-3xl sm:text-4xl mb-2">📥</span>
                          <span className="font-bold text-sm sm:text-base">Exportar Backup</span>
                          <span className="text-xs opacity-80 mt-1">Download arquivo JSON</span>
                        </button>

                        <label className="flex flex-col items-center justify-center p-4 sm:p-5 md:p-6 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-all transform hover:scale-105 shadow-lg cursor-pointer">
                          <span className="text-3xl sm:text-4xl mb-2">📤</span>
                          <span className="font-bold text-sm sm:text-base">Importar Backup</span>
                          <span className="text-xs opacity-80 mt-1">Carregar arquivo JSON</span>
                          <input
                            type="file"
                            accept=".json"
                            onChange={handleImportBackup}
                            className="hidden"
                          />
                        </label>
                      </div>
                    </div>

                    {/* Backup Automático Info */}
                    <div className={`${darkMode ? 'bg-blue-900' : 'bg-blue-100'} ${darkMode ? 'border-blue-700' : 'border-blue-300'} border-2 p-3 sm:p-4 rounded-lg mb-4 sm:mb-6`}>
                      <div className="flex items-start gap-2 sm:gap-3">
                        <span className="text-lg sm:text-xl md:text-2xl">ℹ️</span>
                        <div>
                          <h5 className={`font-bold ${darkMode ? 'text-blue-300' : 'text-blue-800'} mb-1`}>Backup Automático Ativo</h5>
                          <p className={`text-sm ${darkMode ? 'text-blue-200' : 'text-blue-700'}`}>
                            O sistema cria backups automaticamente: <strong>a cada 10 minutos</strong> de uso e <strong>quando qualquer usuário desloga</strong>. Os últimos 5 backups são mantidos no Firebase.
                          </p>
                        </div>
                      </div>
                    </div>

                    {/* Backup Selecionado para Restaurar */}
                    {selectedBackup && (
                      <div className={`${darkMode ? 'bg-yellow-900' : 'bg-yellow-100'} ${darkMode ? 'border-yellow-700' : 'border-yellow-300'} border-2 p-4 rounded-lg mb-6`}>
                        <div className="flex justify-between items-start">
                          <div>
                            <h5 className={`font-bold ${darkMode ? 'text-yellow-300' : 'text-yellow-800'} mb-1`}>Backup Carregado</h5>
                            <p className={`text-sm ${darkMode ? 'text-yellow-200' : 'text-yellow-700'}`}>
                              Data: {new Date(selectedBackup.timestamp).toLocaleString('pt-BR')}
                            </p>
                          </div>
                          <button
                            onClick={() => handleRestoreBackup(selectedBackup)}
                            className="bg-yellow-600 hover:bg-yellow-700 text-white px-3 sm:px-5 md:px-6 py-2 rounded-lg font-bold transition-colors"
                          >
                            ⚠️ Restaurar Agora
                          </button>
                        </div>
                      </div>
                    )}

                    {/* Histórico de Backups */}
                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-3 sm:p-4 md:p-5 rounded-lg`}>
                      <h4 className={`text-base sm:text-lg font-bold ${darkMode ? 'text-white' : 'text-gray-800'} mb-3 sm:mb-4`}>
                        Histórico de Backups ({backupHistory.length}/5)
                      </h4>

                      {backupHistory.length === 0 ? (
                        <p className={`text-center text-sm sm:text-base py-4 sm:py-6 md:py-8 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                          Nenhum backup encontrado. Clique em "Criar Backup" para começar.
                        </p>
                      ) : (
                        <div className="space-y-3">
                          {backupHistory.map((backup, index) => (
                            <div
                              key={index}
                              className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-3 sm:p-4 rounded-lg border-2 ${darkMode ? 'border-gray-600' : 'border-gray-300'} hover:border-blue-500 transition-colors`}
                            >
                              <div className="flex flex-col sm:flex-row justify-between sm:items-center gap-3">
                                <div className="flex-1">
                                  <div className="flex items-center gap-2 sm:gap-3 mb-2">
                                    <span className="text-lg sm:text-xl md:text-2xl">
                                      {index === 0 ? '🌟' : '💾'}
                                    </span>
                                    <div>
                                      <h5 className={`font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                        {index === 0 ? 'Backup Mais Recente' : `Backup #${index + 1}`}
                                      </h5>
                                      <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                        {new Date(backup.timestamp).toLocaleString('pt-BR', {
                                          dateStyle: 'short',
                                          timeStyle: 'short'
                                        })}
                                      </p>
                                    </div>
                                  </div>

                                  {/* Info do Backup */}
                                  <div className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-500'} grid grid-cols-2 sm:grid-cols-4 gap-1 sm:gap-2`}>
                                    <span>📊 Treinadores: {Object.keys(backup.data.trainers || {}).length}</span>
                                    <span>🎮 NPCs: {(backup.data.npcTrainers || []).length}</span>
                                    <span>💬 Mensagens: {(backup.data.chat || []).length}</span>
                                    <span>🌳 Árvores: {(backup.data.apricornTrees || []).length}</span>
                                  </div>
                                </div>

                                <div className="flex gap-2 sm:ml-4 flex-wrap sm:flex-nowrap">
                                  <button
                                    onClick={() => handleRestoreBackup(backup)}
                                    className="bg-green-600 hover:bg-green-700 text-white px-3 sm:px-4 py-2 rounded-lg font-semibold transition-colors text-xs sm:text-sm"
                                    title="Restaurar este backup"
                                  >
                                    ↩️ Restaurar
                                  </button>
                                  <button
                                    onClick={() => {
                                      const dataStr = JSON.stringify(backup, null, 2)
                                      const dataBlob = new Blob([dataStr], { type: 'application/json' })
                                      const url = URL.createObjectURL(dataBlob)
                                      const link = document.createElement('a')
                                      link.href = url
                                      link.download = `backup-${new Date(backup.timestamp).toISOString().replace(/[:.]/g, '-')}.json`
                                      document.body.appendChild(link)
                                      link.click()
                                      document.body.removeChild(link)
                                      URL.revokeObjectURL(url)
                                    }}
                                    className={`${darkMode ? 'bg-gray-600 hover:bg-gray-500' : 'bg-gray-300 hover:bg-gray-400'} ${darkMode ? 'text-white' : 'text-gray-800'} px-3 sm:px-4 py-2 rounded-lg font-semibold transition-colors text-xs sm:text-sm`}
                                    title="Baixar este backup"
                                  >
                                    📥
                                  </button>
                                  <button
                                    onClick={() => handleDeleteBackup(index)}
                                    className="bg-red-600 hover:bg-red-700 text-white px-3 sm:px-4 py-2 rounded-lg font-semibold transition-colors text-xs sm:text-sm"
                                    title="Excluir este backup"
                                  >
                                    🗑️
                                  </button>
                                </div>
                              </div>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>

                    {/* Instruções */}
                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-3 sm:p-4 md:p-5 rounded-lg mt-4 sm:mt-6`}>
                      <h4 className={`text-base sm:text-lg font-bold ${darkMode ? 'text-white' : 'text-gray-800'} mb-3`}>📖 Como Usar</h4>
                      <div className={`space-y-2 text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                        <p><strong>✅ Criar Backup:</strong> Salva todos os dados atuais no navegador (automático a cada 5 min)</p>
                        <p><strong>📥 Exportar:</strong> Baixa um arquivo JSON com todos os dados (recomendado para backup externo)</p>
                        <p><strong>📤 Importar:</strong> Carrega um arquivo de backup JSON (não aplica imediatamente)</p>
                        <p><strong>↩️ Restaurar:</strong> Substitui TODOS os dados atuais pelo backup selecionado</p>
                        <p className={`${darkMode ? 'text-yellow-400' : 'text-yellow-700'} font-bold mt-4`}>
                          ⚠️ IMPORTANTE: Recomendamos exportar backups regularmente para um local seguro fora do navegador!
                        </p>
                      </div>
                    </div>
                  </div>
                )}

                {pokeAppSubArea === 'Concurso' && (
                  <div>
                    {/* Configuração do Concurso */}
                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-3 sm:p-4 md:p-5 rounded-lg mb-4 sm:mb-6`}>
                      <h4 className={`text-base sm:text-lg md:text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'} mb-3 sm:mb-4`}>Configuração do Concurso</h4>

                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-2 sm:gap-3 md:gap-4 mb-4">
                        <div>
                          <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>
                            Número de Pokémon no Concurso (1-20)
                          </label>
                          <input
                            type="number"
                            min="1"
                            max="20"
                            value={numPokemons}
                            onChange={(e) => setNumPokemons(Math.max(1, Math.min(20, parseInt(e.target.value) || 1)))}
                            className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'bg-white border-gray-300'}`}
                          />
                        </div>
                        <div>
                          <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>
                            Número de Rodadas de Apelação (1-20)
                          </label>
                          <input
                            type="number"
                            min="1"
                            max="20"
                            value={numAppealRounds}
                            onChange={(e) => {
                              const val = Math.max(1, Math.min(20, parseInt(e.target.value) || 1))
                              setNumAppealRounds(val)
                              // Atualizar pokémons existentes com novas rodadas
                              if (contestPokemons.length > 0) {
                                const updated = contestPokemons.map(p => ({
                                  ...p,
                                  appealScores: Array(val).fill(0)
                                }))
                                setContestPokemons(updated)
                              }
                            }}
                            className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'bg-white border-gray-300'}`}
                          />
                        </div>
                      </div>

                      <button
                        onClick={() => {
                          const newPokemons = Array.from({ length: numPokemons }, (_, i) => ({
                            id: Date.now() + i,
                            name: `Pokémon ${i + 1}`,
                            presentationScore: 0,
                            appealScores: Array(numAppealRounds).fill(0)
                          }))
                          setContestPokemons(newPokemons)
                          setShowContestResults(false)
                        }}
                        className="w-full bg-green-500 text-white px-3 sm:px-5 md:px-6 py-3 rounded-lg hover:bg-green-600 font-semibold"
                      >
                        Gerar Formulário de Pokémon
                      </button>
                    </div>

                    {/* Lista de Pokémon */}
                    {contestPokemons.length > 0 && (
                      <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-3 sm:p-4 md:p-5 rounded-lg mb-4 sm:mb-6`}>
                        <h4 className={`text-base sm:text-lg md:text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'} mb-3 sm:mb-4`}>Notas dos Pokémon</h4>

                        <div className="space-y-4">
                          {contestPokemons.map((pokemon, idx) => (
                            <div key={pokemon.id} className={`${darkMode ? 'bg-gray-600' : 'bg-white'} p-4 rounded-lg border-2 ${darkMode ? 'border-gray-500' : 'border-gray-300'}`}>
                              <div className="flex justify-between items-center mb-3">
                                <input
                                  type="text"
                                  value={pokemon.name}
                                  onChange={(e) => {
                                    const updated = [...contestPokemons]
                                    updated[idx].name = e.target.value
                                    setContestPokemons(updated)
                                  }}
                                  className={`flex-1 px-3 py-2 rounded-lg font-semibold ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'bg-gray-100 border-gray-300'} border-2 mr-2`}
                                  placeholder={`Nome do Pokémon ${idx + 1}`}
                                />
                                <button
                                  onClick={() => {
                                    setContestPokemons(contestPokemons.filter((_, i) => i !== idx))
                                  }}
                                  className="bg-red-500 text-white px-3 py-2 rounded-full hover:bg-red-600 font-bold"
                                >
                                  ×
                                </button>
                              </div>

                              <div className="grid grid-cols-1 gap-3 sm:gap-4">
                                <div>
                                  <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>
                                    Nota de Apresentação
                                  </label>
                                  <input
                                    type="number"
                                    min="0"
                                    value={pokemon.presentationScore}
                                    onChange={(e) => {
                                      const updated = [...contestPokemons]
                                      updated[idx].presentationScore = Math.max(0, parseInt(e.target.value) || 0)
                                      setContestPokemons(updated)
                                    }}
                                    className={`w-full px-3 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'bg-white border-gray-300'}`}
                                  />
                                </div>

                                <div>
                                  <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>
                                    Notas de Apelação
                                  </label>
                                  <div className="grid grid-cols-2 xs:grid-cols-4 gap-2">
                                    {pokemon.appealScores.map((score, scoreIdx) => (
                                      <div key={scoreIdx}>
                                        <label className={`block text-xs text-center ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-1`}>
                                          R{scoreIdx + 1}
                                        </label>
                                        <input
                                          type="number"
                                          min="0"
                                          value={score}
                                          onChange={(e) => {
                                            const updated = [...contestPokemons]
                                            updated[idx].appealScores[scoreIdx] = Math.max(0, parseInt(e.target.value) || 0)
                                            setContestPokemons(updated)
                                          }}
                                          className={`w-full px-2 py-1 border-2 rounded text-center ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'bg-white border-gray-300'}`}
                                        />
                                      </div>
                                    ))}
                                  </div>
                                </div>
                              </div>
                            </div>
                          ))}
                        </div>

                        <div className="flex flex-col xs:flex-row gap-2 sm:gap-3 mt-6">
                          <button
                            onClick={() => {
                              const results = contestPokemons.map(p => ({
                                ...p,
                                appealTotal: p.appealScores.reduce((sum, score) => sum + score, 0),
                                total: p.presentationScore + p.appealScores.reduce((sum, score) => sum + score, 0)
                              })).sort((a, b) => b.total - a.total)
                              setContestPokemons(results)
                              setShowContestResults(true)
                            }}
                            className="flex-1 bg-blue-500 text-white px-4 sm:px-5 md:px-6 py-3 rounded-lg hover:bg-blue-600 font-semibold text-sm sm:text-base"
                          >
                            Calcular Pódio
                          </button>
                          <button
                            onClick={() => {
                              setContestPokemons([])
                              setShowContestResults(false)
                            }}
                            className="flex-1 bg-orange-500 text-white px-4 sm:px-5 md:px-6 py-3 rounded-lg hover:bg-orange-600 font-semibold text-sm sm:text-base"
                          >
                            Reiniciar
                          </button>
                        </div>
                      </div>
                    )}

                    {/* Resultados */}
                    {showContestResults && contestPokemons.length > 0 && (
                      <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-3 sm:p-4 md:p-5 rounded-lg`}>
                        <h4 className={`text-base sm:text-lg md:text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'} mb-4 sm:mb-6`}>Resultado do Concurso</h4>

                        {/* Pódio */}
                        <div className="flex justify-center items-end gap-1 sm:gap-2 md:gap-3 mb-6 sm:mb-8">
                          {contestPokemons.length >= 2 && (
                            <div className="bg-gradient-to-br from-gray-300 to-gray-400 rounded-t-lg p-2 sm:p-3 md:p-4 text-center w-24 h-20 sm:w-32 sm:h-24 md:w-36 md:h-28">
                              <div className="text-lg sm:text-2xl md:text-3xl font-bold text-gray-800">2º</div>
                              <div className="font-bold text-gray-800 mt-1 text-xs sm:text-sm truncate">{contestPokemons[1].name}</div>
                              <div className="text-xs sm:text-sm text-gray-700 mt-0.5">{contestPokemons[1].total} pts</div>
                            </div>
                          )}
                          {contestPokemons.length >= 1 && (
                            <div className="bg-gradient-to-br from-yellow-400 to-yellow-600 rounded-t-lg p-2 sm:p-3 md:p-4 text-center w-24 h-24 sm:w-32 sm:h-32 md:w-36 md:h-36">
                              <div className="text-2xl sm:text-3xl md:text-4xl font-bold text-yellow-900">1º</div>
                              <div className="font-bold text-yellow-900 mt-1 text-xs sm:text-sm truncate">{contestPokemons[0].name}</div>
                              <div className="text-xs sm:text-sm text-yellow-800 mt-0.5">{contestPokemons[0].total} pts</div>
                            </div>
                          )}
                          {contestPokemons.length >= 3 && (
                            <div className="bg-gradient-to-br from-orange-600 to-orange-800 rounded-t-lg p-2 sm:p-3 md:p-4 text-center w-24 h-16 sm:w-32 sm:h-20 md:w-36 md:h-24">
                              <div className="text-base sm:text-xl md:text-2xl font-bold text-orange-100">3º</div>
                              <div className="font-bold text-orange-100 mt-1 text-xs sm:text-sm truncate">{contestPokemons[2].name}</div>
                              <div className="text-xs sm:text-sm text-orange-200 mt-0.5">{contestPokemons[2].total} pts</div>
                            </div>
                          )}
                        </div>

                        {/* Ranking completo */}
                        <div className="space-y-2">
                          {contestPokemons.map((pokemon, idx) => (
                            <div key={pokemon.id} className={`flex justify-between items-center p-2 sm:p-3 rounded ${darkMode ? 'bg-gray-600' : 'bg-white'} border ${darkMode ? 'border-gray-500' : 'border-gray-300'}`}>
                              <div className="flex items-center gap-2 sm:gap-3 flex-1 min-w-0">
                                {idx === 0 && <span className="w-4 h-4 sm:w-5 sm:h-5 rounded-full bg-gradient-to-br from-yellow-400 to-yellow-600 flex-shrink-0"></span>}
                                {idx === 1 && <span className="w-4 h-4 sm:w-5 sm:h-5 rounded-full bg-gradient-to-br from-gray-300 to-gray-400 flex-shrink-0"></span>}
                                {idx === 2 && <span className="w-4 h-4 sm:w-5 sm:h-5 rounded-full bg-gradient-to-br from-orange-600 to-orange-800 flex-shrink-0"></span>}
                                <span className={`font-bold text-sm sm:text-base ${darkMode ? 'text-white' : 'text-gray-800'} flex-shrink-0`}>{idx + 1}º</span>
                                <span className={`text-sm sm:text-base truncate ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>{pokemon.name}</span>
                              </div>
                              <span className={`font-bold text-sm sm:text-base flex-shrink-0 ml-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>{pokemon.total} <span className="hidden xs:inline">pontos</span><span className="xs:hidden">pts</span></span>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                )}
              </div>
            )}
          </div>
        </div>
        {accountDataModal}
        {scenarioPopupOverlay}
        {mostrarTriunfosOverlay}
        {pokezapPanel}{pokeAgendaPanel}
        {batalhaChatPanel}
      </>
    )
  }

  // ÁREA DO TREINADOR
  if (currentUser.type === 'treinador' && currentArea === 'Treinador') {
    const maxHP = getMaxHP()
    const displacement = getDisplacement()
    const evasion = getEvasion()
    const hpPercent = maxHP > 0 ? (currentHP / maxHP) * 100 : 0

    const capturedCount = pokedex.filter(p => p.isCaptured).length
    const scannedCount = pokedex.length

    return (
      <>
        <div className={`min-h-screen ${mainBgClass}`}>
          {sidebarNav}
        <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-lg`}>
          <div className="max-w-7xl mx-auto px-4 py-4">
            <div className="flex justify-between items-center mb-4">
              <div className="flex items-center gap-3"><button onClick={() => setSidebarOpen(true)} className={`p-2 rounded-lg ${darkMode ? "hover:bg-gray-700 text-gray-400" : "hover:bg-gray-200 text-gray-500"}`}><Menu size={24} /></button><h2 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{currentUser.username}</h2></div>
              <div className="flex gap-2 items-center">
                <button onClick={() => setShowAccountDataModal(true)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-200 text-gray-700'}`} title="Dados da Conta"><ArrowDownUp size={20} /></button>
                <button onClick={() => setDarkMode(!darkMode)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-yellow-400' : 'bg-gray-200 text-gray-700'}`}>{darkMode ? <Sun size={20} /> : <Moon size={20} />}</button>
                {pokezapBtn}{pokeAgendaBtn}{batalhaChatBtn}<button onClick={handleLogout} className="bg-red-500 text-white px-3 sm:px-5 md:px-6 py-2 rounded-lg hover:bg-red-600">Sair</button>
                {currentClima && <div className="flex items-center gap-1.5 ml-1"><img src={`/pokeballs/${currentClima.image}`} alt={currentClima.name} className="w-7 h-7" /><span className={`text-xs font-semibold ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>{currentClima.name}</span></div>}
              </div>
            </div>
          </div>
        </div>

        <div className="max-w-7xl mx-auto px-4 py-3 sm:py-5 md:py-8">
          <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-8`}>
            
            {/* CABEÇALHO COM IMAGEM E INFO */}
            <div className="flex flex-col sm:flex-row items-start gap-3 sm:gap-4 sm:p-5 md:p-6 mb-8">
              <div className="relative flex-shrink-0 mx-auto sm:mx-0">
                {image ? <img src={image} alt="T" className="w-24 h-24 sm:w-28 sm:h-28 md:w-32 md:h-32 object-cover rounded-lg border-4 border-blue-500" /> : <div className="w-24 h-24 sm:w-28 sm:h-28 md:w-32 md:h-32 bg-gray-300 rounded-lg flex items-center justify-center border-4 border-gray-400"><Camera size={48} className="text-gray-500" /></div>}
                <button onClick={() => setShowTrainerImageModal(true)} className="absolute -bottom-2 -right-2 bg-blue-500 text-white p-2 rounded-full shadow-lg hover:bg-blue-600"><Camera size={20} /></button>
                {/* TIPOS DO ELEMENTALISTA - embaixo da imagem */}
                {classes.includes('Elementalista') && elementalistaTypes.length > 0 && (
                  <div className="mt-4 flex flex-wrap gap-1.5 justify-center max-w-[8rem]">
                    {elementalistaTypes.map((type, idx) => (
                      <span
                        key={idx}
                        className={`px-3 py-1 rounded-md text-xs font-bold text-white shadow-md ${TYPE_STYLES[type] || 'bg-gray-400'}`}
                        style={{ clipPath: 'polygon(0 0, 90% 0, 100% 50%, 90% 100%, 0 100%)' }}
                      >
                        {type}
                      </span>
                    ))}
                  </div>
                )}
              </div>
              <div className="flex-1">
                <h3 className={`text-2xl sm:text-3xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'} mb-4`}>{currentUser.username}</h3>
                <div className="flex flex-wrap items-center gap-2 mb-4">
                  <span className={`text-base sm:text-lg font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Nível: {level}</span>
                  <button onClick={() => setLevel(Math.max(0, Math.min(50, level - 1)))} className="p-1 bg-red-500 text-white rounded hover:bg-red-600"><Minus size={16} /></button>
                  <button onClick={() => { setTempLevel(level.toString()); setShowLevelModal(true) }} className="px-2 py-1 sm:px-3 bg-blue-500 text-white rounded hover:bg-blue-600 text-xs sm:text-sm font-semibold">Lvl</button>
                  <button onClick={() => setLevel(Math.max(0, Math.min(50, level + 1)))} className="p-1 bg-green-500 text-white rounded hover:bg-green-600"><Plus size={16} /></button>
                </div>
                <div className="mb-4">
                  <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2 mb-2">
                    <span className={`text-sm font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>HP: {currentHP}/{maxHP}</span>
                    <div className="flex flex-wrap gap-2">
                      <button onClick={() => sendTrainerToBattle()} className="flex items-center gap-1 px-2 py-1 sm:px-3 bg-cyan-500 text-white rounded hover:bg-cyan-600 text-xs sm:text-sm" title="Adicionar a Batalha Treinador"><PlusCircle size={14} /></button>
                      <button onClick={() => setShowHPModal(true)} className="flex items-center gap-1 px-2 py-1 sm:px-3 bg-purple-500 text-white rounded hover:bg-purple-600 text-xs sm:text-sm"><Sword size={14} /><Heart size={14} /><span className="hidden xs:inline">Dano/Cura</span><span className="xs:hidden">HP</span></button>
                    </div>
                  </div>
                  <div className="w-full bg-gray-300 rounded-full h-6">
                    <div className={`h-6 rounded-full transition-all ${currentHP < 0 ? 'bg-red-700' : 'bg-green-500'}`} style={{ width: `${Math.min(100, Math.max(0, hpPercent))}%` }}></div>
                  </div>
                </div>
                <div className="grid grid-cols-2 sm:flex gap-2 sm:gap-3 md:gap-4">
                  <div className="bg-blue-100 px-2 py-2 sm:px-3 md:px-4 rounded-lg text-center"><div className="text-xs text-blue-600">Capturados</div><div className="text-base sm:text-lg font-bold text-blue-800">{capturedCount}</div></div>
                  <div className="bg-yellow-100 px-2 py-2 sm:px-3 md:px-4 rounded-lg text-center"><div className="text-xs text-yellow-600">Pokédex</div><div className="text-base sm:text-lg font-bold text-yellow-800">{scannedCount}</div></div>
                  <div className="bg-green-100 px-2 py-2 sm:px-3 md:px-4 rounded-lg text-center"><div className="text-xs text-green-600">PC</div><div className="text-base sm:text-lg font-bold text-green-800">{pcPokemon.length}/1000</div></div>
                  {classes.includes('Colecionador') && (
                    <div className="bg-orange-100 px-2 py-2 sm:px-3 md:px-4 rounded-lg text-center" title="MV + Grupos de 8 (Shiny=8pts, Lendário=8pts, Normal=1pt)">
                      <div className="text-xs text-orange-600">Contagem</div>
                      <div className="text-base sm:text-lg font-bold text-orange-800">{calcularContagem()}</div>
                    </div>
                  )}
                </div>
              </div>
            </div>

            {/* CLASSES */}
            <div className="mb-8">
              <h4 className={`text-lg sm:text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'} mb-4`}>Classes & Subclasses</h4>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-2 sm:gap-3 md:gap-4">
                {classes.map((cls, idx) => {
                  const ci = allClasses.find(c => c.name === cls)
                  return <div key={idx} className="relative">
                    <button onClick={() => { setCurrentSlot(idx); setShowClassModal(true) }} className="w-full p-4 rounded-lg border-2 hover:shadow-lg transition-all text-center font-semibold" style={{ backgroundColor: cls ? ci?.color + '40' : darkMode ? '#374151' : '#f3f4f6', color: cls ? ci?.color : darkMode ? '#9ca3af' : '#6b7280', borderColor: cls ? ci?.color : darkMode ? '#4b5563' : '#d1d5db' }}>{cls || 'Classe & Subclasse'}</button>
                    {cls && (
                      <button
                        onClick={(e) => {
                          e.stopPropagation()
                          const newClasses = [...classes]
                          newClasses[idx] = ''
                          setClasses(newClasses)
                        }}
                        className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 hover:bg-red-600 shadow-lg transition-colors"
                        title="Remover classe"
                      >
                        <X size={16} />
                      </button>
                    )}
                  </div>
                })}
              </div>
            </div>

            {/* ESTILIZADOR - para Rangers e Policiais */}
            {(classes.includes('Ranger') || classes.includes('Policial')) && (
              <div className="mb-8">
                {/* ESTILIZADOR POLICIAL - apenas para Policiais */}
                {classes.includes('Policial') ? (
                  <>
                    <h4 className={`text-lg sm:text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'} mb-4 text-center`}>Estilizador Policial</h4>
                    <div className={`p-3 sm:p-5 md:p-6 rounded-lg border-2 ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'}`}>
                      <div className="flex items-center justify-center gap-3 sm:p-5 md:p-6">
                        {/* Catador - à esquerda da Pedra do Trovão se Ladrão estiver selecionado */}
                        {classes.includes('Ladrão') && (
                          <div className="flex-shrink-0">
                            <img
                              src="/catador.png"
                              alt="Catador"
                              className="w-16 h-16 sm:w-18 sm:h-18 md:w-20 md:h-20 object-contain"
                              onError={(e) => {
                                e.target.style.display = 'none'
                              }}
                            />
                          </div>
                        )}

                        {/* Pedra do Trovão - esquerda */}
                        <div className="flex-shrink-0">
                          <button
                            onClick={() => {
                              if (!thunderStoneActive) {
                                setThunderStoneActive(true)
                                setEstilizadorPolicialBattery(40)
                              } else {
                                setThunderStoneActive(false)
                                setEstilizadorPolicialBattery(prev => Math.min(prev, 30))
                              }
                            }}
                            className="transition-all cursor-pointer"
                            title={thunderStoneActive ? "Clique para desativar a Pedra do Trovão" : "Clique para ativar a Pedra do Trovão (+10 bateria)"}
                          >
                            <img
                              src="/pedra-trovao.png"
                              alt="Pedra do Trovão"
                              className="w-16 h-16 object-contain"
                              style={{
                                filter: thunderStoneActive ? 'none' : 'grayscale(100%)',
                                opacity: thunderStoneActive ? 1 : 0.6,
                                cursor: 'pointer'
                              }}
                              onError={(e) => {
                                e.target.style.display = 'none'
                              }}
                            />
                          </button>
                        </div>

                        {/* Imagem do Estilizador Policial */}
                        <div className="flex-shrink-0">
                          <img
                            src="/estilizador-policial.png"
                            alt="Estilizador Policial"
                            className="w-24 h-24 object-contain"
                            onError={(e) => {
                              e.target.style.display = 'none'
                            }}
                          />
                        </div>

                        {/* Bateria - 3 linhas de 10 colunas (ou 4 se Thunder Stone ativa) */}
                        <div className="flex flex-col items-center">
                          <div className={`text-sm font-semibold mb-3 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                            Bateria: {estilizadorPolicialBattery}/{thunderStoneActive ? 40 : 30}
                          </div>
                          <div className="flex flex-col gap-1.5">
                            {/* Linhas 1-3 (ou 1-4 com Thunder Stone) */}
                            {[...Array(thunderStoneActive ? 4 : 3)].map((_, lineIdx) => (
                              <div key={lineIdx} className="flex gap-1.5">
                                {[...Array(10)].map((_, colIdx) => {
                                  // Calcular índice da bateria: linha 0 col 0 = bateria 1, linha 0 col 9 = bateria 10
                                  // linha 1 col 0 = bateria 11, etc
                                  const batteryIdx = lineIdx * 10 + colIdx + 1
                                  const maxBattery = thunderStoneActive ? 40 : 30
                                  const isActive = estilizadorPolicialBattery >= batteryIdx

                                  // Gradiente: vermelho (0) no início, verde (120) no final
                                  const hue = ((batteryIdx - 1) / (maxBattery - 1)) * 120
                                  const backgroundColor = isActive
                                    ? `hsl(${hue}, 80%, 50%)`
                                    : darkMode ? '#374151' : '#e5e7eb'

                                  return (
                                    <div
                                      key={colIdx}
                                      className="w-8 h-8 rounded border-2"
                                      style={{
                                        backgroundColor,
                                        borderColor: isActive ? `hsl(${hue}, 80%, 40%)` : darkMode ? '#4b5563' : '#d1d5db'
                                      }}
                                    />
                                  )
                                })}
                              </div>
                            ))}
                          </div>
                        </div>

                        {/* Controles */}
                        <div className="flex gap-2 sm:gap-3 md:gap-4">
                          <button
                            onClick={() => setEstilizadorPolicialBattery(Math.max(0, estilizadorPolicialBattery - 1))}
                            className={`p-3 rounded-lg ${darkMode ? 'bg-red-600 hover:bg-red-700' : 'bg-red-500 hover:bg-red-600'} text-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed`}
                            disabled={estilizadorPolicialBattery === 0}
                            title="Usar Estilizador Policial (-1 bateria)"
                          >
                            <LifeBuoy size={28} />
                          </button>
                          <button
                            onClick={() => setEstilizadorPolicialBattery(thunderStoneActive ? 40 : 30)}
                            className={`p-3 rounded-lg ${darkMode ? 'bg-green-600 hover:bg-green-700' : 'bg-green-500 hover:bg-green-600'} text-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed`}
                            disabled={estilizadorPolicialBattery === (thunderStoneActive ? 40 : 30)}
                            title="Recarregar Estilizador Policial"
                          >
                            <BatteryCharging size={28} />
                          </button>
                        </div>
                      </div>
                    </div>
                  </>
                ) : (
                  /* ESTILIZADOR - apenas para Rangers */
                  <>
                    <h4 className={`text-lg sm:text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'} mb-4 text-center`}>Estilizador</h4>
                    <div className={`p-3 sm:p-5 md:p-6 rounded-lg border-2 ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'}`}>
                      <div className="flex items-center justify-center gap-2 sm:gap-3 md:gap-3 sm:p-5 md:p-8">
                        {/* Catador - à esquerda do Estilizador se Ladrão estiver selecionado */}
                        {classes.includes('Ladrão') && (
                          <div className="flex-shrink-0">
                            <img
                              src="/catador.png"
                              alt="Catador"
                              className="w-16 h-16 sm:w-18 sm:h-18 md:w-20 md:h-20 object-contain"
                              onError={(e) => {
                                e.target.style.display = 'none'
                              }}
                            />
                          </div>
                        )}

                        {/* Imagem do Estilizador */}
                        <div className="flex-shrink-0">
                          <img
                            src="/estilizador.png"
                            alt="Estilizador"
                            className="w-24 h-24 object-contain"
                            onError={(e) => {
                              e.target.style.display = 'none'
                            }}
                          />
                        </div>

                        {/* Bateria */}
                        <div className="flex flex-col items-center">
                          <div className={`text-sm font-semibold mb-3 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                            Bateria: {estilizadorBattery}/10
                          </div>
                          <div className="flex gap-1.5">
                            {[...Array(10)].map((_, idx) => {
                              const isActive = idx < estilizadorBattery
                              // Gradiente de vermelho (0) para verde (9)
                              const hue = (idx / 9) * 120 // 0 = vermelho, 120 = verde
                              const backgroundColor = isActive
                                ? `hsl(${hue}, 80%, 50%)`
                                : darkMode ? '#374151' : '#e5e7eb'

                              return (
                                <div
                                  key={idx}
                                  className="w-10 h-10 rounded border-2"
                                  style={{
                                    backgroundColor,
                                    borderColor: isActive ? `hsl(${hue}, 80%, 40%)` : darkMode ? '#4b5563' : '#d1d5db'
                                  }}
                                />
                              )
                            })}
                          </div>
                        </div>

                        {/* Controles */}
                        <div className="flex gap-2 sm:gap-3 md:gap-4">
                          <button
                            onClick={() => setEstilizadorBattery(Math.max(0, estilizadorBattery - 1))}
                            className={`p-3 rounded-lg ${darkMode ? 'bg-red-600 hover:bg-red-700' : 'bg-red-500 hover:bg-red-600'} text-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed`}
                            disabled={estilizadorBattery === 0}
                            title="Usar Estilizador (-1 bateria)"
                          >
                            <LifeBuoy size={28} />
                          </button>
                          <button
                            onClick={() => setEstilizadorBattery(10)}
                            className={`p-3 rounded-lg ${darkMode ? 'bg-green-600 hover:bg-green-700' : 'bg-green-500 hover:bg-green-600'} text-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed`}
                            disabled={estilizadorBattery === 10}
                            title="Recarregar Estilizador"
                          >
                            <BatteryCharging size={28} />
                          </button>
                        </div>
                      </div>
                    </div>
                  </>
                )}
              </div>
            )}

            {/* CATADOR - para Ladrão sem Ranger ou Policial */}
            {classes.includes('Ladrão') && !classes.includes('Ranger') && !classes.includes('Policial') && (
              <div className="mb-8">
                <h4 className={`text-lg sm:text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'} mb-4 text-center`}>Catador</h4>
                <div className={`p-3 sm:p-5 md:p-6 rounded-lg border-2 ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'}`}>
                  <div className="flex items-center justify-center">
                    <div className="flex-shrink-0">
                      <img
                        src="/catador.png"
                        alt="Catador"
                        className="w-24 h-24 object-contain"
                        onError={(e) => {
                          e.target.style.display = 'none'
                        }}
                      />
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* TABELA DE ATRIBUTOS */}
            <div className="mb-8">
              <h4 className={`text-lg sm:text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'} mb-4`}>Atributos</h4>
              <div className="overflow-x-auto">
                <table className={`w-full border-collapse ${darkMode ? 'bg-gray-700' : 'bg-white'}`}>
                  <thead><tr className={darkMode ? 'bg-gray-600' : 'bg-gray-200'}>
                    <th className={`border p-2 ${darkMode ? 'border-gray-500 text-white' : 'border-gray-300'}`}>Atributo</th>
                    <th className={`border p-2 ${darkMode ? 'border-gray-500 text-white' : 'border-gray-300'}`}>
                      Valor ({attributes.saude + attributes.ataque + attributes.defesa + attributes.ataqueEspecial + attributes.defesaEspecial + attributes.velocidade}/{(() => {
                        const progressionData = LEVEL_PROGRESSION.find(p => p.nivel === level)
                        return progressionData ? progressionData.totalAtributo : 66
                      })()})
                    </th>
                    <th className={`border p-2 ${darkMode ? 'border-gray-500 text-white' : 'border-gray-300'}`}>Modificador</th>
                    <th className={`border p-2 ${darkMode ? 'border-gray-500 text-white' : 'border-gray-300'}`}>Perícias</th>
                  </tr></thead>
                  <tbody>
                    {['saude', 'ataque', 'defesa', 'ataqueEspecial', 'defesaEspecial', 'velocidade'].map((key) => {
                      const value = attributes[key]
                      const mod = getModifier(value)
                      const names = { saude: 'Saúde', ataque: 'Ataque', defesa: 'Defesa', ataqueEspecial: 'Ataque Especial', defesaEspecial: 'Defesa Especial', velocidade: 'Velocidade' }
                      return <tr key={key}>
                        <td className={`border p-2 font-semibold ${darkMode ? 'border-gray-500 text-white' : 'border-gray-300'}`}>{names[key]}</td>
                        <td className={`border p-2 text-center ${darkMode ? 'border-gray-500' : 'border-gray-300'}`}>
                          <input type="number" min="1" max="40" value={value} onChange={e => setAttributes({ ...attributes, [key]: Math.max(1, Math.min(40, parseInt(e.target.value) || 1)) })} className={`w-20 px-2 py-1 text-center border rounded ${darkMode ? 'bg-gray-600 text-white border-gray-500' : 'border-gray-300'}`} style={{ textAlign: 'center' }} />
                        </td>
                        <td className={`border p-2 text-center font-bold ${darkMode ? 'border-gray-500 text-white' : 'border-gray-300'}`}>{mod >= 0 ? '+' : ''}{mod}</td>
                        <td className={`border p-2 ${darkMode ? 'border-gray-500' : 'border-gray-300'}`}>
                          <div className="flex flex-wrap gap-1">
                            {skillsByAttribute[key].map(skill => {
                              const cnt = getSkillCount(key, skill)
                              return <button key={skill} onClick={() => toggleSkill(key, skill)} className={`px-2 py-1 text-xs rounded ${cnt > 0 ? 'bg-blue-500 text-white' : darkMode ? 'bg-gray-600 text-gray-300' : 'bg-gray-200 text-gray-700'}`}>{skill} {cnt === 2 && 'x2'}</button>
                            })}
                          </div>
                        </td>
                      </tr>
                    })}
                  </tbody>
                </table>
              </div>
            </div>

            {/* DESLOCAMENTOS E EVASÃO */}
            <div className="grid md:grid-cols-2 gap-2 sm:gap-3 md:gap-3 sm:p-5 md:p-8 mb-8">
              <div>
                <h4 className={`text-lg sm:text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'} mb-4`}>Deslocamentos</h4>
                <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                  <div className="mb-2"><span className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Terrestre:</span> <span className={darkMode ? 'text-gray-300' : 'text-gray-700'}>{displacement.terrestre}</span></div>
                  <div className="mb-2"><span className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Natação:</span> <span className={darkMode ? 'text-gray-300' : 'text-gray-700'}>{displacement.natacao}</span></div>
                  <div><span className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Subaquático:</span> <span className={darkMode ? 'text-gray-300' : 'text-gray-700'}>{displacement.subaquatico}</span></div>
                </div>
              </div>
              <div>
                <h4 className={`text-lg sm:text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'} mb-4`}>Evasão</h4>
                <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                  <div className="mb-2"><span className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Física:</span> <span className={darkMode ? 'text-gray-300' : 'text-gray-700'}>{evasion.fisica}</span></div>
                  <div className="mb-2"><span className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Especial:</span> <span className={darkMode ? 'text-gray-300' : 'text-gray-700'}>{evasion.especial}</span></div>
                  <div><span className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Veloz:</span> <span className={darkMode ? 'text-gray-300' : 'text-gray-700'}>{evasion.veloz}</span></div>
                </div>
              </div>
            </div>

            {/* TIME PRINCIPAL - COLUNA ÚNICA */}
            <div className="mb-8">
              <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-4">
                <h4 className={`text-lg sm:text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Time Principal ({mainTeam.length}/6)</h4>
                <div className="flex flex-wrap gap-2 w-full sm:w-auto">
                  <button onClick={healAllPokemon} className="flex items-center gap-1 sm:gap-2 px-2 py-1.5 sm:px-3 sm:py-2 md:px-4 bg-red-500 text-white rounded-lg font-semibold hover:bg-red-600 shadow-lg text-xs sm:text-sm md:text-base" title="Curar todos os Pokémon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className="sm:w-5 sm:h-5">
                      <path d="M12 2v20M2 12h20"/>
                    </svg>
                    <span className="hidden xs:inline">EstagiAyla Joy</span>
                    <span className="xs:hidden">Curar</span>
                  </button>
                  <button onClick={() => setShowAddPokemonModal(true)} className="flex items-center gap-1 sm:gap-2 px-2 py-1.5 sm:px-3 sm:py-2 md:px-4 bg-white rounded-lg font-semibold hover:opacity-90 shadow-lg border-2 border-gray-300 text-xs sm:text-sm md:text-base">
                    <img src="/pokeball-icon.png" alt="Pokébola" className="w-4 h-4 sm:w-5 sm:h-5 md:w-6 md:h-6" />
                    <span className="text-gray-800">Adicionar Pkm</span>
                  </button>
                </div>
              </div>
              <div className="space-y-4">
                {[...Array(6)].map((_, idx) => {
                  const pokemon = mainTeam[idx]
                  return (
                    <div
                      key={idx}
                      draggable={!!pokemon}
                      onDragStart={(e) => {
                        if (!pokemon) return
                        setDragPokemonIndex(idx)
                        e.dataTransfer.effectAllowed = 'move'
                      }}
                      onDragOver={(e) => {
                        e.preventDefault()
                        if (dragPokemonIndex !== null && idx !== dragPokemonIndex && idx < mainTeam.length) {
                          setDragOverPokemonIndex(idx)
                        }
                      }}
                      onDragLeave={() => {
                        setDragOverPokemonIndex(null)
                      }}
                      onDrop={(e) => {
                        e.preventDefault()
                        if (dragPokemonIndex !== null && idx !== dragPokemonIndex && idx < mainTeam.length) {
                          const newTeam = [...mainTeam]
                          const [dragged] = newTeam.splice(dragPokemonIndex, 1)
                          newTeam.splice(idx, 0, dragged)
                          setMainTeam(newTeam)
                        }
                        setDragPokemonIndex(null)
                        setDragOverPokemonIndex(null)
                      }}
                      onDragEnd={() => {
                        setDragPokemonIndex(null)
                        setDragOverPokemonIndex(null)
                      }}
                      className={`p-2 sm:p-3 md:p-4 rounded-lg border-2 transition-all ${
                        dragOverPokemonIndex === idx ? 'border-purple-500 border-dashed bg-purple-100 bg-opacity-20 scale-[1.02]' :
                        dragPokemonIndex === idx ? 'opacity-50' :
                        pokemon ? (pokemon.shiny || pokemon.legendary) ? (pokemon.shiny ? 'border-yellow-500' : 'border-orange-500') : darkMode ? 'bg-gray-700 border-blue-500' : 'bg-blue-50 border-blue-300' : darkMode ? 'bg-gray-700 border-gray-600' : 'bg-gray-100 border-gray-300'
                      } ${pokemon ? 'cursor-grab active:cursor-grabbing' : ''}`}
                      style={
                        pokemon?.shiny && pokemon?.legendary ? {
                          backgroundImage: 'url("/efeitolenda.gif"), url("/efeito shiny.gif")',
                          backgroundSize: 'cover, cover',
                          backgroundPosition: 'center, center',
                          backgroundRepeat: 'no-repeat, no-repeat'
                        } :
                        pokemon?.legendary ? {
                          backgroundImage: 'url("/efeitolenda.gif")',
                          backgroundSize: 'cover',
                          backgroundPosition: 'center',
                          backgroundRepeat: 'no-repeat'
                        } :
                        pokemon?.shiny ? {
                          backgroundImage: 'linear-gradient(135deg, rgba(255, 215, 0, 0.1) 0%, rgba(255, 215, 0, 0.2) 100%), url("/efeito shiny.gif")',
                          backgroundSize: 'cover',
                          backgroundPosition: 'center',
                          backgroundRepeat: 'no-repeat'
                        } : {}
                      }
                    >
                      {pokemon ? (
                        <div>
                          {/* Botões no canto direito superior */}
                          <div className="grid grid-cols-4 sm:grid-cols-6 md:flex md:justify-end gap-1 sm:gap-1.5 md:gap-2 mb-3 sm:mb-4">
                            <button onClick={() => openImageModal(pokemon)} className="bg-gray-500 text-white p-1.5 sm:p-2 rounded hover:bg-gray-600" title="Adicionar Imagem">
                              <Camera size={16} className="sm:w-[18px] sm:h-[18px]" />
                            </button>
                            <button onClick={() => openTempHPModal(pokemon, idx)} className="bg-blue-500 text-white p-1.5 sm:p-2 rounded hover:bg-blue-600" title="HP Temporário Pkm">
                              <ShieldPlus size={16} className="sm:w-[18px] sm:h-[18px]" />
                            </button>
                            <button
                              onClick={() => {
                                setNameRaterIndex(idx)
                                setNameRaterNickname(pokemon.nickname)
                                setShowNameRaterModal(true)
                              }}
                              className="bg-orange-500 text-white p-1.5 sm:p-2 rounded hover:bg-orange-600"
                              title="Name Rater"
                            >
                              <Edit size={16} className="sm:w-[18px] sm:h-[18px]" />
                            </button>
                            <button onClick={() => handleOpenTutoria(pokemon, 'team')} className="bg-indigo-500 text-white p-1.5 sm:p-2 rounded hover:bg-indigo-600" title="Tutoria de Golpes">
                              <BookOpenText size={16} className="sm:w-[18px] sm:h-[18px]" />
                            </button>
                            <button onClick={() => handleOpenHabilidades(pokemon, 'team')} className="bg-teal-500 text-white p-1.5 sm:p-2 rounded hover:bg-teal-600" title="Habilidades">
                              <BookA size={16} className="sm:w-[18px] sm:h-[18px]" />
                            </button>
                            <button
                              onClick={() => handleOpenPokeballModal(pokemon, 'team')}
                              className="bg-purple-500 text-white p-1.5 sm:p-2 rounded hover:bg-purple-600 animate-pulse"
                              title="Pokébola de Captura"
                              style={{
                                animation: 'colorCycle 3s linear infinite'
                              }}
                            >
                              <CircleDot size={16} className="sm:w-[18px] sm:h-[18px]" />
                            </button>
                            <button
                              onClick={() => handleOpenHeldItemModal(pokemon, 'team')}
                              className="bg-gray-400 text-white p-1.5 sm:p-2 rounded hover:bg-gray-500"
                              title="Held Item"
                            >
                              <Webhook size={16} className="sm:w-[18px] sm:h-[18px]" />
                            </button>
                            <button onClick={() => openEvolutionModal(pokemon, 'team', idx)} className="bg-emerald-500 text-white px-1.5 py-1.5 sm:px-2 sm:py-2 md:px-3 md:py-2 rounded hover:bg-emerald-600 text-xs sm:text-sm font-semibold flex items-center gap-0.5 sm:gap-1" title="Evoluir Pokémon">
                              <Sparkles size={14} className="sm:w-4 sm:h-4" /> <span className="hidden sm:inline">Evo</span>
                            </button>
                            <button onClick={() => openEditPokemonModal(pokemon, 'team', idx)} className="bg-blue-500 text-white px-1.5 py-1.5 sm:px-2 sm:py-2 md:px-3 md:py-2 rounded hover:bg-blue-600 text-xs sm:text-sm font-semibold" title="Editar Pokémon">
                              <span className="hidden sm:inline">Edição Pkm</span><span className="sm:hidden">Edit</span>
                            </button>
                            <button onClick={() => openPokemonHPModal(pokemon, idx)} className="bg-yellow-500 text-white px-1.5 py-1.5 sm:px-2 sm:py-2 md:px-3 md:py-2 rounded hover:bg-yellow-600 text-xs sm:text-sm font-semibold" title="Dano/Cura">
                              <span className="hidden sm:inline">Dano/Cura</span><span className="sm:hidden">HP</span>
                            </button>
                            <button onClick={() => { setSelectedPokemonIndex(idx); setShowXPModal(true) }} className="bg-green-500 text-white px-1.5 py-1.5 sm:px-2 sm:py-2 md:px-3 md:py-2 lg:px-4 rounded hover:bg-green-600 text-xs sm:text-sm font-semibold">
                              +XP
                            </button>
                            <button onClick={() => openHappinessModal(pokemon, idx)} className="bg-pink-500 text-white p-1.5 sm:p-2 rounded hover:bg-pink-600" title="Felicidade">
                              <Smile size={16} className="sm:w-[18px] sm:h-[18px]" />
                            </button>
                            <button onClick={() => moveToPc(idx)} className="bg-purple-500 text-white px-1.5 py-1.5 sm:px-2 sm:py-2 md:px-3 md:py-2 lg:px-4 rounded hover:bg-purple-600 text-xs sm:text-sm font-semibold" title="Mover para o PC">
                              <span className="hidden sm:inline">⬇️ PC</span><span className="sm:hidden">PC</span>
                            </button>
                            <button onClick={() => openAptidoesModal(pokemon, 'team', idx)} className="bg-indigo-500 text-white p-1.5 sm:p-2 rounded hover:bg-indigo-600" title="Editar Aptidões">
                              <TowerControl size={16} className="sm:w-[18px] sm:h-[18px]" />
                            </button>
                            <button onClick={() => handleDeletePokemon(idx)} className="bg-red-500 text-white p-1.5 sm:p-2 rounded hover:bg-red-600">
                              <Trash2 size={16} className="sm:w-[18px] sm:h-[18px]" />
                            </button>
                          </div>

                          {/* Informações principais e barras */}
                          <div className="flex items-center gap-2 sm:gap-3 md:gap-4 mb-4">
                            <div className="flex flex-col items-center gap-2">
                              <div className={`text-center px-3 py-1 rounded ${darkMode ? 'bg-gray-600' : 'bg-purple-100'}`}>
                                <div className={`text-[10px] whitespace-nowrap ${darkMode ? 'text-purple-300' : 'text-purple-600'}`}>Bônus Ele.</div>
                                <div className={`text-base font-bold ${darkMode ? 'text-white' : 'text-purple-700'}`}>{calculateElementalBonus(pokemon)}</div>
                              </div>
                              {pokemonImages[sanitizeFirebaseKey(pokemon.id)] && (
                                <img src={pokemonImages[sanitizeFirebaseKey(pokemon.id)]} alt={pokemon.nickname} className="w-16 h-16 sm:w-18 sm:h-18 md:w-20 md:h-20 object-cover rounded-lg border-2 border-blue-500" />
                              )}
                              {pokemon.pokeball && (
                                <img
                                  src={pokemon.pokeball === 'Custom Pokeball' && pokemon.customPokeballImage ? pokemon.customPokeballImage : `/pokeballs/${pokemon.pokeball.toLowerCase().replace(/\s+/g, '')}.png`}
                                  alt={pokemon.pokeball}
                                  className="w-10 h-10 object-contain"
                                  title={pokemon.pokeball}
                                />
                              )}
                              <div className={`flex justify-center items-center p-1 rounded-md ${darkMode ? 'bg-gray-700' : 'bg-gray-100'} border ${darkMode ? 'border-gray-600' : 'border-gray-300'}`}>
                                <DietIcons speciesName={pokemon.species} dietOverride={pokemon.dieta} size={27} />
                              </div>
                            </div>
                            <div className="flex-1">
                              {pokemon.isAlpha && (
                                <span
                                  className="inline-block px-2 py-0.5 rounded-md text-xs font-bold text-red-600 mb-1"
                                  style={{ background: 'linear-gradient(135deg, #C0C0C0, #FFFFFF)' }}
                                >
                                  Alpha
                                </span>
                              )}
                              <div className="flex items-center gap-2 sm:gap-3 mb-2 flex-wrap">
                                <span
                                  className={`px-2 py-1 sm:px-3 rounded-lg font-bold text-base sm:text-lg cursor-pointer hover:underline ${pokemon.shiny ? 'bg-yellow-500 text-gray-900 hover:text-blue-900 border-2 border-yellow-700' : darkMode ? 'bg-gray-600 text-white hover:text-blue-400 border-2 border-gray-500' : 'bg-blue-100 text-gray-800 hover:text-blue-600 border-2 border-blue-300'}`}
                                  onClick={() => openPokemonInfoModal(pokemon)}
                                >
                                  {pokemon.nickname}
                                </span>
                                <span className={`px-2 py-1 rounded text-xs font-bold ${pokemon.shiny ? 'bg-blue-700 text-white' : darkMode ? 'bg-blue-600 text-white' : 'bg-blue-200 text-blue-800'}`}>Lv.{pokemon.level}</span>
                                {getPokemonTypes(pokemon).map((tipo, idx) => (
                                  <span
                                    key={idx}
                                    className={`px-3 py-1 rounded-md text-xs font-bold text-white shadow-md ${TYPE_STYLES[tipo] || 'bg-gray-400'} ${classes.includes('Elementalista') ? 'cursor-pointer hover:ring-2 hover:ring-yellow-400 hover:ring-opacity-60' : ''}`}
                                    style={{ clipPath: 'polygon(0 0, 90% 0, 100% 50%, 90% 100%, 0 100%)' }}
                                    onClick={() => {
                                      if (classes.includes('Elementalista')) {
                                        setSelectedPokemonForTypeEdit(pokemon)
                                        setPokemonTypeEditSource('team')
                                        setShowPokemonTypeEditModal(true)
                                      }
                                    }}
                                  >
                                    {tipo}
                                  </span>
                                ))}

                                {/* Tags de Capacidades em grid dinâmico */}
                                {pokemon.capacities && pokemon.capacities.others && pokemon.capacities.others.length > 0 && (() => {
                                  const capacitiesCount = pokemon.capacities.others.filter(cap => cap).length
                                  const gridCols = capacitiesCount === 1 ? 'grid-cols-1' : capacitiesCount === 2 ? 'grid-cols-2' : 'grid-cols-3'
                                  return (
                                    <div className={`px-2 py-1 rounded-lg ${darkMode ? 'bg-gray-600' : 'bg-gray-100'} grid ${gridCols} gap-1 inline-grid`}>
                                      {pokemon.capacities.others.filter(cap => cap).map((capacity, idx) => (
                                        <button
                                          key={idx}
                                          onClick={() => {
                                            setSelectedCapacityForInfo(capacity)
                                            setShowCapacityInfoModal(true)
                                          }}
                                          className={`px-2 py-1 rounded text-xs font-semibold ${darkMode ? 'bg-indigo-600 text-white hover:bg-indigo-500' : 'bg-indigo-200 text-indigo-800 hover:bg-indigo-300'} cursor-pointer transition-colors`}
                                        >
                                          {capacity}
                                        </button>
                                      ))}
                                    </div>
                                  )
                                })()}

                                {/* Caixa de Slots de Habilidades */}
                                <div className={`px-2 py-1 rounded-lg ${darkMode ? 'bg-teal-900 border-2 border-teal-600' : 'bg-teal-50 border-2 border-teal-300'} inline-flex flex-wrap gap-2 items-center`}>
                                  {/* Slot 1 - Nível 1 */}
                                  {pokemon.habilidades && pokemon.habilidades[0] ? (
                                    <button
                                      onClick={() => {
                                        setSelectedHabilidadeForDetail(pokemon.habilidades[0])
                                        setShowHabilidadeDetailModal(true)
                                      }}
                                      className={`px-2 py-1 rounded text-xs font-semibold ${darkMode ? 'bg-teal-600 text-white hover:bg-teal-500' : 'bg-teal-200 text-teal-900 hover:bg-teal-300'} cursor-pointer transition-colors`}
                                    >
                                      {pokemon.habilidades[0]}
                                    </button>
                                  ) : (
                                    <span className={`px-2 py-1 text-xs italic ${darkMode ? 'text-teal-400' : 'text-teal-600'}`}>
                                      Habilidade a partir do nível 1
                                    </span>
                                  )}

                                  {/* Slot 2 - Nível 40 */}
                                  {pokemon.habilidades && pokemon.habilidades[1] ? (
                                    <button
                                      onClick={() => {
                                        setSelectedHabilidadeForDetail(pokemon.habilidades[1])
                                        setShowHabilidadeDetailModal(true)
                                      }}
                                      className={`px-2 py-1 rounded text-xs font-semibold ${darkMode ? 'bg-teal-600 text-white hover:bg-teal-500' : 'bg-teal-200 text-teal-900 hover:bg-teal-300'} cursor-pointer transition-colors`}
                                    >
                                      {pokemon.habilidades[1]}
                                    </button>
                                  ) : (
                                    <span className={`px-2 py-1 text-xs italic ${darkMode ? 'text-teal-400' : 'text-teal-600'}`}>
                                      Habilidade a partir do nível 40
                                    </span>
                                  )}
                                </div>

                                {/* Caixa de Held Item */}
                                <div className={`px-3 py-2 rounded-lg ${darkMode ? 'bg-gray-700 border-2 border-gray-500' : 'bg-gray-100 border-2 border-gray-400'} inline-flex items-center justify-center text-center gap-2`}>
                                  {pokemon.heldItem ? (
                                    <>
                                      <button
                                        onClick={() => handleOpenHeldItemDetail(pokemon.heldItem)}
                                        className={`text-sm font-semibold ${darkMode ? 'text-gray-200 hover:text-white' : 'text-gray-800 hover:text-gray-900'} hover:underline cursor-pointer transition-colors`}
                                      >
                                        {pokemon.heldItem.name}
                                      </button>
                                      <button
                                        onClick={() => handleReturnItemToBackpack(pokemon, false)}
                                        className={`${darkMode ? 'text-blue-400 hover:text-blue-300' : 'text-blue-600 hover:text-blue-700'} transition-colors`}
                                        title="Devolver item para a mochila"
                                      >
                                        <ArrowBigRightDash size={18} />
                                      </button>
                                    </>
                                  ) : (
                                    <span className={`text-xs italic ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                      {getRandomNoItemPhrase()}
                                    </span>
                                  )}
                                </div>
                                {/* Caixa de HP Temporário */}
                                {pokemon.temporaryHP > 0 && (
                                  <div className={`px-3 py-2 rounded-lg ${darkMode ? 'bg-blue-700 border-2 border-blue-500' : 'bg-blue-100 border-2 border-blue-400'} inline-flex items-center justify-center text-center gap-2`}>
                                    <ShieldPlus size={16} className={darkMode ? 'text-blue-200' : 'text-blue-600'} />
                                    <span className={`text-sm font-semibold ${darkMode ? 'text-blue-200' : 'text-blue-800'}`}>
                                      {pokemon.temporaryHP}
                                    </span>
                                  </div>
                                )}
                              </div>
                              <p className={`text-sm mb-2 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>{pokemon.species}</p>

                              {/* Barra de HP */}
                              <div className="mb-1">
                                <div className="flex justify-between items-center mb-1">
                                  <span className={`text-xs font-semibold ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                    HP: {pokemon.currentHP || 0}/{calculateMaxHP(pokemon)}
                                  </span>
                                  <span className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                    {Math.round(((pokemon.currentHP || 0) / calculateMaxHP(pokemon)) * 100)}%
                                  </span>
                                </div>
                                <div className={`w-full rounded-full h-3 overflow-hidden ${darkMode ? 'bg-gray-600' : 'bg-gray-300'}`}>
                                  <div
                                    className={`h-3 rounded-full transition-all duration-500 ${
                                      ((pokemon.currentHP || 0) / calculateMaxHP(pokemon)) > 0.5 ? 'bg-green-500' :
                                      ((pokemon.currentHP || 0) / calculateMaxHP(pokemon)) > 0.2 ? 'bg-yellow-500' :
                                      'bg-red-500'
                                    }`}
                                    style={{ width: `${Math.min(100, ((pokemon.currentHP || 0) / calculateMaxHP(pokemon)) * 100)}%` }}
                                  ></div>
                                </div>
                              </div>

                              {/* Barra de XP */}
                              <div className="mb-1">
                                <div className="flex justify-between items-center mb-1">
                                  <span className={`text-xs font-semibold ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                    XP: {getCurrentLevelXP(pokemon)}/{getXPForNextLevel(pokemon.level)}
                                  </span>
                                  <span className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                    {Math.round(getXPProgress(pokemon))}%
                                  </span>
                                </div>
                                <div className={`w-full rounded-full h-3 overflow-hidden ${darkMode ? 'bg-gray-600' : 'bg-gray-300'}`}>
                                  <div
                                    className="rainbow-xp-bar h-3 rounded-full transition-all duration-500"
                                    style={{ width: `${getXPProgress(pokemon)}%` }}
                                  ></div>
                                </div>
                              </div>

                              {/* Barra de Felicidade */}
                              <div className="mb-1">
                                <div className="flex justify-between items-center mb-1">
                                  <span className={`text-xs font-semibold ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                    Felicidade: {pokemon.currentHappiness || 0}/{calculateMaxHappiness(pokemon)}
                                  </span>
                                  <span className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                    {Math.round(((pokemon.currentHappiness || 0) / calculateMaxHappiness(pokemon)) * 100)}%
                                  </span>
                                </div>
                                <div className={`w-full rounded-full h-3 overflow-hidden ${darkMode ? 'bg-gray-600' : 'bg-gray-300'}`}>
                                  <div
                                    className="h-3 rounded-full transition-all duration-500 bg-gradient-to-r from-pink-400 to-green-400"
                                    style={{ width: `${Math.min(100, ((pokemon.currentHappiness || 0) / calculateMaxHappiness(pokemon)) * 100)}%` }}
                                  ></div>
                                </div>
                              </div>

                              {/* Slots de Golpes */}
                              <div className="mt-4">
                                <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2">
                                  {[...Array(8)].map((_, slotIdx) => {
                                    const golpe = pokemon.golpes && pokemon.golpes[slotIdx]
                                    const golpeNome = golpe?.nome
                                    const golpeTipo = golpeNome && GOLPES_DATA[golpeNome] ? GOLPES_DATA[golpeNome].tipo : null
                                    const golpeColor = golpeTipo ? TYPE_STYLES[golpeTipo] : null
                                    return (
                                      <button
                                        key={slotIdx}
                                        onClick={() => golpeNome && handleOpenGolpeDetail(golpeNome)}
                                        className={`p-2 rounded text-xs font-semibold transition-all truncate ${
                                          golpeNome
                                            ? `${golpeColor || (darkMode ? 'bg-orange-600' : 'bg-orange-500')} text-white hover:opacity-80 cursor-pointer`
                                            : `${darkMode ? 'bg-gray-600 text-gray-400' : 'bg-gray-200 text-gray-500'} cursor-default`
                                        }`}
                                        disabled={!golpeNome}
                                        title={golpeNome || 'Seu pokémon quer aprender...'}
                                      >
                                        {golpeNome || 'Seu pokémon quer aprender...'}
                                      </button>
                                    )
                                  })}
                                </div>
                              </div>
                            </div>
                          </div>

                          {/* Evasões, Deslocamentos, Capacidades e Aptidões */}
                          <div className={`pt-3 border-t-2 ${darkMode ? 'border-gray-600' : 'border-blue-200'}`}>

                            {/* Mobile: botões que abrem pop-ups (< md) */}
                            <div className="flex md:hidden gap-1 mb-0">
                              {[
                                { section: 'evasoes', label: 'Evasões', color: darkMode ? 'bg-blue-700 hover:bg-blue-600' : 'bg-blue-500 hover:bg-blue-600' },
                                { section: 'deslocamentos', label: 'Desl.', color: darkMode ? 'bg-green-700 hover:bg-green-600' : 'bg-green-500 hover:bg-green-600' },
                                { section: 'capacidades', label: 'Capac.', color: darkMode ? 'bg-orange-700 hover:bg-orange-600' : 'bg-orange-500 hover:bg-orange-600' },
                                { section: 'aptidoes', label: 'Aptidões', color: darkMode ? 'bg-gray-600 hover:bg-gray-500' : 'bg-gray-500 hover:bg-gray-600' },
                              ].map(({ section, label, color }) => (
                                <button
                                  key={section}
                                  onClick={() => setOpenPokemonSection({ pokemon, section })}
                                  className={`flex-1 py-1.5 rounded text-white text-xs font-semibold transition-colors ${color}`}
                                >
                                  {label}
                                </button>
                              ))}
                            </div>

                            {/* Desktop: grid completo (md+) */}
                            <div className="hidden md:grid grid-cols-4 gap-2 items-start">

                              {/* ESQUERDA — Evasões */}
                              <div className="flex flex-col items-center">
                                <h6 className={`text-xs font-bold mb-1 ${darkMode ? 'text-blue-300' : 'text-blue-700'}`}>Evasões</h6>
                                <div className="flex gap-1">
                                  <div className={`text-center px-3 py-[14px] rounded ${darkMode ? 'bg-gray-600' : 'bg-blue-100'}`}>
                                    <div className={`text-base whitespace-nowrap ${darkMode ? 'text-gray-300' : 'text-gray-500'}`}>Física</div>
                                    <div className={`text-base font-bold ${darkMode ? 'text-white' : 'text-blue-700'}`}>{calculatePhysicalEvasion(pokemon)}</div>
                                  </div>
                                  <div className={`text-center px-3 py-[14px] rounded ${darkMode ? 'bg-gray-600' : 'bg-blue-100'}`}>
                                    <div className={`text-base whitespace-nowrap ${darkMode ? 'text-gray-300' : 'text-gray-500'}`}>Especial</div>
                                    <div className={`text-base font-bold ${darkMode ? 'text-white' : 'text-blue-700'}`}>{calculateSpecialEvasion(pokemon)}</div>
                                  </div>
                                  <div className={`text-center px-3 py-[14px] rounded ${darkMode ? 'bg-gray-600' : 'bg-blue-100'}`}>
                                    <div className={`text-base whitespace-nowrap ${darkMode ? 'text-gray-300' : 'text-gray-500'}`}>Veloz</div>
                                    <div className={`text-base font-bold ${darkMode ? 'text-white' : 'text-blue-700'}`}>{calculateSpeedEvasion(pokemon)}</div>
                                  </div>
                                </div>
                              </div>

                              {/* CENTRO-ESQUERDA — Deslocamentos */}
                              {(() => {
                                const d = pokemon.displacement || POKEMON_DESLOCAMENTO_MAP[pokemon.species || pokemon.nickname]
                                const LABELS = [
                                  { key: 'terrestre', label: 'Terrestre' },
                                  { key: 'nadar', label: 'Natação' },
                                  { key: 'voar', label: 'Voo' },
                                  { key: 'cavar', label: 'Escavação' },
                                  { key: 'submerso', label: 'Subaquático' },
                                ]
                                const active = d ? LABELS.filter(({ key }) => d[key] !== '' && d[key] != null) : []
                                return (
                                  <div className="flex flex-col items-center">
                                    <h6 className={`text-xs font-bold mb-1 ${darkMode ? 'text-green-300' : 'text-green-700'}`}>Deslocamentos</h6>
                                    {active.length > 0 ? (
                                      <div className="flex gap-1 flex-wrap justify-center">
                                        {active.map(({ key, label }) => (
                                          <div key={key} className={`text-center px-2 py-[14px] rounded ${darkMode ? 'bg-gray-600' : 'bg-green-100'}`}>
                                            <div className={`text-xs whitespace-nowrap ${darkMode ? 'text-gray-300' : 'text-gray-500'}`}>{label}</div>
                                            <div className={`text-base font-bold ${darkMode ? 'text-white' : 'text-green-700'}`}>{d[key]}</div>
                                          </div>
                                        ))}
                                      </div>
                                    ) : (
                                      <div className={`text-xs italic ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>—</div>
                                    )}
                                  </div>
                                )
                              })()}

                              {/* CENTRO-DIREITA — Capacidades */}
                              {(() => {
                                const c = pokemon.capacities || POKEMON_CAPACIDADE_MAP[pokemon.species || pokemon.nickname]
                                const LABELS = [
                                  { key: 'forca', label: 'Força' },
                                  { key: 'inteligencia', label: 'Inteligência' },
                                  { key: 'salto', label: 'Salto' },
                                ]
                                const active = c ? LABELS.filter(({ key }) => c[key] !== '' && c[key] != null) : []
                                return (
                                  <div className="flex flex-col items-center">
                                    <h6 className={`text-xs font-bold mb-1 ${darkMode ? 'text-orange-300' : 'text-orange-700'}`}>Capacidades</h6>
                                    {active.length > 0 ? (
                                      <div className="flex gap-1 flex-wrap justify-center">
                                        {active.map(({ key, label }) => (
                                          <div key={key} className={`text-center px-2 py-[14px] rounded ${darkMode ? 'bg-gray-600' : 'bg-orange-100'}`}>
                                            <div className={`text-xs whitespace-nowrap ${darkMode ? 'text-gray-300' : 'text-gray-500'}`}>{label}</div>
                                            <div className={`text-base font-bold ${darkMode ? 'text-white' : 'text-orange-700'}`}>{c[key]}</div>
                                          </div>
                                        ))}
                                      </div>
                                    ) : (
                                      <div className={`text-xs italic ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>—</div>
                                    )}
                                  </div>
                                )
                              })()}

                              {/* DIREITA — Aptidões */}
                              <div className="flex flex-col items-center">
                                <h6 className={`text-xs font-bold mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>Aptidões</h6>
                                <div className="grid grid-cols-5 gap-1 w-full">
                                  {[
                                    { key: 'estilo', label: 'Estilo', bg: darkMode ? 'bg-red-900' : 'bg-red-100', text: darkMode ? 'text-red-300' : 'text-red-600' },
                                    { key: 'beleza', label: 'Beleza', bg: darkMode ? 'bg-blue-900' : 'bg-blue-100', text: darkMode ? 'text-blue-300' : 'text-blue-600' },
                                    { key: 'ternura', label: 'Ternura', bg: darkMode ? 'bg-pink-900' : 'bg-pink-100', text: darkMode ? 'text-pink-300' : 'text-pink-600' },
                                    { key: 'perspicacia', label: 'Perspicácia', bg: darkMode ? 'bg-green-900' : 'bg-green-100', text: darkMode ? 'text-green-300' : 'text-green-600' },
                                    { key: 'vigor', label: 'Vigor', bg: darkMode ? 'bg-yellow-900' : 'bg-yellow-100', text: darkMode ? 'text-yellow-300' : 'text-yellow-600' }
                                  ].map(apt => (
                                    <div key={apt.key} className={`text-center py-[14px] rounded ${apt.bg}`}>
                                      <div className={`text-xs font-semibold ${apt.text}`} style={{ fontSize: '0.6rem' }}>{apt.label}</div>
                                      <div className={`text-sm font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{pokemon.aptidoes?.[apt.key] ?? 0}</div>
                                    </div>
                                  ))}
                                </div>
                              </div>

                            </div>
                          </div>
                        </div>
                      ) : (
                        <div className={`text-center py-3 sm:py-5 md:py-6 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                          <span className="text-2xl sm:text-3xl">○</span>
                          <p className="text-sm mt-2">Slot {idx + 1}</p>
                        </div>
                      )}
                    </div>
                  )
                })}
              </div>
            </div>
          </div>
        </div>

        {/* Modal de seção do card Pokémon (mobile) */}
        {openPokemonSection && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setOpenPokemonSection(null)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-5 rounded-2xl shadow-2xl w-full max-w-sm`} onClick={e => e.stopPropagation()}>
              <div className="flex justify-between items-center mb-4">
                <h3 className={`text-lg font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  {openPokemonSection.section === 'evasoes' && 'Evasões'}
                  {openPokemonSection.section === 'deslocamentos' && 'Deslocamentos'}
                  {openPokemonSection.section === 'capacidades' && 'Capacidades'}
                  {openPokemonSection.section === 'aptidoes' && 'Aptidões'}
                </h3>
                <button onClick={() => setOpenPokemonSection(null)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                  <X size={24} />
                </button>
              </div>

              {/* Evasões */}
              {openPokemonSection.section === 'evasoes' && (
                <div className="flex gap-3 justify-center">
                  {[
                    { label: 'Física', value: calculatePhysicalEvasion(openPokemonSection.pokemon) },
                    { label: 'Especial', value: calculateSpecialEvasion(openPokemonSection.pokemon) },
                    { label: 'Veloz', value: calculateSpeedEvasion(openPokemonSection.pokemon) },
                  ].map(({ label, value }) => (
                    <div key={label} className={`flex-1 text-center py-4 rounded ${darkMode ? 'bg-gray-600' : 'bg-blue-100'}`}>
                      <div className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-500'}`}>{label}</div>
                      <div className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-blue-700'}`}>{value}</div>
                    </div>
                  ))}
                </div>
              )}

              {/* Deslocamentos */}
              {openPokemonSection.section === 'deslocamentos' && (() => {
                const d = openPokemonSection.pokemon.displacement || POKEMON_DESLOCAMENTO_MAP[openPokemonSection.pokemon.species || openPokemonSection.pokemon.nickname]
                const LABELS = [
                  { key: 'terrestre', label: 'Terrestre' },
                  { key: 'nadar', label: 'Natação' },
                  { key: 'voar', label: 'Voo' },
                  { key: 'cavar', label: 'Escavação' },
                  { key: 'submerso', label: 'Subaquático' },
                ]
                const active = d ? LABELS.filter(({ key }) => d[key] !== '' && d[key] != null) : []
                return active.length > 0 ? (
                  <div className="flex gap-2 flex-wrap justify-center">
                    {active.map(({ key, label }) => (
                      <div key={key} className={`text-center px-4 py-4 rounded ${darkMode ? 'bg-gray-600' : 'bg-green-100'}`}>
                        <div className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-500'}`}>{label}</div>
                        <div className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-green-700'}`}>{d[key]}</div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className={`text-center italic ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>Sem deslocamentos mapeados</div>
                )
              })()}

              {/* Capacidades */}
              {openPokemonSection.section === 'capacidades' && (() => {
                const c = openPokemonSection.pokemon.capacities || POKEMON_CAPACIDADE_MAP[openPokemonSection.pokemon.species || openPokemonSection.pokemon.nickname]
                const LABELS = [
                  { key: 'forca', label: 'Força' },
                  { key: 'inteligencia', label: 'Inteligência' },
                  { key: 'salto', label: 'Salto' },
                ]
                const active = c ? LABELS.filter(({ key }) => c[key] !== '' && c[key] != null) : []
                return active.length > 0 ? (
                  <div className="flex gap-2 flex-wrap justify-center">
                    {active.map(({ key, label }) => (
                      <div key={key} className={`text-center px-4 py-4 rounded ${darkMode ? 'bg-gray-600' : 'bg-orange-100'}`}>
                        <div className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-500'}`}>{label}</div>
                        <div className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-orange-700'}`}>{c[key]}</div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className={`text-center italic ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>Sem capacidades mapeadas</div>
                )
              })()}

              {/* Aptidões */}
              {openPokemonSection.section === 'aptidoes' && (
                <div className="grid grid-cols-5 gap-2">
                  {[
                    { key: 'estilo', label: 'Estilo', bg: darkMode ? 'bg-red-900' : 'bg-red-100', text: darkMode ? 'text-red-300' : 'text-red-600' },
                    { key: 'beleza', label: 'Beleza', bg: darkMode ? 'bg-blue-900' : 'bg-blue-100', text: darkMode ? 'text-blue-300' : 'text-blue-600' },
                    { key: 'ternura', label: 'Ternura', bg: darkMode ? 'bg-pink-900' : 'bg-pink-100', text: darkMode ? 'text-pink-300' : 'text-pink-600' },
                    { key: 'perspicacia', label: 'Perspicácia', bg: darkMode ? 'bg-green-900' : 'bg-green-100', text: darkMode ? 'text-green-300' : 'text-green-600' },
                    { key: 'vigor', label: 'Vigor', bg: darkMode ? 'bg-yellow-900' : 'bg-yellow-100', text: darkMode ? 'text-yellow-300' : 'text-yellow-600' },
                  ].map(apt => (
                    <div key={apt.key} className={`text-center py-4 rounded ${apt.bg}`}>
                      <div className={`font-semibold ${apt.text}`} style={{ fontSize: '0.6rem' }}>{apt.label}</div>
                      <div className={`text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{openPokemonSection.pokemon.aptidoes?.[apt.key] ?? 0}</div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        )}

        {/* MODAIS (mantidos iguais) */}
        {showLevelModal && <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowLevelModal(false)}>
          <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-3 sm:p-5 md:p-8 rounded-2xl shadow-2xl max-w-md w-full`} onClick={(e) => e.stopPropagation()}>
            <div className="flex justify-between items-center mb-4">
              <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Definir Nível (0-50)</h3>
              <button onClick={() => setShowLevelModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}><X size={24} /></button>
            </div>
            <input type="number" min="0" max="50" value={tempLevel} onChange={e => setTempLevel(e.target.value)} className={`w-full px-3 py-2 sm:px-4 sm:py-3 border-2 rounded-lg text-sm sm:text-base mb-4 text-center text-xl sm:text-2xl font-bold ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`} />
            <button onClick={() => { const n = parseInt(tempLevel); if (n >= 0 && n <= 50) { setLevel(n); setShowLevelModal(false); setTempLevel('') } }} className="w-full bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 font-semibold">Confirmar</button>
          </div>
        </div>}

        {showHPModal && <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => { setShowHPModal(false); cancelDamageTypeSelection(); }}>
          <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-3 sm:p-5 md:p-8 rounded-2xl shadow-2xl max-w-md w-full`} onClick={(e) => e.stopPropagation()}>
            <div className="flex justify-between items-center mb-4">
              <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Dano/Cura Treinador</h3>
              <button onClick={() => { setShowHPModal(false); cancelDamageTypeSelection(); }} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}><X size={24} /></button>
            </div>
            <input type="number" min="1" max="1000" value={hpValue} onChange={e => setHpValue(e.target.value)} placeholder="Valor (1-1000)" className={`w-full px-3 py-2 sm:px-4 sm:py-3 border-2 rounded-lg text-sm sm:text-base mb-4 text-center text-lg sm:text-xl ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`} disabled={showDamageTypeButtons && pendingDamageContext === 'trainer'} />
            {!showDamageTypeButtons || pendingDamageContext !== 'trainer' ? (
              <div className="grid grid-cols-2 gap-2 sm:gap-3 md:gap-4">
                <button onClick={() => { const v = parseInt(hpValue) || 0; const newHP = Math.min(currentHP + v, maxHP); setCurrentHP(newHP); setBattleTrainersList(prev => prev.map(t => t.nome === currentUser?.username ? { ...t, hp: newHP } : t)); setHpValue(''); setShowHPModal(false) }} className="bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 font-semibold flex items-center justify-center gap-2"><Heart size={20} />Curar</button>
                <button onClick={() => { const v = parseInt(hpValue) || 0; if (v > 0) { initiateDamageWithType(v, 'trainer'); } }} className="bg-red-500 text-white py-3 rounded-lg hover:bg-red-600 font-semibold flex items-center justify-center gap-2"><Sword size={20} />Dano</button>
              </div>
            ) : (
              <div className="space-y-3">
                <p className={`text-center text-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>Dano: {pendingDamageValue}</p>

                {/* Multiplicadores de Dano */}
                <div className={`p-3 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                  <p className={`text-xs font-semibold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>Multiplicadores:</p>
                  <div className="grid grid-cols-4 gap-2">
                    {['x2', 'x4', '/2', '/4'].map(mult => (
                      <label key={mult} className={`flex items-center justify-center gap-1 px-2 py-1 rounded cursor-pointer transition-colors ${
                        damageMultiplier === mult
                          ? 'bg-blue-500 text-white'
                          : darkMode ? 'bg-gray-600 text-gray-200 hover:bg-gray-500' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                      }`}>
                        <input
                          type="checkbox"
                          checked={damageMultiplier === mult}
                          onChange={(e) => setDamageMultiplier(e.target.checked ? mult : null)}
                          className="hidden"
                        />
                        <span className="text-sm font-semibold">{mult}</span>
                      </label>
                    ))}
                  </div>
                </div>

                <p className={`text-center text-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>Selecione o tipo de dano:</p>
                <div className="grid grid-cols-3 gap-3">
                  <button onClick={() => applyDamageWithType('fisico')} className="bg-orange-500 text-white py-3 rounded-lg hover:bg-orange-600 font-semibold flex items-center justify-center gap-2"><Sword size={20} />Físico</button>
                  <button onClick={() => applyDamageWithType('puro')} className="bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600 font-semibold flex items-center justify-center gap-2"><Minus size={20} />Puro</button>
                  <button onClick={() => applyDamageWithType('especial')} className="bg-purple-500 text-white py-3 rounded-lg hover:bg-purple-600 font-semibold flex items-center justify-center gap-2"><Zap size={20} />Especial</button>
                </div>
                <button onClick={cancelDamageTypeSelection} className={`w-full py-2 rounded-lg font-semibold ${darkMode ? 'bg-gray-600 text-gray-200 hover:bg-gray-500' : 'bg-gray-300 text-gray-700 hover:bg-gray-400'}`}>Cancelar</button>
              </div>
            )}
          </div>
        </div>}

        {/* MODAL DE IMAGEM DO TREINADOR */}
        {showTrainerImageModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowTrainerImageModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-3 sm:p-5 md:p-8 rounded-2xl shadow-2xl max-w-md w-full`} onClick={(e) => e.stopPropagation()}>
              <div className="flex justify-between items-center mb-6">
                <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  Adicionar Foto do Treinador
                </h3>
                <button onClick={() => setShowTrainerImageModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                  <X size={24} />
                </button>
              </div>

              <div className="space-y-4">
                {/* Seletor de tipo de upload */}
                <div className="flex gap-2 mb-4">
                  <button
                    onClick={() => setTrainerImageUploadType('link')}
                    className={`flex-1 py-2 px-4 rounded-lg font-semibold transition-all ${
                      trainerImageUploadType === 'link'
                        ? 'bg-blue-500 text-white'
                        : darkMode ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                    }`}
                  >
                    Link/URL
                  </button>
                  <button
                    onClick={() => setTrainerImageUploadType('file')}
                    className={`flex-1 py-2 px-4 rounded-lg font-semibold transition-all ${
                      trainerImageUploadType === 'file'
                        ? 'bg-blue-500 text-white'
                        : darkMode ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                    }`}
                  >
                    Arquivo Local
                  </button>
                </div>

                {trainerImageUploadType === 'link' ? (
                  <div>
                    <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>
                      URL da Imagem
                    </label>
                    <input
                      type="url"
                      value={trainerImageUrl}
                      onChange={(e) => setTrainerImageUrl(e.target.value)}
                      placeholder="https://exemplo.com/foto.jpg"
                      className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-500' : 'border-gray-300'}`}
                    />
                  </div>
                ) : (
                  <div>
                    <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>
                      Selecionar Arquivo
                    </label>
                    <input
                      id="trainer-image-file"
                      type="file"
                      accept="image/*"
                      className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                    />
                  </div>
                )}

                <div className="flex gap-3 pt-4">
                  <button
                    onClick={() => {
                      setShowTrainerImageModal(false)
                      setTrainerImageUrl('')
                    }}
                    className={`flex-1 py-3 rounded-lg font-semibold ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                  >
                    Cancelar
                  </button>
                  <button
                    onClick={async () => {
                      if (trainerImageUploadType === 'link' && trainerImageUrl.trim()) {
                        setImage(trainerImageUrl)
                        setShowTrainerImageModal(false)
                        setTrainerImageUrl('')
                        // URL será salva no Firebase pelo auto-save
                      } else if (trainerImageUploadType === 'file') {
                        const fileInput = document.getElementById('trainer-image-file')
                        if (fileInput && fileInput.files && fileInput.files[0]) {
                          const reader = new FileReader()
                          reader.onload = (e) => {
                            // Comprimir imagem do treinador via Canvas para uso local
                            const img = new Image()
                            img.onload = () => {
                              const canvas = document.createElement('canvas')
                              let width = img.width
                              let height = img.height
                              const maxSize = 400

                              if (width > height && width > maxSize) {
                                height = (height * maxSize) / width
                                width = maxSize
                              } else if (height > maxSize) {
                                width = (width * maxSize) / height
                                height = maxSize
                              }

                              canvas.width = width
                              canvas.height = height
                              const ctx = canvas.getContext('2d')
                              ctx.drawImage(img, 0, 0, width, height)
                              const compressedImage = canvas.toDataURL('image/jpeg', 0.6)

                              setImage(compressedImage)
                              setShowTrainerImageModal(false)
                              setTrainerImageUrl('')
                              // Base64 não persiste no Firebase (apenas URLs)
                              console.log('[Image] Imagem do treinador definida localmente (base64 não persiste no Firebase)')
                            }
                            img.src = e.target.result
                          }
                          reader.readAsDataURL(fileInput.files[0])
                        }
                      }
                    }}
                    className="flex-1 bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 font-semibold"
                  >
                    Salvar
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {showImageModal && selectedPokemonForImage && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowImageModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-3 sm:p-5 md:p-8 rounded-2xl shadow-2xl max-w-md w-full`} onClick={(e) => e.stopPropagation()}>
              <div className="flex justify-between items-center mb-6">
                <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  Adicionar Imagem - {selectedPokemonForImage.nickname}
                </h3>
                <button onClick={() => setShowImageModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                  <X size={24} />
                </button>
              </div>

              <div className="space-y-4">
                {/* Seletor de tipo de upload */}
                <div className="flex gap-2 mb-4">
                  <button
                    onClick={() => setImageUploadType('link')}
                    className={`flex-1 py-2 px-4 rounded-lg font-semibold transition-all ${
                      imageUploadType === 'link'
                        ? 'bg-blue-500 text-white'
                        : darkMode ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                    }`}
                  >
                    Link/URL
                  </button>
                  <button
                    onClick={() => setImageUploadType('file')}
                    className={`flex-1 py-2 px-4 rounded-lg font-semibold transition-all ${
                      imageUploadType === 'file'
                        ? 'bg-blue-500 text-white'
                        : darkMode ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                    }`}
                  >
                    Arquivo Local
                  </button>
                </div>

                {imageUploadType === 'link' ? (
                  <div>
                    <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>
                      URL da Imagem
                    </label>
                    <input
                      type="url"
                      value={imageUrl}
                      onChange={(e) => setImageUrl(e.target.value)}
                      placeholder="https://exemplo.com/imagem.jpg"
                      className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-500' : 'border-gray-300'}`}
                    />
                  </div>
                ) : (
                  <div>
                    <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>
                      Selecionar Arquivo
                    </label>
                    <input
                      id="pokemon-image-file"
                      type="file"
                      accept="image/*"
                      className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                    />
                  </div>
                )}

                <div className="flex gap-3 pt-4">
                  <button
                    onClick={() => {
                      setShowImageModal(false)
                      setImageUrl('')
                      setSelectedPokemonForImage(null)
                    }}
                    className={`flex-1 py-3 rounded-lg font-semibold ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                  >
                    Cancelar
                  </button>
                  <button
                    onClick={handleSaveImage}
                    className="flex-1 bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 font-semibold"
                  >
                    Salvar Imagem
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {showClassModal && <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowClassModal(false)}>
          <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-3 sm:p-5 md:p-8 rounded-2xl shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-y-auto`} onClick={(e) => e.stopPropagation()}>
            <div className="flex justify-between items-center mb-4">
              <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Selecionar Classe/Subclasse</h3>
              <button onClick={() => setShowClassModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}><X size={24} /></button>
            </div>
            <div className="relative mb-4">
              <Search className={`absolute left-3 top-1/2 transform -translate-y-1/2 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`} size={20} />
              <input type="text" value={classSearch} onChange={e => setClassSearch(e.target.value)} placeholder="Pesquisar..." className={`w-full pl-10 pr-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'bg-white border-gray-300'}`} />
            </div>
            <div className="space-y-2">
              {allClasses.filter(c => c.name.toLowerCase().includes(classSearch.toLowerCase())).map(cls => <button key={cls.name} onClick={() => { const nc = [...classes]; nc[currentSlot] = cls.name; setClasses(nc); setShowClassModal(false); setClassSearch('') }} className="w-full p-3 rounded-lg text-left font-semibold hover:opacity-80 transition-opacity flex items-center gap-2" style={{ backgroundColor: cls.color + '60', color: cls.color, border: `2px solid ${cls.color}` }}>{cls.isMaster && <Crown size={20} />}{cls.name}</button>)}
            </div>
          </div>
        </div>}

        {/* MODAL DE EVOLUÇÃO */}
        {showEvolutionModal && selectedPokemonForEvolution && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowEvolutionModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-3 sm:p-5 md:p-8 rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto`} onClick={(e) => e.stopPropagation()}>
              <div className="flex justify-between items-center mb-4">
                <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  <Sparkles className="inline mr-2" size={24} />
                  Evoluir Pokémon
                </h3>
                <button onClick={() => setShowEvolutionModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                  <X size={24} />
                </button>
              </div>

              {/* Info do Pokémon atual */}
              <div className={`mb-6 p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Pokémon atual:</p>
                <p className={`text-lg sm:text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  {selectedPokemonForEvolution.nickname} ({selectedPokemonForEvolution.species})
                </p>
              </div>

              {/* Campo de busca */}
              <div className="mb-4">
                <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>
                  Buscar nova espécie:
                </label>
                <div className="relative">
                  <Search className={`absolute left-3 top-1/2 transform -translate-y-1/2 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`} size={18} />
                  <input
                    type="text"
                    value={evolutionSearch}
                    onChange={(e) => setEvolutionSearch(e.target.value)}
                    placeholder="Digite o nome da espécie..."
                    className={`w-full pl-10 pr-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-500' : 'border-gray-300'}`}
                  />
                </div>
              </div>

              {/* Lista de opções */}
              <div className={`mb-4 max-h-60 overflow-y-auto rounded-lg border-2 ${darkMode ? 'border-gray-600' : 'border-gray-300'}`}>
                {getEvolutionOptions().length > 0 ? (
                  getEvolutionOptions().slice(0, 50).map((option, index) => (
                    <button
                      key={`${option.nome}-${index}`}
                      onClick={() => setSelectedEvolutionSpecies(option)}
                      className={`w-full p-3 text-left transition-colors ${
                        selectedEvolutionSpecies?.nome === option.nome
                          ? darkMode
                            ? 'bg-emerald-600 text-white'
                            : 'bg-emerald-500 text-white'
                          : darkMode
                            ? 'hover:bg-gray-700 text-white'
                            : 'hover:bg-gray-100 text-gray-800'
                      } ${index !== 0 ? 'border-t ' + (darkMode ? 'border-gray-600' : 'border-gray-200') : ''}`}
                    >
                      <span className="font-semibold">{option.nome}</span>
                      {option.isExotic && (
                        <span className={`ml-2 text-xs px-2 py-0.5 rounded ${darkMode ? 'bg-purple-600' : 'bg-purple-500'} text-white`}>
                          Exótico
                        </span>
                      )}
                    </button>
                  ))
                ) : (
                  <p className={`p-4 text-center ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                    Nenhuma espécie encontrada
                  </p>
                )}
                {getEvolutionOptions().length > 50 && (
                  <p className={`p-2 text-center text-sm ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                    Mostrando primeiros 50 resultados. Refine sua busca.
                  </p>
                )}
              </div>

              {/* Espécie selecionada */}
              {selectedEvolutionSpecies && (
                <div className={`mb-4 p-4 rounded-lg ${darkMode ? 'bg-emerald-900' : 'bg-emerald-100'}`}>
                  <p className={`text-sm ${darkMode ? 'text-emerald-300' : 'text-emerald-700'}`}>Evoluir para:</p>
                  <p className={`text-lg sm:text-xl font-bold ${darkMode ? 'text-emerald-100' : 'text-emerald-800'}`}>
                    {selectedEvolutionSpecies.nome}
                    {selectedEvolutionSpecies.isExotic && ' (Exótico)'}
                  </p>
                </div>
              )}

              {/* Aviso */}
              <div className={`mb-4 p-3 rounded-lg text-sm ${darkMode ? 'bg-yellow-900 text-yellow-200' : 'bg-yellow-100 text-yellow-800'}`}>
                <strong>Nota:</strong> A evolução irá atualizar apenas os atributos basais, altura, peso e espécie. Todos os outros dados (nível, XP, golpes, habilidades, etc.) serão mantidos.
              </div>

              {/* Botões */}
              <div className="flex gap-3">
                <button
                  onClick={() => setShowEvolutionModal(false)}
                  className={`flex-1 py-3 rounded-lg font-semibold ${darkMode ? 'bg-gray-600 hover:bg-gray-500 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-800'}`}
                >
                  Cancelar
                </button>
                <button
                  onClick={handleEvolution}
                  disabled={!selectedEvolutionSpecies}
                  className={`flex-1 py-3 rounded-lg font-semibold flex items-center justify-center gap-2 ${
                    selectedEvolutionSpecies
                      ? 'bg-emerald-500 hover:bg-emerald-600 text-white'
                      : darkMode
                        ? 'bg-gray-700 text-gray-500 cursor-not-allowed'
                        : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                  }`}
                >
                  <Sparkles size={18} />
                  Evoluir!
                </button>
              </div>
            </div>
          </div>
        )}

        {/* MODAL ADICIONAR POKÉMON */}
        {showAddPokemonModal && <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowAddPokemonModal(false)}>
          <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-3 sm:p-5 md:p-8 rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto`} onClick={(e) => e.stopPropagation()}>
            <div className="flex justify-between items-center mb-4">
              <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Adicionar Pokémon</h3>
              <button onClick={() => setShowAddPokemonModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}><X size={24} /></button>
            </div>
            
            <div className="space-y-4">
              <div>
                <label className={`flex items-center gap-2 mb-3 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  <input type="checkbox" checked={pokemonForm.isCaptured} onChange={e => setPokemonForm({ ...pokemonForm, isCaptured: e.target.checked })} className="w-4 h-4" />
                  <span className="font-semibold">Capturado?</span>
                </label>
              </div>

              {pokemonForm.isCaptured && (
                <div>
                  <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>Nome do Pokémon *</label>
                  <input type="text" value={pokemonForm.nickname} onChange={e => setPokemonForm({ ...pokemonForm, nickname: e.target.value })} placeholder="Apelido do Pokémon" className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-500' : 'border-gray-300'}`} />
                </div>
              )}

              <div>
                <label className={`flex items-center gap-2 mb-3 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  <input type="checkbox" checked={pokemonForm.isExotic} onChange={e => setPokemonForm({ ...pokemonForm, isExotic: e.target.checked })} className="w-4 h-4" />
                  <span className="font-semibold">Pkm Exótico</span>
                </label>
              </div>

              {pokemonForm.isExotic ? (
                <div>
                  <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>Nome da Espécie Exótica *</label>
                  <input type="text" value={pokemonForm.exoticSpecies} onChange={e => setPokemonForm({ ...pokemonForm, exoticSpecies: e.target.value })} placeholder="Nome da espécie" className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-500' : 'border-gray-300'}`} />
                </div>
              ) : (
                <div>
                  <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>Espécie do Pokémon *</label>
                  <div className="relative mb-2">
                    <Search className={`absolute left-3 top-1/2 transform -translate-y-1/2 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`} size={18} />
                    <input type="text" value={speciesSearch} onChange={e => setSpeciesSearch(e.target.value)} placeholder="Pesquisar espécie..." className={`w-full pl-10 pr-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-500' : 'border-gray-300'}`} />
                  </div>
                  <div className={`max-h-48 overflow-y-auto border-2 rounded-lg ${darkMode ? 'border-gray-600' : 'border-gray-300'}`}>
                    {filteredSpecies.map(species => (
                      <button key={species} onClick={() => {
                        // Verificar se é espécie exótica
                        const isExoticSpecies = globalExoticSpecies.some(e => e.nome === species)
                        setPokemonForm({
                          ...pokemonForm,
                          species: isExoticSpecies ? '' : species,
                          isExotic: isExoticSpecies,
                          exoticSpecies: isExoticSpecies ? species : ''
                        })
                        setSpeciesSearch('')
                      }} className={`w-full px-4 py-2 text-left hover:bg-opacity-80 ${pokemonForm.species === species || pokemonForm.exoticSpecies === species ? darkMode ? 'bg-blue-600 text-white' : 'bg-blue-200' : darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-white hover:bg-gray-100'}`}>
                        {species}
                      </button>
                    ))}
                  </div>
                  {(pokemonForm.species || pokemonForm.exoticSpecies) && <p className={`mt-2 text-sm ${darkMode ? 'text-green-400' : 'text-green-600'}`}>✓ Selecionado: {pokemonForm.species || pokemonForm.exoticSpecies}</p>}
                </div>
              )}

              {pokemonForm.isCaptured && (
                <div>
                  <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>Nível (1-100)</label>
                  <input type="number" min="1" max="100" value={pokemonForm.level} onChange={e => setPokemonForm({ ...pokemonForm, level: Math.max(1, Math.min(100, parseInt(e.target.value) || 1)) })} className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`} />
                </div>
              )}

              <button onClick={handleAddPokemon} className="w-full bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 font-semibold">Adicionar</button>
            </div>
          </div>
        </div>}

        {/* MODAL XP */}
        {/* MODAL DE XP */}
        {showXPModal && <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowXPModal(false)}>
          <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-3 sm:p-5 md:p-8 rounded-2xl shadow-2xl max-w-md w-full`} onClick={(e) => e.stopPropagation()}>
            <div className="flex justify-between items-center mb-4">
              <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Adicionar XP</h3>
              <button onClick={() => setShowXPModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}><X size={24} /></button>
            </div>
            {mainTeam[selectedPokemonIndex] && (
              <div className="mb-4">
                <p className={`${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Pokémon: <strong>{mainTeam[selectedPokemonIndex].nickname}</strong></p>
                <p className={`${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Nível atual: <strong>{mainTeam[selectedPokemonIndex].level}</strong></p>
                <p className={`${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>XP Total: <strong>{mainTeam[selectedPokemonIndex].totalXP || 0}</strong></p>
                <p className={`${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Progresso no nível: <strong>{getCurrentLevelXP(mainTeam[selectedPokemonIndex])}/{getXPForNextLevel(mainTeam[selectedPokemonIndex].level)}</strong></p>
              </div>
            )}
            <input type="number" min="1" value={xpToAdd} onChange={e => setXpToAdd(e.target.value)} placeholder="Quantidade de XP" className={`w-full px-3 py-2 sm:px-4 sm:py-3 border-2 rounded-lg text-sm sm:text-base mb-4 text-center text-lg sm:text-xl ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`} />
            <input type="text" value={xpBonus} onChange={e => setXpBonus(e.target.value)} placeholder="Bônus XP (ex: 50% ou 100)" className={`w-full px-3 py-2 sm:px-4 sm:py-3 border-2 rounded-lg text-sm sm:text-base mb-4 text-center text-lg sm:text-xl ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`} />
            {(() => {
              const baseXp = parseInt(xpToAdd) || 0
              let bonusXp = 0
              if (xpBonus) {
                const bonusStr = xpBonus.trim()
                if (bonusStr.endsWith('%')) {
                  const percentage = parseFloat(bonusStr.slice(0, -1)) || 0
                  bonusXp = Math.floor((baseXp * percentage) / 100)
                } else {
                  bonusXp = parseInt(bonusStr) || 0
                }
              }
              const totalXp = baseXp + bonusXp

              if (baseXp > 0) {
                return (
                  <div className={`mb-4 p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                    <p className={`text-lg font-semibold ${darkMode ? 'text-yellow-400' : 'text-yellow-600'}`}>
                      XP Base: {baseXp}
                    </p>
                    {bonusXp > 0 && (
                      <p className={`text-lg font-semibold ${darkMode ? 'text-green-400' : 'text-green-600'}`}>
                        Bônus: +{bonusXp}
                      </p>
                    )}
                    <p className={`text-lg sm:text-xl font-bold ${darkMode ? 'text-cyan-400' : 'text-cyan-600'} mt-2 pt-2 border-t ${darkMode ? 'border-gray-600' : 'border-gray-300'}`}>
                      Total: {totalXp} XP
                    </p>
                  </div>
                )
              }
              return null
            })()}
            <button onClick={handleAddXP} className="w-full bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 font-semibold">Adicionar XP</button>
          </div>
        </div>}

        {/* MODAL DE FELICIDADE */}
        {showHappinessModal && mainTeam[selectedPokemonHappinessIndex] && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowHappinessModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-3 sm:p-5 md:p-8 rounded-2xl shadow-2xl max-w-md w-full`} onClick={(e) => e.stopPropagation()}>
              <div className="flex justify-between items-center mb-4">
                <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Felicidade</h3>
                <button onClick={() => setShowHappinessModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}><X size={24} /></button>
              </div>
              <div className="mb-4">
                <p className={`${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Pokémon: <strong>{mainTeam[selectedPokemonHappinessIndex].nickname}</strong></p>
                <p className={`${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Felicidade atual: <strong>{mainTeam[selectedPokemonHappinessIndex].currentHappiness || 0}/{calculateMaxHappiness(mainTeam[selectedPokemonHappinessIndex])}</strong></p>
              </div>
              <input
                type="number"
                min="1"
                value={happinessAmount}
                onChange={e => setHappinessAmount(e.target.value)}
                placeholder="Quantidade"
                className={`w-full px-3 py-2 sm:px-4 sm:py-3 border-2 rounded-lg text-sm sm:text-base mb-4 text-center text-lg sm:text-xl ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
              />
              <div className="flex gap-3">
                <button onClick={handleDecreaseHappiness} className="flex-1 bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 font-semibold">
                  Triste
                </button>
                <button onClick={handleIncreaseHappiness} className="flex-1 bg-pink-500 text-white py-3 rounded-lg hover:bg-pink-600 font-semibold">
                  Feliz
                </button>
              </div>
            </div>
          </div>
        )}

        {/* MODAL NAME RATER - TIME PRINCIPAL */}
        {showNameRaterModal && nameRaterIndex !== null && mainTeam[nameRaterIndex] && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowNameRaterModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-3 sm:p-5 md:p-8 rounded-2xl shadow-2xl max-w-md w-full`} onClick={(e) => e.stopPropagation()}>
              <div className="flex justify-between items-center mb-4">
                <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-orange-400' : 'text-orange-600'}`}>Name Rater</h3>
                <button onClick={() => setShowNameRaterModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                  <X size={24} />
                </button>
              </div>
              <div className="mb-4">
                <p className={`text-center mb-4 italic ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                  Ele tem um nome feio mesmo, quer algumas dicas?
                </p>
                <input
                  type="text"
                  value={nameRaterNickname}
                  onChange={e => setNameRaterNickname(e.target.value)}
                  placeholder="Novo nome do Pokémon"
                  className={`w-full px-3 py-2 sm:px-4 sm:py-3 border-2 rounded-lg text-sm sm:text-base text-center text-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-500' : 'border-gray-300'}`}
                  maxLength={30}
                />
              </div>
              <button
                onClick={() => {
                  if (nameRaterNickname.trim()) {
                    const updatedTeam = [...mainTeam]
                    updatedTeam[nameRaterIndex] = {
                      ...updatedTeam[nameRaterIndex],
                      nickname: nameRaterNickname.trim()
                    }
                    setMainTeam(updatedTeam)
                    setShowNameRaterModal(false)
                    setNameRaterIndex(null)
                    setNameRaterNickname('')
                  }
                }}
                className="w-full bg-orange-500 text-white py-3 rounded-lg hover:bg-orange-600 font-semibold"
              >
                Renomear
              </button>
            </div>
          </div>
        )}

        {/* Modal de Detalhes do Held Item */}
        {showHeldItemDetailModal && selectedHeldItemForDetail && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowHeldItemDetailModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-xl w-full`} onClick={(e) => e.stopPropagation()}>
              <div className="p-3 sm:p-5 md:p-6">
                <div className="flex justify-between items-center mb-6">
                  <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-gray-200' : 'text-gray-800'}`}>
                    {selectedHeldItemForDetail.name}
                  </h3>
                  <button onClick={() => setShowHeldItemDetailModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                    <X size={24} />
                  </button>
                </div>

                {/* Descrição */}
                <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                  <p className={`${darkMode ? 'text-gray-300' : 'text-gray-700'} whitespace-pre-wrap`}>
                    {selectedHeldItemForDetail.description || 'Nenhuma descrição fornecida.'}
                  </p>
                </div>

                {/* Botão Fechar */}
                <div className="mt-6">
                  <button
                    onClick={() => setShowHeldItemDetailModal(false)}
                    className={`w-full py-3 rounded-lg font-semibold ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                  >
                    Fechar
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* MODAL DE DANO/CURA */}
        {showPokemonHPModal && selectedPokemonHP && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowPokemonHPModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-3 sm:p-5 md:p-8 rounded-2xl shadow-2xl max-w-md w-full`} onClick={(e) => e.stopPropagation()}>
              <div className="flex justify-between items-center mb-4">
                <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Dano/Cura</h3>
                <button onClick={() => setShowPokemonHPModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}><X size={24} /></button>
              </div>
              <div className="mb-4">
                <p className={`${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Pokémon: <strong>{selectedPokemonHP.nickname}</strong></p>
                <p className={`${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>HP atual: <strong>{selectedPokemonHP.currentHP || 0}/{calculateMaxHP(selectedPokemonHP)}</strong></p>
                <div className={`w-full rounded-full h-4 overflow-hidden mt-2 ${darkMode ? 'bg-gray-600' : 'bg-gray-300'}`}>
                  <div
                    className={`h-4 rounded-full transition-all duration-500 ${
                      ((selectedPokemonHP.currentHP || 0) / calculateMaxHP(selectedPokemonHP)) > 0.5 ? 'bg-green-500' :
                      ((selectedPokemonHP.currentHP || 0) / calculateMaxHP(selectedPokemonHP)) > 0.2 ? 'bg-yellow-500' :
                      'bg-red-500'
                    }`}
                    style={{ width: `${Math.min(100, ((selectedPokemonHP.currentHP || 0) / calculateMaxHP(selectedPokemonHP)) * 100)}%` }}
                  ></div>
                </div>
              </div>
              <input type="number" min="1" value={hpAmount} onChange={e => setHpAmount(e.target.value)} placeholder="Quantidade de HP" className={`w-full px-3 py-2 sm:px-4 sm:py-3 border-2 rounded-lg text-sm sm:text-base mb-4 text-center text-lg sm:text-xl ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`} />

              {/* Multiplicadores de Dano */}
              <div className={`p-3 rounded-lg mb-4 ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                <p className={`text-xs font-semibold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>Multiplicadores de Dano:</p>
                <div className="grid grid-cols-4 gap-2">
                  {['x2', 'x4', '/2', '/4'].map(mult => (
                    <label key={mult} className={`flex items-center justify-center gap-1 px-2 py-1 rounded cursor-pointer transition-colors ${
                      damageMultiplier === mult
                        ? 'bg-blue-500 text-white'
                        : darkMode ? 'bg-gray-600 text-gray-200 hover:bg-gray-500' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                    }`}>
                      <input
                        type="checkbox"
                        checked={damageMultiplier === mult}
                        onChange={(e) => setDamageMultiplier(e.target.checked ? mult : null)}
                        className="hidden"
                      />
                      <span className="text-sm font-semibold">{mult}</span>
                    </label>
                  ))}
                </div>
              </div>

              <div className="flex gap-3">
                <button onClick={handleDamagePokemon} className="flex-1 bg-red-500 text-white py-3 rounded-lg hover:bg-red-600 font-semibold">Aplicar Dano</button>
                <button onClick={handleHealPokemon} className="flex-1 bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 font-semibold">Curar</button>
              </div>
            </div>
          </div>
        )}
        {/* MODAL DE HP TEMPORÁRIO */}
        {showTempHPModal && selectedPokemonForTempHP && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowTempHPModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-3 sm:p-5 md:p-8 rounded-2xl shadow-2xl max-w-md w-full`} onClick={(e) => e.stopPropagation()}>
              <div className="flex justify-between items-center mb-4">
                <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>HP Temporário Pkm</h3>
                <button onClick={() => setShowTempHPModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}><X size={24} /></button>
              </div>
              <div className="mb-4">
                <p className={`${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Pokémon: <strong>{selectedPokemonForTempHP.nickname}</strong></p>
                <p className={`${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>HP Temporário Atual: <strong>{selectedPokemonForTempHP.temporaryHP || 0}</strong></p>
              </div>
              <input 
                type="number" 
                min="0" 
                value={tempHPAmount} 
                onChange={e => setTempHPAmount(e.target.value)} 
                placeholder="Valor de HP Temporário" 
                className={`w-full px-3 py-2 sm:px-4 sm:py-3 border-2 rounded-lg text-sm sm:text-base mb-4 text-center text-lg sm:text-xl ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`} 
              />
              <button onClick={handleSaveTempHP} className="w-full bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 font-semibold">Salvar HP Temporário</button>
            </div>
          </div>
        )}

        {/* MODAL DE DADOS EXÓTICOS */}
        {showExoticDataModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-3 sm:p-5 md:p-8 rounded-2xl shadow-2xl max-w-sm sm:max-w-2xl md:max-w-4xl w-full max-h-[90vh] overflow-y-auto`} onClick={(e) => e.stopPropagation()}>
              <div className="flex justify-between items-center mb-6">
                <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  Dados do Pokémon Exótico: {pokemonForm.exoticSpecies}
                </h3>
                <button onClick={() => setShowExoticDataModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                  <X size={24} />
                </button>
              </div>

              <div className="space-y-4">
                <div className="grid grid-cols-2 gap-2 sm:gap-3 md:gap-4">
                  <div>
                    <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>Número da Pokédex</label>
                    <input type="number" value={exoticDataForm.dexNumber} onChange={(e) => setExoticDataForm({...exoticDataForm, dexNumber: e.target.value})} className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`} />
                  </div>
                  <div>
                    <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>Distribuição de Gênero</label>
                    <input type="text" value={exoticDataForm.genero} onChange={(e) => setExoticDataForm({...exoticDataForm, genero: e.target.value})} placeholder="Macho/Fêmea/Sem Gênero" className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`} />
                  </div>
                </div>

                <div className="grid grid-cols-2 gap-2 sm:gap-3 md:gap-4">
                  <div>
                    <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>Altura (m) *</label>
                    <input type="number" step="0.1" value={exoticDataForm.altura} onChange={(e) => setExoticDataForm({...exoticDataForm, altura: e.target.value})} className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`} />
                  </div>
                  <div>
                    <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>Peso (kg) *</label>
                    <input type="number" step="0.1" value={exoticDataForm.peso} onChange={(e) => setExoticDataForm({...exoticDataForm, peso: e.target.value})} className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`} />
                  </div>
                </div>

                <div>
                  <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>Tipos * (máximo 3)</label>
                  <div className="flex flex-wrap gap-2 mb-3">
                    {['Normal', 'Fogo', 'Água', 'Planta', 'Elétrico', 'Gelo', 'Lutador', 'Veneno', 'Terra', 'Voador', 'Psíquico', 'Inseto', 'Pedra', 'Fantasma', 'Dragão', 'Sombrio', 'Metal', 'Fada'].map(tipo => {
                      const isSelected = exoticDataForm.tipos.includes(tipo)
                      return (
                        <button
                          key={tipo}
                          type="button"
                          onClick={() => {
                            if (isSelected) {
                              setExoticDataForm({...exoticDataForm, tipos: exoticDataForm.tipos.filter(t => t !== tipo)})
                            } else if (exoticDataForm.tipos.length < 3) {
                              setExoticDataForm({...exoticDataForm, tipos: [...exoticDataForm.tipos, tipo]})
                            }
                          }}
                          className={`px-3 py-2 rounded-lg text-sm font-bold text-white transition-all ${
                            isSelected
                              ? `${TYPE_STYLES[tipo] || 'bg-gray-500'} ring-4 ring-yellow-400`
                              : `${TYPE_STYLES[tipo] || 'bg-gray-500'} opacity-50 hover:opacity-75`
                          }`}
                        >
                          {tipo}
                        </button>
                      )
                    })}
                  </div>
                  <div className="flex gap-2 flex-wrap">
                    {exoticDataForm.tipos.map((tipo, idx) => (
                      <span
                        key={idx}
                        className={`px-3 py-1 rounded-md text-xs font-bold text-white shadow-md ${TYPE_STYLES[tipo] || 'bg-gray-400'}`}
                        style={{ clipPath: 'polygon(0 0, 90% 0, 100% 50%, 90% 100%, 0 100%)' }}
                      >
                        {tipo}
                      </span>
                    ))}
                  </div>
                </div>

                <div>
                  <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>Habitats</label>
                  {exoticDataForm.habitats.map((habitat, idx) => (
                    <div key={idx} className="flex gap-2 mb-2">
                      <input type="text" value={habitat} onChange={(e) => {
                        const newHabitats = [...exoticDataForm.habitats]
                        newHabitats[idx] = e.target.value
                        setExoticDataForm({...exoticDataForm, habitats: newHabitats})
                      }} placeholder={`Habitat ${idx + 1}`} className={`flex-1 px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`} />
                      {idx > 0 && <button onClick={() => setExoticDataForm({...exoticDataForm, habitats: exoticDataForm.habitats.filter((_, i) => i !== idx)})} className="bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600"><Minus size={16} /></button>}
                    </div>
                  ))}
                  <button onClick={() => setExoticDataForm({...exoticDataForm, habitats: [...exoticDataForm.habitats, '']})} className="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 text-sm"><Plus size={16} className="inline" /> Adicionar Habitat</button>
                </div>

                <div className="grid grid-cols-2 gap-2 sm:gap-3 md:gap-4">
                  <div>
                    <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>Catch Rate</label>
                    <input type="number" value={exoticDataForm.catchRate} onChange={(e) => setExoticDataForm({...exoticDataForm, catchRate: e.target.value})} className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`} />
                  </div>
                  <div>
                    <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>Experiência Base</label>
                    <input type="number" value={exoticDataForm.baseExp} onChange={(e) => setExoticDataForm({...exoticDataForm, baseExp: e.target.value})} className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`} />
                  </div>
                </div>

                <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                  <h4 className={`font-bold mb-3 ${darkMode ? 'text-white' : 'text-gray-800'}`}>Status Base</h4>
                  <div className="grid grid-cols-2 gap-3">
                    <div>
                      <label className={`block text-xs font-medium ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-1`}>Saúde</label>
                      <input type="number" value={exoticDataForm.statusBasais.saude} onChange={(e) => setExoticDataForm({...exoticDataForm, statusBasais: {...exoticDataForm.statusBasais, saude: e.target.value}})} className={`w-full px-3 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'border-gray-300'}`} />
                    </div>
                    <div>
                      <label className={`block text-xs font-medium ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-1`}>Ataque</label>
                      <input type="number" value={exoticDataForm.statusBasais.ataque} onChange={(e) => setExoticDataForm({...exoticDataForm, statusBasais: {...exoticDataForm.statusBasais, ataque: e.target.value}})} className={`w-full px-3 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'border-gray-300'}`} />
                    </div>
                    <div>
                      <label className={`block text-xs font-medium ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-1`}>Defesa</label>
                      <input type="number" value={exoticDataForm.statusBasais.defesa} onChange={(e) => setExoticDataForm({...exoticDataForm, statusBasais: {...exoticDataForm.statusBasais, defesa: e.target.value}})} className={`w-full px-3 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'border-gray-300'}`} />
                    </div>
                    <div>
                      <label className={`block text-xs font-medium ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-1`}>Ataque Especial</label>
                      <input type="number" value={exoticDataForm.statusBasais.ataqueEspecial} onChange={(e) => setExoticDataForm({...exoticDataForm, statusBasais: {...exoticDataForm.statusBasais, ataqueEspecial: e.target.value}})} className={`w-full px-3 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'border-gray-300'}`} />
                    </div>
                    <div>
                      <label className={`block text-xs font-medium ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-1`}>Defesa Especial</label>
                      <input type="number" value={exoticDataForm.statusBasais.defesaEspecial} onChange={(e) => setExoticDataForm({...exoticDataForm, statusBasais: {...exoticDataForm.statusBasais, defesaEspecial: e.target.value}})} className={`w-full px-3 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'border-gray-300'}`} />
                    </div>
                    <div>
                      <label className={`block text-xs font-medium ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-1`}>Velocidade</label>
                      <input type="number" value={exoticDataForm.statusBasais.velocidade} onChange={(e) => setExoticDataForm({...exoticDataForm, statusBasais: {...exoticDataForm.statusBasais, velocidade: e.target.value}})} className={`w-full px-3 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'border-gray-300'}`} />
                    </div>
                  </div>
                </div>

                <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                  <h4 className={`font-bold mb-3 ${darkMode ? 'text-white' : 'text-gray-800'}`}>Evolução (Opcional)</h4>
                  <div className="space-y-3">
                    <div>
                      <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>Evolui para</label>
                      <input type="text" value={exoticDataForm.evolucao} onChange={(e) => setExoticDataForm({...exoticDataForm, evolucao: e.target.value})} placeholder="Nome do Pokémon" className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'border-gray-300'}`} />
                    </div>
                    <div className="grid grid-cols-2 gap-3">
                      <div>
                        <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>Nível de Evolução</label>
                        <input type="number" value={exoticDataForm.evolucaoNivel} onChange={(e) => setExoticDataForm({...exoticDataForm, evolucaoNivel: e.target.value})} className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'border-gray-300'}`} />
                      </div>
                      <div>
                        <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>Item de Evolução</label>
                        <input type="text" value={exoticDataForm.evolucaoItem} onChange={(e) => setExoticDataForm({...exoticDataForm, evolucaoItem: e.target.value})} placeholder="Nome do item" className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'border-gray-300'}`} />
                      </div>
                    </div>
                  </div>
                </div>

                <div className="flex gap-3 pt-4">
                  <button onClick={() => setShowExoticDataModal(false)} className={`flex-1 py-3 rounded-lg font-semibold ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}>
                    Cancelar
                  </button>
                  <button onClick={handleSaveExoticData} className="flex-1 bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 font-semibold">
                    Salvar e Adicionar
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* MODAL DE EDIÇÃO DE POKÉMON */}
        {showEditPokemonModal && editingPokemon && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowEditPokemonModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-sm sm:max-w-2xl md:max-w-4xl w-full max-h-[90vh] overflow-y-auto`} onClick={(e) => e.stopPropagation()}>
              <div className="p-3 sm:p-5 md:p-6">
                <div className="flex justify-between items-center mb-6">
                  <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                    Edição de {editingPokemon.nickname}
                  </h3>
                  <button onClick={() => setShowEditPokemonModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                    <X size={24} />
                  </button>
                </div>

                {/* CHECKBOX SHINY */}
                <div className="mb-6 flex items-center gap-3">
                  <input
                    type="checkbox"
                    id="shiny-checkbox"
                    checked={pokemonEditForm.shiny}
                    onChange={(e) => setPokemonEditForm({...pokemonEditForm, shiny: e.target.checked})}
                    className="w-5 h-5 cursor-pointer"
                  />
                  <label htmlFor="shiny-checkbox" className="text-xl sm:text-2xl font-bold cursor-pointer select-none" style={{
                    background: 'linear-gradient(to right, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3)',
                    WebkitBackgroundClip: 'text',
                    WebkitTextFillColor: 'transparent',
                    backgroundClip: 'text'
                  }}>
                    SHINY
                  </label>
                </div>

                {/* CHECKBOX LENDÁRIO */}
                <div className="mb-6 flex items-center gap-3">
                  <input
                    type="checkbox"
                    id="legendary-checkbox"
                    checked={pokemonEditForm.legendary}
                    onChange={(e) => setPokemonEditForm({...pokemonEditForm, legendary: e.target.checked})}
                    className="w-5 h-5 cursor-pointer"
                  />
                  <label htmlFor="legendary-checkbox" className="text-xl sm:text-2xl font-bold cursor-pointer select-none" style={{
                    background: 'linear-gradient(135deg, #FFD700 0%, #FFA500 50%, #FF6347 100%)',
                    WebkitBackgroundClip: 'text',
                    WebkitTextFillColor: 'transparent',
                    backgroundClip: 'text'
                  }}>
                    LENDÁRIO
                  </label>
                </div>

                {/* 1. NATUREZA */}
                <div className="mb-6">
                  <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>1. Natureza</label>
                  <input
                    type="text"
                    placeholder="Buscar natureza..."
                    value={natureSearch}
                    onChange={(e) => setNatureSearch(e.target.value)}
                    className={`w-full px-4 py-2 border-2 rounded-lg mb-2 ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                  />
                  <select
                    value={pokemonEditForm.nature}
                    onChange={(e) => setPokemonEditForm({...pokemonEditForm, nature: e.target.value})}
                    className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                  >
                    <option value="">Selecione uma natureza</option>
                    {natures
                      .filter(n => natureSearch === '' || n.nome.toLowerCase().includes(natureSearch.toLowerCase()))
                      .map((nature, idx) => (
                        <option key={idx} value={nature.nome}>
                          {nature.nome} {nature.up !== 'Nenhum' && `(↑${nature.up} ↓${nature.down})`}
                        </option>
                      ))
                    }
                  </select>
                  {pokemonEditForm.nature && (() => {
                    const selectedNature = natures.find(n => n.nome === pokemonEditForm.nature)
                    return selectedNature && (
                      <div className={`mt-2 text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                        <p><strong>Aumenta:</strong> {selectedNature.up}</p>
                        <p><strong>Diminui:</strong> {selectedNature.down}</p>
                      </div>
                    )
                  })()}
                </div>

                {/* 2. ATRIBUTOS */}
                <div className="mb-6">
                  <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>2. Atributos</label>
                  <p className={`text-xs mb-3 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                    Todos os atributos flutuam entre +2/-2, menos a saúde, ela flutuará entre +1/-1.
                  </p>
                  <div className="overflow-x-auto">
                    <table className={`w-full border-collapse ${darkMode ? 'bg-gray-700' : 'bg-white'}`}>
                      <thead>
                        <tr className={darkMode ? 'bg-gray-600' : 'bg-gray-200'}>
                          <th className={`border p-2 text-xs ${darkMode ? 'border-gray-500 text-white' : 'border-gray-300'}`}>Atributos</th>
                          <th className={`border p-2 text-xs ${darkMode ? 'border-gray-500 text-white' : 'border-gray-300'}`}>Atributos Basais</th>
                          <th className={`border p-2 text-xs ${darkMode ? 'border-gray-500 text-white' : 'border-gray-300'}`}>Atributo Bônus</th>
                          <th className={`border p-2 text-xs ${darkMode ? 'border-gray-500 text-white' : 'border-gray-300'}`}>Basal + Bônus + Nat.</th>
                          <th className={`border p-2 text-xs ${darkMode ? 'border-gray-500 text-white' : 'border-gray-300'}`}>Pontos por Nível</th>
                          <th className={`border p-2 text-xs ${darkMode ? 'border-gray-500 text-white' : 'border-gray-300'}`}>Total</th>
                        </tr>
                      </thead>
                      <tbody>
                        {[
                          { label: 'Saúde', key: 'saude' },
                          { label: 'Ataque', key: 'ataque' },
                          { label: 'Defesa', key: 'defesa' },
                          { label: 'Ataque Especial', key: 'ataqueEspecial' },
                          { label: 'Defesa Especial', key: 'defesaEspecial' },
                          { label: 'Velocidade', key: 'velocidade' }
                        ].map(attr => {
                          const selectedNature = natures.find(n => n.nome === pokemonEditForm.nature)
                          const isIncreased = selectedNature?.up === attr.label
                          const isDecreased = selectedNature?.down === attr.label
                          const baseVal = parseInt(pokemonEditForm.baseAttributes[attr.key]) || 0
                          const bonusVal = parseInt(pokemonEditForm.bonusPoints[attr.key]) || 0
                          // Saúde flutua ±1, outros atributos flutuam ±2
                          const natureBonus = attr.key === 'saude' ? 1 : 2
                          const natureVal = isIncreased ? natureBonus : isDecreased ? -natureBonus : 0
                          const levelVal = parseInt(pokemonEditForm.levelPoints[attr.key]) || 0
                          const total = baseVal + bonusVal + natureVal + levelVal

                          return (
                            <tr key={attr.key} className={
                              isIncreased ? (darkMode ? 'bg-green-900/30' : 'bg-green-50') :
                              isDecreased ? (darkMode ? 'bg-red-900/30' : 'bg-red-50') : ''
                            }>
                              <td className={`border p-2 text-xs font-semibold ${darkMode ? 'border-gray-500 text-white' : 'border-gray-300'}`}>
                                {attr.label}
                              </td>
                              <td className={`border p-2 ${darkMode ? 'border-gray-500' : 'border-gray-300'}`}>
                                <input
                                  type="number"
                                  min="1"
                                  max="100"
                                  value={pokemonEditForm.baseAttributes[attr.key]}
                                  onChange={(e) => setPokemonEditForm({
                                    ...pokemonEditForm,
                                    baseAttributes: {...pokemonEditForm.baseAttributes, [attr.key]: e.target.value}
                                  })}
                                  className={`w-full px-2 py-1 text-xs text-center border rounded ${darkMode ? 'bg-gray-600 text-white border-gray-500' : 'border-gray-300'}`}
                                />
                              </td>
                              <td className={`border p-2 ${darkMode ? 'border-gray-500' : 'border-gray-300'}`}>
                                <input
                                  type="number"
                                  value={pokemonEditForm.bonusPoints[attr.key]}
                                  onChange={(e) => setPokemonEditForm({
                                    ...pokemonEditForm,
                                    bonusPoints: {...pokemonEditForm.bonusPoints, [attr.key]: e.target.value}
                                  })}
                                  className={`w-full px-2 py-1 text-xs text-center border rounded ${darkMode ? 'bg-gray-600 text-white border-gray-500' : 'border-gray-300'}`}
                                />
                              </td>
                              <td className={`border p-2 text-xs text-center ${darkMode ? 'border-gray-500 text-white' : 'border-gray-300'}`}>
                                {baseVal + bonusVal + natureVal}
                              </td>
                              <td className={`border p-2 ${darkMode ? 'border-gray-500' : 'border-gray-300'}`}>
                                <input
                                  type="number"
                                  value={pokemonEditForm.levelPoints[attr.key]}
                                  onChange={(e) => setPokemonEditForm({
                                    ...pokemonEditForm,
                                    levelPoints: {...pokemonEditForm.levelPoints, [attr.key]: e.target.value}
                                  })}
                                  className={`w-full px-2 py-1 text-xs text-center border rounded ${darkMode ? 'bg-gray-600 text-white border-gray-500' : 'border-gray-300'}`}
                                />
                              </td>
                              <td className={`border p-2 text-xs text-center font-bold ${darkMode ? 'border-gray-500 text-white' : 'border-gray-300'}`}>
                                {total}
                              </td>
                            </tr>
                          )
                        })}
                      </tbody>
                    </table>
                  </div>
                </div>

                {/* 3 e 4. SABORES */}
                <div className="grid md:grid-cols-2 gap-2 sm:gap-3 md:gap-4 mb-6">
                  <div>
                    <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>3. Sabor Predileto</label>
                    <input
                      type="text"
                      value={natures.find(n => n.nome === pokemonEditForm.nature)?.gosto || 'Nenhum'}
                      disabled
                      className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-600 border-gray-500 text-gray-400' : 'bg-gray-100 border-gray-300 text-gray-600'}`}
                    />
                  </div>
                  <div>
                    <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>4. Sabor que Não Gosta</label>
                    <input
                      type="text"
                      value={natures.find(n => n.nome === pokemonEditForm.nature)?.desgosto || 'Nenhum'}
                      disabled
                      className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-600 border-gray-500 text-gray-400' : 'bg-gray-100 border-gray-300 text-gray-600'}`}
                    />
                  </div>
                </div>

                {/* 5. GÊNERO */}
                <div className="mb-6">
                  <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>5. Gênero</label>
                  <select
                    value={pokemonEditForm.gender}
                    onChange={(e) => setPokemonEditForm({...pokemonEditForm, gender: e.target.value})}
                    className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                  >
                    <option value="">Selecione...</option>
                    <option value="Macho">Macho</option>
                    <option value="Fêmea">Fêmea</option>
                    <option value="Assexuado">Assexuado</option>
                  </select>
                </div>

                {/* 6. DESLOCAMENTO */}
                <div className="mb-6">
                  <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>6. Deslocamento</label>
                  <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3">
                    {['terrestre', 'nadar', 'voar', 'cavar', 'submerso'].map(type => (
                      <div key={type}>
                        <label className={`block text-xs mb-1 ${darkMode ? 'text-gray-400' : 'text-gray-600'} capitalize`}>{type}</label>
                        <input
                          type="text"
                          value={pokemonEditForm.displacement[type]}
                          onChange={(e) => setPokemonEditForm({
                            ...pokemonEditForm,
                            displacement: {...pokemonEditForm.displacement, [type]: e.target.value}
                          })}
                          className={`w-full px-3 py-2 border-2 rounded-lg text-sm ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                        />
                      </div>
                    ))}
                  </div>
                </div>

                {/* 7. PESO E ALTURA */}
                <div className="grid md:grid-cols-2 gap-2 sm:gap-3 md:gap-4 mb-6">
                  <div>
                    <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>7. Peso (Kg)</label>
                    <input
                      type="number"
                      step="0.01"
                      value={pokemonEditForm.weight}
                      onChange={(e) => setPokemonEditForm({...pokemonEditForm, weight: e.target.value})}
                      className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                    />
                  </div>
                  <div>
                    <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Altura (M)</label>
                    <input
                      type="number"
                      step="0.01"
                      value={pokemonEditForm.height}
                      onChange={(e) => setPokemonEditForm({...pokemonEditForm, height: e.target.value})}
                      className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                    />
                  </div>
                </div>

                {/* 8. LEALDADE */}
                <div className="mb-6">
                  <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>8. Lealdade</label>
                  <input
                    type="text"
                    value={pokemonEditForm.loyalty}
                    onChange={(e) => setPokemonEditForm({...pokemonEditForm, loyalty: e.target.value})}
                    className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                  />
                </div>

                {/* 9. CAPACIDADES */}
                <div className="mb-6">
                  <label className={`block text-sm font-bold mb-4 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>9. Capacidades</label>

                  {/* Força, Inteligência, Salto */}
                  <div className="grid md:grid-cols-3 gap-2 sm:gap-3 md:gap-4 mb-4">
                    <div>
                      <label className={`block text-xs font-semibold mb-1 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Força (1-10)</label>
                      <input
                        type="number"
                        min="1"
                        max="10"
                        value={pokemonEditForm.capacities.forca}
                        onChange={(e) => setPokemonEditForm({
                          ...pokemonEditForm,
                          capacities: {...pokemonEditForm.capacities, forca: e.target.value}
                        })}
                        className={`w-full px-3 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                      />
                    </div>
                    <div>
                      <label className={`block text-xs font-semibold mb-1 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Inteligência (1-7)</label>
                      <input
                        type="number"
                        min="1"
                        max="7"
                        value={pokemonEditForm.capacities.inteligencia}
                        onChange={(e) => setPokemonEditForm({
                          ...pokemonEditForm,
                          capacities: {...pokemonEditForm.capacities, inteligencia: e.target.value}
                        })}
                        className={`w-full px-3 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                      />
                    </div>
                    <div>
                      <label className={`block text-xs font-semibold mb-1 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Salto (1-10)</label>
                      <input
                        type="number"
                        min="1"
                        max="10"
                        value={pokemonEditForm.capacities.salto}
                        onChange={(e) => setPokemonEditForm({
                          ...pokemonEditForm,
                          capacities: {...pokemonEditForm.capacities, salto: e.target.value}
                        })}
                        className={`w-full px-3 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                      />
                    </div>
                  </div>

                  {/* Outras capacidades */}
                  <div>
                    <div className="flex justify-between items-center mb-2">
                      <label className={`block text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Outras Capacidades</label>
                      <button
                        onClick={() => {
                          setPokemonEditForm({
                            ...pokemonEditForm,
                            capacities: {
                              ...pokemonEditForm.capacities,
                              others: [...pokemonEditForm.capacities.others, '']
                            }
                          })
                        }}
                        className="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 text-sm font-semibold"
                      >
                        Outros +
                      </button>
                    </div>

                    {/* Slots dinâmicos */}
                    <div className="space-y-2">
                      {pokemonEditForm.capacities.others.map((capacity, idx) => (
                        <div key={idx} className="flex gap-2">
                          <select
                            value={capacity}
                            onChange={(e) => {
                              const newOthers = [...pokemonEditForm.capacities.others]
                              newOthers[idx] = e.target.value
                              setPokemonEditForm({
                                ...pokemonEditForm,
                                capacities: {...pokemonEditForm.capacities, others: newOthers}
                              })
                            }}
                            className={`flex-1 px-3 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                          >
                            <option value="">Selecione uma capacidade</option>
                            {CAPACIDADES_NAMES.map((cap, i) => (
                              <option key={i} value={cap}>{cap}</option>
                            ))}
                          </select>
                          <button
                            onClick={() => {
                              const newOthers = pokemonEditForm.capacities.others.filter((_, i) => i !== idx)
                              setPokemonEditForm({
                                ...pokemonEditForm,
                                capacities: {...pokemonEditForm.capacities, others: newOthers}
                              })
                            }}
                            className="bg-red-500 text-white px-3 py-2 rounded hover:bg-red-600"
                          >
                            <X size={18} />
                          </button>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>

                {/* 10. DIETA */}
                <div className="mb-6">
                  <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>10. Dieta</label>
                  <div className="flex gap-3">
                    {[1, 2].map(slot => {
                      const slotKey = slot === 1 ? 'dietaSlot1' : 'dietaSlot2'
                      const selectedDiet = pokemonEditForm[slotKey]
                      const isOpen = showDietSlotDropdown === slot
                      return (
                        <div key={slot} className="relative">
                          <button
                            onClick={() => setShowDietSlotDropdown(isOpen ? null : slot)}
                            className={`flex flex-col items-center gap-1 p-3 rounded-lg border-2 min-w-[90px] transition-colors ${selectedDiet ? darkMode ? 'border-green-500 bg-gray-700' : 'border-green-500 bg-green-50' : darkMode ? 'border-gray-600 bg-gray-700 hover:border-gray-400' : 'border-gray-300 bg-gray-50 hover:border-gray-400'}`}
                          >
                            {selectedDiet ? (
                              <>
                                <img src={DIET_IMAGE_MAP[selectedDiet]} alt={selectedDiet} width={28} height={28} className="object-contain" onError={(e) => { e.target.style.display = 'none' }} />
                                <span className={`text-xs font-semibold text-center leading-tight ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>{selectedDiet}</span>
                              </>
                            ) : (
                              <>
                                <span className={`text-2xl ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>+</span>
                                <span className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>Dieta {slot}</span>
                              </>
                            )}
                          </button>
                          {isOpen && (
                            <div className={`absolute top-full left-0 mt-1 rounded-lg shadow-lg border z-10 min-w-[160px] ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-200'}`}>
                              <button
                                onClick={() => { setPokemonEditForm({...pokemonEditForm, [slotKey]: ''}); setShowDietSlotDropdown(null) }}
                                className={`w-full text-left px-3 py-2 text-sm rounded-t-lg ${darkMode ? 'text-gray-400 hover:bg-gray-600' : 'text-gray-500 hover:bg-gray-100'}`}
                              >
                                Nenhuma
                              </button>
                              {Object.keys(DIET_IMAGE_MAP).map(diet => (
                                <button
                                  key={diet}
                                  onClick={() => { setPokemonEditForm({...pokemonEditForm, [slotKey]: diet}); setShowDietSlotDropdown(null) }}
                                  className={`w-full flex items-center gap-2 px-3 py-2 text-sm ${selectedDiet === diet ? darkMode ? 'bg-gray-600' : 'bg-gray-100' : ''} ${darkMode ? 'text-gray-200 hover:bg-gray-600' : 'text-gray-700 hover:bg-gray-100'}`}
                                >
                                  <img src={DIET_IMAGE_MAP[diet]} alt={diet} width={20} height={20} className="object-contain" onError={(e) => { e.target.style.display = 'none' }} />
                                  {diet}
                                </button>
                              ))}
                            </div>
                          )}
                        </div>
                      )
                    })}
                  </div>
                </div>

                {/* BOTÕES */}
                <div className="flex gap-3 pt-4">
                  <button
                    onClick={() => { setShowEditPokemonModal(false); setShowDietSlotDropdown(null) }}
                    className={`flex-1 py-3 rounded-lg font-semibold ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                  >
                    Cancelar
                  </button>
                  <button
                    onClick={handleSaveEditPokemon}
                    className="flex-1 bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 font-semibold"
                  >
                    Salvar Edições
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Modal de Visualização de Informações do Pokémon */}
        {showPokemonInfoModal && viewingPokemon && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto`}>
              <div className={`sticky top-0 ${darkMode ? 'bg-gray-700' : 'bg-gradient-to-r from-blue-500 to-purple-600'} p-3 sm:p-5 md:p-6 rounded-t-2xl`}>
                <div className="flex justify-between items-center">
                  <h3 className="text-xl sm:text-2xl font-bold text-white">
                    {viewingPokemon.nickname || viewingPokemon.species}
                  </h3>
                  <button onClick={() => { setShowPokemonInfoModal(false); setViewingPokemon(null) }} className="text-white hover:text-gray-300">
                    <X size={28} />
                  </button>
                </div>
              </div>

              <div className={`p-3 sm:p-5 md:p-6 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                {/* Informações Básicas */}
                <div className="mb-6">
                  <h4 className={`text-lg font-bold mb-3 ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>Informações Básicas</h4>
                  <div className="grid grid-cols-2 gap-3 text-sm">
                    <div><span className="font-semibold">Apelido:</span> {viewingPokemon.nickname || '-'}</div>
                    <div><span className="font-semibold">Espécie:</span> {viewingPokemon.species || '-'}</div>
                    <div><span className="font-semibold">Nível:</span> {viewingPokemon.level || '-'}</div>
                    <div><span className="font-semibold">XP:</span> {getCurrentLevelXP(viewingPokemon)}/{getXPForNextLevel(viewingPokemon.level)}</div>
                    <div><span className="font-semibold">Natureza:</span> {viewingPokemon.nature || '-'}</div>
                    <div><span className="font-semibold">Gênero:</span> {viewingPokemon.gender || '-'}</div>
                    <div><span className="font-semibold">Felicidade:</span> {viewingPokemon.currentHappiness || 0}/{calculateMaxHappiness(viewingPokemon)}</div>
                    <div><span className="font-semibold">Peso:</span> {viewingPokemon.weight || '-'} kg</div>
                    <div><span className="font-semibold">Altura:</span> {viewingPokemon.height || '-'} m</div>
                    <div><span className="font-semibold">Lealdade:</span> {viewingPokemon.loyalty || '-'}</div>
                  </div>
                </div>

                {/* Capacidades */}
                {viewingPokemon.capacities && (viewingPokemon.capacities.forca || viewingPokemon.capacities.inteligencia || viewingPokemon.capacities.salto) && (
                  <div className="mb-6">
                    <h4 className={`text-lg font-bold mb-3 ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>Capacidades</h4>
                    <div className="grid grid-cols-3 gap-2 sm:gap-3 md:gap-4 text-sm">
                      {viewingPokemon.capacities.forca && (
                        <div className={`p-3 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-blue-50'}`}>
                          <div className="font-semibold text-blue-600">Força</div>
                          <div className="text-xl sm:text-2xl font-bold">{viewingPokemon.capacities.forca}</div>
                        </div>
                      )}
                      {viewingPokemon.capacities.inteligencia && (
                        <div className={`p-3 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-purple-50'}`}>
                          <div className="font-semibold text-purple-600">Inteligência</div>
                          <div className="text-xl sm:text-2xl font-bold">{viewingPokemon.capacities.inteligencia}</div>
                        </div>
                      )}
                      {viewingPokemon.capacities.salto && (
                        <div className={`p-3 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-green-50'}`}>
                          <div className="font-semibold text-green-600">Salto</div>
                          <div className="text-xl sm:text-2xl font-bold">{viewingPokemon.capacities.salto}</div>
                        </div>
                      )}
                    </div>
                  </div>
                )}

                {/* Atributos */}
                {(viewingPokemon.baseAttributes || viewingPokemon.levelPoints) && (
                  <div className="mb-6">
                    <h4 className={`text-lg font-bold mb-3 ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>Atributos</h4>
                    <div className="overflow-x-auto">
                      <table className={`w-full border-collapse ${darkMode ? 'bg-gray-700' : 'bg-white'}`}>
                        <thead>
                          <tr className={darkMode ? 'bg-gray-600' : 'bg-gray-200'}>
                            <th className={`border p-2 text-xs ${darkMode ? 'border-gray-500' : 'border-gray-300'}`}>Atributo</th>
                            <th className={`border p-2 text-xs ${darkMode ? 'border-gray-500' : 'border-gray-300'}`}>Basal</th>
                            <th className={`border p-2 text-xs ${darkMode ? 'border-gray-500' : 'border-gray-300'}`}>Atributo Bônus</th>
                            <th className={`border p-2 text-xs ${darkMode ? 'border-gray-500' : 'border-gray-300'}`}>Basal + Bônus + Nat.</th>
                            <th className={`border p-2 text-xs ${darkMode ? 'border-gray-500' : 'border-gray-300'}`}>Pontos Nível</th>
                            <th className={`border p-2 text-xs ${darkMode ? 'border-gray-500' : 'border-gray-300'}`}>Total</th>
                          </tr>
                        </thead>
                        <tbody>
                          {[
                            { label: 'Saúde', key: 'saude' },
                            { label: 'Ataque', key: 'ataque' },
                            { label: 'Defesa', key: 'defesa' },
                            { label: 'Ataque Especial', key: 'ataqueEspecial' },
                            { label: 'Defesa Especial', key: 'defesaEspecial' },
                            { label: 'Velocidade', key: 'velocidade' }
                          ].map(attr => {
                            const selectedNature = natures.find(n => n.nome === viewingPokemon.nature)
                            const isIncreased = selectedNature?.up === attr.label
                            const isDecreased = selectedNature?.down === attr.label
                            const baseVal = parseInt(viewingPokemon.baseAttributes?.[attr.key]) || 0
                            const bonusVal = parseInt(viewingPokemon.bonusPoints?.[attr.key]) || 0
                            const natureBonus = attr.key === 'saude' ? 1 : 2
                            const natureVal = isIncreased ? natureBonus : isDecreased ? -natureBonus : 0
                            const levelVal = parseInt(viewingPokemon.levelPoints?.[attr.key]) || 0
                            const basalBonusNat = baseVal + bonusVal + natureVal
                            const total = basalBonusNat + levelVal

                            return (
                              <tr key={attr.key}>
                                <td className={`border p-2 text-xs font-semibold ${darkMode ? 'border-gray-500' : 'border-gray-300'}`}>{attr.label}</td>
                                <td className={`border p-2 text-xs text-center ${darkMode ? 'border-gray-500' : 'border-gray-300'}`}>{baseVal || '-'}</td>
                                <td className={`border p-2 text-xs text-center ${darkMode ? 'border-gray-500' : 'border-gray-300'}`}>{bonusVal || '-'}</td>
                                <td className={`border p-2 text-xs text-center ${darkMode ? 'border-gray-500' : 'border-gray-300'}`}>{baseVal ? basalBonusNat : '-'}</td>
                                <td className={`border p-2 text-xs text-center ${darkMode ? 'border-gray-500' : 'border-gray-300'}`}>{levelVal || '-'}</td>
                                <td className={`border p-2 text-xs text-center font-bold ${darkMode ? 'border-gray-500' : 'border-gray-300'}`}>{baseVal ? total : '-'}</td>
                              </tr>
                            )
                          })}
                        </tbody>
                      </table>
                    </div>
                  </div>
                )}

                {/* Sabores */}
                {(viewingPokemon.nature) && (
                  <div className="mb-6">
                    <h4 className={`text-lg font-bold mb-3 ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>Preferências</h4>
                    <div className="grid grid-cols-2 gap-3 text-sm">
                      <div><span className="font-semibold">Sabor Predileto:</span> {viewingPokemon.favoriteFlavor || natures.find(n => n.nome === viewingPokemon.nature)?.gosto || '-'}</div>
                      <div><span className="font-semibold">Sabor que Não Gosta:</span> {viewingPokemon.dislikedFlavor || natures.find(n => n.nome === viewingPokemon.nature)?.desgosto || '-'}</div>
                    </div>
                  </div>
                )}

                {/* Deslocamento */}
                {viewingPokemon.displacement && (
                  <div className="mb-6">
                    <h4 className={`text-lg font-bold mb-3 ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>Deslocamento</h4>
                    <div className="grid grid-cols-2 md:grid-cols-3 gap-3 text-sm">
                      <div><span className="font-semibold">Terrestre:</span> {viewingPokemon.displacement.terrestre || '-'}</div>
                      <div><span className="font-semibold">Nadar:</span> {viewingPokemon.displacement.nadar || '-'}</div>
                      <div><span className="font-semibold">Voar:</span> {viewingPokemon.displacement.voar || '-'}</div>
                      <div><span className="font-semibold">Cavar:</span> {viewingPokemon.displacement.cavar || '-'}</div>
                      <div><span className="font-semibold">Submerso:</span> {viewingPokemon.displacement.submerso || '-'}</div>
                    </div>
                  </div>
                )}

                {/* Aptidões */}
                <div className="mb-6">
                  <h4 className={`text-lg font-bold mb-3 ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>Aptidões</h4>
                  <div className="flex flex-wrap gap-3">
                    {[
                      { key: 'estilo', label: 'Estilo', bg: darkMode ? 'bg-red-900' : 'bg-red-100', text: darkMode ? 'text-red-300' : 'text-red-600' },
                      { key: 'beleza', label: 'Beleza', bg: darkMode ? 'bg-blue-900' : 'bg-blue-100', text: darkMode ? 'text-blue-300' : 'text-blue-600' },
                      { key: 'ternura', label: 'Ternura', bg: darkMode ? 'bg-pink-900' : 'bg-pink-100', text: darkMode ? 'text-pink-300' : 'text-pink-600' },
                      { key: 'perspicacia', label: 'Perspicácia', bg: darkMode ? 'bg-green-900' : 'bg-green-100', text: darkMode ? 'text-green-300' : 'text-green-600' },
                      { key: 'vigor', label: 'Vigor', bg: darkMode ? 'bg-yellow-900' : 'bg-yellow-100', text: darkMode ? 'text-yellow-300' : 'text-yellow-600' }
                    ].map(apt => (
                      <div key={apt.key} className={`text-center px-4 py-2 rounded-lg ${apt.bg}`}>
                        <div className={`text-xs font-semibold ${apt.text}`}>{apt.label}</div>
                        <div className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{viewingPokemon.aptidoes?.[apt.key] ?? 0}</div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>

              <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-4 rounded-b-2xl flex justify-end`}>
                <button onClick={() => { setShowPokemonInfoModal(false); setViewingPokemon(null) }} className="bg-gray-500 text-white px-3 sm:px-5 md:px-6 py-2 rounded-lg hover:bg-gray-600 font-semibold">
                  Fechar
                </button>
              </div>
            </div>
          </div>
        )}


        {/* Modal de Edição de Aptidões */}
        {showAptidoesModal && aptidoesEditingPokemon && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowAptidoesModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-sm w-full`} onClick={e => e.stopPropagation()}>
              <div className={`${darkMode ? 'bg-gray-700' : 'bg-gradient-to-r from-indigo-500 to-purple-600'} p-4 rounded-t-2xl flex justify-between items-center`}>
                <div>
                  <h3 className="text-lg font-bold text-white flex items-center gap-2">
                    <TowerControl size={20} /> Aptidões
                  </h3>
                  <p className="text-indigo-200 text-xs mt-0.5">{aptidoesEditingPokemon.pokemon.nickname || aptidoesEditingPokemon.pokemon.species}</p>
                </div>
                <button onClick={() => setShowAptidoesModal(false)} className="text-white hover:text-gray-300"><X size={24} /></button>
              </div>
              <div className="p-5 space-y-3">
                {[
                  { key: 'estilo', label: 'Estilo', bg: darkMode ? 'bg-red-900' : 'bg-red-50', border: darkMode ? 'border-red-700' : 'border-red-300', text: darkMode ? 'text-red-300' : 'text-red-700' },
                  { key: 'beleza', label: 'Beleza', bg: darkMode ? 'bg-blue-900' : 'bg-blue-50', border: darkMode ? 'border-blue-700' : 'border-blue-300', text: darkMode ? 'text-blue-300' : 'text-blue-700' },
                  { key: 'ternura', label: 'Ternura', bg: darkMode ? 'bg-pink-900' : 'bg-pink-50', border: darkMode ? 'border-pink-700' : 'border-pink-300', text: darkMode ? 'text-pink-300' : 'text-pink-700' },
                  { key: 'perspicacia', label: 'Perspicácia', bg: darkMode ? 'bg-green-900' : 'bg-green-50', border: darkMode ? 'border-green-700' : 'border-green-300', text: darkMode ? 'text-green-300' : 'text-green-700' },
                  { key: 'vigor', label: 'Vigor', bg: darkMode ? 'bg-yellow-900' : 'bg-yellow-50', border: darkMode ? 'border-yellow-700' : 'border-yellow-300', text: darkMode ? 'text-yellow-300' : 'text-yellow-700' }
                ].map(apt => (
                  <div key={apt.key} className={`flex items-center justify-between gap-3 px-3 py-2 rounded-lg border ${apt.bg} ${apt.border}`}>
                    <span className={`font-semibold text-sm w-24 ${apt.text}`}>{apt.label}</span>
                    <div className="flex items-center gap-2">
                      <button
                        onClick={() => updateAptidao(apt.key, -1)}
                        className={`w-7 h-7 rounded flex items-center justify-center font-bold ${darkMode ? 'bg-gray-600 hover:bg-gray-500 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-800'}`}
                      >−</button>
                      <input
                        type="number"
                        min="0"
                        max="12"
                        value={aptidoesTempValues[apt.key] ?? 0}
                        onChange={e => {
                          const val = Math.max(0, Math.min(12, parseInt(e.target.value) || 0))
                          const others = Object.entries(aptidoesTempValues).filter(([k]) => k !== apt.key).reduce((s, [, v]) => s + (v || 0), 0)
                          const capped = Math.min(val, 20 - others)
                          setAptidoesTempValues(prev => ({ ...prev, [apt.key]: capped }))
                        }}
                        className={`w-12 text-center font-bold text-lg rounded border-2 ${darkMode ? 'bg-gray-700 border-gray-500 text-white' : 'bg-white border-gray-300 text-gray-800'}`}
                      />
                      <button
                        onClick={() => updateAptidao(apt.key, 1)}
                        className={`w-7 h-7 rounded flex items-center justify-center font-bold ${darkMode ? 'bg-gray-600 hover:bg-gray-500 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-800'}`}
                      >+</button>
                    </div>
                  </div>
                ))}
                <div className={`text-center text-xs pt-1 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                  Total: <span className={`font-bold ${Object.values(aptidoesTempValues).reduce((s, v) => s + (v || 0), 0) > 20 ? 'text-red-500' : darkMode ? 'text-white' : 'text-gray-800'}`}>
                    {Object.values(aptidoesTempValues).reduce((s, v) => s + (v || 0), 0)}
                  </span>/20 — Máx. por aptidão: 12
                </div>
              </div>
              <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-4 rounded-b-2xl flex gap-3 justify-end`}>
                <button onClick={() => setShowAptidoesModal(false)} className={`px-4 py-2 rounded-lg font-semibold ${darkMode ? 'bg-gray-600 text-gray-200 hover:bg-gray-500' : 'bg-gray-300 text-gray-700 hover:bg-gray-400'}`}>Cancelar</button>
                <button onClick={saveAptidoes} className="px-4 py-2 rounded-lg font-semibold bg-indigo-500 text-white hover:bg-indigo-600">Salvar</button>
              </div>
            </div>
          </div>
        )}

        {/* Modal de Tutoria de Golpes */}
        {showTutoriaModal && selectedPokemonForTutoria && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowTutoriaModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-sm sm:max-w-2xl md:max-w-4xl w-full max-h-[90vh] overflow-y-auto`} onClick={(e) => e.stopPropagation()}>
              <div className="p-3 sm:p-5 md:p-6">
                <div className="flex justify-between items-center mb-6">
                  <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                    Tutoria de Golpes - {selectedPokemonForTutoria.nickname}
                  </h3>
                  <button onClick={() => setShowTutoriaModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                    <X size={24} />
                  </button>
                </div>

                {/* Golpes Selecionados */}
                <div className="mb-6">
                  <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Golpes Selecionados ({tutoriaSelectedGolpes.length}/8)
                  </label>
                  {tutoriaSelectedGolpes.length === 0 ? (
                    <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'} text-center ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                      Nenhum golpe selecionado
                    </div>
                  ) : (
                    <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'} flex flex-wrap gap-2`}>
                      {tutoriaSelectedGolpes.map((golpe, idx) => (
                        <div key={idx} className={`flex items-center gap-2 px-3 py-2 rounded ${darkMode ? 'bg-orange-600 text-white' : 'bg-orange-500 text-white'}`}>
                          <span className="font-semibold">{golpe}</span>
                          <button onClick={() => handleRemoveGolpeFromSelected(golpe)} className="hover:bg-red-500 rounded p-1">
                            <X size={16} />
                          </button>
                        </div>
                      ))}
                    </div>
                  )}
                </div>

                {/* Busca de Golpes */}
                <div className="mb-4">
                  <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Busca de Golpes
                  </label>
                  <div className="relative">
                    <Search className={`absolute left-3 top-1/2 transform -translate-y-1/2 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`} size={20} />
                    <input
                      type="text"
                      value={tutoriaGolpesSearch}
                      onChange={(e) => setTutoriaGolpesSearch(e.target.value)}
                      className={`w-full pl-10 pr-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                      placeholder="Digite o nome do golpe..."
                    />
                  </div>
                </div>

                {/* Golpes Disponíveis */}
                <div className="mb-6">
                  <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Golpes Disponíveis
                  </label>
                  <div className={`max-h-64 overflow-y-auto ${darkMode ? 'bg-gray-700' : 'bg-gray-100'} rounded-lg p-4 space-y-2`}>
                    {GOLPES_NAMES
                      .filter(golpe => golpe.toLowerCase().includes(tutoriaGolpesSearch.toLowerCase()))
                      .filter(golpe => !tutoriaSelectedGolpes.includes(golpe))
                      .map((golpe, idx) => (
                        <div key={idx} className={`flex items-center justify-between p-3 rounded ${darkMode ? 'bg-gray-600 hover:bg-gray-500' : 'bg-white hover:bg-gray-50'} transition-colors`}>
                          <div className="flex-1">
                            <span className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{golpe}</span>
                            <div className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'} mt-1`}>
                              <span className="mr-3">Tipo: {GOLPES_DATA[golpe].tipo}</span>
                              <span className="mr-3">Aptidão: {GOLPES_DATA[golpe].aptidao}</span>
                              <span className="mr-3">Dano: {GOLPES_DATA[golpe].danoBasal || '-'}</span>
                              <span>Freq: {GOLPES_DATA[golpe].frequencia}</span>
                            </div>
                          </div>
                          <button
                            onClick={() => handleAddGolpeToSelected(golpe)}
                            className={`ml-2 p-2 rounded ${darkMode ? 'bg-green-600 hover:bg-green-700' : 'bg-green-500 hover:bg-green-600'} text-white`}
                          >
                            <Plus size={16} />
                          </button>
                        </div>
                      ))}
                  </div>
                </div>

                {/* Botões */}
                <div className="flex gap-3">
                  <button
                    onClick={() => setShowTutoriaModal(false)}
                    className={`flex-1 py-3 rounded-lg font-semibold ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                  >
                    Cancelar
                  </button>
                  <button
                    onClick={handleSaveGolpes}
                    className="flex-1 bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 font-semibold"
                    disabled={tutoriaSelectedGolpes.length < 1}
                  >
                    Salvar Golpes
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Modal de Detalhes do Golpe */}
        {showGolpeDetailModal && selectedGolpeForDetail && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowGolpeDetailModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] flex flex-col`} onClick={(e) => e.stopPropagation()}>
              <div className="p-3 sm:p-5 md:p-6 border-b border-gray-700">
                <div className="flex justify-between items-center">
                  <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                    {selectedGolpeForDetail}
                  </h3>
                  <button onClick={() => setShowGolpeDetailModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                    <X size={24} />
                  </button>
                </div>
              </div>

              <div className="overflow-y-auto flex-1 p-3 sm:p-5 md:p-6">
                <div className={`space-y-4 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  <div className="grid grid-cols-2 gap-2 sm:gap-3 md:gap-4">
                    <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                      <div className={`text-sm font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Tipo</div>
                      <div className="text-lg font-bold">{GOLPES_DATA[selectedGolpeForDetail].tipo}</div>
                    </div>
                    <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                      <div className={`text-sm font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Aptidão</div>
                      <div className="text-lg font-bold">{GOLPES_DATA[selectedGolpeForDetail].aptidao}</div>
                    </div>
                    <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                      <div className={`text-sm font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Dano Basal</div>
                      <div className="text-lg font-bold">{GOLPES_DATA[selectedGolpeForDetail].danoBasal || '-'}</div>
                    </div>
                    <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                      <div className={`text-sm font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Acurácia</div>
                      <div className="text-lg font-bold">{GOLPES_DATA[selectedGolpeForDetail].acuracia}</div>
                    </div>
                    <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                      <div className={`text-sm font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Frequência</div>
                      <div className="text-lg font-bold">{GOLPES_DATA[selectedGolpeForDetail].frequencia}</div>
                    </div>
                    <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                      <div className={`text-sm font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Alcance</div>
                      <div className="text-lg font-bold">{GOLPES_DATA[selectedGolpeForDetail].alcance}</div>
                    </div>
                    <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                      <div className={`text-sm font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Descritores</div>
                      <div className="text-lg font-bold">{GOLPES_DATA[selectedGolpeForDetail].descritores || '-'}</div>
                    </div>
                    <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                      <div className={`text-sm font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Tag de Concurso</div>
                      <div className="text-lg font-bold">{GOLPES_DATA[selectedGolpeForDetail].tagConcurso}</div>
                    </div>
                  </div>
                  <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                    <div className={`text-sm font-semibold mb-2 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Efeito</div>
                    <div className="text-base">{renderGolpeEfeito(GOLPES_DATA[selectedGolpeForDetail].efeito, darkMode)}</div>
                  </div>
                </div>
              </div>

              <div className="p-3 sm:p-5 md:p-6 border-t border-gray-700">
                <button
                  onClick={() => setShowGolpeDetailModal(false)}
                  className={`w-full py-3 rounded-lg font-semibold ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                >
                  Fechar
                </button>
              </div>
            </div>
          </div>
        )}

        {/* MODAL DE HELD ITEM - TIME PRINCIPAL */}
        {showHeldItemModal && selectedPokemonForHeldItem && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowHeldItemModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-2xl w-full`} onClick={(e) => e.stopPropagation()}>
              <div className="p-3 sm:p-5 md:p-6">
                <div className="flex justify-between items-center mb-6">
                  <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-gray-200' : 'text-gray-800'}`}>
                    Held Item - {selectedPokemonForHeldItem.nickname}
                  </h3>
                  <button onClick={() => setShowHeldItemModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                    <X size={24} />
                  </button>
                </div>

                <div className="mb-4">
                  <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Nome do Item
                  </label>
                  <input
                    type="text"
                    value={heldItemName}
                    onChange={(e) => setHeldItemName(e.target.value)}
                    className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                    placeholder="Digite o nome do item..."
                  />
                </div>

                <div className="mb-6">
                  <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Descrição / Efeito
                  </label>
                  <textarea
                    value={heldItemDescription}
                    onChange={(e) => setHeldItemDescription(e.target.value)}
                    className={`w-full px-4 py-2 border-2 rounded-lg min-h-[120px] ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                    placeholder="Digite a descrição e efeito do item..."
                  />
                </div>

                <div className="flex gap-3">
                  <button
                    onClick={() => setShowHeldItemModal(false)}
                    className={`flex-1 py-3 rounded-lg font-semibold ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                  >
                    Cancelar
                  </button>
                  <button
                    onClick={handleSaveHeldItem}
                    className="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600 font-semibold"
                  >
                    Salvar Item
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* MODAL DE HABILIDADES - TIME PRINCIPAL */}
        {showHabilidadesModal && selectedPokemonForHabilidades && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowHabilidadesModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-sm sm:max-w-2xl md:max-w-4xl w-full max-h-[90vh] overflow-y-auto`} onClick={(e) => e.stopPropagation()}>
              <div className="p-3 sm:p-5 md:p-6">
                <div className="flex justify-between items-center mb-6">
                  <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-teal-400' : 'text-teal-700'}`}>
                    Selecionar Habilidades - {selectedPokemonForHabilidades.nickname}
                  </h3>
                  <button onClick={() => setShowHabilidadesModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                    <X size={24} />
                  </button>
                </div>

                <div className="mb-6">
                  <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Habilidades Selecionadas ({habilidadesSelectedList.length}/2)
                  </label>
                  {habilidadesSelectedList.length === 0 ? (
                    <div className={`p-4 rounded-lg text-center ${darkMode ? 'bg-gray-700 text-gray-400' : 'bg-gray-100 text-gray-500'}`}>
                      Nenhuma habilidade selecionada
                    </div>
                  ) : (
                    <div className={`p-4 rounded-lg flex flex-wrap gap-2 ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                      {habilidadesSelectedList.map((hab, idx) => (
                        <div key={idx} className={`flex items-center gap-2 px-3 py-2 rounded ${darkMode ? 'bg-teal-600 text-white' : 'bg-teal-500 text-white'}`}>
                          <button
                            onClick={() => {
                              setSelectedHabilidadeForDetail(hab)
                              setShowHabilidadeDetailModal(true)
                            }}
                            className="font-semibold hover:underline"
                          >
                            {hab}
                          </button>
                          <button
                            onClick={() => handleRemoveHabilidadeFromSelected(hab)}
                            className="hover:bg-red-500 rounded p-1"
                          >
                            <X size={16} />
                          </button>
                        </div>
                      ))}
                    </div>
                  )}
                </div>

                <div className="mb-4">
                  <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Buscar Habilidades
                  </label>
                  <div className="relative">
                    <Search className={`absolute left-3 top-1/2 transform -translate-y-1/2 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`} size={20} />
                    <input
                      type="text"
                      value={habilidadesSearch}
                      onChange={(e) => setHabilidadesSearch(e.target.value)}
                      className={`w-full pl-10 pr-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                      placeholder="Digite o nome da habilidade..."
                    />
                  </div>
                </div>

                <div className="mb-6">
                  <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Habilidades Disponíveis
                  </label>
                  <div className={`max-h-64 overflow-y-auto rounded-lg p-4 space-y-2 ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                    {HABILIDADES_NAMES.length === 0 ? (
                      <div className={`p-4 text-center ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                        Nenhuma habilidade disponível
                      </div>
                    ) : HABILIDADES_NAMES
                      .filter(hab => hab.toLowerCase().includes(habilidadesSearch.toLowerCase()))
                      .filter(hab => !habilidadesSelectedList.includes(hab))
                      .length === 0 ? (
                      <div className={`p-4 text-center ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                        Nenhuma habilidade encontrada
                      </div>
                    ) : (
                      HABILIDADES_NAMES
                        .filter(hab => hab.toLowerCase().includes(habilidadesSearch.toLowerCase()))
                        .filter(hab => !habilidadesSelectedList.includes(hab))
                        .map((hab, idx) => (
                          <div key={idx} className={`flex items-center justify-between p-3 rounded transition-colors ${darkMode ? 'bg-gray-600 hover:bg-gray-500' : 'bg-white hover:bg-gray-50'}`}>
                            <div className="flex-1">
                              <button
                                onClick={() => {
                                  setSelectedHabilidadeForDetail(hab)
                                  setShowHabilidadeDetailModal(true)
                                }}
                                className={`font-semibold hover:underline text-left ${darkMode ? 'text-white' : 'text-gray-800'}`}
                              >
                                {hab}
                              </button>
                              <div className={`text-xs mt-1 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                <span className="mr-3">Ativação: {HABILIDADES_DATA[hab]?.ativacao || 'N/A'}</span>
                              </div>
                            </div>
                            <button
                              onClick={() => handleAddHabilidadeToSelected(hab)}
                              className={`ml-2 p-2 rounded text-white ${darkMode ? 'bg-green-600 hover:bg-green-700' : 'bg-green-500 hover:bg-green-600'}`}
                            >
                              <Plus size={16} />
                            </button>
                          </div>
                        ))
                    )}
                  </div>
                </div>

                <div className="flex gap-3">
                  <button
                    onClick={() => setShowHabilidadesModal(false)}
                    className={`flex-1 py-3 rounded-lg font-semibold ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                  >
                    Cancelar
                  </button>
                  <button
                    onClick={handleSaveHabilidades}
                    className="flex-1 bg-teal-500 text-white py-3 rounded-lg hover:bg-teal-600 font-semibold"
                    disabled={habilidadesSelectedList.length < 1}
                  >
                    Salvar Habilidades
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}
        {/* MODAL POKÉBOLA DE CAPTURA - TIME PRINCIPAL */}
        {showPokeballModal && selectedPokemonForPokeball && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowPokeballModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto`} onClick={(e) => e.stopPropagation()}>
              <div className="p-3 sm:p-5 md:p-6">
                <div className="flex justify-between items-center mb-6">
                  <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-purple-400' : 'text-purple-700'}`}>
                    Pokébola de Captura - {selectedPokemonForPokeball.nickname}
                  </h3>
                  <button onClick={() => setShowPokeballModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                    <X size={24} />
                  </button>
                </div>

                <div className="mb-4">
                  <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Buscar Pokébola
                  </label>
                  <div className="relative">
                    <Search className={`absolute left-3 top-1/2 transform -translate-y-1/2 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`} size={20} />
                    <input
                      type="text"
                      value={pokeballSearch}
                      onChange={(e) => setPokeballSearch(e.target.value)}
                      className={`w-full pl-10 pr-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                      placeholder="Digite o nome da pokébola..."
                    />
                  </div>
                </div>

                <div className="mb-6">
                  <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Pokébolas Disponíveis
                  </label>
                  <div className={`max-h-96 overflow-y-auto rounded-lg p-4 grid grid-cols-2 md:grid-cols-3 gap-3 ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                    {POKEBALLS_LIST
                      .filter(ball => ball.toLowerCase().includes(pokeballSearch.toLowerCase()))
                      .map((ball, idx) => (
                        <button
                          key={idx}
                          onClick={() => handleSelectPokeball(ball)}
                          className={`p-3 rounded-lg flex flex-col items-center gap-2 transition-all border-2 ${
                            selectedPokeballForPC === ball
                              ? darkMode ? 'bg-purple-600 border-purple-400' : 'bg-purple-200 border-purple-500'
                              : darkMode ? 'bg-gray-600 hover:bg-gray-500 border-transparent' : 'bg-white hover:bg-gray-50 border-transparent'
                          }`}
                        >
                          <img
                            src={ball === 'Custom Pokeball' ? `/pokeballs/custompokeball.png` : `/pokeballs/${ball.toLowerCase().replace(/\s+/g, '')}.png`}
                            alt={ball}
                            className="w-16 h-16 object-contain"
                          />
                          <span className={`text-xs font-semibold text-center ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                            {ball}
                          </span>
                        </button>
                      ))}
                  </div>
                </div>

                <div className="flex gap-3">
                  <button
                    onClick={() => setShowPokeballModal(false)}
                    className={`flex-1 py-3 rounded-lg font-semibold ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                  >
                    Cancelar
                  </button>
                  <button
                    onClick={handleSavePokeball}
                    className="flex-1 bg-purple-500 text-white py-3 rounded-lg hover:bg-purple-600 font-semibold"
                    disabled={!selectedPokeballForPC}
                  >
                    Salvar Pokébola
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* MODAL DE CUSTOM POKEBALL OPTIONS */}
        {showCustomPokeballOptions && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4" onClick={handleCancelCustomPokeball}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl max-w-md w-full shadow-2xl`} onClick={(e) => e.stopPropagation()}>
              <div className="p-3 sm:p-5 md:p-6">
                <div className="flex justify-between items-center mb-6">
                  <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-purple-400' : 'text-purple-700'}`}>
                    Custom Pokeball
                  </h3>
                  <button onClick={handleCancelCustomPokeball} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                    <X size={24} />
                  </button>
                </div>

                <div className="mb-6">
                  <label className={`block text-sm font-bold mb-3 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Escolha como adicionar a imagem
                  </label>
                  <div className="flex gap-3 mb-4">
                    <button
                      onClick={() => setCustomPokeballUploadType('link')}
                      className={`flex-1 py-2 px-4 rounded-lg font-semibold transition-all ${
                        customPokeballUploadType === 'link'
                          ? darkMode ? 'bg-purple-600 text-white' : 'bg-purple-500 text-white'
                          : darkMode ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                      }`}
                    >
                      Link
                    </button>
                    <button
                      onClick={() => setCustomPokeballUploadType('file')}
                      className={`flex-1 py-2 px-4 rounded-lg font-semibold transition-all ${
                        customPokeballUploadType === 'file'
                          ? darkMode ? 'bg-purple-600 text-white' : 'bg-purple-500 text-white'
                          : darkMode ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                      }`}
                    >
                      Upload
                    </button>
                  </div>

                  {customPokeballUploadType === 'link' ? (
                    <div>
                      <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                        URL da Imagem
                      </label>
                      <input
                        type="text"
                        value={customPokeballLink}
                        onChange={(e) => setCustomPokeballLink(e.target.value)}
                        className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                        placeholder="https://exemplo.com/pokeball.png"
                      />
                      {customPokeballLink && (
                        <div className="mt-3 p-3 rounded-lg border-2 border-dashed border-gray-500 flex justify-center">
                          <img src={customPokeballLink} alt="Preview" className="w-20 h-20 object-contain" onError={(e) => e.target.style.display = 'none'} />
                        </div>
                      )}
                    </div>
                  ) : (
                    <div>
                      <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                        Selecionar Arquivo
                      </label>
                      <input
                        type="file"
                        accept="image/*"
                        onChange={(e) => setCustomPokeballFile(e.target.files[0])}
                        className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                      />
                      {customPokeballFile && (
                        <div className="mt-3 p-3 rounded-lg border-2 border-dashed border-gray-500 flex justify-center">
                          <img src={URL.createObjectURL(customPokeballFile)} alt="Preview" className="w-20 h-20 object-contain" />
                        </div>
                      )}
                    </div>
                  )}
                </div>

                <div className="flex gap-3">
                  <button
                    onClick={handleCancelCustomPokeball}
                    className={`flex-1 py-3 rounded-lg font-semibold ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                  >
                    Cancelar
                  </button>
                  <button
                    onClick={handleConfirmCustomPokeball}
                    className="flex-1 bg-purple-500 text-white py-3 rounded-lg hover:bg-purple-600 font-semibold"
                  >
                    Confirmar
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Modal de Detalhes da Habilidade - Treinador */}
        {showHabilidadeDetailModal && selectedHabilidadeForDetail && HABILIDADES_DATA?.[selectedHabilidadeForDetail] && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowHabilidadeDetailModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-3 sm:p-5 md:p-8 rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto`} onClick={(e) => e.stopPropagation()}>
              <div className="flex justify-between items-center mb-6">
                <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-teal-400' : 'text-teal-700'}`}>{selectedHabilidadeForDetail}</h3>
                <button onClick={() => setShowHabilidadeDetailModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                  <X size={24} />
                </button>
              </div>
              <div className={`mb-4 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                <p className="mb-2">
                  <span className="font-semibold">Ativação:</span>{' '}
                  <span className={`px-2 py-1 rounded ${darkMode ? 'bg-teal-900 text-teal-300' : 'bg-teal-100 text-teal-800'}`}>
                    {HABILIDADES_DATA[selectedHabilidadeForDetail]?.ativacao || 'N/A'}
                  </span>
                </p>
              </div>
              <div className={`${darkMode ? 'text-gray-300' : 'text-gray-700'} text-base leading-relaxed`}>
                <p className="font-semibold mb-2">Efeito:</p>
                <p>{HABILIDADES_DATA[selectedHabilidadeForDetail]?.efeito || 'Descrição não disponível'}</p>

                {/* Tabela da Habilidade (se houver) */}
                {HABILIDADES_DATA[selectedHabilidadeForDetail]?.tabela && (
                  <div className="mt-4 overflow-x-auto">
                    <table className={`w-full text-sm border-collapse ${
                      darkMode ? 'border-gray-600' : 'border-gray-300'
                    }`}>
                      <thead>
                        <tr className={darkMode ? 'bg-gray-700' : 'bg-teal-100'}>
                          {Object.keys(HABILIDADES_DATA[selectedHabilidadeForDetail].tabela[0]).map(key => (
                            <th key={key} className={`border p-2 font-semibold text-left ${
                              darkMode ? 'border-gray-600 text-teal-300' : 'border-gray-300 text-teal-900'
                            }`}>
                              {key === 'resultado' ? 'Resultado' :
                               key === 'efeito' ? 'Efeito' :
                               key === 'item' ? 'Item' :
                               key === 'clima' ? 'Clima' :
                               key === 'tipo' ? 'Tipo' :
                               key === 'dado' ? 'Dado' :
                               key.charAt(0).toUpperCase() + key.slice(1)}
                            </th>
                          ))}
                        </tr>
                      </thead>
                      <tbody>
                        {HABILIDADES_DATA[selectedHabilidadeForDetail].tabela.map((linha, idx) => (
                          <tr key={idx} className={idx % 2 === 0
                            ? (darkMode ? 'bg-gray-800' : 'bg-white')
                            : (darkMode ? 'bg-gray-750' : 'bg-teal-50')
                          }>
                            {Object.keys(linha).map(key => (
                              <td key={key} className={`border p-2 ${
                                key === 'resultado'
                                  ? `font-bold ${darkMode ? 'border-gray-600 text-teal-400' : 'border-gray-300 text-teal-700'}`
                                  : `${darkMode ? 'border-gray-600 text-gray-300' : 'border-gray-300 text-gray-700'}`
                              }`}>
                                {linha[key]}
                              </td>
                            ))}
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                )}
              </div>
              <div className="flex justify-end mt-6">
                <button
                  onClick={() => setShowHabilidadeDetailModal(false)}
                  className="bg-teal-500 text-white px-3 sm:px-5 md:px-6 py-2 rounded-lg hover:bg-teal-600 font-semibold"
                >
                  Fechar
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Modal de Informação de Capacidade - Treinador */}
        {showCapacityInfoModal && selectedCapacityForInfo && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowCapacityInfoModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-3 sm:p-5 md:p-8 rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto`} onClick={(e) => e.stopPropagation()}>
              <div className="flex justify-between items-center mb-6">
                <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{selectedCapacityForInfo}</h3>
                <button onClick={() => setShowCapacityInfoModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                  <X size={24} />
                </button>
              </div>
              <div className={`${darkMode ? 'text-gray-300' : 'text-gray-700'} text-base leading-relaxed`}>
                {typeof CAPACIDADES_DATA[selectedCapacityForInfo] === 'string'
                  ? CAPACIDADES_DATA[selectedCapacityForInfo]
                  : CAPACIDADES_DATA[selectedCapacityForInfo].descricao}

                {/* Tabela da Capacidade (se houver) */}
                {typeof CAPACIDADES_DATA[selectedCapacityForInfo] === 'object' && CAPACIDADES_DATA[selectedCapacityForInfo].tabela && (
                  <div className="mt-4 overflow-x-auto">
                    <table className={`w-full text-sm border-collapse ${
                      darkMode ? 'border-gray-600' : 'border-gray-300'
                    }`}>
                      <thead>
                        <tr className={darkMode ? 'bg-gray-700' : 'bg-gray-100'}>
                          {Object.keys(CAPACIDADES_DATA[selectedCapacityForInfo].tabela[0]).map(key => (
                            <th key={key} className={`border p-2 font-semibold text-left ${
                              darkMode ? 'border-gray-600 text-teal-300' : 'border-gray-300 text-gray-800'
                            }`}>
                              {key === 'força' ? 'Força' :
                               key === 'peso' ? 'Peso Erguido' :
                               key === 'inteligência' ? 'Inteligência' :
                               key === 'intelecto' ? 'Intelecto' :
                               key === 'pensamentos' ? 'Pensamentos' :
                               key === 'salto' ? 'Salto' :
                               key === 'altura' ? 'Altura' :
                               key === 'resultado' ? 'Resultado' :
                               key === 'área' ? 'Área' :
                               key === 'par' ? 'Par de Espécies' :
                               key === 'condição' ? 'Condição' :
                               key.charAt(0).toUpperCase() + key.slice(1)}
                            </th>
                          ))}
                        </tr>
                      </thead>
                      <tbody>
                        {CAPACIDADES_DATA[selectedCapacityForInfo].tabela.map((linha, idx) => (
                          <tr key={idx} className={idx % 2 === 0
                            ? (darkMode ? 'bg-gray-800' : 'bg-white')
                            : (darkMode ? 'bg-gray-750' : 'bg-gray-50')
                          }>
                            {Object.keys(linha).map(key => (
                              <td key={key} className={`border p-2 ${
                                ['força', 'inteligência', 'salto', 'resultado'].includes(key)
                                  ? `font-bold ${darkMode ? 'border-gray-600 text-teal-400' : 'border-gray-300 text-teal-700'}`
                                  : `${darkMode ? 'border-gray-600 text-gray-300' : 'border-gray-300 text-gray-700'}`
                              }`}>
                                {linha[key]}
                              </td>
                            ))}
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                )}
              </div>
              <div className="flex justify-end mt-6">
                <button
                  onClick={() => setShowCapacityInfoModal(false)}
                  className="bg-blue-500 text-white px-3 sm:px-5 md:px-6 py-2 rounded-lg hover:bg-blue-600 font-semibold"
                >
                  Fechar
                </button>
              </div>
            </div>
          </div>
        )}

        {/* MODAL DE EDIÇÃO DE TIPOS DO POKÉMON (ELEMENTALISTA) - ÁREA TREINADOR */}
        {showPokemonTypeEditModal && selectedPokemonForTypeEdit && pokemonTypeEditSource === 'team' && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowPokemonTypeEditModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto`} onClick={(e) => e.stopPropagation()}>
              <div className="p-3 sm:p-5 md:p-6">
                <div className="flex justify-between items-center mb-6">
                  <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-orange-400' : 'text-orange-700'} flex items-center gap-2`}>
                    <Flame size={28} />
                    Editar Tipos - {selectedPokemonForTypeEdit.nickname}
                  </h3>
                  <button onClick={() => setShowPokemonTypeEditModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                    <X size={24} />
                  </button>
                </div>

                {/* Tipos Selecionados */}
                <div className="mb-6">
                  <h4 className={`text-lg font-bold mb-3 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Tipos Selecionados ({getPokemonTypes(selectedPokemonForTypeEdit).length})
                  </h4>
                  {getPokemonTypes(selectedPokemonForTypeEdit).length > 0 ? (
                    <div className="flex flex-wrap gap-2">
                      {getPokemonTypes(selectedPokemonForTypeEdit).map((type, idx) => (
                        <div
                          key={idx}
                          className="flex items-center gap-2 px-3 py-2 rounded-lg font-semibold text-white shadow-md"
                          style={{
                            background: TYPE_STYLES[type]?.gradient || 'linear-gradient(135deg, #718096 0%, #4A5568 100%)',
                          }}
                        >
                          <span>{type}</span>
                          <button
                            onClick={() => {
                              const currentTypes = getPokemonTypes(selectedPokemonForTypeEdit)
                              if (currentTypes.length > 1) {
                                const newTypes = currentTypes.filter((_, i) => i !== idx)
                                setSelectedPokemonForTypeEdit({
                                  ...selectedPokemonForTypeEdit,
                                  types: newTypes
                                })
                              } else {
                                alert('Um Pokémon deve ter pelo menos um tipo!')
                              }
                            }}
                            className="hover:bg-black/20 rounded-full p-0.5"
                            title="Remover tipo"
                          >
                            <X size={16} />
                          </button>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <p className={`text-sm italic ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                      Nenhum tipo selecionado
                    </p>
                  )}
                </div>

                {/* Tipos Disponíveis */}
                <div className="mb-6">
                  <h4 className={`text-lg font-bold mb-3 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Tipos Disponíveis
                  </h4>
                  <div className="grid grid-cols-2 sm:grid-cols-3 gap-3">
                    {POKEMON_TYPES.map((type) => {
                      const isSelected = getPokemonTypes(selectedPokemonForTypeEdit).includes(type)
                      return (
                        <button
                          key={type}
                          onClick={() => {
                            const currentTypes = getPokemonTypes(selectedPokemonForTypeEdit)
                            if (!isSelected && currentTypes.length < 3) {
                              const newTypes = [...currentTypes, type]
                              setSelectedPokemonForTypeEdit({
                                ...selectedPokemonForTypeEdit,
                                types: newTypes
                              })
                            } else if (!isSelected && currentTypes.length >= 3) {
                              alert('Um Pokémon pode ter no máximo 3 tipos!')
                            }
                          }}
                          disabled={isSelected}
                          className={`px-4 py-3 rounded-lg font-semibold text-white shadow-md transition-all ${
                            isSelected ? 'opacity-50 cursor-not-allowed' : 'hover:opacity-80 cursor-pointer'
                          }`}
                          style={{
                            background: TYPE_STYLES[type]?.gradient || 'linear-gradient(135deg, #718096 0%, #4A5568 100%)',
                          }}
                        >
                          {type}
                        </button>
                      )
                    })}
                  </div>
                </div>

                {/* Botões de Ação */}
                <div className="flex gap-3">
                  <button
                    onClick={() => setShowPokemonTypeEditModal(false)}
                    className={`py-3 px-4 rounded-lg font-semibold ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-800'}`}
                  >
                    Cancelar
                  </button>
                  <button
                    onClick={() => {
                      if (confirm('Deseja restaurar a tipagem original do Pokémon?')) {
                        const pokemonIndex = mainTeam.findIndex(p => p.id === selectedPokemonForTypeEdit.id)
                        if (pokemonIndex !== -1) {
                          const updatedTeam = [...mainTeam]
                          // Remover a propriedade types customizada
                          const { types, ...pokemonWithoutCustomTypes } = updatedTeam[pokemonIndex]
                          updatedTeam[pokemonIndex] = pokemonWithoutCustomTypes
                          setMainTeam(updatedTeam)
                        }
                        setShowPokemonTypeEditModal(false)
                        setSelectedPokemonForTypeEdit(null)
                        setPokemonTypeEditSource(null)
                      }
                    }}
                    className={`py-3 px-4 rounded-lg font-semibold ${darkMode ? 'bg-yellow-600 hover:bg-yellow-700 text-white' : 'bg-yellow-500 hover:bg-yellow-600 text-white'} shadow-lg`}
                  >
                    Restaurar tipagem
                  </button>
                  <button
                    onClick={() => {
                      const updatedTypes = getPokemonTypes(selectedPokemonForTypeEdit)
                      const pokemonIndex = mainTeam.findIndex(p => p.id === selectedPokemonForTypeEdit.id)
                      if (pokemonIndex !== -1) {
                        const updatedTeam = [...mainTeam]
                        updatedTeam[pokemonIndex] = {
                          ...updatedTeam[pokemonIndex],
                          types: updatedTypes
                        }
                        setMainTeam(updatedTeam)
                      }
                      setShowPokemonTypeEditModal(false)
                      setSelectedPokemonForTypeEdit(null)
                      setPokemonTypeEditSource(null)
                    }}
                    className="flex-1 bg-gradient-to-r from-orange-600 to-red-700 text-white py-3 rounded-lg hover:opacity-90 font-semibold shadow-lg"
                  >
                    Salvar Tipos
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        </div>
        {accountDataModal}
        {scenarioPopupOverlay}
        {mostrarTriunfosOverlay}
        {pokezapPanel}{pokeAgendaPanel}
        {batalhaChatPanel}
      </>
    )
  }

  // ÁREA DO PC
  if (currentUser.type === 'treinador' && currentArea === 'PC') {
    return (
      <>
        <div className={`min-h-screen ${mainBgClass}`}>
          {sidebarNav}
        <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-lg`}>
          <div className="max-w-7xl mx-auto px-4 py-4">
            <div className="flex justify-between items-center mb-4">
              <div className="flex items-center gap-3"><button onClick={() => setSidebarOpen(true)} className={`p-2 rounded-lg ${darkMode ? "hover:bg-gray-700 text-gray-400" : "hover:bg-gray-200 text-gray-500"}`}><Menu size={24} /></button><h2 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>PC ({pcPokemon.length}/1000)</h2></div>
              <div className="flex gap-2 items-center">
                <button onClick={() => setShowAccountDataModal(true)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-200 text-gray-700'}`} title="Dados da Conta"><ArrowDownUp size={20} /></button>
                <button onClick={() => setDarkMode(!darkMode)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-yellow-400' : 'bg-gray-200 text-gray-700'}`}>{darkMode ? <Sun size={20} /> : <Moon size={20} />}</button>
                {pokezapBtn}{pokeAgendaBtn}{batalhaChatBtn}<button onClick={handleLogout} className="bg-red-500 text-white px-3 sm:px-5 md:px-6 py-2 rounded-lg hover:bg-red-600">Sair</button>
                {currentClima && <div className="flex items-center gap-1.5 ml-1"><img src={`/pokeballs/${currentClima.image}`} alt={currentClima.name} className="w-7 h-7" /><span className={`text-xs font-semibold ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>{currentClima.name}</span></div>}
              </div>
            </div>
          </div>
        </div>

        <div className="max-w-7xl mx-auto px-4 py-3 sm:py-5 md:py-8">
          <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-8`}>
            <div className="flex justify-between items-center mb-6">
              <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Pokémon Armazenados</h3>
              <div className="flex gap-3">
                <button
                  onClick={() => setShowSwapPokemonModal(true)}
                  className="bg-purple-500 text-white p-2 rounded-lg hover:bg-purple-600"
                  title="Move Pokémon"
                >
                  <MoveVertical size={20} />
                </button>
                <button
                  onClick={() => {
                    setShowSedexPkmModal(true)
                    setSedexPkmSearch('')
                    setSelectedSedexPkm(null)
                    setSelectedSedexPkmTrainer('')
                  }}
                  className="bg-gradient-to-r from-green-600 to-emerald-700 text-white px-3 sm:px-5 md:px-6 py-2 rounded-lg hover:from-green-700 hover:to-emerald-800 font-semibold flex items-center gap-2"
                >
                  📦 Sedex Pkm
                </button>
              </div>
            </div>

            {pcPokemon.length > 0 && (
              <div className="mb-6 space-y-4">
                {/* Barra de Pesquisa */}
                <div className="relative">
                  <Search className={`absolute left-3 top-1/2 transform -translate-y-1/2 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`} size={20} />
                  <input
                    type="text"
                    value={pcSearchQuery}
                    onChange={e => { setPcSearchQuery(e.target.value); setPcPage(0) }}
                    placeholder="Pesquisar por nome ou espécie..."
                    className={`w-full pl-10 pr-4 py-3 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'border-gray-300 placeholder-gray-500'}`}
                  />
                </div>

                {/* Filtro de Tipo */}
                <div className="flex items-center gap-2">
                  <label className={`font-semibold ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Filtrar por tipo:
                  </label>
                  <select
                    value={pcTypeFilter}
                    onChange={e => { setPcTypeFilter(e.target.value); setPcPage(0) }}
                    className={`px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                  >
                    <option value="">Todos os tipos</option>
                    {Object.keys(TYPE_COLORS).map(type => (
                      <option key={type} value={type}>{type}</option>
                    ))}
                  </select>
                  {(pcSearchQuery || pcTypeFilter) && (
                    <button
                      onClick={() => {
                        setPcSearchQuery('')
                        setPcTypeFilter('')
                        setPcPage(0)
                      }}
                      className={`px-3 py-2 rounded-lg ${darkMode ? 'bg-red-600 hover:bg-red-700' : 'bg-red-500 hover:bg-red-600'} text-white font-semibold`}
                    >
                      Limpar Filtros
                    </button>
                  )}
                </div>
              </div>
            )}

            {(() => {
              const PC_PAGE_SIZE = 15 // 3 colunas × 5 linhas
              const filtered = pcPokemon
                .map((pokemon, originalIdx) => ({ pokemon, originalIdx }))
                .filter(({ pokemon }) => {
                  const matchesSearch = !pcSearchQuery ||
                    pokemon.nickname.toLowerCase().includes(pcSearchQuery.toLowerCase()) ||
                    pokemon.species.toLowerCase().includes(pcSearchQuery.toLowerCase())
                  const pokemonTypes = getPokemonTypes(pokemon)
                  const matchesType = !pcTypeFilter || pokemonTypes.includes(pcTypeFilter)
                  return matchesSearch && matchesType
                })
              const isFiltering = !!(pcSearchQuery || pcTypeFilter)
              const totalPages = Math.max(1, Math.ceil(filtered.length / PC_PAGE_SIZE))
              const safePage = Math.min(pcPage, totalPages - 1)
              const pageItems = isFiltering
                ? filtered
                : filtered.slice(safePage * PC_PAGE_SIZE, (safePage + 1) * PC_PAGE_SIZE)
              const emptySlots = !isFiltering && pageItems.length < PC_PAGE_SIZE
                ? PC_PAGE_SIZE - pageItems.length : 0

              if (pcPokemon.length === 0) {
                return (
                  <div className={`text-center py-12 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                    <p className="text-lg">Nenhum Pokémon armazenado no PC</p>
                  </div>
                )
              }
              return (
                <>
                  {!isFiltering && totalPages > 1 && (
                    <div className="flex items-center justify-between mb-4">
                      <button
                        onClick={() => setPcPage(p => Math.max(0, p - 1))}
                        disabled={safePage === 0}
                        className={`px-4 py-2 rounded-lg font-semibold transition-all ${safePage === 0 ? 'opacity-40 cursor-not-allowed' : 'hover:opacity-80'} ${darkMode ? 'bg-purple-700 text-white' : 'bg-purple-500 text-white'}`}
                      >← Anterior</button>
                      <span className={`font-bold text-lg ${darkMode ? 'text-gray-200' : 'text-gray-700'}`}>
                        Caixa {safePage + 1} / {totalPages}
                      </span>
                      <button
                        onClick={() => setPcPage(p => Math.min(totalPages - 1, p + 1))}
                        disabled={safePage >= totalPages - 1}
                        className={`px-4 py-2 rounded-lg font-semibold transition-all ${safePage >= totalPages - 1 ? 'opacity-40 cursor-not-allowed' : 'hover:opacity-80'} ${darkMode ? 'bg-purple-700 text-white' : 'bg-purple-500 text-white'}`}
                      >Próxima →</button>
                    </div>
                  )}
                  <div className="grid grid-cols-3 gap-2 sm:gap-3 md:gap-4">
                    {pageItems.map(({ pokemon, originalIdx }) => (
                  <div
                    key={pokemon.id || originalIdx}
                    className={`p-4 rounded-lg border-2 ${(pokemon.shiny || pokemon.legendary) ? (pokemon.shiny ? 'border-yellow-500' : 'border-orange-500') : darkMode ? 'bg-gray-700 border-purple-500' : 'bg-purple-50 border-purple-300'}`}
                    style={
                      pokemon?.shiny && pokemon?.legendary ? {
                        backgroundImage: 'url("/efeitolenda.gif"), url("/efeito shiny.gif")',
                        backgroundSize: 'cover, cover',
                        backgroundPosition: 'center, center',
                        backgroundRepeat: 'no-repeat, no-repeat'
                      } :
                      pokemon?.legendary ? {
                        backgroundImage: 'url("/efeitolenda.gif")',
                        backgroundSize: 'cover',
                        backgroundPosition: 'center',
                        backgroundRepeat: 'no-repeat'
                      } :
                      pokemon?.shiny ? {
                        backgroundImage: 'linear-gradient(135deg, rgba(255, 215, 0, 0.1) 0%, rgba(255, 215, 0, 0.2) 100%), url("/efeito shiny.gif")',
                        backgroundSize: 'cover',
                        backgroundPosition: 'center',
                        backgroundRepeat: 'no-repeat'
                      } : {}
                    }
                  >
                    <div className="flex items-center justify-between gap-2 sm:gap-3 md:gap-4">
                      {pokemonImages[sanitizeFirebaseKey(pokemon.id)] && (
                        <div className="flex flex-col items-center gap-2">
                          <img src={pokemonImages[sanitizeFirebaseKey(pokemon.id)]} alt={pokemon.nickname} className="w-16 h-16 object-cover rounded-lg border-2 border-purple-500" />
                          {pokemon.pokeball && (
                            <img
                              src={pokemon.pokeball === 'Custom Pokeball' && pokemon.customPokeballImage ? pokemon.customPokeballImage : `/pokeballs/${pokemon.pokeball.toLowerCase().replace(/\s+/g, '')}.png`}
                              alt={pokemon.pokeball}
                              className="w-8 h-8 object-contain"
                              title={pokemon.pokeball}
                            />
                          )}
                          <DietIcons speciesName={pokemon.species} dietOverride={pokemon.dieta} size={18} />
                        </div>
                      )}
                      <div className="flex-1">
                        {pokemon.isAlpha && (
                          <span
                            className="inline-block px-2 py-0.5 rounded-md text-xs font-bold text-red-600 mb-1"
                            style={{ background: 'linear-gradient(135deg, #C0C0C0, #FFFFFF)' }}
                          >
                            Alpha
                          </span>
                        )}
                        <div className="flex items-center gap-3 mb-2 flex-wrap">
                          <span
                            className={`px-3 py-1 rounded-lg font-bold text-lg cursor-pointer hover:underline ${pokemon.shiny ? 'bg-yellow-500 text-gray-900 hover:text-purple-900 border-2 border-yellow-700' : darkMode ? 'bg-gray-600 text-white hover:text-purple-400 border-2 border-gray-500' : 'bg-purple-100 text-gray-800 hover:text-purple-600 border-2 border-purple-300'}`}
                            onClick={() => openPokemonInfoModal(pokemon)}
                          >
                            {pokemon.nickname}
                          </span>
                          <span className={`px-2 py-1 rounded text-xs font-bold ${pokemon.shiny ? 'bg-purple-700 text-white' : darkMode ? 'bg-purple-600 text-white' : 'bg-purple-200 text-purple-800'}`}>Lv.{pokemon.level}</span>
                          {getPokemonTypes(pokemon).map((tipo, idx) => (
                            <span
                              key={idx}
                              className={`px-3 py-1 rounded-md text-xs font-bold text-white shadow-md ${TYPE_STYLES[tipo] || 'bg-gray-400'} ${classes.includes('Elementalista') ? 'cursor-pointer hover:ring-2 hover:ring-yellow-400 hover:ring-opacity-60' : ''}`}
                              style={{ clipPath: 'polygon(0 0, 90% 0, 100% 50%, 90% 100%, 0 100%)' }}
                              onClick={() => {
                                if (classes.includes('Elementalista')) {
                                  setSelectedPokemonForTypeEdit(pokemon)
                                  setPokemonTypeEditSource('pc')
                                  setShowPokemonTypeEditModal(true)
                                }
                              }}
                            >
                              {tipo}
                            </span>
                          ))}

                          {/* Tags de Capacidades na mesma linha */}
                          {pokemon.capacities && pokemon.capacities.others && pokemon.capacities.others.length > 0 && (
                            <div className={`px-2 py-1 rounded-lg ${darkMode ? 'bg-gray-600' : 'bg-gray-100'} inline-flex flex-wrap gap-1 items-center`}>
                              {pokemon.capacities.others.filter(cap => cap).map((capacity, idx) => (
                                <button
                                  key={idx}
                                  onClick={() => {
                                    setSelectedCapacityForInfo(capacity)
                                    setShowCapacityInfoModal(true)
                                  }}
                                  className={`px-2 py-1 rounded text-xs font-semibold ${darkMode ? 'bg-indigo-600 text-white hover:bg-indigo-500' : 'bg-indigo-200 text-indigo-800 hover:bg-indigo-300'} cursor-pointer transition-colors`}
                                >
                                  {capacity}
                                </button>
                              ))}
                            </div>
                          )}

                          {/* Caixa de Slots de Habilidades */}
                          {pokemon.habilidades && pokemon.habilidades.length > 0 && (
                            <div className={`px-2 py-1 rounded-lg ${darkMode ? 'bg-teal-900 border-2 border-teal-600' : 'bg-teal-50 border-2 border-teal-300'} inline-flex flex-wrap gap-1 items-center`}>
                              {pokemon.habilidades.map((habilidade, idx) => (
                                <button
                                  key={idx}
                                  onClick={() => {
                                    setSelectedHabilidadeForDetail(habilidade)
                                    setShowHabilidadeDetailModal(true)
                                  }}
                                  className={`px-2 py-1 rounded text-xs font-semibold ${darkMode ? 'bg-teal-600 text-white hover:bg-teal-500' : 'bg-teal-200 text-teal-900 hover:bg-teal-300'} cursor-pointer transition-colors`}
                                >
                                  {habilidade}
                                </button>
                              ))}
                            </div>
                          )}

                          {/* Caixa de Held Item */}
                          <div className={`px-3 py-2 rounded-lg ${darkMode ? 'bg-gray-700 border-2 border-gray-500' : 'bg-gray-100 border-2 border-gray-400'} inline-flex items-center justify-center text-center gap-2`}>
                            {pokemon.heldItem ? (
                              <>
                                <button
                                  onClick={() => handleOpenHeldItemDetail(pokemon.heldItem)}
                                  className={`text-sm font-semibold ${darkMode ? 'text-gray-200 hover:text-white' : 'text-gray-800 hover:text-gray-900'} hover:underline cursor-pointer transition-colors`}
                                >
                                  {pokemon.heldItem.name}
                                </button>
                                <button
                                  onClick={() => handleReturnItemToBackpack(pokemon, true)}
                                  className={`${darkMode ? 'text-blue-400 hover:text-blue-300' : 'text-blue-600 hover:text-blue-700'} transition-colors`}
                                  title="Devolver item para a mochila"
                                >
                                  <ArrowBigRightDash size={18} />
                                </button>
                              </>
                            ) : (
                              <span className={`text-xs italic ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                {getRandomNoItemPhrase()}
                              </span>
                            )}
                          </div>
                        </div>
                        <p className={`text-sm mb-3 ${pokemon.shiny ? 'text-gray-900 font-semibold' : darkMode ? 'text-gray-400' : 'text-gray-600'}`}>{pokemon.species}</p>

                        <div className="flex gap-2 flex-wrap">
                          <button
                            onClick={() => openImagePCModal(pokemon)}
                            className="bg-gray-500 text-white p-2 rounded hover:bg-gray-600"
                            title="Adicionar Imagem PC"
                          >
                            <Camera size={16} />
                          </button>
                          <button
                            onClick={() => {
                              setNameRaterPCIndex(originalIdx)
                              setNameRaterPCNickname(pokemon.nickname)
                              setShowNameRaterPCModal(true)
                            }}
                            className="bg-purple-500 text-white p-2 rounded hover:bg-purple-600"
                            title="Name Rater PC"
                          >
                            <Edit size={16} />
                          </button>
                          <button onClick={() => handleOpenTutoria(pokemon, 'pc')} className="bg-indigo-500 text-white p-2 rounded hover:bg-indigo-600" title="Tutoria de Golpes">
                            <BookOpenText size={16} />
                          </button>
                          <button onClick={() => handleOpenHabilidadesPC(pokemon, 'pc')} className="bg-teal-500 text-white p-2 rounded hover:bg-teal-600" title="Habilidades PC">
                            <BookA size={16} />
                          </button>
                          <button
                            onClick={() => handleOpenPokeballPC(pokemon, 'pc')}
                            className="bg-purple-500 text-white p-2 rounded hover:bg-purple-600 animate-pulse"
                            title="Pokébola de Captura PC"
                            style={{
                              animation: 'colorCycle 3s linear infinite'
                            }}
                          >
                            <CircleDot size={16} />
                          </button>
                          <button
                            onClick={() => handleOpenHeldItemPC(pokemon, 'pc')}
                            className="bg-gray-400 text-white p-2 rounded hover:bg-gray-500"
                            title="Held Item PC"
                          >
                            <Webhook size={16} />
                          </button>
                          <button onClick={() => handleOpenPCGolpes(pokemon)} className="bg-orange-500 text-white p-2 rounded hover:bg-orange-600" title="Ver Golpes">
                            <Zap size={16} />
                          </button>
                          <button onClick={() => openEvolutionModal(pokemon, 'pc', originalIdx)} className="bg-emerald-500 text-white px-3 py-1 rounded hover:bg-emerald-600 text-sm font-semibold flex items-center gap-1" title="Evoluir Pokémon PC">
                            <Sparkles size={14} /> Evo PC
                          </button>
                          <button onClick={() => openEditPokemonPCModal(pokemon, originalIdx)} className="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 text-sm font-semibold" title="Editar Pokémon PC">
                            Edit Pkm PC
                          </button>
                          <button onClick={() => openAptidoesModal(pokemon, 'pc', originalIdx)} className="bg-indigo-500 text-white p-2 rounded hover:bg-indigo-600" title="Editar Aptidões PC">
                            <TowerControl size={16} />
                          </button>
                          <button onClick={() => moveToTeam(originalIdx)} className="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 text-sm font-semibold" title="Mover para o Time">
                            ⬆️ TP
                          </button>
                          <button onClick={() => handleDeleteFromPc(originalIdx)} className="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 text-sm font-semibold">
                            🗑️ Liberar
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                    ))}
                    {Array.from({ length: emptySlots }).map((_, i) => (
                      <div
                        key={`empty-${i}`}
                        className={`rounded-lg border-2 border-dashed ${darkMode ? 'border-gray-600' : 'border-gray-300'} flex items-center justify-center`}
                        style={{ minHeight: '8rem' }}
                      >
                        <span className={`${darkMode ? 'text-gray-600' : 'text-gray-400'} text-2xl`}>—</span>
                      </div>
                    ))}
                  </div>
                </>
              )
            })()}
          </div>
        </div>

        {/* Modal de Adicionar Imagem PC */}
        {showImagePCModal && selectedPokemonForImage && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowImagePCModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-3 sm:p-5 md:p-8 rounded-2xl shadow-2xl max-w-md w-full`} onClick={(e) => e.stopPropagation()}>
              <div className="flex justify-between items-center mb-6">
                <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  Adicionar Imagem PC - {selectedPokemonForImage.nickname}
                </h3>
                <button onClick={() => setShowImagePCModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                  <X size={24} />
                </button>
              </div>

              <div className="space-y-4">
                {/* Seletor de tipo de upload */}
                <div className="flex gap-2 mb-4">
                  <button
                    onClick={() => setImageUploadType('link')}
                    className={`flex-1 py-2 px-4 rounded-lg font-semibold transition-all ${
                      imageUploadType === 'link'
                        ? 'bg-blue-500 text-white'
                        : darkMode ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                    }`}
                  >
                    Link/URL
                  </button>
                  <button
                    onClick={() => setImageUploadType('file')}
                    className={`flex-1 py-2 px-4 rounded-lg font-semibold transition-all ${
                      imageUploadType === 'file'
                        ? 'bg-blue-500 text-white'
                        : darkMode ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                    }`}
                  >
                    Arquivo Local
                  </button>
                </div>

                {imageUploadType === 'link' ? (
                  <div>
                    <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>
                      URL da Imagem
                    </label>
                    <input
                      type="url"
                      value={imageUrl}
                      onChange={(e) => setImageUrl(e.target.value)}
                      placeholder="https://exemplo.com/imagem.jpg"
                      className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-500' : 'border-gray-300'}`}
                    />
                  </div>
                ) : (
                  <div>
                    <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>
                      Selecionar Arquivo
                    </label>
                    <input
                      id="pokemon-image-file-pc"
                      type="file"
                      accept="image/*"
                      className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                    />
                  </div>
                )}

                <div className="flex gap-3 pt-4">
                  <button
                    onClick={() => {
                      setShowImagePCModal(false)
                      setImageUrl('')
                      setSelectedPokemonForImage(null)
                    }}
                    className={`flex-1 py-3 rounded-lg font-semibold ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                  >
                    Cancelar
                  </button>
                  <button
                    onClick={() => handleSaveImage(true)}
                    className="flex-1 bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 font-semibold"
                  >
                    Salvar Imagem
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Modal de Visualização de Informações do Pokémon */}
        {showPokemonInfoModal && viewingPokemon && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto`}>
              <div className={`sticky top-0 ${darkMode ? 'bg-gray-700' : 'bg-gradient-to-r from-blue-500 to-purple-600'} p-3 sm:p-5 md:p-6 rounded-t-2xl`}>
                <div className="flex justify-between items-center">
                  <h3 className="text-xl sm:text-2xl font-bold text-white">
                    {viewingPokemon.nickname || viewingPokemon.species}
                  </h3>
                  <button onClick={() => { setShowPokemonInfoModal(false); setViewingPokemon(null) }} className="text-white hover:text-gray-300">
                    <X size={28} />
                  </button>
                </div>
              </div>

              <div className={`p-3 sm:p-5 md:p-6 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                {/* Informações Básicas */}
                <div className="mb-6">
                  <h4 className={`text-lg font-bold mb-3 ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>Informações Básicas</h4>
                  <div className="grid grid-cols-2 gap-3 text-sm">
                    <div><span className="font-semibold">Apelido:</span> {viewingPokemon.nickname || '-'}</div>
                    <div><span className="font-semibold">Espécie:</span> {viewingPokemon.species || '-'}</div>
                    <div><span className="font-semibold">Nível:</span> {viewingPokemon.level || '-'}</div>
                    <div><span className="font-semibold">XP:</span> {getCurrentLevelXP(viewingPokemon)}/{getXPForNextLevel(viewingPokemon.level)}</div>
                    <div><span className="font-semibold">Natureza:</span> {viewingPokemon.nature || '-'}</div>
                    <div><span className="font-semibold">Gênero:</span> {viewingPokemon.gender || '-'}</div>
                    <div><span className="font-semibold">Felicidade:</span> {viewingPokemon.currentHappiness || 0}/{calculateMaxHappiness(viewingPokemon)}</div>
                    <div><span className="font-semibold">Peso:</span> {viewingPokemon.weight || '-'} kg</div>
                    <div><span className="font-semibold">Altura:</span> {viewingPokemon.height || '-'} m</div>
                    <div><span className="font-semibold">Lealdade:</span> {viewingPokemon.loyalty || '-'}</div>
                  </div>
                </div>

                {/* Capacidades */}
                {viewingPokemon.capacities && (viewingPokemon.capacities.forca || viewingPokemon.capacities.inteligencia || viewingPokemon.capacities.salto) && (
                  <div className="mb-6">
                    <h4 className={`text-lg font-bold mb-3 ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>Capacidades</h4>
                    <div className="grid grid-cols-3 gap-2 sm:gap-3 md:gap-4 text-sm">
                      {viewingPokemon.capacities.forca && (
                        <div className={`p-3 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-blue-50'}`}>
                          <div className="font-semibold text-blue-600">Força</div>
                          <div className="text-xl sm:text-2xl font-bold">{viewingPokemon.capacities.forca}</div>
                        </div>
                      )}
                      {viewingPokemon.capacities.inteligencia && (
                        <div className={`p-3 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-purple-50'}`}>
                          <div className="font-semibold text-purple-600">Inteligência</div>
                          <div className="text-xl sm:text-2xl font-bold">{viewingPokemon.capacities.inteligencia}</div>
                        </div>
                      )}
                      {viewingPokemon.capacities.salto && (
                        <div className={`p-3 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-green-50'}`}>
                          <div className="font-semibold text-green-600">Salto</div>
                          <div className="text-xl sm:text-2xl font-bold">{viewingPokemon.capacities.salto}</div>
                        </div>
                      )}
                    </div>
                  </div>
                )}

                {/* Atributos */}
                {(viewingPokemon.baseAttributes || viewingPokemon.levelPoints) && (
                  <div className="mb-6">
                    <h4 className={`text-lg font-bold mb-3 ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>Atributos</h4>
                    <div className="overflow-x-auto">
                      <table className={`w-full border-collapse ${darkMode ? 'bg-gray-700' : 'bg-white'}`}>
                        <thead>
                          <tr className={darkMode ? 'bg-gray-600' : 'bg-gray-200'}>
                            <th className={`border p-2 text-xs ${darkMode ? 'border-gray-500' : 'border-gray-300'}`}>Atributo</th>
                            <th className={`border p-2 text-xs ${darkMode ? 'border-gray-500' : 'border-gray-300'}`}>Basal</th>
                            <th className={`border p-2 text-xs ${darkMode ? 'border-gray-500' : 'border-gray-300'}`}>Atributo Bônus</th>
                            <th className={`border p-2 text-xs ${darkMode ? 'border-gray-500' : 'border-gray-300'}`}>Basal + Bônus + Nat.</th>
                            <th className={`border p-2 text-xs ${darkMode ? 'border-gray-500' : 'border-gray-300'}`}>Pontos Nível</th>
                            <th className={`border p-2 text-xs ${darkMode ? 'border-gray-500' : 'border-gray-300'}`}>Total</th>
                          </tr>
                        </thead>
                        <tbody>
                          {[
                            { label: 'Saúde', key: 'saude' },
                            { label: 'Ataque', key: 'ataque' },
                            { label: 'Defesa', key: 'defesa' },
                            { label: 'Ataque Especial', key: 'ataqueEspecial' },
                            { label: 'Defesa Especial', key: 'defesaEspecial' },
                            { label: 'Velocidade', key: 'velocidade' }
                          ].map(attr => {
                            const selectedNature = natures.find(n => n.nome === viewingPokemon.nature)
                            const isIncreased = selectedNature?.up === attr.label
                            const isDecreased = selectedNature?.down === attr.label
                            const baseVal = parseInt(viewingPokemon.baseAttributes?.[attr.key]) || 0
                            const bonusVal = parseInt(viewingPokemon.bonusPoints?.[attr.key]) || 0
                            const natureBonus = attr.key === 'saude' ? 1 : 2
                            const natureVal = isIncreased ? natureBonus : isDecreased ? -natureBonus : 0
                            const levelVal = parseInt(viewingPokemon.levelPoints?.[attr.key]) || 0
                            const basalBonusNat = baseVal + bonusVal + natureVal
                            const total = basalBonusNat + levelVal

                            return (
                              <tr key={attr.key}>
                                <td className={`border p-2 text-xs font-semibold ${darkMode ? 'border-gray-500' : 'border-gray-300'}`}>{attr.label}</td>
                                <td className={`border p-2 text-xs text-center ${darkMode ? 'border-gray-500' : 'border-gray-300'}`}>{baseVal || '-'}</td>
                                <td className={`border p-2 text-xs text-center ${darkMode ? 'border-gray-500' : 'border-gray-300'}`}>{bonusVal || '-'}</td>
                                <td className={`border p-2 text-xs text-center ${darkMode ? 'border-gray-500' : 'border-gray-300'}`}>{baseVal ? basalBonusNat : '-'}</td>
                                <td className={`border p-2 text-xs text-center ${darkMode ? 'border-gray-500' : 'border-gray-300'}`}>{levelVal || '-'}</td>
                                <td className={`border p-2 text-xs text-center font-bold ${darkMode ? 'border-gray-500' : 'border-gray-300'}`}>{baseVal ? total : '-'}</td>
                              </tr>
                            )
                          })}
                        </tbody>
                      </table>
                    </div>
                  </div>
                )}

                {/* Sabores */}
                {(viewingPokemon.nature) && (
                  <div className="mb-6">
                    <h4 className={`text-lg font-bold mb-3 ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>Preferências</h4>
                    <div className="grid grid-cols-2 gap-3 text-sm">
                      <div><span className="font-semibold">Sabor Predileto:</span> {viewingPokemon.favoriteFlavor || natures.find(n => n.nome === viewingPokemon.nature)?.gosto || '-'}</div>
                      <div><span className="font-semibold">Sabor que Não Gosta:</span> {viewingPokemon.dislikedFlavor || natures.find(n => n.nome === viewingPokemon.nature)?.desgosto || '-'}</div>
                    </div>
                  </div>
                )}

                {/* Deslocamento */}
                {viewingPokemon.displacement && (
                  <div className="mb-6">
                    <h4 className={`text-lg font-bold mb-3 ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>Deslocamento</h4>
                    <div className="grid grid-cols-2 md:grid-cols-3 gap-3 text-sm">
                      <div><span className="font-semibold">Terrestre:</span> {viewingPokemon.displacement.terrestre || '-'}</div>
                      <div><span className="font-semibold">Nadar:</span> {viewingPokemon.displacement.nadar || '-'}</div>
                      <div><span className="font-semibold">Voar:</span> {viewingPokemon.displacement.voar || '-'}</div>
                      <div><span className="font-semibold">Cavar:</span> {viewingPokemon.displacement.cavar || '-'}</div>
                      <div><span className="font-semibold">Submerso:</span> {viewingPokemon.displacement.submerso || '-'}</div>
                    </div>
                  </div>
                )}

                {/* Aptidões */}
                <div className="mb-6">
                  <h4 className={`text-lg font-bold mb-3 ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>Aptidões</h4>
                  <div className="flex flex-wrap gap-3">
                    {[
                      { key: 'estilo', label: 'Estilo', bg: darkMode ? 'bg-red-900' : 'bg-red-100', text: darkMode ? 'text-red-300' : 'text-red-600' },
                      { key: 'beleza', label: 'Beleza', bg: darkMode ? 'bg-blue-900' : 'bg-blue-100', text: darkMode ? 'text-blue-300' : 'text-blue-600' },
                      { key: 'ternura', label: 'Ternura', bg: darkMode ? 'bg-pink-900' : 'bg-pink-100', text: darkMode ? 'text-pink-300' : 'text-pink-600' },
                      { key: 'perspicacia', label: 'Perspicácia', bg: darkMode ? 'bg-green-900' : 'bg-green-100', text: darkMode ? 'text-green-300' : 'text-green-600' },
                      { key: 'vigor', label: 'Vigor', bg: darkMode ? 'bg-yellow-900' : 'bg-yellow-100', text: darkMode ? 'text-yellow-300' : 'text-yellow-600' }
                    ].map(apt => (
                      <div key={apt.key} className={`text-center px-4 py-2 rounded-lg ${apt.bg}`}>
                        <div className={`text-xs font-semibold ${apt.text}`}>{apt.label}</div>
                        <div className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{viewingPokemon.aptidoes?.[apt.key] ?? 0}</div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>

              <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-4 rounded-b-2xl flex justify-end`}>
                <button onClick={() => { setShowPokemonInfoModal(false); setViewingPokemon(null) }} className="bg-gray-500 text-white px-3 sm:px-5 md:px-6 py-2 rounded-lg hover:bg-gray-600 font-semibold">
                  Fechar
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Modal de Tutoria de Golpes */}
        {showTutoriaModal && selectedPokemonForTutoria && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowTutoriaModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-sm sm:max-w-2xl md:max-w-4xl w-full max-h-[90vh] overflow-y-auto`} onClick={(e) => e.stopPropagation()}>
              <div className="p-3 sm:p-5 md:p-6">
                <div className="flex justify-between items-center mb-6">
                  <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                    Tutoria de Golpes - {selectedPokemonForTutoria.nickname}
                  </h3>
                  <button onClick={() => setShowTutoriaModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                    <X size={24} />
                  </button>
                </div>

                {/* Golpes Selecionados */}
                <div className="mb-6">
                  <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Golpes Selecionados ({tutoriaSelectedGolpes.length}/8)
                  </label>
                  {tutoriaSelectedGolpes.length === 0 ? (
                    <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'} text-center ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                      Nenhum golpe selecionado
                    </div>
                  ) : (
                    <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'} flex flex-wrap gap-2`}>
                      {tutoriaSelectedGolpes.map((golpe, idx) => (
                        <div key={idx} className={`flex items-center gap-2 px-3 py-2 rounded ${darkMode ? 'bg-orange-600 text-white' : 'bg-orange-500 text-white'}`}>
                          <span className="font-semibold">{golpe}</span>
                          <button onClick={() => handleRemoveGolpeFromSelected(golpe)} className="hover:bg-red-500 rounded p-1">
                            <X size={16} />
                          </button>
                        </div>
                      ))}
                    </div>
                  )}
                </div>

                {/* Busca de Golpes */}
                <div className="mb-4">
                  <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Busca de Golpes
                  </label>
                  <div className="relative">
                    <Search className={`absolute left-3 top-1/2 transform -translate-y-1/2 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`} size={20} />
                    <input
                      type="text"
                      value={tutoriaGolpesSearch}
                      onChange={(e) => setTutoriaGolpesSearch(e.target.value)}
                      className={`w-full pl-10 pr-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                      placeholder="Digite o nome do golpe..."
                    />
                  </div>
                </div>

                {/* Golpes Disponíveis */}
                <div className="mb-6">
                  <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Golpes Disponíveis
                  </label>
                  <div className={`max-h-64 overflow-y-auto ${darkMode ? 'bg-gray-700' : 'bg-gray-100'} rounded-lg p-4 space-y-2`}>
                    {GOLPES_NAMES
                      .filter(golpe => golpe.toLowerCase().includes(tutoriaGolpesSearch.toLowerCase()))
                      .filter(golpe => !tutoriaSelectedGolpes.includes(golpe))
                      .map((golpe, idx) => (
                        <div key={idx} className={`flex items-center justify-between p-3 rounded ${darkMode ? 'bg-gray-600 hover:bg-gray-500' : 'bg-white hover:bg-gray-50'} transition-colors`}>
                          <div className="flex-1">
                            <span className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{golpe}</span>
                            <div className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'} mt-1`}>
                              <span className="mr-3">Tipo: {GOLPES_DATA[golpe].tipo}</span>
                              <span className="mr-3">Aptidão: {GOLPES_DATA[golpe].aptidao}</span>
                              <span className="mr-3">Dano: {GOLPES_DATA[golpe].danoBasal || '-'}</span>
                              <span>Freq: {GOLPES_DATA[golpe].frequencia}</span>
                            </div>
                          </div>
                          <button
                            onClick={() => handleAddGolpeToSelected(golpe)}
                            className={`ml-2 p-2 rounded ${darkMode ? 'bg-green-600 hover:bg-green-700' : 'bg-green-500 hover:bg-green-600'} text-white`}
                          >
                            <Plus size={16} />
                          </button>
                        </div>
                      ))}
                  </div>
                </div>

                {/* Botões */}
                <div className="flex gap-3">
                  <button
                    onClick={() => setShowTutoriaModal(false)}
                    className={`flex-1 py-3 rounded-lg font-semibold ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                  >
                    Cancelar
                  </button>
                  <button
                    onClick={handleSaveGolpes}
                    className="flex-1 bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 font-semibold"
                    disabled={tutoriaSelectedGolpes.length < 1}
                  >
                    Salvar Golpes
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Modal de Golpes do PC */}
        {showPCGolpesModal && selectedPokemonForPCGolpes && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowPCGolpesModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto`} onClick={(e) => e.stopPropagation()}>
              <div className="p-3 sm:p-5 md:p-6">
                <div className="flex justify-between items-center mb-6">
                  <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                    Golpes - {selectedPokemonForPCGolpes.nickname}
                  </h3>
                  <button onClick={() => setShowPCGolpesModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                    <X size={24} />
                  </button>
                </div>

                <div className="space-y-3">
                  {selectedPokemonForPCGolpes.golpes && selectedPokemonForPCGolpes.golpes.length > 0 ? (
                    selectedPokemonForPCGolpes.golpes
                      .filter(g => g !== null)
                      .map((golpe, idx) => {
                        const golpeNome = typeof golpe === 'string' ? golpe : golpe?.nome
                        if (!golpeNome) return null
                        return (
                          <div key={idx} className={`rounded-lg overflow-hidden ${TYPE_STYLES[GOLPES_DATA[golpeNome]?.tipo] || (darkMode ? 'bg-gray-700' : 'bg-gray-100')}`}>
                            <button
                              onClick={() => setExpandedGolpeInPC(expandedGolpeInPC === golpeNome ? null : golpeNome)}
                              className={`w-full p-4 text-left font-semibold text-white transition-colors flex items-center justify-between hover:opacity-80`}
                            >
                              <span>{golpeNome}</span>
                              <span className="text-sm">{expandedGolpeInPC === golpeNome ? '▼' : '▶'}</span>
                            </button>

                            {expandedGolpeInPC === golpeNome && (
                              <div className={`p-4 border-t-2 ${darkMode ? 'border-gray-600 text-white' : 'border-gray-300 text-gray-800'}`}>
                                <div className="grid grid-cols-2 gap-3 mb-3">
                                  <div>
                                    <div className={`text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Tipo</div>
                                    <div className="font-bold">{GOLPES_DATA[golpeNome]?.tipo}</div>
                                  </div>
                                  <div>
                                    <div className={`text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Aptidão</div>
                                    <div className="font-bold">{GOLPES_DATA[golpeNome]?.aptidao}</div>
                                  </div>
                                  <div>
                                    <div className={`text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Dano Basal</div>
                                    <div className="font-bold">{GOLPES_DATA[golpeNome]?.danoBasal || '-'}</div>
                                  </div>
                                  <div>
                                    <div className={`text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Acurácia</div>
                                    <div className="font-bold">{GOLPES_DATA[golpeNome]?.acuracia}</div>
                                  </div>
                                  <div>
                                    <div className={`text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Frequência</div>
                                    <div className="font-bold">{GOLPES_DATA[golpeNome]?.frequencia}</div>
                                  </div>
                                  <div>
                                    <div className={`text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Alcance</div>
                                    <div className="font-bold">{GOLPES_DATA[golpeNome]?.alcance}</div>
                                  </div>
                                  <div>
                                    <div className={`text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Descritores</div>
                                    <div className="font-bold">{GOLPES_DATA[golpeNome]?.descritores || '-'}</div>
                                  </div>
                                  <div>
                                    <div className={`text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Tag Concurso</div>
                                    <div className="font-bold">{GOLPES_DATA[golpeNome]?.tagConcurso}</div>
                                  </div>
                                </div>
                                <div>
                                  <div className={`text-xs font-semibold mb-1 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Efeito</div>
                                  <div className="text-sm">{renderGolpeEfeito(GOLPES_DATA[golpeNome]?.efeito, darkMode)}</div>
                                </div>
                              </div>
                            )}
                          </div>
                        )
                      })
                  ) : (
                    <div className={`p-3 sm:p-5 md:p-8 text-center ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                      Nenhum golpe selecionado. Use a Tutoria para adicionar golpes!
                    </div>
                  )}
                </div>

                <div className="mt-6">
                  <button
                    onClick={() => setShowPCGolpesModal(false)}
                    className={`w-full py-3 rounded-lg font-semibold ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                  >
                    Fechar
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* MODAL DE EDIÇÃO DE POKÉMON - PC */}
        {showEditPokemonPCModal && editingPokemon && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowEditPokemonPCModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-sm sm:max-w-2xl md:max-w-4xl w-full max-h-[90vh] overflow-y-auto`} onClick={(e) => e.stopPropagation()}>
              <div className="p-3 sm:p-5 md:p-6">
                <div className="flex justify-between items-center mb-6">
                  <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                    Edição de {editingPokemon.nickname} (PC)
                  </h3>
                  <button onClick={() => setShowEditPokemonPCModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                    <X size={24} />
                  </button>
                </div>

                {/* CHECKBOX SHINY */}
                <div className="mb-6 flex items-center gap-3">
                  <input
                    type="checkbox"
                    id="shiny-checkbox"
                    checked={pokemonEditForm.shiny}
                    onChange={(e) => setPokemonEditForm({...pokemonEditForm, shiny: e.target.checked})}
                    className="w-5 h-5 cursor-pointer"
                  />
                  <label htmlFor="shiny-checkbox" className="text-xl sm:text-2xl font-bold cursor-pointer select-none" style={{
                    background: 'linear-gradient(to right, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3)',
                    WebkitBackgroundClip: 'text',
                    WebkitTextFillColor: 'transparent',
                    backgroundClip: 'text'
                  }}>
                    SHINY
                  </label>
                </div>

                {/* CHECKBOX LENDÁRIO */}
                <div className="mb-6 flex items-center gap-3">
                  <input
                    type="checkbox"
                    id="legendary-checkbox"
                    checked={pokemonEditForm.legendary}
                    onChange={(e) => setPokemonEditForm({...pokemonEditForm, legendary: e.target.checked})}
                    className="w-5 h-5 cursor-pointer"
                  />
                  <label htmlFor="legendary-checkbox" className="text-xl sm:text-2xl font-bold cursor-pointer select-none" style={{
                    background: 'linear-gradient(135deg, #FFD700 0%, #FFA500 50%, #FF6347 100%)',
                    WebkitBackgroundClip: 'text',
                    WebkitTextFillColor: 'transparent',
                    backgroundClip: 'text'
                  }}>
                    LENDÁRIO
                  </label>
                </div>

                {/* 1. NATUREZA */}
                <div className="mb-6">
                  <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>1. Natureza</label>
                  <input
                    type="text"
                    placeholder="Buscar natureza..."
                    value={natureSearch}
                    onChange={(e) => setNatureSearch(e.target.value)}
                    className={`w-full px-4 py-2 border-2 rounded-lg mb-2 ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                  />
                  <select
                    value={pokemonEditForm.nature}
                    onChange={(e) => setPokemonEditForm({...pokemonEditForm, nature: e.target.value})}
                    className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                  >
                    <option value="">Selecione uma natureza</option>
                    {natures
                      .filter(n => natureSearch === '' || n.nome.toLowerCase().includes(natureSearch.toLowerCase()))
                      .map((nature, idx) => (
                        <option key={idx} value={nature.nome}>
                          {nature.nome} {nature.up !== 'Nenhum' && `(↑${nature.up} ↓${nature.down})`}
                        </option>
                      ))
                    }
                  </select>
                  {pokemonEditForm.nature && (() => {
                    const selectedNature = natures.find(n => n.nome === pokemonEditForm.nature)
                    return selectedNature && (
                      <div className={`mt-2 text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                        <p><strong>Aumenta:</strong> {selectedNature.up}</p>
                        <p><strong>Diminui:</strong> {selectedNature.down}</p>
                      </div>
                    )
                  })()}
                </div>

                {/* 2. ATRIBUTOS */}
                <div className="mb-6">
                  <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>2. Atributos</label>
                  <p className={`text-xs mb-3 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                    Todos os atributos flutuam entre +2/-2, menos a saúde, ela flutuará entre +1/-1.
                  </p>
                  <div className="overflow-x-auto">
                    <table className={`w-full border-collapse ${darkMode ? 'bg-gray-700' : 'bg-white'}`}>
                      <thead>
                        <tr className={darkMode ? 'bg-gray-600' : 'bg-gray-200'}>
                          <th className={`border p-2 text-xs ${darkMode ? 'border-gray-500 text-white' : 'border-gray-300'}`}>Atributos</th>
                          <th className={`border p-2 text-xs ${darkMode ? 'border-gray-500 text-white' : 'border-gray-300'}`}>Atributos Basais</th>
                          <th className={`border p-2 text-xs ${darkMode ? 'border-gray-500 text-white' : 'border-gray-300'}`}>Atributo Bônus</th>
                          <th className={`border p-2 text-xs ${darkMode ? 'border-gray-500 text-white' : 'border-gray-300'}`}>Basal + Bônus + Nat.</th>
                          <th className={`border p-2 text-xs ${darkMode ? 'border-gray-500 text-white' : 'border-gray-300'}`}>Pontos por Nível</th>
                          <th className={`border p-2 text-xs ${darkMode ? 'border-gray-500 text-white' : 'border-gray-300'}`}>Total</th>
                        </tr>
                      </thead>
                      <tbody>
                        {[
                          { label: 'Saúde', key: 'saude' },
                          { label: 'Ataque', key: 'ataque' },
                          { label: 'Defesa', key: 'defesa' },
                          { label: 'Ataque Especial', key: 'ataqueEspecial' },
                          { label: 'Defesa Especial', key: 'defesaEspecial' },
                          { label: 'Velocidade', key: 'velocidade' }
                        ].map(attr => {
                          const selectedNature = natures.find(n => n.nome === pokemonEditForm.nature)
                          const isIncreased = selectedNature?.up === attr.label
                          const isDecreased = selectedNature?.down === attr.label
                          const baseVal = parseInt(pokemonEditForm.baseAttributes[attr.key]) || 0
                          const bonusVal = parseInt(pokemonEditForm.bonusPoints[attr.key]) || 0
                          const natureBonus = attr.key === 'saude' ? 1 : 2
                          const natureVal = isIncreased ? natureBonus : isDecreased ? -natureBonus : 0
                          const levelVal = parseInt(pokemonEditForm.levelPoints[attr.key]) || 0
                          const total = baseVal + bonusVal + natureVal + levelVal

                          return (
                            <tr key={attr.key} className={
                              isIncreased ? (darkMode ? 'bg-green-900/30' : 'bg-green-50') :
                              isDecreased ? (darkMode ? 'bg-red-900/30' : 'bg-red-50') : ''
                            }>
                              <td className={`border p-2 text-xs font-semibold ${darkMode ? 'border-gray-500 text-white' : 'border-gray-300'}`}>
                                {attr.label}
                              </td>
                              <td className={`border p-2 ${darkMode ? 'border-gray-500' : 'border-gray-300'}`}>
                                <input
                                  type="number"
                                  min="1"
                                  max="100"
                                  value={pokemonEditForm.baseAttributes[attr.key]}
                                  onChange={(e) => setPokemonEditForm({
                                    ...pokemonEditForm,
                                    baseAttributes: {...pokemonEditForm.baseAttributes, [attr.key]: e.target.value}
                                  })}
                                  className={`w-full px-2 py-1 text-xs text-center border rounded ${darkMode ? 'bg-gray-600 text-white border-gray-500' : 'border-gray-300'}`}
                                />
                              </td>
                              <td className={`border p-2 ${darkMode ? 'border-gray-500' : 'border-gray-300'}`}>
                                <input
                                  type="number"
                                  value={pokemonEditForm.bonusPoints[attr.key]}
                                  onChange={(e) => setPokemonEditForm({
                                    ...pokemonEditForm,
                                    bonusPoints: {...pokemonEditForm.bonusPoints, [attr.key]: e.target.value}
                                  })}
                                  className={`w-full px-2 py-1 text-xs text-center border rounded ${darkMode ? 'bg-gray-600 text-white border-gray-500' : 'border-gray-300'}`}
                                />
                              </td>
                              <td className={`border p-2 text-xs text-center ${darkMode ? 'border-gray-500 text-white' : 'border-gray-300'}`}>
                                {baseVal + bonusVal + natureVal}
                              </td>
                              <td className={`border p-2 ${darkMode ? 'border-gray-500' : 'border-gray-300'}`}>
                                <input
                                  type="number"
                                  value={pokemonEditForm.levelPoints[attr.key]}
                                  onChange={(e) => setPokemonEditForm({
                                    ...pokemonEditForm,
                                    levelPoints: {...pokemonEditForm.levelPoints, [attr.key]: e.target.value}
                                  })}
                                  className={`w-full px-2 py-1 text-xs text-center border rounded ${darkMode ? 'bg-gray-600 text-white border-gray-500' : 'border-gray-300'}`}
                                />
                              </td>
                              <td className={`border p-2 text-xs text-center font-bold ${darkMode ? 'border-gray-500 text-white' : 'border-gray-300'}`}>
                                {total}
                              </td>
                            </tr>
                          )
                        })}
                      </tbody>
                    </table>
                  </div>
                </div>

                {/* 3 e 4. SABORES */}
                <div className="grid md:grid-cols-2 gap-2 sm:gap-3 md:gap-4 mb-6">
                  <div>
                    <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>3. Sabor Predileto</label>
                    <input
                      type="text"
                      value={natures.find(n => n.nome === pokemonEditForm.nature)?.gosto || 'Nenhum'}
                      disabled
                      className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-600 border-gray-500 text-gray-400' : 'bg-gray-100 border-gray-300 text-gray-600'}`}
                    />
                  </div>
                  <div>
                    <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>4. Sabor que Não Gosta</label>
                    <input
                      type="text"
                      value={natures.find(n => n.nome === pokemonEditForm.nature)?.desgosto || 'Nenhum'}
                      disabled
                      className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-600 border-gray-500 text-gray-400' : 'bg-gray-100 border-gray-300 text-gray-600'}`}
                    />
                  </div>
                </div>

                {/* 5. GÊNERO */}
                <div className="mb-6">
                  <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>5. Gênero</label>
                  <select
                    value={pokemonEditForm.gender}
                    onChange={(e) => setPokemonEditForm({...pokemonEditForm, gender: e.target.value})}
                    className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                  >
                    <option value="">Selecione...</option>
                    <option value="Macho">Macho</option>
                    <option value="Fêmea">Fêmea</option>
                    <option value="Assexuado">Assexuado</option>
                  </select>
                </div>

                {/* 6. DESLOCAMENTO */}
                <div className="mb-6">
                  <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>6. Deslocamento</label>
                  <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3">
                    {['terrestre', 'nadar', 'voar', 'cavar', 'submerso'].map(type => (
                      <div key={type}>
                        <label className={`block text-xs mb-1 ${darkMode ? 'text-gray-400' : 'text-gray-600'} capitalize`}>{type}</label>
                        <input
                          type="text"
                          value={pokemonEditForm.displacement[type]}
                          onChange={(e) => setPokemonEditForm({
                            ...pokemonEditForm,
                            displacement: {...pokemonEditForm.displacement, [type]: e.target.value}
                          })}
                          className={`w-full px-3 py-2 border-2 rounded-lg text-sm ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                        />
                      </div>
                    ))}
                  </div>
                </div>

                {/* 7. PESO E ALTURA */}
                <div className="grid md:grid-cols-2 gap-2 sm:gap-3 md:gap-4 mb-6">
                  <div>
                    <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>7. Peso (Kg)</label>
                    <input
                      type="number"
                      step="0.01"
                      value={pokemonEditForm.weight}
                      onChange={(e) => setPokemonEditForm({...pokemonEditForm, weight: e.target.value})}
                      className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                    />
                  </div>
                  <div>
                    <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Altura (M)</label>
                    <input
                      type="number"
                      step="0.01"
                      value={pokemonEditForm.height}
                      onChange={(e) => setPokemonEditForm({...pokemonEditForm, height: e.target.value})}
                      className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                    />
                  </div>
                </div>

                {/* 8. LEALDADE */}
                <div className="mb-6">
                  <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>8. Lealdade</label>
                  <input
                    type="text"
                    value={pokemonEditForm.loyalty}
                    onChange={(e) => setPokemonEditForm({...pokemonEditForm, loyalty: e.target.value})}
                    className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                  />
                </div>

                {/* 9. CAPACIDADES */}
                <div className="mb-6">
                  <label className={`block text-sm font-bold mb-4 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>9. Capacidades</label>

                  <div className="grid md:grid-cols-3 gap-2 sm:gap-3 md:gap-4 mb-4">
                    <div>
                      <label className={`block text-xs font-semibold mb-1 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Força (1-10)</label>
                      <input
                        type="number"
                        min="1"
                        max="10"
                        value={pokemonEditForm.capacities.forca}
                        onChange={(e) => setPokemonEditForm({
                          ...pokemonEditForm,
                          capacities: {...pokemonEditForm.capacities, forca: e.target.value}
                        })}
                        className={`w-full px-3 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                      />
                    </div>
                    <div>
                      <label className={`block text-xs font-semibold mb-1 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Inteligência (1-7)</label>
                      <input
                        type="number"
                        min="1"
                        max="7"
                        value={pokemonEditForm.capacities.inteligencia}
                        onChange={(e) => setPokemonEditForm({
                          ...pokemonEditForm,
                          capacities: {...pokemonEditForm.capacities, inteligencia: e.target.value}
                        })}
                        className={`w-full px-3 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                      />
                    </div>
                    <div>
                      <label className={`block text-xs font-semibold mb-1 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Salto (1-10)</label>
                      <input
                        type="number"
                        min="1"
                        max="10"
                        value={pokemonEditForm.capacities.salto}
                        onChange={(e) => setPokemonEditForm({
                          ...pokemonEditForm,
                          capacities: {...pokemonEditForm.capacities, salto: e.target.value}
                        })}
                        className={`w-full px-3 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                      />
                    </div>
                  </div>

                  <div>
                    <div className="flex justify-between items-center mb-2">
                      <label className={`block text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Outras Capacidades</label>
                      <button
                        onClick={() => {
                          setPokemonEditForm({
                            ...pokemonEditForm,
                            capacities: {
                              ...pokemonEditForm.capacities,
                              others: [...pokemonEditForm.capacities.others, '']
                            }
                          })
                        }}
                        className="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 text-sm font-semibold"
                      >
                        Outros +
                      </button>
                    </div>

                    <div className="space-y-2">
                      {pokemonEditForm.capacities.others.map((capacity, idx) => (
                        <div key={idx} className="flex gap-2">
                          <select
                            value={capacity}
                            onChange={(e) => {
                              const newOthers = [...pokemonEditForm.capacities.others]
                              newOthers[idx] = e.target.value
                              setPokemonEditForm({
                                ...pokemonEditForm,
                                capacities: {...pokemonEditForm.capacities, others: newOthers}
                              })
                            }}
                            className={`flex-1 px-3 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                          >
                            <option value="">Selecione uma capacidade</option>
                            {CAPACIDADES_NAMES.map((cap, i) => (
                              <option key={i} value={cap}>{cap}</option>
                            ))}
                          </select>
                          <button
                            onClick={() => {
                              const newOthers = pokemonEditForm.capacities.others.filter((_, i) => i !== idx)
                              setPokemonEditForm({
                                ...pokemonEditForm,
                                capacities: {...pokemonEditForm.capacities, others: newOthers}
                              })
                            }}
                            className="bg-red-500 text-white px-3 py-2 rounded hover:bg-red-600"
                          >
                            <X size={18} />
                          </button>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>

                {/* 10. DIETA */}
                <div className="mb-6">
                  <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>10. Dieta</label>
                  <div className="flex gap-3">
                    {[1, 2].map(slot => {
                      const slotKey = slot === 1 ? 'dietaSlot1' : 'dietaSlot2'
                      const selectedDiet = pokemonEditForm[slotKey]
                      const isOpen = showDietSlotDropdown === slot
                      return (
                        <div key={slot} className="relative">
                          <button
                            onClick={() => setShowDietSlotDropdown(isOpen ? null : slot)}
                            className={`flex flex-col items-center gap-1 p-3 rounded-lg border-2 min-w-[90px] transition-colors ${selectedDiet ? darkMode ? 'border-green-500 bg-gray-700' : 'border-green-500 bg-green-50' : darkMode ? 'border-gray-600 bg-gray-700 hover:border-gray-400' : 'border-gray-300 bg-gray-50 hover:border-gray-400'}`}
                          >
                            {selectedDiet ? (
                              <>
                                <img src={DIET_IMAGE_MAP[selectedDiet]} alt={selectedDiet} width={28} height={28} className="object-contain" onError={(e) => { e.target.style.display = 'none' }} />
                                <span className={`text-xs font-semibold text-center leading-tight ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>{selectedDiet}</span>
                              </>
                            ) : (
                              <>
                                <span className={`text-2xl ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>+</span>
                                <span className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>Dieta {slot}</span>
                              </>
                            )}
                          </button>
                          {isOpen && (
                            <div className={`absolute top-full left-0 mt-1 rounded-lg shadow-lg border z-10 min-w-[160px] ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-200'}`}>
                              <button
                                onClick={() => { setPokemonEditForm({...pokemonEditForm, [slotKey]: ''}); setShowDietSlotDropdown(null) }}
                                className={`w-full text-left px-3 py-2 text-sm rounded-t-lg ${darkMode ? 'text-gray-400 hover:bg-gray-600' : 'text-gray-500 hover:bg-gray-100'}`}
                              >
                                Nenhuma
                              </button>
                              {Object.keys(DIET_IMAGE_MAP).map(diet => (
                                <button
                                  key={diet}
                                  onClick={() => { setPokemonEditForm({...pokemonEditForm, [slotKey]: diet}); setShowDietSlotDropdown(null) }}
                                  className={`w-full flex items-center gap-2 px-3 py-2 text-sm ${selectedDiet === diet ? darkMode ? 'bg-gray-600' : 'bg-gray-100' : ''} ${darkMode ? 'text-gray-200 hover:bg-gray-600' : 'text-gray-700 hover:bg-gray-100'}`}
                                >
                                  <img src={DIET_IMAGE_MAP[diet]} alt={diet} width={20} height={20} className="object-contain" onError={(e) => { e.target.style.display = 'none' }} />
                                  {diet}
                                </button>
                              ))}
                            </div>
                          )}
                        </div>
                      )
                    })}
                  </div>
                </div>

                {/* BOTÕES */}
                <div className="flex gap-3 pt-4">
                  <button
                    onClick={() => { setShowEditPokemonPCModal(false); setShowDietSlotDropdown(null) }}
                    className={`flex-1 py-3 rounded-lg font-semibold ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                  >
                    Cancelar
                  </button>
                  <button
                    onClick={handleSaveEditPokemon}
                    className="flex-1 bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 font-semibold"
                  >
                    Salvar Edições
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* MODAL DE HELD ITEM - PC */}
        {showHeldItemPCModal && selectedPokemonForHeldItem && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowHeldItemPCModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-2xl w-full`} onClick={(e) => e.stopPropagation()}>
              <div className="p-3 sm:p-5 md:p-6">
                <div className="flex justify-between items-center mb-6">
                  <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-gray-200' : 'text-gray-800'}`}>
                    Held Item - {selectedPokemonForHeldItem.nickname} (PC)
                  </h3>
                  <button onClick={() => setShowHeldItemPCModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                    <X size={24} />
                  </button>
                </div>

                <div className="mb-4">
                  <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Nome do Item
                  </label>
                  <input
                    type="text"
                    value={heldItemName}
                    onChange={(e) => setHeldItemName(e.target.value)}
                    className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                    placeholder="Digite o nome do item..."
                  />
                </div>

                <div className="mb-6">
                  <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Descrição / Efeito
                  </label>
                  <textarea
                    value={heldItemDescription}
                    onChange={(e) => setHeldItemDescription(e.target.value)}
                    className={`w-full px-4 py-2 border-2 rounded-lg min-h-[120px] ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                    placeholder="Digite a descrição e efeito do item..."
                  />
                </div>

                <div className="flex gap-3">
                  <button
                    onClick={() => setShowHeldItemPCModal(false)}
                    className={`flex-1 py-3 rounded-lg font-semibold ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                  >
                    Cancelar
                  </button>
                  <button
                    onClick={handleSaveHeldItem}
                    className="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600 font-semibold"
                  >
                    Salvar Item
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* MODAL DE CUSTOM POKEBALL 2 OPTIONS (PC) */}
        {showCustomPokeball2Options && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4" onClick={handleCancelCustomPokeball2}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl max-w-md w-full shadow-2xl`} onClick={(e) => e.stopPropagation()}>
              <div className="p-3 sm:p-5 md:p-6">
                <div className="flex justify-between items-center mb-6">
                  <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-purple-400' : 'text-purple-700'}`}>
                    Custom Pokeball
                  </h3>
                  <button onClick={handleCancelCustomPokeball2} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                    <X size={24} />
                  </button>
                </div>

                <div className="mb-6">
                  <label className={`block text-sm font-bold mb-3 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Escolha como adicionar a imagem
                  </label>
                  <div className="flex gap-3 mb-4">
                    <button
                      onClick={() => setCustomPokeball2UploadType('link')}
                      className={`flex-1 py-2 px-4 rounded-lg font-semibold transition-all ${
                        customPokeball2UploadType === 'link'
                          ? darkMode ? 'bg-purple-600 text-white' : 'bg-purple-500 text-white'
                          : darkMode ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                      }`}
                    >
                      Link
                    </button>
                    <button
                      onClick={() => setCustomPokeball2UploadType('file')}
                      className={`flex-1 py-2 px-4 rounded-lg font-semibold transition-all ${
                        customPokeball2UploadType === 'file'
                          ? darkMode ? 'bg-purple-600 text-white' : 'bg-purple-500 text-white'
                          : darkMode ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                      }`}
                    >
                      Upload
                    </button>
                  </div>

                  {customPokeball2UploadType === 'link' ? (
                    <div>
                      <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                        URL da Imagem
                      </label>
                      <input
                        type="text"
                        value={customPokeball2Link}
                        onChange={(e) => setCustomPokeball2Link(e.target.value)}
                        className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                        placeholder="https://exemplo.com/pokeball.png"
                      />
                      {customPokeball2Link && (
                        <div className="mt-3 p-3 rounded-lg border-2 border-dashed border-gray-500 flex justify-center">
                          <img src={customPokeball2Link} alt="Preview" className="w-20 h-20 object-contain" onError={(e) => e.target.style.display = 'none'} />
                        </div>
                      )}
                    </div>
                  ) : (
                    <div>
                      <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                        Selecionar Arquivo
                      </label>
                      <input
                        type="file"
                        accept="image/*"
                        onChange={(e) => setCustomPokeball2File(e.target.files[0])}
                        className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                      />
                      {customPokeball2File && (
                        <div className="mt-3 p-3 rounded-lg border-2 border-dashed border-gray-500 flex justify-center">
                          <img src={URL.createObjectURL(customPokeball2File)} alt="Preview" className="w-20 h-20 object-contain" />
                        </div>
                      )}
                    </div>
                  )}
                </div>

                <div className="flex gap-3">
                  <button
                    onClick={handleCancelCustomPokeball2}
                    className={`flex-1 py-3 rounded-lg font-semibold ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                  >
                    Cancelar
                  </button>
                  <button
                    onClick={handleConfirmCustomPokeball2}
                    className="flex-1 bg-purple-500 text-white py-3 rounded-lg hover:bg-purple-600 font-semibold"
                  >
                    Confirmar
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* MODAL POKÉBOLA DE CAPTURA PC */}
        {showPokeballPCModal && selectedPokemonForPokeball && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowPokeballPCModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto`} onClick={(e) => e.stopPropagation()}>
              <div className="p-3 sm:p-5 md:p-6">
                <div className="flex justify-between items-center mb-6">
                  <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-purple-400' : 'text-purple-700'}`}>
                    Pokébola de Captura PC - {selectedPokemonForPokeball.nickname}
                  </h3>
                  <button onClick={() => setShowPokeballPCModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                    <X size={24} />
                  </button>
                </div>

                <div className="mb-4">
                  <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Buscar Pokébola
                  </label>
                  <div className="relative">
                    <Search className={`absolute left-3 top-1/2 transform -translate-y-1/2 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`} size={20} />
                    <input
                      type="text"
                      value={pokeballSearch}
                      onChange={(e) => setPokeballSearch(e.target.value)}
                      className={`w-full pl-10 pr-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                      placeholder="Digite o nome da pokébola..."
                    />
                  </div>
                </div>

                <div className="mb-6">
                  <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Pokébolas Disponíveis
                  </label>
                  <div className={`max-h-96 overflow-y-auto rounded-lg p-4 grid grid-cols-2 md:grid-cols-3 gap-3 ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                    {POKEBALLS_PC_LIST
                      .filter(ball => ball.toLowerCase().includes(pokeballSearch.toLowerCase()))
                      .map((ball, idx) => (
                        <button
                          key={idx}
                          onClick={() => handleSelectPokeballPC(ball)}
                          className={`p-3 rounded-lg flex flex-col items-center gap-2 transition-all border-2 ${
                            selectedPokeballForPC === ball || (selectedPokeballForPC === 'Custom Pokeball 2' && ball === 'Custom Pokeball 2')
                              ? darkMode ? 'bg-purple-600 border-purple-400' : 'bg-purple-200 border-purple-500'
                              : darkMode ? 'bg-gray-600 hover:bg-gray-500 border-transparent' : 'bg-white hover:bg-gray-50 border-transparent'
                          }`}
                        >
                          <img
                            src={ball === 'Custom Pokeball 2' ? `/pokeballs/custompokeball.png` : `/pokeballs/${ball.toLowerCase().replace(/\s+/g, '')}.png`}
                            alt={ball}
                            className="w-16 h-16 object-contain"
                          />
                          <span className={`text-xs font-semibold text-center ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                            {ball.replace(' 2', '')}
                          </span>
                        </button>
                      ))}
                  </div>
                </div>

                <div className="flex gap-3">
                  <button
                    onClick={() => setShowPokeballPCModal(false)}
                    className={`flex-1 py-3 rounded-lg font-semibold ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                  >
                    Cancelar
                  </button>
                  <button
                    onClick={handleSavePokeball}
                    className="flex-1 bg-purple-500 text-white py-3 rounded-lg hover:bg-purple-600 font-semibold"
                    disabled={!selectedPokeballForPC}
                  >
                    Salvar Pokébola
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* MODAL DE HABILIDADES - PC */}
        {showHabilidadesPCModal && selectedPokemonForHabilidades && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowHabilidadesPCModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-sm sm:max-w-2xl md:max-w-4xl w-full max-h-[90vh] overflow-y-auto`} onClick={(e) => e.stopPropagation()}>
              <div className="p-3 sm:p-5 md:p-6">
                <div className="flex justify-between items-center mb-6">
                  <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-teal-400' : 'text-teal-700'}`}>
                    Selecionar Habilidades - {selectedPokemonForHabilidades.nickname} (PC)
                  </h3>
                  <button onClick={() => setShowHabilidadesPCModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                    <X size={24} />
                  </button>
                </div>

                <div className="mb-6">
                  <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Habilidades Selecionadas ({habilidadesSelectedList.length}/2)
                  </label>
                  {habilidadesSelectedList.length === 0 ? (
                    <div className={`p-4 rounded-lg text-center ${darkMode ? 'bg-gray-700 text-gray-400' : 'bg-gray-100 text-gray-500'}`}>
                      Nenhuma habilidade selecionada
                    </div>
                  ) : (
                    <div className={`p-4 rounded-lg flex flex-wrap gap-2 ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                      {habilidadesSelectedList.map((hab, idx) => (
                        <div key={idx} className={`flex items-center gap-2 px-3 py-2 rounded ${darkMode ? 'bg-teal-600 text-white' : 'bg-teal-500 text-white'}`}>
                          <button
                            onClick={() => {
                              setSelectedHabilidadeForDetail(hab)
                              setShowHabilidadeDetailModal(true)
                            }}
                            className="font-semibold hover:underline"
                          >
                            {hab}
                          </button>
                          <button
                            onClick={() => handleRemoveHabilidadeFromSelected(hab)}
                            className="hover:bg-red-500 rounded p-1"
                          >
                            <X size={16} />
                          </button>
                        </div>
                      ))}
                    </div>
                  )}
                </div>

                <div className="mb-4">
                  <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Buscar Habilidades
                  </label>
                  <div className="relative">
                    <Search className={`absolute left-3 top-1/2 transform -translate-y-1/2 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`} size={20} />
                    <input
                      type="text"
                      value={habilidadesSearch}
                      onChange={(e) => setHabilidadesSearch(e.target.value)}
                      className={`w-full pl-10 pr-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                      placeholder="Digite o nome da habilidade..."
                    />
                  </div>
                </div>

                <div className="mb-6">
                  <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Habilidades Disponíveis
                  </label>
                  <div className={`max-h-64 overflow-y-auto rounded-lg p-4 space-y-2 ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                    {HABILIDADES_NAMES.length === 0 ? (
                      <div className={`p-4 text-center ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                        Nenhuma habilidade disponível
                      </div>
                    ) : HABILIDADES_NAMES
                      .filter(hab => hab.toLowerCase().includes(habilidadesSearch.toLowerCase()))
                      .filter(hab => !habilidadesSelectedList.includes(hab))
                      .length === 0 ? (
                      <div className={`p-4 text-center ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                        Nenhuma habilidade encontrada
                      </div>
                    ) : (
                      HABILIDADES_NAMES
                        .filter(hab => hab.toLowerCase().includes(habilidadesSearch.toLowerCase()))
                        .filter(hab => !habilidadesSelectedList.includes(hab))
                        .map((hab, idx) => (
                          <div key={idx} className={`flex items-center justify-between p-3 rounded transition-colors ${darkMode ? 'bg-gray-600 hover:bg-gray-500' : 'bg-white hover:bg-gray-50'}`}>
                            <div className="flex-1">
                              <button
                                onClick={() => {
                                  setSelectedHabilidadeForDetail(hab)
                                  setShowHabilidadeDetailModal(true)
                                }}
                                className={`font-semibold hover:underline text-left ${darkMode ? 'text-white' : 'text-gray-800'}`}
                              >
                                {hab}
                              </button>
                              <div className={`text-xs mt-1 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                <span className="mr-3">Ativação: {HABILIDADES_DATA[hab]?.ativacao || 'N/A'}</span>
                              </div>
                            </div>
                            <button
                              onClick={() => handleAddHabilidadeToSelected(hab)}
                              className={`ml-2 p-2 rounded text-white ${darkMode ? 'bg-green-600 hover:bg-green-700' : 'bg-green-500 hover:bg-green-600'}`}
                            >
                              <Plus size={16} />
                            </button>
                          </div>
                        ))
                    )}
                  </div>
                </div>

                <div className="flex gap-3">
                  <button
                    onClick={() => setShowHabilidadesPCModal(false)}
                    className={`flex-1 py-3 rounded-lg font-semibold ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                  >
                    Cancelar
                  </button>
                  <button
                    onClick={handleSaveHabilidades}
                    className="flex-1 bg-teal-500 text-white py-3 rounded-lg hover:bg-teal-600 font-semibold"
                    disabled={habilidadesSelectedList.length < 1}
                  >
                    Salvar Habilidades
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* MODAL NAME RATER PC */}
        {showNameRaterPCModal && nameRaterPCIndex !== null && pcPokemon[nameRaterPCIndex] && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowNameRaterPCModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-3 sm:p-5 md:p-8 rounded-2xl shadow-2xl max-w-md w-full`} onClick={(e) => e.stopPropagation()}>
              <div className="flex justify-between items-center mb-4">
                <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-purple-400' : 'text-purple-600'}`}>Name Rater PC</h3>
                <button onClick={() => setShowNameRaterPCModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                  <X size={24} />
                </button>
              </div>
              <div className="mb-4">
                <p className={`text-center mb-4 italic ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                  Ele tem um nome feio mesmo, quer algumas dicas?
                </p>
                <input
                  type="text"
                  value={nameRaterPCNickname}
                  onChange={e => setNameRaterPCNickname(e.target.value)}
                  placeholder="Novo nome do Pokémon"
                  className={`w-full px-3 py-2 sm:px-4 sm:py-3 border-2 rounded-lg text-sm sm:text-base text-center text-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-500' : 'border-gray-300'}`}
                  maxLength={30}
                />
              </div>
              <button
                onClick={() => {
                  if (nameRaterPCNickname.trim()) {
                    const updatedPC = [...pcPokemon]
                    updatedPC[nameRaterPCIndex] = {
                      ...updatedPC[nameRaterPCIndex],
                      nickname: nameRaterPCNickname.trim()
                    }
                    setPcPokemon(updatedPC)
                    setShowNameRaterPCModal(false)
                    setNameRaterPCIndex(null)
                    setNameRaterPCNickname('')
                  }
                }}
                className="w-full bg-purple-500 text-white py-3 rounded-lg hover:bg-purple-600 font-semibold"
              >
                Renomear
              </button>
            </div>
          </div>
        )}

        {/* Modal de Detalhes da Habilidade - PC */}
        {showHabilidadeDetailModal && selectedHabilidadeForDetail && HABILIDADES_DATA?.[selectedHabilidadeForDetail] && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowHabilidadeDetailModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-3 sm:p-5 md:p-8 rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto`} onClick={(e) => e.stopPropagation()}>
              <div className="flex justify-between items-center mb-6">
                <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-teal-400' : 'text-teal-700'}`}>{selectedHabilidadeForDetail}</h3>
                <button onClick={() => setShowHabilidadeDetailModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                  <X size={24} />
                </button>
              </div>
              <div className={`mb-4 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                <p className="mb-2">
                  <span className="font-semibold">Ativação:</span>{' '}
                  <span className={`px-2 py-1 rounded ${darkMode ? 'bg-teal-900 text-teal-300' : 'bg-teal-100 text-teal-800'}`}>
                    {HABILIDADES_DATA[selectedHabilidadeForDetail]?.ativacao || 'N/A'}
                  </span>
                </p>
              </div>
              <div className={`${darkMode ? 'text-gray-300' : 'text-gray-700'} text-base leading-relaxed`}>
                <p className="font-semibold mb-2">Efeito:</p>
                <p>{HABILIDADES_DATA[selectedHabilidadeForDetail]?.efeito || 'Descrição não disponível'}</p>

                {/* Tabela da Habilidade (se houver) */}
                {HABILIDADES_DATA[selectedHabilidadeForDetail]?.tabela && (
                  <div className="mt-4 overflow-x-auto">
                    <table className={`w-full text-sm border-collapse ${
                      darkMode ? 'border-gray-600' : 'border-gray-300'
                    }`}>
                      <thead>
                        <tr className={darkMode ? 'bg-gray-700' : 'bg-teal-100'}>
                          {Object.keys(HABILIDADES_DATA[selectedHabilidadeForDetail].tabela[0]).map(key => (
                            <th key={key} className={`border p-2 font-semibold text-left ${
                              darkMode ? 'border-gray-600 text-teal-300' : 'border-gray-300 text-teal-900'
                            }`}>
                              {key === 'resultado' ? 'Resultado' :
                               key === 'efeito' ? 'Efeito' :
                               key === 'item' ? 'Item' :
                               key === 'clima' ? 'Clima' :
                               key === 'tipo' ? 'Tipo' :
                               key === 'dado' ? 'Dado' :
                               key.charAt(0).toUpperCase() + key.slice(1)}
                            </th>
                          ))}
                        </tr>
                      </thead>
                      <tbody>
                        {HABILIDADES_DATA[selectedHabilidadeForDetail].tabela.map((linha, idx) => (
                          <tr key={idx} className={idx % 2 === 0
                            ? (darkMode ? 'bg-gray-800' : 'bg-white')
                            : (darkMode ? 'bg-gray-750' : 'bg-teal-50')
                          }>
                            {Object.keys(linha).map(key => (
                              <td key={key} className={`border p-2 ${
                                key === 'resultado'
                                  ? `font-bold ${darkMode ? 'border-gray-600 text-teal-400' : 'border-gray-300 text-teal-700'}`
                                  : `${darkMode ? 'border-gray-600 text-gray-300' : 'border-gray-300 text-gray-700'}`
                              }`}>
                                {linha[key]}
                              </td>
                            ))}
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                )}
              </div>
              <div className="flex justify-end mt-6">
                <button
                  onClick={() => setShowHabilidadeDetailModal(false)}
                  className="bg-teal-500 text-white px-3 sm:px-5 md:px-6 py-2 rounded-lg hover:bg-teal-600 font-semibold"
                >
                  Fechar
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Modal de Informação de Capacidade - PC */}
        {showCapacityInfoModal && selectedCapacityForInfo && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowCapacityInfoModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-3 sm:p-5 md:p-8 rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto`} onClick={(e) => e.stopPropagation()}>
              <div className="flex justify-between items-center mb-6">
                <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{selectedCapacityForInfo}</h3>
                <button onClick={() => setShowCapacityInfoModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                  <X size={24} />
                </button>
              </div>
              <div className={`${darkMode ? 'text-gray-300' : 'text-gray-700'} text-base leading-relaxed`}>
                {typeof CAPACIDADES_DATA[selectedCapacityForInfo] === 'string'
                  ? CAPACIDADES_DATA[selectedCapacityForInfo]
                  : CAPACIDADES_DATA[selectedCapacityForInfo].descricao}

                {/* Tabela da Capacidade (se houver) */}
                {typeof CAPACIDADES_DATA[selectedCapacityForInfo] === 'object' && CAPACIDADES_DATA[selectedCapacityForInfo].tabela && (
                  <div className="mt-4 overflow-x-auto">
                    <table className={`w-full text-sm border-collapse ${
                      darkMode ? 'border-gray-600' : 'border-gray-300'
                    }`}>
                      <thead>
                        <tr className={darkMode ? 'bg-gray-700' : 'bg-gray-100'}>
                          {Object.keys(CAPACIDADES_DATA[selectedCapacityForInfo].tabela[0]).map(key => (
                            <th key={key} className={`border p-2 font-semibold text-left ${
                              darkMode ? 'border-gray-600 text-teal-300' : 'border-gray-300 text-gray-800'
                            }`}>
                              {key === 'força' ? 'Força' :
                               key === 'peso' ? 'Peso Erguido' :
                               key === 'inteligência' ? 'Inteligência' :
                               key === 'intelecto' ? 'Intelecto' :
                               key === 'pensamentos' ? 'Pensamentos' :
                               key === 'salto' ? 'Salto' :
                               key === 'altura' ? 'Altura' :
                               key === 'resultado' ? 'Resultado' :
                               key === 'área' ? 'Área' :
                               key === 'par' ? 'Par de Espécies' :
                               key === 'condição' ? 'Condição' :
                               key.charAt(0).toUpperCase() + key.slice(1)}
                            </th>
                          ))}
                        </tr>
                      </thead>
                      <tbody>
                        {CAPACIDADES_DATA[selectedCapacityForInfo].tabela.map((linha, idx) => (
                          <tr key={idx} className={idx % 2 === 0
                            ? (darkMode ? 'bg-gray-800' : 'bg-white')
                            : (darkMode ? 'bg-gray-750' : 'bg-gray-50')
                          }>
                            {Object.keys(linha).map(key => (
                              <td key={key} className={`border p-2 ${
                                ['força', 'inteligência', 'salto', 'resultado'].includes(key)
                                  ? `font-bold ${darkMode ? 'border-gray-600 text-teal-400' : 'border-gray-300 text-teal-700'}`
                                  : `${darkMode ? 'border-gray-600 text-gray-300' : 'border-gray-300 text-gray-700'}`
                              }`}>
                                {linha[key]}
                              </td>
                            ))}
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                )}
              </div>
              <div className="flex justify-end mt-6">
                <button
                  onClick={() => setShowCapacityInfoModal(false)}
                  className="bg-blue-500 text-white px-3 sm:px-5 md:px-6 py-2 rounded-lg hover:bg-blue-600 font-semibold"
                >
                  Fechar
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Modal Move Pokémon */}
        {showSwapPokemonModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => {
            setShowSwapPokemonModal(false)
            setSwapMainTeamSearch('')
            setSwapPcSearch('')
            setSelectedSwapMainTeam(null)
            setSelectedSwapPc(null)
          }}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-md w-full`} onClick={(e) => e.stopPropagation()}>
              <div className="p-3 sm:p-5 md:p-6">
                <div className="flex justify-between items-center mb-6">
                  <h3 className={`text-lg sm:text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                    Move Pokémon
                  </h3>
                  <button onClick={() => {
                    setShowSwapPokemonModal(false)
                    setSwapMainTeamSearch('')
                    setSwapPcSearch('')
                    setSelectedSwapMainTeam(null)
                    setSelectedSwapPc(null)
                  }} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                    <X size={24} />
                  </button>
                </div>

                <div className="space-y-4">
                  {/* Seleção do Time Principal */}
                  <div>
                    <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-cyan-400' : 'text-cyan-700'}`}>
                      Time Principal → PC
                    </label>
                    <div className="relative">
                      <input
                        type="text"
                        value={swapMainTeamSearch}
                        onChange={(e) => {
                          setSwapMainTeamSearch(e.target.value)
                          setSelectedSwapMainTeam(null)
                        }}
                        placeholder="Pesquisar no time principal..."
                        className={`w-full px-3 py-2 sm:px-4 rounded-lg border-2 text-sm sm:text-base ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                      />
                      {swapMainTeamSearch && !selectedSwapMainTeam && (
                        <div className={`absolute z-10 w-full mt-1 max-h-40 overflow-y-auto rounded-lg shadow-lg ${darkMode ? 'bg-gray-700' : 'bg-white'} border ${darkMode ? 'border-gray-600' : 'border-gray-300'}`}>
                          {mainTeam
                            .filter(p =>
                              (p.nickname || '').toLowerCase().includes(swapMainTeamSearch.toLowerCase())
                            )
                            .map((pokemon, index) => (
                              <div
                                key={pokemon.id || index}
                                onClick={() => {
                                  setSelectedSwapMainTeam(pokemon)
                                  setSwapMainTeamSearch(pokemon.nickname || pokemon.species)
                                }}
                                className={`px-4 py-2 cursor-pointer ${darkMode ? 'hover:bg-gray-600 text-white' : 'hover:bg-gray-100 text-gray-800'}`}
                              >
                                {pokemon.nickname || pokemon.species} {pokemon.shiny && '✨'} {pokemon.legendary && '👑'} <span className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>(Nv. {pokemon.level})</span>
                              </div>
                            ))
                          }
                          {mainTeam.filter(p =>
                            (p.nickname || '').toLowerCase().includes(swapMainTeamSearch.toLowerCase())
                          ).length === 0 && (
                            <div className={`px-4 py-2 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                              Nenhum pokémon encontrado
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                    {selectedSwapMainTeam && (
                      <div className={`mt-2 p-2 rounded-lg ${darkMode ? 'bg-cyan-900 text-cyan-300' : 'bg-cyan-100 text-cyan-800'} text-sm`}>
                        Selecionado: <strong>{selectedSwapMainTeam.nickname || selectedSwapMainTeam.species}</strong> (Nv. {selectedSwapMainTeam.level})
                      </div>
                    )}
                  </div>

                  {/* Ícone de troca */}
                  <div className="flex justify-center">
                    <MoveVertical size={32} className={darkMode ? 'text-purple-400' : 'text-purple-600'} />
                  </div>

                  {/* Seleção do PC */}
                  <div>
                    <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-blue-400' : 'text-blue-700'}`}>
                      PC → Time Principal
                    </label>
                    <div className="relative">
                      <input
                        type="text"
                        value={swapPcSearch}
                        onChange={(e) => {
                          setSwapPcSearch(e.target.value)
                          setSelectedSwapPc(null)
                        }}
                        placeholder="Pesquisar no PC..."
                        className={`w-full px-3 py-2 sm:px-4 rounded-lg border-2 text-sm sm:text-base ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                      />
                      {swapPcSearch && !selectedSwapPc && (
                        <div className={`absolute z-10 w-full mt-1 max-h-40 overflow-y-auto rounded-lg shadow-lg ${darkMode ? 'bg-gray-700' : 'bg-white'} border ${darkMode ? 'border-gray-600' : 'border-gray-300'}`}>
                          {pcPokemon
                            .filter(p =>
                              (p.nickname || '').toLowerCase().includes(swapPcSearch.toLowerCase())
                            )
                            .map((pokemon, index) => (
                              <div
                                key={pokemon.id || index}
                                onClick={() => {
                                  setSelectedSwapPc(pokemon)
                                  setSwapPcSearch(pokemon.nickname || pokemon.species)
                                }}
                                className={`px-4 py-2 cursor-pointer ${darkMode ? 'hover:bg-gray-600 text-white' : 'hover:bg-gray-100 text-gray-800'}`}
                              >
                                {pokemon.nickname || pokemon.species} {pokemon.shiny && '✨'} {pokemon.legendary && '👑'} <span className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>(Nv. {pokemon.level})</span>
                              </div>
                            ))
                          }
                          {pcPokemon.filter(p =>
                            (p.nickname || '').toLowerCase().includes(swapPcSearch.toLowerCase())
                          ).length === 0 && (
                            <div className={`px-4 py-2 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                              Nenhum pokémon encontrado
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                    {selectedSwapPc && (
                      <div className={`mt-2 p-2 rounded-lg ${darkMode ? 'bg-blue-900 text-blue-300' : 'bg-blue-100 text-blue-800'} text-sm`}>
                        Selecionado: <strong>{selectedSwapPc.nickname || selectedSwapPc.species}</strong> (Nv. {selectedSwapPc.level})
                      </div>
                    )}
                  </div>

                  <button
                    onClick={() => {
                      if (selectedSwapMainTeam && selectedSwapPc) {
                        // Remove do time principal e adiciona no PC
                        const newMainTeam = mainTeam.filter(p => p.id !== selectedSwapMainTeam.id)
                        newMainTeam.push(selectedSwapPc)

                        // Remove do PC e adiciona no time principal
                        const newPcPokemon = pcPokemon.filter(p => p.id !== selectedSwapPc.id)
                        newPcPokemon.push(selectedSwapMainTeam)

                        setMainTeam(newMainTeam)
                        setPcPokemon(newPcPokemon)

                        // Limpa o modal
                        setShowSwapPokemonModal(false)
                        setSwapMainTeamSearch('')
                        setSwapPcSearch('')
                        setSelectedSwapMainTeam(null)
                        setSelectedSwapPc(null)
                      }
                    }}
                    disabled={!selectedSwapMainTeam || !selectedSwapPc}
                    className="w-full bg-purple-500 text-white py-3 rounded-lg hover:bg-purple-600 font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    Mover
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Modal Sedex Pkm */}
        {showSedexPkmModal && (
          <div
            className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
            onClick={() => setShowSedexPkmModal(false)}
          >
            <div
              className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto`}
              onClick={(e) => e.stopPropagation()}
            >
              <div className="p-3 sm:p-5 md:p-6">
                {/* Header */}
                <div className="flex justify-between items-center mb-6">
                  <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                    📦 Sedex Pkm
                  </h3>
                  <button
                    onClick={() => setShowSedexPkmModal(false)}
                    className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}
                  >
                    <X size={24} />
                  </button>
                </div>

                {/* Busca de Pokémon */}
                <div className="mb-6">
                  <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Selecione um Pokémon do PC
                  </label>
                  <input
                    type="text"
                    value={sedexPkmSearch}
                    onChange={(e) => setSedexPkmSearch(e.target.value)}
                    placeholder="Buscar por nickname..."
                    className={`w-full px-3 py-2 sm:px-4 sm:py-3 border-2 rounded-lg text-sm sm:text-base mb-4 ${
                      darkMode
                        ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400'
                        : 'border-gray-300 placeholder-gray-400'
                    }`}
                  />

                  {/* Lista de Pokémons */}
                  <div className={`max-h-64 overflow-y-auto border-2 rounded-lg ${
                    darkMode ? 'border-gray-600' : 'border-gray-300'
                  }`}>
                    {pcPokemon.length === 0 ? (
                      <p className={`text-center py-3 sm:py-5 md:py-8 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                        Nenhum Pokémon no PC
                      </p>
                    ) : (
                      pcPokemon
                        .filter(pkm => {
                          const searchLower = sedexPkmSearch.toLowerCase()
                          const nickname = (pkm.nickname || '').toLowerCase()
                          const species = (pkm.species || '').toLowerCase()
                          return nickname.includes(searchLower) || species.includes(searchLower)
                        })
                        .map((pkm, idx) => (
                          <button
                            key={idx}
                            onClick={() => setSelectedSedexPkm(pkm)}
                            className={`w-full p-4 text-left border-b transition-colors ${
                              selectedSedexPkm?.id === pkm.id
                                ? 'bg-blue-500 text-white'
                                : darkMode
                                  ? 'bg-gray-700 border-gray-600 hover:bg-gray-600 text-white'
                                  : 'bg-white border-gray-200 hover:bg-gray-50 text-gray-800'
                            }`}
                          >
                            <div className="flex items-center gap-3">
                              {pkm.customImage && (
                                <img
                                  src={pkm.customImage}
                                  alt={pkm.nickname || pkm.species}
                                  className="w-12 h-12 object-contain"
                                  onError={(e) => { e.target.style.display = 'none' }}
                                />
                              )}
                              <div>
                                <p className="font-bold">
                                  {pkm.nickname || pkm.species}
                                  {pkm.shiny && ' ✨'}
                                </p>
                                <p className="text-sm opacity-80">
                                  {pkm.species} - Nv. {pkm.level}
                                </p>
                              </div>
                            </div>
                          </button>
                        ))
                    )}
                  </div>
                </div>

                {/* Seleção de Treinador */}
                <div className="mb-6">
                  <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Selecione o Treinador Destinatário
                  </label>
                  <div className={`max-h-48 overflow-y-auto border-2 rounded-lg p-4 space-y-2 ${
                    darkMode ? 'border-gray-600 bg-gray-700' : 'border-gray-300 bg-gray-50'
                  }`}>
                    {users
                      .filter(user => user.type === 'treinador' && user.username !== currentUser?.username)
                      .map((trainer, idx) => (
                        <label
                          key={idx}
                          className={`flex items-center gap-3 p-3 rounded-lg cursor-pointer transition-colors ${
                            selectedSedexPkmTrainer === trainer.username
                              ? 'bg-blue-500 text-white'
                              : darkMode
                                ? 'bg-gray-600 hover:bg-gray-500 text-white'
                                : 'bg-white hover:bg-gray-100 text-gray-800'
                          }`}
                        >
                          <input
                            type="checkbox"
                            checked={selectedSedexPkmTrainer === trainer.username}
                            onChange={(e) => setSelectedSedexPkmTrainer(e.target.checked ? trainer.username : '')}
                            className="w-5 h-5"
                          />
                          <span className="font-semibold">{trainer.username}</span>
                        </label>
                      ))}
                  </div>
                </div>

                {/* Botão Enviar */}
                <div className="flex gap-3">
                  <button
                    onClick={() => setShowSedexPkmModal(false)}
                    className={`flex-1 py-3 rounded-lg font-semibold ${
                      darkMode
                        ? 'bg-gray-600 text-gray-200 hover:bg-gray-500'
                        : 'bg-gray-300 text-gray-700 hover:bg-gray-400'
                    }`}
                  >
                    Cancelar
                  </button>
                  <button
                    onClick={handleDispatchPokemon}
                    disabled={!selectedSedexPkm || !selectedSedexPkmTrainer}
                    className={`flex-1 py-3 rounded-lg font-semibold ${
                      !selectedSedexPkm || !selectedSedexPkmTrainer
                        ? 'bg-gray-400 text-gray-600 cursor-not-allowed'
                        : 'bg-gradient-to-r from-green-600 to-emerald-700 text-white hover:from-green-700 hover:to-emerald-800'
                    }`}
                  >
                    Enviar
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* MODAL DE EDIÇÃO DE TIPOS DO POKÉMON (ELEMENTALISTA) - ÁREA PC */}
        {showPokemonTypeEditModal && selectedPokemonForTypeEdit && pokemonTypeEditSource === 'pc' && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowPokemonTypeEditModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto`} onClick={(e) => e.stopPropagation()}>
              <div className="p-3 sm:p-5 md:p-6">
                <div className="flex justify-between items-center mb-6">
                  <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-orange-400' : 'text-orange-700'} flex items-center gap-2`}>
                    <Flame size={28} />
                    Editar Tipos - {selectedPokemonForTypeEdit.nickname}
                  </h3>
                  <button onClick={() => setShowPokemonTypeEditModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                    <X size={24} />
                  </button>
                </div>

                {/* Tipos Selecionados */}
                <div className="mb-6">
                  <h4 className={`text-lg font-bold mb-3 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Tipos Selecionados ({getPokemonTypes(selectedPokemonForTypeEdit).length})
                  </h4>
                  {getPokemonTypes(selectedPokemonForTypeEdit).length > 0 ? (
                    <div className="flex flex-wrap gap-2">
                      {getPokemonTypes(selectedPokemonForTypeEdit).map((type, idx) => (
                        <div
                          key={idx}
                          className="flex items-center gap-2 px-3 py-2 rounded-lg font-semibold text-white shadow-md"
                          style={{
                            background: TYPE_STYLES[type]?.gradient || 'linear-gradient(135deg, #718096 0%, #4A5568 100%)',
                          }}
                        >
                          <span>{type}</span>
                          <button
                            onClick={() => {
                              const currentTypes = getPokemonTypes(selectedPokemonForTypeEdit)
                              if (currentTypes.length > 1) {
                                const newTypes = currentTypes.filter((_, i) => i !== idx)
                                setSelectedPokemonForTypeEdit({
                                  ...selectedPokemonForTypeEdit,
                                  types: newTypes
                                })
                              } else {
                                alert('Um Pokémon deve ter pelo menos um tipo!')
                              }
                            }}
                            className="hover:bg-black/20 rounded-full p-0.5"
                            title="Remover tipo"
                          >
                            <X size={16} />
                          </button>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <p className={`text-sm italic ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                      Nenhum tipo selecionado
                    </p>
                  )}
                </div>

                {/* Tipos Disponíveis */}
                <div className="mb-6">
                  <h4 className={`text-lg font-bold mb-3 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Tipos Disponíveis
                  </h4>
                  <div className="grid grid-cols-2 sm:grid-cols-3 gap-3">
                    {POKEMON_TYPES.map((type) => {
                      const isSelected = getPokemonTypes(selectedPokemonForTypeEdit).includes(type)
                      return (
                        <button
                          key={type}
                          onClick={() => {
                            const currentTypes = getPokemonTypes(selectedPokemonForTypeEdit)
                            if (!isSelected && currentTypes.length < 3) {
                              const newTypes = [...currentTypes, type]
                              setSelectedPokemonForTypeEdit({
                                ...selectedPokemonForTypeEdit,
                                types: newTypes
                              })
                            } else if (!isSelected && currentTypes.length >= 3) {
                              alert('Um Pokémon pode ter no máximo 3 tipos!')
                            }
                          }}
                          disabled={isSelected}
                          className={`px-4 py-3 rounded-lg font-semibold text-white shadow-md transition-all ${
                            isSelected ? 'opacity-50 cursor-not-allowed' : 'hover:opacity-80 cursor-pointer'
                          }`}
                          style={{
                            background: TYPE_STYLES[type]?.gradient || 'linear-gradient(135deg, #718096 0%, #4A5568 100%)',
                          }}
                        >
                          {type}
                        </button>
                      )
                    })}
                  </div>
                </div>

                {/* Botões de Ação */}
                <div className="flex gap-3">
                  <button
                    onClick={() => setShowPokemonTypeEditModal(false)}
                    className={`py-3 px-4 rounded-lg font-semibold ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-800'}`}
                  >
                    Cancelar
                  </button>
                  <button
                    onClick={() => {
                      if (confirm('Deseja restaurar a tipagem original do Pokémon?')) {
                        const pokemonIndex = pcPokemon.findIndex(p => p.id === selectedPokemonForTypeEdit.id)
                        if (pokemonIndex !== -1) {
                          const updatedPC = [...pcPokemon]
                          // Remover a propriedade types customizada
                          const { types, ...pokemonWithoutCustomTypes } = updatedPC[pokemonIndex]
                          updatedPC[pokemonIndex] = pokemonWithoutCustomTypes
                          setPcPokemon(updatedPC)
                        }
                        setShowPokemonTypeEditModal(false)
                        setSelectedPokemonForTypeEdit(null)
                        setPokemonTypeEditSource(null)
                      }
                    }}
                    className={`py-3 px-4 rounded-lg font-semibold ${darkMode ? 'bg-yellow-600 hover:bg-yellow-700 text-white' : 'bg-yellow-500 hover:bg-yellow-600 text-white'} shadow-lg`}
                  >
                    Restaurar tipagem
                  </button>
                  <button
                    onClick={() => {
                      const updatedTypes = getPokemonTypes(selectedPokemonForTypeEdit)
                      const pokemonIndex = pcPokemon.findIndex(p => p.id === selectedPokemonForTypeEdit.id)
                      if (pokemonIndex !== -1) {
                        const updatedPC = [...pcPokemon]
                        updatedPC[pokemonIndex] = {
                          ...updatedPC[pokemonIndex],
                          types: updatedTypes
                        }
                        setPcPokemon(updatedPC)
                      }
                      setShowPokemonTypeEditModal(false)
                      setSelectedPokemonForTypeEdit(null)
                      setPokemonTypeEditSource(null)
                    }}
                    className="flex-1 bg-gradient-to-r from-orange-600 to-red-700 text-white py-3 rounded-lg hover:opacity-90 font-semibold shadow-lg"
                  >
                    Salvar Tipos
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        </div>

        {/* MODAL DE EVOLUÇÃO (PC) */}
        {showEvolutionModal && selectedPokemonForEvolution && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowEvolutionModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-3 sm:p-5 md:p-8 rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto`} onClick={(e) => e.stopPropagation()}>
              <div className="flex justify-between items-center mb-4">
                <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  <Sparkles className="inline mr-2" size={24} />
                  Evoluir Pokémon
                </h3>
                <button onClick={() => setShowEvolutionModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                  <X size={24} />
                </button>
              </div>

              <div className={`mb-6 p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Pokémon atual:</p>
                <p className={`text-lg sm:text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  {selectedPokemonForEvolution.nickname} ({selectedPokemonForEvolution.species})
                </p>
              </div>

              <div className="mb-4">
                <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>
                  Buscar nova espécie:
                </label>
                <div className="relative">
                  <Search className={`absolute left-3 top-1/2 transform -translate-y-1/2 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`} size={18} />
                  <input
                    type="text"
                    value={evolutionSearch}
                    onChange={(e) => setEvolutionSearch(e.target.value)}
                    placeholder="Digite o nome da espécie..."
                    className={`w-full pl-10 pr-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-500' : 'border-gray-300'}`}
                  />
                </div>
              </div>

              <div className={`mb-4 max-h-60 overflow-y-auto rounded-lg border-2 ${darkMode ? 'border-gray-600' : 'border-gray-300'}`}>
                {getEvolutionOptions().length > 0 ? (
                  getEvolutionOptions().slice(0, 50).map((option, index) => (
                    <button
                      key={`${option.nome}-${index}`}
                      onClick={() => setSelectedEvolutionSpecies(option)}
                      className={`w-full p-3 text-left transition-colors ${
                        selectedEvolutionSpecies?.nome === option.nome
                          ? darkMode
                            ? 'bg-emerald-600 text-white'
                            : 'bg-emerald-500 text-white'
                          : darkMode
                            ? 'hover:bg-gray-700 text-white'
                            : 'hover:bg-gray-100 text-gray-800'
                      } ${index !== 0 ? 'border-t ' + (darkMode ? 'border-gray-600' : 'border-gray-200') : ''}`}
                    >
                      <span className="font-semibold">{option.nome}</span>
                      {option.isExotic && (
                        <span className={`ml-2 text-xs px-2 py-0.5 rounded ${darkMode ? 'bg-purple-600' : 'bg-purple-500'} text-white`}>
                          Exótico
                        </span>
                      )}
                    </button>
                  ))
                ) : (
                  <p className={`p-4 text-center ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                    Nenhuma espécie encontrada
                  </p>
                )}
                {getEvolutionOptions().length > 50 && (
                  <p className={`p-2 text-center text-sm ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                    Mostrando primeiros 50 resultados. Refine sua busca.
                  </p>
                )}
              </div>

              {selectedEvolutionSpecies && (
                <div className={`mb-4 p-4 rounded-lg ${darkMode ? 'bg-emerald-900' : 'bg-emerald-100'}`}>
                  <p className={`text-sm ${darkMode ? 'text-emerald-300' : 'text-emerald-700'}`}>Evoluir para:</p>
                  <p className={`text-lg sm:text-xl font-bold ${darkMode ? 'text-emerald-100' : 'text-emerald-800'}`}>
                    {selectedEvolutionSpecies.nome}
                    {selectedEvolutionSpecies.isExotic && ' (Exótico)'}
                  </p>
                </div>
              )}

              <div className={`mb-4 p-3 rounded-lg text-sm ${darkMode ? 'bg-yellow-900 text-yellow-200' : 'bg-yellow-100 text-yellow-800'}`}>
                <strong>Nota:</strong> A evolução irá atualizar apenas os atributos basais, altura, peso e espécie. Todos os outros dados (nível, XP, golpes, habilidades, etc.) serão mantidos.
              </div>

              <div className="flex gap-3">
                <button
                  onClick={() => setShowEvolutionModal(false)}
                  className={`flex-1 py-3 rounded-lg font-semibold ${darkMode ? 'bg-gray-600 hover:bg-gray-500 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-800'}`}
                >
                  Cancelar
                </button>
                <button
                  onClick={handleEvolution}
                  disabled={!selectedEvolutionSpecies}
                  className={`flex-1 py-3 rounded-lg font-semibold flex items-center justify-center gap-2 ${
                    selectedEvolutionSpecies
                      ? 'bg-emerald-500 hover:bg-emerald-600 text-white'
                      : darkMode
                        ? 'bg-gray-700 text-gray-500 cursor-not-allowed'
                        : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                  }`}
                >
                  <Sparkles size={18} />
                  Evoluir!
                </button>
              </div>
            </div>
          </div>
        )}

        {accountDataModal}
        {scenarioPopupOverlay}
        {mostrarTriunfosOverlay}
        {pokezapPanel}{pokeAgendaPanel}
        {batalhaChatPanel}

        {/* Modal de Edição de Aptidões — PC */}
        {showAptidoesModal && aptidoesEditingPokemon && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowAptidoesModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-sm w-full`} onClick={e => e.stopPropagation()}>
              <div className={`${darkMode ? 'bg-gray-700' : 'bg-gradient-to-r from-indigo-500 to-purple-600'} p-4 rounded-t-2xl flex justify-between items-center`}>
                <div>
                  <h3 className="text-lg font-bold text-white flex items-center gap-2">
                    <TowerControl size={20} /> Aptidões
                  </h3>
                  <p className="text-indigo-200 text-xs mt-0.5">{aptidoesEditingPokemon.pokemon.nickname || aptidoesEditingPokemon.pokemon.species}</p>
                </div>
                <button onClick={() => setShowAptidoesModal(false)} className="text-white hover:text-gray-300"><X size={24} /></button>
              </div>
              <div className="p-5 space-y-3">
                {[
                  { key: 'estilo', label: 'Estilo', bg: darkMode ? 'bg-red-900' : 'bg-red-50', border: darkMode ? 'border-red-700' : 'border-red-300', text: darkMode ? 'text-red-300' : 'text-red-700' },
                  { key: 'beleza', label: 'Beleza', bg: darkMode ? 'bg-blue-900' : 'bg-blue-50', border: darkMode ? 'border-blue-700' : 'border-blue-300', text: darkMode ? 'text-blue-300' : 'text-blue-700' },
                  { key: 'ternura', label: 'Ternura', bg: darkMode ? 'bg-pink-900' : 'bg-pink-50', border: darkMode ? 'border-pink-700' : 'border-pink-300', text: darkMode ? 'text-pink-300' : 'text-pink-700' },
                  { key: 'perspicacia', label: 'Perspicácia', bg: darkMode ? 'bg-green-900' : 'bg-green-50', border: darkMode ? 'border-green-700' : 'border-green-300', text: darkMode ? 'text-green-300' : 'text-green-700' },
                  { key: 'vigor', label: 'Vigor', bg: darkMode ? 'bg-yellow-900' : 'bg-yellow-50', border: darkMode ? 'border-yellow-700' : 'border-yellow-300', text: darkMode ? 'text-yellow-300' : 'text-yellow-700' }
                ].map(apt => (
                  <div key={apt.key} className={`flex items-center justify-between gap-3 px-3 py-2 rounded-lg border ${apt.bg} ${apt.border}`}>
                    <span className={`font-semibold text-sm w-24 ${apt.text}`}>{apt.label}</span>
                    <div className="flex items-center gap-2">
                      <button onClick={() => updateAptidao(apt.key, -1)} className={`w-7 h-7 rounded flex items-center justify-center font-bold ${darkMode ? 'bg-gray-600 hover:bg-gray-500 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-800'}`}>−</button>
                      <input
                        type="number" min="0" max="12"
                        value={aptidoesTempValues[apt.key] ?? 0}
                        onChange={e => {
                          const val = Math.max(0, Math.min(12, parseInt(e.target.value) || 0))
                          const others = Object.entries(aptidoesTempValues).filter(([k]) => k !== apt.key).reduce((s, [, v]) => s + (v || 0), 0)
                          const capped = Math.min(val, 20 - others)
                          setAptidoesTempValues(prev => ({ ...prev, [apt.key]: capped }))
                        }}
                        className={`w-12 text-center font-bold text-lg rounded border-2 ${darkMode ? 'bg-gray-700 border-gray-500 text-white' : 'bg-white border-gray-300 text-gray-800'}`}
                      />
                      <button onClick={() => updateAptidao(apt.key, 1)} className={`w-7 h-7 rounded flex items-center justify-center font-bold ${darkMode ? 'bg-gray-600 hover:bg-gray-500 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-800'}`}>+</button>
                    </div>
                  </div>
                ))}
                <div className={`text-center text-xs pt-1 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                  Total: <span className={`font-bold ${Object.values(aptidoesTempValues).reduce((s, v) => s + (v || 0), 0) > 20 ? 'text-red-500' : darkMode ? 'text-white' : 'text-gray-800'}`}>
                    {Object.values(aptidoesTempValues).reduce((s, v) => s + (v || 0), 0)}
                  </span>/20 — Máx. por aptidão: 12
                </div>
              </div>
              <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-4 rounded-b-2xl flex gap-3 justify-end`}>
                <button onClick={() => setShowAptidoesModal(false)} className={`px-4 py-2 rounded-lg font-semibold ${darkMode ? 'bg-gray-600 text-gray-200 hover:bg-gray-500' : 'bg-gray-300 text-gray-700 hover:bg-gray-400'}`}>Cancelar</button>
                <button onClick={saveAptidoes} className="px-4 py-2 rounded-lg font-semibold bg-indigo-500 text-white hover:bg-indigo-600">Salvar</button>
              </div>
            </div>
          </div>
        )}
      </>
    )
  }

  // ÁREA DA POKÉDEX
  if (currentUser.type === 'treinador' && currentArea === 'Pokédex') {
    return (
      <>
        <div className={`min-h-screen ${mainBgClass}`}>
          {sidebarNav}
        <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-lg`}>
          <div className="max-w-7xl mx-auto px-4 py-4">
            <div className="flex justify-between items-center mb-4">
              <div className="flex items-center gap-3"><button onClick={() => setSidebarOpen(true)} className={`p-2 rounded-lg ${darkMode ? "hover:bg-gray-700 text-gray-400" : "hover:bg-gray-200 text-gray-500"}`}><Menu size={24} /></button><h2 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Pokédex ({pokedex.length})</h2></div>
              <div className="flex gap-2 items-center">
                <button onClick={() => setShowAccountDataModal(true)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-200 text-gray-700'}`} title="Dados da Conta"><ArrowDownUp size={20} /></button>
                <button onClick={() => setDarkMode(!darkMode)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-yellow-400' : 'bg-gray-200 text-gray-700'}`}>{darkMode ? <Sun size={20} /> : <Moon size={20} />}</button>
                {pokezapBtn}{pokeAgendaBtn}{batalhaChatBtn}<button onClick={handleLogout} className="bg-red-500 text-white px-3 sm:px-5 md:px-6 py-2 rounded-lg hover:bg-red-600">Sair</button>
                {currentClima && <div className="flex items-center gap-1.5 ml-1"><img src={`/pokeballs/${currentClima.image}`} alt={currentClima.name} className="w-7 h-7" /><span className={`text-xs font-semibold ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>{currentClima.name}</span></div>}
              </div>
            </div>
          </div>
        </div>

        <div className="max-w-7xl mx-auto px-4 py-3 sm:py-5 md:py-8">
          <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-6`}>
            <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 sm:gap-4 mb-3 sm:mb-4 md:mb-6">
              <h3 className={`text-lg sm:text-xl md:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Pokémon Registrados</h3>
              <div className="flex flex-wrap items-center gap-2 w-full sm:w-auto">
                <button
                  onClick={() => setShowScanPokemonModal(true)}
                  className={`p-1.5 sm:p-2 rounded-lg transition-all hover:scale-110 ${darkMode ? 'bg-blue-900/50 hover:bg-blue-800' : 'bg-blue-100 hover:bg-blue-200'}`}
                  title="Escanear"
                >
                  <img src="/pokedexpq.png" alt="Escanear" className="w-4 h-4 sm:w-5 sm:h-5" />
                </button>
                <button
                  onClick={() => setShowExoticConfigModal(true)}
                  className={`p-1.5 sm:p-2 rounded-lg transition-all hover:scale-110 ${darkMode ? 'bg-purple-900/50 text-purple-400 hover:bg-purple-800' : 'bg-purple-100 text-purple-600 hover:bg-purple-200'}`}
                  title="Configuração Pokémon Exótico"
                >
                  <ListTree size={18} className="sm:w-5 sm:h-5" />
                </button>
                <div className={`flex gap-2 text-xs sm:text-sm font-semibold ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                  <span className={`px-2 py-1 sm:px-3 sm:py-1.5 md:px-4 md:py-2 rounded-lg ${darkMode ? 'bg-blue-900/30 border border-blue-500' : 'bg-blue-50 border border-blue-400'} ${darkMode ? 'text-blue-400' : 'text-blue-700'}`}>
                    <span className="hidden xs:inline">Escaneados: </span>{pokedex.length}
                  </span>
                  <span className={`px-2 py-1 sm:px-3 sm:py-1.5 md:px-4 md:py-2 rounded-lg ${darkMode ? 'bg-green-900/30 border border-green-500' : 'bg-green-50 border border-green-400'} ${darkMode ? 'text-green-400' : 'text-green-700'}`}>
                    <span className="hidden xs:inline">Capturados: </span>{pokedex.filter(p => p.isCaptured).length}
                  </span>
                </div>
              </div>
            </div>

            {pokedex.length > 0 && (
              <div className="mb-4 sm:mb-5 md:mb-6 space-y-3 sm:space-y-4">
                {/* Barra de Pesquisa */}
                <div className="relative">
                  <Search className={`absolute left-3 top-1/2 transform -translate-y-1/2 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`} size={18} />
                  <input
                    type="text"
                    value={pokedexSearchQuery}
                    onChange={e => setPokedexSearchQuery(e.target.value)}
                    placeholder="Pesquisar por espécie..."
                    className={`w-full pl-10 pr-4 py-2 sm:py-2.5 md:py-3 border-2 rounded-lg text-sm sm:text-base ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'border-gray-300 placeholder-gray-500'}`}
                  />
                </div>

                {/* Filtro de Tipo */}
                <div className="flex flex-col sm:flex-row sm:items-center gap-2">
                  <label className={`font-semibold text-sm sm:text-base ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Filtrar por tipo:
                  </label>
                  <div className="flex flex-wrap gap-2">
                    <select
                      value={pokedexTypeFilter}
                      onChange={e => setPokedexTypeFilter(e.target.value)}
                      className={`flex-1 sm:flex-initial px-3 py-2 border-2 rounded-lg text-sm sm:text-base ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                    >
                      <option value="">Todos os tipos</option>
                      {Object.keys(TYPE_COLORS).map(type => (
                        <option key={type} value={type}>{type}</option>
                      ))}
                    </select>
                    {(pokedexSearchQuery || pokedexTypeFilter) && (
                      <button
                        onClick={() => {
                          setPokedexSearchQuery('')
                          setPokedexTypeFilter('')
                        }}
                        className={`px-3 py-2 rounded-lg text-sm sm:text-base ${darkMode ? 'bg-red-600 hover:bg-red-700' : 'bg-red-500 hover:bg-red-600'} text-white font-semibold`}
                      >
                        Limpar
                      </button>
                    )}
                  </div>
                </div>
              </div>
            )}

            {pokedex.length === 0 ? (
              <div className={`text-center py-8 sm:py-10 md:py-12 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                <p className="text-base sm:text-lg">Nenhum Pokémon registrado ainda</p>
                <p className="text-xs sm:text-sm mt-2">Adicione ou escaneie Pokémon para preencher sua Pokédex</p>
              </div>
            ) : (
              <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-2 sm:gap-3">
                {pokedex.filter(entry => {
                  // Filtro de pesquisa por espécie
                  const matchesSearch = !pokedexSearchQuery ||
                    entry.species.toLowerCase().includes(pokedexSearchQuery.toLowerCase())

                  // Filtro de tipo
                  if (!pokedexTypeFilter) return matchesSearch

                  const fullData = entry.isExotic ? entry.exoticData : fullPokedexData.find(p => p.nome === entry.species)
                  if (!fullData) return matchesSearch

                  const pokemonTypes = fullData.tipos || []
                  const matchesType = pokemonTypes.includes(pokedexTypeFilter)

                  return matchesSearch && matchesType
                }).sort((a, b) => a.species.localeCompare(b.species)).map((entry, idx) => {
                  const fullData = entry.isExotic ? entry.exoticData : fullPokedexData.find(p => p.nome === entry.species)
                  return (
                    <div key={idx} className={`p-2 sm:p-3 rounded-lg border-2 transition-all hover:shadow-lg relative ${entry.isCaptured ? (darkMode ? 'bg-green-900/30 border-green-500' : 'bg-green-50 border-green-400') : (darkMode ? 'bg-gray-700 border-gray-600' : 'bg-gray-50 border-gray-300')}`}>
                      <button
                        onClick={() => removeFromPokedex(entry.species)}
                        className={`absolute top-1 right-1 p-0.5 sm:p-1 rounded-full transition-all hover:scale-110 ${darkMode ? 'bg-red-900/50 text-red-400 hover:bg-red-800' : 'bg-red-100 text-red-600 hover:bg-red-200'}`}
                        title="Remover da Pokédex"
                      >
                        <Trash2 size={12} className="sm:w-[14px] sm:h-[14px]" />
                      </button>
                      <div className="flex flex-col items-center gap-1 sm:gap-2">
                        <button
                          onClick={() => !entry.isCaptured && openCaptureModal(entry.species)}
                          className={`w-8 h-8 sm:w-10 sm:h-10 rounded-full flex items-center justify-center transition-all ${entry.isCaptured ? 'cursor-default' : 'hover:scale-110 cursor-pointer'}`}
                          title={entry.isCaptured ? 'Capturado' : 'Capturar Pokémon'}
                        >
                          <img
                            src="/pokeball-icon.png"
                            alt="Pokébola"
                            className={`w-6 h-6 sm:w-8 sm:h-8 ${!entry.isCaptured ? 'grayscale opacity-50' : ''}`}
                          />
                        </button>
                        <button
                          onClick={() => {
                            setSelectedPokedexEntry({ ...entry, fullData })
                            setShowPokedexDetailModal(true)
                          }}
                          className={`font-bold text-xs sm:text-sm text-center hover:underline truncate max-w-full px-1 ${darkMode ? 'text-white' : 'text-gray-800'}`}
                          title={entry.species}
                        >
                          {entry.species}
                        </button>
                        <p className={`text-[10px] sm:text-xs ${entry.isCaptured ? (darkMode ? 'text-green-400' : 'text-green-600') : (darkMode ? 'text-gray-400' : 'text-gray-500')}`}>
                          <span className="hidden xs:inline">{entry.isCaptured ? '✓ Capturado' : '○ Escaneado'}</span>
                          <span className="xs:hidden">{entry.isCaptured ? '✓' : '○'}</span>
                        </p>
                      </div>
                    </div>
                  )
                })}
              </div>
            )}
          </div>
        </div>

        {/* MODAL DE DETALHES DA POKÉDEX */}
        {showPokedexDetailModal && selectedPokedexEntry && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-2 sm:p-4" onClick={() => setShowPokedexDetailModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-3 sm:p-5 md:p-6 rounded-2xl shadow-2xl max-w-sm sm:max-w-lg md:max-w-2xl w-full max-h-[90vh] overflow-y-auto`} onClick={(e) => e.stopPropagation()}>
              <div className="flex justify-between items-center mb-3 sm:mb-4 md:mb-6">
                <h3 className={`text-base sm:text-lg md:text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'} truncate pr-2`}>
                  {selectedPokedexEntry.fullData ? `#${String(selectedPokedexEntry.fullData.dexNumber).padStart(3, '0')} - ` : ''}{selectedPokedexEntry.species}
                </h3>
                <button onClick={() => setShowPokedexDetailModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                  <X size={20} className="sm:w-6 sm:h-6" />
                </button>
              </div>

              {selectedPokedexEntry.fullData ? (
                <div className={`p-2 sm:p-4 md:p-6 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                  <div className="grid grid-cols-2 gap-2 mb-3 sm:mb-4">
                    <div>
                      <h4 className={`font-bold mb-1 sm:mb-2 text-xs sm:text-sm ${darkMode ? 'text-white' : 'text-gray-800'}`}>Altura</h4>
                      <p className={`text-xs sm:text-base ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>{selectedPokedexEntry.fullData.altura}m</p>
                    </div>
                    <div>
                      <h4 className={`font-bold mb-1 sm:mb-2 text-xs sm:text-sm ${darkMode ? 'text-white' : 'text-gray-800'}`}>Peso</h4>
                      <p className={`text-xs sm:text-base ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>{selectedPokedexEntry.fullData.peso}kg</p>
                    </div>
                  </div>

                  <div className="mb-3 sm:mb-4">
                    <h4 className={`font-bold mb-1 sm:mb-2 text-xs sm:text-sm ${darkMode ? 'text-white' : 'text-gray-800'}`}>Tipos</h4>
                    <div className="flex flex-wrap gap-1.5 sm:gap-2">
                      {selectedPokedexEntry.fullData.tipos.map((tipo, i) => (
                        <span key={i} className={`px-2 py-0.5 sm:px-3 sm:py-1 rounded-full text-xs sm:text-sm font-semibold ${darkMode ? 'bg-blue-600 text-white' : 'bg-blue-200 text-blue-800'}`}>
                          {tipo}
                        </span>
                      ))}
                    </div>
                  </div>

                  <div className="mb-3 sm:mb-4">
                    <h4 className={`font-bold mb-1 sm:mb-2 text-xs sm:text-sm ${darkMode ? 'text-white' : 'text-gray-800'}`}>Habitats</h4>
                    <p className={`text-xs sm:text-base ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      {selectedPokedexEntry.fullData.habitats.join(', ')}
                    </p>
                  </div>

                  <div className="mb-3 sm:mb-4">
                    <h4 className={`font-bold mb-1 sm:mb-2 text-xs sm:text-sm ${darkMode ? 'text-white' : 'text-gray-800'}`}>Catch Rate</h4>
                    <p className={`text-xs sm:text-base ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>{selectedPokedexEntry.fullData.catchRate}</p>
                  </div>

                  <div className="mb-3 sm:mb-4">
                    <h4 className={`font-bold mb-1 sm:mb-2 text-xs sm:text-sm ${darkMode ? 'text-white' : 'text-gray-800'}`}>Experiência Base</h4>
                    <p className={`text-xs sm:text-base ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>{selectedPokedexEntry.fullData.baseExp}</p>
                  </div>

                  <div className="mb-3 sm:mb-4">
                    <h4 className={`font-bold mb-1 sm:mb-2 text-xs sm:text-sm ${darkMode ? 'text-white' : 'text-gray-800'}`}>Status Base</h4>
                    <div className="grid grid-cols-2 gap-1.5 sm:gap-2">
                      <div className={`p-1.5 sm:p-2 rounded text-xs sm:text-sm ${darkMode ? 'bg-gray-600' : 'bg-gray-200'}`}>
                        <span className="font-semibold">Saúde:</span> {selectedPokedexEntry.fullData.statusBasais.saude}
                      </div>
                      <div className={`p-1.5 sm:p-2 rounded text-xs sm:text-sm ${darkMode ? 'bg-gray-600' : 'bg-gray-200'}`}>
                        <span className="font-semibold">Ataque:</span> {selectedPokedexEntry.fullData.statusBasais.ataque}
                      </div>
                      <div className={`p-1.5 sm:p-2 rounded text-xs sm:text-sm ${darkMode ? 'bg-gray-600' : 'bg-gray-200'}`}>
                        <span className="font-semibold">Defesa:</span> {selectedPokedexEntry.fullData.statusBasais.defesa}
                      </div>
                      <div className={`p-1.5 sm:p-2 rounded text-xs sm:text-sm ${darkMode ? 'bg-gray-600' : 'bg-gray-200'}`}>
                        <span className="font-semibold">Atq. Esp.:</span> {selectedPokedexEntry.fullData.statusBasais.ataqueEspecial}
                      </div>
                      <div className={`p-1.5 sm:p-2 rounded text-xs sm:text-sm ${darkMode ? 'bg-gray-600' : 'bg-gray-200'}`}>
                        <span className="font-semibold">Def. Esp.:</span> {selectedPokedexEntry.fullData.statusBasais.defesaEspecial}
                      </div>
                      <div className={`p-1.5 sm:p-2 rounded text-xs sm:text-sm ${darkMode ? 'bg-gray-600' : 'bg-gray-200'}`}>
                        <span className="font-semibold">Velocidade:</span> {selectedPokedexEntry.fullData.statusBasais.velocidade}
                      </div>
                    </div>
                  </div>

                  {selectedPokedexEntry.fullData.evolucao && (
                    <div className="mb-3 sm:mb-4">
                      <h4 className={`font-bold mb-1 sm:mb-2 text-xs sm:text-sm ${darkMode ? 'text-white' : 'text-gray-800'}`}>Evolução</h4>
                      <p className={`text-xs sm:text-base ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                        Evolui para {fullPokedexData.find(p => p.dexNumber === selectedPokedexEntry.fullData.evolucao)?.nome || '?'}
                        {selectedPokedexEntry.fullData.evolucaoNivel && ` no nível ${selectedPokedexEntry.fullData.evolucaoNivel}`}
                        {selectedPokedexEntry.fullData.evolucaoItem && ` usando ${selectedPokedexEntry.fullData.evolucaoItem}`}
                      </p>
                    </div>
                  )}

                  <div className="mb-3 sm:mb-4">
                    <h4 className={`font-bold mb-1 sm:mb-2 text-xs sm:text-sm ${darkMode ? 'text-white' : 'text-gray-800'}`}>Status</h4>
                    <p className={`font-semibold text-xs sm:text-base ${selectedPokedexEntry.isCaptured ? (darkMode ? 'text-green-400' : 'text-green-600') : (darkMode ? 'text-gray-400' : 'text-gray-500')}`}>
                      {selectedPokedexEntry.isCaptured ? '✓ Capturado' : '○ Escaneado'}
                    </p>
                  </div>

                  {!selectedPokedexEntry.isCaptured && (
                    <button
                      onClick={() => {
                        setShowPokedexDetailModal(false)
                        openCaptureModal(selectedPokedexEntry.species)
                      }}
                      className="w-full bg-green-500 text-white py-2 sm:py-2.5 md:py-3 rounded-lg hover:bg-green-600 font-semibold mt-2 sm:mt-3 md:mt-4 text-sm sm:text-base"
                    >
                      Capturar este Pokémon
                    </button>
                  )}
                </div>
              ) : (
                <div className={`p-2 sm:p-4 md:p-6 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                  <p className={`text-center text-xs sm:text-base ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                    Carregando informações...
                  </p>
                </div>
              )}
            </div>
          </div>
        )}

        {/* MODAL DE CAPTURA */}
        {showCaptureModal && pokemonToCapture && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowCaptureModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-3 sm:p-5 md:p-8 rounded-2xl shadow-2xl max-w-md w-full`} onClick={(e) => e.stopPropagation()}>
              <div className="flex justify-between items-center mb-6">
                <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Capturar {pokemonToCapture}</h3>
                <button onClick={() => setShowCaptureModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                  <X size={24} />
                </button>
              </div>

              <div className="space-y-4">
                <div>
                  <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>
                    Nome do Pokémon *
                  </label>
                  <input
                    type="text"
                    value={captureForm.nickname}
                    onChange={(e) => setCaptureForm({ ...captureForm, nickname: e.target.value })}
                    placeholder="Digite um nome para seu Pokémon"
                    className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-500' : 'border-gray-300'}`}
                  />
                </div>

                <div>
                  <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>
                    Nível (1-100)
                  </label>
                  <input
                    type="number"
                    min="1"
                    max="100"
                    value={captureForm.level}
                    onChange={(e) => setCaptureForm({ ...captureForm, level: Math.max(1, Math.min(100, parseInt(e.target.value) || 1)) })}
                    className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                  />
                </div>

                <button
                  onClick={handleCapturePokemon}
                  className="w-full bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 font-semibold"
                >
                  Confirmar Captura
                </button>
              </div>
            </div>
          </div>
        )}

        {/* MODAL DE DADOS EXÓTICOS */}
        {showExoticDataModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-3 sm:p-5 md:p-8 rounded-2xl shadow-2xl max-w-sm sm:max-w-2xl md:max-w-4xl w-full max-h-[90vh] overflow-y-auto`} onClick={(e) => e.stopPropagation()}>
              <div className="flex justify-between items-center mb-6">
                <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  Dados do Pokémon Exótico: {pokemonForm.exoticSpecies}
                </h3>
                <button onClick={() => setShowExoticDataModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                  <X size={24} />
                </button>
              </div>

              <div className="space-y-4">
                <div className="grid grid-cols-2 gap-2 sm:gap-3 md:gap-4">
                  <div>
                    <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>Número da Pokédex</label>
                    <input type="number" value={exoticDataForm.dexNumber} onChange={(e) => setExoticDataForm({...exoticDataForm, dexNumber: e.target.value})} className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`} />
                  </div>
                  <div>
                    <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>Distribuição de Gênero</label>
                    <input type="text" value={exoticDataForm.genero} onChange={(e) => setExoticDataForm({...exoticDataForm, genero: e.target.value})} placeholder="Macho/Fêmea/Sem Gênero" className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`} />
                  </div>
                </div>

                <div className="grid grid-cols-2 gap-2 sm:gap-3 md:gap-4">
                  <div>
                    <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>Altura (m) *</label>
                    <input type="number" step="0.1" value={exoticDataForm.altura} onChange={(e) => setExoticDataForm({...exoticDataForm, altura: e.target.value})} className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`} />
                  </div>
                  <div>
                    <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>Peso (kg) *</label>
                    <input type="number" step="0.1" value={exoticDataForm.peso} onChange={(e) => setExoticDataForm({...exoticDataForm, peso: e.target.value})} className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`} />
                  </div>
                </div>

                <div>
                  <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>Tipos * (máximo 3)</label>
                  <div className="flex flex-wrap gap-2 mb-3">
                    {['Normal', 'Fogo', 'Água', 'Planta', 'Elétrico', 'Gelo', 'Lutador', 'Veneno', 'Terra', 'Voador', 'Psíquico', 'Inseto', 'Pedra', 'Fantasma', 'Dragão', 'Sombrio', 'Metal', 'Fada'].map(tipo => {
                      const isSelected = exoticDataForm.tipos.includes(tipo)
                      return (
                        <button
                          key={tipo}
                          type="button"
                          onClick={() => {
                            if (isSelected) {
                              setExoticDataForm({...exoticDataForm, tipos: exoticDataForm.tipos.filter(t => t !== tipo)})
                            } else if (exoticDataForm.tipos.length < 3) {
                              setExoticDataForm({...exoticDataForm, tipos: [...exoticDataForm.tipos, tipo]})
                            }
                          }}
                          className={`px-3 py-2 rounded-lg text-sm font-bold text-white transition-all ${
                            isSelected
                              ? `${TYPE_STYLES[tipo] || 'bg-gray-500'} ring-4 ring-yellow-400`
                              : `${TYPE_STYLES[tipo] || 'bg-gray-500'} opacity-50 hover:opacity-75`
                          }`}
                        >
                          {tipo}
                        </button>
                      )
                    })}
                  </div>
                  <div className="flex gap-2 flex-wrap">
                    {exoticDataForm.tipos.map((tipo, idx) => (
                      <span
                        key={idx}
                        className={`px-3 py-1 rounded-md text-xs font-bold text-white shadow-md ${TYPE_STYLES[tipo] || 'bg-gray-400'}`}
                        style={{ clipPath: 'polygon(0 0, 90% 0, 100% 50%, 90% 100%, 0 100%)' }}
                      >
                        {tipo}
                      </span>
                    ))}
                  </div>
                </div>

                <div>
                  <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>Habitats</label>
                  {exoticDataForm.habitats.map((habitat, idx) => (
                    <div key={idx} className="flex gap-2 mb-2">
                      <input type="text" value={habitat} onChange={(e) => {
                        const newHabitats = [...exoticDataForm.habitats]
                        newHabitats[idx] = e.target.value
                        setExoticDataForm({...exoticDataForm, habitats: newHabitats})
                      }} placeholder={`Habitat ${idx + 1}`} className={`flex-1 px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`} />
                      {idx > 0 && <button onClick={() => setExoticDataForm({...exoticDataForm, habitats: exoticDataForm.habitats.filter((_, i) => i !== idx)})} className="bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600"><Minus size={16} /></button>}
                    </div>
                  ))}
                  <button onClick={() => setExoticDataForm({...exoticDataForm, habitats: [...exoticDataForm.habitats, '']})} className="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 text-sm"><Plus size={16} className="inline" /> Adicionar Habitat</button>
                </div>

                <div className="grid grid-cols-2 gap-2 sm:gap-3 md:gap-4">
                  <div>
                    <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>Catch Rate</label>
                    <input type="number" value={exoticDataForm.catchRate} onChange={(e) => setExoticDataForm({...exoticDataForm, catchRate: e.target.value})} className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`} />
                  </div>
                  <div>
                    <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>Experiência Base</label>
                    <input type="number" value={exoticDataForm.baseExp} onChange={(e) => setExoticDataForm({...exoticDataForm, baseExp: e.target.value})} className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`} />
                  </div>
                </div>

                <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                  <h4 className={`font-bold mb-3 ${darkMode ? 'text-white' : 'text-gray-800'}`}>Status Base</h4>
                  <div className="grid grid-cols-2 gap-3">
                    <div>
                      <label className={`block text-xs font-medium ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-1`}>Saúde</label>
                      <input type="number" value={exoticDataForm.statusBasais.saude} onChange={(e) => setExoticDataForm({...exoticDataForm, statusBasais: {...exoticDataForm.statusBasais, saude: e.target.value}})} className={`w-full px-3 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'border-gray-300'}`} />
                    </div>
                    <div>
                      <label className={`block text-xs font-medium ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-1`}>Ataque</label>
                      <input type="number" value={exoticDataForm.statusBasais.ataque} onChange={(e) => setExoticDataForm({...exoticDataForm, statusBasais: {...exoticDataForm.statusBasais, ataque: e.target.value}})} className={`w-full px-3 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'border-gray-300'}`} />
                    </div>
                    <div>
                      <label className={`block text-xs font-medium ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-1`}>Defesa</label>
                      <input type="number" value={exoticDataForm.statusBasais.defesa} onChange={(e) => setExoticDataForm({...exoticDataForm, statusBasais: {...exoticDataForm.statusBasais, defesa: e.target.value}})} className={`w-full px-3 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'border-gray-300'}`} />
                    </div>
                    <div>
                      <label className={`block text-xs font-medium ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-1`}>Ataque Especial</label>
                      <input type="number" value={exoticDataForm.statusBasais.ataqueEspecial} onChange={(e) => setExoticDataForm({...exoticDataForm, statusBasais: {...exoticDataForm.statusBasais, ataqueEspecial: e.target.value}})} className={`w-full px-3 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'border-gray-300'}`} />
                    </div>
                    <div>
                      <label className={`block text-xs font-medium ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-1`}>Defesa Especial</label>
                      <input type="number" value={exoticDataForm.statusBasais.defesaEspecial} onChange={(e) => setExoticDataForm({...exoticDataForm, statusBasais: {...exoticDataForm.statusBasais, defesaEspecial: e.target.value}})} className={`w-full px-3 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'border-gray-300'}`} />
                    </div>
                    <div>
                      <label className={`block text-xs font-medium ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-1`}>Velocidade</label>
                      <input type="number" value={exoticDataForm.statusBasais.velocidade} onChange={(e) => setExoticDataForm({...exoticDataForm, statusBasais: {...exoticDataForm.statusBasais, velocidade: e.target.value}})} className={`w-full px-3 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'border-gray-300'}`} />
                    </div>
                  </div>
                </div>

                <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                  <h4 className={`font-bold mb-3 ${darkMode ? 'text-white' : 'text-gray-800'}`}>Evolução (Opcional)</h4>
                  <div className="space-y-3">
                    <div>
                      <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>Evolui para</label>
                      <input type="text" value={exoticDataForm.evolucao} onChange={(e) => setExoticDataForm({...exoticDataForm, evolucao: e.target.value})} placeholder="Nome do Pokémon" className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'border-gray-300'}`} />
                    </div>
                    <div className="grid grid-cols-2 gap-3">
                      <div>
                        <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>Nível de Evolução</label>
                        <input type="number" value={exoticDataForm.evolucaoNivel} onChange={(e) => setExoticDataForm({...exoticDataForm, evolucaoNivel: e.target.value})} className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'border-gray-300'}`} />
                      </div>
                      <div>
                        <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>Item de Evolução</label>
                        <input type="text" value={exoticDataForm.evolucaoItem} onChange={(e) => setExoticDataForm({...exoticDataForm, evolucaoItem: e.target.value})} placeholder="Nome do item" className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'border-gray-300'}`} />
                      </div>
                    </div>
                  </div>
                </div>

                <div className="flex gap-3 pt-4">
                  <button onClick={() => setShowExoticDataModal(false)} className={`flex-1 py-3 rounded-lg font-semibold ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}>
                    Cancelar
                  </button>
                  <button onClick={handleSaveExoticData} className="flex-1 bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 font-semibold">
                    Salvar e Adicionar
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* MODAL DE CONFIGURAÇÃO DE POKÉMON EXÓTICO */}
        {showExoticConfigModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowExoticConfigModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-sm sm:max-w-2xl md:max-w-4xl w-full max-h-[90vh] overflow-y-auto`} onClick={(e) => e.stopPropagation()}>
              <div className="p-3 sm:p-5 md:p-6">
                {/* Header */}
                <div className="flex justify-between items-center mb-6">
                  <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                    Configuração de Pokémon Exótico
                  </h3>
                  <button onClick={() => {
                    setShowExoticConfigModal(false)
                    setExoticConfigSearch('')
                    setSelectedExoticConfig(null)
                  }} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                    <X size={24} />
                  </button>
                </div>

                {/* Species Search Dropdown */}
                <div className="mb-6">
                  <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>
                    Espécie Exótica
                  </label>
                  <div className="relative">
                    <input
                      type="text"
                      value={exoticConfigSearch}
                      onChange={(e) => setExoticConfigSearch(e.target.value)}
                      placeholder="Pesquisar espécie exótica..."
                      className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'bg-white border-gray-300'}`}
                    />
                    {exoticConfigSearch && (
                      <div className={`absolute z-10 w-full mt-1 max-h-60 overflow-y-auto rounded-lg border-2 ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'} shadow-lg`}>
                        {globalExoticSpecies
                          .filter(e => e.nome.toLowerCase().includes(exoticConfigSearch.toLowerCase()))
                          .map(species => (
                            <button
                              key={species.nome}
                              onClick={() => {
                                setSelectedExoticConfig(species.nome)
                                setExoticConfigSearch(species.nome)

                                // Load exotic species data - converter ataqueEspecial/defesaEspecial para ataqueEsp/defesaEsp
                                setExoticConfigForm({
                                  dexNumber: species.dexNumber || '',
                                  altura: species.altura || '',
                                  peso: species.peso || '',
                                  genero: species.genero || '',
                                  tipos: species.tipos || [],
                                  habitats: species.habitats || [],
                                  statusBasais: {
                                    saude: species.statusBasais?.saude || '',
                                    ataque: species.statusBasais?.ataque || '',
                                    defesa: species.statusBasais?.defesa || '',
                                    ataqueEsp: species.statusBasais?.ataqueEspecial || '',
                                    defesaEsp: species.statusBasais?.defesaEspecial || '',
                                    velocidade: species.statusBasais?.velocidade || ''
                                  },
                                  habilidades: species.habilidades || [],
                                  habilidadesAltas: species.habilidadesAltas || [],
                                  habilidadesOcultas: species.habilidadesOcultas || [],
                                  minimoLevel: species.minimoLevel || '',
                                  estagio: species.estagio || 'Básico',
                                  evolucaoDe: species.evolucao || '',
                                  evolucaoModo: species.evolucaoModo || '',
                                  evolucaoLevel: species.evolucaoNivel || '',
                                  evolucaoItem: species.evolucaoItem || ''
                                })
                              }}
                              className={`w-full px-4 py-2 text-left hover:bg-purple-500 hover:text-white transition-colors ${darkMode ? 'text-gray-200' : 'text-gray-800'}`}
                            >
                              {species.nome}
                            </button>
                          ))}
                        {globalExoticSpecies.filter(e => e.nome.toLowerCase().includes(exoticConfigSearch.toLowerCase())).length === 0 && (
                          <div className={`px-4 py-2 text-center ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                            Nenhuma espécie exótica encontrada
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                </div>

                {/* Edit Form - Only show when species is selected */}
                {selectedExoticConfig && (
                  <div className={`p-3 sm:p-5 md:p-6 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                    <h4 className={`text-lg font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                      Editando: {selectedExoticConfig}
                    </h4>

                    {/* Basic Info */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-2 sm:gap-3 md:gap-4 mb-4">
                      <div>
                        <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>Número da Dex</label>
                        <input type="number" value={exoticConfigForm.dexNumber} onChange={(e) => setExoticConfigForm({...exoticConfigForm, dexNumber: e.target.value})} placeholder="000" className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'border-gray-300'}`} />
                      </div>
                      <div>
                        <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>Altura (metros)</label>
                        <input type="text" value={exoticConfigForm.altura} onChange={(e) => setExoticConfigForm({...exoticConfigForm, altura: e.target.value})} placeholder="0.0" className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'border-gray-300'}`} />
                      </div>
                      <div>
                        <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>Peso (kg)</label>
                        <input type="text" value={exoticConfigForm.peso} onChange={(e) => setExoticConfigForm({...exoticConfigForm, peso: e.target.value})} placeholder="0.0" className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'border-gray-300'}`} />
                      </div>
                      <div>
                        <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>Distribuição de Gênero</label>
                        <input type="text" value={exoticConfigForm.genero} onChange={(e) => setExoticConfigForm({...exoticConfigForm, genero: e.target.value})} placeholder="Ex: 50% ♂ / 50% ♀" className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'border-gray-300'}`} />
                      </div>
                    </div>

                    {/* Types */}
                    <div className="mb-4">
                      <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>Tipos (separados por vírgula)</label>
                      <input type="text" value={exoticConfigForm.tipos.join(', ')} onChange={(e) => setExoticConfigForm({...exoticConfigForm, tipos: e.target.value.split(',').map(t => t.trim()).filter(t => t)})} placeholder="Ex: Fogo, Voador" className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'border-gray-300'}`} />
                    </div>

                    {/* Habitats */}
                    <div className="mb-4">
                      <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>Habitats (separados por vírgula)</label>
                      <input type="text" value={exoticConfigForm.habitats.join(', ')} onChange={(e) => setExoticConfigForm({...exoticConfigForm, habitats: e.target.value.split(',').map(h => h.trim()).filter(h => h)})} placeholder="Ex: Floresta, Montanha" className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'border-gray-300'}`} />
                    </div>

                    {/* Base Stats */}
                    <div className="mb-4">
                      <h5 className={`text-sm font-bold mb-3 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Status Basais</h5>
                      <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                        <div>
                          <label className={`block text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-1`}>Saúde</label>
                          <input type="number" value={exoticConfigForm.statusBasais.saude} onChange={(e) => setExoticConfigForm({...exoticConfigForm, statusBasais: {...exoticConfigForm.statusBasais, saude: e.target.value}})} placeholder="0" className={`w-full px-3 py-2 border rounded ${darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'border-gray-300'}`} />
                        </div>
                        <div>
                          <label className={`block text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-1`}>Ataque</label>
                          <input type="number" value={exoticConfigForm.statusBasais.ataque} onChange={(e) => setExoticConfigForm({...exoticConfigForm, statusBasais: {...exoticConfigForm.statusBasais, ataque: e.target.value}})} placeholder="0" className={`w-full px-3 py-2 border rounded ${darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'border-gray-300'}`} />
                        </div>
                        <div>
                          <label className={`block text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-1`}>Defesa</label>
                          <input type="number" value={exoticConfigForm.statusBasais.defesa} onChange={(e) => setExoticConfigForm({...exoticConfigForm, statusBasais: {...exoticConfigForm.statusBasais, defesa: e.target.value}})} placeholder="0" className={`w-full px-3 py-2 border rounded ${darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'border-gray-300'}`} />
                        </div>
                        <div>
                          <label className={`block text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-1`}>Ataque Esp.</label>
                          <input type="number" value={exoticConfigForm.statusBasais.ataqueEsp} onChange={(e) => setExoticConfigForm({...exoticConfigForm, statusBasais: {...exoticConfigForm.statusBasais, ataqueEsp: e.target.value}})} placeholder="0" className={`w-full px-3 py-2 border rounded ${darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'border-gray-300'}`} />
                        </div>
                        <div>
                          <label className={`block text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-1`}>Defesa Esp.</label>
                          <input type="number" value={exoticConfigForm.statusBasais.defesaEsp} onChange={(e) => setExoticConfigForm({...exoticConfigForm, statusBasais: {...exoticConfigForm.statusBasais, defesaEsp: e.target.value}})} placeholder="0" className={`w-full px-3 py-2 border rounded ${darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'border-gray-300'}`} />
                        </div>
                        <div>
                          <label className={`block text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-1`}>Velocidade</label>
                          <input type="number" value={exoticConfigForm.statusBasais.velocidade} onChange={(e) => setExoticConfigForm({...exoticConfigForm, statusBasais: {...exoticConfigForm.statusBasais, velocidade: e.target.value}})} placeholder="0" className={`w-full px-3 py-2 border rounded ${darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'border-gray-300'}`} />
                        </div>
                      </div>
                    </div>

                    {/* Abilities */}
                    <div className="mb-4">
                      <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>Habilidades (separadas por vírgula)</label>
                      <input type="text" value={exoticConfigForm.habilidades.join(', ')} onChange={(e) => setExoticConfigForm({...exoticConfigForm, habilidades: e.target.value.split(',').map(h => h.trim()).filter(h => h)})} placeholder="Ex: Chama, Corpo em Chamas" className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'border-gray-300'}`} />
                    </div>

                    <div className="mb-4">
                      <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>Habilidades Altas (separadas por vírgula)</label>
                      <input type="text" value={exoticConfigForm.habilidadesAltas.join(', ')} onChange={(e) => setExoticConfigForm({...exoticConfigForm, habilidadesAltas: e.target.value.split(',').map(h => h.trim()).filter(h => h)})} placeholder="Ex: Habilidade Alta 1" className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'border-gray-300'}`} />
                    </div>

                    <div className="mb-4">
                      <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>Habilidades Ocultas (separadas por vírgula)</label>
                      <input type="text" value={exoticConfigForm.habilidadesOcultas.join(', ')} onChange={(e) => setExoticConfigForm({...exoticConfigForm, habilidadesOcultas: e.target.value.split(',').map(h => h.trim()).filter(h => h)})} placeholder="Ex: Velocidade Máxima" className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'border-gray-300'}`} />
                    </div>

                    {/* Evolution Info */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-2 sm:gap-3 md:gap-4 mb-4">
                      <div>
                        <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>Nível Mínimo para Captura</label>
                        <input type="number" value={exoticConfigForm.minimoLevel} onChange={(e) => setExoticConfigForm({...exoticConfigForm, minimoLevel: e.target.value})} placeholder="5" className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'border-gray-300'}`} />
                      </div>
                      <div>
                        <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>Estágio</label>
                        <select value={exoticConfigForm.estagio} onChange={(e) => setExoticConfigForm({...exoticConfigForm, estagio: e.target.value})} className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'border-gray-300'}`}>
                          <option value="Básico">Básico</option>
                          <option value="Estágio 1">Estágio 1</option>
                          <option value="Estágio 2">Estágio 2</option>
                        </select>
                      </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-2 sm:gap-3 md:gap-4">
                      <div>
                        <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>Evolução De</label>
                        <input type="text" value={exoticConfigForm.evolucaoDe} onChange={(e) => setExoticConfigForm({...exoticConfigForm, evolucaoDe: e.target.value})} placeholder="Nome do pokémon anterior" className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'border-gray-300'}`} />
                      </div>
                      <div>
                        <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>Modo de Evolução</label>
                        <input type="text" value={exoticConfigForm.evolucaoModo} onChange={(e) => setExoticConfigForm({...exoticConfigForm, evolucaoModo: e.target.value})} placeholder="Ex: Level, Item, Troca" className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'border-gray-300'}`} />
                      </div>
                      <div>
                        <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>Level de Evolução</label>
                        <input type="number" value={exoticConfigForm.evolucaoLevel} onChange={(e) => setExoticConfigForm({...exoticConfigForm, evolucaoLevel: e.target.value})} placeholder="Level necessário" className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'border-gray-300'}`} />
                      </div>
                      <div>
                        <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>Item de Evolução</label>
                        <input type="text" value={exoticConfigForm.evolucaoItem} onChange={(e) => setExoticConfigForm({...exoticConfigForm, evolucaoItem: e.target.value})} placeholder="Nome do item" className={`w-full px-4 py-2 border-2 rounded-lg ${darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'border-gray-300'}`} />
                      </div>
                    </div>
                  </div>
                )}

                {/* Action Buttons */}
                <div className="flex gap-3 pt-4">
                  <button onClick={() => {
                    setShowExoticConfigModal(false)
                    setExoticConfigSearch('')
                    setSelectedExoticConfig(null)
                  }} className={`flex-1 py-3 rounded-lg font-semibold ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}>
                    Cancelar
                  </button>
                  {selectedExoticConfig && (
                    <button onClick={handleSaveExoticConfig} className="flex-1 bg-purple-500 text-white py-3 rounded-lg hover:bg-purple-600 font-semibold">
                      Salvar Configurações
                    </button>
                  )}
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Modal Escanear Pokémon */}
        {showScanPokemonModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => {
            setShowScanPokemonModal(false)
            setScanSearch('')
            setSelectedScanPokemon(null)
          }}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-md w-full`} onClick={(e) => e.stopPropagation()}>
              <div className="p-3 sm:p-5 md:p-6">
                <div className="flex justify-between items-center mb-6">
                  <h3 className={`text-lg sm:text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                    Escanear Pokémon
                  </h3>
                  <button onClick={() => {
                    setShowScanPokemonModal(false)
                    setScanSearch('')
                    setSelectedScanPokemon(null)
                  }} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                    <X size={24} />
                  </button>
                </div>

                <div className="space-y-4">
                  <div>
                    <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      Espécie
                    </label>
                    <div className="relative">
                      <input
                        type="text"
                        value={scanSearch}
                        onChange={(e) => {
                          setScanSearch(e.target.value)
                          setSelectedScanPokemon(null)
                        }}
                        placeholder="Pesquisar espécie..."
                        className={`w-full px-3 py-2 sm:px-4 rounded-lg border-2 text-sm sm:text-base ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                      />
                      {scanSearch && !selectedScanPokemon && (
                        <div className={`absolute z-10 w-full mt-1 max-h-60 overflow-y-auto rounded-lg shadow-lg ${darkMode ? 'bg-gray-700' : 'bg-white'} border ${darkMode ? 'border-gray-600' : 'border-gray-300'}`}>
                          {/* Pokémon normais */}
                          {pokedexData
                            .filter(p => p.nome.toLowerCase().includes(scanSearch.toLowerCase()))
                            .map((pokemon, index) => (
                              <div
                                key={`normal-${pokemon.dexNumber}-${index}`}
                                onClick={() => {
                                  setSelectedScanPokemon(pokemon)
                                  setScanSearch(pokemon.nome)
                                }}
                                className={`px-4 py-2 cursor-pointer ${darkMode ? 'hover:bg-gray-600 text-white' : 'hover:bg-gray-100 text-gray-800'}`}
                              >
                                #{String(pokemon.dexNumber).padStart(4, '0')} - {pokemon.nome}
                              </div>
                            ))
                          }
                          {/* Pokémon exóticos */}
                          {globalExoticSpecies
                            .filter(p => (p.species || p.nome || '').toLowerCase().includes(scanSearch.toLowerCase()))
                            .map((pokemon, index) => (
                              <div
                                key={`exotic-${pokemon.species || pokemon.nome}-${index}`}
                                onClick={() => {
                                  setSelectedScanPokemon({ ...pokemon, isExotic: true })
                                  setScanSearch(pokemon.species || pokemon.nome)
                                }}
                                className={`px-4 py-2 cursor-pointer ${darkMode ? 'hover:bg-gray-600 text-purple-300' : 'hover:bg-gray-100 text-purple-600'}`}
                              >
                                {pokemon.species || pokemon.nome} <span className="text-xs">(Exótico)</span>
                              </div>
                            ))
                          }
                          {pokedexData.filter(p => p.nome.toLowerCase().includes(scanSearch.toLowerCase())).length === 0 &&
                           globalExoticSpecies.filter(p => (p.species || p.nome || '').toLowerCase().includes(scanSearch.toLowerCase())).length === 0 && (
                            <div className={`px-4 py-2 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                              Nenhuma espécie encontrada
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                    {selectedScanPokemon && (
                      <div className={`mt-2 p-2 rounded-lg ${darkMode ? 'bg-blue-900 text-blue-300' : 'bg-blue-100 text-blue-800'} text-sm`}>
                        Selecionado: <strong>{selectedScanPokemon.nome || selectedScanPokemon.species}</strong>
                        {selectedScanPokemon.isExotic && <span className="ml-2 text-xs">(Exótico)</span>}
                      </div>
                    )}
                  </div>

                  <button
                    onClick={catalogPokemon}
                    disabled={!selectedScanPokemon}
                    className="w-full bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    Catalogar
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}
        </div>
        {accountDataModal}
        {scenarioPopupOverlay}
        {mostrarTriunfosOverlay}
        {pokezapPanel}{pokeAgendaPanel}
        {batalhaChatPanel}
      </>
    )
  }

  // ÁREA DA MOCHILA
  if (currentUser.type === 'treinador' && currentArea === 'Mochila') {
    const filteredKeyItems = KEY_ITEMS_LIST.filter(item =>
      item.toLowerCase().includes(keyItemSearch.toLowerCase())
    )

    return (
      <>
        <div className={`min-h-screen ${mainBgClass}`}>
          {sidebarNav}
        <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-lg`}>
          <div className="max-w-7xl mx-auto px-4 py-4">
            <div className="flex justify-between items-center mb-4">
              <div className="flex items-center gap-3"><button onClick={() => setSidebarOpen(true)} className={`p-2 rounded-lg ${darkMode ? "hover:bg-gray-700 text-gray-400" : "hover:bg-gray-200 text-gray-500"}`}><Menu size={24} /></button><h2 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Mochila</h2></div>
              <div className="flex gap-2 items-center">
                <button onClick={() => setDarkMode(!darkMode)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-yellow-400' : 'bg-gray-200 text-gray-700'}`}>
                  {darkMode ? <Sun size={20} /> : <Moon size={20} />}
                </button>
                {pokezapBtn}{pokeAgendaBtn}{batalhaChatBtn}<button onClick={handleLogout} className="bg-red-500 text-white px-3 sm:px-5 md:px-6 py-2 rounded-lg hover:bg-red-600">Sair</button>
                {currentClima && <div className="flex items-center gap-1.5 ml-1"><img src={`/pokeballs/${currentClima.image}`} alt={currentClima.name} className="w-7 h-7" /><span className={`text-xs font-semibold ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>{currentClima.name}</span></div>}
              </div>
            </div>
          </div>
        </div>

        <div className="max-w-7xl mx-auto px-4 py-4 sm:py-5 md:py-6">
          {/* Pokémoedas */}
          <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-6 mb-4 sm:mb-5 md:mb-6`}>
            <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
              <h3 className={`text-lg sm:text-xl md:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Pokémoedas</h3>
              <div className="flex items-center gap-2 sm:gap-3 flex-wrap">
                {/* Botão Pokecaixinha */}
                <button
                  onClick={() => setShowPokecaixinhaModal(true)}
                  className="flex items-center justify-center p-1.5 sm:p-2 bg-gray-300 hover:bg-gray-400 rounded-lg shadow-lg transition-all"
                  title="Pokecaixinha - Depositar"
                >
                  <img src="/pokecofrinho.png" alt="Pokecaixinha" className="w-6 h-6 sm:w-7 sm:h-7 md:w-8 md:h-8" />
                </button>

                {/* Botão Dia do Saque */}
                <button
                  onClick={() => {
                    if (pokecaixinha > 0) {
                      setPokemonedas(prev => prev + pokecaixinha)
                      setPokecaixinha(0)
                      if (useFirebase) {
                        saveTrainerData(currentUser.username, {
                          ...currentUser,
                          pokemonedas: pokemonedas + pokecaixinha,
                          pokecaixinha: 0
                        })
                      }
                      alert(`Você sacou ₽${pokecaixinha.toLocaleString()} da Pokecaixinha!`)
                    } else {
                      alert('A Pokecaixinha está vazia!')
                    }
                  }}
                  className="flex items-center justify-center p-1.5 sm:p-2 bg-gray-300 hover:bg-gray-400 rounded-lg shadow-lg transition-all"
                  title="Dia do Saque - Retirar tudo"
                >
                  <img src="/pokecofrinhoquebrado.png" alt="Dia do Saque" className="w-6 h-6 sm:w-7 sm:h-7 md:w-8 md:h-8" />
                </button>

                <button
                  onClick={() => setShowPokemonedasModal(true)}
                  className={`text-2xl sm:text-3xl md:text-4xl font-bold ${darkMode ? 'text-yellow-400 hover:text-yellow-300' : 'text-yellow-600 hover:text-yellow-700'} transition-colors cursor-pointer`}
                  title="Clique para editar Pokémoedas"
                >
                  ₽{pokemonedas.toLocaleString()}
                </button>
              </div>
            </div>

            {/* Saldo da Pokecaixinha */}
            {pokecaixinha > 0 && (
              <div className="mt-2 sm:mt-3 pt-2 sm:pt-3 border-t border-gray-600">
                <div className="flex items-center justify-between">
                  <span className={`text-xs sm:text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                    💰 Pokecaixinha:
                  </span>
                  <span className={`text-base sm:text-lg font-bold ${darkMode ? 'text-green-400' : 'text-green-600'}`}>
                    ₽{pokecaixinha.toLocaleString()}
                  </span>
                </div>
              </div>
            )}
          </div>

          {/* Itens Chave */}
          <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-6 mb-4 sm:mb-5 md:mb-6`}>
            <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 sm:gap-3 mb-3 sm:mb-4">
              <h3 className={`text-lg sm:text-xl md:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Itens Chave ({keyItems.length + pokeovoList.length})</h3>
              <div className="flex flex-wrap gap-2">
                {currentUser?.type === 'treinador' && (
                  <>
                    <button
                      onClick={() => { setShowPokesucoModal(true); setPokesucoSlots([null, null, null]); setPokesucoModificador(0); setPokesucoIntensificar(null); setPokesucoDominante(null) }}
                      className="p-0 hover:opacity-80 transition-opacity flex items-center justify-center"
                      title="Fazer Pokesuco"
                    >
                      <img src="/pokesuco/miniiconepokesuco.png" alt="Fazer Pokesuco" className="w-8 h-8 sm:w-9 sm:h-9 md:w-10 md:h-10 object-contain" />
                    </button>
                    <button
                      onClick={() => { setShowFazerPuffinModal(true); setPuffinSlots([null, null, null, null, null]); setPuffinSlotDropdown(null) }}
                      className="p-0 hover:opacity-80 transition-opacity flex items-center justify-center"
                      title="Fazer Puffin"
                    >
                      <img src="/miniiconefazerpuffin.png" alt="Fazer Puffin" className="w-8 h-8 sm:w-9 sm:h-9 md:w-10 md:h-10 object-contain" onError={(e) => { e.target.src = ''; e.target.style.display='none'; e.target.parentElement.innerHTML = '<span style="font-size:1.5rem">🐦</span>' }} />
                    </button>
                    <button
                      onClick={() => setShowSnackModal(true)}
                      className="p-0 hover:opacity-80 transition-opacity flex items-center justify-center"
                      title="Snack"
                    >
                      <img src="/minibittenpuffin.png" alt="Snack" className="w-8 h-8 sm:w-9 sm:h-9 md:w-10 md:h-10 object-contain" onError={(e) => { e.target.src = ''; e.target.style.display='none'; e.target.parentElement.innerHTML = '<span style="font-size:1.5rem">🍪</span>' }} />
                    </button>
                    <button
                      onClick={handleShinyCheck}
                      className="p-0 hover:opacity-80 transition-opacity flex items-center justify-center"
                      title="Será que veio shiny?"
                    >
                      <img src="/seraqueveioshiny.png" alt="Shiny Check" className="w-8 h-8 sm:w-9 sm:h-9 md:w-10 md:h-10" />
                    </button>
                    <button
                      onClick={handleOpenSedexModal}
                      className="bg-gradient-to-r from-green-600 to-emerald-700 text-white px-2 py-1.5 sm:px-3 sm:py-2 md:px-5 md:py-2 rounded-lg hover:from-green-700 hover:to-emerald-800 font-semibold flex items-center gap-1 sm:gap-2 text-xs sm:text-sm md:text-base"
                    >
                      📦 <span className="hidden xs:inline">Sedex Item</span><span className="xs:hidden">Sedex</span>
                    </button>
                  </>
                )}
                <button
                  onClick={() => setShowAddKeyItemModal(true)}
                  className="bg-gradient-to-r from-blue-600 to-purple-700 text-white px-2 py-1.5 sm:px-3 sm:py-2 md:px-5 md:py-2 rounded-lg hover:from-blue-700 hover:to-purple-800 font-semibold flex items-center gap-1 sm:gap-2 text-xs sm:text-sm md:text-base"
                >
                  <Plus size={16} className="sm:w-[18px] sm:h-[18px] md:w-5 md:h-5" />
                  <span className="hidden xs:inline">Adicionar Item</span><span className="xs:hidden">Add</span>
                </button>
              </div>
            </div>

            {(() => {
              const ITEMS_PER_PAGE = 24
              // Combinar todos os itens em uma lista unificada
              const allKeyItems = [
                ...pokeovoList.map(p => ({ type: 'pokeovo', data: p })),
                ...keyItems.filter(item => item.name === 'Shiny Charm').map(item => ({ type: 'shinyCharm', data: item })),
                ...keyItems.filter(item => item.name !== 'Shiny Charm').map(item => ({ type: 'regular', data: item }))
              ]
              const totalPages = Math.max(1, Math.ceil(allKeyItems.length / ITEMS_PER_PAGE))
              const currentPage = Math.min(keyItemsPage, totalPages - 1)
              const pageItems = allKeyItems.slice(currentPage * ITEMS_PER_PAGE, (currentPage + 1) * ITEMS_PER_PAGE)
              // Preencher slots vazios para completar o grid
              const emptySlots = ITEMS_PER_PAGE - pageItems.length

              return allKeyItems.length === 0 ? (
                <div className={`text-center py-4 sm:py-5 md:py-6 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                  <p className="text-sm sm:text-base">Nenhum item chave na mochila</p>
                </div>
              ) : (
                <>
                  <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 gap-2 sm:gap-3">
                    {pageItems.map((entry, idx) => {
                      if (entry.type === 'pokeovo') {
                        const pokeovo = entry.data
                        return (
                          <div
                            key={`pokeovo-${pokeovo.id}`}
                            className={`flex flex-col items-center p-1.5 sm:p-2 rounded-lg border-2 ${darkMode ? 'bg-gray-700 border-pink-500' : 'bg-pink-50 border-pink-400'} relative group`}
                          >
                            <button
                              onClick={() => setPokeovoList(pokeovoList.filter(p => p.id !== pokeovo.id))}
                              className="absolute top-0.5 right-0.5 sm:top-1 sm:right-1 text-red-500 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity"
                              title="Excluir Pokeovo"
                            >
                              <Trash2 size={12} className="sm:w-[14px] sm:h-[14px]" />
                            </button>
                            <div className="w-10 h-10 sm:w-12 sm:h-12 mb-1 flex items-center justify-center">
                              <img
                                src={POKEOVO_IMAGES[pokeovo.imageIndex]}
                                alt={pokeovo.displayName}
                                className="max-w-full max-h-full object-contain"
                                onError={(e) => { e.target.style.display = 'none' }}
                              />
                            </div>
                            <h4 className={`font-bold text-[10px] sm:text-xs text-center mb-1 ${darkMode ? 'text-white' : 'text-gray-800'} truncate w-full`} title={pokeovo.displayName}>
                              {pokeovo.displayName}
                            </h4>
                            <button
                              onClick={() => handleHatchEgg(pokeovo)}
                              className="bg-gradient-to-r from-yellow-500 to-orange-600 text-white px-1.5 py-0.5 sm:px-2 rounded text-[10px] sm:text-xs font-semibold hover:from-yellow-600 hover:to-orange-700"
                            >
                              Chocar
                            </button>
                          </div>
                        )
                      } else if (entry.type === 'shinyCharm') {
                        const item = entry.data
                        return (
                          <div
                            key={`shiny-charm-${idx}`}
                            className={`flex flex-col items-center p-1.5 sm:p-2 rounded-lg border-2 ${darkMode ? 'bg-gradient-to-br from-yellow-900 to-amber-800 border-yellow-600' : 'bg-gradient-to-br from-yellow-100 to-amber-100 border-yellow-400'} relative group`}
                          >
                            <button
                              onClick={() => handleOpenDeleteConfirm(item.name, 'keyItem')}
                              className="absolute top-0.5 right-0.5 sm:top-1 sm:right-1 text-red-500 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity"
                              title="Excluir item"
                            >
                              <Trash2 size={12} className="sm:w-[14px] sm:h-[14px]" />
                            </button>
                            <button
                              onClick={() => {
                                setShinyCharmToEdit(item)
                                setShinyCharmLuckyNumber(item.luckyNumber?.toString() || '')
                                setShowEditShinyCharmModal(true)
                              }}
                              className="absolute top-0.5 left-0.5 sm:top-1 sm:left-1 text-blue-500 hover:text-blue-600 opacity-0 group-hover:opacity-100 transition-opacity"
                              title="Editar número da sorte"
                            >
                              <Pencil size={12} className="sm:w-[14px] sm:h-[14px]" />
                            </button>
                            <div className="w-10 h-10 sm:w-12 sm:h-12 mb-1 flex items-center justify-center">
                              <img
                                src="/pokeballs/shinycharm.png"
                                alt={item.name}
                                className="max-w-full max-h-full object-contain"
                                onError={(e) => { e.target.style.display = 'none' }}
                              />
                            </div>
                            <h4 className={`font-bold text-[10px] sm:text-xs text-center mb-0.5 ${darkMode ? 'text-yellow-300' : 'text-yellow-700'} truncate w-full`} title={item.name}>
                              ✨ {item.name}
                            </h4>
                            <span className={`text-[10px] sm:text-xs ${darkMode ? 'text-yellow-400' : 'text-yellow-600'}`}>
                              Nº: {item.luckyNumber}
                            </span>
                          </div>
                        )
                      } else {
                        const item = entry.data
                        return (
                          <div
                            key={`item-${item.name}-${idx}`}
                            className={`flex flex-col items-center p-1.5 sm:p-2 rounded-lg border-2 ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-gray-50 border-gray-300'} relative group`}
                          >
                            <button
                              onClick={() => handleOpenDeleteConfirm(item.name, 'keyItem')}
                              className="absolute top-0.5 right-0.5 sm:top-1 sm:right-1 text-red-500 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity"
                              title="Excluir item"
                            >
                              <Trash2 size={12} className="sm:w-[14px] sm:h-[14px]" />
                            </button>
                            <button
                              onClick={() => { setMochilaDescItem(item); setShowMochilaDescModal(true) }}
                              className={`absolute top-0.5 left-0.5 sm:top-1 sm:left-1 opacity-0 group-hover:opacity-100 transition-opacity ${darkMode ? 'text-blue-400 hover:text-blue-300' : 'text-blue-500 hover:text-blue-600'}`}
                              title="Ver descrição"
                            >
                              <Info size={12} className="sm:w-[14px] sm:h-[14px]" />
                            </button>
                            <div className="w-10 h-10 sm:w-12 sm:h-12 mb-1 flex items-center justify-center">
                              <img
                                src={item.image || getItemImage(item.name)}
                                alt={item.name}
                                className="max-w-full max-h-full object-contain"
                                onError={(e) => { e.target.src = '/pokeballs/placeholderitem.png' }}
                              />
                            </div>
                            <h4 className={`font-bold text-[10px] sm:text-xs text-center mb-1 ${darkMode ? 'text-white' : 'text-gray-800'} truncate w-full`} title={item.name}>
                              {item.name}
                            </h4>
                            <div className="flex items-center gap-0.5">
                              <button
                                onClick={() => handleDecrementKeyItem(item.name)}
                                className={`p-0.5 rounded ${darkMode ? 'bg-gray-600 hover:bg-gray-500' : 'bg-gray-300 hover:bg-gray-400'}`}
                                title="Diminuir quantidade"
                              >
                                <Minus size={10} className="sm:w-3 sm:h-3" />
                              </button>
                              <span
                                onClick={() => handleOpenEditKeyItemQuantity(item)}
                                className={`font-bold text-xs sm:text-sm cursor-pointer ${darkMode ? 'text-white' : 'text-gray-800'} px-1 rounded ${darkMode ? 'hover:bg-gray-600' : 'hover:bg-gray-200'} min-w-[24px] sm:min-w-[28px] text-center`}
                                title="Clique para editar quantidade"
                              >
                                {item.quantity}
                              </span>
                              <button
                                onClick={() => handleIncrementKeyItem(item.name)}
                                className={`p-0.5 rounded ${darkMode ? 'bg-gray-600 hover:bg-gray-500' : 'bg-gray-300 hover:bg-gray-400'}`}
                                title="Aumentar quantidade"
                              >
                                <Plus size={10} className="sm:w-3 sm:h-3" />
                              </button>
                            </div>
                          </div>
                        )
                      }
                    })}
                    {/* Slots vazios */}
                    {Array.from({ length: emptySlots }).map((_, idx) => (
                      <div
                        key={`empty-${idx}`}
                        className={`flex flex-col items-center p-1.5 sm:p-2 rounded-lg border-2 border-dashed ${darkMode ? 'border-gray-600' : 'border-gray-300'} min-h-[100px] sm:min-h-[120px]`}
                      />
                    ))}
                  </div>
                  {/* Paginação */}
                  {totalPages > 1 && (
                    <div className="flex justify-center items-center gap-2 sm:gap-3 mt-3 sm:mt-4">
                      <button
                        onClick={() => setKeyItemsPage(Math.max(0, currentPage - 1))}
                        disabled={currentPage === 0}
                        className={`px-2 py-1 sm:px-3 rounded font-semibold text-sm sm:text-base ${currentPage === 0 ? 'opacity-40 cursor-not-allowed' : 'hover:opacity-80'} ${darkMode ? 'bg-gray-600 text-white' : 'bg-gray-300 text-gray-800'}`}
                      >
                        ◀
                      </button>
                      <span className={`font-bold text-sm sm:text-base ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                        {currentPage + 1} / {totalPages}
                      </span>
                      <button
                        onClick={() => setKeyItemsPage(Math.min(totalPages - 1, currentPage + 1))}
                        disabled={currentPage === totalPages - 1}
                        className={`px-2 py-1 sm:px-3 rounded font-semibold text-sm sm:text-base ${currentPage === totalPages - 1 ? 'opacity-40 cursor-not-allowed' : 'hover:opacity-80'} ${darkMode ? 'bg-gray-600 text-white' : 'bg-gray-300 text-gray-800'}`}
                      >
                        ▶
                      </button>
                    </div>
                  )}
                </>
              )
            })()}
          </div>

          {/* Seção Fotografias */}
          <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-6 mb-4 sm:mb-5 md:mb-6`}>
            <div className="flex justify-between items-center mb-3 sm:mb-4">
              <h3 className={`text-lg sm:text-xl md:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Fotografias</h3>
              <button onClick={() => setShowFotografiaModal(true)}
                className="p-1.5 sm:p-2 rounded-lg transition-all hover:opacity-70"
                title="Revelar foto">
                <img src="/revelarpokemon.png" alt="Revelar foto" className="w-6 h-6 sm:w-7 sm:h-7 md:w-8 md:h-8 object-contain" />
              </button>
            </div>
            {fotografias.length === 0 ? (
              <p className={`text-center text-xs sm:text-sm ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Nenhuma fotografia revelada.</p>
            ) : (
              <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2 sm:gap-3">
                {fotografias.map((foto) => (
                  <div key={foto.id} className={`rounded-xl overflow-hidden shadow-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                    <div className="relative" style={{ aspectRatio: '4/3' }}>
                      <img src={foto.url} alt="Fotografia" className="absolute inset-0 w-full h-full object-cover" style={{ padding: '6%', paddingBottom: '18%' }} />
                      <img src="/fotografiatemplate.png" alt="" className="absolute inset-0 w-full h-full object-fill pointer-events-none" />
                    </div>
                    <div className={`px-1 py-0.5 sm:px-2 sm:py-1 text-center text-xs sm:text-sm font-bold ${darkMode ? 'text-yellow-300' : 'text-yellow-700'}`}>
                      {foto.nome && <span className={`block ${darkMode ? 'text-white' : 'text-gray-800'} truncate`} title={foto.nome}>{foto.nome}</span>}
                      ₽{foto.preco}
                    </div>
                    <div className="flex justify-center gap-1 sm:gap-2 pb-1 sm:pb-2">
                      <button onClick={() => {
                        setFotografiaNome(foto.nome || '')
                        setFotografiaUrl(foto.url)
                        setFotografiaPreco(foto.preco)
                        setEditingFotografiaId(foto.id)
                        setShowFotografiaModal(true)
                      }}
                        className={`p-1.5 rounded-lg transition-all ${darkMode ? 'bg-gray-600 hover:bg-gray-500 text-blue-400' : 'bg-gray-200 hover:bg-gray-300 text-blue-600'}`}
                        title="Editar">
                        <Pencil size={14} />
                      </button>
                      <button onClick={async () => {
                        const updated = fotografias.filter(f => f.id !== foto.id)
                        setFotografias(updated)
                        if (useFirebase && currentUser) {
                          await set(ref(database, `trainers/${currentUser.username}/fotografias`), updated)
                        }
                      }}
                        className={`p-1.5 rounded-lg transition-all ${darkMode ? 'bg-gray-600 hover:bg-gray-500 text-red-400' : 'bg-gray-200 hover:bg-gray-300 text-red-600'}`}
                        title="Excluir">
                        <Trash2 size={14} />
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>

          {/* POKÉOFICINA - para Captores */}
          {classes.includes('Captor') && (() => {
            // Verificar talentos
            const hasCriarPokebola = talentosSelected.some(t => {
              const nome = typeof t === 'string' ? t : t.nome
              return nome === 'Criar Pokébola'
            })
            const hasRepararPokebola = talentosSelected.some(t => {
              const nome = typeof t === 'string' ? t : t.nome
              return nome === 'Reparar Pokébola'
            })

            // Só mostrar a seção se tiver pelo menos um dos talentos
            if (!hasCriarPokebola && !hasRepararPokebola) return null

            return (
              <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-6 mb-4 sm:mb-5 md:mb-6`}>
                <h3 className={`text-lg sm:text-xl md:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'} mb-3 sm:mb-4`}>🔧 Pokéoficina</h3>
                <div className={`p-2 sm:p-4 md:p-6 rounded-lg border-2 ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-gray-50 border-gray-300'}`}>
                  <div className="flex flex-col sm:flex-row flex-wrap gap-2 sm:gap-3 mb-3 sm:mb-4">
                    {hasCriarPokebola && (
                      <button
                        onClick={handleCriarPokebola}
                        className="flex-1 min-w-[160px] sm:min-w-[200px] bg-gradient-to-r from-blue-600 to-cyan-700 text-white px-3 py-2 sm:px-4 sm:py-2.5 md:px-6 md:py-3 rounded-lg hover:from-blue-700 hover:to-cyan-800 font-semibold shadow-lg transition-all text-sm sm:text-base"
                      >
                        🎲 Criar Pokébola
                      </button>
                    )}
                    {hasRepararPokebola && (
                      <button
                        onClick={handleRepararPokebola}
                        className="flex-1 min-w-[160px] sm:min-w-[200px] bg-gradient-to-r from-orange-600 to-red-700 text-white px-3 py-2 sm:px-4 sm:py-2.5 md:px-6 md:py-3 rounded-lg hover:from-orange-700 hover:to-red-800 font-semibold shadow-lg transition-all text-sm sm:text-base"
                      >
                        🔧 Reparar Pokébola
                      </button>
                    )}
                  </div>
                  <div className={`p-2 sm:p-3 rounded-lg ${darkMode ? 'bg-gray-600' : 'bg-gray-100'}`}>
                    <p className={`text-xs sm:text-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                      {hasCriarPokebola && (
                        <>
                          <strong>Criar Pokébola:</strong> Rola 1d20 + Mod. Velocidade. Resultado 1-14: Pokeball | 15-19: Greatball | 20+: Ultraball
                        </>
                      )}
                      {hasCriarPokebola && hasRepararPokebola && <br />}
                      {hasRepararPokebola && (
                        <>
                          <strong>Reparar Pokébola:</strong> Rola 1d20 + Mod. Velocidade. Resultado ≥16: Sucesso (consome peça e adiciona pokébola) | &lt;16: Falha (apenas consome peça)
                        </>
                      )}
                    </p>
                  </div>
                </div>
              </div>
            )
          })()}

          {/* Itens Customizados */}
          <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-6`}>
            <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 sm:gap-3 mb-3 sm:mb-4">
              <h3 className={`text-lg sm:text-xl md:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Itens Customizados ({customItems.length})</h3>
              <button
                onClick={() => setShowAddCustomItemModal(true)}
                className="bg-gradient-to-r from-green-600 to-teal-700 text-white px-2 py-1.5 sm:px-3 sm:py-2 md:px-5 md:py-2 rounded-lg hover:from-green-700 hover:to-teal-800 font-semibold flex items-center gap-1 sm:gap-2 text-xs sm:text-sm md:text-base"
              >
                <Plus size={16} className="sm:w-[18px] sm:h-[18px] md:w-5 md:h-5" />
                <span className="hidden xs:inline">Criar Item</span><span className="xs:hidden">Criar</span>
              </button>
            </div>

            {customItems.length === 0 ? (
              <div className={`text-center py-4 sm:py-5 md:py-6 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                <p className="text-sm sm:text-base">Nenhum item customizado criado</p>
              </div>
            ) : (
              <div className="overflow-x-auto -mx-3 px-3 sm:mx-0 sm:px-0">
                <table className={`w-full min-w-[600px] ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  <thead>
                    <tr className={`border-b-2 ${darkMode ? 'border-gray-600' : 'border-gray-300'}`}>
                      <th className="p-2 sm:p-3 text-left font-bold text-xs sm:text-sm">Nome</th>
                      <th className="p-2 sm:p-3 text-center font-bold text-xs sm:text-sm">Qtd</th>
                      <th className="p-2 sm:p-3 text-left font-bold text-xs sm:text-sm">Descrição</th>
                      <th className="p-2 sm:p-3 text-center font-bold text-xs sm:text-sm">Bolso</th>
                      <th className="p-2 sm:p-3 text-center font-bold text-xs sm:text-sm">Editar</th>
                      <th className="p-2 sm:p-3 text-center font-bold text-xs sm:text-sm">Excluir</th>
                    </tr>
                  </thead>
                  <tbody>
                    {customItems.map((item, idx) => (
                      <tr key={idx} className={`border-b ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
                        <td className="p-2 sm:p-3">
                          <div className="flex items-center gap-1 sm:gap-2">
                            <button
                              onClick={() => {
                                setSelectedItemToGive(item)
                                setShowGiveItemModal(true)
                              }}
                              className={`${darkMode ? 'text-blue-400 hover:text-blue-300' : 'text-blue-600 hover:text-blue-700'}`}
                              title="Dar item para Pokémon"
                            >
                              <ArrowBigLeftDash size={16} className="sm:w-5 sm:h-5" />
                            </button>
                            <span className="font-semibold text-xs sm:text-sm truncate">{item.name}</span>
                          </div>
                        </td>
                        <td className="p-2 sm:p-3 text-center">
                          <span className={`font-bold text-xs sm:text-sm ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>{item.quantity}</span>
                        </td>
                        <td className="p-2 sm:p-3">
                          <span className={`text-xs sm:text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'} line-clamp-2`}>{item.description}</span>
                        </td>
                        <td className="p-2 sm:p-3 text-center">
                          <div className="flex flex-col items-center gap-0.5 sm:gap-1">
                            <button
                              onClick={() => {
                                if (idx === 0) return
                                const newItems = [...customItems]
                                const temp = newItems[idx]
                                newItems[idx] = newItems[idx - 1]
                                newItems[idx - 1] = temp
                                setCustomItems(newItems)
                              }}
                              disabled={idx === 0}
                              className={`text-xs sm:text-sm font-bold ${idx === 0 ? 'text-gray-400 cursor-not-allowed' : (darkMode ? 'text-blue-400 hover:text-blue-300' : 'text-blue-600 hover:text-blue-700')}`}
                              title="Mover para cima"
                            >
                              ▲
                            </button>
                            <button
                              onClick={() => {
                                if (idx === customItems.length - 1) return
                                const newItems = [...customItems]
                                const temp = newItems[idx]
                                newItems[idx] = newItems[idx + 1]
                                newItems[idx + 1] = temp
                                setCustomItems(newItems)
                              }}
                              disabled={idx === customItems.length - 1}
                              className={`text-xs sm:text-sm font-bold ${idx === customItems.length - 1 ? 'text-gray-400 cursor-not-allowed' : (darkMode ? 'text-blue-400 hover:text-blue-300' : 'text-blue-600 hover:text-blue-700')}`}
                              title="Mover para baixo"
                            >
                              ▼
                            </button>
                          </div>
                        </td>
                        <td className="p-2 sm:p-3 text-center">
                          <button
                            onClick={() => handleOpenEditCustomItem(item, idx)}
                            className={`${darkMode ? 'text-yellow-400 hover:text-yellow-300' : 'text-yellow-600 hover:text-yellow-700'}`}
                            title="Editar item"
                          >
                            <Wrench size={16} className="sm:w-[18px] sm:h-[18px]" />
                          </button>
                        </td>
                        <td className="p-2 sm:p-3 text-center">
                          <button
                            onClick={() => handleOpenDeleteConfirm(idx, 'customItem')}
                            className="text-red-500 hover:text-red-600"
                            title="Excluir item"
                          >
                            <Trash2 size={16} className="sm:w-[18px] sm:h-[18px]" />
                          </button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>

        </div>

        {/* Modal Adicionar Item Chave */}
        {showAddKeyItemModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowAddKeyItemModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl p-3 sm:p-5 md:p-6 max-w-md w-full max-h-[80vh] overflow-y-auto`} onClick={(e) => e.stopPropagation()}>
              <h3 className={`text-xl sm:text-2xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-800'}`}>Adicionar Item Chave</h3>

              <input
                type="text"
                placeholder="Buscar item..."
                value={keyItemSearch}
                onChange={(e) => setKeyItemSearch(e.target.value)}
                className={`w-full p-3 rounded-lg mb-4 ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-100 text-gray-800'}`}
              />

              <div className="mb-4 max-h-60 overflow-y-auto">
                {filteredKeyItems.map((item, idx) => (
                  <button
                    key={idx}
                    onClick={() => setSelectedKeyItem(item)}
                    className={`w-full p-3 rounded-lg mb-2 text-left ${
                      selectedKeyItem === item
                        ? 'bg-gradient-to-r from-blue-600 to-purple-700 text-white'
                        : darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-100 text-gray-800 hover:bg-gray-200'
                    }`}
                  >
                    {item}
                  </button>
                ))}
              </div>

              <div className="mb-4">
                <label className={`block mb-2 font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Quantidade</label>
                <input
                  type="number"
                  min="1"
                  value={keyItemQuantity}
                  onChange={(e) => setKeyItemQuantity(parseInt(e.target.value) || 1)}
                  className={`w-full p-3 rounded-lg ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-100 text-gray-800'}`}
                />
              </div>

              <div className="flex gap-3">
                <button
                  onClick={() => setShowAddKeyItemModal(false)}
                  className={`flex-1 py-3 rounded-lg font-semibold ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                >
                  Cancelar
                </button>
                <button
                  onClick={handleAddKeyItem}
                  className="flex-1 bg-gradient-to-r from-blue-600 to-purple-700 text-white py-3 rounded-lg hover:from-blue-700 hover:to-purple-800 font-semibold"
                >
                  Adicionar
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Modal Adicionar Item Customizado */}
        {showAddCustomItemModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowAddCustomItemModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl p-3 sm:p-5 md:p-6 max-w-md w-full`} onClick={(e) => e.stopPropagation()}>
              <h3 className={`text-xl sm:text-2xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-800'}`}>Criar Item Customizado</h3>

              <div className="mb-4">
                <label className={`block mb-2 font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Nome do Item</label>
                <input
                  type="text"
                  value={customItemName}
                  onChange={(e) => setCustomItemName(e.target.value)}
                  className={`w-full p-3 rounded-lg ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-100 text-gray-800'}`}
                  placeholder="Ex: Espada Mágica"
                />
              </div>

              <div className="mb-4">
                <label className={`block mb-2 font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Quantidade</label>
                <input
                  type="number"
                  min="1"
                  value={customItemQuantity}
                  onChange={(e) => setCustomItemQuantity(parseInt(e.target.value) || 1)}
                  className={`w-full p-3 rounded-lg ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-100 text-gray-800'}`}
                />
              </div>

              <div className="mb-4">
                <label className={`block mb-2 font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Descrição</label>
                <textarea
                  value={customItemDescription}
                  onChange={(e) => setCustomItemDescription(e.target.value)}
                  className={`w-full p-3 rounded-lg ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-100 text-gray-800'}`}
                  rows="3"
                  placeholder="Descreva o efeito do item..."
                />
              </div>

              <div className="flex gap-3">
                <button
                  onClick={() => setShowAddCustomItemModal(false)}
                  className={`flex-1 py-3 rounded-lg font-semibold ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                >
                  Cancelar
                </button>
                <button
                  onClick={handleAddCustomItem}
                  className="flex-1 bg-gradient-to-r from-green-600 to-teal-700 text-white py-3 rounded-lg hover:from-green-700 hover:to-teal-800 font-semibold"
                >
                  Criar
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Modal Selecionar Espécie do Pokeovo */}
        {showPokeovoSpeciesModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowPokeovoSpeciesModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl p-3 sm:p-5 md:p-6 max-w-md w-full max-h-[80vh] overflow-y-auto`} onClick={(e) => e.stopPropagation()}>
              <h3 className={`text-xl sm:text-2xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-800'}`}>Selecionar Espécie do Pokeovo</h3>

              <input
                type="text"
                placeholder="Buscar espécie..."
                value={pokeovoSpeciesSearch}
                onChange={(e) => setPokeovoSpeciesSearch(e.target.value)}
                className={`w-full p-3 rounded-lg mb-4 ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-100 text-gray-800'}`}
              />

              <div className="mb-4 max-h-60 overflow-y-auto">
                {/* Opção Misterioso sempre primeiro */}
                <button
                  onClick={() => setSelectedPokeovoSpecies('Misterioso')}
                  className={`w-full p-3 rounded-lg mb-2 text-left ${
                    selectedPokeovoSpecies === 'Misterioso'
                      ? 'bg-gradient-to-r from-purple-600 to-pink-700 text-white'
                      : darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-100 text-gray-800 hover:bg-gray-200'
                  }`}
                >
                  🥚 Misterioso
                </button>

                {/* Lista de espécies filtradas */}
                {POKEMON_SPECIES.filter(species =>
                  species.toLowerCase().includes(pokeovoSpeciesSearch.toLowerCase())
                ).slice(0, 50).map((species, idx) => (
                  <button
                    key={idx}
                    onClick={() => setSelectedPokeovoSpecies(species)}
                    className={`w-full p-3 rounded-lg mb-2 text-left ${
                      selectedPokeovoSpecies === species
                        ? 'bg-gradient-to-r from-blue-600 to-purple-700 text-white'
                        : darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-100 text-gray-800 hover:bg-gray-200'
                    }`}
                  >
                    {species}
                  </button>
                ))}
              </div>

              <div className="flex gap-3">
                <button
                  onClick={() => {
                    setShowPokeovoSpeciesModal(false)
                    setSelectedKeyItem('')
                  }}
                  className={`flex-1 py-3 rounded-lg font-semibold ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                >
                  Cancelar
                </button>
                <button
                  onClick={handleAddPokeovo}
                  className="flex-1 bg-gradient-to-r from-pink-600 to-purple-700 text-white py-3 rounded-lg hover:from-pink-700 hover:to-purple-800 font-semibold"
                >
                  Salvar
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Modal Qualidade do Pokesuco */}
        {showPokesucoQualidadeModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowPokesucoQualidadeModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl p-3 sm:p-5 md:p-6 max-w-sm w-full`} onClick={(e) => e.stopPropagation()}>
              <h3 className={`text-xl sm:text-2xl font-bold mb-2 ${darkMode ? 'text-white' : 'text-gray-800'}`}>🧃 {pokesucoQualidadeSelectedItem}</h3>
              <p className={`mb-4 text-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>Qual é a qualidade do suco? (1 a 10)</p>
              <input
                type="number"
                min="1"
                max="10"
                value={pokesucoQualidadeValue}
                onChange={(e) => setPokesucoQualidadeValue(e.target.value)}
                className={`w-full p-3 rounded-lg mb-4 text-center text-2xl font-bold ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-100 text-gray-800'}`}
              />
              <div className="flex gap-3">
                <button
                  onClick={() => { setShowPokesucoQualidadeModal(false); setPokesucoQualidadeSelectedItem('') }}
                  className={`flex-1 py-3 rounded-lg font-semibold ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                >
                  Cancelar
                </button>
                <button
                  onClick={handleConfirmPokesucoQualidade}
                  className="flex-1 bg-gradient-to-r from-purple-600 to-pink-600 text-white py-3 rounded-lg hover:from-purple-700 hover:to-pink-700 font-semibold"
                >
                  Adicionar
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Modal Valor e Aroma do Puffin */}
        {showPuffinValorModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowPuffinValorModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl p-4 sm:p-6 max-w-sm w-full`} onClick={(e) => e.stopPropagation()}>
              <h3 className={`text-xl font-bold mb-1 ${darkMode ? 'text-white' : 'text-gray-800'}`}>🐦 {puffinValorSelectedItem}</h3>
              <p className={`mb-4 text-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>Defina o valor e o aroma deste puffin.</p>

              <label className={`block text-sm font-semibold mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Valor</label>
              <input
                type="number"
                min="1"
                value={puffinValorValue}
                onChange={(e) => setPuffinValorValue(e.target.value)}
                className={`w-full p-3 rounded-lg mb-4 text-center text-2xl font-bold ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-100 text-gray-800'}`}
              />

              <label className={`block text-sm font-semibold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Aromatizado com</label>
              <div className="flex flex-wrap gap-2 mb-5">
                {['Picante', 'Seco', 'Doce', 'Amargo', 'Azedo'].map(flavor => (
                  <button
                    key={flavor}
                    onClick={() => setPuffinAromaFlavor(puffinAromaFlavor === flavor ? null : flavor)}
                    className={`px-3 py-1.5 rounded-full text-sm font-semibold transition-colors ${
                      puffinAromaFlavor === flavor
                        ? 'bg-purple-600 text-white'
                        : darkMode ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                    }`}
                  >
                    {flavor}
                  </button>
                ))}
                {puffinAromaFlavor && (
                  <button
                    onClick={() => setPuffinAromaFlavor(null)}
                    className={`px-3 py-1.5 rounded-full text-sm font-semibold ${darkMode ? 'bg-gray-700 text-gray-400 hover:bg-gray-600' : 'bg-gray-200 text-gray-500 hover:bg-gray-300'}`}
                  >
                    ✕ Sem aroma
                  </button>
                )}
              </div>

              {puffinAromaFlavor && (
                <p className={`text-xs mb-4 text-center ${darkMode ? 'text-purple-300' : 'text-purple-600'}`}>
                  Nome final: <strong>{puffinValorSelectedItem} ({puffinAromaFlavor}) {Math.max(1, parseInt(puffinValorValue) || 1)}</strong>
                </p>
              )}
              {!puffinAromaFlavor && (
                <p className={`text-xs mb-4 text-center ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                  Nome final: <strong>{puffinValorSelectedItem} {Math.max(1, parseInt(puffinValorValue) || 1)}</strong>
                </p>
              )}

              <div className="flex gap-3">
                <button
                  onClick={() => { setShowPuffinValorModal(false); setPuffinValorSelectedItem(''); setPuffinAromaFlavor(null) }}
                  className={`flex-1 py-3 rounded-lg font-semibold ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                >
                  Cancelar
                </button>
                <button
                  onClick={handleConfirmPuffinValor}
                  className="flex-1 bg-gradient-to-r from-purple-600 to-pink-600 text-white py-3 rounded-lg hover:from-purple-700 hover:to-pink-700 font-semibold"
                >
                  Adicionar
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Modal Custom Item Chave */}
        {showCustomKeyItemModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowCustomKeyItemModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl p-4 sm:p-6 max-w-sm w-full`} onClick={(e) => e.stopPropagation()}>
              <h3 className={`text-xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-800'}`}>🎒 Custom Item Chave</h3>

              <div className="mb-4">
                <label className={`block text-sm font-semibold mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Nome do item</label>
                <input
                  type="text"
                  value={customKeyItemName}
                  onChange={(e) => setCustomKeyItemName(e.target.value)}
                  placeholder="Ex: Grimório Antigo"
                  className={`w-full p-3 rounded-lg ${darkMode ? 'bg-gray-700 text-white placeholder-gray-500' : 'bg-gray-100 text-gray-800 placeholder-gray-400'}`}
                />
              </div>

              <div className="mb-4">
                <label className={`block text-sm font-semibold mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Quantidade</label>
                <input
                  type="number"
                  min="1"
                  value={customKeyItemQty}
                  onChange={(e) => setCustomKeyItemQty(e.target.value)}
                  className={`w-full p-3 rounded-lg text-center text-xl font-bold ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-100 text-gray-800'}`}
                />
              </div>

              <div className="mb-5">
                <label className={`block text-sm font-semibold mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>URL da imagem <span className={`font-normal ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>(opcional)</span></label>
                <input
                  type="text"
                  value={customKeyItemImageUrl}
                  onChange={(e) => setCustomKeyItemImageUrl(e.target.value)}
                  placeholder="https://..."
                  className={`w-full p-3 rounded-lg text-sm ${darkMode ? 'bg-gray-700 text-white placeholder-gray-500' : 'bg-gray-100 text-gray-800 placeholder-gray-400'}`}
                />
                {!customKeyItemImageUrl && (
                  <p className={`text-xs mt-1 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>Sem imagem: será usado o ícone padrão.</p>
                )}
              </div>

              <div className="mb-5">
                <label className={`block text-sm font-semibold mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Descrição <span className={`font-normal ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>(opcional)</span></label>
                <textarea
                  value={customKeyItemDescription}
                  onChange={(e) => setCustomKeyItemDescription(e.target.value)}
                  placeholder="Descreva o item..."
                  rows={3}
                  className={`w-full p-3 rounded-lg text-sm resize-none ${darkMode ? 'bg-gray-700 text-white placeholder-gray-500' : 'bg-gray-100 text-gray-800 placeholder-gray-400'}`}
                />
              </div>

              <div className="flex gap-3">
                <button
                  onClick={() => { setShowCustomKeyItemModal(false); setCustomKeyItemName(''); setCustomKeyItemQty(1); setCustomKeyItemImageUrl(''); setCustomKeyItemDescription('') }}
                  className={`flex-1 py-3 rounded-lg font-semibold ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                >
                  Cancelar
                </button>
                <button
                  onClick={handleConfirmCustomKeyItem}
                  className="flex-1 bg-gradient-to-r from-blue-600 to-purple-700 text-white py-3 rounded-lg hover:from-blue-700 hover:to-purple-800 font-semibold"
                >
                  Salvar
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Modal Descrição Item Mochila */}
        {showMochilaDescModal && mochilaDescItem && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowMochilaDescModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl p-4 sm:p-6 max-w-sm w-full`} onClick={(e) => e.stopPropagation()}>
              <div className="w-full h-24 mb-3 flex items-center justify-center">
                <img
                  src={mochilaDescItem.image || getItemImage(mochilaDescItem.name)}
                  alt={mochilaDescItem.name}
                  className="max-w-full max-h-full object-contain"
                  onError={(e) => { e.target.src = '/pokeballs/placeholderitem.png' }}
                />
              </div>
              <h3 className={`text-lg font-bold text-center mb-3 ${darkMode ? 'text-white' : 'text-gray-800'}`}>{mochilaDescItem.name}</h3>
              <p className={`text-sm text-center mb-5 ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                {getMochilaItemDescription(mochilaDescItem)}
              </p>
              <button
                onClick={() => setShowMochilaDescModal(false)}
                className={`w-full py-3 rounded-lg font-semibold ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
              >
                Fechar
              </button>
            </div>
          </div>
        )}

        {/* Modal Adicionar Shiny Charm */}
        {showShinyCharmModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowShinyCharmModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl p-3 sm:p-5 md:p-6 max-w-md w-full`} onClick={(e) => e.stopPropagation()}>
              <h3 className={`text-xl sm:text-2xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-800'}`}>✨ Shiny Charm</h3>

              <p className={`mb-4 ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                Insira seu número da sorte (1 a 1365):
              </p>

              <input
                type="number"
                min="1"
                max="1365"
                value={shinyCharmLuckyNumber}
                onChange={(e) => setShinyCharmLuckyNumber(e.target.value)}
                placeholder="Ex: 777"
                className={`w-full p-3 rounded-lg mb-4 ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-100 text-gray-800'}`}
              />

              <div className="flex gap-3">
                <button
                  onClick={() => {
                    setShowShinyCharmModal(false)
                    setSelectedKeyItem('')
                    setShinyCharmLuckyNumber('')
                  }}
                  className={`flex-1 py-3 rounded-lg font-semibold ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                >
                  Cancelar
                </button>
                <button
                  onClick={handleAddShinyCharm}
                  className="flex-1 bg-gradient-to-r from-yellow-500 to-amber-600 text-white py-3 rounded-lg hover:from-yellow-600 hover:to-amber-700 font-semibold"
                >
                  Adicionar
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Modal Reparar Pokébola */}
        {showRepairPokeballModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowRepairPokeballModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl p-3 sm:p-5 md:p-6 max-w-md w-full max-h-[80vh] overflow-y-auto`} onClick={(e) => e.stopPropagation()}>
              <h3 className={`text-xl sm:text-2xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-800'}`}>🔧 Reparar Pokébola</h3>

              <p className={`mb-4 ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                Escolha o tipo de pokébola para reparar:
              </p>

              <input
                type="text"
                placeholder="Buscar tipo de pokébola..."
                value={repairPokeballSearch}
                onChange={(e) => setRepairPokeballSearch(e.target.value)}
                className={`w-full p-3 rounded-lg mb-4 ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-100 text-gray-800'}`}
              />

              <div className="mb-4 max-h-60 overflow-y-auto">
                {POKEBALLS_LIST
                  .filter(ball => ball !== 'Custom Pokeball')
                  .filter(ball => ball.toLowerCase().includes(repairPokeballSearch.toLowerCase()))
                  .map((ball) => (
                    <button
                      key={ball}
                      onClick={() => setSelectedPokeballToRepair(ball)}
                      className={`w-full p-3 rounded-lg mb-2 text-left ${
                        selectedPokeballToRepair === ball
                          ? 'bg-gradient-to-r from-orange-600 to-red-700 text-white'
                          : darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-100 text-gray-800 hover:bg-gray-200'
                      }`}
                    >
                      {ball}
                    </button>
                  ))}
              </div>

              <div className={`mb-4 p-3 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                  • Rolagem: 1d20 + Modificador de Velocidade<br />
                  • Se resultado ≥ 16: Consome peça e adiciona 1 pokébola<br />
                  • Se resultado &lt; 16: Apenas consome a peça
                </p>
              </div>

              <div className="flex gap-3">
                <button
                  onClick={() => {
                    setShowRepairPokeballModal(false)
                    setSelectedPokeballToRepair('')
                    setRepairPokeballSearch('')
                  }}
                  className={`flex-1 py-3 rounded-lg font-semibold ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                >
                  Cancelar
                </button>
                <button
                  onClick={handleConfirmRepairPokeball}
                  className="flex-1 bg-gradient-to-r from-orange-600 to-red-700 text-white py-3 rounded-lg hover:from-orange-700 hover:to-red-800 font-semibold"
                >
                  Reparar
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Modal Editar Shiny Charm */}
        {showEditShinyCharmModal && shinyCharmToEdit && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowEditShinyCharmModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl p-3 sm:p-5 md:p-6 max-w-md w-full`} onClick={(e) => e.stopPropagation()}>
              <h3 className={`text-xl sm:text-2xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-800'}`}>✨ Editar Shiny Charm</h3>

              <p className={`mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                Número da sorte atual: <strong>{shinyCharmToEdit.luckyNumber}</strong>
              </p>
              <p className={`mb-4 ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                Insira o novo número da sorte (1 a 1365):
              </p>

              <input
                type="number"
                min="1"
                max="1365"
                value={shinyCharmLuckyNumber}
                onChange={(e) => setShinyCharmLuckyNumber(e.target.value)}
                placeholder="Ex: 777"
                className={`w-full p-3 rounded-lg mb-4 ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-100 text-gray-800'}`}
              />

              <div className="flex gap-3">
                <button
                  onClick={() => {
                    setShowEditShinyCharmModal(false)
                    setShinyCharmToEdit(null)
                    setShinyCharmLuckyNumber('')
                  }}
                  className={`flex-1 py-3 rounded-lg font-semibold ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                >
                  Cancelar
                </button>
                <button
                  onClick={handleEditShinyCharm}
                  className="flex-1 bg-gradient-to-r from-yellow-500 to-amber-600 text-white py-3 rounded-lg hover:from-yellow-600 hover:to-amber-700 font-semibold"
                >
                  Salvar
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Modal Sedex Item */}
        {showSedexItemModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowSedexItemModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl p-3 sm:p-5 md:p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto`} onClick={(e) => e.stopPropagation()}>
              <h3 className={`text-xl sm:text-2xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-800'}`}>📦 Sedex Item</h3>

              <p className={`mb-4 ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                Envie um item da sua mochila para outro treinador:
              </p>

              {/* Busca de Item */}
              <div className="mb-4">
                <label className={`block mb-2 font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Selecione o Item</label>
                <input
                  type="text"
                  placeholder="Buscar item..."
                  value={sedexItemSearch}
                  onChange={(e) => setSedexItemSearch(e.target.value)}
                  className={`w-full p-3 rounded-lg mb-2 ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-100 text-gray-800'}`}
                />

                <div className="max-h-40 overflow-y-auto">
                  {/* Itens Chave */}
                  {keyItems
                    .filter(item => item.name.toLowerCase().includes(sedexItemSearch.toLowerCase()))
                    .map((item, idx) => (
                      <button
                        key={`key-${idx}`}
                        onClick={() => setSelectedSedexItem({ ...item, type: 'key' })}
                        className={`w-full p-3 rounded-lg mb-2 text-left ${
                          selectedSedexItem?.name === item.name && selectedSedexItem?.type === 'key'
                            ? 'bg-gradient-to-r from-green-600 to-emerald-700 text-white'
                            : darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-100 text-gray-800 hover:bg-gray-200'
                        }`}
                      >
                        <div className="flex justify-between items-center">
                          <span className="font-semibold">{item.name}</span>
                          <span className="text-sm opacity-75">Qtd: {item.quantity}</span>
                        </div>
                        <span className="text-xs opacity-75">Item Chave</span>
                      </button>
                    ))}

                  {/* Itens Customizados */}
                  {customItems
                    .filter(item => item.name.toLowerCase().includes(sedexItemSearch.toLowerCase()))
                    .map((item, idx) => (
                      <button
                        key={`custom-${idx}`}
                        onClick={() => setSelectedSedexItem({ ...item, type: 'custom' })}
                        className={`w-full p-3 rounded-lg mb-2 text-left ${
                          selectedSedexItem?.name === item.name && selectedSedexItem?.type === 'custom'
                            ? 'bg-gradient-to-r from-green-600 to-emerald-700 text-white'
                            : darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-100 text-gray-800 hover:bg-gray-200'
                        }`}
                      >
                        <div className="flex justify-between items-center">
                          <span className="font-semibold">{item.name}</span>
                          <span className="text-sm opacity-75">Qtd: {item.quantity}</span>
                        </div>
                        <span className="text-xs opacity-75">Item Customizado - {item.description}</span>
                      </button>
                    ))}

                  {/* Fotografias */}
                  {fotografias
                    .filter(foto => (foto.nome || '').toLowerCase().includes(sedexItemSearch.toLowerCase()))
                    .map((foto, idx) => (
                      <button
                        key={`foto-${idx}`}
                        onClick={() => setSelectedSedexItem({ ...foto, name: foto.nome || 'Fotografia sem nome', type: 'fotografia', quantity: 1 })}
                        className={`w-full p-3 rounded-lg mb-2 text-left ${
                          selectedSedexItem?.id === foto.id && selectedSedexItem?.type === 'fotografia'
                            ? 'bg-gradient-to-r from-green-600 to-emerald-700 text-white'
                            : darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-100 text-gray-800 hover:bg-gray-200'
                        }`}
                      >
                        <div className="flex justify-between items-center">
                          <span className="font-semibold">{foto.nome || 'Fotografia sem nome'}</span>
                          <span className="text-sm opacity-75">₽{foto.preco}</span>
                        </div>
                        <span className="text-xs opacity-75">Fotografia</span>
                      </button>
                    ))}
                </div>
              </div>

              {/* Seleção de Treinador */}
              <div className="mb-4">
                <label className={`block mb-2 font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Selecione o Treinador</label>
                <div className="max-h-40 overflow-y-auto">
                  {availableTrainers.length === 0 ? (
                    <p className={`text-center py-4 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                      Nenhum treinador disponível
                    </p>
                  ) : (
                    availableTrainers.map((trainer, idx) => (
                      <label
                        key={idx}
                        className={`flex items-center p-3 rounded-lg mb-2 cursor-pointer ${
                          darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-100 hover:bg-gray-200'
                        }`}
                      >
                        <input
                          type="checkbox"
                          checked={selectedSedexTrainer === trainer.username}
                          onChange={(e) => {
                            if (e.target.checked) {
                              setSelectedSedexTrainer(trainer.username)
                            } else {
                              setSelectedSedexTrainer('')
                            }
                          }}
                          className="mr-3 w-5 h-5"
                        />
                        <span className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                          {trainer.username}
                        </span>
                      </label>
                    ))
                  )}
                </div>
              </div>

              {/* Item e Treinador Selecionados */}
              {selectedSedexItem && selectedSedexTrainer && (
                <div className={`mb-4 p-3 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                  <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                    <strong>Enviando:</strong> {selectedSedexItem.name}<br />
                    <strong>Para:</strong> {selectedSedexTrainer}
                  </p>
                </div>
              )}

              <div className="flex gap-3">
                <button
                  onClick={() => {
                    setShowSedexItemModal(false)
                    setSedexItemSearch('')
                    setSelectedSedexItem(null)
                    setSelectedSedexTrainer('')
                  }}
                  className={`flex-1 py-3 rounded-lg font-semibold ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                >
                  Cancelar
                </button>
                <button
                  onClick={handleDispatchItem}
                  className="flex-1 bg-gradient-to-r from-green-600 to-emerald-700 text-white py-3 rounded-lg hover:from-green-700 hover:to-emerald-800 font-semibold"
                >
                  Despachar
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Modal Chocar Ovo Misterioso */}
        {showHatchMysteryEggModal && selectedPokeovoToHatch && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowHatchMysteryEggModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl p-3 sm:p-5 md:p-6 max-w-md w-full max-h-[80vh] overflow-y-auto`} onClick={(e) => e.stopPropagation()}>
              <h3 className={`text-xl sm:text-2xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-800'}`}>Qual Pokémon está no ovo?</h3>

              <input
                type="text"
                placeholder="Buscar espécie..."
                value={hatchSpeciesSearch}
                onChange={(e) => setHatchSpeciesSearch(e.target.value)}
                className={`w-full p-3 rounded-lg mb-4 ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-100 text-gray-800'}`}
              />

              <div className="mb-4 max-h-60 overflow-y-auto">
                {POKEMON_SPECIES.filter(species =>
                  species.toLowerCase().includes(hatchSpeciesSearch.toLowerCase())
                ).slice(0, 50).map((species, idx) => (
                  <button
                    key={idx}
                    onClick={() => setSelectedHatchSpecies(species)}
                    className={`w-full p-3 rounded-lg mb-2 text-left ${
                      selectedHatchSpecies === species
                        ? 'bg-gradient-to-r from-yellow-500 to-orange-600 text-white'
                        : darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-100 text-gray-800 hover:bg-gray-200'
                    }`}
                  >
                    {species}
                  </button>
                ))}
              </div>

              {selectedHatchSpecies && (
                <div className="flex items-center gap-2 mb-4 p-2 rounded-lg justify-center">
                  <span className={`text-sm font-semibold ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>Dieta:</span>
                  <DietIcons speciesName={selectedHatchSpecies} size={20} />
                </div>
              )}

              <div className="flex gap-3">
                <button
                  onClick={() => {
                    setShowHatchMysteryEggModal(false)
                    setSelectedPokeovoToHatch(null)
                  }}
                  className={`flex-1 py-3 rounded-lg font-semibold ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                >
                  Cancelar
                </button>
                <button
                  onClick={handleConfirmHatchMysteryEgg}
                  disabled={!selectedHatchSpecies}
                  className={`flex-1 py-3 rounded-lg font-semibold ${
                    selectedHatchSpecies
                      ? 'bg-gradient-to-r from-yellow-500 to-orange-600 text-white hover:from-yellow-600 hover:to-orange-700'
                      : 'bg-gray-400 text-gray-600 cursor-not-allowed'
                  }`}
                >
                  Chocar
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Modal Editar Quantidade */}
        {showEditKeyItemQuantityModal && selectedKeyItemForEdit && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowEditKeyItemQuantityModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl p-3 sm:p-5 md:p-6 max-w-md w-full`} onClick={(e) => e.stopPropagation()}>
              <h3 className={`text-xl sm:text-2xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                Editar Quantidade - {selectedKeyItemForEdit.name}
              </h3>

              <div className="mb-4">
                <label className={`block mb-2 font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Quantidade</label>
                <input
                  type="number"
                  min="1"
                  value={editKeyItemQuantity}
                  onChange={(e) => setEditKeyItemQuantity(parseInt(e.target.value) || 1)}
                  className={`w-full p-3 rounded-lg ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-100 text-gray-800'}`}
                />
              </div>

              <div className="flex gap-3">
                <button
                  onClick={() => setShowEditKeyItemQuantityModal(false)}
                  className={`flex-1 py-3 rounded-lg font-semibold ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                >
                  Cancelar
                </button>
                <button
                  onClick={handleSaveEditKeyItemQuantity}
                  className="flex-1 bg-gradient-to-r from-blue-600 to-purple-700 text-white py-3 rounded-lg hover:from-blue-700 hover:to-purple-800 font-semibold"
                >
                  Salvar
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Modal Confirmar Exclusão */}
        {showDeleteConfirmModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowDeleteConfirmModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl p-3 sm:p-5 md:p-6 max-w-md w-full`} onClick={(e) => e.stopPropagation()}>
              <h3 className={`text-xl sm:text-2xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-800'}`}>Confirmar Exclusão</h3>

              <p className={`mb-6 ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                Tem certeza que deseja excluir este item?
              </p>

              <div className="flex gap-3">
                <button
                  onClick={() => setShowDeleteConfirmModal(false)}
                  className={`flex-1 py-3 rounded-lg font-semibold ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                >
                  Cancelar
                </button>
                <button
                  onClick={handleConfirmDelete}
                  className="flex-1 bg-red-500 text-white py-3 rounded-lg hover:bg-red-600 font-semibold"
                >
                  Excluir
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Modal Dar Item para Pokémon */}
        {showGiveItemModal && selectedItemToGive && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowGiveItemModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl p-3 sm:p-5 md:p-6 max-w-md w-full`} onClick={(e) => e.stopPropagation()}>
              <h3 className={`text-xl sm:text-2xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                Dar Item - {selectedItemToGive.name}
              </h3>

              <p className={`mb-4 ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                {selectedItemToGive.description}
              </p>

              <div className="mb-4">
                <label className={`block mb-2 font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  Selecione o Pokémon
                </label>
                {mainTeam.length === 0 ? (
                  <p className={`text-center py-4 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                    Nenhum Pokémon no time principal
                  </p>
                ) : (
                  <select
                    value={selectedPokemonToReceiveItem || ''}
                    onChange={(e) => setSelectedPokemonToReceiveItem(e.target.value)}
                    className={`w-full p-3 rounded-lg ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-100 text-gray-800'}`}
                  >
                    <option value="">Escolha um Pokémon...</option>
                    {mainTeam.map((pokemon) => (
                      <option key={pokemon.id} value={pokemon.id}>
                        {pokemon.nickname} (Lv. {pokemon.level})
                        {pokemon.heldItem ? ` - Já tem: ${pokemon.heldItem.name}` : ''}
                      </option>
                    ))}
                  </select>
                )}
              </div>

              {selectedPokemonToReceiveItem && mainTeam.find(p => p.id == selectedPokemonToReceiveItem)?.heldItem && (
                <div className={`mb-4 p-3 rounded-lg ${darkMode ? 'bg-yellow-900/30 border border-yellow-600' : 'bg-yellow-50 border border-yellow-400'}`}>
                  <p className={`text-sm ${darkMode ? 'text-yellow-400' : 'text-yellow-700'}`}>
                    ⚠️ Este Pokémon já possui um item. O item atual será substituído.
                  </p>
                </div>
              )}

              <div className="flex gap-3">
                <button
                  onClick={() => {
                    setShowGiveItemModal(false)
                    setSelectedItemToGive(null)
                    setSelectedPokemonToReceiveItem(null)
                  }}
                  className={`flex-1 py-3 rounded-lg font-semibold ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                >
                  Cancelar
                </button>
                <button
                  onClick={handleGiveItemToPokemon}
                  disabled={mainTeam.length === 0}
                  className={`flex-1 py-3 rounded-lg font-semibold ${
                    mainTeam.length === 0
                      ? 'bg-gray-500 text-gray-300 cursor-not-allowed'
                      : 'bg-gradient-to-r from-green-600 to-teal-700 text-white hover:from-green-700 hover:to-teal-800'
                  }`}
                >
                  Dar Item
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Modal Editar Item Customizado */}
        {showEditCustomItemModal && selectedCustomItemForEdit !== null && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowEditCustomItemModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl p-3 sm:p-5 md:p-6 max-w-md w-full`} onClick={(e) => e.stopPropagation()}>
              <h3 className={`text-xl sm:text-2xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-800'}`}>Editar Item Customizado</h3>

              <div className="mb-4">
                <label className={`block mb-2 font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Nome do Item</label>
                <input
                  type="text"
                  value={editCustomItemName}
                  onChange={(e) => setEditCustomItemName(e.target.value)}
                  className={`w-full p-3 rounded-lg ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-100 text-gray-800'}`}
                  placeholder="Ex: Espada Mágica"
                />
              </div>

              <div className="mb-4">
                <label className={`block mb-2 font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Quantidade</label>
                <input
                  type="number"
                  min="1"
                  value={editCustomItemQuantity}
                  onChange={(e) => setEditCustomItemQuantity(parseInt(e.target.value) || 1)}
                  className={`w-full p-3 rounded-lg ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-100 text-gray-800'}`}
                />
              </div>

              <div className="mb-4">
                <label className={`block mb-2 font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Descrição</label>
                <textarea
                  value={editCustomItemDescription}
                  onChange={(e) => setEditCustomItemDescription(e.target.value)}
                  className={`w-full p-3 rounded-lg ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-100 text-gray-800'}`}
                  rows="3"
                  placeholder="Descreva o efeito do item..."
                />
              </div>

              <div className="flex gap-3">
                <button
                  onClick={() => {
                    setShowEditCustomItemModal(false)
                    setSelectedCustomItemForEdit(null)
                    setEditCustomItemName('')
                    setEditCustomItemQuantity(1)
                    setEditCustomItemDescription('')
                  }}
                  className={`flex-1 py-3 rounded-lg font-semibold ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                >
                  Cancelar
                </button>
                <button
                  onClick={handleSaveEditCustomItem}
                  className="flex-1 bg-gradient-to-r from-yellow-600 to-orange-700 text-white py-3 rounded-lg hover:from-yellow-700 hover:to-orange-800 font-semibold"
                >
                  Salvar
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Modal Pokémoedas */}
        {showPokemonedasModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowPokemonedasModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl p-3 sm:p-5 md:p-6 max-w-md w-full`} onClick={(e) => e.stopPropagation()}>
              <h3 className={`text-xl sm:text-2xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                Gerenciar Pokémoedas
              </h3>

              <div className="mb-2">
                <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-4`}>
                  Saldo atual: <span className={`font-bold ${darkMode ? 'text-yellow-400' : 'text-yellow-600'}`}>₽{pokemonedas.toLocaleString()}</span>
                </p>
              </div>

              <div className="mb-6">
                <label className={`block mb-2 font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Valor</label>
                <input
                  type="number"
                  min="0"
                  value={pokemonedasValue}
                  onChange={(e) => setPokemonedasValue(e.target.value)}
                  className={`w-full p-3 rounded-lg ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-100 text-gray-800'}`}
                  placeholder="Digite o valor..."
                />
              </div>

              <div className="flex gap-3 mb-3">
                <button
                  onClick={handlePerdeuPokemonedas}
                  className="flex-1 bg-red-500 text-white py-3 rounded-lg hover:bg-red-600 font-semibold"
                  title="Subtrair valor do saldo atual"
                >
                  Perdeu
                </button>
                <button
                  onClick={handleSaldoPokemonedas}
                  className="flex-1 bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 font-semibold"
                  title="Definir como novo saldo"
                >
                  Saldo
                </button>
                <button
                  onClick={handleAcheiPokemonedas}
                  className="flex-1 bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 font-semibold"
                  title="Adicionar valor ao saldo atual"
                >
                  Achei
                </button>
              </div>

              <button
                onClick={() => {
                  setShowPokemonedasModal(false)
                  setPokemonedasValue('')
                }}
                className={`w-full py-3 rounded-lg font-semibold ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
              >
                Cancelar
              </button>
            </div>
          </div>
        )}

        {/* Modal Pokecaixinha - Depositar */}
        {showPokecaixinhaModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowPokecaixinhaModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl p-3 sm:p-5 md:p-6 max-w-md w-full`} onClick={(e) => e.stopPropagation()}>
              <div className="flex items-center gap-3 mb-4">
                <img src="/pokecofrinho.png" alt="Pokecaixinha" className="w-12 h-12" />
                <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-yellow-400' : 'text-yellow-600'}`}>
                  Pokecaixinha
                </h3>
              </div>

              <div className="mb-4">
                <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-2`}>
                  Saldo atual: <span className={`font-bold ${darkMode ? 'text-yellow-400' : 'text-yellow-600'}`}>₽{pokemonedas.toLocaleString()}</span>
                </p>
                <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                  Na Pokecaixinha: <span className={`font-bold ${darkMode ? 'text-green-400' : 'text-green-600'}`}>₽{pokecaixinha.toLocaleString()}</span>
                </p>
              </div>

              <div className="mb-6">
                <label className={`block mb-2 font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  Quanto deseja depositar?
                </label>
                <input
                  type="number"
                  min="0"
                  max={pokemonedas}
                  value={pokecaixinhaDepositValue}
                  onChange={(e) => setPokecaixinhaDepositValue(e.target.value)}
                  className={`w-full p-3 rounded-lg ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-100 text-gray-800'}`}
                  placeholder="Digite o valor..."
                />
              </div>

              <div className="flex gap-3">
                <button
                  onClick={() => {
                    const value = parseInt(pokecaixinhaDepositValue)
                    if (isNaN(value) || value <= 0) {
                      alert('Digite um valor válido!')
                      return
                    }
                    if (value > pokemonedas) {
                      alert('Você não tem Pokémoedas suficientes!')
                      return
                    }

                    setPokemonedas(prev => prev - value)
                    setPokecaixinha(prev => prev + value)

                    if (useFirebase) {
                      saveTrainerData(currentUser.username, {
                        ...currentUser,
                        pokemonedas: pokemonedas - value,
                        pokecaixinha: pokecaixinha + value
                      })
                    }

                    setShowPokecaixinhaModal(false)
                    setPokecaixinhaDepositValue('')
                    alert(`Você depositou ₽${value.toLocaleString()} na Pokecaixinha!`)
                  }}
                  className="flex-1 bg-gradient-to-r from-yellow-600 to-orange-600 text-white py-3 rounded-lg hover:from-yellow-700 hover:to-orange-700 font-semibold"
                >
                  Depositar
                </button>
                <button
                  onClick={() => {
                    setShowPokecaixinhaModal(false)
                    setPokecaixinhaDepositValue('')
                  }}
                  className={`flex-1 py-3 rounded-lg font-semibold ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                >
                  Cancelar
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Modal Revelar Fotografia */}
        {showFotografiaModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => { setShowFotografiaModal(false); setFotografiaNome(''); setFotografiaUrl(''); setFotografiaPreco(''); setEditingFotografiaId(null) }}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl p-3 sm:p-5 md:p-6 max-w-lg w-full`} onClick={e => e.stopPropagation()}>
              <h3 className={`text-xl sm:text-2xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-800'}`}>{editingFotografiaId ? 'Editar Fotografia' : 'Revelar Fotografia'}</h3>

              <label className={`block text-sm font-semibold mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>Nome</label>
              <input type="text" value={fotografiaNome} onChange={e => setFotografiaNome(e.target.value)}
                placeholder="Nome da fotografia"
                className={`w-full p-3 rounded-lg mb-4 ${darkMode ? 'bg-gray-700 text-white placeholder-gray-500' : 'bg-gray-100 text-gray-800 placeholder-gray-400'}`} />

              <label className={`block text-sm font-semibold mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>Link da Imagem</label>
              <input type="text" value={fotografiaUrl} onChange={e => setFotografiaUrl(e.target.value)}
                placeholder="https://exemplo.com/imagem.png"
                className={`w-full p-3 rounded-lg mb-4 ${darkMode ? 'bg-gray-700 text-white placeholder-gray-500' : 'bg-gray-100 text-gray-800 placeholder-gray-400'}`} />

              <label className={`block text-sm font-semibold mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>Preço em ₽</label>
              <input type="number" value={fotografiaPreco} onChange={e => setFotografiaPreco(e.target.value)}
                placeholder="0"
                className={`w-full p-3 rounded-lg mb-4 ${darkMode ? 'bg-gray-700 text-white placeholder-gray-500' : 'bg-gray-100 text-gray-800 placeholder-gray-400'}`} />

              {fotografiaUrl && (
                <div className="mb-4">
                  <p className={`text-sm font-semibold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>Pré-visualização:</p>
                  <div className="relative mx-auto" style={{ width: '280px', aspectRatio: '4/3' }}>
                    <img src={fotografiaUrl} alt="Preview" className="absolute inset-0 w-full h-full object-cover" style={{ padding: '6%', paddingBottom: '18%' }} />
                    <img src="/fotografiatemplate.png" alt="" className="absolute inset-0 w-full h-full object-fill pointer-events-none" />
                  </div>
                </div>
              )}

              <div className="flex gap-3">
                <button onClick={async () => {
                  if (!fotografiaUrl.trim()) return
                  let updated
                  if (editingFotografiaId) {
                    updated = fotografias.map(f => f.id === editingFotografiaId ? { ...f, nome: fotografiaNome.trim(), url: fotografiaUrl.trim(), preco: fotografiaPreco || '0' } : f)
                  } else {
                    updated = [...fotografias, { id: Date.now(), nome: fotografiaNome.trim(), url: fotografiaUrl.trim(), preco: fotografiaPreco || '0' }]
                  }
                  setFotografias(updated)
                  if (useFirebase && currentUser) {
                    await set(ref(database, `trainers/${currentUser.username}/fotografias`), updated)
                  }
                  setFotografiaNome('')
                  setFotografiaUrl('')
                  setFotografiaPreco('')
                  setEditingFotografiaId(null)
                  setShowFotografiaModal(false)
                }}
                  className={`flex-1 py-3 rounded-lg font-semibold ${fotografiaUrl.trim() ? 'bg-gradient-to-r from-amber-500 to-yellow-600 text-white hover:from-amber-600 hover:to-yellow-700' : 'bg-gray-400 text-gray-200 cursor-not-allowed'}`}
                  disabled={!fotografiaUrl.trim()}>
                  {editingFotografiaId ? 'Salvar' : 'Revelar'}
                </button>
                <button onClick={() => { setShowFotografiaModal(false); setFotografiaNome(''); setFotografiaUrl(''); setFotografiaPreco(''); setEditingFotografiaId(null) }}
                  className={`flex-1 py-3 rounded-lg font-semibold ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}>
                  Cancelar
                </button>
              </div>
            </div>
          </div>
        )}

        </div>
        {accountDataModal}
        {scenarioPopupOverlay}
        {mostrarTriunfosOverlay}
        {pokezapPanel}{pokeAgendaPanel}
        {batalhaChatPanel}

        {/* Modal Fazer Puffin */}
        {showFazerPuffinModal && (() => {
          const frutasNaMochila = keyItems.filter(item =>
            POKELOJA_DATA['Frutas']?.find(f => f.name === item.name)
          )
          const usedCounts = {}
          puffinSlots.forEach(s => { if (s) usedCounts[s] = (usedCounts[s] || 0) + 1 })
          const getAvailableQty = (fruitName) => {
            const inMochila = frutasNaMochila.find(i => i.name === fruitName)?.quantity || 0
            return inMochila - (usedCounts[fruitName] || 0)
          }

          // Preview do puffin em tempo real
          const first5 = puffinSlots.slice(0, 5).filter(s => s !== null)
          const flavorCounts = {}
          first5.forEach(fruitName => {
            getFruitFlavors(fruitName).forEach(f => { flavorCounts[f] = (flavorCounts[f] || 0) + 1 })
          })
          let puffinPreview = null
          if (Object.keys(flavorCounts).length > 0) {
            const maxCount = Math.max(...Object.values(flavorCounts))
            const topFlavors = Object.keys(flavorCounts).filter(f => flavorCounts[f] === maxCount)
            const primaryFlavor = topFlavors[0]
            const secondaryFlavor = topFlavors.length >= 2 ? topFlavors[1] : null
            let baseName = `Puffin ${primaryFlavor}`
            if (secondaryFlavor) baseName += ` / ${secondaryFlavor}`
            const extraSlots = puffinSlots.slice(5).filter(s => s !== null)
            let aromaHint = null
            if (extraSlots.length > 0) {
              const totalCounts = { ...flavorCounts }
              extraSlots.forEach(fn => { getFruitFlavors(fn).forEach(f => { totalCounts[f] = (totalCounts[f] || 0) + 1 }) })
              const totalMax = Math.max(...Object.values(totalCounts))
              const totalTop = Object.keys(totalCounts).filter(f => totalCounts[f] === totalMax)
              if (!totalTop.includes(primaryFlavor)) aromaHint = totalTop.join(' / ')
            }
            puffinPreview = `${baseName}${aromaHint ? ` (${aromaHint})` : ''} ${maxCount}`
          }

          const filledCount = puffinSlots.filter(s => s !== null).length
          return (
            <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-2 sm:p-4" onClick={() => setShowFazerPuffinModal(false)}>
              <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl p-4 sm:p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto`} onClick={(e) => e.stopPropagation()}>
                {/* Header */}
                <div className="flex items-center gap-3 mb-5">
                  <img src="/miniiconefazerpuffin.png" alt="Puffin" className="w-10 h-10 object-contain" onError={(e) => { e.target.style.display='none' }} />
                  <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-pink-300' : 'text-pink-700'}`}>Fazer Puffin</h3>
                  <button onClick={() => setShowFazerPuffinModal(false)} className={`ml-auto p-1.5 rounded-lg ${darkMode ? 'hover:bg-gray-700 text-gray-400' : 'hover:bg-gray-200 text-gray-600'}`}>✕</button>
                </div>

                {/* Slots de frutas */}
                <div className="mb-5">
                  <div className="flex items-center justify-between mb-2">
                    <h4 className={`font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                      Frutas ({filledCount}/{puffinSlots.length})
                      <span className={`ml-2 text-xs font-normal ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>— 1ª a 5ª definem o sabor · extras definem o aroma</span>
                    </h4>
                    <button
                      onClick={() => setPuffinSlots([...puffinSlots, null])}
                      className="text-xs bg-pink-600 hover:bg-pink-700 text-white px-2 py-1 rounded-lg font-semibold"
                    >+ Slot</button>
                  </div>
                  <div className="flex flex-wrap gap-2">
                    {puffinSlots.map((slot, idx) => (
                      <div key={idx} className="relative">
                        <button
                          onClick={() => setPuffinSlotDropdown(puffinSlotDropdown === idx ? null : idx)}
                          className={`flex flex-col items-center px-3 py-2 rounded-lg border-2 text-sm font-semibold min-w-[80px] transition-all ${
                            slot
                              ? (darkMode ? 'bg-pink-900 border-pink-600 text-white' : 'bg-pink-100 border-pink-400 text-pink-900')
                              : (darkMode ? 'bg-gray-700 border-gray-600 text-gray-400' : 'bg-gray-100 border-gray-300 text-gray-400')
                          }`}
                        >
                          <span className={`text-[10px] mb-1 ${idx >= 5 ? 'text-purple-400' : 'text-gray-400'}`}>
                            #{idx + 1}{idx >= 5 ? ' 🌸' : ''}
                          </span>
                          {slot ? (
                            <>
                              <img src={getItemImage(slot)} alt={slot} className="w-8 h-8 object-contain mb-1" onError={(e) => { e.target.style.display='none' }} />
                              <span className="text-[10px] text-center leading-tight">{slot}</span>
                              <div className="flex gap-0.5 mt-1 flex-wrap justify-center">
                                {getFruitFlavors(slot).map(f => (
                                  <span key={f} className={`text-[10px] font-bold ${FLAVOR_ABBR[f]?.color || ''}`}>
                                    {FLAVOR_ABBR[f]?.abbr || f}
                                  </span>
                                ))}
                              </div>
                            </>
                          ) : (
                            <span className="text-xs mt-1">+ Fruta</span>
                          )}
                        </button>
                        {/* Dropdown de frutas */}
                        {puffinSlotDropdown === idx && (
                          <div
                            className={`absolute top-full left-0 mt-1 z-20 rounded-xl shadow-2xl border ${darkMode ? 'bg-gray-800 border-gray-600' : 'bg-white border-gray-200'} max-h-60 overflow-y-auto min-w-[160px]`}
                            onClick={e => e.stopPropagation()}
                          >
                            {slot && (
                              <button
                                onClick={() => { setPuffinSlots(puffinSlots.map((s, i) => i === idx ? null : s)); setPuffinSlotDropdown(null) }}
                                className={`w-full text-left px-3 py-2 text-sm font-semibold text-red-500 ${darkMode ? 'hover:bg-red-900/30' : 'hover:bg-red-50'}`}
                              >✕ Remover</button>
                            )}
                            {frutasNaMochila.length === 0 ? (
                              <p className={`px-3 py-2 text-sm ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Nenhuma fruta na mochila</p>
                            ) : frutasNaMochila.map(item => {
                              const available = getAvailableQty(item.name)
                              const flavors = getFruitFlavors(item.name)
                              return (
                                <button
                                  key={item.name}
                                  onClick={() => {
                                    if (available > 0) {
                                      setPuffinSlots(puffinSlots.map((s, i) => i === idx ? item.name : s))
                                      setPuffinSlotDropdown(null)
                                    }
                                  }}
                                  disabled={available <= 0}
                                  className={`w-full text-left px-3 py-2 flex items-center gap-2 ${available > 0 ? (darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-100') : 'opacity-40 cursor-not-allowed'}`}
                                >
                                  <img src={getItemImage(item.name)} alt={item.name} className="w-7 h-7 object-contain flex-shrink-0" onError={(e) => { e.target.style.display='none' }} />
                                  <div className="flex-1 min-w-0">
                                    <div className={`text-xs font-semibold truncate ${darkMode ? 'text-white' : 'text-gray-800'}`}>{item.name}</div>
                                    <div className="flex gap-0.5 flex-wrap">
                                      {flavors.map(f => (
                                        <span key={f} className={`text-[10px] font-bold ${FLAVOR_ABBR[f]?.color || ''}`}>{FLAVOR_ABBR[f]?.abbr || f}</span>
                                      ))}
                                    </div>
                                  </div>
                                  <span className={`text-xs flex-shrink-0 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>x{available}</span>
                                </button>
                              )
                            })}
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                </div>

                {/* Preview */}
                {puffinPreview && (
                  <div className={`mb-4 p-3 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-50'} border ${darkMode ? 'border-gray-600' : 'border-gray-200'}`}>
                    <p className={`text-sm font-semibold ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      Puffin previsto: <span className={`font-bold ${darkMode ? 'text-pink-300' : 'text-pink-700'}`}>{puffinPreview}</span>
                    </p>
                    <p className={`text-xs mt-1 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>* Empates entre sabores são resolvidos aleatoriamente na criação.</p>
                  </div>
                )}

                {/* Botões */}
                <div className="flex gap-3">
                  <button onClick={() => setShowFazerPuffinModal(false)} className={`flex-1 py-3 rounded-xl font-semibold ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-800'}`}>Cancelar</button>
                  <button
                    onClick={handleCriarPuffin}
                    disabled={filledCount === 0}
                    className={`flex-1 px-6 py-3 rounded-xl font-bold text-white transition-all ${filledCount > 0 ? 'bg-gradient-to-r from-pink-600 to-purple-600 hover:from-pink-700 hover:to-purple-700 shadow-lg' : 'bg-gray-400 cursor-not-allowed'}`}
                  >
                    🐦 Criar Puffin
                  </button>
                </div>
              </div>
            </div>
          )
        })()}

        {/* Modal Snack (puffins → aptidões) */}
        {showSnackModal && (() => {
          const APTIDAO_INFO = [
            { key: 'estilo', label: 'Estilo', bg: darkMode ? 'bg-red-900' : 'bg-red-100', text: darkMode ? 'text-red-300' : 'text-red-700' },
            { key: 'beleza', label: 'Beleza', bg: darkMode ? 'bg-blue-900' : 'bg-blue-100', text: darkMode ? 'text-blue-300' : 'text-blue-700' },
            { key: 'ternura', label: 'Ternura', bg: darkMode ? 'bg-pink-900' : 'bg-pink-100', text: darkMode ? 'text-pink-300' : 'text-pink-700' },
            { key: 'perspicacia', label: 'Perspicácia', bg: darkMode ? 'bg-green-900' : 'bg-green-100', text: darkMode ? 'text-green-300' : 'text-green-700' },
            { key: 'vigor', label: 'Vigor', bg: darkMode ? 'bg-yellow-900' : 'bg-yellow-100', text: darkMode ? 'text-yellow-300' : 'text-yellow-700' },
          ]
          const puffinsNaMochila = keyItems.filter(item => item.name.startsWith('Puffin '))
          return (
            <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-2 sm:p-4" onClick={() => { setShowSnackModal(false); setSnackDropdownPokemon(null) }}>
              <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl p-4 sm:p-6 max-w-5xl w-full max-h-[90vh] overflow-y-auto`} onClick={(e) => e.stopPropagation()}>
                {/* Header */}
                <div className="flex items-center gap-3 mb-5">
                  <img src="/minibittenpuffin.png" alt="Snack" className="w-10 h-10 object-contain" onError={(e) => { e.target.style.display='none' }} />
                  <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-pink-300' : 'text-pink-700'}`}>Snack</h3>
                  <button onClick={() => { setShowSnackModal(false); setSnackDropdownPokemon(null) }} className={`ml-auto p-1.5 rounded-lg ${darkMode ? 'hover:bg-gray-700 text-gray-400' : 'hover:bg-gray-200 text-gray-600'}`}>✕</button>
                </div>

                {puffinsNaMochila.length === 0 && (
                  <p className={`text-center py-6 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Você não tem nenhum Puffin na mochila.</p>
                )}

                {mainTeam.filter(p => p && p.species).length === 0 && (
                  <p className={`text-center py-6 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Nenhum Pokémon no time principal.</p>
                )}

                {/* Grid de Pokémon */}
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                  {mainTeam.map((pokemon, idx) => {
                    if (!pokemon || !pokemon.species) return null
                    const consumed = pokemon.puffinsConsumed || 0
                    const aptidoes = { estilo: 0, beleza: 0, ternura: 0, perspicacia: 0, vigor: 0, ...(pokemon.aptidoes || {}) }
                    const nature = natures.find(n => n.nome === pokemon.nature)
                    const favFlavor = pokemon.favoriteFlavor || nature?.gosto || 'Nenhum'
                    const dislikeFlavor = pokemon.dislikedFlavor || nature?.desgosto || 'Nenhum'
                    const isDropdownOpen = snackDropdownPokemon === idx
                    return (
                      <div key={idx} className={`rounded-xl p-3 border ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-gray-50 border-gray-200'}`}>
                        {/* Nome do Pokémon */}
                        <div className="flex items-center gap-2 mb-2">
                          <span className={`font-bold text-sm truncate ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                            {pokemon.nickname || pokemon.species}
                          </span>
                          {pokemon.nickname && <span className={`text-xs truncate ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>({pokemon.species})</span>}
                        </div>

                        {/* Gostos */}
                        <div className={`text-xs mb-2 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                          {favFlavor !== 'Nenhum' && <span className="mr-2">❤️ {favFlavor}</span>}
                          {dislikeFlavor !== 'Nenhum' && <span>💔 {dislikeFlavor}</span>}
                          {favFlavor === 'Nenhum' && dislikeFlavor === 'Nenhum' && <span>Sabores neutros</span>}
                        </div>

                        {/* Aptidões */}
                        <div className="flex gap-1 flex-wrap mb-3">
                          {APTIDAO_INFO.map(apt => (
                            <div key={apt.key} className={`text-center px-2 py-1 rounded ${apt.bg}`}>
                              <div className={`text-xs font-semibold ${apt.text}`}>{apt.label}</div>
                              <div className={`text-sm font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{aptidoes[apt.key]}</div>
                            </div>
                          ))}
                        </div>

                        {/* Contador de puffins consumidos */}
                        <div className={`text-xs mb-3 flex items-center gap-1 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                          <img src="/minibittenpuffin.png" alt="" className="w-4 h-4 object-contain" onError={(e) => e.target.style.display='none'} />
                          <span>{consumed}/5 puffins consumidos</span>
                        </div>

                        {/* Seletor de Puffin */}
                        {consumed >= 5 ? (
                          <div className={`text-xs text-center py-2 rounded-lg font-semibold ${darkMode ? 'bg-gray-600 text-gray-400' : 'bg-gray-200 text-gray-500'}`}>Limite atingido</div>
                        ) : puffinsNaMochila.length === 0 ? (
                          <div className={`text-xs text-center py-2 rounded-lg ${darkMode ? 'bg-gray-600 text-gray-400' : 'bg-gray-200 text-gray-500'}`}>Sem puffins</div>
                        ) : (
                          <div className="relative">
                            <button
                              onClick={() => setSnackDropdownPokemon(isDropdownOpen ? null : idx)}
                              className={`w-full px-3 py-2 rounded-lg text-sm font-semibold text-left flex items-center justify-between ${darkMode ? 'bg-pink-700 hover:bg-pink-600 text-white' : 'bg-pink-100 hover:bg-pink-200 text-pink-800'}`}
                            >
                              <span>Dar Puffin</span>
                              <span>{isDropdownOpen ? '▲' : '▼'}</span>
                            </button>
                            {isDropdownOpen && (
                              <div className={`absolute left-0 right-0 top-full mt-1 rounded-xl shadow-xl border z-20 max-h-64 overflow-y-auto ${darkMode ? 'bg-gray-800 border-gray-600' : 'bg-white border-gray-200'}`}>
                                {puffinsNaMochila.map((puffin, pIdx) => {
                                  const gains = calculateSnackGains(puffin.name, pokemon)
                                  const gainEntries = Object.entries(gains).filter(([, v]) => v > 0)
                                  return (
                                    <button
                                      key={pIdx}
                                      onClick={() => handleFeedSnack(idx, puffin.name)}
                                      className={`w-full px-3 py-2 text-left hover:${darkMode ? 'bg-gray-700' : 'bg-pink-50'} transition-colors border-b last:border-b-0 ${darkMode ? 'border-gray-700' : 'border-gray-100'}`}
                                    >
                                      <div className={`text-sm font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                        {puffin.name} <span className={`text-xs font-normal ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>×{puffin.quantity}</span>
                                      </div>
                                      <div className="flex gap-1 mt-1 flex-wrap">
                                        {gainEntries.length === 0 ? (
                                          <span className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>+0 aptidões</span>
                                        ) : gainEntries.map(([key, val]) => {
                                          const info = APTIDAO_INFO.find(a => a.key === key)
                                          return (
                                            <span key={key} className={`text-xs px-1.5 py-0.5 rounded font-bold ${info?.bg} ${info?.text}`}>
                                              +{val} {info?.label}
                                            </span>
                                          )
                                        })}
                                      </div>
                                    </button>
                                  )
                                })}
                              </div>
                            )}
                          </div>
                        )}
                      </div>
                    )
                  })}
                </div>

                <div className="mt-5 flex justify-end">
                  <button onClick={() => { setShowSnackModal(false); setSnackDropdownPokemon(null) }} className={`px-6 py-2.5 rounded-xl font-semibold ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-800'}`}>Fechar</button>
                </div>
              </div>
            </div>
          )
        })()}

        {/* Modal Pokesuco */}
        {showPokesucoModal && (() => {
          const apricornsNaMochila = keyItems.filter(item => APRICORN_COLOR_MAP[item.name])
          const showIntensificar = shouldShowIntensificar(pokesucoSlots)
          const showDominante = shouldShowDominante(pokesucoSlots)
          const intensificarColors = getIntensificarColors(pokesucoSlots)
          const dominanteColors = getDominanteColors(pokesucoSlots)
          const filledSlotsCount = pokesucoSlots.filter(s => s !== null).length
          const canMixer = filledSlotsCount > 0 &&
            (!showIntensificar || pokesucoIntensificar) &&
            (!showDominante || pokesucoDominante)

          return (
            <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-2 sm:p-4" onClick={() => setShowPokesucoModal(false)}>
              <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl p-4 sm:p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto`} onClick={(e) => e.stopPropagation()}>
                {/* Header */}
                <div className="flex items-center gap-3 mb-5">
                  <img src="/pokesuco/miniiconepokesuco.png" alt="Pokesuco" className="w-10 h-10 object-contain" onError={(e) => { e.target.style.display='none' }} />
                  <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-purple-300' : 'text-purple-700'}`}>Fazer Pokesuco</h3>
                  <button onClick={() => setShowPokesucoModal(false)} className={`ml-auto p-1.5 rounded-lg ${darkMode ? 'hover:bg-gray-700 text-gray-400' : 'hover:bg-gray-200 text-gray-600'}`}>✕</button>
                </div>

                {/* Slots selecionados */}
                <div className="mb-4">
                  <div className="flex items-center justify-between mb-2">
                    <h4 className={`font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Ingredientes ({filledSlotsCount}/{pokesucoSlots.length})</h4>
                    <button
                      onClick={() => setPokesucoSlots([...pokesucoSlots, null])}
                      className="text-xs bg-purple-600 hover:bg-purple-700 text-white px-2 py-1 rounded-lg font-semibold"
                    >+ Slot</button>
                  </div>
                  <div className="flex flex-wrap gap-2">
                    {pokesucoSlots.map((slot, idx) => (
                      <div key={idx} className={`flex items-center gap-1.5 px-3 py-2 rounded-lg border-2 text-sm font-semibold ${slot ? (darkMode ? 'bg-purple-900 border-purple-600 text-white' : 'bg-purple-100 border-purple-400 text-purple-900') : (darkMode ? 'bg-gray-700 border-gray-600 text-gray-400' : 'bg-gray-100 border-gray-300 text-gray-400')}`}>
                        <span className="text-xs text-gray-400">#{idx + 1}</span>
                        {slot ? (
                          <>
                            <img src={getItemImage(slot)} alt={slot} className="w-6 h-6 object-contain" onError={(e) => { e.target.style.display='none' }} />
                            <span>{slot.replace('Apricorn ', '')}</span>
                            <button onClick={() => handleRemoveApricornFromSlot(idx)} className="text-red-400 hover:text-red-600 ml-1 text-xs">✕</button>
                          </>
                        ) : (
                          <span>Vazio</span>
                        )}
                      </div>
                    ))}
                  </div>
                </div>

                {/* Campo Intensificar */}
                {showIntensificar && (
                  <div className={`mb-4 p-3 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-purple-50'} border ${darkMode ? 'border-purple-700' : 'border-purple-200'}`}>
                    <h4 className={`font-bold mb-2 ${darkMode ? 'text-purple-300' : 'text-purple-700'}`}>Intensificar (Apricorn Preto detectado)</h4>
                    <p className={`text-xs mb-3 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Selecione a cor predominante do suco:</p>
                    <div className="flex flex-wrap gap-2">
                      {intensificarColors.map(color => (
                        <button
                          key={color}
                          onClick={() => setPokesucoIntensificar(pokesucoIntensificar === color ? null : color)}
                          className={`px-3 py-1.5 rounded-lg text-sm font-semibold border-2 transition-all ${pokesucoIntensificar === color ? 'bg-purple-600 border-purple-700 text-white' : (darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'bg-white border-gray-300 text-gray-800')}`}
                        >{color}</button>
                      ))}
                    </div>
                  </div>
                )}

                {/* Campo Dominante */}
                {showDominante && (
                  <div className={`mb-4 p-3 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-blue-50'} border ${darkMode ? 'border-blue-700' : 'border-blue-200'}`}>
                    <h4 className={`font-bold mb-2 ${darkMode ? 'text-blue-300' : 'text-blue-700'}`}>Dominante</h4>
                    <p className={`text-xs mb-3 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Selecione a cor que dará o nome ao suco:</p>
                    <div className="flex flex-wrap gap-2">
                      {dominanteColors.map(color => (
                        <button
                          key={color}
                          onClick={() => setPokesucoDominante(pokesucoDominante === color ? null : color)}
                          className={`px-3 py-1.5 rounded-lg text-sm font-semibold border-2 transition-all ${pokesucoDominante === color ? 'bg-blue-600 border-blue-700 text-white' : (darkMode ? 'bg-gray-600 border-gray-500 text-white' : 'bg-white border-gray-300 text-gray-800')}`}
                        >{color}</button>
                      ))}
                    </div>
                  </div>
                )}

                {/* Modificador de Suco */}
                <div className="mb-4">
                  <label className={`block font-bold mb-2 ${darkMode ? 'text-white' : 'text-gray-800'}`}>Modificador de Suco</label>
                  <div className="flex items-center gap-3">
                    <button onClick={() => setPokesucoModificador(Math.max(0, pokesucoModificador - 1))} className={`w-8 h-8 rounded-lg font-bold ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-800'}`}>-</button>
                    <span className={`text-2xl font-bold w-10 text-center ${darkMode ? 'text-purple-300' : 'text-purple-700'}`}>{pokesucoModificador}</span>
                    <button onClick={() => setPokesucoModificador(Math.min(3, pokesucoModificador + 1))} className={`w-8 h-8 rounded-lg font-bold ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-800'}`}>+</button>
                    <span className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>(0–3) • Rola 1d4 + {pokesucoModificador}</span>
                  </div>
                </div>

                {/* Apricorns disponíveis */}
                <div className="mb-5">
                  <h4 className={`font-bold mb-3 ${darkMode ? 'text-white' : 'text-gray-800'}`}>Apricorns na Mochila</h4>
                  {apricornsNaMochila.length === 0 ? (
                    <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Nenhum Apricorn na mochila.</p>
                  ) : (
                    <div className="grid grid-cols-3 sm:grid-cols-4 gap-2">
                      {apricornsNaMochila.map((apricorn) => {
                        const check = canAddApricorn(apricorn.name, pokesucoSlots)
                        return (
                          <div key={apricorn.name} className={`flex flex-col items-center p-2 rounded-lg border-2 ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-gray-50 border-gray-300'}`}>
                            <span className={`text-xs font-bold mb-1 ${darkMode ? 'text-yellow-400' : 'text-yellow-600'}`}>x{apricorn.quantity}</span>
                            <img src={getItemImage(apricorn.name)} alt={apricorn.name} className="w-10 h-10 object-contain mb-1" onError={(e) => { e.target.style.display='none' }} />
                            <span className={`text-[10px] text-center mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>{apricorn.name.replace('Apricorn ', '')}</span>
                            <button
                              onClick={() => handleAddApricornToSlot(apricorn.name)}
                              disabled={!check.ok || apricorn.quantity === 0}
                              className={`w-full py-1 rounded text-xs font-semibold transition-all ${!check.ok || apricorn.quantity === 0 ? 'bg-gray-400 text-gray-600 cursor-not-allowed' : 'bg-purple-600 hover:bg-purple-700 text-white'}`}
                              title={!check.ok ? check.reason : 'Adicionar ao suco'}
                            >
                              {check.ok ? 'Adicionar' : '✕'}
                            </button>
                          </div>
                        )
                      })}
                    </div>
                  )}
                </div>

                {/* Preview do suco */}
                {filledSlotsCount > 0 && (
                  <div className={`mb-4 p-3 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-50'} border ${darkMode ? 'border-gray-600' : 'border-gray-200'}`}>
                    <p className={`text-sm font-semibold ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      Suco previsto: <span className={`${darkMode ? 'text-purple-300' : 'text-purple-700'} font-bold`}>
                        {(() => { try { return calcPokesucoInfo(pokesucoSlots, pokesucoIntensificar, pokesucoDominante).sucoNome + ' [qualidade]' } catch { return '...' } })()}
                      </span>
                    </p>
                  </div>
                )}

                {/* Botão Mexer o Suco */}
                <div className="flex gap-3">
                  <button onClick={() => setShowPokesucoModal(false)} className={`flex-1 py-3 rounded-xl font-semibold ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-800'}`}>Cancelar</button>
                  <button
                    onClick={handleMexerSuco}
                    disabled={!canMixer}
                    className={`flex-2 px-6 py-3 rounded-xl font-bold text-white transition-all ${canMixer ? 'bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 shadow-lg' : 'bg-gray-400 cursor-not-allowed'}`}
                  >
                    🧃 Mexer o Suco
                  </button>
                </div>
              </div>
            </div>
          )
        })()}
      </>
    )
  }

  // ÁREA DA POKÉLOJA
  if (currentUser.type === 'treinador' && currentArea === 'Pokéloja') {
    // Itens ocultos são carregados do estado hiddenPokelojaItems que é sincronizado com Firebase
    const hiddenItems = hiddenPokelojaItems || []

    return (
      <>
        <div className={`min-h-screen ${mainBgClass}`}>
          {sidebarNav}
        <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-lg`}>
          <div className="max-w-7xl mx-auto px-4 py-4">
            <div className="flex justify-between items-center mb-4">
              <div className="flex items-center gap-2 sm:gap-3 md:gap-4">
                <button onClick={() => setSidebarOpen(true)} className={`p-2 rounded-lg ${darkMode ? 'hover:bg-gray-700 text-gray-400' : 'hover:bg-gray-200 text-gray-500'}`}><Menu size={24} /></button>
                <h2 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>PokéLoja</h2>
                <span className={`text-lg sm:text-xl font-bold ${darkMode ? 'text-yellow-400' : 'text-yellow-600'}`}>
                  ₽{pokemonedas.toLocaleString()}
                </span>
              </div>
              <div className="flex gap-2 items-center">
                <button onClick={() => setDarkMode(!darkMode)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-yellow-400' : 'bg-gray-200 text-gray-700'}`}>
                  {darkMode ? <Sun size={20} /> : <Moon size={20} />}
                </button>
                {pokezapBtn}{pokeAgendaBtn}{batalhaChatBtn}<button onClick={handleLogout} className="bg-red-500 text-white px-3 sm:px-5 md:px-6 py-2 rounded-lg hover:bg-red-600">Sair</button>
                {currentClima && <div className="flex items-center gap-1.5 ml-1"><img src={`/pokeballs/${currentClima.image}`} alt={currentClima.name} className="w-7 h-7" /><span className={`text-xs font-semibold ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>{currentClima.name}</span></div>}
              </div>
            </div>
          </div>
        </div>

        <div className="max-w-7xl mx-auto px-4 py-3 sm:py-5 md:py-8">
          {Object.entries(POKELOJA_DATA).map(([corredor, items]) => {
            // Corredores sempre ocultos nunca aparecem na loja
            if (CORREDORES_SEMPRE_OCULTOS.includes(corredor)) return null

            // Corredor de Pokesucos tem renderização especial
            if (corredor === 'Pokesucos') {
              return (
                <div key={corredor} className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl mb-6 overflow-hidden`}>
                  <button
                    onClick={() => toggleCorredor(corredor)}
                    className={`w-full p-3 sm:p-5 md:p-6 flex justify-between items-center ${darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-50'} transition-colors`}
                  >
                    <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>🧃 {corredor}</h3>
                    {expandedCorredores[corredor] ? <ChevronDown size={24} className={darkMode ? 'text-white' : 'text-gray-800'} /> : <ChevronRight size={24} className={darkMode ? 'text-white' : 'text-gray-800'} />}
                  </button>
                  {expandedCorredores[corredor] && (
                    <div className="p-3 sm:p-5 md:p-6 pt-0">
                      <div className="flex items-center justify-between mb-4">
                        <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                          {Object.keys(pokesucoLojaQualidades).length > 0 ? 'Qualidades sorteadas!' : 'Clique para sortear as qualidades de hoje.'}
                        </p>
                        <button
                          onClick={handleSortearQualidadeLoja}
                          className="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white px-4 py-2 rounded-lg font-semibold text-sm shadow"
                        >
                          🎲 Sortear Qualidade
                        </button>
                      </div>
                      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3">
                        {items.map((item, idx) => {
                          const quality = pokesucoLojaQualidades[item.sucoColor] || null
                          const price = quality ? quality * 150 : null
                          return (
                            <div key={idx} className={`p-3 rounded-lg border-2 ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-gray-50 border-gray-300'} flex flex-col`}>
                              <div className="w-full h-20 mb-2 flex items-center justify-center">
                                <img src={item.image} alt={item.name} className="max-w-full max-h-full object-contain" onError={(e) => { e.target.style.display = 'none' }} />
                              </div>
                              <h4 className={`font-bold text-base mb-1 text-center ${darkMode ? 'text-white' : 'text-gray-800'}`}>{item.name}</h4>
                              {quality !== null ? (
                                <>
                                  <p className={`text-center text-xs mb-1 ${darkMode ? 'text-blue-300' : 'text-blue-600'}`}>Qualidade: <span className="font-bold text-lg">{quality}</span></p>
                                  <p className={`text-center mb-2 text-lg font-bold ${darkMode ? 'text-yellow-400' : 'text-yellow-600'}`}>₽{price.toLocaleString()}</p>
                                </>
                              ) : (
                                <p className={`text-center mb-2 text-sm ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>Qualidade não sorteada</p>
                              )}
                              <div className="flex gap-1.5 mt-auto">
                                <button onClick={() => handleOpenItemDescription(item)} className={`flex-1 py-1.5 rounded-lg ${darkMode ? 'bg-gray-600 hover:bg-gray-500 text-white' : 'bg-gray-300 hover:bg-gray-400 text-gray-800'} font-semibold flex items-center justify-center`} title="Ver descrição"><Info size={14} /></button>
                                <button
                                  onClick={() => handleBuyPokesucoLoja(item, quality)}
                                  disabled={quality === null || pokemonedas < price}
                                  className={`flex-1 py-1.5 rounded-lg font-semibold text-sm ${quality === null || pokemonedas < price ? 'bg-gray-400 text-gray-600 cursor-not-allowed' : 'bg-gradient-to-r from-green-600 to-teal-700 hover:from-green-700 hover:to-teal-800 text-white'}`}
                                >Comprar</button>
                              </div>
                            </div>
                          )
                        })}
                      </div>
                    </div>
                  )}
                </div>
              )
            }

            // Filtrar itens ocultos e itens sem loja
            const visibleItems = items.filter(item => !hiddenItems.includes(item.name) && !item.noShop)

            // Se não houver itens visíveis, não mostrar o corredor
            if (visibleItems.length === 0) return null

            return (
            <div key={corredor} className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl mb-6 overflow-hidden`}>
              {/* Header do Corredor */}
              <button
                onClick={() => toggleCorredor(corredor)}
                className={`w-full p-3 sm:p-5 md:p-6 flex justify-between items-center ${darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-50'} transition-colors`}
              >
                <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  {corredor}
                </h3>
                {expandedCorredores[corredor] ? (
                  <ChevronDown size={24} className={darkMode ? 'text-white' : 'text-gray-800'} />
                ) : (
                  <ChevronRight size={24} className={darkMode ? 'text-white' : 'text-gray-800'} />
                )}
              </button>

              {/* Items do Corredor */}
              {expandedCorredores[corredor] && (
                <div className="p-3 sm:p-5 md:p-6 pt-0">
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3">
                    {visibleItems.map((item, idx) => (
                      <div
                        key={idx}
                        className={`p-3 rounded-lg border-2 ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-gray-50 border-gray-300'} flex flex-col`}
                      >
                        {/* Imagem do Item */}
                        <div className="w-full h-20 mb-2 flex items-center justify-center">
                          <img
                            src={item.image}
                            alt={item.name}
                            className="max-w-full max-h-full object-contain"
                            onError={(e) => {
                              e.target.style.display = 'none'
                            }}
                          />
                        </div>

                        {/* Nome do Item */}
                        <h4 className={`font-bold text-base mb-1 text-center ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                          {item.name}
                        </h4>

                        {/* Preço */}
                        <p className={`text-center mb-2 text-lg font-bold ${darkMode ? 'text-yellow-400' : 'text-yellow-600'}`}>
                          ₽{(customPrices[item.name] !== undefined ? customPrices[item.name] : item.price).toLocaleString()}
                        </p>

                        {/* Botões */}
                        <div className="flex gap-1.5 mt-auto">
                          <button
                            onClick={() => handleOpenItemDescription(item)}
                            className={`flex-1 py-1.5 rounded-lg ${darkMode ? 'bg-gray-600 hover:bg-gray-500 text-white' : 'bg-gray-300 hover:bg-gray-400 text-gray-800'} font-semibold flex items-center justify-center gap-1`}
                            title="Ver descrição"
                          >
                            <Info size={14} />
                          </button>
                          <button
                            onClick={() => handleOpenBuyItemModal(item)}
                            className="flex-1 bg-gradient-to-r from-green-600 to-teal-700 text-white py-1.5 rounded-lg hover:from-green-700 hover:to-teal-800 font-semibold text-sm"
                          >
                            Comprar
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
            )
          })}
        </div>

        {/* Modal Descrição do Item */}
        {showItemDescriptionModal && selectedItemForDescription && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowItemDescriptionModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl p-3 sm:p-5 md:p-6 max-w-md w-full`} onClick={(e) => e.stopPropagation()}>
              {/* Imagem */}
              <div className="w-full h-32 mb-4 flex items-center justify-center">
                <img
                  src={selectedItemForDescription.image}
                  alt={selectedItemForDescription.name}
                  className="max-w-full max-h-full object-contain"
                />
              </div>

              <h3 className={`text-xl sm:text-2xl font-bold mb-2 text-center ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                {selectedItemForDescription.name}
              </h3>

              <p className={`text-center mb-4 text-lg sm:text-xl font-bold ${darkMode ? 'text-yellow-400' : 'text-yellow-600'}`}>
                ₽{(customPrices[selectedItemForDescription.name] !== undefined ? customPrices[selectedItemForDescription.name] : selectedItemForDescription.price).toLocaleString()}
              </p>

              <p className={`mb-6 ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                {selectedItemForDescription.description}
              </p>

              <div className="flex gap-3">
                <button
                  onClick={() => setShowItemDescriptionModal(false)}
                  className={`flex-1 py-3 rounded-lg font-semibold ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                >
                  Fechar
                </button>
                <button
                  onClick={() => {
                    setShowItemDescriptionModal(false)
                    handleOpenBuyItemModal(selectedItemForDescription)
                  }}
                  className="flex-1 bg-gradient-to-r from-green-600 to-teal-700 text-white py-3 rounded-lg hover:from-green-700 hover:to-teal-800 font-semibold"
                >
                  Comprar
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Modal Comprar Item */}
        {showBuyItemModal && selectedItemToBuy && (() => {
          const itemPrice = customPrices[selectedItemToBuy.name] !== undefined ? customPrices[selectedItemToBuy.name] : selectedItemToBuy.price
          const totalPrice = itemPrice * buyItemQuantity
          return (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowBuyItemModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl p-3 sm:p-5 md:p-6 max-w-md w-full`} onClick={(e) => e.stopPropagation()}>
              <h3 className={`text-xl sm:text-2xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                Comprar {selectedItemToBuy.name}
              </h3>

              <div className="mb-4">
                <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-2`}>
                  Preço unitário: <span className={`font-bold ${darkMode ? 'text-yellow-400' : 'text-yellow-600'}`}>₽{itemPrice.toLocaleString()}</span>
                </p>
                <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-4`}>
                  Seu saldo: <span className={`font-bold ${darkMode ? 'text-yellow-400' : 'text-yellow-600'}`}>₽{pokemonedas.toLocaleString()}</span>
                </p>
              </div>

              <div className="mb-4">
                <label className={`block mb-2 font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Quantidade</label>
                <div className="flex items-center gap-3">
                  <button
                    onClick={() => setBuyItemQuantity(Math.max(1, buyItemQuantity - 1))}
                    className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'}`}
                  >
                    <Minus size={20} />
                  </button>
                  <input
                    type="number"
                    min="1"
                    value={buyItemQuantity}
                    onChange={(e) => setBuyItemQuantity(Math.max(1, parseInt(e.target.value) || 1))}
                    className={`flex-1 p-3 rounded-lg text-center font-bold text-lg sm:text-xl ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-100 text-gray-800'}`}
                  />
                  <button
                    onClick={() => setBuyItemQuantity(buyItemQuantity + 1)}
                    className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'}`}
                  >
                    <Plus size={20} />
                  </button>
                </div>
              </div>

              <div className={`mb-6 p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                <p className={`text-center text-lg ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                  Total: <span className={`font-bold text-xl sm:text-2xl ${darkMode ? 'text-yellow-400' : 'text-yellow-600'}`}>
                    ₽{totalPrice.toLocaleString()}
                  </span>
                </p>
              </div>

              {pokemonedas < totalPrice && (
                <div className={`mb-4 p-3 rounded-lg ${darkMode ? 'bg-red-900/30 border border-red-600' : 'bg-red-50 border border-red-400'}`}>
                  <p className={`text-sm ${darkMode ? 'text-red-400' : 'text-red-700'}`}>
                    ⚠️ Pokémoedas insuficientes!
                  </p>
                </div>
              )}

              <div className="flex gap-3">
                <button
                  onClick={() => {
                    setShowBuyItemModal(false)
                    setSelectedItemToBuy(null)
                    setBuyItemQuantity(1)
                  }}
                  className={`flex-1 py-3 rounded-lg font-semibold ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                >
                  Cancelar
                </button>
                <button
                  onClick={handleBuyItem}
                  disabled={pokemonedas < totalPrice}
                  className={`flex-1 py-3 rounded-lg font-semibold ${
                    pokemonedas < totalPrice
                      ? 'bg-gray-500 text-gray-300 cursor-not-allowed'
                      : 'bg-gradient-to-r from-green-600 to-teal-700 text-white hover:from-green-700 hover:to-teal-800'
                  }`}
                >
                  Confirmar Compra
                </button>
              </div>
            </div>
          </div>
          )
        })()}
        </div>
        {accountDataModal}
        {scenarioPopupOverlay}
        {mostrarTriunfosOverlay}
        {pokezapPanel}{pokeAgendaPanel}
        {batalhaChatPanel}
      </>
    )
  }

  // ÁREA INSÍGNIAS
  if (currentUser.type === 'treinador' && currentArea === 'Insígnias') {
    const regions = ['Kanto', 'Johto', 'Hoenn', 'Sinnoh', 'Unova', 'Kalos']

    return (
      <>
        <div className={`min-h-screen ${mainBgClass}`}>
          {sidebarNav}
          <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-lg`}>
            <div className="max-w-7xl mx-auto px-4 py-4">
              <div className="flex justify-between items-center mb-4">
                <div className="flex items-center gap-3"><button onClick={() => setSidebarOpen(true)} className={`p-2 rounded-lg ${darkMode ? "hover:bg-gray-700 text-gray-400" : "hover:bg-gray-200 text-gray-500"}`}><Menu size={24} /></button><h2 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Insígnias</h2></div>
                <div className="flex gap-2 items-center">
                  <button onClick={() => setShowAccountDataModal(true)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-200 text-gray-700'}`} title="Dados da Conta"><ArrowDownUp size={20} /></button>
                  <button onClick={() => setDarkMode(!darkMode)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-yellow-400' : 'bg-gray-200 text-gray-700'}`}>
                    {darkMode ? <Sun size={20} /> : <Moon size={20} />}
                  </button>
                  {pokezapBtn}{pokeAgendaBtn}{batalhaChatBtn}<button onClick={handleLogout} className="bg-red-500 text-white px-3 sm:px-5 md:px-6 py-2 rounded-lg hover:bg-red-600">Sair</button>
                  {currentClima && <div className="flex items-center gap-1.5 ml-1"><img src={`/pokeballs/${currentClima.image}`} alt={currentClima.name} className="w-7 h-7" /><span className={`text-xs font-semibold ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>{currentClima.name}</span></div>}
                </div>
              </div>
            </div>
          </div>

          <div className="max-w-7xl mx-auto px-4 py-3 sm:py-5 md:py-8">
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-8`}>
              {/* Botões de Regiões */}
              <div className="grid grid-cols-2 md:grid-cols-3 gap-2 sm:gap-3 md:gap-4 mb-8">
                {regions.map(region => (
                  <button
                    key={region}
                    onClick={() => setSelectedRegion(region)}
                    className={`flex items-center justify-center gap-2 px-3 sm:px-5 md:px-6 py-4 rounded-lg font-bold text-lg transition-all ${
                      selectedRegion === region
                        ? 'bg-gradient-to-r from-yellow-500 to-orange-500 text-white shadow-lg scale-105'
                        : `${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`
                    }`}
                  >
                    <Award size={24} />
                    {region}
                  </button>
                ))}
              </div>

              {/* Grid de Insígnias */}
              {selectedRegion && (
                <div className="mt-8">
                  <h3 className={`text-xl sm:text-2xl font-bold mb-6 text-center ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                    Insígnias de {selectedRegion}
                  </h3>

                  {/* Imagem de fundo */}
                  <div className="relative mb-6">
                    <img
                      src={`/badges/${selectedRegion.toLowerCase()}.png`}
                      alt={`Insígnias de ${selectedRegion}`}
                      className="w-full max-w-2xl mx-auto rounded-lg"
                      onError={(e) => {
                        e.target.style.display = 'none'
                        e.target.nextElementSibling.style.display = 'grid'
                      }}
                    />

                    {/* Grid de fallback (quando imagem não existe) */}
                    <div className={`hidden ${selectedRegion === 'Unova' ? 'grid-rows-4' : 'grid-cols-3'} gap-2 max-w-2xl mx-auto p-4 ${darkMode ? 'bg-gray-700' : 'bg-gray-200'} rounded-lg`}>
                      {badges[selectedRegion].slice(0, selectedRegion === 'Unova' ? 12 : 9).map((collected, index) => (
                        <button
                          key={`fallback-${index}`}
                          onClick={() => (selectedRegion === 'Unova' ? (index !== 4 && index !== 9) : index !== 4) && toggleBadge(selectedRegion, index)}
                          className={`aspect-square rounded-lg border-4 ${
                            darkMode ? 'border-gray-600' : 'border-gray-400'
                          } transition-all hover:border-yellow-400 ${
                            (selectedRegion === 'Unova' ? (index === 4 || index === 9) : index === 4) ? 'cursor-default' : 'cursor-pointer'
                          } ${collected ? 'bg-gradient-to-br from-yellow-400 to-orange-500' : 'bg-gray-500'}`}
                        >
                          {(selectedRegion === 'Unova' ? (index !== 4 && index !== 9) : index !== 4) && (
                            <div className="flex items-center justify-center h-full">
                              <span className="text-xl sm:text-2xl">{collected ? '✓' : '?'}</span>
                            </div>
                          )}
                        </button>
                      ))}
                    </div>

                    {/* Grid sobreposto - específico para cada região */}
                    {selectedRegion === 'Unova' ? (
                      // Grid 3x4 para Unova (12 posições: 0-11, fixos: 4 e 9)
                      <div className="absolute inset-0 grid grid-cols-3 grid-rows-4 gap-0 max-w-2xl mx-auto">
                        {Array.from({ length: 12 }, (_, i) => i).map((index) => {
                          const isFixed = index === 4 || index === 9
                          // Garantir que badges.Unova sempre tenha 12 posições
                          const unovaBadges = [...(badges.Unova || []), ...Array(12)].slice(0, 12).map(b => b === true)
                          const isCollected = unovaBadges[index]
                          const shouldShowDark = !isCollected && !isFixed

                          return (
                            <button
                              key={index}
                              onClick={() => {
                                if (!isFixed) {
                                  // Garantir que o array tenha 12 posições antes de fazer toggle
                                  setBadges(prev => {
                                    const currentUnova = [...(prev.Unova || []), ...Array(12).fill(false)].slice(0, 12)
                                    const newUnova = currentUnova.map((collected, i) => i === index ? !collected : collected)
                                    return {
                                      ...prev,
                                      Unova: newUnova
                                    }
                                  })
                                }
                              }}
                              className={`transition-all ${isFixed ? 'cursor-default' : 'cursor-pointer hover:opacity-80'}`}
                              style={{
                                backgroundColor: shouldShowDark ? 'rgba(0, 0, 0, 0.8)' : 'transparent',
                                backdropFilter: shouldShowDark ? 'blur(2px)' : 'none'
                              }}
                            />
                          )
                        })}
                      </div>
                    ) : (
                      // Grid 3x3 padrão para outras regiões
                      <div className="absolute inset-0 grid grid-cols-3 gap-0 max-w-2xl mx-auto">
                        {badges[selectedRegion].slice(0, 9).map((collected, index) => (
                          <button
                            key={index}
                            onClick={() => index !== 4 && toggleBadge(selectedRegion, index)}
                            className={`aspect-square transition-all ${
                              index === 4 ? 'cursor-default' : 'cursor-pointer hover:opacity-80'
                            }`}
                            style={{
                              backgroundColor: collected || index === 4 ? 'transparent' : 'rgba(0, 0, 0, 0.8)',
                              backdropFilter: collected || index === 4 ? 'none' : 'blur(2px)'
                            }}
                          />
                        ))}
                      </div>
                    )}
                  </div>

                  {/* Contador */}
                  <div className={`text-center text-lg font-semibold ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Coletadas: {badges[selectedRegion].filter((c, i) => c && (selectedRegion === 'Unova' ? (i !== 4 && i !== 9) : i !== 4)).length} / {selectedRegion === 'Unova' ? '10' : '8'}
                  </div>
                </div>
              )}

              {!selectedRegion && (
                <div className={`text-center text-lg ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                  Selecione uma região acima para visualizar as insígnias
                </div>
              )}
            </div>
          </div>
        </div>
        {accountDataModal}
        {scenarioPopupOverlay}
        {mostrarTriunfosOverlay}
        {pokezapPanel}{pokeAgendaPanel}
        {batalhaChatPanel}
      </>
    )
  }

  // ÁREA CARACTERÍSTICAS & TALENTOS
  if (currentUser.type === 'treinador' && currentArea === 'Características & Talentos') {
    return (
      <>
        <div className={`min-h-screen ${mainBgClass}`}>
          {sidebarNav}
        <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-lg`}>
          <div className="max-w-7xl mx-auto px-4 py-4">
            <div className="flex justify-between items-center mb-4">
              <div className="flex items-center gap-3"><button onClick={() => setSidebarOpen(true)} className={`p-2 rounded-lg ${darkMode ? "hover:bg-gray-700 text-gray-400" : "hover:bg-gray-200 text-gray-500"}`}><Menu size={24} /></button><h2 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Características & Talentos</h2></div>
              <div className="flex gap-2 items-center">
                <button onClick={() => setDarkMode(!darkMode)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-yellow-400' : 'bg-gray-200 text-gray-700'}`}>
                  {darkMode ? <Sun size={20} /> : <Moon size={20} />}
                </button>
                {pokezapBtn}{pokeAgendaBtn}{batalhaChatBtn}<button onClick={handleLogout} className="bg-red-500 text-white px-3 sm:px-5 md:px-6 py-2 rounded-lg hover:bg-red-600">Sair</button>
                {currentClima && <div className="flex items-center gap-1.5 ml-1"><img src={`/pokeballs/${currentClima.image}`} alt={currentClima.name} className="w-7 h-7" /><span className={`text-xs font-semibold ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>{currentClima.name}</span></div>}
              </div>
            </div>
          </div>
        </div>

        <div className="max-w-7xl mx-auto px-4 py-4 sm:py-6 md:py-8">
          <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-6`}>

            {/* LEGENDA DE SÍMBOLOS */}
            <div className={`mb-6 p-3 sm:p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-blue-50'} border ${darkMode ? 'border-gray-600' : 'border-blue-200'}`}>
              <h3 className={`text-base sm:text-lg font-bold mb-3 ${darkMode ? 'text-blue-300' : 'text-blue-800'}`}>Legenda de Ações</h3>
              <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 sm:gap-3 text-xs sm:text-sm">
                <div className={`flex items-center gap-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                  <span className="font-bold text-blue-600">C</span>
                  <span>= Contínuo</span>
                </div>
                <div className={`flex items-center gap-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                  <span className="font-bold text-green-600">P</span>
                  <span>= Ação Padrão</span>
                </div>
                <div className={`flex items-center gap-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                  <span className="font-bold text-yellow-600">L</span>
                  <span>= Ação Livre</span>
                </div>
                <div className={`flex items-center gap-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                  <span className="font-bold text-red-600">I</span>
                  <span>= Ação de Interrupção</span>
                </div>
                <div className={`flex items-center gap-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                  <span className="font-bold text-purple-600">E</span>
                  <span>= Ação Estendida</span>
                </div>
                <div className={`flex items-center gap-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                  <span className="font-bold text-green-600">V</span>
                  <span>= Legal (oficial)</span>
                </div>
                <div className={`flex items-center gap-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                  <span className="font-bold text-red-600">X</span>
                  <span>= Ilegal (oficial)</span>
                </div>
              </div>
            </div>

            {/* CARACTERÍSTICAS */}
            <div className="mb-8">
              <h3 className={`text-lg sm:text-xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-800'}`}>Características de Classe</h3>

              {/* Características Selecionadas */}
              {caracteristicasSelected.length > 0 && (
                <div className="mb-4">
                  <label className={`block text-xs sm:text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Características Selecionadas ({caracteristicasSelected.length})
                  </label>
                  <div className={`p-3 sm:p-4 rounded-lg flex flex-wrap gap-2 ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                    {caracteristicasSelected.map((carac, idx) => (
                      <div key={idx} className={`flex items-center gap-2 px-2 py-1.5 sm:px-3 sm:py-2 rounded text-xs sm:text-sm ${darkMode ? 'bg-purple-600 text-white' : 'bg-purple-500 text-white'}`}>
                        <span className="font-semibold">{typeof carac === 'string' ? carac : (carac.nome || 'Sem nome')}</span>
                        <button
                          onClick={() => setCaracteristicasSelected(caracteristicasSelected.filter((_, i) => i !== idx))}
                          className="hover:bg-red-500 rounded p-1"
                        >
                          <X size={14} className="sm:w-4 sm:h-4" />
                        </button>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              <div className="grid grid-cols-1 md:grid-cols-2 gap-2 sm:gap-3 md:gap-4">
                {(() => {
                  // Obter características das classes/subclasses do usuário
                  const userCaracteristicas = []
                  classes.forEach(className => {
                    if (className && CARACTERISTICAS_DATA[className]) {
                      Object.entries(CARACTERISTICAS_DATA[className]).forEach(([name, data]) => {
                        userCaracteristicas.push({ name, ...data, className })
                      })
                    }
                  })

                  if (userCaracteristicas.length === 0) {
                    return (
                      <div className={`col-span-2 text-center py-4 sm:py-6 md:py-8 text-xs sm:text-sm ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                        <p>Nenhuma classe selecionada. Selecione suas classes na área "Treinador" para ver as características disponíveis.</p>
                      </div>
                    )
                  }

                  return userCaracteristicas.map((carac, idx) => {
                    const isExpanded = expandedCaracteristicas.includes(idx)
                    const isSelected = caracteristicasSelected.some(c => c.nome === carac.name)
                    return (
                      <div key={idx} className={`rounded-lg border-2 ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'}`}>
                        <div className="flex items-center">
                          <button
                            onClick={() => {
                              if (isExpanded) {
                                setExpandedCaracteristicas(expandedCaracteristicas.filter(i => i !== idx))
                              } else {
                                // Calcular qual linha este item está (2 colunas)
                                const row = Math.floor(idx / 2)
                                // Remover outros itens expandidos da mesma linha
                                const newExpanded = expandedCaracteristicas.filter(i => {
                                  const itemRow = Math.floor(i / 2)
                                  return itemRow !== row
                                })
                                setExpandedCaracteristicas([...newExpanded, idx])
                              }
                            }}
                            className={`flex-1 p-3 sm:p-4 flex items-center justify-between hover:opacity-80 transition-opacity rounded-lg`}
                          >
                            <div className="flex items-center gap-2 sm:gap-3">
                              {isExpanded ? <ChevronDown size={18} className={`sm:w-5 sm:h-5 ${darkMode ? 'text-blue-400' : 'text-blue-600'}`} /> : <ChevronRight size={18} className={`sm:w-5 sm:h-5 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`} />}
                              <span className={`font-bold text-sm sm:text-base md:text-lg ${darkMode ? 'text-white' : 'text-gray-800'}`}>{carac.name}</span>
                              <span className={`text-[10px] sm:text-xs px-1.5 py-0.5 sm:px-2 sm:py-1 rounded ${darkMode ? 'bg-blue-900 text-blue-300' : 'bg-blue-100 text-blue-700'}`}>{carac.className}</span>
                            </div>
                            <span className={`text-xs sm:text-sm font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>{carac.frequencia}</span>
                          </button>
                        </div>
                        {isExpanded && (
                          <div className={`px-3 pb-3 sm:px-4 sm:pb-4 border-t ${darkMode ? 'border-gray-600' : 'border-gray-200'}`}>
                            <div className="mt-2 sm:mt-3 space-y-1 sm:space-y-2 text-xs sm:text-sm">
                              <div>
                                <span className={`font-semibold ${darkMode ? 'text-blue-400' : 'text-blue-700'}`}>Referência: </span>
                                <span className={darkMode ? 'text-gray-300' : 'text-gray-700'}>{carac.referencia}</span>
                              </div>
                              {carac.alvo && (
                                <div>
                                  <span className={`font-semibold ${darkMode ? 'text-blue-400' : 'text-blue-700'}`}>Alvo: </span>
                                  <span className={darkMode ? 'text-gray-300' : 'text-gray-700'}>{carac.alvo}</span>
                                </div>
                              )}
                              {carac.gatilho && (
                                <div>
                                  <span className={`font-semibold ${darkMode ? 'text-blue-400' : 'text-blue-700'}`}>Gatilho: </span>
                                  <span className={darkMode ? 'text-gray-300' : 'text-gray-700'}>{carac.gatilho}</span>
                                </div>
                              )}
                              <div>
                                <span className={`font-semibold ${darkMode ? 'text-blue-400' : 'text-blue-700'}`}>Efeito: </span>
                                <span className={darkMode ? 'text-gray-300' : 'text-gray-700'}>{carac.efeito}</span>
                              </div>
                            </div>
                          </div>
                        )}
                      </div>
                    )
                  })
                })()}
              </div>
            </div>

            {/* BOTÕES DE TALENTOS E BOLSA */}
            <div className="flex flex-col sm:flex-row gap-2 sm:gap-3 md:gap-4 mb-6 items-start sm:items-center">
              <button
                onClick={() => setShowTalentosModal(true)}
                className="flex items-center gap-2 px-3 sm:px-5 md:px-6 py-2.5 sm:py-3 bg-gradient-to-r from-green-600 to-emerald-700 text-white rounded-lg font-semibold hover:opacity-90 shadow-lg text-sm sm:text-base w-full sm:w-auto"
              >
                <Plus size={18} className="sm:w-5 sm:h-5" />
                <span>Talento</span>
              </button>
              <div className="flex gap-2 items-center w-full sm:w-auto">
                <button
                  onClick={() => setShowBolsaTalentoModal(true)}
                  className="p-2.5 sm:p-3 bg-gradient-to-r from-blue-600 to-cyan-700 text-white rounded-lg font-semibold hover:opacity-90 shadow-lg"
                  title="Bolsa de Talento"
                >
                  <Sparkles size={18} className="sm:w-5 sm:h-5" />
                </button>
                <div className="flex items-center gap-2">
                  <span className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{bolsaTalento}</span>
                  <div className="flex flex-col gap-1">
                    <button
                      onClick={() => setBolsaTalento(bolsaTalento + 1)}
                      className={`p-1 rounded ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                    >
                      <CornerRightUp size={14} className="sm:w-4 sm:h-4" />
                    </button>
                    <button
                      onClick={() => setBolsaTalento(Math.max(0, bolsaTalento - 1))}
                      className={`p-1 rounded ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                    >
                      <CornerLeftDown size={14} className="sm:w-4 sm:h-4" />
                    </button>
                  </div>
                </div>
              </div>
              {classes.includes('Elementalista') && (
                <button
                  onClick={() => setShowElementalistaTypesModal(true)}
                  className="flex items-center justify-center p-2.5 sm:p-3 bg-black text-white rounded-lg font-semibold hover:opacity-90 shadow-lg w-full sm:w-auto"
                  title="Tipo de Escolha (Elementalista)"
                >
                  <img src="/logodeelemento.png" alt="Tipo de Escolha" className="w-10 h-10 sm:w-12 sm:h-12" />
                </button>
              )}
            </div>

            {/* TALENTOS SELECIONADOS */}
            {talentosSelected.length > 0 && (
              <div className="mb-6">
                <h3 className={`text-base sm:text-lg md:text-xl font-bold mb-3 sm:mb-4 ${darkMode ? 'text-white' : 'text-gray-800'}`}>Talentos Selecionados</h3>
                <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 sm:gap-3">
                  {talentosSelected.map((talentoItem, idx) => {
                    const isExpanded = expandedTalentos.includes(idx)

                    // Extrair o nome do talento (pode ser string ou objeto)
                    const talentoNome = typeof talentoItem === 'string' ? talentoItem : talentoItem.nome

                    // Encontrar os dados completos do talento
                    let talentoData = null
                    let talentoClasse = ''

                    // Procurar nos talentos gerais
                    if (TALENTOS_DATA['Geral']) {
                      const found = TALENTOS_DATA['Geral'].find(t => t.nome === talentoNome)
                      if (found) {
                        talentoData = found
                        talentoClasse = 'Geral'
                      }
                    }

                    // Procurar nas classes do usuário
                    if (!talentoData) {
                      classes.forEach(className => {
                        if (className && TALENTOS_DATA[className]) {
                          const found = TALENTOS_DATA[className].find(t => t.nome === talentoNome)
                          if (found) {
                            talentoData = found
                            talentoClasse = className
                          }
                        }
                      })
                    }

                    return (
                      <div
                        key={idx}
                        className={`rounded-lg border-2 ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'}`}
                      >
                        <div className={`p-2 sm:p-3 flex items-start justify-between gap-2`}>
                          <button
                            onClick={() => {
                              if (isExpanded) {
                                setExpandedTalentos(expandedTalentos.filter(i => i !== idx))
                              } else {
                                // Calcular qual linha este item está (4 colunas em telas grandes)
                                const row = Math.floor(idx / 4)
                                // Remover outros itens expandidos da mesma linha
                                const newExpanded = expandedTalentos.filter(i => {
                                  const itemRow = Math.floor(i / 4)
                                  return itemRow !== row
                                })
                                setExpandedTalentos([...newExpanded, idx])
                              }
                            }}
                            className="flex-1 text-left"
                          >
                            <div className="flex items-center gap-1.5 sm:gap-2 mb-1">
                              {isExpanded ? <ChevronDown size={14} className={`sm:w-4 sm:h-4 ${darkMode ? 'text-green-400' : 'text-green-600'}`} /> : <ChevronRight size={14} className={`sm:w-4 sm:h-4 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`} />}
                              <span className={`font-bold text-xs sm:text-sm ${darkMode ? 'text-white' : 'text-gray-800'}`}>{talentoNome}</span>
                            </div>
                            {talentoClasse && (
                              <span className={`text-[10px] sm:text-xs px-1.5 py-0.5 sm:px-2 sm:py-1 rounded ml-5 sm:ml-6 ${darkMode ? 'bg-blue-900 text-blue-300' : 'bg-blue-100 text-blue-700'}`}>
                                {talentoClasse}
                              </span>
                            )}
                          </button>
                          <button
                            onClick={() => setTalentosSelected(talentosSelected.filter((_, i) => i !== idx))}
                            className={`flex-shrink-0 hover:opacity-70 ${darkMode ? 'text-red-400' : 'text-red-600'}`}
                          >
                            <X size={14} className="sm:w-4 sm:h-4" />
                          </button>
                        </div>

                        {isExpanded && talentoData && (
                          <div className={`px-2 pb-2 sm:px-3 sm:pb-3 border-t ${darkMode ? 'border-gray-600' : 'border-gray-200'}`}>
                            <div className="mt-1.5 sm:mt-2 space-y-1 text-[11px] sm:text-xs">
                              {talentoData.requisitos && (
                                <div>
                                  <span className={`font-semibold ${darkMode ? 'text-green-400' : 'text-green-700'}`}>Requisitos: </span>
                                  <span className={darkMode ? 'text-gray-300' : 'text-gray-700'}>{talentoData.requisitos}</span>
                                </div>
                              )}
                              <div>
                                <span className={`font-semibold ${darkMode ? 'text-green-400' : 'text-green-700'}`}>Frequência: </span>
                                <span className={darkMode ? 'text-gray-300' : 'text-gray-700'}>{talentoData.frequencia}</span>
                              </div>
                              <div>
                                <span className={`font-semibold ${darkMode ? 'text-green-400' : 'text-green-700'}`}>Referência: </span>
                                <span className={darkMode ? 'text-gray-300' : 'text-gray-700'}>{talentoData.referencia}</span>
                              </div>
                              {talentoData.alvo && (
                                <div>
                                  <span className={`font-semibold ${darkMode ? 'text-green-400' : 'text-green-700'}`}>Alvo: </span>
                                  <span className={darkMode ? 'text-gray-300' : 'text-gray-700'}>{talentoData.alvo}</span>
                                </div>
                              )}
                              {talentoData.gatilho && (
                                <div>
                                  <span className={`font-semibold ${darkMode ? 'text-green-400' : 'text-green-700'}`}>Gatilho: </span>
                                  <span className={darkMode ? 'text-gray-300' : 'text-gray-700'}>{talentoData.gatilho}</span>
                                </div>
                              )}
                              <div>
                                <span className={`font-semibold ${darkMode ? 'text-green-400' : 'text-green-700'}`}>Efeito: </span>
                                <span className={darkMode ? 'text-gray-300' : 'text-gray-700'}>{talentoData.efeito}</span>
                              </div>
                            </div>
                          </div>
                        )}
                      </div>
                    )
                  })}
                </div>
              </div>
            )}

          </div>
        </div>

        {/* MODAL DE TALENTOS */}
        {showTalentosModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowTalentosModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-sm sm:max-w-2xl md:max-w-4xl w-full max-h-[90vh] overflow-y-auto`} onClick={(e) => e.stopPropagation()}>
              <div className="p-3 sm:p-5 md:p-6">
                <div className="flex justify-between items-center mb-6">
                  <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-green-400' : 'text-green-700'}`}>
                    Gerenciar Talentos
                  </h3>
                  <button onClick={() => setShowTalentosModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                    <X size={24} />
                  </button>
                </div>

                {/* TALENTOS SELECIONADOS */}
                <div className="mb-6">
                  <label className={`block text-xs sm:text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Talentos Selecionados ({talentosSelected.length})
                  </label>
                  {talentosSelected.length === 0 ? (
                    <div className={`p-3 sm:p-4 rounded-lg text-center text-xs sm:text-sm ${darkMode ? 'bg-gray-700 text-gray-400' : 'bg-gray-100 text-gray-500'}`}>
                      Nenhum talento selecionado
                    </div>
                  ) : (
                    <div className={`p-3 sm:p-4 rounded-lg flex flex-wrap gap-2 ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                      {talentosSelected.map((talento, idx) => (
                        <div key={idx} className={`flex items-center gap-2 px-2 py-1.5 sm:px-3 sm:py-2 rounded text-xs sm:text-sm ${darkMode ? 'bg-green-600 text-white' : 'bg-green-500 text-white'}`}>
                          <span className="font-semibold">{typeof talento === 'string' ? talento : talento.nome}</span>
                          <button
                            onClick={() => setTalentosSelected(talentosSelected.filter((_, i) => i !== idx))}
                            className="hover:bg-red-500 rounded p-1"
                          >
                            <X size={14} className="sm:w-4 sm:h-4" />
                          </button>
                        </div>
                      ))}
                    </div>
                  )}
                </div>

                {/* BUSCA DE TALENTOS */}
                <div className="mb-4">
                  <label className={`block text-xs sm:text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Buscar Talentos
                  </label>
                  <div className="relative">
                    <Search className={`absolute left-2.5 sm:left-3 top-1/2 transform -translate-y-1/2 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`} size={18} />
                    <input
                      type="text"
                      value={talentosSearch}
                      onChange={(e) => setTalentosSearch(e.target.value)}
                      className={`w-full pl-9 sm:pl-10 pr-3 sm:pr-4 py-2 sm:py-2.5 md:py-3 border-2 rounded-lg text-sm sm:text-base ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                      placeholder="Digite o nome do talento..."
                    />
                  </div>
                </div>

                {/* FILTROS DE TALENTOS */}
                <div className="mb-4">
                  <label className={`block text-xs sm:text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Filtrar por Classe
                  </label>
                  <div className="flex flex-wrap gap-2">
                    <button
                      onClick={() => {
                        if (talentosFilterSelected.includes('Geral')) {
                          setTalentosFilterSelected(talentosFilterSelected.filter(f => f !== 'Geral'))
                        } else {
                          setTalentosFilterSelected([...talentosFilterSelected, 'Geral'])
                        }
                      }}
                      className={`px-2 py-1 sm:px-3 rounded-lg text-xs sm:text-sm font-semibold transition-all ${
                        talentosFilterSelected.includes('Geral')
                          ? 'bg-green-500 text-white'
                          : darkMode ? 'bg-gray-600 text-gray-300 hover:bg-gray-500' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                      }`}
                    >
                      Geral
                    </button>
                    {classes[0] && (
                      <button
                        onClick={() => {
                          if (talentosFilterSelected.includes(classes[0])) {
                            setTalentosFilterSelected(talentosFilterSelected.filter(f => f !== classes[0]))
                          } else {
                            setTalentosFilterSelected([...talentosFilterSelected, classes[0]])
                          }
                        }}
                        className={`px-2 py-1 sm:px-3 rounded-lg text-xs sm:text-sm font-semibold transition-all ${
                          talentosFilterSelected.includes(classes[0])
                            ? 'bg-blue-500 text-white'
                            : darkMode ? 'bg-gray-600 text-gray-300 hover:bg-gray-500' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                        }`}
                      >
                        {classes[0]}
                      </button>
                    )}
                    {classes[1] && (
                      <button
                        onClick={() => {
                          if (talentosFilterSelected.includes(classes[1])) {
                            setTalentosFilterSelected(talentosFilterSelected.filter(f => f !== classes[1]))
                          } else {
                            setTalentosFilterSelected([...talentosFilterSelected, classes[1]])
                          }
                        }}
                        className={`px-2 py-1 sm:px-3 rounded-lg text-xs sm:text-sm font-semibold transition-all ${
                          talentosFilterSelected.includes(classes[1])
                            ? 'bg-purple-500 text-white'
                            : darkMode ? 'bg-gray-600 text-gray-300 hover:bg-gray-500' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                        }`}
                      >
                        {classes[1]}
                      </button>
                    )}
                    {classes[2] && (
                      <button
                        onClick={() => {
                          if (talentosFilterSelected.includes(classes[2])) {
                            setTalentosFilterSelected(talentosFilterSelected.filter(f => f !== classes[2]))
                          } else {
                            setTalentosFilterSelected([...talentosFilterSelected, classes[2]])
                          }
                        }}
                        className={`px-2 py-1 sm:px-3 rounded-lg text-xs sm:text-sm font-semibold transition-all ${
                          talentosFilterSelected.includes(classes[2])
                            ? 'bg-orange-500 text-white'
                            : darkMode ? 'bg-gray-600 text-gray-300 hover:bg-gray-500' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                        }`}
                      >
                        {classes[2]}
                      </button>
                    )}
                    {classes[3] && (
                      <button
                        onClick={() => {
                          if (talentosFilterSelected.includes(classes[3])) {
                            setTalentosFilterSelected(talentosFilterSelected.filter(f => f !== classes[3]))
                          } else {
                            setTalentosFilterSelected([...talentosFilterSelected, classes[3]])
                          }
                        }}
                        className={`px-2 py-1 sm:px-3 rounded-lg text-xs sm:text-sm font-semibold transition-all ${
                          talentosFilterSelected.includes(classes[3])
                            ? 'bg-red-500 text-white'
                            : darkMode ? 'bg-gray-600 text-gray-300 hover:bg-gray-500' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                        }`}
                      >
                        {classes[3]}
                      </button>
                    )}
                  </div>
                </div>

                {/* TALENTOS DISPONÍVEIS */}
                <div className="mb-6">
                  <label className={`block text-xs sm:text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Talentos Disponíveis
                  </label>
                  <div className={`max-h-96 overflow-y-auto rounded-lg p-3 sm:p-4 space-y-2 ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                    {(() => {
                      // Filtrar talentos por classe do usuário + talentos gerais
                      const availableTalentos = []

                      // Adicionar talentos gerais
                      if (TALENTOS_DATA['Geral']) {
                        TALENTOS_DATA['Geral'].forEach(talento => {
                          availableTalentos.push({ ...talento, classe: 'Geral' })
                        })
                      }

                      // Adicionar talentos das classes do usuário
                      classes.forEach(className => {
                        if (className && TALENTOS_DATA[className]) {
                          TALENTOS_DATA[className].forEach(talento => {
                            availableTalentos.push({ ...talento, classe: className })
                          })
                        }
                      })

                      // Filtrar pela busca, filtros de classe e remover os já selecionados
                      const filtered = availableTalentos
                        .filter(talento => talento.nome.toLowerCase().includes(talentosSearch.toLowerCase()))
                        .filter(talento => talentosFilterSelected.length === 0 || talentosFilterSelected.includes(talento.classe))
                        .filter(talento => !talentosSelected.some(t => t.nome === talento.nome))

                      if (filtered.length === 0) {
                        return (
                          <div className={`text-center py-4 sm:py-6 md:py-8 text-xs sm:text-sm ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                            {talentosSearch ? 'Nenhum talento encontrado' : 'Nenhuma classe selecionada. Selecione suas classes na área "Treinador".'}
                          </div>
                        )
                      }

                      return filtered.map((talento, idx) => (
                        <div key={idx} className={`p-2 sm:p-3 rounded transition-colors ${darkMode ? 'bg-gray-600' : 'bg-white'}`}>
                          <div className="flex items-start justify-between gap-2 sm:gap-3">
                            <div className="flex-1">
                              <div className="flex items-center gap-1.5 sm:gap-2 mb-1">
                                <span className={`font-bold text-xs sm:text-sm ${darkMode ? 'text-white' : 'text-gray-800'}`}>{talento.nome}</span>
                                <span className={`text-[10px] sm:text-xs px-1.5 py-0.5 sm:px-2 sm:py-1 rounded ${darkMode ? 'bg-blue-900 text-blue-300' : 'bg-blue-100 text-blue-700'}`}>
                                  {talento.classe}
                                </span>
                              </div>
                              <div className={`text-[11px] sm:text-xs space-y-1 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                {talento.requisitos && (
                                  <div>
                                    <span className="font-semibold">Requisitos: </span>
                                    <span>{talento.requisitos}</span>
                                  </div>
                                )}
                                <div>
                                  <span className="font-semibold">Frequência: </span>
                                  <span>{talento.frequencia}</span>
                                </div>
                                <div>
                                  <span className="font-semibold">Referência: </span>
                                  <span>{talento.referencia}</span>
                                </div>
                                {talento.alvo && (
                                  <div>
                                    <span className="font-semibold">Alvo: </span>
                                    <span>{talento.alvo}</span>
                                  </div>
                                )}
                                {talento.gatilho && (
                                  <div>
                                    <span className="font-semibold">Gatilho: </span>
                                    <span>{talento.gatilho}</span>
                                  </div>
                                )}
                                <div>
                                  <span className="font-semibold">Efeito: </span>
                                  <span>{talento.efeito}</span>
                                </div>
                              </div>
                            </div>
                            <button
                              onClick={() => setTalentosSelected([...talentosSelected, talento])}
                              className={`flex-shrink-0 p-1.5 sm:p-2 rounded text-white ${darkMode ? 'bg-green-600 hover:bg-green-700' : 'bg-green-500 hover:bg-green-600'}`}
                            >
                              <Plus size={18} className="sm:w-5 sm:h-5" />
                            </button>
                          </div>
                        </div>
                      ))
                    })()}
                  </div>
                </div>

                <div className="flex gap-3">
                  <button
                    onClick={() => setShowTalentosModal(false)}
                    className="flex-1 bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 font-semibold"
                  >
                    Fechar
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* MODAL BOLSA DE TALENTO */}
        {showBolsaTalentoModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowBolsaTalentoModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-sm sm:max-w-md w-full`} onClick={(e) => e.stopPropagation()}>
              <div className="p-3 sm:p-5 md:p-6">
                <div className="flex justify-between items-center mb-6">
                  <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-blue-400' : 'text-blue-700'}`}>
                    Bolsa de Talento
                  </h3>
                  <button onClick={() => setShowBolsaTalentoModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                    <X size={24} />
                  </button>
                </div>

                <div className="mb-6">
                  <label className={`block text-sm font-bold mb-3 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Valor da Bolsa de Talento
                  </label>
                  <div className="flex items-center gap-3">
                    <button
                      onClick={() => setBolsaTalento(Math.max(0, bolsaTalento - 1))}
                      className={`p-3 rounded-lg ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                    >
                      <CornerLeftDown size={24} />
                    </button>
                    <input
                      type="number"
                      min="0"
                      value={bolsaTalento}
                      onChange={(e) => setBolsaTalento(Math.max(0, parseInt(e.target.value) || 0))}
                      className={`flex-1 px-4 py-3 text-center text-xl sm:text-2xl font-bold border-2 rounded-lg ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                    />
                    <button
                      onClick={() => setBolsaTalento(bolsaTalento + 1)}
                      className={`p-3 rounded-lg ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                    >
                      <CornerRightUp size={24} />
                    </button>
                  </div>
                </div>

                <div className="flex gap-3">
                  <button
                    onClick={() => setShowBolsaTalentoModal(false)}
                    className="flex-1 bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 font-semibold"
                  >
                    Salvar
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* MODAL TIPO DE ESCOLHA (ELEMENTALISTA) */}
        {showElementalistaTypesModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowElementalistaTypesModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-sm sm:max-w-xl md:max-w-2xl w-full max-h-[90vh] overflow-y-auto`} onClick={(e) => e.stopPropagation()}>
              <div className="p-3 sm:p-5 md:p-6">
                <div className="flex justify-between items-center mb-6">
                  <h3 className={`text-lg sm:text-xl md:text-2xl font-bold ${darkMode ? 'text-orange-400' : 'text-orange-700'} flex items-center gap-2`}>
                    <img src="/logodeelemento.png" alt="Tipo" className="w-6 h-6 sm:w-7 sm:h-7" />
                    Tipo de Escolha
                  </h3>
                  <button onClick={() => setShowElementalistaTypesModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                    <X size={24} />
                  </button>
                </div>

                {/* Campo de Busca */}
                <div className="mb-6">
                  <input
                    type="text"
                    placeholder="Buscar tipo..."
                    value={elementalistaTypesSearch}
                    onChange={(e) => setElementalistaTypesSearch(e.target.value)}
                    className={`w-full px-3 py-2 sm:px-4 sm:py-3 border-2 rounded-lg text-sm sm:text-base ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'border-gray-300 placeholder-gray-500'}`}
                  />
                </div>

                {/* Tipos Selecionados */}
                {elementalistaTypes.length > 0 && (
                  <div className="mb-6">
                    <h4 className={`text-base sm:text-lg font-bold mb-3 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      Tipos Selecionados ({elementalistaTypes.length})
                    </h4>
                    <div className="flex flex-wrap gap-2">
                      {elementalistaTypes.map((type, idx) => (
                        <div
                          key={idx}
                          className="flex items-center gap-1.5 sm:gap-2 px-2 py-1 sm:px-3 sm:py-1.5 rounded-lg font-semibold text-white text-xs sm:text-sm shadow-md"
                          style={{
                            background: TYPE_STYLES[type]?.gradient || 'linear-gradient(135deg, #718096 0%, #4A5568 100%)',
                          }}
                        >
                          <span>{type}</span>
                          <button
                            onClick={() => setElementalistaTypes(elementalistaTypes.filter((_, i) => i !== idx))}
                            className="hover:bg-black/20 rounded-full p-0.5"
                          >
                            <X size={14} className="sm:w-4 sm:h-4" />
                          </button>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {/* Grid de Tipos Disponíveis */}
                <div className="mb-6">
                  <h4 className={`text-base sm:text-lg font-bold mb-3 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Tipos Disponíveis
                  </h4>
                  <div className="grid grid-cols-2 sm:grid-cols-3 gap-2 sm:gap-3">
                    {POKEMON_TYPES.filter(type =>
                      type.toLowerCase().includes(elementalistaTypesSearch.toLowerCase())
                    ).map((type) => {
                      const isSelected = elementalistaTypes.includes(type)
                      return (
                        <button
                          key={type}
                          onClick={() => {
                            if (isSelected) {
                              setElementalistaTypes(elementalistaTypes.filter(t => t !== type))
                            } else {
                              setElementalistaTypes([...elementalistaTypes, type])
                            }
                          }}
                          className={`px-3 py-2 sm:px-4 sm:py-3 rounded-lg font-semibold text-white shadow-md transition-all text-xs sm:text-sm ${
                            isSelected ? 'ring-4 ring-yellow-400 ring-opacity-60' : 'hover:opacity-80'
                          }`}
                          style={{
                            background: TYPE_STYLES[type]?.gradient || 'linear-gradient(135deg, #718096 0%, #4A5568 100%)',
                          }}
                        >
                          {type}
                        </button>
                      )
                    })}
                  </div>
                </div>

                {/* Botão Salvar */}
                <div className="flex gap-3">
                  <button
                    onClick={() => {
                      setShowElementalistaTypesModal(false)
                      setElementalistaTypesSearch('')
                    }}
                    className="flex-1 bg-gradient-to-r from-orange-600 to-red-700 text-white py-3 rounded-lg hover:opacity-90 font-semibold shadow-lg"
                  >
                    Salvar
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        </div>
        {accountDataModal}
        {scenarioPopupOverlay}
        {mostrarTriunfosOverlay}
        {pokezapPanel}{pokeAgendaPanel}
        {batalhaChatPanel}
      </>
    )
  }

  // ÁREA ENCICLOPÉDIA
  if (currentUser.type === 'treinador' && currentArea === 'Enciclopédia') {
    const encyclopediaSections = ['Golpedex', 'Descritordex', 'Tag de Concursodex', 'Períciadex', 'Habilidadedex', 'Capacidadex', 'Condiçõesdex', 'Itendex', 'Progressão de nível']

    return (
      <>
        <div className={`min-h-screen ${mainBgClass}`}>
          {sidebarNav}
        <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-lg`}>
          <div className="max-w-7xl mx-auto px-4 py-4">
            <div className="flex justify-between items-center mb-4">
              <div className="flex items-center gap-3"><button onClick={() => setSidebarOpen(true)} className={`p-2 rounded-lg ${darkMode ? "hover:bg-gray-700 text-gray-400" : "hover:bg-gray-200 text-gray-500"}`}><Menu size={24} /></button><h2 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Enciclopédia</h2></div>
              <div className="flex gap-2 items-center">
                <button onClick={() => setDarkMode(!darkMode)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-yellow-400' : 'bg-gray-200 text-gray-700'}`}>
                  {darkMode ? <Sun size={20} /> : <Moon size={20} />}
                </button>
                {pokezapBtn}{pokeAgendaBtn}{batalhaChatBtn}<button onClick={handleLogout} className="bg-red-500 text-white px-3 sm:px-5 md:px-6 py-2 rounded-lg hover:bg-red-600">Sair</button>
                {currentClima && <div className="flex items-center gap-1.5 ml-1"><img src={`/pokeballs/${currentClima.image}`} alt={currentClima.name} className="w-7 h-7" /><span className={`text-xs font-semibold ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>{currentClima.name}</span></div>}
              </div>
            </div>
          </div>
        </div>

        {/* Navegação de Subáreas da Enciclopédia */}
        <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-md`}>
          <div className="max-w-7xl mx-auto px-4 py-3">
            <div className="flex flex-wrap gap-2">
              {encyclopediaSections.map(section => (
                <button
                  key={section}
                  onClick={() => setEncyclopediaSection(section)}
                  className={`px-4 py-2 rounded-lg text-sm font-semibold transition-all ${
                    encyclopediaSection === section
                      ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white shadow-lg'
                      : darkMode
                      ? 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                      : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                  }`}
                >
                  {section}
                </button>
              ))}
            </div>
          </div>
        </div>

        <div className="max-w-7xl mx-auto px-4 py-3 sm:py-5 md:py-8">
          {/* Golpedex */}
          {encyclopediaSection === 'Golpedex' && (
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-8`}>
              <h3 className={`text-2xl sm:text-3xl font-bold mb-6 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                Golpedex
              </h3>
              <p className={`mb-6 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                Pesquise até 8 golpes simultaneamente para comparar suas características
              </p>

              {/* Grid 4x2 de Barras de Pesquisa */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-3 sm:p-5 md:p-6 mb-8">
                {golpedexSearches.map((search, index) => (
                  <div key={index} className="relative">
                    <label className={`block text-sm font-semibold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      Golpe #{index + 1}
                    </label>
                    <div className="relative">
                      <Search className={`absolute left-3 top-1/2 transform -translate-y-1/2 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`} size={20} />
                      <input
                        type="text"
                        value={search}
                        onChange={(e) => {
                          const newSearches = [...golpedexSearches]
                          newSearches[index] = e.target.value
                          setGolpedexSearches(newSearches)
                        }}
                        placeholder="Digite o nome do golpe..."
                        className={`w-full pl-10 pr-4 py-3 rounded-lg border-2 ${
                          darkMode
                            ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-500 focus:border-purple-500'
                            : 'bg-white border-gray-300 text-gray-800 placeholder-gray-400 focus:border-purple-500'
                        } focus:outline-none transition-all`}
                        list={`golpes-datalist-${index}`}
                      />
                      <datalist id={`golpes-datalist-${index}`}>
                        {GOLPES_NAMES.filter(nome =>
                          nome.toLowerCase().includes(search.toLowerCase())
                        ).slice(0, 50).map(nome => (
                          <option key={nome} value={nome} />
                        ))}
                      </datalist>
                      {search && (
                        <button
                          onClick={() => {
                            const newSearches = [...golpedexSearches]
                            newSearches[index] = ''
                            setGolpedexSearches(newSearches)
                          }}
                          className={`absolute right-3 top-1/2 transform -translate-y-1/2 ${
                            darkMode ? 'text-gray-500 hover:text-gray-300' : 'text-gray-400 hover:text-gray-600'
                          }`}
                        >
                          <X size={20} />
                        </button>
                      )}
                    </div>

                    {/* Exibir informações do golpe se selecionado */}
                    {search && GOLPES_DATA[search] && (
                      <div className={`mt-3 p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                        <div className="space-y-2">
                          <div className="flex items-center gap-2">
                            <span className={`px-3 py-1 rounded-full text-xs font-bold ${TYPE_STYLES[GOLPES_DATA[search].tipo] || 'bg-gray-500'} text-white`}>
                              {GOLPES_DATA[search].tipo}
                            </span>
                            <span className={`px-2 py-1 rounded text-xs font-semibold ${darkMode ? 'bg-gray-600 text-gray-200' : 'bg-white text-gray-700'}`}>
                              {GOLPES_DATA[search].aptidao}
                            </span>
                          </div>

                          <div className="grid grid-cols-2 gap-2 text-sm">
                            <div>
                              <span className={`font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Acurácia:</span>
                              <span className={`ml-2 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                {GOLPES_DATA[search].acuracia || 'N/A'}
                              </span>
                            </div>
                            <div>
                              <span className={`font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Dano:</span>
                              <span className={`ml-2 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                {GOLPES_DATA[search].danoBasal || 'N/A'}
                              </span>
                            </div>
                            <div>
                              <span className={`font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Alcance:</span>
                              <span className={`ml-2 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                {GOLPES_DATA[search].alcance || 'N/A'}
                              </span>
                            </div>
                            <div>
                              <span className={`font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Frequência:</span>
                              <span className={`ml-2 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                {GOLPES_DATA[search].frequencia || 'N/A'}
                              </span>
                            </div>
                          </div>

                          {GOLPES_DATA[search].descritores && (
                            <div>
                              <span className={`font-semibold text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                Descritores:
                              </span>
                              <span className={`ml-2 text-sm ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                {GOLPES_DATA[search].descritores}
                              </span>
                            </div>
                          )}

                          {GOLPES_DATA[search].tagConcurso && (
                            <div>
                              <span className={`font-semibold text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                Tag Concurso:
                              </span>
                              <span className={`ml-2 text-sm ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                {GOLPES_DATA[search].tagConcurso}
                              </span>
                            </div>
                          )}

                          <div className={`pt-2 border-t ${darkMode ? 'border-gray-600' : 'border-gray-300'}`}>
                            <div className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                              <span className="font-semibold">Efeito:</span> {renderGolpeEfeito(GOLPES_DATA[search].efeito, darkMode)}
                            </div>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Descritordex */}
          {encyclopediaSection === 'Descritordex' && (
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-8`}>
              <h3 className={`text-2xl sm:text-3xl font-bold mb-6 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                Descritordex
              </h3>
              <p className={`mb-6 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                Clique em um descritor para ver suas informações detalhadas
              </p>

              {/* Grid 5x4 de Descritores */}
              <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 sm:gap-3 md:gap-4">
                {DESCRITORES_DATA.map((descritor) => (
                  <div key={descritor.nome} className="relative">
                    <button
                      onClick={() => {
                        if (expandedDescritor === descritor.nome) {
                          setExpandedDescritor(null)
                        } else {
                          setExpandedDescritor(descritor.nome)
                        }
                      }}
                      className={`w-full text-left p-4 rounded-lg border-2 transition-all ${
                        expandedDescritor === descritor.nome
                          ? darkMode
                            ? 'bg-purple-900 border-purple-500 shadow-lg'
                            : 'bg-purple-100 border-purple-500 shadow-lg'
                          : darkMode
                          ? 'bg-gray-700 border-gray-600 hover:bg-gray-650 hover:border-gray-500'
                          : 'bg-white border-gray-300 hover:bg-gray-50 hover:border-gray-400'
                      }`}
                    >
                      <div className="flex items-center justify-between">
                        <h4 className={`font-bold text-lg ${
                          expandedDescritor === descritor.nome
                            ? darkMode ? 'text-purple-200' : 'text-purple-800'
                            : darkMode ? 'text-white' : 'text-gray-800'
                        }`}>
                          {descritor.nome}
                        </h4>
                        <ChevronDown
                          size={20}
                          className={`transition-transform ${
                            expandedDescritor === descritor.nome ? 'rotate-180' : ''
                          } ${
                            expandedDescritor === descritor.nome
                              ? darkMode ? 'text-purple-300' : 'text-purple-600'
                              : darkMode ? 'text-gray-400' : 'text-gray-500'
                          }`}
                        />
                      </div>
                    </button>

                    {/* Card Expandido */}
                    {expandedDescritor === descritor.nome && (
                      <div className={`mt-3 p-5 rounded-lg border-2 ${
                        darkMode
                          ? 'bg-gray-750 border-purple-600'
                          : 'bg-purple-50 border-purple-400'
                      } shadow-xl`}>
                        <div className="flex items-start gap-3 mb-3">
                          <div className={`p-2 rounded-full ${
                            darkMode ? 'bg-purple-800' : 'bg-purple-200'
                          }`}>
                            <BookOpenText size={20} className={
                              darkMode ? 'text-purple-300' : 'text-purple-700'
                            } />
                          </div>
                          <div className="flex-1">
                            <h5 className={`font-bold text-lg sm:text-xl mb-2 ${
                              darkMode ? 'text-purple-200' : 'text-purple-900'
                            }`}>
                              {descritor.nome}
                            </h5>
                          </div>
                        </div>

                        <div className={`pt-3 border-t ${
                          darkMode ? 'border-purple-700' : 'border-purple-300'
                        }`}>
                          <p className={`text-sm leading-relaxed ${
                            darkMode ? 'text-gray-300' : 'text-gray-700'
                          }`}>
                            {descritor.efeito}
                          </p>
                        </div>
                      </div>
                    )}
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Tag de Concursodex */}
          {encyclopediaSection === 'Tag de Concursodex' && (
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-8`}>
              <h3 className={`text-2xl sm:text-3xl font-bold mb-6 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                Tag de Concursodex
              </h3>
              <p className={`mb-6 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                Clique em uma tag de concurso para ver suas informações detalhadas
              </p>

              {/* Grid 5x4 de Tags de Concurso */}
              <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 sm:gap-3 md:gap-4">
                {TAGS_CONCURSO_DATA.map((tag) => (
                  <div key={tag.nome} className="relative">
                    <button
                      onClick={() => {
                        if (expandedTagConcurso === tag.nome) {
                          setExpandedTagConcurso(null)
                        } else {
                          setExpandedTagConcurso(tag.nome)
                        }
                      }}
                      className={`w-full text-left p-4 rounded-lg border-2 transition-all ${
                        expandedTagConcurso === tag.nome
                          ? darkMode
                            ? 'bg-pink-900 border-pink-500 shadow-lg'
                            : 'bg-pink-100 border-pink-500 shadow-lg'
                          : darkMode
                          ? 'bg-gray-700 border-gray-600 hover:bg-gray-650 hover:border-gray-500'
                          : 'bg-white border-gray-300 hover:bg-gray-50 hover:border-gray-400'
                      }`}
                    >
                      <div className="flex items-center justify-between">
                        <div className="flex-1">
                          <h4 className={`font-bold text-lg ${
                            expandedTagConcurso === tag.nome
                              ? darkMode ? 'text-pink-200' : 'text-pink-800'
                              : darkMode ? 'text-white' : 'text-gray-800'
                          }`}>
                            {tag.nome}
                          </h4>
                          <p className={`text-xs mt-1 font-semibold ${
                            expandedTagConcurso === tag.nome
                              ? darkMode ? 'text-pink-300' : 'text-pink-600'
                              : darkMode ? 'text-gray-400' : 'text-gray-500'
                          }`}>
                            Pontuação: {tag.pontuacaoBasal}
                          </p>
                        </div>
                        <ChevronDown
                          size={20}
                          className={`transition-transform flex-shrink-0 ml-2 ${
                            expandedTagConcurso === tag.nome ? 'rotate-180' : ''
                          } ${
                            expandedTagConcurso === tag.nome
                              ? darkMode ? 'text-pink-300' : 'text-pink-600'
                              : darkMode ? 'text-gray-400' : 'text-gray-500'
                          }`}
                        />
                      </div>
                    </button>

                    {/* Card Expandido */}
                    {expandedTagConcurso === tag.nome && (
                      <div className={`mt-3 p-5 rounded-lg border-2 ${
                        darkMode
                          ? 'bg-gray-750 border-pink-600'
                          : 'bg-pink-50 border-pink-400'
                      } shadow-xl`}>
                        <div className="flex items-start gap-3 mb-3">
                          <div className={`p-2 rounded-full ${
                            darkMode ? 'bg-pink-800' : 'bg-pink-200'
                          }`}>
                            <Crown size={20} className={
                              darkMode ? 'text-pink-300' : 'text-pink-700'
                            } />
                          </div>
                          <div className="flex-1">
                            <h5 className={`font-bold text-lg sm:text-xl mb-1 ${
                              darkMode ? 'text-pink-200' : 'text-pink-900'
                            }`}>
                              {tag.nome}
                            </h5>
                            <div className={`inline-block px-3 py-1 rounded-full text-xs font-bold ${
                              darkMode ? 'bg-pink-700 text-pink-100' : 'bg-pink-200 text-pink-800'
                            }`}>
                              Pontuação Basal: {tag.pontuacaoBasal}
                            </div>
                          </div>
                        </div>

                        <div className={`pt-3 border-t ${
                          darkMode ? 'border-pink-700' : 'border-pink-300'
                        }`}>
                          <p className={`text-sm font-semibold mb-1 ${
                            darkMode ? 'text-pink-300' : 'text-pink-700'
                          }`}>
                            Efeito:
                          </p>
                          <p className={`text-sm leading-relaxed ${
                            darkMode ? 'text-gray-300' : 'text-gray-700'
                          }`}>
                            {tag.efeito}
                          </p>
                        </div>
                      </div>
                    )}
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Períciadex */}
          {encyclopediaSection === 'Períciadex' && (
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-8`}>
              <h3 className={`text-2xl sm:text-3xl font-bold mb-6 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                Períciadex
              </h3>
              <p className={`mb-6 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                Clique em um atributo para ver suas perícias
              </p>

              {/* Coluna de 6 Atributos */}
              <div className="space-y-4 max-w-sm sm:max-w-2xl md:max-w-4xl mx-auto">
                {ATRIBUTOS_PERICIAS_DATA.map((atributo) => (
                  <div key={atributo.nome} className="relative">
                    <button
                      onClick={() => {
                        if (expandedAtributo === atributo.nome) {
                          setExpandedAtributo(null)
                        } else {
                          setExpandedAtributo(atributo.nome)
                        }
                      }}
                      className={`w-full text-left p-5 rounded-lg border-2 transition-all ${
                        expandedAtributo === atributo.nome
                          ? darkMode
                            ? 'bg-blue-900 border-blue-500 shadow-lg'
                            : 'bg-blue-100 border-blue-500 shadow-lg'
                          : darkMode
                          ? 'bg-gray-700 border-gray-600 hover:bg-gray-650 hover:border-gray-500'
                          : 'bg-white border-gray-300 hover:bg-gray-50 hover:border-gray-400'
                      }`}
                    >
                      <div className="flex items-center justify-between">
                        <div className="flex-1">
                          <h4 className={`font-bold text-xl sm:text-2xl mb-2 ${
                            expandedAtributo === atributo.nome
                              ? darkMode ? 'text-blue-200' : 'text-blue-800'
                              : darkMode ? 'text-white' : 'text-gray-800'
                          }`}>
                            {atributo.nome}
                          </h4>
                          <p className={`text-sm leading-relaxed ${
                            expandedAtributo === atributo.nome
                              ? darkMode ? 'text-blue-100' : 'text-blue-700'
                              : darkMode ? 'text-gray-400' : 'text-gray-600'
                          }`}>
                            {atributo.explicacao}
                          </p>
                        </div>
                        <ChevronRight
                          size={28}
                          className={`transition-transform flex-shrink-0 ml-4 ${
                            expandedAtributo === atributo.nome ? 'rotate-90' : ''
                          } ${
                            expandedAtributo === atributo.nome
                              ? darkMode ? 'text-blue-300' : 'text-blue-600'
                              : darkMode ? 'text-gray-400' : 'text-gray-500'
                          }`}
                        />
                      </div>
                    </button>

                    {/* Perícias expandidas em coluna */}
                    {expandedAtributo === atributo.nome && (
                      <div className={`mt-4 p-3 sm:p-5 md:p-6 rounded-lg border-2 ${
                        darkMode
                          ? 'bg-gray-750 border-blue-600'
                          : 'bg-blue-50 border-blue-400'
                      } shadow-xl`}>
                        <div className="flex items-center gap-3 mb-4">
                          <div className={`p-2 rounded-full ${
                            darkMode ? 'bg-blue-800' : 'bg-blue-200'
                          }`}>
                            <Sparkles size={24} className={
                              darkMode ? 'text-blue-300' : 'text-blue-700'
                            } />
                          </div>
                          <h5 className={`font-bold text-lg sm:text-xl ${
                            darkMode ? 'text-blue-200' : 'text-blue-900'
                          }`}>
                            Perícias de {atributo.nome}
                          </h5>
                        </div>

                        {/* Lista de Perícias em coluna */}
                        <div className="space-y-3">
                          {atributo.pericias.map((pericia, index) => (
                            <div
                              key={pericia.nome}
                              className={`p-4 rounded-lg ${
                                darkMode ? 'bg-gray-800' : 'bg-white'
                              } border ${
                                darkMode ? 'border-blue-700' : 'border-blue-300'
                              }`}
                            >
                              <div className="flex items-start gap-3">
                                <div className={`mt-1 px-2 py-1 rounded-full text-xs font-bold ${
                                  darkMode ? 'bg-blue-700 text-blue-100' : 'bg-blue-200 text-blue-800'
                                }`}>
                                  {index + 1}
                                </div>
                                <div className="flex-1">
                                  <h6 className={`font-bold text-lg mb-1 ${
                                    darkMode ? 'text-blue-200' : 'text-blue-900'
                                  }`}>
                                    {pericia.nome}
                                  </h6>
                                  <p className={`text-sm leading-relaxed mb-3 ${
                                    darkMode ? 'text-gray-300' : 'text-gray-700'
                                  }`}>
                                    {pericia.descricao}
                                  </p>

                                  {/* Tabela da Perícia (se houver) */}
                                  {pericia.tabela && (
                                    <div className="mt-3 overflow-x-auto">
                                      <table className={`w-full text-sm border-collapse ${
                                        darkMode ? 'border-gray-600' : 'border-gray-300'
                                      }`}>
                                        <thead>
                                          <tr className={darkMode ? 'bg-gray-700' : 'bg-blue-100'}>
                                            <th className={`border p-2 font-semibold text-left ${
                                              darkMode ? 'border-gray-600 text-blue-200' : 'border-gray-300 text-blue-900'
                                            }`}>
                                              Resultado
                                            </th>
                                            {/* Cabeçalhos dinâmicos baseados nas colunas da tabela */}
                                            {Object.keys(pericia.tabela[0])
                                              .filter(key => key !== 'resultado')
                                              .map(key => (
                                                <th key={key} className={`border p-2 font-semibold text-left ${
                                                  darkMode ? 'border-gray-600 text-blue-200' : 'border-gray-300 text-blue-900'
                                                }`}>
                                                  {key === 'efeito' ? 'Efeito' :
                                                   key === 'altura' ? 'Altura' :
                                                   key === 'horizontal' ? 'Horizontal' :
                                                   key === 'equilibrio' ? 'Equilíbrio' :
                                                   key === 'escalada' ? 'Escalada' : key}
                                                </th>
                                              ))}
                                          </tr>
                                        </thead>
                                        <tbody>
                                          {pericia.tabela.map((linha, idx) => (
                                            <tr key={idx} className={idx % 2 === 0
                                              ? (darkMode ? 'bg-gray-750' : 'bg-white')
                                              : (darkMode ? 'bg-gray-800' : 'bg-blue-50')
                                            }>
                                              <td className={`border p-2 font-bold ${
                                                darkMode ? 'border-gray-600 text-blue-300' : 'border-gray-300 text-blue-700'
                                              }`}>
                                                {linha.resultado}
                                              </td>
                                              {Object.keys(linha)
                                                .filter(key => key !== 'resultado')
                                                .map(key => (
                                                  <td key={key} className={`border p-2 ${
                                                    darkMode ? 'border-gray-600 text-gray-300' : 'border-gray-300 text-gray-700'
                                                  }`}>
                                                    {linha[key]}
                                                  </td>
                                                ))}
                                            </tr>
                                          ))}
                                        </tbody>
                                      </table>
                                    </div>
                                  )}
                                </div>
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Habilidadedex */}
          {encyclopediaSection === 'Habilidadedex' && (
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-8`}>
              <h3 className={`text-2xl sm:text-3xl font-bold mb-6 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                Habilidadedex
              </h3>
              <p className={`mb-6 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                Pesquise até 8 habilidades simultaneamente para comparar suas características
              </p>

              {/* Grid 4x2 de Barras de Pesquisa */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-3 sm:p-5 md:p-6 mb-8">
                {habilidadedexSearches.map((search, index) => (
                  <div key={index} className="relative">
                    <label className={`block text-sm font-semibold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      Habilidade #{index + 1}
                    </label>
                    <div className="relative">
                      <Search className={`absolute left-3 top-1/2 transform -translate-y-1/2 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`} size={20} />
                      <input
                        type="text"
                        value={search}
                        onChange={(e) => {
                          const newSearches = [...habilidadedexSearches]
                          newSearches[index] = e.target.value
                          setHabilidadedexSearches(newSearches)
                        }}
                        placeholder="Digite o nome da habilidade..."
                        className={`w-full pl-10 pr-4 py-3 rounded-lg border-2 ${
                          darkMode
                            ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-500 focus:border-teal-500'
                            : 'bg-white border-gray-300 text-gray-800 placeholder-gray-400 focus:border-teal-500'
                        } focus:outline-none transition-all`}
                        list={`habilidades-datalist-${index}`}
                      />
                      <datalist id={`habilidades-datalist-${index}`}>
                        {HABILIDADES_NAMES.filter(nome =>
                          nome.toLowerCase().includes(search.toLowerCase())
                        ).slice(0, 50).map(nome => (
                          <option key={nome} value={nome} />
                        ))}
                      </datalist>
                      {search && (
                        <button
                          onClick={() => {
                            const newSearches = [...habilidadedexSearches]
                            newSearches[index] = ''
                            setHabilidadedexSearches(newSearches)
                          }}
                          className={`absolute right-3 top-1/2 transform -translate-y-1/2 ${
                            darkMode ? 'text-gray-500 hover:text-gray-300' : 'text-gray-400 hover:text-gray-600'
                          }`}
                        >
                          <X size={20} />
                        </button>
                      )}
                    </div>

                    {/* Exibir informações da habilidade se selecionada */}
                    {search && HABILIDADES_DATA[search] && (
                      <div className={`mt-3 p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                        <div className="space-y-2">
                          <div className="flex items-center gap-2">
                            <span className={`px-3 py-1 rounded-full text-xs font-bold ${darkMode ? 'bg-teal-900 text-teal-300' : 'bg-teal-100 text-teal-800'}`}>
                              {HABILIDADES_DATA[search].ativacao || 'N/A'}
                            </span>
                          </div>

                          <div className={`pt-2 border-t ${darkMode ? 'border-gray-600' : 'border-gray-300'}`}>
                            <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                              <span className="font-semibold">Efeito:</span> {HABILIDADES_DATA[search].efeito}
                            </p>

                            {/* Tabela da Habilidade (se houver) */}
                            {HABILIDADES_DATA[search].tabela && (
                              <div className="mt-3 overflow-x-auto">
                                <table className={`w-full text-sm border-collapse ${
                                  darkMode ? 'border-gray-600' : 'border-gray-300'
                                }`}>
                                  <thead>
                                    <tr className={darkMode ? 'bg-gray-800' : 'bg-teal-100'}>
                                      {/* Cabeçalhos dinâmicos baseados nas colunas da tabela */}
                                      {Object.keys(HABILIDADES_DATA[search].tabela[0]).map(key => (
                                        <th key={key} className={`border p-2 font-semibold text-left ${
                                          darkMode ? 'border-gray-600 text-teal-300' : 'border-gray-300 text-teal-900'
                                        }`}>
                                          {key === 'resultado' ? 'Resultado' :
                                           key === 'efeito' ? 'Efeito' :
                                           key === 'item' ? 'Item' :
                                           key === 'clima' ? 'Clima' :
                                           key === 'tipo' ? 'Tipo' :
                                           key === 'dado' ? 'Dado' :
                                           key.charAt(0).toUpperCase() + key.slice(1)}
                                        </th>
                                      ))}
                                    </tr>
                                  </thead>
                                  <tbody>
                                    {HABILIDADES_DATA[search].tabela.map((linha, idx) => (
                                      <tr key={idx} className={idx % 2 === 0
                                        ? (darkMode ? 'bg-gray-750' : 'bg-white')
                                        : (darkMode ? 'bg-gray-700' : 'bg-teal-50')
                                      }>
                                        {Object.keys(linha).map(key => (
                                          <td key={key} className={`border p-2 ${
                                            key === 'resultado'
                                              ? `font-bold ${darkMode ? 'border-gray-600 text-teal-400' : 'border-gray-300 text-teal-700'}`
                                              : `${darkMode ? 'border-gray-600 text-gray-300' : 'border-gray-300 text-gray-700'}`
                                          }`}>
                                            {linha[key]}
                                          </td>
                                        ))}
                                      </tr>
                                    ))}
                                  </tbody>
                                </table>
                              </div>
                            )}
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Capacidadex */}
          {encyclopediaSection === 'Capacidadex' && (
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-8`}>
              <h3 className={`text-2xl sm:text-3xl font-bold mb-6 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                Capacidadex
              </h3>
              <p className={`mb-6 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                Pesquise até 8 capacidades simultaneamente para comparar suas características
              </p>

              {/* Grid 4x2 de Barras de Pesquisa */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-3 sm:p-5 md:p-6 mb-8">
                {capacidadexSearches.map((search, index) => (
                  <div key={index} className="relative">
                    <label className={`block text-sm font-semibold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      Capacidade #{index + 1}
                    </label>
                    <div className="relative">
                      <Search className={`absolute left-3 top-1/2 transform -translate-y-1/2 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`} size={20} />
                      <input
                        type="text"
                        value={search}
                        onChange={(e) => {
                          const newSearches = [...capacidadexSearches]
                          newSearches[index] = e.target.value
                          setCapacidadexSearches(newSearches)
                        }}
                        placeholder="Digite o nome da capacidade..."
                        className={`w-full pl-10 pr-4 py-3 rounded-lg border-2 ${
                          darkMode
                            ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-500 focus:border-indigo-500'
                            : 'bg-white border-gray-300 text-gray-800 placeholder-gray-400 focus:border-indigo-500'
                        } focus:outline-none transition-all`}
                        list={`capacidades-datalist-${index}`}
                      />
                      <datalist id={`capacidades-datalist-${index}`}>
                        {CAPACIDADES_NAMES.filter(nome =>
                          nome.toLowerCase().includes(search.toLowerCase())
                        ).slice(0, 50).map(nome => (
                          <option key={nome} value={nome} />
                        ))}
                      </datalist>
                      {search && (
                        <button
                          onClick={() => {
                            const newSearches = [...capacidadexSearches]
                            newSearches[index] = ''
                            setCapacidadexSearches(newSearches)
                          }}
                          className={`absolute right-3 top-1/2 transform -translate-y-1/2 ${
                            darkMode ? 'text-gray-500 hover:text-gray-300' : 'text-gray-400 hover:text-gray-600'
                          }`}
                        >
                          <X size={20} />
                        </button>
                      )}
                    </div>

                    {/* Exibir informações da capacidade se selecionada */}
                    {search && CAPACIDADES_DATA[search] && (
                      <div className={`mt-3 p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                        <div className="space-y-2">
                          <div className={`pt-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                            <p className={`text-sm leading-relaxed`}>
                              {typeof CAPACIDADES_DATA[search] === 'string'
                                ? CAPACIDADES_DATA[search]
                                : CAPACIDADES_DATA[search].descricao}
                            </p>

                            {/* Tabela da Capacidade (se houver) */}
                            {typeof CAPACIDADES_DATA[search] === 'object' && CAPACIDADES_DATA[search].tabela && (
                              <div className="mt-3 overflow-x-auto">
                                <table className={`w-full text-sm border-collapse ${
                                  darkMode ? 'border-gray-600' : 'border-gray-300'
                                }`}>
                                  <thead>
                                    <tr className={darkMode ? 'bg-gray-800' : 'bg-teal-100'}>
                                      {/* Cabeçalhos dinâmicos baseados nas colunas da tabela */}
                                      {Object.keys(CAPACIDADES_DATA[search].tabela[0]).map(key => (
                                        <th key={key} className={`border p-2 font-semibold text-left ${
                                          darkMode ? 'border-gray-600 text-teal-300' : 'border-gray-300 text-teal-900'
                                        }`}>
                                          {key === 'força' ? 'Força' :
                                           key === 'peso' ? 'Peso Erguido' :
                                           key === 'inteligência' ? 'Inteligência' :
                                           key === 'intelecto' ? 'Intelecto' :
                                           key === 'pensamentos' ? 'Pensamentos' :
                                           key === 'salto' ? 'Salto' :
                                           key === 'altura' ? 'Altura' :
                                           key === 'resultado' ? 'Resultado' :
                                           key === 'área' ? 'Área' :
                                           key === 'par' ? 'Par de Espécies' :
                                           key === 'condição' ? 'Condição' :
                                           key.charAt(0).toUpperCase() + key.slice(1)}
                                        </th>
                                      ))}
                                    </tr>
                                  </thead>
                                  <tbody>
                                    {CAPACIDADES_DATA[search].tabela.map((linha, idx) => (
                                      <tr key={idx} className={idx % 2 === 0
                                        ? (darkMode ? 'bg-gray-750' : 'bg-white')
                                        : (darkMode ? 'bg-gray-700' : 'bg-teal-50')
                                      }>
                                        {Object.keys(linha).map(key => (
                                          <td key={key} className={`border p-2 ${
                                            ['força', 'inteligência', 'salto', 'resultado'].includes(key)
                                              ? `font-bold ${darkMode ? 'border-gray-600 text-teal-400' : 'border-gray-300 text-teal-700'}`
                                              : `${darkMode ? 'border-gray-600 text-gray-300' : 'border-gray-300 text-gray-700'}`
                                          }`}>
                                            {linha[key]}
                                          </td>
                                        ))}
                                      </tr>
                                    ))}
                                  </tbody>
                                </table>
                              </div>
                            )}
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Condiçõesdex */}
          {encyclopediaSection === 'Condiçõesdex' && (
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-8`}>
              <h3 className={`text-2xl sm:text-3xl font-bold mb-6 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                Condiçõesdex
              </h3>
              <p className={`mb-6 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                Clique em uma condição para expandir e ver suas informações detalhadas
              </p>

              {/* Lista de Condições em coluna única */}
              <div className="grid grid-cols-1 gap-2 sm:gap-3 md:gap-4">
                {condicoes.map((condicao) => {
                  const isExpanded = expandedCondicoes.includes(condicao.nome)

                  return (
                    <div
                      key={condicao.nome}
                      className={`${
                        darkMode ? 'bg-gray-700' : 'bg-gray-100'
                      } rounded-lg overflow-hidden transition-all`}
                    >
                      <button
                        onClick={() => {
                          if (isExpanded) {
                            setExpandedCondicoes(expandedCondicoes.filter(nome => nome !== condicao.nome))
                          } else {
                            setExpandedCondicoes([...expandedCondicoes, condicao.nome])
                          }
                        }}
                        className={`w-full p-4 text-left flex justify-between items-center ${
                          darkMode ? 'hover:bg-gray-600' : 'hover:bg-gray-200'
                        } transition-colors`}
                      >
                        <span className={`font-bold text-lg ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                          {condicao.nome}
                        </span>
                        {isExpanded ? (
                          <ChevronUp className={darkMode ? 'text-gray-300' : 'text-gray-600'} size={24} />
                        ) : (
                          <ChevronDown className={darkMode ? 'text-gray-300' : 'text-gray-600'} size={24} />
                        )}
                      </button>

                      {isExpanded && (
                        <div className={`p-3 sm:p-5 md:p-6 ${darkMode ? 'bg-gray-750' : 'bg-white'} border-t ${darkMode ? 'border-gray-600' : 'border-gray-300'}`}>
                          <p className={`${darkMode ? 'text-gray-300' : 'text-gray-700'} leading-relaxed mb-4`}>
                            {condicao.descricao}
                          </p>

                          {condicao.tabela && (
                            <div className="mt-4">
                              <h4 className={`font-bold text-lg mb-3 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                {condicao.tabela.titulo}
                              </h4>
                              <div className="overflow-x-auto">
                                <table className={`w-full border ${darkMode ? 'border-gray-600' : 'border-gray-300'}`}>
                                  <thead>
                                    <tr className={darkMode ? 'bg-gray-600' : 'bg-gray-200'}>
                                      {condicao.tabela.colunas.map((coluna, idx) => (
                                        <th
                                          key={idx}
                                          className={`px-4 py-2 text-left font-semibold ${
                                            darkMode ? 'text-white' : 'text-gray-800'
                                          } border ${darkMode ? 'border-gray-600' : 'border-gray-300'}`}
                                        >
                                          {coluna}
                                        </th>
                                      ))}
                                    </tr>
                                  </thead>
                                  <tbody>
                                    {condicao.tabela.linhas.map((linha, idx) => (
                                      <tr
                                        key={idx}
                                        className={`${
                                          idx % 2 === 0
                                            ? darkMode ? 'bg-gray-700' : 'bg-gray-50'
                                            : darkMode ? 'bg-gray-750' : 'bg-white'
                                        }`}
                                      >
                                        {linha.map((celula, cellIdx) => (
                                          <td
                                            key={cellIdx}
                                            className={`px-4 py-2 ${
                                              darkMode ? 'text-gray-300' : 'text-gray-700'
                                            } border ${darkMode ? 'border-gray-600' : 'border-gray-300'}`}
                                          >
                                            {celula}
                                          </td>
                                        ))}
                                      </tr>
                                    ))}
                                  </tbody>
                                </table>
                              </div>
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                  )
                })}
              </div>
            </div>
          )}

          {/* Itendex */}
          {encyclopediaSection === 'Itendex' && (
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-8`}>
              <h3 className={`text-2xl sm:text-3xl font-bold mb-6 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                Itendex
              </h3>
              <p className={`mb-6 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                Catálogo completo de itens disponíveis na Pokéloja. Clique em um corredor para expandir.
              </p>

              {/* Lista de itens por corredor */}
              <div className="space-y-4">
                {Object.entries(POKELOJA_DATA).map(([corredor, itens]) => {
                  const isExpanded = expandedItendexCorredores.includes(corredor)
                  return (
                    <div key={corredor} className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} rounded-lg overflow-hidden`}>
                      <button
                        onClick={() => {
                          if (isExpanded) {
                            setExpandedItendexCorredores(expandedItendexCorredores.filter(c => c !== corredor))
                          } else {
                            setExpandedItendexCorredores([...expandedItendexCorredores, corredor])
                          }
                        }}
                        className={`w-full p-4 text-left flex justify-between items-center ${darkMode ? 'hover:bg-gray-600' : 'hover:bg-gray-200'} transition-colors`}
                      >
                        <h4 className={`text-lg sm:text-xl font-bold ${darkMode ? 'text-purple-400' : 'text-purple-600'}`}>
                          Corredor de {corredor}
                          <span className={`ml-2 text-sm font-normal ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                            ({itens.length} itens)
                          </span>
                        </h4>
                        {isExpanded ? (
                          <ChevronUp className={darkMode ? 'text-gray-300' : 'text-gray-600'} size={24} />
                        ) : (
                          <ChevronDown className={darkMode ? 'text-gray-300' : 'text-gray-600'} size={24} />
                        )}
                      </button>

                      {isExpanded && (
                        <div className={`p-4 border-t ${darkMode ? 'border-gray-600 bg-gray-750' : 'border-gray-300 bg-white'}`}>
                          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 sm:gap-3 md:gap-4">
                            {itens.map((item) => (
                              <div
                                key={item.name}
                                className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} rounded-lg p-4 flex gap-2 sm:gap-3 md:gap-4`}
                              >
                                <img
                                  src={item.image}
                                  alt={item.name}
                                  className="w-16 h-16 object-contain flex-shrink-0"
                                  onError={(e) => { e.target.src = '/pokeballs/pokeball.png' }}
                                />
                                <div className="flex-1 min-w-0">
                                  <h5 className={`font-bold text-lg ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                    {item.name}{item.realName ? ` (${item.realName})` : ''}
                                  </h5>
                                  {item.price != null && corredor !== 'Apricorns e Bonsais' && corredor !== 'Pokesucos' && (
                                    <p className={`text-sm ${darkMode ? 'text-yellow-400' : 'text-yellow-600'} font-semibold`}>
                                      ₽ {(customPrices[item.name] !== undefined ? customPrices[item.name] : item.price).toLocaleString()}
                                    </p>
                                  )}
                                  {item.description && (
                                    <p className={`text-sm mt-2 ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                                      {renderDescriptionWithFlavors(item.description)}
                                    </p>
                                  )}
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}
                    </div>
                  )
                })}
              </div>
            </div>
          )}

          {/* Progressão de nível */}
          {encyclopediaSection === 'Progressão de nível' && (
            <div
              className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-8`}
              onClick={(e) => {
                // Limpar destaques se clicar fora da tabela
                if (!e.target.closest('table')) {
                  setHighlightedProgressaoRows([])
                }
              }}
            >
              <h3 className={`text-2xl sm:text-3xl font-bold mb-6 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                Progressão de nível
              </h3>
              <p className={`mb-6 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                Tabela de progressão de nível do treinador, mostrando os pontos de atributo e talentos ganhos a cada nível. Clique em uma linha para destacá-la.
              </p>

              <div className="overflow-x-auto">
                <table className={`w-full border-collapse ${darkMode ? 'bg-gray-700' : 'bg-white'}`}>
                  <thead>
                    <tr className={darkMode ? 'bg-gray-600' : 'bg-gray-200'}>
                      <th className={`border p-2 text-center ${darkMode ? 'border-gray-500 text-white' : 'border-gray-300'}`}>Nível</th>
                      <th className={`border p-2 text-center ${darkMode ? 'border-gray-500 text-white' : 'border-gray-300'}`}>Ponto de Atributo</th>
                      <th className={`border p-2 text-center ${darkMode ? 'border-gray-500 text-white' : 'border-gray-300'}`}>Pontos de Talento</th>
                      <th className={`border p-2 text-center ${darkMode ? 'border-gray-500 text-white' : 'border-gray-300'}`}>Total de Pts de Atributo</th>
                      <th className={`border p-2 text-center ${darkMode ? 'border-gray-500 text-white' : 'border-gray-300'}`}>Total de Pts de Talento</th>
                    </tr>
                  </thead>
                  <tbody>
                    {[
                      { nivel: 0, ptoAtributo: '0', ptosTalento: '0', totalAtributo: 66, totalTalento: 0 },
                      { nivel: 1, ptoAtributo: '+1', ptosTalento: '+1', totalAtributo: 67, totalTalento: 1 },
                      { nivel: 2, ptoAtributo: '+1', ptosTalento: '+1', totalAtributo: 68, totalTalento: 2 },
                      { nivel: 3, ptoAtributo: '+1', ptosTalento: '+1', totalAtributo: 69, totalTalento: 3 },
                      { nivel: 4, ptoAtributo: '+1', ptosTalento: '+1', totalAtributo: 70, totalTalento: 4 },
                      { nivel: 5, ptoAtributo: '+1', ptosTalento: '+1', totalAtributo: 71, totalTalento: 5 },
                      { nivel: 6, ptoAtributo: '+1', ptosTalento: '+1', totalAtributo: 72, totalTalento: 6 },
                      { nivel: 7, ptoAtributo: '0', ptosTalento: '+1', totalAtributo: 72, totalTalento: 7 },
                      { nivel: 8, ptoAtributo: '+1', ptosTalento: '+1', totalAtributo: 73, totalTalento: 8 },
                      { nivel: 9, ptoAtributo: '0', ptosTalento: '+1', totalAtributo: 73, totalTalento: 9 },
                      { nivel: 10, ptoAtributo: '+2', ptosTalento: '+1', totalAtributo: 75, totalTalento: 10 },
                      { nivel: 11, ptoAtributo: '0', ptosTalento: '+1', totalAtributo: 75, totalTalento: 11 },
                      { nivel: 12, ptoAtributo: '+1', ptosTalento: '0', totalAtributo: 76, totalTalento: 11 },
                      { nivel: 13, ptoAtributo: '0', ptosTalento: '+1', totalAtributo: 76, totalTalento: 12 },
                      { nivel: 14, ptoAtributo: '+2', ptosTalento: '0', totalAtributo: 78, totalTalento: 12 },
                      { nivel: 15, ptoAtributo: '0', ptosTalento: '+1', totalAtributo: 78, totalTalento: 13 },
                      { nivel: 16, ptoAtributo: '+1', ptosTalento: '0', totalAtributo: 79, totalTalento: 13 },
                      { nivel: 17, ptoAtributo: '0', ptosTalento: '+1', totalAtributo: 79, totalTalento: 14 },
                      { nivel: 18, ptoAtributo: '+2', ptosTalento: '0', totalAtributo: 81, totalTalento: 14 },
                      { nivel: 19, ptoAtributo: '0', ptosTalento: '+1', totalAtributo: 81, totalTalento: 15 },
                      { nivel: 20, ptoAtributo: '+1', ptosTalento: '0', totalAtributo: 82, totalTalento: 15 },
                      { nivel: 21, ptoAtributo: '0', ptosTalento: '+1', totalAtributo: 82, totalTalento: 16 },
                      { nivel: 22, ptoAtributo: '+2', ptosTalento: '0', totalAtributo: 84, totalTalento: 16 },
                      { nivel: 23, ptoAtributo: '0', ptosTalento: '+1', totalAtributo: 84, totalTalento: 17 },
                      { nivel: 24, ptoAtributo: '+1', ptosTalento: '0', totalAtributo: 85, totalTalento: 17 },
                      { nivel: 25, ptoAtributo: '0', ptosTalento: '+1', totalAtributo: 85, totalTalento: 18 },
                      { nivel: 26, ptoAtributo: '+2', ptosTalento: '0', totalAtributo: 87, totalTalento: 18 },
                      { nivel: 27, ptoAtributo: '0', ptosTalento: '+1', totalAtributo: 87, totalTalento: 19 },
                      { nivel: 28, ptoAtributo: '+1', ptosTalento: '0', totalAtributo: 88, totalTalento: 19 },
                      { nivel: 29, ptoAtributo: '0', ptosTalento: '+1', totalAtributo: 88, totalTalento: 20 },
                      { nivel: 30, ptoAtributo: '+2', ptosTalento: '0', totalAtributo: 90, totalTalento: 20 },
                      { nivel: 31, ptoAtributo: '0', ptosTalento: '+1', totalAtributo: 90, totalTalento: 21 },
                      { nivel: 32, ptoAtributo: '+1', ptosTalento: '0', totalAtributo: 91, totalTalento: 21 },
                      { nivel: 33, ptoAtributo: '0', ptosTalento: '+1', totalAtributo: 91, totalTalento: 22 },
                      { nivel: 34, ptoAtributo: '+2', ptosTalento: '0', totalAtributo: 93, totalTalento: 22 },
                      { nivel: 35, ptoAtributo: '0', ptosTalento: '+1', totalAtributo: 93, totalTalento: 23 },
                      { nivel: 36, ptoAtributo: '+1', ptosTalento: '0', totalAtributo: 94, totalTalento: 23 },
                      { nivel: 37, ptoAtributo: '0', ptosTalento: '+1', totalAtributo: 94, totalTalento: 24 },
                      { nivel: 38, ptoAtributo: '+2', ptosTalento: '0', totalAtributo: 96, totalTalento: 24 },
                      { nivel: 39, ptoAtributo: '0', ptosTalento: '+1', totalAtributo: 96, totalTalento: 25 },
                      { nivel: 40, ptoAtributo: '+1', ptosTalento: '0', totalAtributo: 97, totalTalento: 25 },
                      { nivel: 41, ptoAtributo: '0', ptosTalento: '+1', totalAtributo: 97, totalTalento: 26 },
                      { nivel: 42, ptoAtributo: '+2', ptosTalento: '0', totalAtributo: 99, totalTalento: 26 },
                      { nivel: 43, ptoAtributo: '0', ptosTalento: '+1', totalAtributo: 99, totalTalento: 27 },
                      { nivel: 44, ptoAtributo: '+1', ptosTalento: '0', totalAtributo: 100, totalTalento: 27 },
                      { nivel: 45, ptoAtributo: '0', ptosTalento: '+1', totalAtributo: 100, totalTalento: 28 },
                      { nivel: 46, ptoAtributo: '+2', ptosTalento: '0', totalAtributo: 102, totalTalento: 28 },
                      { nivel: 47, ptoAtributo: '0', ptosTalento: '+1', totalAtributo: 102, totalTalento: 29 },
                      { nivel: 48, ptoAtributo: '+1', ptosTalento: '0', totalAtributo: 103, totalTalento: 29 },
                      { nivel: 49, ptoAtributo: '0', ptosTalento: '+1', totalAtributo: 103, totalTalento: 30 },
                      { nivel: 50, ptoAtributo: '+3', ptosTalento: '0', totalAtributo: 106, totalTalento: 30 }
                    ].map((row, index) => {
                      const isHighlighted = highlightedProgressaoRows.includes(row.nivel)
                      return (
                        <tr
                          key={row.nivel}
                          onClick={(e) => {
                            e.stopPropagation()
                            if (isHighlighted) {
                              setHighlightedProgressaoRows(highlightedProgressaoRows.filter(n => n !== row.nivel))
                            } else {
                              setHighlightedProgressaoRows([...highlightedProgressaoRows, row.nivel])
                            }
                          }}
                          className={`cursor-pointer transition-all ${
                            isHighlighted
                              ? (darkMode ? 'bg-yellow-600 hover:bg-yellow-500' : 'bg-yellow-300 hover:bg-yellow-400')
                              : (index % 2 === 0 ? (darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-white hover:bg-gray-100') : (darkMode ? 'bg-gray-650 hover:bg-gray-600' : 'bg-gray-50 hover:bg-gray-100'))
                          }`}
                        >
                          <td className={`border p-2 text-center font-bold ${darkMode ? 'border-gray-500 text-white' : 'border-gray-300'}`}>
                            <span className={isHighlighted ? `px-2 py-1 rounded ${darkMode ? 'bg-gray-700' : 'bg-gray-200'}` : ''}>{row.nivel}{[1, 5, 12, 24].includes(row.nivel) ? ' ⭐' : ''}</span>
                          </td>
                          <td className={`border p-2 text-center ${darkMode ? 'border-gray-500 text-blue-400' : 'border-gray-300 text-blue-600'}`}>
                            <span className={isHighlighted ? `px-2 py-1 rounded ${darkMode ? 'bg-gray-700' : 'bg-gray-200'}` : ''}>{row.ptoAtributo}</span>
                          </td>
                          <td className={`border p-2 text-center ${darkMode ? 'border-gray-500 text-purple-400' : 'border-gray-300 text-purple-600'}`}>
                            <span className={isHighlighted ? `px-2 py-1 rounded ${darkMode ? 'bg-gray-700' : 'bg-gray-200'}` : ''}>{row.ptosTalento}</span>
                          </td>
                          <td className={`border p-2 text-center font-semibold ${darkMode ? 'border-gray-500 text-yellow-400' : 'border-gray-300 text-yellow-600'}`}>
                            <span className={isHighlighted ? `px-2 py-1 rounded ${darkMode ? 'bg-gray-700' : 'bg-gray-200'}` : ''}>{row.totalAtributo}</span>
                          </td>
                          <td className={`border p-2 text-center font-semibold ${darkMode ? 'border-gray-500 text-pink-400' : 'border-gray-300 text-pink-600'}`}>
                            <span className={isHighlighted ? `px-2 py-1 rounded ${darkMode ? 'bg-gray-700' : 'bg-gray-200'}` : ''}>{row.totalTalento}</span>
                          </td>
                        </tr>
                      )
                    })}
                  </tbody>
                </table>
              </div>
            </div>
          )}
        </div>
        </div>
        {accountDataModal}
        {scenarioPopupOverlay}
        {mostrarTriunfosOverlay}
        {pokezapPanel}{pokeAgendaPanel}
        {batalhaChatPanel}
      </>
    )
  }

  // ÁREA PROGRESSÃO
  if (currentUser.type === 'treinador' && currentArea === 'Progressão') {
    const handleAddVivencia = () => {
      if (!novaVivenciaNome.trim() || !novaVivenciaEfeito.trim()) {
        alert('Nome e Efeito são obrigatórios!')
        return
      }

      if (editingVivenciaId) {
        setVivencias(vivencias.map(v => v.id === editingVivenciaId ? {
          ...v,
          nome: novaVivenciaNome.trim(),
          frequencia: novaVivenciaFrequencia.trim(),
          alvo: novaVivenciaAlvo.trim(),
          gatilho: novaVivenciaGatilho.trim(),
          efeito: novaVivenciaEfeito.trim()
        } : v))
      } else {
        const newVivencia = {
          id: Date.now(),
          nome: novaVivenciaNome.trim(),
          frequencia: novaVivenciaFrequencia.trim(),
          alvo: novaVivenciaAlvo.trim(),
          gatilho: novaVivenciaGatilho.trim(),
          efeito: novaVivenciaEfeito.trim()
        }
        setVivencias([...vivencias, newVivencia])
      }

      setShowNovaVivenciaModal(false)
      setEditingVivenciaId(null)
      setNovaVivenciaNome('')
      setNovaVivenciaFrequencia('')
      setNovaVivenciaAlvo('')
      setNovaVivenciaGatilho('')
      setNovaVivenciaEfeito('')
    }

    return (
      <>
        <div className={`min-h-screen ${mainBgClass}`}>
          {sidebarNav}
        <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-lg`}>
          <div className="max-w-7xl mx-auto px-4 py-4">
            <div className="flex justify-between items-center mb-4">
              <div className="flex items-center gap-3"><button onClick={() => setSidebarOpen(true)} className={`p-2 rounded-lg ${darkMode ? "hover:bg-gray-700 text-gray-400" : "hover:bg-gray-200 text-gray-500"}`}><Menu size={24} /></button><h2 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Progressão</h2></div>
              <div className="flex gap-2 items-center">
                <button onClick={() => setDarkMode(!darkMode)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-yellow-400' : 'bg-gray-200 text-gray-700'}`}>
                  {darkMode ? <Sun size={20} /> : <Moon size={20} />}
                </button>
                {pokezapBtn}{pokeAgendaBtn}{batalhaChatBtn}<button onClick={handleLogout} className="bg-red-500 text-white px-3 sm:px-5 md:px-6 py-2 rounded-lg hover:bg-red-600">Sair</button>
                {currentClima && <div className="flex items-center gap-1.5 ml-1"><img src={`/pokeballs/${currentClima.image}`} alt={currentClima.name} className="w-7 h-7" /><span className={`text-xs font-semibold ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>{currentClima.name}</span></div>}
              </div>
            </div>
          </div>
        </div>

        {/* Navegação de Subáreas */}
        <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-md`}>
          <div className="max-w-7xl mx-auto px-4 py-3">
            <div className="flex flex-wrap gap-2">
              <button
                onClick={() => setProgressaoSection('Vivências')}
                className={`px-4 py-2 rounded-lg text-sm font-semibold transition-all ${
                  progressaoSection === 'Vivências'
                    ? 'bg-gradient-to-r from-green-600 to-emerald-600 text-white shadow-lg'
                    : darkMode
                    ? 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                    : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                }`}
              >
                Vivências
              </button>
              <button
                onClick={() => setProgressaoSection('Diário da Jornada')}
                className={`px-4 py-2 rounded-lg text-sm font-semibold transition-all ${
                  progressaoSection === 'Diário da Jornada'
                    ? 'bg-gradient-to-r from-amber-600 to-yellow-600 text-white shadow-lg'
                    : darkMode
                    ? 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                    : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                }`}
              >
                Diário da Jornada
              </button>
              <button
                onClick={() => setProgressaoSection('Background')}
                className={`px-4 py-2 rounded-lg text-sm font-semibold transition-all ${
                  progressaoSection === 'Background'
                    ? 'bg-gradient-to-r from-purple-600 to-indigo-600 text-white shadow-lg'
                    : darkMode
                    ? 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                    : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                }`}
              >
                Background
              </button>
              <button
                onClick={() => setProgressaoSection('XP & Capturas')}
                className={`px-4 py-2 rounded-lg text-sm font-semibold transition-all ${
                  progressaoSection === 'XP & Capturas'
                    ? 'bg-gradient-to-r from-cyan-600 to-blue-600 text-white shadow-lg'
                    : darkMode
                    ? 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                    : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                }`}
              >
                XP & Capturas
              </button>
              <button
                onClick={() => {
                  // Gerar conteúdo do arquivo TXT
                  let content = `=== HISTÓRIA DE ${currentUser.username.toUpperCase()} ===\n\n`

                  if (background && background.trim()) {
                    content += background + '\n\n'
                  } else {
                    content += '(Nenhuma história escrita ainda)\n\n'
                  }

                  content += '\n' + '='.repeat(50) + '\n'
                  content += 'CONQUISTAS\n'
                  content += '='.repeat(50) + '\n\n'

                  // Apenas conquistas da linha do tempo atual (não as arquivadas em ciclos)
                  if (conquistas.length > 0) {
                    conquistas.forEach((conquista, index) => {
                      content += `${index + 1}. ${conquista.nome}\n`
                      if (conquista.descricao && conquista.descricao.trim()) {
                        content += `   ${conquista.descricao}\n`
                      }
                      content += '\n'
                    })
                  } else {
                    content += '(Nenhuma conquista registrada ainda)\n'
                  }

                  // Criar blob e fazer download
                  const blob = new Blob([content], { type: 'text/plain;charset=utf-8' })
                  const url = URL.createObjectURL(blob)
                  const link = document.createElement('a')
                  link.href = url
                  link.download = `${currentUser.username}_historia.txt`
                  document.body.appendChild(link)
                  link.click()
                  document.body.removeChild(link)
                  URL.revokeObjectURL(url)
                }}
                className={`p-2 rounded-lg transition-all ${
                  darkMode
                    ? 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                    : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                }`}
                title="Download História"
              >
                <BookType size={20} />
              </button>
            </div>
          </div>
        </div>

        <div className="max-w-7xl mx-auto px-4 py-3 sm:py-5 md:py-8">
          {/* VIVÊNCIAS */}
          {progressaoSection === 'Vivências' && (
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-6`}>
              <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 sm:gap-0 mb-4 sm:mb-6">
                <h3 className={`text-xl sm:text-2xl md:text-3xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  Vivências
                </h3>
                <button
                  onClick={() => {
                    setEditingVivenciaId(null)
                    setNovaVivenciaNome('')
                    setNovaVivenciaFrequencia('')
                    setNovaVivenciaAlvo('')
                    setNovaVivenciaGatilho('')
                    setNovaVivenciaEfeito('')
                    setShowNovaVivenciaModal(true)
                  }}
                  className="w-full sm:w-auto bg-gradient-to-r from-green-600 to-emerald-600 text-white px-3 sm:px-5 md:px-6 py-2.5 sm:py-3 rounded-lg hover:from-green-700 hover:to-emerald-700 font-semibold flex items-center justify-center gap-2 shadow-lg text-sm sm:text-base"
                >
                  <Plus size={18} className="sm:w-5 sm:h-5" />
                  Nova Vivência
                </button>
              </div>

              {vivencias.length === 0 ? (
                <div className={`text-center py-8 sm:py-12 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                  <p className="text-base sm:text-lg">Nenhuma vivência cadastrada</p>
                  <p className="text-xs sm:text-sm mt-2">Clique em "Nova Vivência" para adicionar</p>
                </div>
              ) : (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
                  {vivencias.map((vivencia) => (
                    <div key={vivencia.id} className={`rounded-lg border-2 transition-all ${
                      expandedVivencia === vivencia.id
                        ? darkMode
                          ? 'bg-gray-700 border-green-500'
                          : 'bg-green-50 border-green-500'
                        : darkMode
                        ? 'bg-gray-700 border-gray-600 hover:border-gray-500'
                        : 'bg-white border-gray-300 hover:border-gray-400'
                    }`}>
                      <div className="flex items-center justify-between p-3 sm:p-4">
                        <button
                          onClick={() => setExpandedVivencia(expandedVivencia === vivencia.id ? null : vivencia.id)}
                          className="flex-1 text-left"
                        >
                          <h4 className={`font-bold text-base sm:text-lg ${
                            expandedVivencia === vivencia.id
                              ? darkMode ? 'text-green-400' : 'text-green-700'
                              : darkMode ? 'text-white' : 'text-gray-800'
                          }`}>
                            {vivencia.nome}
                          </h4>
                        </button>
                        <button
                          onClick={() => {
                            setEditingVivenciaId(vivencia.id)
                            setNovaVivenciaNome(vivencia.nome)
                            setNovaVivenciaFrequencia(vivencia.frequencia || '')
                            setNovaVivenciaAlvo(vivencia.alvo || '')
                            setNovaVivenciaGatilho(vivencia.gatilho || '')
                            setNovaVivenciaEfeito(vivencia.efeito || '')
                            setShowNovaVivenciaModal(true)
                          }}
                          className={`ml-2 p-1 sm:p-1.5 rounded hover:bg-yellow-500 hover:text-white transition-colors ${
                            darkMode ? 'text-gray-400' : 'text-gray-500'
                          }`}
                          title="Editar vivência"
                        >
                          <Pencil size={16} className="sm:w-[18px] sm:h-[18px]" />
                        </button>
                        <button
                          onClick={() => {
                            if (confirm(`Deseja excluir a vivência "${vivencia.nome}"?`)) {
                              setVivencias(vivencias.filter(v => v.id !== vivencia.id))
                              if (expandedVivencia === vivencia.id) {
                                setExpandedVivencia(null)
                              }
                            }
                          }}
                          className={`ml-2 p-1 sm:p-1.5 rounded hover:bg-red-500 hover:text-white transition-colors ${
                            darkMode ? 'text-gray-400' : 'text-gray-500'
                          }`}
                          title="Excluir vivência"
                        >
                          <X size={18} className="sm:w-5 sm:h-5" />
                        </button>
                      </div>

                      {expandedVivencia === vivencia.id && (
                        <div className={`px-3 sm:px-4 pb-3 sm:pb-4 space-y-2 sm:space-y-3 text-sm sm:text-base ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                          {vivencia.frequencia && (
                            <div>
                              <span className="font-semibold">Frequência:</span> {vivencia.frequencia}
                            </div>
                          )}
                          {vivencia.alvo && (
                            <div>
                              <span className="font-semibold">Alvo:</span> {vivencia.alvo}
                            </div>
                          )}
                          {vivencia.gatilho && (
                            <div>
                              <span className="font-semibold">Gatilho:</span> {vivencia.gatilho}
                            </div>
                          )}
                          <div>
                            <span className="font-semibold">Efeito:</span> {vivencia.efeito}
                          </div>
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}

          {/* DIÁRIO DA JORNADA */}
          {progressaoSection === 'Diário da Jornada' && (
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-6`}>
              <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 sm:gap-0 mb-4 sm:mb-6">
                <h3 className={`text-xl sm:text-2xl md:text-3xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  Diário da Jornada
                </h3>
                {!selectedDiarioTrainer && (
                  <div className="flex flex-col sm:flex-row gap-2 sm:gap-3 w-full sm:w-auto">
                    <button
                      onClick={() => {
                        setConquistaEditando(null)
                        setNovaConquistaNome('')
                        setNovaConquistaLevelUp(false)
                        setNovaConquistaDescricao('')
                        setShowNovaConquistaModal(true)
                      }}
                      className="bg-gradient-to-r from-amber-600 to-yellow-600 text-white px-3 sm:px-5 md:px-6 py-2.5 sm:py-3 rounded-lg hover:from-amber-700 hover:to-yellow-700 font-semibold flex items-center justify-center gap-2 shadow-lg text-sm sm:text-base w-full sm:w-auto"
                    >
                      <Plus size={18} className="sm:w-5 sm:h-5" />
                      Conquistas
                    </button>
                    <button
                      onClick={() => {
                        setFimCicloVerdade('')
                        setShowFimCicloModal(true)
                      }}
                      className="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-3 sm:px-5 md:px-6 py-2.5 sm:py-3 rounded-lg hover:from-purple-700 hover:to-pink-700 font-semibold flex items-center justify-center gap-2 shadow-lg text-sm sm:text-base w-full sm:w-auto"
                    >
                      Fim do Ciclo
                    </button>
                  </div>
                )}
              </div>

              {/* Dropdown para selecionar treinador */}
              <div className="mb-6">
                <label className={`block text-xs sm:text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                  Ver Diário de:
                </label>
                <select
                  value={selectedDiarioTrainer}
                  onChange={(e) => setSelectedDiarioTrainer(e.target.value)}
                  className={`w-full px-3 py-2 sm:px-4 rounded-lg border-2 text-sm sm:text-base ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300 bg-white text-gray-800'}`}
                >
                  <option value="">Meu Diário</option>
                  {users.filter(u => u.type === 'treinador' && u.username !== currentUser.username).map(trainer => (
                    <option key={trainer.username} value={trainer.username}>{trainer.username}</option>
                  ))}
                </select>
              </div>

              {/* Linha do Tempo com Ciclos */}
              <div className="flex flex-col md:flex-row gap-3 md:gap-4">
                {/* Coluna de Ciclos - à esquerda */}
                {(() => {
                  // Determinar quais ciclos exibir
                  let ciclosToDisplay = ciclos
                  if (selectedDiarioTrainer && selectedDiarioData) {
                    ciclosToDisplay = selectedDiarioData?.ciclos || []
                  }

                  if (ciclosToDisplay.length === 0) return null

                  return (
                    <div className="flex flex-col gap-2 sm:gap-3 pt-0 md:pt-12 mb-6 md:mb-0 min-w-0 md:min-w-[120px]">
                      <p className={`text-xs sm:text-sm font-bold ${darkMode ? 'text-gray-400' : 'text-gray-500'} mb-1 sm:mb-2`}>Ciclos</p>
                      {ciclosToDisplay.map((ciclo, index) => (
                        <div key={ciclo.id} className="flex items-center gap-1">
                          <button
                            onClick={() => setSelectedCiclo(ciclo)}
                            className={`flex-1 px-2 py-1.5 sm:px-3 sm:py-2 rounded-l-lg text-xs sm:text-sm font-semibold transition-all hover:scale-105 ${
                              darkMode
                                ? 'bg-purple-900 hover:bg-purple-800 text-purple-200 border border-purple-700 border-r-0'
                                : 'bg-purple-100 hover:bg-purple-200 text-purple-800 border border-purple-300 border-r-0'
                            }`}
                            title={ciclo.verdade}
                          >
                            {ciclo.verdade.length > 12 ? ciclo.verdade.substring(0, 12) + '...' : ciclo.verdade}
                          </button>
                          {!selectedDiarioTrainer && (
                            <button
                              onClick={(e) => {
                                e.stopPropagation()
                                if (confirm(`Desfazer o ciclo "${ciclo.verdade}"? As conquistas voltarão para a linha do tempo principal.`)) {
                                  // Restaurar conquistas do ciclo para a linha do tempo
                                  setConquistas([...conquistas, ...ciclo.conquistas])
                                  // Remover o ciclo da lista
                                  setCiclos(ciclos.filter(c => c.id !== ciclo.id))
                                }
                              }}
                              className={`px-1.5 py-1.5 sm:px-2 sm:py-2 rounded-r-lg transition-all hover:scale-105 ${
                                darkMode
                                  ? 'bg-purple-900 hover:bg-red-700 text-purple-200 border border-purple-700 border-l-0'
                                  : 'bg-purple-100 hover:bg-red-200 text-purple-800 border border-purple-300 border-l-0'
                              }`}
                              title="Desfazer fim de ciclo"
                            >
                              <RotateCw size={12} className="sm:w-[14px] sm:h-[14px]" />
                            </button>
                          )}
                        </div>
                      ))}
                    </div>
                  )
                })()}

                {/* Linha do Tempo */}
                <div className="relative py-12 flex-1">
                  {(() => {
                    // Determinar quais conquistas exibir
                    let conquistasToDisplay = conquistas

                    if (selectedDiarioTrainer && selectedDiarioData) {
                      // Carregar conquistas do treinador selecionado
                      conquistasToDisplay = selectedDiarioData?.conquistas || []
                    }

                    return (
                      <>
                        {/* Ponto Inicial */}
                        <div className="relative mb-12 sm:mb-16">
                          <div className="flex items-center justify-center">
                            <div className={`${darkMode ? 'bg-gray-700 border-gray-500' : 'bg-white border-gray-400'} border-2 sm:border-4 rounded-full px-3 sm:px-4 md:px-6 py-2 sm:py-2.5 md:py-3 shadow-lg z-10`}>
                              <p className={`font-bold text-sm sm:text-base md:text-lg ${darkMode ? 'text-white' : 'text-gray-800'} text-center`}>
                                Qual o nome do meu neto?
                              </p>
                            </div>
                          </div>
                        </div>

                      {/* Linha vertical - só até antes do ponto final */}
                      {conquistasToDisplay.length > 0 && (
                        <div
                          className={`absolute left-1/2 transform -translate-x-1/2 w-1 ${darkMode ? 'bg-gray-600' : 'bg-gray-300'}`}
                          style={{
                            top: '6rem',
                            height: `calc(100% - 12rem)`
                          }}
                        ></div>
                      )}

                      {/* Conquistas */}
                      {conquistasToDisplay.map((conquista, index) => (
                        <div
                          key={conquista.id}
                          className={`relative mb-12 sm:mb-16 text-center ${index % 2 === 0 ? 'md:text-right md:pr-[52%]' : 'md:text-left md:pl-[52%]'} ${
                            !selectedDiarioTrainer ? 'cursor-grab active:cursor-grabbing' : ''
                          } ${draggingConquistaId === conquista.id ? 'opacity-50' : ''}`}
                          draggable={!selectedDiarioTrainer}
                          onDragStart={(e) => {
                            if (selectedDiarioTrainer) return
                            setDraggingConquistaId(conquista.id)
                            e.dataTransfer.effectAllowed = 'move'
                          }}
                          onDragOver={(e) => {
                            if (selectedDiarioTrainer) return
                            e.preventDefault()
                            e.dataTransfer.dropEffect = 'move'
                          }}
                          onDrop={(e) => {
                            if (selectedDiarioTrainer) return
                            e.preventDefault()
                            if (draggingConquistaId && draggingConquistaId !== conquista.id) {
                              const dragIndex = conquistas.findIndex(c => c.id === draggingConquistaId)
                              const dropIndex = conquistas.findIndex(c => c.id === conquista.id)
                              if (dragIndex !== -1 && dropIndex !== -1) {
                                const newConquistas = [...conquistas]
                                const [draggedItem] = newConquistas.splice(dragIndex, 1)
                                newConquistas.splice(dropIndex, 0, draggedItem)
                                setConquistas(newConquistas)
                              }
                            }
                            setDraggingConquistaId(null)
                          }}
                          onDragEnd={() => setDraggingConquistaId(null)}
                        >
                          <div className="relative inline-block">
                            {/* Ponto na linha do tempo */}
                            <div className={`hidden md:block absolute top-1/2 ${index % 2 === 0 ? 'md:-right-6' : 'md:-left-6'} transform -translate-y-1/2 w-3 h-3 sm:w-4 sm:h-4 rounded-full ${
                              conquista.levelUp
                                ? 'bg-gradient-to-r from-yellow-400 to-amber-500'
                                : 'bg-gradient-to-r from-blue-500 to-indigo-600'
                            } border-2 sm:border-4 ${darkMode ? 'border-gray-800' : 'border-white'} z-10`}></div>

                            {/* Botão de Editar - só aparece se estiver vendo o próprio diário */}
                            {!selectedDiarioTrainer && (
                              <button
                                onClick={(e) => {
                                  e.stopPropagation()
                                  setConquistaEditando(conquista.id)
                                  setNovaConquistaNome(conquista.nome)
                                  setNovaConquistaLevelUp(conquista.levelUp)
                                  setNovaConquistaDescricao(conquista.descricao || '')
                                  setShowNovaConquistaModal(true)
                                }}
                                className="absolute -top-1 -right-8 sm:-top-2 sm:-right-10 w-5 h-5 sm:w-6 sm:h-6 bg-blue-500 hover:bg-blue-600 text-white rounded-full flex items-center justify-center z-20 transition-colors shadow-lg"
                                title="Editar conquista"
                              >
                                <Edit size={12} className="sm:w-[14px] sm:h-[14px]" />
                              </button>
                            )}

                            {/* Botão de Excluir - só aparece se estiver vendo o próprio diário */}
                            {!selectedDiarioTrainer && (
                              <button
                                onClick={(e) => {
                                  e.stopPropagation()
                                  if (confirm(`Deseja excluir a conquista "${conquista.nome}"?`)) {
                                    setConquistas(conquistas.filter(c => c.id !== conquista.id))
                                    if (selectedConquista?.id === conquista.id) {
                                      setSelectedConquista(null)
                                    }
                                  }
                                }}
                                className="absolute -top-1 -right-1 sm:-top-2 sm:-right-2 w-5 h-5 sm:w-6 sm:h-6 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center z-20 transition-colors shadow-lg"
                                title="Excluir conquista"
                              >
                                <X size={12} className="sm:w-[14px] sm:h-[14px]" />
                              </button>
                            )}

                            {/* Caixa da Conquista */}
                            <button
                              onClick={() => setSelectedConquista(conquista)}
                              className={`relative inline-block px-3 sm:px-4 md:px-6 py-2.5 sm:py-3 md:py-4 rounded-lg shadow-lg transition-all hover:shadow-xl hover:scale-105 ${
                                conquista.levelUp
                                  ? 'bg-gradient-to-r from-yellow-400 to-amber-500 text-gray-900'
                                  : 'bg-gradient-to-r from-blue-500 to-indigo-600 text-white'
                              } font-bold text-sm sm:text-base md:text-lg border-2 ${
                                conquista.levelUp ? 'border-yellow-600' : 'border-blue-700'
                              }`}
                            >
                              {conquista.nome}
                            </button>
                          </div>
                        </div>
                      ))}

                        {/* Ponto Final */}
                        <div className="relative mt-6 sm:mt-8">
                          <div className="flex items-center justify-center">
                            <div className={`${darkMode ? 'bg-gray-700 border-gray-500' : 'bg-white border-gray-400'} border-2 sm:border-4 rounded-full px-3 sm:px-4 md:px-6 py-2 sm:py-2.5 md:py-3 shadow-lg z-10`}>
                              <p className={`font-bold text-sm sm:text-base md:text-lg ${darkMode ? 'text-white' : 'text-gray-800'} text-center`}>
                                Acordei do coma?
                              </p>
                            </div>
                          </div>
                        </div>
                      </>
                    )
                  })()}
                </div>
              </div>
            </div>
          )}

          {/* BACKGROUND */}
          {progressaoSection === 'Background' && (
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-6`}>
              <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 sm:gap-0 mb-4 sm:mb-6">
                <h3 className={`text-xl sm:text-2xl md:text-3xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  Background
                </h3>
                <button
                  onClick={() => setShowBackgroundModal(true)}
                  className="w-full sm:w-auto bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-3 sm:px-5 md:px-6 py-2.5 sm:py-3 rounded-lg hover:from-purple-700 hover:to-indigo-700 font-semibold flex items-center justify-center gap-2 shadow-lg text-sm sm:text-base"
                >
                  <Edit size={18} className="sm:w-5 sm:h-5" />
                  Conte sua história
                </button>
              </div>

              {/* Dropdown para selecionar treinador */}
              <div className="mb-4 sm:mb-6">
                <label className={`block text-xs sm:text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                  Ver Background de:
                </label>
                <select
                  value={selectedBackgroundTrainer}
                  onChange={(e) => setSelectedBackgroundTrainer(e.target.value)}
                  className={`w-full px-3 py-2 sm:px-4 rounded-lg border-2 text-sm sm:text-base ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300 bg-white text-gray-800'}`}
                >
                  <option value="">Meu Background</option>
                  {users.filter(u => u.type === 'treinador' && u.username !== currentUser.username).map(trainer => (
                    <option key={trainer.username} value={trainer.username}>{trainer.username}</option>
                  ))}
                </select>
              </div>

              {/* Conteúdo do Background */}
              <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-50'} rounded-lg p-4 sm:p-5 md:p-6 min-h-[300px] sm:min-h-[400px]`}>
                <h4 className={`text-base sm:text-lg md:text-xl font-bold mb-3 sm:mb-4 ${darkMode ? 'text-purple-400' : 'text-purple-700'}`}>
                  {selectedBackgroundTrainer || currentUser.username}
                </h4>
                {(() => {
                  const displayBackground = selectedBackgroundTrainer && selectedBackgroundData
                    ? selectedBackgroundData.background || ''
                    : background

                  return displayBackground ? (
                    <p className={`whitespace-pre-wrap text-sm sm:text-base ${darkMode ? 'text-gray-300' : 'text-gray-700'} leading-relaxed`}>
                      {displayBackground}
                    </p>
                  ) : (
                    <p className={`text-center text-xs sm:text-sm ${darkMode ? 'text-gray-500' : 'text-gray-400'} italic`}>
                      {selectedBackgroundTrainer
                        ? 'Este treinador ainda não escreveu sua história.'
                        : 'Você ainda não escreveu sua história. Clique em "Conte sua história" para começar.'}
                    </p>
                  )
                })()}
              </div>
            </div>
          )}

          {/* XP & CAPTURAS */}
          {progressaoSection === 'XP & Capturas' && (
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-6`}>
              <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 sm:gap-0 mb-4 sm:mb-6">
                <h3 className={`text-xl sm:text-2xl md:text-3xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  XP & Capturas
                </h3>
                <button
                  onClick={async () => {
                    if (window.confirm('Tem certeza que deseja limpar todas as listas de XP e Capturas?')) {
                      setXpList([])
                      setCapturaList([])
                      if (useFirebase) {
                        await saveXpCapturas(currentUser.username, { xpList: [], capturaList: [] })
                      }
                    }
                  }}
                  className="w-full sm:w-auto bg-red-500 text-white px-3 py-2 sm:px-4 rounded-lg hover:bg-red-600 font-semibold flex items-center justify-center gap-2 text-sm sm:text-base"
                >
                  <Trash2 size={16} className="sm:w-[18px] sm:h-[18px]" />
                  Limpar listas
                </button>
              </div>

              {/* Grid com Lista de XP e Lista de Captura */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4">
                {/* Lista de XP (Esquerda) */}
                <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-50'} rounded-lg p-3 sm:p-4`}>
                  <div className="flex flex-col xs:flex-row justify-between items-start xs:items-center gap-2 xs:gap-0 mb-3 sm:mb-4">
                    <h4 className={`text-base sm:text-lg md:text-xl font-bold ${darkMode ? 'text-cyan-400' : 'text-cyan-700'}`}>
                      Lista de XP
                    </h4>
                    <button
                      onClick={() => setShowAddXpModal(true)}
                      className="w-full xs:w-auto bg-cyan-500 text-white px-3 py-1.5 sm:py-1 rounded-lg hover:bg-cyan-600 text-xs sm:text-sm font-semibold flex items-center justify-center gap-1"
                    >
                      <Plus size={14} className="sm:w-4 sm:h-4" />
                      Listar XP
                    </button>
                  </div>

                  {xpList.length === 0 ? (
                    <p className={`text-center text-xs sm:text-sm ${darkMode ? 'text-gray-500' : 'text-gray-400'} italic py-6 sm:py-8`}>
                      Nenhuma XP listada ainda.
                    </p>
                  ) : (
                    <div className="space-y-2 max-h-[400px] overflow-y-auto">
                      {xpList.map((xp, index) => (
                        <div key={index} className={`flex justify-between items-center p-2 sm:p-2.5 rounded text-xs sm:text-sm ${darkMode ? 'bg-gray-600' : 'bg-white'} shadow-sm`}>
                          <span className={`${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                            {index + 1}. {xp.value} XP {xp.species && <span className={xp.fromNpc ? 'text-red-500 font-semibold' : `${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>({xp.species})</span>}
                          </span>
                          <div className="flex gap-1">
                            <button
                              onClick={() => {
                                setEditingXpIndex(index)
                                setEditXpValue(xp.value.toString())
                                setShowEditXpModal(true)
                              }}
                              className="text-blue-500 hover:text-blue-600 p-0.5 sm:p-1"
                              title="Editar XP"
                            >
                              <Pencil size={14} className="sm:w-4 sm:h-4" />
                            </button>
                            <button
                              onClick={async () => {
                                const newList = xpList.filter((_, i) => i !== index)
                                setXpList(newList)
                                if (useFirebase) {
                                  await saveXpCapturas(currentUser.username, { xpList: newList, capturaList })
                                }
                              }}
                              className="text-red-500 hover:text-red-600 p-0.5 sm:p-1"
                              title="Remover XP"
                            >
                              <Trash2 size={14} className="sm:w-4 sm:h-4" />
                            </button>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}

                  {/* Total de XP */}
                  {xpList.length > 0 && (
                    <div className={`mt-3 sm:mt-4 pt-3 sm:pt-4 border-t ${darkMode ? 'border-gray-600' : 'border-gray-300'}`}>
                      <p className={`text-base sm:text-lg font-bold ${darkMode ? 'text-cyan-400' : 'text-cyan-700'}`}>
                        Total: {xpList.reduce((sum, xp) => sum + (xp.value || 0), 0)} XP
                      </p>
                    </div>
                  )}
                </div>

                {/* Lista de Captura (Direita) */}
                <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-50'} rounded-lg p-3 sm:p-4`}>
                  <h4 className={`text-base sm:text-lg md:text-xl font-bold mb-3 sm:mb-4 ${darkMode ? 'text-blue-400' : 'text-blue-700'}`}>
                    Lista de Captura
                  </h4>

                  {capturaList.length === 0 ? (
                    <p className={`text-center text-xs sm:text-sm ${darkMode ? 'text-gray-500' : 'text-gray-400'} italic py-6 sm:py-8`}>
                      Nenhum Pokémon na lista de captura.
                    </p>
                  ) : (
                    <div className="space-y-2 max-h-[400px] overflow-y-auto">
                      {capturaList.map((pokemon, index) => (
                        <div key={index} className={`flex justify-between items-center p-2 sm:p-2.5 rounded ${darkMode ? 'bg-gray-600' : 'bg-white'} shadow-sm ${
                          pokemon.status === 'capturado' ? 'border-l-4 border-green-500' :
                          pokemon.status === 'batalha' ? 'border-l-4 border-orange-500' :
                          pokemon.status === 'block' ? 'border-l-4 border-red-500' : ''
                        }`}>
                          <div className="flex-1 min-w-0">
                            <div className="flex flex-wrap items-center gap-1">
                              <span className={`font-semibold text-xs sm:text-sm ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                {pokemon.species}
                              </span>
                              <span className={`text-[10px] sm:text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                                Nv. {pokemon.level} | Cap: {pokemon.captureValue}
                              </span>
                            </div>
                            {pokemon.status && (
                              <span className={`inline-block mt-1 text-[10px] px-1.5 py-0.5 rounded ${
                                pokemon.status === 'capturado' ? 'bg-green-500 text-white' :
                                pokemon.status === 'batalha' ? 'bg-orange-500 text-white' :
                                'bg-red-500 text-white'
                              }`}>
                                {pokemon.status === 'capturado' ? 'Capturado' :
                                 pokemon.status === 'batalha' ? 'Vencido' : 'Bloqueado'}
                              </span>
                            )}
                          </div>
                          <div className="flex gap-1 ml-2">
                            <button
                              onClick={() => {
                                setEditingCapturaIndex(index)
                                setEditCapturaData({
                                  species: pokemon.species,
                                  level: pokemon.level.toString(),
                                  captureValue: pokemon.captureValue.toString()
                                })
                                setShowEditCapturaModal(true)
                              }}
                              className="text-blue-500 hover:text-blue-600 p-0.5 sm:p-1"
                              title="Editar Captura"
                            >
                              <Pencil size={14} className="sm:w-4 sm:h-4" />
                            </button>
                            <button
                              onClick={async () => {
                                const newList = capturaList.filter((_, i) => i !== index)
                                setCapturaList(newList)
                                if (useFirebase) {
                                  await saveXpCapturas(currentUser.username, { xpList, capturaList: newList })
                                }
                              }}
                              className="text-red-500 hover:text-red-600 p-0.5 sm:p-1"
                              title="Remover Captura"
                            >
                              <Trash2 size={14} className="sm:w-4 sm:h-4" />
                            </button>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </div>

              {/* Capturas da Narração - NOVO */}
              {gridCapturaConfig && gridCapturaConfig.pokemons && (
                <div className={`mt-4 sm:mt-6 ${darkMode ? 'bg-gray-700' : 'bg-gray-50'} rounded-lg p-3 sm:p-4 md:p-6`}>
                  <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2 sm:gap-0 mb-3 sm:mb-4">
                    <h4 className={`text-base sm:text-xl md:text-2xl font-bold ${darkMode ? 'text-purple-400' : 'text-purple-700'}`}>
                      Capturas da Narração
                    </h4>
                    <div className={`px-3 py-1.5 sm:px-4 sm:py-2 rounded-lg ${
                      gridCapturaConfig.trainer === currentUser.username
                        ? 'bg-gradient-to-r from-green-600 to-emerald-600 text-white'
                        : 'bg-gradient-to-r from-gray-600 to-gray-700 text-gray-300'
                    }`}>
                      <span className="text-xs sm:text-sm font-semibold">
                        {gridCapturaConfig.trainer === currentUser.username
                          ? '🎯 Você pode interagir!'
                          : `🔒 Grid de ${gridCapturaConfig.trainer}`}
                      </span>
                    </div>
                  </div>

                  {/* Botões de Estado */}
                  <div className="flex flex-col xs:flex-row gap-2 xs:gap-3 mb-3 sm:mb-4 justify-center">
                    <button
                      onClick={() => setSelectedGridState(selectedGridState === 'bloqueado' ? null : 'bloqueado')}
                      className={`flex items-center justify-center gap-2 px-3 py-2 sm:px-4 rounded-lg font-semibold transition-all text-xs sm:text-sm ${
                        selectedGridState === 'bloqueado'
                          ? 'bg-red-600 text-white shadow-lg scale-105'
                          : darkMode
                            ? 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                            : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                      }`}
                    >
                      <img src="/xdebloqueio.png" alt="Bloqueado" className="w-5 h-5 sm:w-6 sm:h-6" />
                      <span>Bloqueado</span>
                    </button>
                    <button
                      onClick={() => setSelectedGridState(selectedGridState === 'capturado' ? null : 'capturado')}
                      className={`flex items-center justify-center gap-2 px-3 py-2 sm:px-4 rounded-lg font-semibold transition-all text-xs sm:text-sm ${
                        selectedGridState === 'capturado'
                          ? 'bg-green-600 text-white shadow-lg scale-105'
                          : darkMode
                            ? 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                            : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                      }`}
                    >
                      <img src="/pokeball-icon.png" alt="Capturado" className="w-5 h-5 sm:w-6 sm:h-6" />
                      <span>Capturado</span>
                    </button>
                    <button
                      onClick={() => setSelectedGridState(selectedGridState === 'vencido' ? null : 'vencido')}
                      className={`flex items-center justify-center gap-2 px-3 py-2 sm:px-4 rounded-lg font-semibold transition-all text-xs sm:text-sm ${
                        selectedGridState === 'vencido'
                          ? 'bg-blue-600 text-white shadow-lg scale-105'
                          : darkMode
                            ? 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                            : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                      }`}
                    >
                      <img src="/xpbatalhou.png" alt="Vencido" className="w-5 h-5 sm:w-6 sm:h-6" />
                      <span>Vencido</span>
                    </button>
                  </div>

                  <div
                    className="grid gap-2 sm:gap-3"
                    style={{
                      gridTemplateColumns: `repeat(${gridCapturaConfig.cols}, minmax(0, 1fr))`,
                      maxWidth: `${gridCapturaConfig.cols * 110}px`,
                      margin: '0 auto'
                    }}
                  >
                    {gridCapturaConfig.pokemons.map((pokemon, index) => {
                      // Célula vazia
                      if (!pokemon) {
                        return (
                          <div
                            key={index}
                            className={`aspect-square rounded-xl border-2 ${darkMode ? 'bg-gray-800 border-gray-600' : 'bg-gray-200 border-gray-400'}`}
                          />
                        )
                      }

                      const isRevealed = revealedCards.includes(index)
                      const canInteract = gridCapturaConfig.trainer === currentUser.username
                      const cardState = gridCardStates[index]

                      return (
                        <div
                          key={index}
                          onClick={() => {
                            if (canInteract) {
                              // Se tem estado selecionado, aplicar/remover estado
                              if (selectedGridState) {
                                const newStates = { ...gridCardStates }
                                // Toggle: se já tem esse estado, remove; senão, aplica
                                if (newStates[index] === selectedGridState) {
                                  delete newStates[index]
                                } else {
                                  newStates[index] = selectedGridState
                                }
                                setGridCardStates(newStates)
                                if (useFirebase) {
                                  saveToFirebase('mestre/gridCardStates', newStates)
                                }
                              } else if (!isRevealed) {
                                // Se não tem estado selecionado, revelar card
                                const newRevealed = [...revealedCards, index]
                                setRevealedCards(newRevealed)
                                if (useFirebase) {
                                  saveToFirebase('mestre/gridCapturaRevealed', newRevealed)
                                }
                              }
                            }
                          }}
                          className={`aspect-square rounded-xl border-2 transition-all shadow-lg relative overflow-hidden ${
                            canInteract
                              ? 'cursor-pointer hover:shadow-2xl ' + (darkMode ? 'bg-gray-600 border-gray-500 hover:border-purple-400' : 'bg-white border-gray-300 hover:border-purple-500')
                              : 'cursor-not-allowed ' + (darkMode ? 'bg-gray-600 border-gray-500' : 'bg-white border-gray-300')
                          }`}
                        >
                          {isRevealed ? (
                            <div className="flex flex-col items-center justify-center h-full p-1 sm:p-2">
                              {pokemon.imageUrl && (
                                <img src={pokemon.imageUrl} alt={pokemon.species} className="w-12 h-12 sm:w-16 sm:h-16 md:w-20 md:h-20 object-contain mb-0.5 sm:mb-1" />
                              )}
                              <p className={`text-[10px] sm:text-xs md:text-sm font-bold text-center ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                {pokemon.species}
                              </p>
                              <p className={`text-[9px] sm:text-[10px] md:text-xs ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                                Nv.{pokemon.level}
                              </p>
                              <p className={`text-[9px] sm:text-[10px] md:text-xs font-semibold ${darkMode ? 'text-cyan-400' : 'text-cyan-600'}`}>
                                Cap: {pokemon.captureValue}
                              </p>
                            </div>
                          ) : (
                            <div className="w-full h-full flex items-center justify-center relative bg-gradient-to-br from-purple-900 to-blue-900">
                              <img
                                src="/quemeessepkm.png"
                                alt="Pokémon oculto"
                                className="w-full h-full object-cover absolute inset-0 opacity-80"
                              />
                            </div>
                          )}

                          {/* Ícone de Estado */}
                          {cardState && (
                            <div className="absolute top-0.5 right-0.5 sm:top-1 sm:right-1 w-6 h-6 sm:w-7 sm:h-7 md:w-8 md:h-8 bg-white rounded-full shadow-lg flex items-center justify-center p-0.5 sm:p-1">
                              <img
                                src={
                                  cardState === 'bloqueado' ? '/xdebloqueio.png' :
                                  cardState === 'capturado' ? '/pokeball-icon.png' :
                                  '/xpbatalhou.png'
                                }
                                alt={cardState}
                                className="w-full h-full object-contain"
                              />
                            </div>
                          )}
                        </div>
                      )
                    })}
                  </div>
                </div>
              )}

              {/* Chat de XP & Capturas */}
              <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-50'} rounded-2xl shadow-lg p-3 sm:p-4 md:p-6 mt-4 sm:mt-6`}>
                <h3 className={`text-base sm:text-xl md:text-2xl font-bold mb-3 sm:mb-4 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  Chat
                </h3>

                {/* Menu de Rolagem Rápida */}
                <div className={`${darkMode ? 'bg-gray-600' : 'bg-gray-100'} rounded-lg p-3 sm:p-4 mb-3 sm:mb-4`}>
                  <h4 className={`text-xs sm:text-sm font-bold mb-2 sm:mb-3 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Rolagem Rápida
                  </h4>
                  <div className="flex flex-col sm:flex-row flex-wrap items-start sm:items-center gap-2 sm:gap-3">
                    <div className="flex items-center gap-2 w-full sm:w-auto">
                      <span className={`text-[10px] sm:text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Qtd:</span>
                      <div className="flex gap-1 flex-wrap">
                        {[1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(num => (
                          <button
                            key={num}
                            onClick={() => setQuickRollNumDice(num)}
                            className={`w-7 h-7 sm:w-8 sm:h-8 rounded text-xs sm:text-sm font-bold transition-colors ${
                              quickRollNumDice === num
                                ? 'bg-blue-600 text-white'
                                : darkMode
                                ? 'bg-gray-500 text-gray-300 hover:bg-gray-400'
                                : 'bg-white text-gray-700 hover:bg-gray-200'
                            }`}
                          >
                            {num}
                          </button>
                        ))}
                      </div>
                    </div>
                    <div className="flex items-center gap-2 w-full sm:w-auto">
                      <span className={`text-[10px] sm:text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Dado:</span>
                      <div className="flex gap-1 flex-wrap">
                        {['d4', 'd6', 'd8', 'd10', 'd12', 'd20'].map(dice => (
                          <button
                            key={dice}
                            onClick={() => setQuickRollDiceType(dice)}
                            className={`px-2 sm:px-3 h-7 sm:h-8 rounded text-xs sm:text-sm font-bold transition-colors ${
                              quickRollDiceType === dice
                                ? 'bg-green-600 text-white'
                                : darkMode
                                ? 'bg-gray-500 text-gray-300 hover:bg-gray-400'
                                : 'bg-white text-gray-700 hover:bg-gray-200'
                            }`}
                          >
                            {dice}
                          </button>
                        ))}
                      </div>
                    </div>
                    <button
                      onClick={() => {
                        const diceNotation = `${quickRollNumDice}${quickRollDiceType}`
                        const result = rollDiceExpression(diceNotation)
                        if (result.error) {
                          alert(result.error)
                          return
                        }
                        const newMessage = {
                          username: currentUser?.username || 'Anônimo',
                          text: `🎲 Rolagem Rápida: ${diceNotation}`,
                          timestamp: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
                          isDiceRoll: true,
                          diceResult: result.total,
                          diceDetails: result.formula
                        }
                        setChatMessages(prev => [...prev, newMessage])
                        if (useFirebase) {
                          (async () => {
                            const currentMessages = await loadChatMessages()
                            await saveChatMessages([...(currentMessages || []), newMessage])
                          })().catch(err => console.error('Erro ao salvar mensagem:', err))
                        }
                      }}
                      className="w-full sm:w-auto px-4 sm:px-5 md:px-6 h-7 sm:h-8 bg-purple-600 text-white rounded font-bold hover:bg-purple-700 transition-colors text-xs sm:text-sm"
                    >
                      🎲 Rolar
                    </button>
                  </div>
                </div>

                <div className={`text-[10px] sm:text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-3 sm:mb-4 space-y-1`}>
                  <p>Use /r ou /roll para rolar dados. Ex: /r 1d20+5, /roll 2d6</p>
                  <p className="hidden sm:block">Use comandos @ para referenciar seus atributos: <span className="font-mono">1d20+@MAE</span>, <span className="font-mono">2d6+@MA+@MV</span></p>
                  <p className="text-[9px] sm:text-[10px]">Comandos: @MA @MD @MAE @MDE @MV @MS @At @Dt @AEt @DEt @Vt @St @Cont</p>
                </div>

                {/* Área de Mensagens */}
                <div ref={chatContainerRef} className={`${darkMode ? 'bg-gray-900' : 'bg-gray-50'} rounded-lg p-3 sm:p-4 h-64 sm:h-80 md:h-96 overflow-y-auto mb-3 sm:mb-4`}>
                  {chatMessages.length === 0 ? (
                    <p className={`text-center text-xs sm:text-sm ${darkMode ? 'text-gray-500' : 'text-gray-400'} py-8 sm:py-12`}>
                      Nenhuma mensagem ainda. Seja o primeiro a falar!
                    </p>
                  ) : (
                    <div className="space-y-2 sm:space-y-3">
                      {chatMessages.map((msg, idx) => (
                        <div key={idx} className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg p-2 sm:p-3`}>
                          <div className="flex justify-between items-start mb-1">
                            <span className={`font-bold text-xs sm:text-sm ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>
                              {msg.username}
                            </span>
                            <span className={`text-[10px] sm:text-xs ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                              {msg.timestamp}
                            </span>
                          </div>
                          {msg.isDiceRoll ? (
                            <div>
                              <p className={`text-xs sm:text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                {msg.text}
                              </p>
                              <div className={`mt-1 sm:mt-2 p-1.5 sm:p-2 rounded ${darkMode ? 'bg-green-900' : 'bg-green-100'}`}>
                                <p className={`font-bold text-sm sm:text-base md:text-lg ${darkMode ? 'text-green-400' : 'text-green-700'}`}>
                                  Resultado: {msg.diceResult}
                                </p>
                                <p className={`text-[10px] sm:text-xs ${darkMode ? 'text-green-300' : 'text-green-600'}`}>
                                  {msg.diceDetails}
                                </p>
                              </div>
                            </div>
                          ) : msg.isAction ? (
                            <p className={`text-xs sm:text-sm font-semibold text-yellow-500`}>
                              {msg.text}
                            </p>
                          ) : (
                            <p className={`text-xs sm:text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                              {msg.text}
                            </p>
                          )}
                        </div>
                      ))}
                    </div>
                  )}
                </div>

                {/* Input de Mensagem */}
                <div className="flex gap-2">
                  <input
                    type="text"
                    value={chatInput}
                    onChange={(e) => setChatInput(e.target.value)}
                    onKeyPress={(e) => {
                      if (e.key === 'Enter') {
                        handleSendMessage()
                      }
                    }}
                    placeholder="Digite sua mensagem ou /r 1d20..."
                    className={`flex-1 px-3 py-2 sm:px-4 sm:py-3 rounded-lg border-2 text-sm sm:text-base ${
                      darkMode
                        ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-500'
                        : 'bg-white border-gray-300 text-gray-800 placeholder-gray-400'
                    } focus:outline-none focus:border-blue-500`}
                  />
                  <button
                    onClick={handleSendMessage}
                    className="px-3 sm:px-5 md:px-6 py-2 sm:py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold text-sm sm:text-base"
                  >
                    Enviar
                  </button>
                </div>
              </div>

            </div>
          )}
        </div>

        {/* Modal Adicionar XP */}
        {showAddXpModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowAddXpModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-sm sm:max-w-md w-full`} onClick={(e) => e.stopPropagation()}>
              <div className="p-4 sm:p-5 md:p-6">
                <div className="flex justify-between items-center mb-4 sm:mb-6">
                  <h3 className={`text-base sm:text-lg md:text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                    Listar XP
                  </h3>
                  <button onClick={() => setShowAddXpModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                    <X size={20} className="sm:w-6 sm:h-6" />
                  </button>
                </div>

                <div className="space-y-3 sm:space-y-4">
                  <div>
                    <label className={`block text-xs sm:text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      Quantidade de XP
                    </label>
                    <input
                      type="number"
                      value={addXpValue}
                      onChange={(e) => setAddXpValue(e.target.value)}
                      className={`w-full px-3 py-2 sm:px-4 rounded-lg border-2 text-sm sm:text-base ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                      placeholder="Ex: 100"
                    />
                  </div>

                  <button
                    onClick={async () => {
                      if (addXpValue && parseInt(addXpValue) > 0) {
                        const newXpList = [...xpList, { value: parseInt(addXpValue) }]
                        setXpList(newXpList)
                        if (useFirebase) {
                          await saveXpCapturas(currentUser.username, { xpList: newXpList, capturaList })
                        }
                        setAddXpValue('')
                        setShowAddXpModal(false)
                      }
                    }}
                    disabled={!addXpValue || parseInt(addXpValue) <= 0}
                    className="w-full bg-cyan-500 text-white py-2.5 sm:py-3 rounded-lg hover:bg-cyan-600 font-semibold disabled:opacity-50 disabled:cursor-not-allowed text-sm sm:text-base"
                  >
                    Adicionar XP
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Modal Editar XP */}
        {showEditXpModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowEditXpModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-sm sm:max-w-md w-full`} onClick={(e) => e.stopPropagation()}>
              <div className="p-4 sm:p-5 md:p-6">
                <div className="flex justify-between items-center mb-4 sm:mb-6">
                  <h3 className={`text-base sm:text-lg md:text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                    Editar XP
                  </h3>
                  <button onClick={() => setShowEditXpModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                    <X size={20} className="sm:w-6 sm:h-6" />
                  </button>
                </div>

                <div className="space-y-3 sm:space-y-4">
                  <div>
                    <label className={`block text-xs sm:text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      Quantidade de XP
                    </label>
                    <input
                      type="number"
                      value={editXpValue}
                      onChange={(e) => setEditXpValue(e.target.value)}
                      className={`w-full px-3 py-2 sm:px-4 rounded-lg border-2 text-sm sm:text-base ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                      placeholder="Ex: 100"
                    />
                  </div>

                  <button
                    onClick={async () => {
                      if (editXpValue && parseInt(editXpValue) > 0 && editingXpIndex !== null) {
                        const newXpList = xpList.map((xp, i) =>
                          i === editingXpIndex ? { ...xp, value: parseInt(editXpValue) } : xp
                        )
                        setXpList(newXpList)
                        if (useFirebase) {
                          await saveXpCapturas(currentUser.username, { xpList: newXpList, capturaList })
                        }
                        setEditXpValue('')
                        setEditingXpIndex(null)
                        setShowEditXpModal(false)
                      }
                    }}
                    disabled={!editXpValue || parseInt(editXpValue) <= 0}
                    className="w-full bg-blue-500 text-white py-2.5 sm:py-3 rounded-lg hover:bg-blue-600 font-semibold disabled:opacity-50 disabled:cursor-not-allowed text-sm sm:text-base"
                  >
                    Salvar Alterações
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Modal Editar Captura */}
        {showEditCapturaModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowEditCapturaModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-sm sm:max-w-md w-full`} onClick={(e) => e.stopPropagation()}>
              <div className="p-4 sm:p-5 md:p-6">
                <div className="flex justify-between items-center mb-4 sm:mb-6">
                  <h3 className={`text-base sm:text-lg md:text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                    Editar Captura
                  </h3>
                  <button onClick={() => setShowEditCapturaModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                    <X size={20} className="sm:w-6 sm:h-6" />
                  </button>
                </div>

                <div className="space-y-3 sm:space-y-4">
                  <div>
                    <label className={`block text-xs sm:text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      Espécie
                    </label>
                    <input
                      type="text"
                      value={editCapturaData.species}
                      onChange={(e) => setEditCapturaData({ ...editCapturaData, species: e.target.value })}
                      className={`w-full px-3 py-2 sm:px-4 rounded-lg border-2 text-sm sm:text-base ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                      placeholder="Ex: Pikachu"
                    />
                  </div>

                  <div>
                    <label className={`block text-xs sm:text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      Nível
                    </label>
                    <input
                      type="number"
                      value={editCapturaData.level}
                      onChange={(e) => setEditCapturaData({ ...editCapturaData, level: e.target.value })}
                      className={`w-full px-3 py-2 sm:px-4 rounded-lg border-2 text-sm sm:text-base ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                      placeholder="Ex: 5"
                    />
                  </div>

                  <div>
                    <label className={`block text-xs sm:text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      Valor de Captura
                    </label>
                    <input
                      type="number"
                      value={editCapturaData.captureValue}
                      onChange={(e) => setEditCapturaData({ ...editCapturaData, captureValue: e.target.value })}
                      className={`w-full px-3 py-2 sm:px-4 rounded-lg border-2 text-sm sm:text-base ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                      placeholder="Ex: 100"
                    />
                  </div>

                  <button
                    onClick={async () => {
                      if (editCapturaData.species && editCapturaData.level && editCapturaData.captureValue && editingCapturaIndex !== null) {
                        const newCapturaList = capturaList.map((cap, i) =>
                          i === editingCapturaIndex ? {
                            ...cap,
                            species: editCapturaData.species,
                            level: parseInt(editCapturaData.level),
                            captureValue: parseInt(editCapturaData.captureValue)
                          } : cap
                        )
                        setCapturaList(newCapturaList)
                        if (useFirebase) {
                          await saveXpCapturas(currentUser.username, { xpList, capturaList: newCapturaList })
                        }
                        setEditCapturaData({ species: '', level: '', captureValue: '' })
                        setEditingCapturaIndex(null)
                        setShowEditCapturaModal(false)
                      }
                    }}
                    disabled={!editCapturaData.species || !editCapturaData.level || !editCapturaData.captureValue}
                    className="w-full bg-blue-500 text-white py-2.5 sm:py-3 rounded-lg hover:bg-blue-600 font-semibold disabled:opacity-50 disabled:cursor-not-allowed text-sm sm:text-base"
                  >
                    Salvar Alterações
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Modal Nova/Editar Vivência */}
        {showNovaVivenciaModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => { setShowNovaVivenciaModal(false); setEditingVivenciaId(null) }}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-sm sm:max-w-xl md:max-w-2xl w-full max-h-[90vh] overflow-y-auto`} onClick={(e) => e.stopPropagation()}>
              <div className="p-4 sm:p-5 md:p-6">
                <div className="flex justify-between items-center mb-4 sm:mb-6">
                  <h3 className={`text-lg sm:text-xl md:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                    {editingVivenciaId ? 'Editar Vivência' : 'Nova Vivência'}
                  </h3>
                  <button onClick={() => { setShowNovaVivenciaModal(false); setEditingVivenciaId(null) }} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                    <X size={20} className="sm:w-6 sm:h-6" />
                  </button>
                </div>

                <div className="space-y-3 sm:space-y-4">
                  {/* Nome */}
                  <div>
                    <label className={`block text-xs sm:text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      Nome <span className="text-red-500">*</span>
                    </label>
                    <input
                      type="text"
                      value={novaVivenciaNome}
                      onChange={(e) => setNovaVivenciaNome(e.target.value)}
                      className={`w-full px-3 py-2 sm:px-4 rounded-lg border-2 text-sm sm:text-base ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                      placeholder="Nome da vivência"
                    />
                  </div>

                  {/* Frequência */}
                  <div>
                    <label className={`block text-xs sm:text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      Frequência
                    </label>
                    <input
                      type="text"
                      value={novaVivenciaFrequencia}
                      onChange={(e) => setNovaVivenciaFrequencia(e.target.value)}
                      className={`w-full px-3 py-2 sm:px-4 rounded-lg border-2 text-sm sm:text-base ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                      placeholder="Ex: Diária, Semanal, etc."
                    />
                  </div>

                  {/* Alvo */}
                  <div>
                    <label className={`block text-xs sm:text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      Alvo
                    </label>
                    <input
                      type="text"
                      value={novaVivenciaAlvo}
                      onChange={(e) => setNovaVivenciaAlvo(e.target.value)}
                      className={`w-full px-3 py-2 sm:px-4 rounded-lg border-2 text-sm sm:text-base ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                      placeholder="Alvo da vivência"
                    />
                  </div>

                  {/* Gatilho */}
                  <div>
                    <label className={`block text-xs sm:text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      Gatilho
                    </label>
                    <input
                      type="text"
                      value={novaVivenciaGatilho}
                      onChange={(e) => setNovaVivenciaGatilho(e.target.value)}
                      className={`w-full px-3 py-2 sm:px-4 rounded-lg border-2 text-sm sm:text-base ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                      placeholder="Gatilho da vivência"
                    />
                  </div>

                  {/* Efeito */}
                  <div>
                    <label className={`block text-xs sm:text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      Efeito <span className="text-red-500">*</span>
                    </label>
                    <textarea
                      value={novaVivenciaEfeito}
                      onChange={(e) => setNovaVivenciaEfeito(e.target.value)}
                      className={`w-full px-3 py-2 sm:px-4 rounded-lg border-2 text-sm sm:text-base ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                      placeholder="Efeito da vivência"
                      rows={4}
                    />
                  </div>
                </div>

                <div className="flex gap-3 mt-4 sm:mt-6">
                  <button
                    onClick={() => { setShowNovaVivenciaModal(false); setEditingVivenciaId(null) }}
                    className={`flex-1 py-2.5 sm:py-3 rounded-lg font-semibold text-sm sm:text-base ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                  >
                    Cancelar
                  </button>
                  <button
                    onClick={handleAddVivencia}
                    className="flex-1 bg-gradient-to-r from-green-600 to-emerald-600 text-white py-2.5 sm:py-3 rounded-lg hover:from-green-700 hover:to-emerald-700 font-semibold text-sm sm:text-base"
                  >
                    {editingVivenciaId ? 'Salvar' : 'Adicionar'}
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Modal Nova Conquista */}
        {showNovaConquistaModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowNovaConquistaModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-sm sm:max-w-xl md:max-w-2xl w-full max-h-[90vh] overflow-y-auto`} onClick={(e) => e.stopPropagation()}>
              <div className="p-3 sm:p-5 md:p-6">
                <div className="flex justify-between items-center mb-6">
                  <h3 className={`text-lg sm:text-xl md:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                    {conquistaEditando ? 'Editar Conquista' : 'Nova Conquista'}
                  </h3>
                  <button onClick={() => {
                    setShowNovaConquistaModal(false)
                    setConquistaEditando(null)
                  }} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                    <X size={20} className="sm:w-6 sm:h-6" />
                  </button>
                </div>

                <div className="space-y-4">
                  {/* Nome */}
                  <div>
                    <label className={`block text-xs sm:text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      Nome
                    </label>
                    <input
                      type="text"
                      value={novaConquistaNome}
                      onChange={(e) => setNovaConquistaNome(e.target.value)}
                      className={`w-full px-3 py-2 sm:px-4 rounded-lg border-2 text-sm sm:text-base ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                      placeholder="Nome da conquista"
                    />
                  </div>

                  {/* Lvl Up */}
                  <div className="flex items-center gap-3">
                    <input
                      type="checkbox"
                      id="levelUpCheckbox"
                      checked={novaConquistaLevelUp}
                      onChange={(e) => setNovaConquistaLevelUp(e.target.checked)}
                      className="w-4 h-4 sm:w-5 sm:h-5 rounded cursor-pointer"
                    />
                    <label htmlFor="levelUpCheckbox" className={`text-xs sm:text-sm font-bold cursor-pointer ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      Lvl Up
                    </label>
                  </div>

                  {/* Descrição */}
                  <div>
                    <label className={`block text-xs sm:text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      Descrição
                    </label>
                    <textarea
                      value={novaConquistaDescricao}
                      onChange={(e) => setNovaConquistaDescricao(e.target.value)}
                      className={`w-full px-3 py-2 sm:px-4 rounded-lg border-2 text-sm sm:text-base ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                      placeholder="Descrição da conquista"
                      rows={4}
                    />
                  </div>
                </div>

                <div className="flex gap-3 mt-6">
                  <button
                    onClick={() => {
                      setShowNovaConquistaModal(false)
                      setConquistaEditando(null)
                      setNovaConquistaNome('')
                      setNovaConquistaLevelUp(false)
                      setNovaConquistaDescricao('')
                    }}
                    className={`flex-1 py-2.5 sm:py-3 rounded-lg font-semibold text-sm sm:text-base ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                  >
                    Cancelar
                  </button>
                  <button
                    onClick={() => {
                      if (!novaConquistaNome.trim()) {
                        alert('Nome é obrigatório!')
                        return
                      }

                      if (conquistaEditando) {
                        // Editar conquista existente
                        setConquistas(conquistas.map(c =>
                          c.id === conquistaEditando
                            ? {
                                ...c,
                                nome: novaConquistaNome.trim(),
                                levelUp: novaConquistaLevelUp,
                                descricao: novaConquistaDescricao.trim()
                              }
                            : c
                        ))
                      } else {
                        // Adicionar nova conquista
                        const newConquista = {
                          id: Date.now(),
                          nome: novaConquistaNome.trim(),
                          levelUp: novaConquistaLevelUp,
                          descricao: novaConquistaDescricao.trim()
                        }
                        setConquistas([...conquistas, newConquista])
                      }

                      setShowNovaConquistaModal(false)
                      setConquistaEditando(null)
                      setNovaConquistaNome('')
                      setNovaConquistaLevelUp(false)
                      setNovaConquistaDescricao('')
                    }}
                    className="flex-1 bg-gradient-to-r from-amber-600 to-yellow-600 text-white py-2.5 sm:py-3 rounded-lg hover:from-amber-700 hover:to-yellow-700 font-semibold text-sm sm:text-base"
                  >
                    {conquistaEditando ? 'Salvar' : 'Adicionar'}
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Modal Detalhes da Conquista */}
        {selectedConquista && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setSelectedConquista(null)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-sm sm:max-w-xl md:max-w-2xl w-full`} onClick={(e) => e.stopPropagation()}>
              <div className="p-3 sm:p-5 md:p-6">
                <div className="flex justify-between items-center mb-6">
                  <h3 className={`text-lg sm:text-xl md:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                    {selectedConquista.nome}
                  </h3>
                  <button onClick={() => setSelectedConquista(null)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                    <X size={20} className="sm:w-6 sm:h-6" />
                  </button>
                </div>

                {selectedConquista.levelUp && (
                  <div className="mb-4">
                    <span className="inline-block px-3 py-1.5 sm:px-4 sm:py-2 rounded-lg bg-gradient-to-r from-yellow-400 to-amber-500 text-gray-900 font-bold text-sm sm:text-base">
                      Level Up!
                    </span>
                  </div>
                )}

                <div className={`${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                  <p className="text-sm sm:text-base leading-relaxed whitespace-pre-wrap">
                    {selectedConquista.descricao || 'Sem descrição'}
                  </p>
                </div>

                <div className="flex justify-end mt-6">
                  <button
                    onClick={() => setSelectedConquista(null)}
                    className="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-3 sm:px-5 md:px-6 py-2 sm:py-2.5 rounded-lg hover:from-blue-700 hover:to-indigo-700 font-semibold text-sm sm:text-base"
                  >
                    Fechar
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Modal Fim do Ciclo */}
        {showFimCicloModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowFimCicloModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-sm sm:max-w-md md:max-w-lg w-full`} onClick={(e) => e.stopPropagation()}>
              <div className="p-3 sm:p-5 md:p-6">
                <div className="flex justify-between items-center mb-6">
                  <h3 className={`text-lg sm:text-xl md:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                    Fim do Ciclo
                  </h3>
                  <button onClick={() => setShowFimCicloModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                    <X size={20} className="sm:w-6 sm:h-6" />
                  </button>
                </div>

                <p className={`mb-4 text-xs sm:text-sm md:text-base ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                  Ao encerrar o ciclo, todas as conquistas atuais serão arquivadas e a linha do tempo será limpa para um novo começo.
                </p>

                <div className="mb-6">
                  <label className={`block text-xs sm:text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Verdade <span className="text-red-500">*</span>
                  </label>
                  <input
                    type="text"
                    value={fimCicloVerdade}
                    onChange={(e) => setFimCicloVerdade(e.target.value)}
                    className={`w-full px-3 py-2 sm:px-4 rounded-lg border-2 text-sm sm:text-base ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                    placeholder="Escreva a verdade deste ciclo..."
                  />
                </div>

                <div className="flex gap-3">
                  <button
                    onClick={() => setShowFimCicloModal(false)}
                    className={`flex-1 py-2.5 sm:py-3 rounded-lg font-semibold text-sm sm:text-base ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                  >
                    Cancelar
                  </button>
                  <button
                    onClick={() => {
                      if (!fimCicloVerdade.trim()) {
                        alert('A Verdade é obrigatória!')
                        return
                      }
                      if (conquistas.length === 0) {
                        alert('Não há conquistas para arquivar!')
                        return
                      }

                      // Criar novo ciclo com as conquistas atuais
                      const novoCiclo = {
                        id: Date.now(),
                        verdade: fimCicloVerdade.trim(),
                        conquistas: [...conquistas],
                        dataFim: new Date().toISOString()
                      }

                      // Adicionar ciclo à lista e limpar conquistas
                      setCiclos([...ciclos, novoCiclo])
                      setConquistas([])
                      setShowFimCicloModal(false)
                      setFimCicloVerdade('')
                    }}
                    className="flex-1 bg-gradient-to-r from-purple-600 to-pink-600 text-white py-2.5 sm:py-3 rounded-lg hover:from-purple-700 hover:to-pink-700 font-semibold text-sm sm:text-base"
                  >
                    Encerrar Ciclo
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Modal Visualizar Ciclo */}
        {selectedCiclo && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setSelectedCiclo(null)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-sm sm:max-w-xl md:max-w-2xl w-full max-h-[90vh] overflow-y-auto`} onClick={(e) => e.stopPropagation()}>
              <div className="p-3 sm:p-5 md:p-6">
                <div className="flex justify-between items-center mb-6">
                  <h3 className={`text-lg sm:text-xl md:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                    {selectedCiclo.verdade}
                  </h3>
                  <button onClick={() => setSelectedCiclo(null)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                    <X size={20} className="sm:w-6 sm:h-6" />
                  </button>
                </div>

                <p className={`mb-4 text-xs sm:text-sm ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                  Encerrado em: {new Date(selectedCiclo.dataFim).toLocaleDateString('pt-BR')}
                </p>

                <div className="space-y-3 sm:space-y-4">
                  <h4 className={`font-bold text-sm sm:text-base ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Conquistas ({selectedCiclo.conquistas.length})
                  </h4>
                  {selectedCiclo.conquistas.map((conquista) => (
                    <div
                      key={conquista.id}
                      className={`p-3 sm:p-4 rounded-lg ${
                        conquista.levelUp
                          ? 'bg-gradient-to-r from-yellow-400 to-amber-500 text-gray-900'
                          : darkMode
                            ? 'bg-gray-700 text-white'
                            : 'bg-gray-100 text-gray-800'
                      }`}
                    >
                      <div className="flex flex-wrap items-center gap-2 mb-1 sm:mb-2">
                        <span className="font-bold text-sm sm:text-base">{conquista.nome}</span>
                        {conquista.levelUp && (
                          <span className="text-[10px] sm:text-xs px-1.5 py-0.5 sm:px-2 sm:py-1 bg-yellow-600 text-white rounded">Level Up!</span>
                        )}
                      </div>
                      {conquista.descricao && (
                        <p className={`text-xs sm:text-sm ${conquista.levelUp ? 'text-gray-800' : darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                          {conquista.descricao}
                        </p>
                      )}
                    </div>
                  ))}
                </div>

                <div className="flex justify-end mt-6">
                  <button
                    onClick={() => setSelectedCiclo(null)}
                    className="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-3 sm:px-5 md:px-6 py-2 rounded-lg hover:from-purple-700 hover:to-pink-700 font-semibold"
                  >
                    Fechar
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Modal Background */}
        {showBackgroundModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowBackgroundModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-sm sm:max-w-xl md:max-w-3xl w-full max-h-[90vh] overflow-y-auto`} onClick={(e) => e.stopPropagation()}>
              <div className="p-4 sm:p-5 md:p-6">
                <div className="flex justify-between items-center mb-4 sm:mb-6">
                  <h3 className={`text-lg sm:text-xl md:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                    Conte sua história
                  </h3>
                  <button onClick={() => setShowBackgroundModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                    <X size={20} className="sm:w-6 sm:h-6" />
                  </button>
                </div>

                <div className="mb-4 sm:mb-6">
                  <label className={`block text-xs sm:text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    História do seu personagem
                  </label>
                  <textarea
                    value={background}
                    onChange={(e) => {
                      if (e.target.value.length <= 2000) {
                        setBackground(e.target.value)
                      }
                    }}
                    className={`w-full px-3 py-2 sm:px-4 rounded-lg border-2 text-sm sm:text-base ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                    placeholder="Escreva a história do seu personagem..."
                    rows={10}
                  />
                  <p className={`text-[10px] sm:text-xs mt-2 ${background.length > 1900 ? 'text-red-500' : darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                    {background.length}/2000 caracteres
                  </p>
                </div>

                <div className="flex gap-3">
                  <button
                    onClick={() => setShowBackgroundModal(false)}
                    className={`flex-1 py-2.5 sm:py-3 rounded-lg font-semibold text-sm sm:text-base ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                  >
                    Cancelar
                  </button>
                  <button
                    onClick={() => {
                      setShowBackgroundModal(false)
                    }}
                    className="flex-1 bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-2.5 sm:py-3 rounded-lg hover:from-purple-700 hover:to-indigo-700 font-semibold text-sm sm:text-base"
                  >
                    Salvar
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}
        </div>

        {accountDataModal}
        {scenarioPopupOverlay}
        {mostrarTriunfosOverlay}
        {pokezapPanel}{pokeAgendaPanel}
        {batalhaChatPanel}
      </>
    )
  }

  // ÁREA BATALHA PKM (Treinador)
  if (currentUser.type === 'treinador' && currentArea === 'Batalha Pkm') {
    return (
      <>
        <div className={`min-h-screen ${mainBgClass}`}>
          {sidebarNav}
          <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-lg`}>
            <div className="max-w-7xl mx-auto px-4 py-4">
              <div className="flex justify-between items-center mb-4">
                <div className="flex items-center gap-3"><button onClick={() => setSidebarOpen(true)} className={`p-2 rounded-lg ${darkMode ? "hover:bg-gray-700 text-gray-400" : "hover:bg-gray-200 text-gray-500"}`}><Menu size={24} /></button><h2 className={`text-lg sm:text-xl md:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Batalha Pkm</h2></div>
                <div className="flex gap-1.5 sm:gap-2 items-center flex-shrink-0">
                  <button onClick={() => setShowAccountDataModal(true)} className={`p-1.5 sm:p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-200 text-gray-700'}`} title="Dados da Conta"><ArrowDownUp size={18} className="sm:w-5 sm:h-5" /></button>
                  <button onClick={() => setDarkMode(!darkMode)} className={`p-1.5 sm:p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-yellow-400' : 'bg-gray-200 text-gray-700'}`}>{darkMode ? <Sun size={18} className="sm:w-5 sm:h-5" /> : <Moon size={18} className="sm:w-5 sm:h-5" />}</button>
                  {pokezapBtn}{pokeAgendaBtn}{batalhaChatBtn}<button onClick={handleLogout} className="bg-red-500 text-white px-2 sm:px-5 md:px-6 py-1.5 sm:py-2 rounded-lg hover:bg-red-600 text-sm sm:text-base">Sair</button>
                  {currentClima && <div className="flex items-center gap-1 ml-1"><img src={`/pokeballs/${currentClima.image}`} alt={currentClima.name} className="w-5 h-5 sm:w-7 sm:h-7" /><span className={`text-[10px] sm:text-xs font-semibold ${darkMode ? 'text-gray-300' : 'text-gray-600'} hidden xs:inline`}>{currentClima.name}</span></div>}
                </div>
              </div>
            </div>
          </div>

          <div className="max-w-7xl mx-auto px-4 py-3 sm:py-5 md:py-8">
            {/* Navegação Mapa/Rolagens (Treinador) */}
            <div className="mb-6 flex gap-2 sm:gap-3 md:gap-4 justify-center">
              <button
                onClick={() => setBattleView('mapa')}
                className={`px-3 sm:px-5 md:px-6 py-3 rounded-lg font-semibold transition-all ${
                  battleView === 'mapa'
                    ? 'bg-gradient-to-r from-green-600 to-teal-600 text-white shadow-lg'
                    : darkMode
                    ? 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                    : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                }`}
              >
                Mapa Treinador
              </button>
              <button
                onClick={() => setBattleView('rolagens')}
                className={`px-3 sm:px-5 md:px-6 py-3 rounded-lg font-semibold transition-all ${
                  battleView === 'rolagens'
                    ? 'bg-gradient-to-r from-blue-600 to-purple-700 text-white shadow-lg'
                    : darkMode
                    ? 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                    : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                }`}
              >
                Rolagens Treinador
              </button>
            </div>

            {/* ÁREA DO MAPA (VTT) - TREINADOR */}
            {battleView === 'mapa' && (
              <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-8`}>
                <h3 className={`text-2xl sm:text-3xl font-bold mb-6 text-center ${darkMode ? 'text-green-400' : 'text-green-600'}`}>
                  Mapa de Batalha
                </h3>

                {/* Mostrar localidade atual */}
                {currentVttLocation && vttLocations.length > 0 && (
                  <div className={`mb-4 text-center py-3 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                    <span className={`text-lg font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                      Localização Atual: {vttLocations.find(loc => loc.id === currentVttLocation)?.name || 'Desconhecida'}
                    </span>
                  </div>
                )}

                {/* Aviso Mobile */}
                <div className={`mb-4 p-3 rounded-lg md:hidden ${darkMode ? 'bg-yellow-900 border border-yellow-700' : 'bg-yellow-100 border border-yellow-400'}`}>
                  <p className={`text-sm text-center ${darkMode ? 'text-yellow-200' : 'text-yellow-800'}`}>
                    ⚠️ O mapa funciona melhor em telas maiores. Use pinça para zoom e arraste para navegar.
                  </p>
                </div>

                {/* Container com scroll para o Canvas */}
                <div
                  className={`overflow-auto rounded-lg border-2 ${darkMode ? 'border-gray-600' : 'border-gray-300'}`}
                  style={{
                    width: '100%',
                    height: 'min(80vh, 600px)',
                    maxWidth: '100%'
                  }}
                >
                  {/* Canvas do Mapa - Dimensões Customizáveis */}
                  <div
                    ref={setCanvasRef}
                    data-vtt-canvas="true"
                    className={`relative ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}
                    style={{
                      width: `${vttCanvasWidth}px`,
                      height: `${vttCanvasHeight}px`,
                      cursor: vttIsPanning ? 'grabbing' : 'default'
                    }}
                    onMouseDown={handlePanStart}
                    onMouseMove={(e) => {
                      handlePanMove(e)
                      if (!vttIsPanning) handleTokenMouseMove(e)
                    }}
                    onMouseUp={(e) => {
                      handlePanEnd()
                      handleTokenMouseUp(e)
                    }}
                    onMouseLeave={handlePanEnd}
                    onContextMenu={(e) => e.preventDefault()}
                  >
                    <div
                      className="absolute"
                      style={{
                        width: `${vttCanvasWidth}px`,
                        height: `${vttCanvasHeight}px`,
                        transform: `translate(${vttViewportOffset.x}px, ${vttViewportOffset.y}px) scale(${vttViewportZoom})`,
                        transformOrigin: 'center center'
                      }}
                    >
                    {vttMapImage && (
                      <img
                        src={vttMapImage}
                        alt="Mapa"
                        className="absolute"
                        style={{
                          left: '50%',
                          top: '50%',
                          transform: `translate(calc(-50% + ${vttMapPosition.x}px), calc(-50% + ${vttMapPosition.y}px)) scale(${vttMapScale / 100})`,
                          transformOrigin: 'center center',
                          maxWidth: 'none',
                          maxHeight: 'none',
                          zIndex: 0
                        }}
                      />
                    )}
                    {!vttMapImage && (
                      <div className={`flex items-center justify-center h-full ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                        <p className="text-lg sm:text-xl">Aguardando o mestre configurar o mapa</p>
                      </div>
                    )}

                    {/* Grid Overlay */}
                    {vttShowGrid && vttMapImage && (() => {
                      const cellWidth = vttCanvasWidth / vttGridColumns
                      const cellHeight = vttCanvasHeight / vttGridRows
                      return (
                        <svg className="absolute inset-0 w-full h-full pointer-events-none" style={{ opacity: 0.3 }}>
                          {Array.from({ length: vttGridRows }).map((_, row) =>
                            Array.from({ length: vttGridColumns }).map((_, col) => (
                              <rect
                                key={`grid-${row}-${col}`}
                                x={col * cellWidth}
                                y={row * cellHeight}
                                width={cellWidth}
                                height={cellHeight}
                                fill="none"
                                stroke={darkMode ? '#ffffff' : '#000000'}
                                strokeWidth="1"
                              />
                            ))
                          )}
                        </svg>
                      )
                    })()}

                    {/* Régua de Medição */}
                    {vttRulerActive && (() => {
                      const cellWidth = vttCanvasWidth / vttGridColumns
                      const cellHeight = vttCanvasHeight / vttGridRows
                      // Calcular distância em pixels
                      const dx = vttRulerEnd.x - vttRulerStart.x
                      const dy = vttRulerEnd.y - vttRulerStart.y
                      const distancePixels = Math.sqrt(dx * dx + dy * dy)
                      // Converter para metros (1 quadrado = 1 metro)
                      const avgCellSize = (cellWidth + cellHeight) / 2
                      const distanceMeters = distancePixels / avgCellSize
                      // Posição do texto (meio da linha)
                      const midX = (vttRulerStart.x + vttRulerEnd.x) / 2
                      const midY = (vttRulerStart.y + vttRulerEnd.y) / 2
                      return (
                        <svg className="absolute inset-0 w-full h-full pointer-events-none" style={{ zIndex: 1000 }}>
                          {/* Linha da régua */}
                          <line
                            x1={vttRulerStart.x}
                            y1={vttRulerStart.y}
                            x2={vttRulerEnd.x}
                            y2={vttRulerEnd.y}
                            stroke="#ffcc00"
                            strokeWidth="3"
                            strokeDasharray="8,4"
                          />
                          {/* Círculo no início */}
                          <circle
                            cx={vttRulerStart.x}
                            cy={vttRulerStart.y}
                            r="6"
                            fill="#ffcc00"
                            stroke="#000"
                            strokeWidth="2"
                          />
                          {/* Círculo no fim */}
                          <circle
                            cx={vttRulerEnd.x}
                            cy={vttRulerEnd.y}
                            r="6"
                            fill="#ffcc00"
                            stroke="#000"
                            strokeWidth="2"
                          />
                          {/* Fundo do texto */}
                          <rect
                            x={midX - 35}
                            y={midY - 14}
                            width="70"
                            height="28"
                            rx="4"
                            fill="rgba(0,0,0,0.8)"
                          />
                          {/* Texto com distância */}
                          <text
                            x={midX}
                            y={midY + 5}
                            textAnchor="middle"
                            fill="#ffcc00"
                            fontSize="16"
                            fontWeight="bold"
                            style={{ userSelect: 'none' }}
                          >
                            {distanceMeters.toFixed(1)}m
                          </text>
                        </svg>
                      )
                    })()}

                    {/* Tokens da camada MAPA (visível para todos, embaixo de tudo) */}
                    {vttMapTokens.map(token => (
                      <div
                        key={token.id}
                        className="absolute"
                        style={{
                          left: `${token.x}px`,
                          top: `${token.y}px`,
                          width: `${token.size}px`,
                          height: `${token.size}px`,
                          cursor: 'default',
                          border: '2px solid #b45309',
                          borderRadius: '50%',
                          overflow: 'hidden',
                          transform: `rotate(${token.rotation || 0}deg)`,
                          userSelect: 'none',
                          zIndex: 1
                        }}
                      >
                        {token.image && (
                          <img
                            src={token.image}
                            alt={token.name}
                            className="w-full h-full object-cover"
                            style={token.npcType === 'trainer' ? { objectPosition: 'center 20%' } : {}}
                          />
                        )}
                        {!token.image && (
                          <div className="w-full h-full bg-amber-600 flex items-center justify-center text-white font-bold">
                            {token.name?.charAt(0) || 'M'}
                          </div>
                        )}
                        <div className="absolute bottom-0 left-0 right-0 bg-amber-900 bg-opacity-90 text-white text-xs text-center px-1 truncate">
                          {token.name}
                        </div>
                      </div>
                    ))}

                    {/* Tokens da camada de JOGADORES (visível para todos) */}
                    {vttTokens.map(token => (
                      <div
                        key={token.id}
                        className="absolute"
                        onMouseDown={(e) => handleTokenMouseDown(token.id, 'tokens', e)}
                        style={{
                          left: `${token.x}px`,
                          top: `${token.y}px`,
                          width: `${token.size}px`,
                          height: `${token.size}px`,
                          cursor: token.owner === currentUser.username ? 'move' : 'default',
                          border: selectedToken === token.id ? '3px solid yellow' : '2px solid black',
                          borderRadius: '50%',
                          overflow: 'hidden',
                          transform: `rotate(${token.rotation || 0}deg)`,
                          userSelect: 'none',
                          zIndex: 3
                        }}
                      >
                        {token.image && (
                          <img
                            src={token.image}
                            alt={token.name}
                            className="w-full h-full object-cover"
                            style={token.npcType === 'trainer' ? { objectPosition: 'center 20%' } : {}}
                          />
                        )}
                        {!token.image && (
                          <div className="w-full h-full bg-blue-500 flex items-center justify-center text-white font-bold">
                            {token.name?.charAt(0) || 'T'}
                          </div>
                        )}
                        <div className="absolute bottom-0 left-0 right-0 bg-black bg-opacity-70 text-white text-xs text-center px-1 truncate">
                          {token.name}
                        </div>
                      </div>
                    ))}
                    </div>
                  </div>
                </div>

                <div className={`mt-4 text-center text-xs sm:text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                  <p>Arraste seus tokens para movê-los no mapa. Clique e segure com o botão direito para arrastar a visualização.</p>
                </div>
              </div>
            )}

            {/* Layout Superior: Duas Colunas */}
            {battleView === 'rolagens' && (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4 md:gap-6 mb-6">

              {/* PARTE 1: Em Batalha (Esquerda) */}
              <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-6`}>
                <h3 className={`text-xl sm:text-2xl font-bold mb-6 text-center ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>
                  Treinadores em Batalha
                </h3>
                <div className={`p-4 rounded-lg border-2 min-h-[250px] max-h-[400px] overflow-y-auto ${darkMode ? 'bg-gray-700 border-blue-500' : 'bg-blue-50 border-blue-300'}`}>
                  {battleTrainersList.length === 0 ? (
                    <p className={`text-center ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                      Aguardando o mestre montar a batalha
                    </p>
                  ) : (
                    <div className="space-y-2">
                      {battleTrainersList.map((trainer, idx) => {
                        const stages = trainerStages[trainer.id] || { defesa: 0, defesaEspecial: 0, velocidade: 0 }
                        const evasoes = calcularEvasoes(
                          trainer.baseAttributes?.defesa || 0,
                          trainer.baseAttributes?.defesaEspecial || 0,
                          trainer.baseAttributes?.velocidade || trainer.velocidade || 0,
                          stages,
                          true
                        )

                        return (
                          <div
                            key={trainer.id}
                            className={`p-3 rounded-lg border-2 ${
                              idx === currentTrainerTurn
                                ? darkMode ? 'bg-yellow-900 border-yellow-500' : 'bg-yellow-100 border-yellow-500'
                                : darkMode ? 'bg-gray-600 border-gray-500' : 'bg-white border-gray-300'
                            }`}
                          >
                            <div className="flex items-center justify-between">
                              <div className={`font-semibold ${idx === currentTrainerTurn ? 'text-yellow-600' : darkMode ? 'text-white' : 'text-gray-800'}`}>
                                {idx === currentTrainerTurn && '▶ '}
                                {/* Se for NPC e não revelado, mostrar nome falso. Se for o próprio treinador ou revelado, mostrar nome real */}
                                {trainer.nome === currentUser?.username || !trainer.isNpc || revealedTrainers[trainer.id] ? trainer.nome : (trainer.nomeFalso || 'NPC')}
                              </div>
                              <span className={`text-xs px-2 py-1 rounded ${darkMode ? 'bg-gray-700 text-gray-300' : 'bg-gray-200 text-gray-600'}`}>
                                Vel: {trainer.velocidade}
                              </span>
                            </div>
                            <div className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                              {/* HP visível apenas para o próprio treinador */}
                              {trainer.nome === currentUser?.username ? (
                                <span>HP: {trainer.hp}/{trainer.maxHP}</span>
                              ) : (
                                <span>HP: ???</span>
                              )}
                            </div>
                            <div className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                              {/* Evasões visíveis para todos, calculadas com fases */}
                              <span>Evasões - F: {evasoes.evasaoFisica} | E: {evasoes.evasaoEspecial} | V: {evasoes.evasaoVeloz}</span>
                            </div>
                          </div>
                        )
                      })}
                    </div>
                  )}
                </div>

                {/* Em Batalha - Pokémon */}
                <h3 className={`text-xl sm:text-2xl font-bold mb-6 mt-8 text-center ${darkMode ? 'text-red-400' : 'text-red-600'}`}>
                  Pokémon em Batalha
                </h3>
                <div className={`p-4 rounded-lg border-2 min-h-[250px] max-h-[400px] overflow-y-auto ${darkMode ? 'bg-gray-700 border-red-500' : 'bg-red-50 border-red-300'}`}>
                  {battlePokemonList.length === 0 ? (
                    <p className={`text-center ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                      Aguardando o mestre montar a batalha
                    </p>
                  ) : (
                    <div className="space-y-2">
                      {battlePokemonList.map((pokemon, idx) => {
                        const pokemonConditions = battlePokemonConditions[pokemon.id] || [null, null, null]
                        const stages = pokemonStages[pokemon.id] || { defesa: 0, defesaEspecial: 0, velocidade: 0 }
                        const evasoes = calcularEvasoes(
                          pokemon.totalAttributes?.defesa || 0,
                          pokemon.totalAttributes?.defesaEspecial || 0,
                          pokemon.totalAttributes?.velocidade || pokemon.velocidade || 0,
                          stages
                        )

                        return (
                          <div
                            key={pokemon.id}
                            className={`p-3 rounded-lg border-2 ${
                              idx === currentPokemonTurn
                                ? darkMode ? 'bg-yellow-900 border-yellow-500' : 'bg-yellow-100 border-yellow-500'
                                : darkMode ? 'bg-gray-600 border-gray-500' : 'bg-white border-gray-300'
                            }`}
                          >
                            <div className="flex items-center justify-between">
                              <div className={`font-semibold ${idx === currentPokemonTurn ? 'text-yellow-600' : darkMode ? 'text-white' : 'text-gray-800'}`}>
                                {idx === currentPokemonTurn && '▶ '}
                                {/* Mostrar nome real se não for NPC, se for o dono, ou se revelar estiver ativo */}
                                {(!pokemon.isNpc || pokemon.owner === currentUser?.username || revealedNpcPokemon[pokemon.id]) ? pokemon.nome : (pokemon.nomeFalso || pokemon.nome)}
                              </div>
                              <span className={`text-xs px-2 py-1 rounded ${darkMode ? 'bg-gray-700 text-gray-300' : 'bg-gray-200 text-gray-600'}`}>
                                Vel: {pokemon.velocidade}
                              </span>
                            </div>
                            <div className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                              {/* Mostrar espécie real se não for NPC, se for o dono, ou se revelar estiver ativo */}
                              {(!pokemon.isNpc || pokemon.owner === currentUser?.username || revealedNpcPokemon[pokemon.id]) ? pokemon.especie : '???'}
                              {/* Mostrar HP apenas para o dono */}
                              {pokemon.owner === currentUser?.username && (
                                <span> | HP: {pokemon.hp}/{pokemon.maxHP}</span>
                              )}
                            </div>
                            <div className={`text-xs flex gap-1 mt-1`}>
                              {/* Mostrar tipos reais se não for NPC, se for o dono, ou se revelar estiver ativo */}
                              {(!pokemon.isNpc || pokemon.owner === currentUser?.username || revealedNpcPokemon[pokemon.id]) ? (
                                (pokemon.tipos || []).map((tipo, i) => (
                                  <span key={i} className="px-2 py-0.5 rounded text-white text-xs" style={{ backgroundColor: TYPE_COLORS[tipo] || '#777' }}>
                                    {tipo}
                                  </span>
                                ))
                              ) : (
                                <span className="px-2 py-0.5 rounded text-white text-xs bg-gray-500">
                                  ???
                                </span>
                              )}
                            </div>
                            {/* Evasões - visíveis para todos, calculadas com fases */}
                            <div className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                              Evasões - F: {evasoes.evasaoFisica} | E: {evasoes.evasaoEspecial} | V: {evasoes.evasaoVeloz}
                            </div>

                            {/* Condições - Editable se for o dono, read-only se não for */}
                            {pokemon.owner === currentUser?.username ? (
                              <div className={`mt-2 pt-2 border-t ${darkMode ? 'border-gray-500' : 'border-gray-300'}`}>
                                <label className={`text-xs font-semibold mb-1 block ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                  Condições:
                                </label>
                                <select
                                  className={`w-full text-xs px-2 py-1 rounded mb-2 ${darkMode ? 'bg-gray-700 text-white border-gray-600' : 'bg-white text-gray-800 border-gray-300'} border`}
                                  onChange={(e) => {
                                    if (e.target.value) {
                                      const newConditions = [...pokemonConditions]
                                      const emptySlot = newConditions.findIndex(c => c === null)
                                      if (emptySlot !== -1) {
                                        newConditions[emptySlot] = { condition: e.target.value, rounds: 1 }
                                        setBattlePokemonConditions({
                                          ...battlePokemonConditions,
                                          [pokemon.id]: newConditions
                                        })
                                      }
                                      e.target.value = ''
                                    }
                                  }}
                                  value=""
                                >
                                  <option value="">Selecione uma condição</option>
                                  <option value="confusao">😵 Confusão</option>
                                  <option value="critico">🍀 Crítico</option>
                                  <option value="paralisia">⚡ Paralisia</option>
                                  <option value="sono">💤 Sono</option>
                                  <option value="atordoamento">🌀 Atordoamento</option>
                                  <option value="congelamento">❄️ Congelamento</option>
                                  <option value="paixao">❤️ Paixão</option>
                                  <option value="queimadura">🔥 Queimadura</option>
                                  <option value="veneno">☠️ Veneno</option>
                                </select>

                                <div className="grid grid-cols-3 gap-1">
                                  {pokemonConditions.map((cond, slotIdx) => (
                                    <div
                                      key={slotIdx}
                                      className={`relative text-center p-2 rounded border-2 ${
                                        cond
                                          ? darkMode ? 'bg-gray-700 border-blue-500' : 'bg-blue-50 border-blue-400'
                                          : darkMode ? 'bg-gray-800 border-gray-600' : 'bg-gray-100 border-gray-300'
                                      }`}
                                    >
                                      {cond ? (
                                        <>
                                          <button
                                            onClick={() => {
                                              const newConditions = [...pokemonConditions]
                                              newConditions[slotIdx] = null
                                              setBattlePokemonConditions({
                                                ...battlePokemonConditions,
                                                [pokemon.id]: newConditions
                                              })
                                            }}
                                            className="absolute -top-1 -right-1 w-4 h-4 bg-red-500 text-white rounded-full text-xs flex items-center justify-center hover:bg-red-600"
                                          >
                                            ×
                                          </button>
                                          <div className="text-lg mb-1">
                                            {cond.condition === 'confusao' && '😵'}
                                            {cond.condition === 'critico' && '🍀'}
                                            {cond.condition === 'paralisia' && '⚡'}
                                            {cond.condition === 'sono' && '💤'}
                                            {cond.condition === 'atordoamento' && '🌀'}
                                            {cond.condition === 'congelamento' && '❄️'}
                                            {cond.condition === 'paixao' && '❤️'}
                                            {cond.condition === 'queimadura' && '🔥'}
                                            {cond.condition === 'veneno' && '☠️'}
                                          </div>
                                          <div className="flex items-center justify-center gap-1">
                                            <button
                                              onClick={() => {
                                                const newConditions = [...pokemonConditions]
                                                newConditions[slotIdx].rounds = Math.max(0, newConditions[slotIdx].rounds - 1)
                                                setBattlePokemonConditions({
                                                  ...battlePokemonConditions,
                                                  [pokemon.id]: newConditions
                                                })
                                              }}
                                              className={`w-5 h-5 rounded text-xs font-bold ${darkMode ? 'bg-gray-600 hover:bg-gray-500 text-white' : 'bg-gray-300 hover:bg-gray-400 text-gray-800'}`}
                                            >
                                              -
                                            </button>
                                            <span className={`text-xs font-bold min-w-[20px] ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                              {cond.rounds}
                                            </span>
                                            <button
                                              onClick={() => {
                                                const newConditions = [...pokemonConditions]
                                                newConditions[slotIdx].rounds += 1
                                                setBattlePokemonConditions({
                                                  ...battlePokemonConditions,
                                                  [pokemon.id]: newConditions
                                                })
                                              }}
                                              className={`w-5 h-5 rounded text-xs font-bold ${darkMode ? 'bg-gray-600 hover:bg-gray-500 text-white' : 'bg-gray-300 hover:bg-gray-400 text-gray-800'}`}
                                            >
                                              +
                                            </button>
                                          </div>
                                        </>
                                      ) : (
                                        <div className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>-</div>
                                      )}
                                    </div>
                                  ))}
                                </div>
                              </div>
                            ) : (
                              /* Read-only condições para pokémon de outros */
                              pokemonConditions.some(c => c !== null) && (
                                <div className={`mt-2 pt-2 border-t ${darkMode ? 'border-gray-500' : 'border-gray-300'}`}>
                                  <div className="flex gap-2 items-center flex-wrap">
                                    {pokemonConditions.map((cond, slotIdx) => (
                                      cond && (
                                        <div key={slotIdx} className={`text-center px-2 py-1 rounded ${darkMode ? 'bg-gray-700' : 'bg-gray-200'}`}>
                                          <span className="text-sm">
                                            {cond.condition === 'confusao' && '😵'}
                                            {cond.condition === 'critico' && '🍀'}
                                            {cond.condition === 'paralisia' && '⚡'}
                                            {cond.condition === 'sono' && '💤'}
                                            {cond.condition === 'atordoamento' && '🌀'}
                                            {cond.condition === 'congelamento' && '❄️'}
                                            {cond.condition === 'paixao' && '❤️'}
                                            {cond.condition === 'queimadura' && '🔥'}
                                            {cond.condition === 'veneno' && '☠️'}
                                          </span>
                                          <span className={`text-xs ml-1 font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                            {cond.rounds}
                                          </span>
                                        </div>
                                      )
                                    ))}
                                  </div>
                                </div>
                              )
                            )}
                          </div>
                        )
                      })}
                    </div>
                  )}
                </div>
              </div>

              {/* PARTE 2: Time Principal e Detalhes (Direita) */}
              <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-6`}>
                {/* Seção do Treinador */}
                <div className={`${darkMode ? 'bg-gray-900' : 'bg-gray-50'} rounded-lg p-4 mb-4`}>
                  <div className="flex items-center gap-2">
                    <button
                      onClick={() => setSelectedTeamPokemon(null)}
                      className={`flex-1 text-left p-3 rounded-lg transition-colors font-bold ${
                        !selectedTeamPokemon
                          ? darkMode ? 'bg-blue-700 border-2 border-blue-500' : 'bg-blue-200 border-2 border-blue-500'
                          : darkMode ? 'bg-gray-800 hover:bg-gray-700' : 'bg-white hover:bg-gray-100'
                      }`}
                    >
                      {currentUser?.username || 'Treinador'}
                    </button>
                    <button
                      onClick={() => sendTrainerToBattle()}
                      className="p-3 bg-cyan-500 text-white rounded-lg hover:bg-cyan-600"
                      title="Enviar para Batalha Treinador Pkm"
                    >
                      <PlusCircle size={18} />
                    </button>
                  </div>

                  {!selectedTeamPokemon && (
                    <div className="mt-4 space-y-3">
                      {/* Botão Dano/Cura Treinador */}
                      <button
                        onClick={() => setShowTrainerBattleDamageModal(true)}
                        className={`w-full flex items-center justify-center gap-2 py-3 rounded-lg font-semibold ${darkMode ? 'bg-gradient-to-r from-red-700 to-green-700 hover:from-red-600 hover:to-green-600' : 'bg-gradient-to-r from-red-500 to-green-500 hover:from-red-600 hover:to-green-600'} text-white`}
                      >
                        <Sword size={18} />
                        Dano/Cura Treinador
                        <Heart size={18} />
                      </button>

                      {/* Perícias */}
                      <div>
                        <h5 className={`text-xs font-semibold mb-2 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                          Perícias:
                        </h5>
                        <div className="grid grid-cols-2 gap-1">
                          {Object.entries(skills).map(([attr, skillList]) => {
                            const attrNames = {
                              saude: 'Saúde',
                              ataque: 'Ataque',
                              defesa: 'Defesa',
                              ataqueEspecial: 'Ataque Especial',
                              defesaEspecial: 'Defesa Especial',
                              velocidade: 'Velocidade'
                            }

                            return skillList.map((skill, idx) => {
                              const count = skillList.filter(s => s === skill).length
                              const isFirst = skillList.indexOf(skill) === idx

                              if (!isFirst) return null

                              const modifier = getModifier(attributes[attr])

                              return (
                                <button
                                  key={`${attr}-${skill}-${idx}`}
                                  onClick={() => {
                                    // Rolar 1d20
                                    const d20Roll = Math.floor(Math.random() * 20) + 1

                                    // Calcular bônus baseado em quantas vezes a perícia foi selecionada
                                    let baseBonus, modifierMultiplier
                                    if (count === 1) {
                                      baseBonus = 2
                                      modifierMultiplier = 1
                                    } else {
                                      baseBonus = 4
                                      modifierMultiplier = 2
                                    }

                                    const modifierBonus = modifierMultiplier * modifier
                                    const total = d20Roll + baseBonus + modifierBonus

                                    const timestamp = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
                                    const message = `🎲 ${skill} (${attrNames[attr]})\n1d20 = ${d20Roll} | ${baseBonus} + ${modifierMultiplier > 1 ? `${modifierMultiplier}x` : ''}Modificador(${modifier}) = ${modifierBonus}\nTotal: ${total}`

                                    addChatMessage({
                                      username: currentUser.username,
                                      text: message,
                                      timestamp,
                                      isDiceRoll: true,
                                      diceResult: message
                                    })
                                  }}
                                  className={`text-xs p-2 rounded ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-white hover:bg-gray-100 text-gray-800 border'}`}
                                >
                                  {skill} {count > 1 && `(x${count})`}
                                </button>
                              )
                            })
                          })}
                        </div>
                      </div>

                      {/* Botões de Ataque e Dano do Treinador */}
                      <div className="flex gap-2 mt-3">
                        <button
                          onClick={() => {
                            const d20Roll = Math.floor(Math.random() * 20) + 1
                            const timestamp = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })

                            // Buscar o treinador na lista de batalha para pegar o ID
                            const trainerInBattle = battleTrainersList.find(t => t.nome === currentUser?.username)
                            const trainerId = trainerInBattle?.id || currentUser?.username
                            const stages = trainerStages[trainerId] || { precisao: 0 }
                            const precisaoStage = stages.precisao || 0

                            // Acurácia do ataque: 4 com Arma de Escolha, 6 sem
                            const acuraciaAtaque = armaDeEscolha ? 4 : 6

                            // Calcular resultado final com modificador de precisão
                            const finalResult = d20Roll + precisaoStage
                            let detailsParts = `1d20 = ${d20Roll}`
                            if (precisaoStage !== 0) {
                              detailsParts += ` | Fase Precisão: ${precisaoStage >= 0 ? '+' : ''}${precisaoStage}`
                            }

                            const message = `🎲 Ataque Treinador (Acurácia: ${acuraciaAtaque})\n${detailsParts}\nTotal: ${finalResult}`

                            addChatMessage({
                              username: currentUser.username,
                              text: message,
                              timestamp,
                              isDiceRoll: true,
                              diceResult: finalResult
                            })
                          }}
                          className={`flex-1 p-3 rounded-lg flex items-center justify-center gap-1 ${darkMode ? 'bg-purple-600 hover:bg-purple-700' : 'bg-purple-500 hover:bg-purple-600'} text-white`}
                          title="Ataque Treinador"
                        >
                          <Dices size={20} />
                          <span className="text-xs">({armaDeEscolha ? 4 : 6})</span>
                        </button>
                        <button
                          onClick={() => {
                            const ataqueBase = attributes?.ataque || 0

                            // Buscar o treinador na lista de batalha para pegar o ID e aplicar fases
                            const trainerInBattle = battleTrainersList.find(t => t.nome === currentUser?.username)
                            const trainerId = trainerInBattle?.id || currentUser?.username
                            const stages = trainerStages[trainerId] || { ataque: 0 }
                            const ataqueStage = stages.ataque || 0
                            const ataqueMultiplier = getStageMultiplier(ataqueStage)
                            const ataqueTotal = Math.floor(ataqueBase * ataqueMultiplier)

                            let damageRoll, damageBonus, diceType

                            // Determinar dano baseado no nível e se usa Arma de Escolha
                            if (armaDeEscolha) {
                              // Tabela de dano com Arma de Escolha
                              if (level >= 1 && level <= 6) {
                                diceType = '1d12+6'
                                damageRoll = Math.floor(Math.random() * 12) + 1
                                damageBonus = 6
                              } else if (level >= 7 && level <= 14) {
                                diceType = '2d10+8'
                                const dice1 = Math.floor(Math.random() * 10) + 1
                                const dice2 = Math.floor(Math.random() * 10) + 1
                                damageRoll = dice1 + dice2
                                damageBonus = 8
                              } else {
                                diceType = '3d10+12'
                                const dice1 = Math.floor(Math.random() * 10) + 1
                                const dice2 = Math.floor(Math.random() * 10) + 1
                                const dice3 = Math.floor(Math.random() * 10) + 1
                                damageRoll = dice1 + dice2 + dice3
                                damageBonus = 12
                              }
                            } else {
                              // Tabela de dano padrão
                              if (level >= 1 && level <= 6) {
                                diceType = '1d10+4'
                                damageRoll = Math.floor(Math.random() * 10) + 1
                                damageBonus = 4
                              } else if (level >= 7 && level <= 14) {
                                diceType = '1d12+6'
                                damageRoll = Math.floor(Math.random() * 12) + 1
                                damageBonus = 6
                              } else {
                                diceType = '2d8+6'
                                const dice1 = Math.floor(Math.random() * 8) + 1
                                const dice2 = Math.floor(Math.random() * 8) + 1
                                damageRoll = dice1 + dice2
                                damageBonus = 6
                              }
                            }

                            const baseDamage = damageRoll + damageBonus
                            const totalDamage = baseDamage + ataqueTotal

                            // Mensagens personalizadas por usuário
                            const username = currentUser?.username || 'Treinador'
                            let attackMessage = ''

                            switch(username.toLowerCase()) {
                              case 'alocin':
                                attackMessage = `${username} atirou uma flecha e atingiu seu alvo, causou ${totalDamage} de dano`
                                break
                              case 'lila':
                                attackMessage = `${username} deu um nome horrível para seu alvo, causou ${totalDamage} de dano`
                                break
                              case 'ludovic':
                                attackMessage = `${username} atirou uma pedra envolta em papel e atingiu seu alvo, causou ${totalDamage} de dano`
                                break
                              case 'noryat':
                                attackMessage = `${username} correu e deu uma voadora e atingiu seu alvo, causou ${totalDamage} de dano`
                                break
                              case 'pedro':
                                attackMessage = `Treinador ${username} incendiou seu alvo, causou ${totalDamage} de dano`
                                break
                              default:
                                attackMessage = `${username} atacou seu alvo, causou ${totalDamage} de dano`
                            }

                            let stageInfo = ''
                            if (ataqueStage !== 0) {
                              stageInfo = ` [Fase ATQ: ${ataqueStage > 0 ? '+' : ''}${ataqueStage} → ${ataqueBase}→${ataqueTotal}]`
                            }

                            const timestamp = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
                            const message = `⚔️ ${attackMessage}\n${diceType} = ${damageRoll} + ${damageBonus} + ${ataqueTotal} (Ataque Total)${stageInfo} = ${totalDamage}`

                            addChatMessage({
                              username: currentUser.username,
                              text: message,
                              timestamp,
                              isDiceRoll: true,
                              diceResult: message
                            })
                          }}
                          className={`flex-1 p-3 rounded-lg flex items-center justify-center ${darkMode ? 'bg-purple-600 hover:bg-purple-700' : 'bg-purple-500 hover:bg-purple-600'} text-white`}
                          title="Dano Treinador"
                        >
                          <Sword size={20} className="text-purple-300" />
                        </button>
                      </div>

                      {/* Checkbox Arma de Escolha */}
                      <div className="flex items-center gap-2 mt-2">
                        <input
                          type="checkbox"
                          id="armaDeEscolha"
                          checked={armaDeEscolha}
                          onChange={(e) => setArmaDeEscolha(e.target.checked)}
                          className="w-4 h-4 rounded"
                        />
                        <label htmlFor="armaDeEscolha" className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                          Arma de escolha
                        </label>
                      </div>

                      {/* Fases do Treinador (controles interativos) */}
                      {(() => {
                        const trainerInBattle = battleTrainersList.find(t => t.nome === currentUser?.username)
                        if (!trainerInBattle) return null
                        const stages = trainerStages[trainerInBattle.id] || { ataque: 0, ataqueEspecial: 0, defesa: 0, defesaEspecial: 0, velocidade: 0, precisao: 0 }

                        const stageConfig = [
                          { key: 'ataque', label: 'ATQ', color: 'red' },
                          { key: 'ataqueEspecial', label: 'ATE', color: 'purple' },
                          { key: 'defesa', label: 'DEF', color: 'blue' },
                          { key: 'defesaEspecial', label: 'DEE', color: 'teal' },
                          { key: 'velocidade', label: 'VEL', color: 'yellow' },
                          { key: 'precisao', label: 'PREC', color: 'pink' }
                        ]

                        return (
                          <div className={`p-3 rounded-lg ${darkMode ? 'bg-gray-800' : 'bg-gray-100'}`}>
                            <h5 className={`text-xs font-semibold mb-2 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                              Suas Fases:
                            </h5>
                            <div className="grid grid-cols-3 gap-2">
                              {stageConfig.map(({ key, label, color }) => {
                                const value = stages[key] || 0
                                const colorClasses = {
                                  red: darkMode ? 'bg-red-900/50' : 'bg-red-100',
                                  purple: darkMode ? 'bg-purple-900/50' : 'bg-purple-100',
                                  blue: darkMode ? 'bg-blue-900/50' : 'bg-blue-100',
                                  teal: darkMode ? 'bg-teal-900/50' : 'bg-teal-100',
                                  yellow: darkMode ? 'bg-yellow-900/50' : 'bg-yellow-100',
                                  pink: darkMode ? 'bg-pink-900/50' : 'bg-pink-100'
                                }
                                return (
                                  <div key={key} className={`p-2 rounded ${colorClasses[color]}`}>
                                    <div className={`text-xs font-semibold text-center mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                      {label}
                                    </div>
                                    <div className="flex items-center justify-center gap-1">
                                      <button
                                        onClick={() => adjustTrainerStage(trainerInBattle.id, key, -1)}
                                        disabled={value <= -6}
                                        className={`w-5 h-5 rounded text-xs font-bold ${
                                          value <= -6
                                            ? 'bg-gray-500 text-gray-400 cursor-not-allowed'
                                            : darkMode
                                              ? 'bg-gray-600 hover:bg-gray-500 text-white'
                                              : 'bg-gray-300 hover:bg-gray-400 text-gray-800'
                                        }`}
                                      >
                                        ▼
                                      </button>
                                      <span className={`text-sm font-bold min-w-[24px] text-center ${
                                        value > 0 ? 'text-green-500' : value < 0 ? 'text-red-500' : darkMode ? 'text-gray-400' : 'text-gray-600'
                                      }`}>
                                        {value > 0 ? `+${value}` : value}
                                      </span>
                                      <button
                                        onClick={() => adjustTrainerStage(trainerInBattle.id, key, 1)}
                                        disabled={value >= 6}
                                        className={`w-5 h-5 rounded text-xs font-bold ${
                                          value >= 6
                                            ? 'bg-gray-500 text-gray-400 cursor-not-allowed'
                                            : darkMode
                                              ? 'bg-gray-600 hover:bg-gray-500 text-white'
                                              : 'bg-gray-300 hover:bg-gray-400 text-gray-800'
                                        }`}
                                      >
                                        ▲
                                      </button>
                                    </div>
                                  </div>
                                )
                              })}
                            </div>
                          </div>
                        )
                      })()}
                    </div>
                  )}
                </div>

                <h3 className={`text-xl sm:text-2xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  Seu Time
                </h3>

                {/* Caixa 1: Lista de Pokémons do Time Principal */}
                <div className={`${darkMode ? 'bg-gray-900' : 'bg-gray-50'} rounded-lg p-4 mb-4`}>
                  <h4 className={`text-sm font-bold mb-3 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Time Principal ({mainTeam.length})
                  </h4>
                  {mainTeam.length === 0 ? (
                    <p className={`text-center text-sm ${darkMode ? 'text-gray-500' : 'text-gray-400'} py-4`}>
                      Nenhum Pokémon no time principal
                    </p>
                  ) : (
                    <div className="space-y-2">
                      {mainTeam.map((pkmn, idx) => (
                        <div
                          key={idx}
                          onClick={() => setSelectedTeamPokemon(pkmn)}
                          className={`w-full text-left p-3 rounded-lg transition-colors cursor-pointer ${
                            selectedTeamPokemon === pkmn
                              ? darkMode ? 'bg-blue-700 border-2 border-blue-500' : 'bg-blue-200 border-2 border-blue-500'
                              : darkMode ? 'bg-gray-800 hover:bg-gray-700' : 'bg-white hover:bg-gray-100'
                          }`}
                        >
                          <div className="flex items-center justify-between">
                            <span className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                              {pkmn.nickname || pkmn.species}
                            </span>
                            <div className="flex items-center gap-2">
                              <span className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                Nv. {pkmn.level}
                              </span>
                              <button
                                onClick={(e) => {
                                  e.stopPropagation();
                                  setSelectedBattlePokemon(pkmn);
                                  setBattleHpValue('');
                                  setShowBattleHPModal(true);
                                }}
                                className="flex items-center gap-0.5 px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-xs"
                              >
                                <Sword size={12} /><Heart size={12} />
                              </button>
                              <button
                                onClick={(e) => {
                                  e.stopPropagation();
                                  sendPokemonToBattle(pkmn);
                                }}
                                className="flex items-center gap-1 px-2 py-1 bg-cyan-500 text-white rounded hover:bg-cyan-600 text-xs"
                              >
                                <ArrowRightCircle size={12} />
                              </button>
                            </div>
                          </div>
                          <div className="flex gap-1 mt-1">
                            {(pkmn.types || []).map((tipo, i) => (
                              <span key={i} className="px-2 py-0.5 rounded text-white text-xs" style={{ backgroundColor: TYPE_COLORS[tipo] || '#777' }}>
                                {tipo}
                              </span>
                            ))}
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>

                {/* Caixa 2: Detalhes do Pokémon Selecionado */}
                <div className={`${darkMode ? 'bg-gray-900' : 'bg-gray-50'} rounded-lg p-4`}>
                  <div className="flex justify-between items-center mb-3">
                    <h4 className={`text-sm font-bold ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      Detalhes
                    </h4>
                    {selectedTeamPokemon && (
                      <label className="flex items-center gap-2 cursor-pointer">
                        <input
                          type="checkbox"
                          checked={isCritical}
                          onChange={(e) => setIsCritical(e.target.checked)}
                          className="w-4 h-4 cursor-pointer"
                        />
                        <span className="text-sm font-bold text-red-600">CRIT</span>
                      </label>
                    )}
                  </div>
                  {!selectedTeamPokemon ? (
                    <p className={`text-center text-sm ${darkMode ? 'text-gray-500' : 'text-gray-400'} py-3 sm:py-5 md:py-8`}>
                      Selecione um Pokémon para ver seus detalhes
                    </p>
                  ) : (
                    <div className="space-y-3">
                      {/* Habilidades */}
                      <div>
                        <h5 className={`text-xs font-semibold mb-2 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                          Habilidades:
                        </h5>
                        <div className="space-y-1">
                          {selectedTeamPokemon.habilidades && selectedTeamPokemon.habilidades.length > 0 ? (
                            selectedTeamPokemon.habilidades.map((ability, idx) => (
                              <button
                                key={idx}
                                onClick={() => {
                                  setSelectedBattleAbility(ability)
                                  setShowBattleAbilityModal(true)
                                }}
                                className={`w-full text-left p-2 rounded transition-colors ${darkMode ? 'bg-gray-800 hover:bg-gray-700' : 'bg-white hover:bg-gray-100'}`}
                              >
                                <span className={`text-sm font-semibold ${darkMode ? 'text-blue-400' : 'text-blue-600'} cursor-pointer hover:underline`}>
                                  {ability}
                                </span>
                              </button>
                            ))
                          ) : (
                            <p className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                              Nenhuma habilidade
                            </p>
                          )}
                        </div>
                      </div>

                      {/* Golpes */}
                      <div>
                        <h5 className={`text-xs font-semibold mb-2 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                          Golpes:
                        </h5>
                        <div className="space-y-1">
                          {selectedTeamPokemon.golpes && selectedTeamPokemon.golpes.length > 0 ? (
                            selectedTeamPokemon.golpes.map((move, idx) => {
                              if (!move) return null
                              const moveName = typeof move === 'string' ? move : (move.nome || move.name || '')
                              if (!moveName) return null

                              return (
                                <div key={idx} className={`p-2 rounded ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
                                  <div className="flex items-center justify-between">
                                    <button
                                      onClick={() => {
                                        setSelectedBattleMove(moveName)
                                        setShowBattleMoveModal(true)
                                      }}
                                      className={`text-sm font-semibold ${darkMode ? 'text-white hover:text-blue-400' : 'text-gray-800 hover:text-blue-600'} cursor-pointer hover:underline transition-colors`}
                                    >
                                      {moveName}
                                    </button>
                                    <div className="flex items-center gap-2">
                                      {typeof move === 'object' && move.usos !== null && move.usos !== undefined && (
                                        <span className={`text-xs px-2 py-0.5 rounded ${darkMode ? 'bg-gray-700 text-gray-300' : 'bg-gray-200 text-gray-600'}`}>
                                          {move.usos} usos
                                        </span>
                                      )}
                                      <button
                                        onClick={() => handleRollAccuracy(moveName)}
                                        className={`p-1 rounded transition-colors ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-blue-400' : 'bg-gray-200 hover:bg-gray-300 text-blue-600'}`}
                                        title="Teste de Acurácia"
                                      >
                                        <Dices size={14} />
                                      </button>
                                      <button
                                        onClick={() => handleRollMoveDamage(moveName)}
                                        className={`p-1 rounded transition-colors ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-yellow-400' : 'bg-gray-200 hover:bg-gray-300 text-yellow-600'}`}
                                        title="Rolar Dano"
                                      >
                                        <Hand size={14} />
                                      </button>
                                    </div>
                                  </div>
                                </div>
                              )
                            })
                          ) : (
                            <p className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                              Nenhum golpe
                            </p>
                          )}
                        </div>
                      </div>

                      {/* Fases */}
                      {(() => {
                        // Buscar o Pokémon na batalha pelo originalId para usar o ID correto
                        const teamPokemonId = selectedTeamPokemon.id || `team-${selectedTeamPokemon.species}`
                        const pokemonInBattle = battlePokemonList.find(p => p.originalId === teamPokemonId)
                        // Se o Pokémon está em batalha, usar o ID de batalha; senão, usar o ID do time
                        const battleId = pokemonInBattle ? pokemonInBattle.id : teamPokemonId
                        const currentStages = pokemonStages[battleId] || { ataque: 0, ataqueEspecial: 0, defesa: 0, defesaEspecial: 0, velocidade: 0, precisao: 0 }

                        return (
                          <div className={`mt-3 pt-3 border-t ${darkMode ? 'border-gray-700' : 'border-gray-300'}`}>
                            <h5 className={`text-xs font-semibold mb-2 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                              Fases (-6 a +6):{pokemonInBattle ? '' : ' (Pokémon não está em batalha)'}
                            </h5>
                            <div className="grid grid-cols-2 gap-2 text-xs">
                              {/* Ataque */}
                              <div className={`flex items-center justify-between p-2 rounded ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
                                <span className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>ATQ</span>
                                <div className="flex items-center gap-1">
                                  <button
                                    onClick={() => adjustPokemonStage(battleId, 'ataque', -1)}
                                    className={`w-6 h-6 rounded flex items-center justify-center ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-800'}`}
                                  >
                                    ▼
                                  </button>
                                  <span className={`min-w-[24px] text-center font-bold ${
                                    currentStages.ataque > 0 ? 'text-green-500' :
                                    currentStages.ataque < 0 ? 'text-red-500' :
                                    darkMode ? 'text-white' : 'text-gray-800'
                                  }`}>
                                    {currentStages.ataque > 0 ? `+${currentStages.ataque}` : currentStages.ataque}
                                  </span>
                                  <button
                                    onClick={() => adjustPokemonStage(battleId, 'ataque', 1)}
                                    className={`w-6 h-6 rounded flex items-center justify-center ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-800'}`}
                                  >
                                    ▲
                                  </button>
                                </div>
                              </div>

                              {/* Ataque Especial */}
                              <div className={`flex items-center justify-between p-2 rounded ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
                                <span className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>ATQ ESP</span>
                                <div className="flex items-center gap-1">
                                  <button
                                    onClick={() => adjustPokemonStage(battleId, 'ataqueEspecial', -1)}
                                    className={`w-6 h-6 rounded flex items-center justify-center ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-800'}`}
                                  >
                                    ▼
                                  </button>
                                  <span className={`min-w-[24px] text-center font-bold ${
                                    currentStages.ataqueEspecial > 0 ? 'text-green-500' :
                                    currentStages.ataqueEspecial < 0 ? 'text-red-500' :
                                    darkMode ? 'text-white' : 'text-gray-800'
                                  }`}>
                                    {currentStages.ataqueEspecial > 0 ? `+${currentStages.ataqueEspecial}` : currentStages.ataqueEspecial}
                                  </span>
                                  <button
                                    onClick={() => adjustPokemonStage(battleId, 'ataqueEspecial', 1)}
                                    className={`w-6 h-6 rounded flex items-center justify-center ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-800'}`}
                                  >
                                    ▲
                                  </button>
                                </div>
                              </div>

                              {/* Defesa */}
                              <div className={`flex items-center justify-between p-2 rounded ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
                                <span className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>DEF</span>
                                <div className="flex items-center gap-1">
                                  <button
                                    onClick={() => adjustPokemonStage(battleId, 'defesa', -1)}
                                    className={`w-6 h-6 rounded flex items-center justify-center ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-800'}`}
                                  >
                                    ▼
                                  </button>
                                  <span className={`min-w-[24px] text-center font-bold ${
                                    currentStages.defesa > 0 ? 'text-green-500' :
                                    currentStages.defesa < 0 ? 'text-red-500' :
                                    darkMode ? 'text-white' : 'text-gray-800'
                                  }`}>
                                    {currentStages.defesa > 0 ? `+${currentStages.defesa}` : currentStages.defesa}
                                  </span>
                                  <button
                                    onClick={() => adjustPokemonStage(battleId, 'defesa', 1)}
                                    className={`w-6 h-6 rounded flex items-center justify-center ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-800'}`}
                                  >
                                    ▲
                                  </button>
                                </div>
                              </div>

                              {/* Defesa Especial */}
                              <div className={`flex items-center justify-between p-2 rounded ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
                                <span className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>DEF ESP</span>
                                <div className="flex items-center gap-1">
                                  <button
                                    onClick={() => adjustPokemonStage(battleId, 'defesaEspecial', -1)}
                                    className={`w-6 h-6 rounded flex items-center justify-center ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-800'}`}
                                  >
                                    ▼
                                  </button>
                                  <span className={`min-w-[24px] text-center font-bold ${
                                    currentStages.defesaEspecial > 0 ? 'text-green-500' :
                                    currentStages.defesaEspecial < 0 ? 'text-red-500' :
                                    darkMode ? 'text-white' : 'text-gray-800'
                                  }`}>
                                    {currentStages.defesaEspecial > 0 ? `+${currentStages.defesaEspecial}` : currentStages.defesaEspecial}
                                  </span>
                                  <button
                                    onClick={() => adjustPokemonStage(battleId, 'defesaEspecial', 1)}
                                    className={`w-6 h-6 rounded flex items-center justify-center ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-800'}`}
                                  >
                                    ▲
                                  </button>
                                </div>
                              </div>

                              {/* Velocidade */}
                              <div className={`flex items-center justify-between p-2 rounded ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
                                <span className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>VEL</span>
                                <div className="flex items-center gap-1">
                                  <button
                                    onClick={() => adjustPokemonStage(battleId, 'velocidade', -1)}
                                    className={`w-6 h-6 rounded flex items-center justify-center ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-800'}`}
                                  >
                                    ▼
                                  </button>
                                  <span className={`min-w-[24px] text-center font-bold ${
                                    currentStages.velocidade > 0 ? 'text-green-500' :
                                    currentStages.velocidade < 0 ? 'text-red-500' :
                                    darkMode ? 'text-white' : 'text-gray-800'
                                  }`}>
                                    {currentStages.velocidade > 0 ? `+${currentStages.velocidade}` : currentStages.velocidade}
                                  </span>
                                  <button
                                    onClick={() => adjustPokemonStage(battleId, 'velocidade', 1)}
                                    className={`w-6 h-6 rounded flex items-center justify-center ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-800'}`}
                                  >
                                    ▲
                                  </button>
                                </div>
                              </div>

                              {/* Precisão */}
                              <div className={`flex items-center justify-between p-2 rounded ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
                                <span className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>PREC</span>
                                <div className="flex items-center gap-1">
                                  <button
                                    onClick={() => adjustPokemonStage(battleId, 'precisao', -1)}
                                    className={`w-6 h-6 rounded flex items-center justify-center ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-800'}`}
                                  >
                                    ▼
                                  </button>
                                  <span className={`min-w-[24px] text-center font-bold ${
                                    currentStages.precisao > 0 ? 'text-green-500' :
                                    currentStages.precisao < 0 ? 'text-red-500' :
                                    darkMode ? 'text-white' : 'text-gray-800'
                                  }`}>
                                    {currentStages.precisao > 0 ? `+${currentStages.precisao}` : currentStages.precisao}
                                  </span>
                                  <button
                                    onClick={() => adjustPokemonStage(battleId, 'precisao', 1)}
                                    className={`w-6 h-6 rounded flex items-center justify-center ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-800'}`}
                                  >
                                    ▲
                                  </button>
                                </div>
                              </div>
                            </div>
                          </div>
                        )
                      })()}
                    </div>
                  )}
                </div>
              </div>

            </div>
            )}

            {/* SEÇÃO: Imagens do Treinador e Pokémon */}
            {battleView === 'rolagens' && (
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-6 mb-6`}>
              <div className="grid grid-cols-2 gap-2 sm:gap-3 md:gap-4">
                {/* Imagem do Treinador */}
                <div className={`${darkMode ? 'bg-gray-900' : 'bg-gray-50'} rounded-lg p-2 sm:p-4 flex flex-col items-center justify-center`}>
                  <h4 className={`text-xs sm:text-sm font-bold mb-2 sm:mb-3 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Treinador
                  </h4>
                  <div className="flex items-center gap-1 sm:gap-2">
                    {/* Shiny Charm (se o treinador possuir) */}
                    {keyItems.find(item => item.name === 'Shiny Charm') && (
                      <div
                        className="w-8 h-8 sm:w-12 sm:h-12 cursor-pointer hover:scale-110 transition-transform"
                        onClick={() => handleShinyCharmRoll(keyItems.find(item => item.name === 'Shiny Charm')?.luckyNumber)}
                        title={`Shiny Charm - Clique para rolar 1d1365 (Nº da Sorte: ${keyItems.find(item => item.name === 'Shiny Charm')?.luckyNumber})`}
                      >
                        <img
                          src="/pokeballs/shinycharm.png"
                          alt="Shiny Charm"
                          className="w-full h-full object-contain"
                        />
                      </div>
                    )}
                    {/* Imagem do Treinador */}
                    <div className="flex flex-col items-center">
                      {image ? (
                        <img
                          src={image}
                          alt={currentUser?.username || 'Treinador'}
                          className="w-20 h-20 sm:w-32 sm:h-32 object-cover rounded-lg"
                          onError={(e) => {
                            e.target.style.display = 'none'
                            e.target.nextSibling.style.display = 'flex'
                          }}
                        />
                      ) : null}
                      <div className={`w-20 h-20 sm:w-32 sm:h-32 ${image ? 'hidden' : 'flex'} items-center justify-center rounded-lg ${darkMode ? 'bg-gray-800' : 'bg-gray-200'}`}>
                        <User size={36} className={`sm:w-12 sm:h-12 ${darkMode ? 'text-gray-600' : 'text-gray-400'}`} />
                      </div>
                    </div>
                  </div>
                  <p className={`text-sm font-semibold mt-2 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                    {currentUser?.username || 'Treinador'}
                  </p>
                </div>

                {/* Imagem do Pokémon Selecionado */}
                <div className={`${darkMode ? 'bg-gray-900' : 'bg-gray-50'} rounded-lg p-2 sm:p-4 flex flex-col items-center justify-center`}>
                  <h4 className={`text-xs sm:text-sm font-bold mb-2 sm:mb-3 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Pokémon em Ação
                  </h4>
                  {selectedTeamPokemon ? (
                    <>
                      {(pokemonImages[sanitizeFirebaseKey(selectedTeamPokemon.id)] || selectedTeamPokemon.imageUrl) && (
                        <img
                          src={pokemonImages[sanitizeFirebaseKey(selectedTeamPokemon.id)] || selectedTeamPokemon.imageUrl}
                          alt={selectedTeamPokemon.nickname || selectedTeamPokemon.species}
                          className="w-20 h-20 sm:w-32 sm:h-32 object-contain"
                          onError={(e) => {
                            e.target.style.display = 'none'
                            e.target.nextSibling.style.display = 'flex'
                          }}
                        />
                      )}
                      <div className={`w-20 h-20 sm:w-32 sm:h-32 ${(pokemonImages[sanitizeFirebaseKey(selectedTeamPokemon.id)] || selectedTeamPokemon.imageUrl) ? 'hidden' : 'flex'} items-center justify-center text-4xl sm:text-6xl`}>
                        ❓
                      </div>
                      <p className={`text-sm font-semibold mt-2 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                        {selectedTeamPokemon.nickname || selectedTeamPokemon.species}
                      </p>
                      <div className="flex gap-1 mt-1">
                        {(selectedTeamPokemon.types || []).map((tipo, i) => (
                          <span key={i} className="px-2 py-0.5 rounded text-white text-xs" style={{ backgroundColor: TYPE_COLORS[tipo] || '#777' }}>
                            {tipo}
                          </span>
                        ))}
                      </div>
                    </>
                  ) : (
                    <div className={`w-20 h-20 sm:w-32 sm:h-32 flex items-center justify-center rounded-lg ${darkMode ? 'bg-gray-800' : 'bg-gray-200'}`}>
                      <p className={`text-[10px] sm:text-xs text-center ${darkMode ? 'text-gray-500' : 'text-gray-400'} px-2 sm:px-4`}>
                        Selecione um Pokémon
                      </p>
                    </div>
                  )}
                </div>
              </div>
            </div>
            )}

            {/* PARTE NOVA: Modificadores */}
            {battleView === 'rolagens' && (
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-6 mb-6`}>
              <div
                className="flex justify-between items-center cursor-pointer"
                onClick={() => setShowModifiersSection(!showModifiersSection)}
              >
                <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  Modificadores
                </h3>
                <div className="flex items-center gap-2">
                  {showModifiersSection && (
                    <button
                      onClick={(e) => {
                        e.stopPropagation()
                        handleAddModifier()
                      }}
                      className={`p-2 rounded-lg transition-colors ${darkMode ? 'bg-blue-700 hover:bg-blue-600' : 'bg-blue-600 hover:bg-blue-700'} text-white`}
                      title="Adicionar Modificador"
                    >
                      <Sigma size={20} />
                    </button>
                  )}
                  {showModifiersSection ? <ChevronUp size={24} className={darkMode ? 'text-gray-400' : 'text-gray-600'} /> : <ChevronDown size={24} className={darkMode ? 'text-gray-400' : 'text-gray-600'} />}
                </div>
              </div>

              {showModifiersSection && (
                <div className={`${darkMode ? 'bg-gray-900' : 'bg-gray-50'} rounded-lg p-4 mt-4`}>
                {getUserModifiers().length === 0 ? (
                  <p className={`text-center text-sm ${darkMode ? 'text-gray-500' : 'text-gray-400'} py-4`}>
                    Nenhum modificador adicionado
                  </p>
                ) : (
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                    {getUserModifiers().map((modifier, idx) => (
                      <div
                        key={idx}
                        className={`${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-300'} border-2 rounded-lg p-3`}
                      >
                        <div className="flex items-start justify-between mb-2">
                          <label className="flex items-center gap-2 cursor-pointer flex-1">
                            <input
                              type="checkbox"
                              checked={getUserActiveModifiers().includes(idx)}
                              onChange={() => handleToggleModifier(idx)}
                              className="w-4 h-4 cursor-pointer"
                            />
                            <button
                              onClick={() => handleShowModifierDetails(modifier)}
                              className={`text-sm font-semibold ${darkMode ? 'text-blue-400 hover:text-blue-300' : 'text-blue-600 hover:text-blue-700'} text-left`}
                            >
                              {modifier.nome}
                            </button>
                          </label>
                          <div className="flex gap-1">
                            <button
                              onClick={() => handleEditModifier(idx)}
                              className={`p-1 rounded ${darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-200'}`}
                              title="Editar"
                            >
                              <Edit size={14} className={darkMode ? 'text-yellow-400' : 'text-yellow-600'} />
                            </button>
                            <button
                              onClick={() => handleDeleteModifier(idx)}
                              className={`p-1 rounded ${darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-200'}`}
                              title="Excluir"
                            >
                              <Trash2 size={14} className={darkMode ? 'text-red-400' : 'text-red-600'} />
                            </button>
                          </div>
                        </div>
                        <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                          Mod: {modifier.mod}
                        </p>
                      </div>
                    ))}
                  </div>
                )}
                </div>
              )}
            </div>
            )}

            {/* SEÇÃO TALENTOS EM JOGO */}
            {battleView === 'rolagens' && (
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-6 mb-6`}>
              <div
                className="flex justify-between items-center cursor-pointer"
                onClick={() => setShowTalentosSection(!showTalentosSection)}
              >
                <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  Talentos em Jogo
                </h3>
                <div className="flex items-center gap-2">
                  {showTalentosSection && (
                    <button
                      onClick={(e) => {
                        e.stopPropagation()
                        handleAddTalentinho()
                      }}
                      className={`p-2 rounded-lg transition-colors ${darkMode ? 'bg-purple-700 hover:bg-purple-600' : 'bg-purple-600 hover:bg-purple-700'} text-white`}
                      title="Adicionar Talentinho"
                    >
                      <Plus size={20} />
                    </button>
                  )}
                  {showTalentosSection ? <ChevronUp size={24} className={darkMode ? 'text-gray-400' : 'text-gray-600'} /> : <ChevronDown size={24} className={darkMode ? 'text-gray-400' : 'text-gray-600'} />}
                </div>
              </div>

              {showTalentosSection && (
                <div className={`${darkMode ? 'bg-gray-900' : 'bg-gray-50'} rounded-lg p-4 mt-4`}>
                  {talentinhos.length === 0 ? (
                    <p className={`text-center text-sm ${darkMode ? 'text-gray-500' : 'text-gray-400'} py-4`}>
                      Nenhum talentinho adicionado
                    </p>
                  ) : (
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                      {talentinhos.map((talentinho, idx) => (
                        <div
                          key={idx}
                          className={`p-4 rounded-lg ${darkMode ? 'bg-gray-800' : 'bg-white'} border ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}
                        >
                          <div className="flex items-start justify-between gap-2 mb-2">
                            <button
                              onClick={() => {
                                setSelectedTalentinhoDetail(talentinho)
                                setShowTalentinhoDetailModal(true)
                              }}
                              className={`flex-1 text-left font-semibold ${darkMode ? 'text-purple-400 hover:text-purple-300' : 'text-purple-600 hover:text-purple-700'} transition-colors`}
                            >
                              {talentinho.nome}
                            </button>
                            <div className="flex gap-1">
                              <button
                                onClick={() => handleRollTalentinho(talentinho)}
                                className={`p-1 rounded ${darkMode ? 'bg-green-700 hover:bg-green-600' : 'bg-green-500 hover:bg-green-600'} text-white`}
                                title="Enviar no Chat"
                              >
                                <Send size={14} />
                              </button>
                              <button
                                onClick={() => handleEditTalentinho(idx)}
                                className={`p-1 rounded ${darkMode ? 'bg-blue-700 hover:bg-blue-600' : 'bg-blue-500 hover:bg-blue-600'} text-white`}
                                title="Editar"
                              >
                                <Edit size={14} />
                              </button>
                              <button
                                onClick={() => handleDeleteTalentinho(idx)}
                                className={`p-1 rounded ${darkMode ? 'bg-red-700 hover:bg-red-600' : 'bg-red-500 hover:bg-red-600'} text-white`}
                                title="Excluir"
                              >
                                <Trash2 size={14} />
                              </button>
                            </div>
                          </div>
                          <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'} font-mono`}>
                            {talentinho.expressao}
                          </p>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              )}
            </div>
            )}

            {/* SEÇÃO LIMITES DE USO */}
            {battleView === 'rolagens' && (
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-6 mb-6`}>
              <div
                className="flex justify-between items-center cursor-pointer"
                onClick={() => setShowLimitesUsoSection(!showLimitesUsoSection)}
              >
                <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  Limites de Uso
                </h3>
                <div className="flex items-center gap-2">
                  {showLimitesUsoSection && (
                    <>
                      <button
                        onClick={(e) => {
                          e.stopPropagation()
                          setShowAddLimiteUsoModal(true)
                        }}
                        className={`p-1.5 sm:p-2 rounded-lg text-sm font-medium transition-all ${darkMode ? 'bg-blue-700 hover:bg-blue-600' : 'bg-blue-500 hover:bg-blue-600'} text-white`}
                        title="Adicionar Limites de Uso"
                      >
                        <ListPlus size={16} className="sm:w-[18px] sm:h-[18px]" />
                      </button>
                      <button
                        onClick={(e) => {
                          e.stopPropagation()
                          resetarTodosOsUsos()
                        }}
                        className={`flex items-center gap-1 p-1.5 sm:px-3 sm:py-1.5 rounded-lg text-sm font-medium transition-all ${darkMode ? 'bg-green-700 hover:bg-green-600' : 'bg-green-500 hover:bg-green-600'} text-white`}
                        title="Resetar todos os usos"
                      >
                        <RotateCcw size={16} />
                        <span className="hidden sm:inline">Resetar Todos</span>
                      </button>
                    </>
                  )}
                  {showLimitesUsoSection ? <ChevronUp size={24} className={darkMode ? 'text-gray-400' : 'text-gray-600'} /> : <ChevronDown size={24} className={darkMode ? 'text-gray-400' : 'text-gray-600'} />}
                </div>
              </div>

              {showLimitesUsoSection && (
                <div className={`${darkMode ? 'bg-gray-900' : 'bg-gray-50'} rounded-lg p-4 mt-4`}>
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                    {getItensComLimiteDeUso().map((item, idx) => (
                      <div
                        key={`${item.tipo}-${item.index}`}
                        className={`p-4 rounded-lg ${darkMode ? 'bg-gray-800' : 'bg-white'} border ${
                          item.atual === 0
                            ? darkMode ? 'border-red-600' : 'border-red-400'
                            : darkMode ? 'border-gray-700' : 'border-gray-200'
                        }`}
                      >
                        <div className="flex flex-col gap-2 relative">
                          {item.isPersonalizado && (
                            <button
                              onClick={() => removerLimiteUsoPersonalizado(item.index)}
                              className="absolute -top-2 -right-2 p-1 rounded-full bg-red-500 hover:bg-red-600 text-white shadow-lg"
                              title="Remover limite"
                            >
                              <X size={12} />
                            </button>
                          )}
                          <div className="flex items-center justify-between">
                            <span className={`font-semibold ${
                              item.tipo === 'modificador'
                                ? darkMode ? 'text-blue-400' : 'text-blue-600'
                                : item.tipo === 'talentinho'
                                  ? darkMode ? 'text-purple-400' : 'text-purple-600'
                                  : item.isPersonalizado
                                    ? darkMode ? 'text-cyan-400' : 'text-cyan-600'
                                    : darkMode ? 'text-yellow-400' : 'text-yellow-600'
                            }`}>
                              {item.nome}
                            </span>
                            <span className={`text-xs px-2 py-0.5 rounded-full ${
                              item.tipo === 'modificador'
                                ? darkMode ? 'bg-blue-900 text-blue-300' : 'bg-blue-100 text-blue-700'
                                : item.tipo === 'talentinho'
                                  ? darkMode ? 'bg-purple-900 text-purple-300' : 'bg-purple-100 text-purple-700'
                                  : item.isPersonalizado
                                    ? darkMode ? 'bg-cyan-900 text-cyan-300' : 'bg-cyan-100 text-cyan-700'
                                    : darkMode ? 'bg-yellow-900 text-yellow-300' : 'bg-yellow-100 text-yellow-700'
                            }`}>
                              {item.tipo === 'modificador' ? 'Mod' : item.tipo === 'talentinho' && !item.isPersonalizado ? 'Talento' : item.isPersonalizado ? (item.fontes?.talento ? 'Talento' : item.fontes?.item ? 'Item' : 'Outros') : 'Item'}
                            </span>
                          </div>

                          <div className="flex items-center justify-center gap-3">
                            <button
                              onClick={item.decrementar}
                              disabled={item.atual === 0}
                              className={`p-2 rounded-lg transition-colors ${
                                item.atual === 0
                                  ? darkMode ? 'bg-gray-700 text-gray-500 cursor-not-allowed' : 'bg-gray-200 text-gray-400 cursor-not-allowed'
                                  : darkMode ? 'bg-red-700 hover:bg-red-600 text-white' : 'bg-red-500 hover:bg-red-600 text-white'
                              }`}
                              title="Usar"
                            >
                              <Minus size={16} />
                            </button>

                            <span className={`text-xl sm:text-2xl font-bold ${
                              item.atual === 0
                                ? darkMode ? 'text-red-400' : 'text-red-600'
                                : darkMode ? 'text-white' : 'text-gray-800'
                            }`}>
                              {item.atual}/{item.total}
                            </span>

                            <button
                              onClick={item.resetar}
                              className={`p-2 rounded-lg transition-colors ${darkMode ? 'bg-green-700 hover:bg-green-600' : 'bg-green-500 hover:bg-green-600'} text-white`}
                              title="Resetar"
                            >
                              <RotateCcw size={16} />
                            </button>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
            )}

            {/* SEÇÃO DE CAPTURA */}
            {battleView === 'rolagens' && (
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-6 mb-6`}>
              <div
                className="flex justify-between items-center cursor-pointer"
                onClick={() => setShowCaptureSection(!showCaptureSection)}
              >
                <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  Lançar Pokébola
                </h3>
                {showCaptureSection ? <ChevronUp size={24} className={darkMode ? 'text-gray-400' : 'text-gray-600'} /> : <ChevronDown size={24} className={darkMode ? 'text-gray-400' : 'text-gray-600'} />}
              </div>

              {showCaptureSection && (
                <div className={`${darkMode ? 'bg-gray-900' : 'bg-gray-50'} rounded-lg p-4 mt-4`}>
                {keyItems.filter(item => POKEBALL_MODIFIERS[item.name]).length === 0 ? (
                  <p className={`text-center text-sm ${darkMode ? 'text-gray-500' : 'text-gray-400'} py-4`}>
                    Nenhuma pokébola disponível
                  </p>
                ) : (
                  <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3">
                    {/* Customball sempre aparece primeiro */}
                    <button
                      onClick={() => handleOpenCaptureModal('Customball')}
                      className={`relative flex flex-col items-center p-2 rounded-lg transition-all ${darkMode ? 'bg-gray-800 hover:bg-gray-700' : 'bg-white hover:bg-gray-100'} border-2 border-dashed ${darkMode ? 'border-gray-600' : 'border-gray-300'}`}
                      title="Customball"
                    >
                      <img
                        src="/pokeballs/custompokeball.png"
                        alt="Customball"
                        className="w-12 h-12 object-contain"
                        onError={(e) => {
                          e.target.style.display = 'none'
                          e.target.nextSibling.style.display = 'flex'
                        }}
                      />
                      <div className="w-12 h-12 hidden items-center justify-center text-xl sm:text-2xl">
                        ❓
                      </div>
                      <span className={`text-[10px] font-semibold text-center mt-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                        Customball
                      </span>
                    </button>

                    {/* Pokébolas dos keyItems */}
                    {keyItems
                      .filter(item => POKEBALL_MODIFIERS[item.name] && item.name !== 'Customball')
                      .map((item, idx) => (
                        <button
                          key={idx}
                          onClick={() => handleOpenCaptureModal(item.name)}
                          className={`relative flex flex-col items-center p-2 rounded-lg transition-all ${darkMode ? 'bg-gray-800 hover:bg-gray-700' : 'bg-white hover:bg-gray-100'} ${item.quantity > 0 ? '' : 'opacity-50 cursor-not-allowed'}`}
                          disabled={item.quantity === 0}
                          title={item.name}
                        >
                          <img
                            src={`/pokeballs/${item.name.toLowerCase().replace(' ', '')}.png`}
                            alt={item.name}
                            className="w-12 h-12 object-contain"
                            onError={(e) => {
                              e.target.style.display = 'none'
                              e.target.nextSibling.style.display = 'flex'
                            }}
                          />
                          <div className="w-12 h-12 hidden items-center justify-center text-xl sm:text-2xl">
                            ⚪
                          </div>
                          <span className={`text-[10px] font-semibold text-center mt-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                            {item.name}
                          </span>
                          <div className={`absolute -top-1 -right-1 w-5 h-5 rounded-full flex items-center justify-center text-[10px] font-bold ${item.quantity > 0 ? (darkMode ? 'bg-blue-600 text-white' : 'bg-blue-500 text-white') : (darkMode ? 'bg-gray-600 text-gray-400' : 'bg-gray-400 text-gray-600')}`}>
                            {item.quantity}
                          </div>
                        </button>
                      ))}
                  </div>
                )}
                </div>
              )}
            </div>
            )}

            {/* SEÇÃO DE CURA EM BATALHA */}
            {battleView === 'rolagens' && (
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-6 mb-6`}>
              <div
                className="flex justify-between items-center cursor-pointer"
                onClick={() => setShowHealingSection(!showHealingSection)}
              >
                <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  Cura em Batalha
                </h3>
                {showHealingSection ? <ChevronUp size={24} className={darkMode ? 'text-gray-400' : 'text-gray-600'} /> : <ChevronDown size={24} className={darkMode ? 'text-gray-400' : 'text-gray-600'} />}
              </div>

              {showHealingSection && (
                <div className={`${darkMode ? 'bg-gray-900' : 'bg-gray-50'} rounded-lg p-4 mt-4`}>
                  {(() => {
                    // Filtrar itens de cura que o usuário possui e que têm expressão de dados
                    const healingItems = keyItems.filter(item => {
                      // Verificar se o item está no corredor de Cura
                      const curaItem = POKELOJA_DATA['Cura']?.find(i => i.name === item.name)
                      if (!curaItem) return false
                      // Verificar se tem expressão de dados na descrição
                      const hasDiceExpression = /\d+d\d+/i.test(curaItem.description)
                      return hasDiceExpression && item.quantity > 0
                    })

                    if (healingItems.length === 0) {
                      return (
                        <p className={`text-center text-sm ${darkMode ? 'text-gray-500' : 'text-gray-400'} py-4`}>
                          Nenhum item de cura com dados disponível
                        </p>
                      )
                    }

                    return (
                      <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3">
                        {healingItems.map((item, idx) => {
                          const curaItem = POKELOJA_DATA['Cura']?.find(i => i.name === item.name)
                          return (
                            <button
                              key={idx}
                              onClick={() => {
                                setSelectedHealingItem({ ...item, ...curaItem })
                                setShowHealingModal(true)
                              }}
                              className={`relative flex flex-col items-center p-2 rounded-lg transition-all ${darkMode ? 'bg-gray-800 hover:bg-gray-700' : 'bg-white hover:bg-gray-100'}`}
                              title={item.name}
                            >
                              <img
                                src={curaItem?.image || `/pokeballs/${item.name.toLowerCase().replace(/ /g, '')}.png`}
                                alt={item.name}
                                className="w-12 h-12 object-contain"
                                onError={(e) => {
                                  e.target.style.display = 'none'
                                  e.target.nextSibling.style.display = 'flex'
                                }}
                              />
                              <div className="w-12 h-12 hidden items-center justify-center text-xl sm:text-2xl">
                                💊
                              </div>
                              <span className={`text-[10px] font-semibold text-center mt-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                {item.name}
                              </span>
                              <div className={`absolute -top-1 -right-1 w-5 h-5 rounded-full flex items-center justify-center text-[10px] font-bold ${darkMode ? 'bg-green-600 text-white' : 'bg-green-500 text-white'}`}>
                                {item.quantity}
                              </div>
                            </button>
                          )
                        })}
                      </div>
                    )
                  })()}
                </div>
              )}
            </div>
            )}

            {/* PARTE 3: Chat (Embaixo) */}
            {battleView === 'rolagens' && (
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-6`}>
              <h3 className={`text-xl sm:text-2xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                Chat de Batalha
              </h3>

              {/* Menu de Rolagem Rápida */}
              <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} rounded-lg p-3 sm:p-4 mb-4`}>
                <h4 className={`text-sm font-bold mb-3 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                  Rolagem Rápida
                </h4>
                <div className="flex flex-col sm:flex-row sm:flex-wrap sm:items-center gap-3">
                  {/* Primeira Parte: Número de dados */}
                  <div className="flex flex-col xs:flex-row xs:items-center gap-2">
                    <span className={`text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'} whitespace-nowrap`}>Quantidade:</span>
                    <div className="flex flex-wrap gap-1">
                      {[1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(num => (
                        <button
                          key={num}
                          onClick={() => setQuickRollNumDice(num)}
                          className={`w-7 h-7 sm:w-8 sm:h-8 rounded text-xs sm:text-sm font-bold transition-colors ${
                            quickRollNumDice === num
                              ? 'bg-blue-600 text-white'
                              : darkMode
                              ? 'bg-gray-600 text-gray-300 hover:bg-gray-500'
                              : 'bg-white text-gray-700 hover:bg-gray-200'
                          }`}
                        >
                          {num}
                        </button>
                      ))}
                    </div>
                  </div>

                  {/* Segunda Parte: Tipo de dado */}
                  <div className="flex flex-col xs:flex-row xs:items-center gap-2">
                    <span className={`text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'} whitespace-nowrap`}>Dado:</span>
                    <div className="flex flex-wrap gap-1">
                      {['d4', 'd6', 'd8', 'd10', 'd12', 'd20'].map(dice => (
                        <button
                          key={dice}
                          onClick={() => setQuickRollDiceType(dice)}
                          className={`px-2.5 h-7 sm:px-3 sm:h-8 rounded text-xs sm:text-sm font-bold transition-colors ${
                            quickRollDiceType === dice
                              ? 'bg-green-600 text-white'
                              : darkMode
                              ? 'bg-gray-600 text-gray-300 hover:bg-gray-500'
                              : 'bg-white text-gray-700 hover:bg-gray-200'
                          }`}
                        >
                          {dice}
                        </button>
                      ))}
                    </div>
                  </div>

                  {/* Botão Rolar */}
                  <button
                    onClick={() => {
                      const diceNotation = `${quickRollNumDice}${quickRollDiceType}`
                      const result = rollDiceExpression(diceNotation)
                      if (result.error) {
                        alert(result.error)
                        return
                      }
                      const newMessage = {
                        username: currentUser?.username || 'Anônimo',
                        text: `🎲 Rolagem Rápida: ${diceNotation}`,
                        timestamp: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
                        isDiceRoll: true,
                        diceResult: result.total,
                        diceDetails: result.formula
                      }
                      setChatMessages(prev => [...prev, newMessage])
                      if (useFirebase) {
                        (async () => {
                          const currentMessages = await loadChatMessages()
                          await saveChatMessages([...(currentMessages || []), newMessage])
                        })().catch(err => console.error('Erro ao salvar mensagem:', err))
                      }
                    }}
                    className="px-3 sm:px-5 md:px-6 h-7 sm:h-8 bg-purple-600 text-white rounded font-bold hover:bg-purple-700 transition-colors text-xs sm:text-sm"
                  >
                    🎲 Rolar
                  </button>
                </div>
              </div>

              <div className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-4 space-y-1`}>
                <p>Use /r ou /roll para rolar dados. Exemplo: /r 1d20+5, /roll 2d6</p>
                <p>Use comandos @ para referenciar seus atributos: <span className="font-mono">1d20+@MAE</span>, <span className="font-mono">2d6+@MA+@MV</span></p>
                <p className="text-[10px]">Comandos: @MA @MD @MAE @MDE @MV @MS @At @Dt @AEt @DEt @Vt @St @Cont</p>
              </div>

              {/* Área de Mensagens */}
              <div ref={chatContainerRef} className={`${darkMode ? 'bg-gray-900' : 'bg-gray-50'} rounded-lg p-4 h-96 overflow-y-auto mb-4`}>
                {chatMessages.length === 0 ? (
                  <p className={`text-center ${darkMode ? 'text-gray-500' : 'text-gray-400'} py-3 sm:py-5 md:py-8`}>
                    Nenhuma mensagem ainda. Seja o primeiro a falar!
                  </p>
                ) : (
                  <div className="space-y-3">
                    {chatMessages.map((msg, idx) => (
                      <div key={idx} className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg p-3`}>
                        <div className="flex justify-between items-start mb-1">
                          <span className={`font-bold text-sm ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>
                            {msg.username}
                          </span>
                          <span className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                            {msg.timestamp}
                          </span>
                        </div>
                        {msg.isDiceRoll ? (
                          <div>
                            <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                              {msg.text}
                            </p>
                            <div className={`mt-2 p-2 rounded ${darkMode ? 'bg-green-900' : 'bg-green-100'}`}>
                              <p className={`font-bold text-lg ${darkMode ? 'text-green-400' : 'text-green-700'}`}>
                                Resultado: {msg.diceResult}
                              </p>
                              <p className={`text-xs ${darkMode ? 'text-green-300' : 'text-green-600'}`}>
                                {msg.diceDetails}
                              </p>
                            </div>
                          </div>
                        ) : msg.isAction ? (
                          <p className={`text-sm font-semibold text-yellow-500`}>
                            {msg.text}
                          </p>
                        ) : (
                          <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                            {msg.text}
                          </p>
                        )}
                      </div>
                    ))}
                  </div>
                )}
              </div>

              {/* Input de Mensagem */}
              <div className="flex gap-2">
                <input
                  type="text"
                  value={chatInput}
                  onChange={(e) => setChatInput(e.target.value)}
                  onKeyPress={(e) => {
                    if (e.key === 'Enter') {
                      handleSendMessage()
                    }
                  }}
                  placeholder="Digite sua mensagem, 1d20+@MAE, ou /r 1d20..."
                  className={`flex-1 px-3 py-2 sm:px-4 sm:py-3 rounded-lg border-2 text-sm sm:text-base ${
                    darkMode
                      ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-500'
                      : 'bg-white border-gray-300 text-gray-800 placeholder-gray-400'
                  } focus:outline-none focus:border-blue-500`}
                />
                <button
                  onClick={handleSendMessage}
                  className="px-3 sm:px-5 md:px-6 py-2 sm:py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold text-sm sm:text-base"
                >
                  Enviar
                </button>
              </div>
            </div>
            )}
          </div>
        </div>

        {/* Modal de Golpe */}
        {showBattleMoveModal && selectedBattleMove && (
          <div
            className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
            onClick={() => setShowBattleMoveModal(false)}
          >
            <div
              className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg p-3 sm:p-5 md:p-6 max-w-[95vw] sm:max-w-xl md:max-w-2xl w-full max-h-[90vh] overflow-y-auto`}
              onClick={(e) => e.stopPropagation()}
            >
              <div className="flex justify-between items-center mb-4">
                <h3 className={`text-lg sm:text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  {selectedBattleMove}
                </h3>
                <button
                  onClick={() => setShowBattleMoveModal(false)}
                  className={`${darkMode ? 'text-gray-400 hover:text-white' : 'text-gray-600 hover:text-gray-800'}`}
                >
                  <X size={24} />
                </button>
              </div>

              {(() => {
                const moveData = GOLPES_DATA[selectedBattleMove]
                if (!moveData) {
                  return <p className={`${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Golpe não encontrado</p>
                }

                return (
                  <div className="space-y-3">
                    <div className="grid grid-cols-2 gap-2 sm:gap-3 md:gap-4">
                      <div>
                        <span className={`text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Tipo:</span>
                        <p className={`${darkMode ? 'text-white' : 'text-gray-800'}`}>{moveData.tipo}</p>
                      </div>
                      <div>
                        <span className={`text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Aptidão:</span>
                        <p className={`${darkMode ? 'text-white' : 'text-gray-800'}`}>{moveData.aptidao}</p>
                      </div>
                      <div>
                        <span className={`text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Dano Basal:</span>
                        <p className={`${darkMode ? 'text-white' : 'text-gray-800'}`}>{moveData.danoBasal || '-'}</p>
                      </div>
                      <div>
                        <span className={`text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Acurácia:</span>
                        <p className={`${darkMode ? 'text-white' : 'text-gray-800'}`}>{moveData.acuracia}</p>
                      </div>
                      <div>
                        <span className={`text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Alcance:</span>
                        <p className={`${darkMode ? 'text-white' : 'text-gray-800'}`}>{moveData.alcance}</p>
                      </div>
                      <div>
                        <span className={`text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Frequência:</span>
                        <p className={`${darkMode ? 'text-white' : 'text-gray-800'}`}>{moveData.frequencia}</p>
                      </div>
                    </div>

                    {moveData.descritores && (
                      <div>
                        <span className={`text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Descritores:</span>
                        <p className={`${darkMode ? 'text-white' : 'text-gray-800'}`}>{moveData.descritores}</p>
                      </div>
                    )}

                    <div>
                      <span className={`text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Efeito:</span>
                      <p className={`${darkMode ? 'text-gray-300' : 'text-gray-700'} whitespace-pre-wrap`}>
                        {moveData.efeito}
                      </p>
                    </div>
                  </div>
                )
              })()}
            </div>
          </div>
        )}

        {/* Modal de Habilidade */}
        {showBattleAbilityModal && selectedBattleAbility && (
          <div
            className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
            onClick={() => setShowBattleAbilityModal(false)}
          >
            <div
              className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg p-3 sm:p-5 md:p-6 max-w-[95vw] sm:max-w-xl md:max-w-2xl w-full max-h-[90vh] overflow-y-auto`}
              onClick={(e) => e.stopPropagation()}
            >
              <div className="flex justify-between items-center mb-4">
                <h3 className={`text-lg sm:text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  {selectedBattleAbility}
                </h3>
                <button
                  onClick={() => setShowBattleAbilityModal(false)}
                  className={`${darkMode ? 'text-gray-400 hover:text-white' : 'text-gray-600 hover:text-gray-800'}`}
                >
                  <X size={24} />
                </button>
              </div>

              {(() => {
                const abilityData = HABILIDADES_DATA[selectedBattleAbility]
                if (!abilityData) {
                  return <p className={`${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Habilidade não encontrada</p>
                }

                // Extrair descrição corretamente (pode ser string ou objeto com ativacao/efeito)
                let description = ''
                if (typeof abilityData === 'string') {
                  description = abilityData
                } else if (abilityData.descricao) {
                  description = abilityData.descricao
                } else if (abilityData.efeito) {
                  description = `Ativação: ${abilityData.ativacao || 'N/A'}\n\nEfeito: ${abilityData.efeito}`
                }

                return (
                  <div className="space-y-3">
                    <div>
                      <span className={`text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Descrição:</span>
                      <p className={`${darkMode ? 'text-gray-300' : 'text-gray-700'} whitespace-pre-wrap`}>
                        {description}
                      </p>
                    </div>

                    <button
                      onClick={() => handleSendAbilityToChat(selectedBattleAbility)}
                      className="w-full mt-4 bg-green-600 text-white px-3 sm:px-5 md:px-6 py-3 rounded-lg hover:bg-green-700 font-semibold"
                    >
                      Enviar no Chat
                    </button>
                  </div>
                )
              })()}
            </div>
          </div>
        )}

        {/* Modal de Adicionar/Editar Modificador */}
        {showModifierModal && (
          <div
            className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
            onClick={() => setShowModifierModal(false)}
          >
            <div
              className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg p-3 sm:p-5 md:p-6 max-w-md w-full`}
              onClick={(e) => e.stopPropagation()}
            >
              <div className="flex justify-between items-center mb-4">
                <h3 className={`text-lg sm:text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  {editingModifierIndex !== null ? 'Editar Modificador' : 'Adicionar Modificador'}
                </h3>
                <button
                  onClick={() => setShowModifierModal(false)}
                  className={`${darkMode ? 'text-gray-400 hover:text-white' : 'text-gray-600 hover:text-gray-800'}`}
                >
                  <X size={24} />
                </button>
              </div>

              <div className="space-y-4">
                <div>
                  <label className={`block text-sm font-semibold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Nome *
                  </label>
                  <input
                    type="text"
                    value={modifierForm.nome}
                    onChange={(e) => setModifierForm({ ...modifierForm, nome: e.target.value })}
                    className={`w-full px-3 py-2 sm:px-4 rounded-lg border-2 text-sm sm:text-base ${
                      darkMode
                        ? 'bg-gray-700 border-gray-600 text-white'
                        : 'bg-white border-gray-300 text-gray-800'
                    } focus:outline-none focus:border-blue-500`}
                    placeholder="Ex: Buff de Ataque"
                  />
                </div>

                <div>
                  <label className={`block text-sm font-semibold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Mod *
                  </label>
                  <input
                    type="text"
                    value={modifierForm.mod}
                    onChange={(e) => setModifierForm({ ...modifierForm, mod: e.target.value })}
                    className={`w-full px-3 py-2 sm:px-4 rounded-lg border-2 text-sm sm:text-base ${
                      darkMode
                        ? 'bg-gray-700 border-gray-600 text-white'
                        : 'bg-white border-gray-300 text-gray-800'
                    } focus:outline-none focus:border-blue-500`}
                    placeholder="Ex: 1d6+@MA, @MAd6, +5, -3"
                  />
                  <p className={`text-xs mt-1 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                    Use expressões de dado (1d6+@MA), comandos @ (@MAd6), ou números (+5, -3)
                  </p>
                </div>

                <div>
                  <label className={`block text-sm font-semibold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Descrição
                  </label>
                  <textarea
                    value={modifierForm.descricao}
                    onChange={(e) => setModifierForm({ ...modifierForm, descricao: e.target.value })}
                    className={`w-full px-3 py-2 sm:px-4 rounded-lg border-2 text-sm sm:text-base ${
                      darkMode
                        ? 'bg-gray-700 border-gray-600 text-white'
                        : 'bg-white border-gray-300 text-gray-800'
                    } focus:outline-none focus:border-blue-500 resize-none`}
                    placeholder="Descrição opcional do modificador"
                    rows={3}
                  />
                </div>

                <div>
                  <label className={`block text-sm font-semibold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Número de usos a cada X lvl
                  </label>
                  <input
                    type="number"
                    min="0"
                    value={modifierForm.usosACadaXLvl}
                    onChange={(e) => setModifierForm({ ...modifierForm, usosACadaXLvl: e.target.value === '' ? '' : parseInt(e.target.value) || '' })}
                    className={`w-full px-3 py-2 sm:px-4 rounded-lg border-2 text-sm sm:text-base ${
                      darkMode
                        ? 'bg-gray-700 border-gray-600 text-white'
                        : 'bg-white border-gray-300 text-gray-800'
                    } focus:outline-none focus:border-blue-500`}
                    placeholder="Ex: 5 (ganha +1 uso a cada 5 níveis)"
                  />
                  <p className={`text-xs mt-1 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                    Deixe vazio para uso ilimitado. Se preencher, o modificador terá 1 uso base + 1 a cada X níveis.
                  </p>
                </div>

                {/* Checkboxes de Aplicação */}
                <div>
                  <label className={`block text-sm font-semibold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Aplicar em:
                  </label>
                  <div className="space-y-2">
                    <label className="flex items-center gap-2 cursor-pointer">
                      <input
                        type="checkbox"
                        checked={modifierForm.aplicarAcuracia}
                        onChange={(e) => setModifierForm({ ...modifierForm, aplicarAcuracia: e.target.checked })}
                        className="w-4 h-4 cursor-pointer"
                      />
                      <span className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                        Acurácia
                      </span>
                    </label>
                    <label className="flex items-center gap-2 cursor-pointer">
                      <input
                        type="checkbox"
                        checked={modifierForm.aplicarDano}
                        onChange={(e) => setModifierForm({ ...modifierForm, aplicarDano: e.target.checked })}
                        className="w-4 h-4 cursor-pointer"
                      />
                      <span className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                        Dano
                      </span>
                    </label>
                    <label className="flex items-center gap-2 cursor-pointer">
                      <input
                        type="checkbox"
                        checked={modifierForm.aplicarCaptura}
                        onChange={(e) => setModifierForm({ ...modifierForm, aplicarCaptura: e.target.checked })}
                        className="w-4 h-4 cursor-pointer"
                      />
                      <span className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                        Captura
                      </span>
                    </label>
                  </div>
                </div>

                <div className="flex gap-2">
                  <button
                    onClick={handleSaveModifier}
                    className="flex-1 bg-blue-600 text-white px-3 sm:px-5 md:px-6 py-3 rounded-lg hover:bg-blue-700 font-semibold"
                    disabled={!modifierForm.nome || !modifierForm.mod}
                  >
                    {editingModifierIndex !== null ? 'Salvar' : 'Adicionar'}
                  </button>
                  <button
                    onClick={() => setShowModifierModal(false)}
                    className={`px-3 sm:px-5 md:px-6 py-3 rounded-lg font-semibold ${
                      darkMode
                        ? 'bg-gray-700 text-white hover:bg-gray-600'
                        : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                    }`}
                  >
                    Cancelar
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Modal de Adicionar/Editar Talentinho */}
        {showTalentinhoModal && (
          <div
            className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
            onClick={() => setShowTalentinhoModal(false)}
          >
            <div
              className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-[95vw] sm:max-w-xl md:max-w-2xl w-full p-3 sm:p-5 md:p-6`}
              onClick={(e) => e.stopPropagation()}
            >
              <div className="flex justify-between items-center mb-4 sm:mb-6">
                <h3 className={`text-lg sm:text-xl md:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  {editingTalentinhoIndex !== null ? 'Editar Talentinho' : 'Adicionar Talentinho'}
                </h3>
                <button
                  onClick={() => setShowTalentinhoModal(false)}
                  className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}
                >
                  <X size={24} />
                </button>
              </div>

              <div className="space-y-4">
                {/* Nome */}
                <div>
                  <label className={`block text-sm font-semibold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Nome do Talentinho
                  </label>
                  <input
                    type="text"
                    value={talentinhoForm.nome}
                    onChange={(e) => setTalentinhoForm({ ...talentinhoForm, nome: e.target.value })}
                    className={`w-full px-3 py-2 sm:px-4 sm:py-3 border-2 rounded-lg text-sm sm:text-base ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                    placeholder="Ex: Ataque Rápido"
                  />
                </div>

                {/* Expressão */}
                <div>
                  <label className={`block text-sm font-semibold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Expressão do Talento
                  </label>
                  <input
                    type="text"
                    value={talentinhoForm.expressao}
                    onChange={(e) => setTalentinhoForm({ ...talentinhoForm, expressao: e.target.value })}
                    className={`w-full px-3 py-2 sm:px-4 sm:py-3 border-2 rounded-lg text-sm sm:text-base font-mono ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                    placeholder="Ex: 1d20 + @MA + 2"
                  />
                  <p className={`text-xs mt-2 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                    Use @ para referenciar atributos: @MA, @MD, @MAE, @MDE, @MV, @MS, @At, @Dt, @AEt, @DEt, @Vt, @St, @Cont
                  </p>
                </div>

                {/* Alvos */}
                <div>
                  <div className="flex items-center justify-between mb-2">
                    <label className={`block text-sm font-semibold ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      Alvos (Opcional)
                    </label>
                    <button
                      type="button"
                      onClick={() => {
                        const newAlvos = [...(talentinhoForm.alvos || []), { operador: '>=', valor: '' }]
                        setTalentinhoForm({ ...talentinhoForm, alvos: newAlvos })
                      }}
                      className={`flex items-center gap-1 px-2 py-1 rounded text-xs font-semibold ${darkMode ? 'bg-green-700 hover:bg-green-600' : 'bg-green-500 hover:bg-green-600'} text-white`}
                    >
                      <Plus size={14} />
                      Adicionar Alvo
                    </button>
                  </div>
                  {talentinhoForm.alvos && talentinhoForm.alvos.length > 0 && (
                    <div className="space-y-2">
                      {talentinhoForm.alvos.map((alvo, idx) => {
                        // Compatibilidade com formato antigo (string) e novo ({operador, valor})
                        const alvoObj = typeof alvo === 'object' ? alvo : { operador: '>=', valor: alvo }
                        return (
                          <div key={idx} className="flex gap-2">
                            <select
                              value={alvoObj.operador || '>='}
                              onChange={(e) => {
                                const newAlvos = [...talentinhoForm.alvos]
                                newAlvos[idx] = { ...alvoObj, operador: e.target.value }
                                setTalentinhoForm({ ...talentinhoForm, alvos: newAlvos })
                              }}
                              className={`px-2 py-2 border-2 rounded-lg text-sm ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                            >
                              <option value=">=">maior ou igual a</option>
                              <option value="<=">menor ou igual a</option>
                              <option value=">">maior que</option>
                              <option value="<">menor que</option>
                              <option value="==">igual a</option>
                            </select>
                            <input
                              type="text"
                              value={alvoObj.valor || ''}
                              onChange={(e) => {
                                const newAlvos = [...talentinhoForm.alvos]
                                newAlvos[idx] = { ...alvoObj, valor: e.target.value }
                                setTalentinhoForm({ ...talentinhoForm, alvos: newAlvos })
                              }}
                              className={`flex-1 px-3 py-2 border-2 rounded-lg font-mono text-sm ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                              placeholder={`Ex: 16 ou 1d10+@MD`}
                            />
                            <button
                              type="button"
                              onClick={() => {
                                const newAlvos = talentinhoForm.alvos.filter((_, i) => i !== idx)
                                setTalentinhoForm({ ...talentinhoForm, alvos: newAlvos })
                              }}
                              className={`p-2 rounded ${darkMode ? 'bg-red-700 hover:bg-red-600' : 'bg-red-500 hover:bg-red-600'} text-white`}
                              title="Remover Alvo"
                            >
                              <X size={16} />
                            </button>
                          </div>
                        )
                      })}
                    </div>
                  )}
                  <p className={`text-xs mt-2 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                    Escolha o operador de comparação e defina o valor alvo. Ex: "maior ou igual a 16" significa que a rolagem precisa ser 16 ou mais para ser sucesso.
                  </p>
                </div>

                {/* Número de usos a cada X lvl */}
                <div>
                  <label className={`block text-sm font-semibold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Número de usos a cada X lvl
                  </label>
                  <input
                    type="number"
                    min="0"
                    value={talentinhoForm.usosACadaXLvl}
                    onChange={(e) => setTalentinhoForm({ ...talentinhoForm, usosACadaXLvl: e.target.value === '' ? '' : parseInt(e.target.value) || '' })}
                    className={`w-full px-3 py-2 sm:px-4 sm:py-3 border-2 rounded-lg text-sm sm:text-base ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                    placeholder="Ex: 5 (ganha +1 uso a cada 5 níveis)"
                  />
                  <p className={`text-xs mt-2 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                    Deixe vazio para uso ilimitado. Se preencher, o talento terá 1 uso base + 1 a cada X níveis.
                  </p>
                </div>

                <div className="flex gap-2">
                  <button
                    onClick={handleSaveTalentinho}
                    className="flex-1 bg-purple-600 text-white px-3 sm:px-5 md:px-6 py-3 rounded-lg hover:bg-purple-700 font-semibold"
                    disabled={!talentinhoForm.nome || !talentinhoForm.expressao}
                  >
                    {editingTalentinhoIndex !== null ? 'Salvar' : 'Adicionar'}
                  </button>
                  <button
                    onClick={() => setShowTalentinhoModal(false)}
                    className={`px-3 sm:px-5 md:px-6 py-3 rounded-lg font-semibold ${
                      darkMode
                        ? 'bg-gray-700 text-white hover:bg-gray-600'
                        : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                    }`}
                  >
                    Cancelar
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Modal de Adicionar Limite de Uso */}
        {showAddLimiteUsoModal && (
          <div
            className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
            onClick={() => setShowAddLimiteUsoModal(false)}
          >
            <div
              className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-md w-full p-3 sm:p-5 md:p-6`}
              onClick={(e) => e.stopPropagation()}
            >
              <div className="flex justify-between items-center mb-6">
                <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  Adicionar Limite de Uso
                </h3>
                <button
                  onClick={() => setShowAddLimiteUsoModal(false)}
                  className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}
                >
                  <X size={24} />
                </button>
              </div>

              <div className="space-y-4">
                {/* Nome */}
                <div>
                  <label className={`block text-sm font-semibold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Nome *
                  </label>
                  <input
                    type="text"
                    value={limiteUsoForm.nome}
                    onChange={(e) => setLimiteUsoForm({ ...limiteUsoForm, nome: e.target.value })}
                    className={`w-full px-3 py-2 sm:px-4 sm:py-3 border-2 rounded-lg text-sm sm:text-base ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                    placeholder="Ex: Investida, Escudo Protetor"
                  />
                </div>

                {/* Número de usos a cada X lvl */}
                <div>
                  <label className={`block text-sm font-semibold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Número de usos a cada X lvl *
                  </label>
                  <input
                    type="number"
                    min="1"
                    value={limiteUsoForm.usosACadaXLvl}
                    onChange={(e) => setLimiteUsoForm({ ...limiteUsoForm, usosACadaXLvl: e.target.value === '' ? '' : parseInt(e.target.value) || '' })}
                    className={`w-full px-3 py-2 sm:px-4 sm:py-3 border-2 rounded-lg text-sm sm:text-base ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                    placeholder="Ex: 5 (ganha +1 uso a cada 5 níveis)"
                  />
                  <p className={`text-xs mt-2 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                    O limite terá 1 uso base + 1 a cada X níveis. Ex: Se colocar 5 e estiver no nível 12, terá 1 + floor(12/5) = 3 usos.
                  </p>
                </div>

                {/* Fonte */}
                <div>
                  <label className={`block text-sm font-semibold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Fonte do Limite
                  </label>
                  <div className="flex flex-wrap gap-2 sm:gap-3 md:gap-4">
                    <label className={`flex items-center gap-2 cursor-pointer ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      <input
                        type="checkbox"
                        checked={limiteUsoForm.fontes.talento}
                        onChange={(e) => setLimiteUsoForm({ ...limiteUsoForm, fontes: { ...limiteUsoForm.fontes, talento: e.target.checked } })}
                        className="w-4 h-4 rounded"
                      />
                      <span>Talento</span>
                    </label>
                    <label className={`flex items-center gap-2 cursor-pointer ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      <input
                        type="checkbox"
                        checked={limiteUsoForm.fontes.item}
                        onChange={(e) => setLimiteUsoForm({ ...limiteUsoForm, fontes: { ...limiteUsoForm.fontes, item: e.target.checked } })}
                        className="w-4 h-4 rounded"
                      />
                      <span>Item</span>
                    </label>
                    <label className={`flex items-center gap-2 cursor-pointer ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      <input
                        type="checkbox"
                        checked={limiteUsoForm.fontes.outros}
                        onChange={(e) => setLimiteUsoForm({ ...limiteUsoForm, fontes: { ...limiteUsoForm.fontes, outros: e.target.checked } })}
                        className="w-4 h-4 rounded"
                      />
                      <span>Outros</span>
                    </label>
                  </div>
                  <p className={`text-xs mt-2 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                    Marque de onde vem este limite de uso.
                  </p>
                </div>

                <div className="flex gap-2">
                  <button
                    onClick={adicionarLimiteUsoPersonalizado}
                    className="flex-1 bg-blue-600 text-white px-3 sm:px-5 md:px-6 py-3 rounded-lg hover:bg-blue-700 font-semibold"
                    disabled={!limiteUsoForm.nome || !limiteUsoForm.usosACadaXLvl}
                  >
                    Adicionar
                  </button>
                  <button
                    onClick={() => setShowAddLimiteUsoModal(false)}
                    className={`px-3 sm:px-5 md:px-6 py-3 rounded-lg font-semibold ${
                      darkMode
                        ? 'bg-gray-700 text-white hover:bg-gray-600'
                        : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                    }`}
                  >
                    Cancelar
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Modal de Detalhes do Talentinho */}
        {showTalentinhoDetailModal && selectedTalentinhoDetail && (
          <div
            className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
            onClick={() => setShowTalentinhoDetailModal(false)}
          >
            <div
              className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-md w-full p-3 sm:p-5 md:p-6`}
              onClick={(e) => e.stopPropagation()}
            >
              <div className="flex justify-between items-center mb-6">
                <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  {selectedTalentinhoDetail.nome}
                </h3>
                <button
                  onClick={() => setShowTalentinhoDetailModal(false)}
                  className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}
                >
                  <X size={24} />
                </button>
              </div>

              <div className="space-y-4">
                <div>
                  <label className={`block text-sm font-semibold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Expressão
                  </label>
                  <div className={`px-4 py-3 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                    <code className={`text-sm font-mono ${darkMode ? 'text-purple-300' : 'text-purple-700'}`}>
                      {selectedTalentinhoDetail.expressao}
                    </code>
                  </div>
                </div>

                {selectedTalentinhoDetail.alvos && selectedTalentinhoDetail.alvos.length > 0 && (
                  <div>
                    <label className={`block text-sm font-semibold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      Alvos
                    </label>
                    <div className="space-y-2">
                      {selectedTalentinhoDetail.alvos.map((alvo, idx) => {
                        // Compatibilidade com formato antigo (string) e novo ({operador, valor})
                        const alvoObj = typeof alvo === 'object' ? alvo : { operador: '>=', valor: alvo }
                        const operadorTexto = {
                          '>=': 'maior ou igual a',
                          '<=': 'menor ou igual a',
                          '>': 'maior que',
                          '<': 'menor que',
                          '==': 'igual a'
                        }[alvoObj.operador] || 'maior ou igual a'
                        return (
                          <div key={idx} className={`px-4 py-2 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                            <span className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Alvo {idx + 1}:</span>
                            <code className={`text-sm font-mono block ${darkMode ? 'text-green-300' : 'text-green-700'}`}>
                              {operadorTexto} {alvoObj.valor}
                            </code>
                          </div>
                        )
                      })}
                    </div>
                  </div>
                )}

                <button
                  onClick={() => {
                    handleRollTalentinho(selectedTalentinhoDetail)
                    setShowTalentinhoDetailModal(false)
                  }}
                  className="w-full bg-green-600 text-white px-3 sm:px-5 md:px-6 py-3 rounded-lg hover:bg-green-700 font-semibold flex items-center justify-center gap-2"
                >
                  <Send size={20} />
                  Enviar no Chat
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Modal de Detalhes do Modificador */}
        {showModifierDetailsModal && selectedModifier && (
          <div
            className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
            onClick={() => setShowModifierDetailsModal(false)}
          >
            <div
              className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg p-3 sm:p-5 md:p-6 max-w-md w-full`}
              onClick={(e) => e.stopPropagation()}
            >
              <div className="flex justify-between items-center mb-4">
                <h3 className={`text-lg sm:text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  {selectedModifier.nome}
                </h3>
                <button
                  onClick={() => setShowModifierDetailsModal(false)}
                  className={`${darkMode ? 'text-gray-400 hover:text-white' : 'text-gray-600 hover:text-gray-800'}`}
                >
                  <X size={24} />
                </button>
              </div>

              <div className="space-y-3">
                <div>
                  <span className={`text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Modificador:</span>
                  <p className={`${darkMode ? 'text-white' : 'text-gray-800'} font-mono text-lg`}>
                    {selectedModifier.mod}
                  </p>
                </div>

                {selectedModifier.descricao && (
                  <div>
                    <span className={`text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Descrição:</span>
                    <p className={`${darkMode ? 'text-gray-300' : 'text-gray-700'} whitespace-pre-wrap`}>
                      {selectedModifier.descricao}
                    </p>
                  </div>
                )}
              </div>
            </div>
          </div>
        )}

        {/* Modal de Captura */}
        {showCaptureModal && selectedPokeball && (
          <div
            className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
            onClick={() => setShowCaptureModal(false)}
          >
            <div
              className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg p-3 sm:p-5 md:p-6 max-w-md w-full`}
              onClick={(e) => e.stopPropagation()}
            >
              <div className="flex justify-between items-center mb-4">
                <h3 className={`text-lg sm:text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  {selectedPokeball}
                </h3>
                <button
                  onClick={() => setShowCaptureModal(false)}
                  className={`${darkMode ? 'text-gray-400 hover:text-white' : 'text-gray-600 hover:text-gray-800'}`}
                >
                  <X size={24} />
                </button>
              </div>

              {(() => {
                const pokeballData = POKELOJA_DATA['Captura']?.find(item => item.name === selectedPokeball)
                if (pokeballData?.description) {
                  return (
                    <div className={`mb-4 p-3 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                      <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                        <span className="font-semibold">Descrição:</span> {pokeballData.description}
                      </p>
                    </div>
                  )
                }
                return null
              })()}

              <div className="space-y-4">
                {selectedPokeball === 'Customball' ? (
                  <div>
                    <label className={`block text-sm font-semibold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      Modificador de Captura
                    </label>
                    <input
                      type="text"
                      value={customPokeballModifier}
                      onChange={(e) => setCustomPokeballModifier(e.target.value)}
                      className={`w-full px-3 py-2 sm:px-4 rounded-lg border-2 text-sm sm:text-base ${
                        darkMode
                          ? 'bg-gray-700 border-gray-600 text-white'
                          : 'bg-white border-gray-300 text-gray-800'
                      } focus:outline-none focus:border-blue-500`}
                      placeholder="Ex: +15, -5, @MA, 1d6+@MAE"
                    />
                    <p className={`text-xs mt-1 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                      Suporta comandos @ e expressões
                    </p>
                  </div>
                ) : POKEBALL_MODIFIERS[selectedPokeball]?.length > 1 ? (
                  <div>
                    <label className={`block text-sm font-semibold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      Modificador de Captura
                    </label>
                    <select
                      value={selectedPokeballModifier}
                      onChange={(e) => setSelectedPokeballModifier(e.target.value)}
                      className={`w-full px-3 py-2 sm:px-4 rounded-lg border-2 text-sm sm:text-base ${
                        darkMode
                          ? 'bg-gray-700 border-gray-600 text-white'
                          : 'bg-white border-gray-300 text-gray-800'
                      } focus:outline-none focus:border-blue-500`}
                    >
                      {POKEBALL_MODIFIERS[selectedPokeball].map((mod, idx) => (
                        <option key={idx} value={mod}>
                          {mod === 'auto' ? 'Captura Automática' : mod}
                        </option>
                      ))}
                    </select>
                  </div>
                ) : (
                  <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                    <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      Modificador: <span className="font-bold">{POKEBALL_MODIFIERS[selectedPokeball]?.[0]}</span>
                    </p>
                  </div>
                )}

                <button
                  onClick={handleThrowPokeball}
                  className="w-full bg-blue-600 text-white px-3 sm:px-5 md:px-6 py-3 rounded-lg hover:bg-blue-700 font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
                  disabled={selectedPokeball === 'Customball' && !customPokeballModifier}
                >
                  Pokébolaaa, vaaai!
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Modal de Cura em Batalha */}
        {showHealingModal && selectedHealingItem && (
          <div
            className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
            onClick={() => setShowHealingModal(false)}
          >
            <div
              className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg p-3 sm:p-5 md:p-6 max-w-md w-full`}
              onClick={(e) => e.stopPropagation()}
            >
              <div className="flex justify-between items-center mb-4">
                <h3 className={`text-lg sm:text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  {selectedHealingItem.name}
                </h3>
                <button
                  onClick={() => setShowHealingModal(false)}
                  className={`${darkMode ? 'text-gray-400 hover:text-white' : 'text-gray-600 hover:text-gray-800'}`}
                >
                  <X size={24} />
                </button>
              </div>

              <div className="space-y-4">
                <div className="flex items-center gap-2 sm:gap-3 md:gap-4">
                  <img
                    src={selectedHealingItem.image}
                    alt={selectedHealingItem.name}
                    className="w-16 h-16 object-contain"
                    onError={(e) => { e.target.src = '/pokeballs/pokeball.png' }}
                  />
                  <div>
                    <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      {selectedHealingItem.description}
                    </p>
                    <p className={`text-xs mt-1 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                      Quantidade: {selectedHealingItem.quantity}
                    </p>
                  </div>
                </div>

                {(() => {
                  // Extrair expressão de dados da descrição
                  const diceMatch = selectedHealingItem.description.match(/(\d+d\d+(\+\d+)?)/i)
                  const diceExpression = diceMatch ? diceMatch[1] : null

                  if (!diceExpression) return null

                  return (
                    <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                      <p className={`text-center text-lg font-bold ${darkMode ? 'text-green-400' : 'text-green-600'}`}>
                        Expressão: {diceExpression}
                      </p>
                    </div>
                  )
                })()}

                <button
                  onClick={() => {
                    // Extrair expressão de dados da descrição
                    const diceMatch = selectedHealingItem.description.match(/(\d+d\d+(\+\d+)?)/i)
                    const diceExpression = diceMatch ? diceMatch[1] : null

                    if (diceExpression) {
                      const timestamp = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
                      const result = rollDiceExpression(diceExpression)

                      if (!result.error) {
                        addChatMessage({
                          username: currentUser.username,
                          text: `💊 Usou ${selectedHealingItem.name} (${diceExpression})`,
                          timestamp,
                          isDiceRoll: true,
                          diceResult: result.total,
                          diceDetails: result.formula
                        })

                        // Descontar item da mochila
                        const newQuantity = selectedHealingItem.quantity - 1
                        if (newQuantity <= 0) {
                          // Remover item se quantidade chegar a 0
                          setKeyItems(keyItems.filter(i => i.name !== selectedHealingItem.name))
                        } else {
                          // Decrementar quantidade
                          setKeyItems(keyItems.map(i =>
                            i.name === selectedHealingItem.name
                              ? { ...i, quantity: newQuantity }
                              : i
                          ))
                        }
                      }
                    }

                    setShowHealingModal(false)
                  }}
                  className="w-full bg-green-600 text-white px-3 sm:px-5 md:px-6 py-3 rounded-lg hover:bg-green-700 font-semibold"
                >
                  Curar?
                </button>
              </div>
            </div>
          </div>
        )}

        {/* MODAL DANO/CURA BATALHA PKM */}
        {showBattleHPModal && selectedBattlePokemon && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => { setShowBattleHPModal(false); cancelDamageTypeSelection(); }}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-3 sm:p-5 md:p-8 rounded-2xl shadow-2xl max-w-md w-full`} onClick={(e) => e.stopPropagation()}>
              <div className="flex justify-between items-center mb-4">
                <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  Dano/Cura - {selectedBattlePokemon.nickname || selectedBattlePokemon.species}
                </h3>
                <button onClick={() => { setShowBattleHPModal(false); cancelDamageTypeSelection(); }} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                  <X size={24} />
                </button>
              </div>
              <input
                type="number"
                min="1"
                max="1000"
                value={battleHpValue}
                onChange={e => setBattleHpValue(e.target.value)}
                placeholder="Valor (1-1000)"
                className={`w-full px-3 py-2 sm:px-4 sm:py-3 border-2 rounded-lg text-sm sm:text-base mb-4 text-center text-lg sm:text-xl ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                disabled={showDamageTypeButtons && pendingDamageContext === 'battlePokemon'}
              />
              {!showDamageTypeButtons || pendingDamageContext !== 'battlePokemon' ? (
                <div className="grid grid-cols-2 gap-2 sm:gap-3 md:gap-4">
                  <button
                    onClick={() => {
                      const v = parseInt(battleHpValue) || 0;
                      const idx = mainTeam.findIndex(p => p === selectedBattlePokemon);
                      console.log('[DEBUG HP SYNC] Curar | idx:', idx, '| selectedBattlePokemon:', { species: selectedBattlePokemon?.species, nickname: selectedBattlePokemon?.nickname }, '| battlePokemonList:', battlePokemonList.map(b => ({ especie: b.especie, nome: b.nome, hp: b.hp })));
                      if (idx !== -1) {
                        const updatedTeam = [...mainTeam];
                        const maxHP = calculateMaxHP(updatedTeam[idx]);
                        const currentHp = updatedTeam[idx].currentHP !== undefined ? updatedTeam[idx].currentHP : maxHP;
                        const newHP = Math.min(currentHp + v, maxHP);
                        updatedTeam[idx] = { ...updatedTeam[idx], currentHP: newHP };
                        setMainTeam(updatedTeam);

                        const updatedBPLHeal = battlePokemonList.map(battlePkmn => {
                          if (battlePkmn.especie === selectedBattlePokemon.species &&
                              battlePkmn.nome === (selectedBattlePokemon.nickname || selectedBattlePokemon.species)) {
                            return { ...battlePkmn, hp: newHP };
                          }
                          return battlePkmn;
                        });
                        setBattlePokemonList(updatedBPLHeal);
                        if (useFirebase) { saveBattleData({ battleTrainers, battlePokemon, battleTrainersList, battlePokemonList: updatedBPLHeal, currentTrainerTurn, currentPokemonTurn, trainerRound, pokemonRound, battlePokemonConditions, revealedNpcPokemon, revealedTrainers }) }
                      }
                      setBattleHpValue('');
                      setShowBattleHPModal(false);
                    }}
                    className="bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 font-semibold flex items-center justify-center gap-2"
                  >
                    <Heart size={20} />Curar
                  </button>
                  <button
                    onClick={() => {
                      const v = parseInt(battleHpValue) || 0;
                      if (v > 0) {
                        initiateDamageWithType(v, 'battlePokemon');
                      }
                    }}
                    className="bg-red-500 text-white py-3 rounded-lg hover:bg-red-600 font-semibold flex items-center justify-center gap-2"
                  >
                    <Sword size={20} />Dano
                  </button>
                </div>
              ) : (
                <div className="space-y-3">
                  <p className={`text-center text-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                    Dano: {pendingDamageValue}
                  </p>

                  {/* Multiplicadores de Dano */}
                  <div className={`p-3 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                    <p className={`text-xs font-semibold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>Multiplicadores:</p>
                    <div className="grid grid-cols-4 gap-2">
                      {['x2', 'x4', '/2', '/4'].map(mult => (
                        <label key={mult} className={`flex items-center justify-center gap-1 px-2 py-1 rounded cursor-pointer transition-colors ${
                          damageMultiplier === mult
                            ? 'bg-blue-500 text-white'
                            : darkMode ? 'bg-gray-600 text-gray-200 hover:bg-gray-500' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                        }`}>
                          <input
                            type="checkbox"
                            checked={damageMultiplier === mult}
                            onChange={(e) => setDamageMultiplier(e.target.checked ? mult : null)}
                            className="hidden"
                          />
                          <span className="text-sm font-semibold">{mult}</span>
                        </label>
                      ))}
                    </div>
                  </div>

                  <p className={`text-center text-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                    Selecione o tipo de dano:
                  </p>
                  <div className="grid grid-cols-3 gap-3">
                    <button
                      onClick={() => applyDamageWithType('fisico')}
                      className="bg-orange-500 text-white py-3 rounded-lg hover:bg-orange-600 font-semibold flex items-center justify-center gap-2"
                    >
                      <Sword size={20} />Físico
                    </button>
                    <button
                      onClick={() => applyDamageWithType('puro')}
                      className="bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600 font-semibold flex items-center justify-center gap-2"
                    >
                      <Minus size={20} />Puro
                    </button>
                    <button
                      onClick={() => applyDamageWithType('especial')}
                      className="bg-purple-500 text-white py-3 rounded-lg hover:bg-purple-600 font-semibold flex items-center justify-center gap-2"
                    >
                      <Zap size={20} />Especial
                    </button>
                  </div>
                  <button
                    onClick={cancelDamageTypeSelection}
                    className={`w-full py-2 rounded-lg font-semibold ${darkMode ? 'bg-gray-600 text-gray-200 hover:bg-gray-500' : 'bg-gray-300 text-gray-700 hover:bg-gray-400'}`}
                  >
                    Cancelar
                  </button>
                </div>
              )}
            </div>
          </div>
        )}

        {/* Modal de Dano/Cura Treinador em Batalha */}
        {showTrainerBattleDamageModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => { setShowTrainerBattleDamageModal(false); cancelDamageTypeSelection(); }}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-md w-full`} onClick={(e) => e.stopPropagation()}>
              <div className="p-3 sm:p-5 md:p-6">
                <div className="flex justify-between items-center mb-6">
                  <h3 className={`text-lg sm:text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                    Dano/Cura - {currentUser?.username || 'Treinador'}
                  </h3>
                  <button onClick={() => { setShowTrainerBattleDamageModal(false); cancelDamageTypeSelection(); }} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                    <X size={24} />
                  </button>
                </div>

                {/* Informação de HP Atual */}
                <div className={`mb-6 p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                  <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>HP Atual</p>
                  <p className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                    {currentHP} / {getMaxHP()}
                  </p>
                </div>

                {/* Input de Quantidade */}
                <div className="mb-6">
                  <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Quantidade
                  </label>
                  <input
                    type="number"
                    value={trainerBattleDamageAmount}
                    onChange={(e) => setTrainerBattleDamageAmount(e.target.value)}
                    placeholder="Digite a quantidade..."
                    className={`w-full px-3 py-2 sm:px-4 sm:py-3 border-2 rounded-lg text-sm sm:text-base text-lg ${
                      darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'border-gray-300 placeholder-gray-400'
                    }`}
                    min="1"
                    disabled={showDamageTypeButtons && pendingDamageContext === 'trainerBattle'}
                  />
                </div>

                {/* Botões de Ação */}
                {!showDamageTypeButtons || pendingDamageContext !== 'trainerBattle' ? (
                  <div className="flex gap-3">
                    <button
                      onClick={() => {
                        const v = parseInt(trainerBattleDamageAmount) || 0;
                        if (v > 0) {
                          initiateDamageWithType(v, 'trainerBattle');
                        }
                      }}
                      disabled={!trainerBattleDamageAmount || parseInt(trainerBattleDamageAmount) <= 0}
                      className="flex-1 flex items-center justify-center gap-2 bg-gradient-to-r from-red-600 to-red-700 text-white py-3 rounded-lg hover:from-red-700 hover:to-red-800 font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      <Sword size={18} />
                      Aplicar Dano
                    </button>
                    <button
                      onClick={() => applyTrainerBattleDamage(false)}
                      disabled={!trainerBattleDamageAmount || parseInt(trainerBattleDamageAmount) <= 0}
                      className="flex-1 flex items-center justify-center gap-2 bg-gradient-to-r from-green-600 to-green-700 text-white py-3 rounded-lg hover:from-green-700 hover:to-green-800 font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      <Heart size={18} />
                      Curar
                    </button>
                  </div>
                ) : (
                  <div className="space-y-3">
                    <p className={`text-center text-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                      Dano: {pendingDamageValue}
                    </p>

                    {/* Multiplicadores de Dano */}
                    <div className={`p-3 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                      <p className={`text-xs font-semibold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>Multiplicadores:</p>
                      <div className="grid grid-cols-2 xs:grid-cols-4 gap-2">
                        {['x2', 'x4', '/2', '/4'].map(mult => (
                          <label key={mult} className={`flex items-center justify-center gap-1 px-2 py-1 rounded cursor-pointer transition-colors ${
                            damageMultiplier === mult
                              ? 'bg-blue-500 text-white'
                              : darkMode ? 'bg-gray-600 text-gray-200 hover:bg-gray-500' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                          }`}>
                            <input
                              type="checkbox"
                              checked={damageMultiplier === mult}
                              onChange={(e) => setDamageMultiplier(e.target.checked ? mult : null)}
                              className="hidden"
                            />
                            <span className="text-sm font-semibold">{mult}</span>
                          </label>
                        ))}
                      </div>
                    </div>

                    <p className={`text-center text-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                      Selecione o tipo de dano:
                    </p>
                    <div className="grid grid-cols-1 xs:grid-cols-3 gap-2 sm:gap-3">
                      <button
                        onClick={() => applyDamageWithType('fisico')}
                        className="flex items-center justify-center gap-2 bg-orange-500 text-white py-2 sm:py-3 rounded-lg hover:bg-orange-600 font-semibold text-sm sm:text-base"
                      >
                        <Sword size={18} />Físico
                      </button>
                      <button
                        onClick={() => applyDamageWithType('puro')}
                        className="flex items-center justify-center gap-2 bg-gray-500 text-white py-2 sm:py-3 rounded-lg hover:bg-gray-600 font-semibold text-sm sm:text-base"
                      >
                        <Minus size={18} />Puro
                      </button>
                      <button
                        onClick={() => applyDamageWithType('especial')}
                        className="flex items-center justify-center gap-2 bg-purple-500 text-white py-2 sm:py-3 rounded-lg hover:bg-purple-600 font-semibold text-sm sm:text-base"
                      >
                        <Zap size={18} />Especial
                      </button>
                    </div>
                    <button
                      onClick={cancelDamageTypeSelection}
                      className={`w-full py-2 rounded-lg font-semibold ${darkMode ? 'bg-gray-600 text-gray-200 hover:bg-gray-500' : 'bg-gray-300 text-gray-700 hover:bg-gray-400'}`}
                    >
                      Cancelar
                    </button>
                  </div>
                )}
              </div>
            </div>
          </div>
            )}

        {accountDataModal}
        {scenarioPopupOverlay}
        {mostrarTriunfosOverlay}
        {pokezapPanel}{pokeAgendaPanel}
        {batalhaChatPanel}
      </>
    )
  }

  // ==================== ÁREA SAFARI (TREINADOR) ====================
  if (currentArea === 'Safari' && currentUser.type === 'treinador') {
    const activeRunKey = safariActiveRun ? `run-${safariActiveRun}` : null
    const myTimer = activeRunKey ? (safariTimers[activeRunKey] !== undefined ? safariTimers[activeRunKey] : 600) : 600
    const safariballItem = keyItems.find(item => item.name === 'Safariball')
    const safariballCount = safariballItem ? safariballItem.quantity : 0
    const connections = SAFARI_AREA_CONNECTIONS[safariCurrentArea] || []
    const myRunPermission = activeRunKey ? !!(safariRunPermissions[activeRunKey] || {})[currentUser.username] : false
    const myRunEncounters = activeRunKey ? (safariRunEncounters[activeRunKey] || []) : []
    const typeColorsTrainer = { normal: '#A8A878', fire: '#F08030', water: '#6890F0', electric: '#F8D030', grass: '#78C850', ice: '#98D8D8', fighting: '#C03028', poison: '#A040A0', ground: '#E0C068', flying: '#A890F0', psychic: '#F85888', bug: '#A8B820', rock: '#B8A038', ghost: '#705898', dragon: '#7038F8', dark: '#705848', steel: '#B8B8D0', fairy: '#EE99AC' }

    return (
      <>
        <div className={`min-h-screen ${mainBgClass}`}>
          {sidebarNav}
          <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-lg`}>
            <div className="max-w-7xl mx-auto px-4 py-4">
              <div className="flex justify-between items-center mb-4">
                <div className="flex items-center gap-3"><button onClick={() => setSidebarOpen(true)} className={`p-2 rounded-lg ${darkMode ? "hover:bg-gray-700 text-gray-400" : "hover:bg-gray-200 text-gray-500"}`}><Menu size={24} /></button><h2 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Safari</h2></div>
                <div className="flex gap-2 items-center">
                  <button onClick={() => setShowAccountDataModal(true)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-200 text-gray-700'}`} title="Dados da Conta"><ArrowDownUp size={20} /></button>
                  <button onClick={() => setDarkMode(!darkMode)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-yellow-400' : 'bg-gray-200 text-gray-700'}`}>{darkMode ? <Sun size={20} /> : <Moon size={20} />}</button>
                  {pokezapBtn}{pokeAgendaBtn}{batalhaChatBtn}<button onClick={handleLogout} className="bg-red-500 text-white px-3 sm:px-5 md:px-6 py-2 rounded-lg hover:bg-red-600">Sair</button>
                  {currentClima && <div className="flex items-center gap-1.5 ml-1"><img src={`/pokeballs/${currentClima.image}`} alt={currentClima.name} className="w-7 h-7" /><span className={`text-xs font-semibold ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>{currentClima.name}</span></div>}
                </div>
              </div>
            </div>
          </div>

          <div className="max-w-7xl mx-auto px-4 py-3 sm:py-5 md:py-8">
            {/* Subáreas */}
            <div className="flex gap-2 mb-6">
              {(() => {
                // Verificar se o usuário tem permissão em alguma run
                const hasRunPermission = Object.values(safariRunPermissions).some(runPerms => runPerms[currentUser.username])
                const availableSubareas = hasRunPermission
                  ? ['Mapa Safari', 'Encontro Safari', 'Espectador']
                  : ['Mapa Safari', 'Espectador']

                return availableSubareas.map(sub => (
                  <button key={sub} onClick={() => setSafariSubarea(sub)}
                    className={`px-4 py-2 rounded-lg font-semibold ${safariSubarea === sub ? 'bg-green-600 text-white' : darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}>
                    {sub}
                  </button>
                ))
              })()}
            </div>

            {/* MAPA SAFARI */}
            {safariSubarea === 'Mapa Safari' && (
              <div>
                {/* Run Safari Buttons */}
                <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-6 mb-6`}>
                  <div className="flex items-center gap-3 mb-4">
                    <h3 className={`text-lg sm:text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Zona Safari</h3>
                    <button onClick={() => setShowMapaSafariCompletoModal(true)}
                      className={`p-2 rounded-lg transition-all ${darkMode ? 'bg-green-700 hover:bg-green-600 text-white' : 'bg-green-100 hover:bg-green-200 text-green-800'}`}
                      title="Mapa Safari Completo">
                      🗺️
                    </button>
                  </div>
                  <p className={`mb-4 text-sm ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Entrada por run: ₽{SAFARI_ENTRY_COST}</p>
                  <div className="flex flex-wrap gap-3">
                    {[1, 2, 3, 4, 5].map(num => {
                      const rKey = `run-${num}`
                      const hasGrid = !!safariRunGrids[rKey]
                      const isActive = safariActiveRun === num
                      const hasPerm = !!(safariRunPermissions[rKey] || {})[currentUser.username]
                      return (
                        <button key={num} onClick={() => handleStartSafariRun(num)}
                          className={`px-5 py-3 rounded-xl font-bold transition-all ${
                            isActive
                              ? 'bg-gradient-to-r from-green-600 to-emerald-700 text-white ring-2 ring-green-400 shadow-lg'
                              : hasGrid
                                ? (darkMode ? 'bg-green-800 text-green-300 hover:bg-green-700' : 'bg-green-100 text-green-800 hover:bg-green-200')
                                : hasPerm
                                  ? (darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-700 hover:bg-gray-300')
                                  : (darkMode ? 'bg-gray-800 text-gray-600' : 'bg-gray-100 text-gray-400')
                          }`}>
                          Run Safari {num} {hasGrid ? `(${safariRunAreas[rKey] || 'Central'})` : ''} {!hasPerm && !hasGrid ? '🔒' : ''}
                        </button>
                      )
                    })}
                  </div>
                </div>

                {/* Grid do Safari (Run Ativo) */}
                {safariActiveRun && safariGridData && (
                  <div>
                    <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-6 mb-6`}>
                      <div className="flex justify-between items-center mb-4">
                        <div>
                          <h3 className={`text-lg sm:text-xl font-bold ${darkMode ? 'text-green-400' : 'text-green-700'}`}>{safariCurrentArea}</h3>
                          <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Run Safari {safariActiveRun} {!myRunPermission && <span className="text-red-400">(Somente visualização)</span>}</p>
                        </div>
                        <div className="flex items-center gap-2 sm:gap-3 md:gap-4">
                          <span className={`font-bold text-lg ${myTimer <= 0 ? 'text-red-500' : darkMode ? 'text-yellow-400' : 'text-yellow-600'}`}>⏰ {formatSafariTimer(myTimer)}</span>
                          {myRunPermission && (
                            <button
                              onClick={() => setShowAreaNavigationModal(true)}
                              disabled={myTimer <= 0}
                              className={`px-4 py-2 rounded-lg font-semibold ${
                                myTimer <= 0
                                  ? 'bg-gray-400 text-gray-600 cursor-not-allowed'
                                  : 'bg-blue-600 text-white hover:bg-blue-700'
                              }`}
                              title={myTimer <= 0 ? 'Tempo esgotado!' : 'Avançar para outra área'}
                            >
                              Avançar para...
                            </button>
                          )}
                        </div>
                      </div>

                      {/* Grid 8x8 */}
                      <div className="grid grid-cols-8 gap-1 max-w-xl mx-auto">
                        {safariGridData.map((row, ri) => row.map((cell, ci) => {
                          // Determinar se esta célula pode ser clicada
                          const revealedCells = safariGridData.flat().filter(c => c.revealed)
                          const isFirstClick = revealedCells.length === 0
                          const activeRunKey = safariActiveRun ? `run-${safariActiveRun}` : null
                          const lastClicked = activeRunKey ? safariRunLastClicked[activeRunKey] : null

                          let isClickable = false
                          if (!cell.revealed && myRunPermission && myTimer > 0) {
                            if (isFirstClick) {
                              isClickable = isEdgeCell(ri, ci, safariGridData.length)
                            } else {
                              const isAdjacentToLast = lastClicked && isAdjacentToCell(ri, ci, lastClicked.row, lastClicked.col)
                              const allLastAdjacentRevealed = lastClicked && allAdjacentRevealed(lastClicked.row, lastClicked.col, safariGridData)
                              const isAdjacentToRevealed = isAdjacentToAnyRevealed(ri, ci, safariGridData)

                              if (isAdjacentToLast) {
                                isClickable = true
                              } else if (allLastAdjacentRevealed && isAdjacentToRevealed) {
                                isClickable = true
                              }
                            }
                          }

                          return (
                            <div key={`${ri}-${ci}`}
                              onClick={() => !cell.revealed && myRunPermission && myTimer > 0 && handleSafariCellClick(ri, ci)}
                              className={`aspect-square rounded border-2 relative flex flex-col items-center justify-center overflow-hidden ${
                                isClickable ? 'cursor-pointer' : cell.revealed ? '' : 'cursor-not-allowed opacity-50'
                              } ${
                                cell.revealed
                                  ? (cell.pokemon
                                    ? (darkMode ? 'bg-yellow-900 border-yellow-600' : 'bg-yellow-100 border-yellow-400')
                                    : (darkMode ? 'bg-gray-700 border-gray-600' : 'bg-gray-200 border-gray-400'))
                                  : isClickable
                                    ? (darkMode ? 'border-green-500' : 'border-green-400')
                                    : 'border-transparent'
                              }`}>
                            {!cell.revealed && (
                              <img src={cell.terrain === 'Grama' ? '/gramasafari.png' : '/aguasafari.png'} alt={cell.terrain}
                                className="absolute inset-0 w-full h-full object-cover" />
                            )}
                            {cell.revealed && cell.pokemon && (
                              <div className="text-center">
                                {cell.imageUrl && <img src={cell.imageUrl} alt={cell.pokemon} className="w-10 h-10 mx-auto" />}
                                <div className={`text-[8px] font-bold truncate w-full ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                  {cell.pokemon}{cell.isSkittish ? '*' : ''}
                                </div>
                                <div className={`text-[8px] ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                                  x{cell.quantity} Nv{cell.level}
                                </div>
                              </div>
                            )}
                            {cell.revealed && !cell.pokemon && (
                              <span className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>Vazio</span>
                            )}
                          </div>
                          )
                        }))}
                      </div>
                    </div>

                    {/* Chat */}
                    <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-6`}>
                      <h3 className={`text-xl sm:text-2xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-800'}`}>Chat Safari</h3>

                      {/* Menu de Rolagem Rápida */}
                      <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} rounded-lg p-4 mb-4`}>
                        <h4 className={`text-sm font-bold mb-3 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                          Rolagem Rápida
                        </h4>
                        <div className="flex flex-wrap items-center gap-3">
                          <div className="flex items-center gap-2">
                            <span className={`text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Quantidade:</span>
                            <div className="flex gap-1">
                              {[1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(num => (
                                <button
                                  key={num}
                                  onClick={() => setQuickRollNumDice(num)}
                                  className={`w-8 h-8 rounded text-sm font-bold transition-colors ${
                                    quickRollNumDice === num
                                      ? 'bg-blue-600 text-white'
                                      : darkMode
                                      ? 'bg-gray-600 text-gray-300 hover:bg-gray-500'
                                      : 'bg-white text-gray-700 hover:bg-gray-200'
                                  }`}
                                >
                                  {num}
                                </button>
                              ))}
                            </div>
                          </div>
                          <div className="flex items-center gap-2">
                            <span className={`text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Dado:</span>
                            <div className="flex gap-1">
                              {['d4', 'd6', 'd8', 'd10', 'd12', 'd20'].map(dice => (
                                <button
                                  key={dice}
                                  onClick={() => setQuickRollDiceType(dice)}
                                  className={`px-3 h-8 rounded text-sm font-bold transition-colors ${
                                    quickRollDiceType === dice
                                      ? 'bg-green-600 text-white'
                                      : darkMode
                                      ? 'bg-gray-600 text-gray-300 hover:bg-gray-500'
                                      : 'bg-white text-gray-700 hover:bg-gray-200'
                                  }`}
                                >
                                  {dice}
                                </button>
                              ))}
                            </div>
                          </div>
                          <button
                            onClick={() => {
                              const diceNotation = `${quickRollNumDice}${quickRollDiceType}`
                              const result = rollDiceExpression(diceNotation)
                              if (result.error) {
                                alert(result.error)
                                return
                              }
                              const newMessage = {
                                username: currentUser?.username || 'Anônimo',
                                text: `🎲 Rolagem Rápida: ${diceNotation}`,
                                timestamp: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
                                isDiceRoll: true,
                                diceResult: result.total,
                                diceDetails: result.formula
                              }
                              setChatMessages(prev => [...prev, newMessage])
                              if (useFirebase) {
                                (async () => {
                                  const currentMessages = await loadChatMessages()
                                  await saveChatMessages([...(currentMessages || []), newMessage])
                                })().catch(err => console.error('Erro ao salvar mensagem:', err))
                              }
                            }}
                            className="px-3 sm:px-5 md:px-6 h-8 bg-purple-600 text-white rounded font-bold hover:bg-purple-700 transition-colors"
                          >
                            🎲 Rolar
                          </button>
                        </div>
                      </div>

                      <div className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-4 space-y-1`}>
                        <p>Use /r ou /roll para rolar dados. Exemplo: /r 1d20+5, /roll 2d6</p>
                        <p>Use comandos @ para referenciar seus atributos: <span className="font-mono">1d20+@MAE</span>, <span className="font-mono">2d6+@MA+@MV</span></p>
                        <p className="text-[10px]">Comandos: @MA @MD @MAE @MDE @MV @MS @At @Dt @AEt @DEt @Vt @St @Cont</p>
                      </div>

                      {/* Área de Mensagens */}
                      <div ref={chatContainerRef} className={`${darkMode ? 'bg-gray-900' : 'bg-gray-50'} rounded-lg p-4 h-96 overflow-y-auto mb-4`}>
                        {chatMessages.length === 0 ? (
                          <p className={`text-center ${darkMode ? 'text-gray-500' : 'text-gray-400'} py-3 sm:py-5 md:py-8`}>
                            Nenhuma mensagem ainda. Seja o primeiro a falar!
                          </p>
                        ) : (
                          <div className="space-y-3">
                            {chatMessages.map((msg, idx) => (
                              <div key={idx} className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg p-3`}>
                                <div className="flex justify-between items-start mb-1">
                                  <span className={`font-bold text-sm ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>{msg.username}</span>
                                  <span className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>{msg.timestamp}</span>
                                </div>
                                {msg.isDiceRoll ? (
                                  <div>
                                    <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>{msg.text}</p>
                                    <div className={`mt-2 p-2 rounded ${darkMode ? 'bg-green-900' : 'bg-green-100'}`}>
                                      <p className={`font-bold text-lg ${darkMode ? 'text-green-400' : 'text-green-700'}`}>Resultado: {msg.diceResult}</p>
                                      <p className={`text-xs ${darkMode ? 'text-green-300' : 'text-green-600'}`}>{msg.diceDetails}</p>
                                    </div>
                                  </div>
                                ) : msg.isAction ? (
                                  <p className="text-sm font-semibold text-yellow-500">{msg.text}</p>
                                ) : (
                                  <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>{msg.text}</p>
                                )}
                              </div>
                            ))}
                          </div>
                        )}
                      </div>

                      {/* Input de Mensagem */}
                      <div className="flex gap-2">
                        <input
                          type="text"
                          value={chatInput}
                          onChange={(e) => setChatInput(e.target.value)}
                          onKeyPress={(e) => { if (e.key === 'Enter') handleSendMessage() }}
                          placeholder="Digite sua mensagem, 1d20+@MAE, ou /r 1d20..."
                          className={`flex-1 px-4 py-3 rounded-lg border-2 ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-500' : 'bg-white border-gray-300 text-gray-800 placeholder-gray-400'} focus:outline-none focus:border-blue-500`}
                        />
                        <button onClick={handleSendMessage} className="px-3 sm:px-5 md:px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">Enviar</button>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* ENCONTRO SAFARI */}
            {safariSubarea === 'Encontro Safari' && (
              <div>
                {/* Pokémons do Safari - imagem e tipo, com checkbox */}
                <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-6 mb-6`}>
                  <h3 className={`text-lg sm:text-xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-800'}`}>Pokémons do Safari</h3>
                  {myRunEncounters.length === 0 ? (
                    <p className={`text-center py-4 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>Nenhum pokémon no encontro ainda. Explore o grid no Mapa Safari.</p>
                  ) : (
                    <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 sm:gap-3 md:gap-4">
                      {myRunEncounters.map((npc, npcIndex) => {
                        const isSelected = safariSelectedPokemon.has(npc.id)

                        // Array de cores para os cards Safari NPC (mesmo do mestre)
                        const safariCardColors = [
                          { dark: 'bg-gradient-to-br from-rose-800 to-rose-900', light: 'bg-gradient-to-br from-rose-200 to-rose-300' },
                          { dark: 'bg-gradient-to-br from-blue-800 to-blue-900', light: 'bg-gradient-to-br from-blue-200 to-blue-300' },
                          { dark: 'bg-gradient-to-br from-emerald-800 to-emerald-900', light: 'bg-gradient-to-br from-emerald-200 to-emerald-300' },
                          { dark: 'bg-gradient-to-br from-amber-800 to-amber-900', light: 'bg-gradient-to-br from-amber-200 to-amber-300' },
                          { dark: 'bg-gradient-to-br from-purple-800 to-purple-900', light: 'bg-gradient-to-br from-purple-200 to-purple-300' },
                          { dark: 'bg-gradient-to-br from-cyan-800 to-cyan-900', light: 'bg-gradient-to-br from-cyan-200 to-cyan-300' },
                          { dark: 'bg-gradient-to-br from-pink-800 to-pink-900', light: 'bg-gradient-to-br from-pink-200 to-pink-300' },
                          { dark: 'bg-gradient-to-br from-indigo-800 to-indigo-900', light: 'bg-gradient-to-br from-indigo-200 to-indigo-300' },
                          { dark: 'bg-gradient-to-br from-teal-800 to-teal-900', light: 'bg-gradient-to-br from-teal-200 to-teal-300' },
                          { dark: 'bg-gradient-to-br from-orange-800 to-orange-900', light: 'bg-gradient-to-br from-orange-200 to-orange-300' },
                        ]
                        const cardColor = safariCardColors[npcIndex % safariCardColors.length]
                        const cardBg = darkMode ? cardColor.dark : cardColor.light

                        return (
                          <div key={npc.id}
                            className={`${cardBg} ${isSelected ? 'ring-4 ring-green-400' : ''} rounded-xl p-3 text-center cursor-pointer transition-all`}
                            onClick={() => {
                              setSafariSelectedPokemon(prev => {
                                const newSet = new Set(prev)
                                if (newSet.has(npc.id)) newSet.delete(npc.id)
                                else newSet.add(npc.id)
                                return newSet
                              })
                            }}>
                            <input type="checkbox" checked={isSelected} readOnly className="mb-2 w-4 h-4" />
                            {npc.imageUrl && <img src={npc.imageUrl} alt={npc.species} className="w-16 h-16 mx-auto mb-1" />}
                            <h4 className={`font-bold text-sm ${darkMode ? 'text-white' : 'text-gray-800'}`}>{npc.species}</h4>
                            {/* Tipos */}
                            <div className="flex justify-center gap-1 mt-1">
                              {(npc.types || []).map(t => (
                                <span key={t} className="px-1.5 py-0.5 rounded text-[9px] font-bold text-white" style={{ backgroundColor: typeColorsTrainer[t] || '#888' }}>
                                  {t.charAt(0).toUpperCase() + t.slice(1)}
                                </span>
                              ))}
                            </div>
                            <div className="flex justify-center mt-1">
                              <DietIcons speciesName={npc.species} size={16} />
                            </div>
                          </div>
                        )
                      })}
                    </div>
                  )}
                </div>

                {/* Safari Mod Captura */}
                <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-6 mb-6`}>
                  <h3 className={`text-lg sm:text-xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-800'}`}>Safari Mod Captura</h3>
                  {(() => {
                    const currentUserModifiers = userBattleModifiers[currentUser.username] || []
                    const captureModifiers = currentUserModifiers.filter(mod => mod.aplicarCaptura)

                    if (captureModifiers.length === 0) {
                      return (
                        <p className={`text-center py-4 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                          Nenhum modificador de captura disponível. Adicione modificadores com a checkbox "Captura" marcada na área Batalha Pkm.
                        </p>
                      )
                    }

                    return (
                      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                        {currentUserModifiers.map((modifier, idx) => {
                          if (!modifier.aplicarCaptura) return null
                          const isActive = safariActiveCaptureModifiers.includes(idx)
                          return (
                            <div
                              key={idx}
                              className={`${isActive ? (darkMode ? 'bg-green-900 ring-2 ring-green-400' : 'bg-green-100 ring-2 ring-green-500') : (darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300')} border-2 rounded-lg p-3`}
                            >
                              <label className="flex items-center gap-2 cursor-pointer">
                                <input
                                  type="checkbox"
                                  checked={isActive}
                                  onChange={() => {
                                    setSafariActiveCaptureModifiers(prev =>
                                      prev.includes(idx) ? prev.filter(i => i !== idx) : [...prev, idx]
                                    )
                                  }}
                                  className="w-4 h-4 cursor-pointer"
                                />
                                <div className="flex-1">
                                  <p className={`text-sm font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                    {modifier.nome}
                                  </p>
                                  <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                    Mod: {modifier.mod}
                                  </p>
                                </div>
                              </label>
                            </div>
                          )
                        })}
                      </div>
                    )
                  })()}
                </div>

                {/* Ações Safari Treinador */}
                <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-6 mb-6`}>
                  <h3 className={`text-lg sm:text-xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-800'}`}>Ações Safari Treinador</h3>

                  {/* Status */}
                  <div className="flex flex-wrap gap-2 sm:gap-3 md:gap-4 mb-6">
                    <div className={`px-4 py-2 rounded-lg ${darkMode ? 'bg-blue-900' : 'bg-blue-100'}`}>
                      <span className={`text-sm font-bold ${darkMode ? 'text-blue-400' : 'text-blue-700'}`}>
                        Selecionados: {safariSelectedPokemon.size}
                      </span>
                    </div>
                    <div className={`px-4 py-2 rounded-lg ${darkMode ? 'bg-green-900' : 'bg-green-100'}`}>
                      <span className={`text-sm font-bold ${darkMode ? 'text-green-400' : 'text-green-700'}`}>
                        Safariballs: {safariballCount}
                      </span>
                    </div>
                  </div>

                  {/* Botões */}
                  <div className="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-4 gap-2 sm:gap-3">
                    <button onClick={handleSafariIsca}
                      disabled={safariSelectedPokemon.size === 0}
                      className={`px-3 sm:px-4 py-2 sm:py-3 rounded-lg font-semibold transition-all text-sm sm:text-base ${safariSelectedPokemon.size > 0 ? 'bg-yellow-600 text-white hover:bg-yellow-700' : darkMode ? 'bg-gray-600 text-gray-400 cursor-not-allowed' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}`}>
                      🍖 Jogar Isca
                    </button>
                    <button onClick={handleSafariSurpresa}
                      disabled={safariSelectedPokemon.size === 0}
                      className={`px-3 sm:px-4 py-2 sm:py-3 rounded-lg font-semibold transition-all text-sm sm:text-base ${safariSelectedPokemon.size > 0 ? 'bg-purple-600 text-white hover:bg-purple-700' : darkMode ? 'bg-gray-600 text-gray-400 cursor-not-allowed' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}`}>
                      💥 Ação Surpresa
                    </button>
                    <button onClick={handleSafariBall}
                      disabled={safariballCount === 0}
                      className={`px-3 sm:px-4 py-2 sm:py-3 rounded-lg font-semibold transition-all text-sm sm:text-base ${
                        safariballCount > 0
                          ? 'bg-green-600 text-white hover:bg-green-700'
                          : darkMode ? 'bg-gray-600 text-gray-400 cursor-not-allowed' : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                      }`}>
                      🎯 Safariball ({safariballCount})
                    </button>
                    <button onClick={handleSafariFuga}
                      className="px-3 sm:px-4 py-2 sm:py-3 rounded-lg font-semibold bg-red-600 text-white hover:bg-red-700 transition-all text-sm sm:text-base">
                      🏃 {skills.ataque && skills.ataque.includes('Corrida') ? 'Correria' : 'Fuga'}
                    </button>
                  </div>
                </div>

                {/* Chat */}
                <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-6`}>
                  <h3 className={`text-xl sm:text-2xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-800'}`}>Chat Safari</h3>

                  {/* Menu de Rolagem Rápida */}
                  <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} rounded-lg p-3 sm:p-4 mb-4`}>
                    <h4 className={`text-sm font-bold mb-3 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      Rolagem Rápida
                    </h4>
                    <div className="flex flex-col sm:flex-row sm:flex-wrap sm:items-center gap-3">
                      <div className="flex flex-col xs:flex-row xs:items-center gap-2">
                        <span className={`text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'} whitespace-nowrap`}>Quantidade:</span>
                        <div className="flex flex-wrap gap-1">
                          {[1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(num => (
                            <button
                              key={num}
                              onClick={() => setQuickRollNumDice(num)}
                              className={`w-7 h-7 sm:w-8 sm:h-8 rounded text-xs sm:text-sm font-bold transition-colors ${
                                quickRollNumDice === num
                                  ? 'bg-blue-600 text-white'
                                  : darkMode
                                  ? 'bg-gray-600 text-gray-300 hover:bg-gray-500'
                                  : 'bg-white text-gray-700 hover:bg-gray-200'
                              }`}
                            >
                              {num}
                            </button>
                          ))}
                        </div>
                      </div>
                      <div className="flex flex-col xs:flex-row xs:items-center gap-2">
                        <span className={`text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'} whitespace-nowrap`}>Dado:</span>
                        <div className="flex flex-wrap gap-1">
                          {['d4', 'd6', 'd8', 'd10', 'd12', 'd20'].map(dice => (
                            <button
                              key={dice}
                              onClick={() => setQuickRollDiceType(dice)}
                              className={`px-2 sm:px-3 h-7 sm:h-8 rounded text-xs sm:text-sm font-bold transition-colors ${
                                quickRollDiceType === dice
                                  ? 'bg-green-600 text-white'
                                  : darkMode
                                  ? 'bg-gray-600 text-gray-300 hover:bg-gray-500'
                                  : 'bg-white text-gray-700 hover:bg-gray-200'
                              }`}
                            >
                              {dice}
                            </button>
                          ))}
                        </div>
                      </div>
                      <button
                        onClick={() => {
                          const diceNotation = `${quickRollNumDice}${quickRollDiceType}`
                          const result = rollDiceExpression(diceNotation)
                          if (result.error) {
                            alert(result.error)
                            return
                          }
                          const newMessage = {
                            username: currentUser?.username || 'Anônimo',
                            text: `🎲 Rolagem Rápida: ${diceNotation}`,
                            timestamp: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
                            isDiceRoll: true,
                            diceResult: result.total,
                            diceDetails: result.formula
                          }
                          setChatMessages(prev => [...prev, newMessage])
                          if (useFirebase) {
                            (async () => {
                              const currentMessages = await loadChatMessages()
                              await saveChatMessages([...(currentMessages || []), newMessage])
                            })().catch(err => console.error('Erro ao salvar mensagem:', err))
                          }
                        }}
                        className="w-full sm:w-auto px-3 sm:px-5 md:px-6 h-8 bg-purple-600 text-white rounded font-bold hover:bg-purple-700 transition-colors text-sm"
                      >
                        🎲 Rolar
                      </button>
                    </div>
                  </div>

                  <div className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-4 space-y-1`}>
                    <p>Use /r ou /roll para rolar dados. Exemplo: /r 1d20+5, /roll 2d6</p>
                    <p>Use comandos @ para referenciar seus atributos: <span className="font-mono">1d20+@MAE</span>, <span className="font-mono">2d6+@MA+@MV</span></p>
                    <p className="text-[10px]">Comandos: @MA @MD @MAE @MDE @MV @MS @At @Dt @AEt @DEt @Vt @St @Cont</p>
                  </div>

                  {/* Área de Mensagens */}
                  <div ref={chatContainerRef} className={`${darkMode ? 'bg-gray-900' : 'bg-gray-50'} rounded-lg p-4 h-96 overflow-y-auto mb-4`}>
                    {chatMessages.length === 0 ? (
                      <p className={`text-center ${darkMode ? 'text-gray-500' : 'text-gray-400'} py-3 sm:py-5 md:py-8`}>
                        Nenhuma mensagem ainda. Seja o primeiro a falar!
                      </p>
                    ) : (
                      <div className="space-y-3">
                        {chatMessages.map((msg, idx) => (
                          <div key={idx} className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg p-3`}>
                            <div className="flex justify-between items-start mb-1">
                              <span className={`font-bold text-sm ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>{msg.username}</span>
                              <span className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>{msg.timestamp}</span>
                            </div>
                            {msg.isDiceRoll ? (
                              <div>
                                <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>{msg.text}</p>
                                <div className={`mt-2 p-2 rounded ${darkMode ? 'bg-green-900' : 'bg-green-100'}`}>
                                  <p className={`font-bold text-lg ${darkMode ? 'text-green-400' : 'text-green-700'}`}>Resultado: {msg.diceResult}</p>
                                  <p className={`text-xs ${darkMode ? 'text-green-300' : 'text-green-600'}`}>{msg.diceDetails}</p>
                                </div>
                              </div>
                            ) : msg.isAction ? (
                              <p className="text-sm font-semibold text-yellow-500">{msg.text}</p>
                            ) : (
                              <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>{msg.text}</p>
                            )}
                          </div>
                        ))}
                      </div>
                    )}
                  </div>

                  {/* Input de Mensagem */}
                  <div className="flex gap-2">
                    <input
                      type="text"
                      value={chatInput}
                      onChange={(e) => setChatInput(e.target.value)}
                      onKeyPress={(e) => { if (e.key === 'Enter') handleSendMessage() }}
                      placeholder="Digite sua mensagem, 1d20+@MAE, ou /r 1d20..."
                      className={`flex-1 px-3 py-2 sm:px-4 sm:py-3 rounded-lg border-2 text-sm sm:text-base ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-500' : 'bg-white border-gray-300 text-gray-800 placeholder-gray-400'} focus:outline-none focus:border-blue-500`}
                    />
                    <button onClick={handleSendMessage} className="px-3 sm:px-5 md:px-6 py-2 sm:py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold text-sm sm:text-base">Enviar</button>
                  </div>
                </div>
              </div>
            )}

            {/* ESPECTADOR */}
            {safariSubarea === 'Espectador' && (
              <div>
                {/* Botões para assistir cada run */}
                <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-6 mb-6`}>
                  <h3 className={`text-lg sm:text-xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-800'}`}>Assistir Runs</h3>
                  <p className={`mb-4 text-sm ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                    Selecione uma run para assistir os encontros de outros jogadores.
                  </p>
                  <div className="flex flex-wrap gap-3">
                    {[1, 2, 3, 4, 5].map(num => {
                      const runKey = `run-${num}`
                      const runEnc = safariRunEncounters[runKey] || []
                      return (
                        <button key={num}
                          onClick={() => setSafariSpectatorRun(safariSpectatorRun === num ? null : num)}
                          className={`px-4 py-2 rounded-lg font-semibold transition-all ${
                            safariSpectatorRun === num
                              ? 'bg-purple-600 text-white ring-2 ring-purple-400'
                              : runEnc.length > 0
                                ? (darkMode ? 'bg-purple-800 text-purple-300 hover:bg-purple-700' : 'bg-purple-100 text-purple-800 hover:bg-purple-200')
                                : (darkMode ? 'bg-gray-600 text-gray-300 hover:bg-gray-500' : 'bg-gray-200 text-gray-500 hover:bg-gray-300')
                          }`}>
                          Assistir Run {num} {runEnc.length > 0 ? `(${runEnc.length})` : ''}
                        </button>
                      )
                    })}
                  </div>
                </div>

                {/* Pokémons da Run sendo assistida */}
                {safariSpectatorRun && (() => {
                  const spectatorRunKey = `run-${safariSpectatorRun}`
                  const spectatorEncounters = safariRunEncounters[spectatorRunKey] || []
                  return (
                    <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-6 mb-6`}>
                      <h3 className={`text-lg sm:text-xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                        Run Safari {safariSpectatorRun} {safariRunAreas[spectatorRunKey] ? `- ${safariRunAreas[spectatorRunKey]}` : ''}
                      </h3>
                      {spectatorEncounters.length === 0 ? (
                        <p className={`text-center py-4 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                          Nenhum pokémon no encontro desta run ainda.
                        </p>
                      ) : (
                        <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 sm:gap-3 md:gap-4">
                          {spectatorEncounters.map((npc, npcIndex) => {
                            // Array de cores para os cards Safari NPC (mesmo do mestre e treinador)
                            const safariCardColors = [
                              { dark: 'bg-gradient-to-br from-rose-800 to-rose-900', light: 'bg-gradient-to-br from-rose-200 to-rose-300' },
                              { dark: 'bg-gradient-to-br from-blue-800 to-blue-900', light: 'bg-gradient-to-br from-blue-200 to-blue-300' },
                              { dark: 'bg-gradient-to-br from-emerald-800 to-emerald-900', light: 'bg-gradient-to-br from-emerald-200 to-emerald-300' },
                              { dark: 'bg-gradient-to-br from-amber-800 to-amber-900', light: 'bg-gradient-to-br from-amber-200 to-amber-300' },
                              { dark: 'bg-gradient-to-br from-purple-800 to-purple-900', light: 'bg-gradient-to-br from-purple-200 to-purple-300' },
                              { dark: 'bg-gradient-to-br from-cyan-800 to-cyan-900', light: 'bg-gradient-to-br from-cyan-200 to-cyan-300' },
                              { dark: 'bg-gradient-to-br from-pink-800 to-pink-900', light: 'bg-gradient-to-br from-pink-200 to-pink-300' },
                              { dark: 'bg-gradient-to-br from-indigo-800 to-indigo-900', light: 'bg-gradient-to-br from-indigo-200 to-indigo-300' },
                              { dark: 'bg-gradient-to-br from-teal-800 to-teal-900', light: 'bg-gradient-to-br from-teal-200 to-teal-300' },
                              { dark: 'bg-gradient-to-br from-orange-800 to-orange-900', light: 'bg-gradient-to-br from-orange-200 to-orange-300' },
                            ]
                            const cardColor = safariCardColors[npcIndex % safariCardColors.length]
                            const cardBg = darkMode ? cardColor.dark : cardColor.light

                            return (
                              <div key={npc.id}
                                className={`${cardBg} rounded-xl p-3 text-center`}>
                                {npc.imageUrl && <img src={npc.imageUrl} alt={npc.species} className="w-16 h-16 mx-auto mb-1" />}
                                <h4 className={`font-bold text-sm ${darkMode ? 'text-white' : 'text-gray-800'}`}>{npc.species}</h4>
                                <p className={`text-xs ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>Nível {npc.level}</p>
                                {/* Tipos */}
                                <div className="flex justify-center gap-1 mt-1">
                                  {(npc.types || []).map(t => (
                                    <span key={t} className="px-1.5 py-0.5 rounded text-[9px] font-bold text-white" style={{ backgroundColor: typeColorsTrainer[t] || '#888' }}>
                                      {t.charAt(0).toUpperCase() + t.slice(1)}
                                    </span>
                                  ))}
                                </div>
                              </div>
                            )
                          })}
                        </div>
                      )}
                    </div>
                  )
                })()}

                {/* Chat do Espectador */}
                <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-6`}>
                  <h3 className={`text-lg sm:text-xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-800'}`}>Chat</h3>

                  {/* Menu de Rolagem Rápida */}
                  <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} rounded-lg p-3 sm:p-4 mb-4`}>
                    <h4 className={`text-sm font-bold mb-3 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      Rolagem Rápida
                    </h4>
                    <div className="flex flex-col sm:flex-row sm:flex-wrap sm:items-center gap-3">
                      <div className="flex flex-col xs:flex-row xs:items-center gap-2">
                        <span className={`text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'} whitespace-nowrap`}>Quantidade:</span>
                        <div className="flex flex-wrap gap-1">
                          {[1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(num => (
                            <button
                              key={num}
                              onClick={() => setQuickRollNumDice(num)}
                              className={`w-7 h-7 sm:w-8 sm:h-8 rounded text-xs sm:text-sm font-bold transition-colors ${
                                quickRollNumDice === num
                                  ? 'bg-blue-600 text-white'
                                  : darkMode
                                  ? 'bg-gray-600 text-gray-300 hover:bg-gray-500'
                                  : 'bg-white text-gray-700 hover:bg-gray-200'
                              }`}
                            >
                              {num}
                            </button>
                          ))}
                        </div>
                      </div>
                      <div className="flex flex-col xs:flex-row xs:items-center gap-2">
                        <span className={`text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'} whitespace-nowrap`}>Dado:</span>
                        <div className="flex flex-wrap gap-1">
                          {['d4', 'd6', 'd8', 'd10', 'd12', 'd20'].map(dice => (
                            <button
                              key={dice}
                              onClick={() => setQuickRollDiceType(dice)}
                              className={`px-2 sm:px-3 h-7 sm:h-8 rounded text-xs sm:text-sm font-bold transition-colors ${
                                quickRollDiceType === dice
                                  ? 'bg-green-600 text-white'
                                  : darkMode
                                  ? 'bg-gray-600 text-gray-300 hover:bg-gray-500'
                                  : 'bg-white text-gray-700 hover:bg-gray-200'
                              }`}
                            >
                              {dice}
                            </button>
                          ))}
                        </div>
                      </div>
                      <button
                        onClick={() => {
                          const diceNotation = `${quickRollNumDice}${quickRollDiceType}`
                          const result = rollDiceExpression(diceNotation)
                          if (result.error) {
                            alert(result.error)
                            return
                          }
                          const newMessage = {
                            username: currentUser?.username || 'Anônimo',
                            text: `🎲 Rolagem Rápida: ${diceNotation}`,
                            timestamp: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
                            isDiceRoll: true,
                            diceResult: result.total,
                            diceDetails: result.formula
                          }
                          setChatMessages(prev => [...prev, newMessage])
                          if (useFirebase) {
                            (async () => {
                              const currentMessages = await loadChatMessages()
                              await saveChatMessages([...(currentMessages || []), newMessage])
                            })().catch(err => console.error('Erro ao salvar mensagem:', err))
                          }
                        }}
                        className="w-full sm:w-auto px-3 sm:px-5 md:px-6 h-8 bg-purple-600 text-white rounded font-bold hover:bg-purple-700 transition-colors text-sm"
                      >
                        🎲 Rolar
                      </button>
                    </div>
                  </div>

                  <div className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-4 space-y-1`}>
                    <p>Use /r ou /roll para rolar dados. Exemplo: /r 1d20+5, /roll 2d6</p>
                    <p>Use comandos @ para referenciar seus atributos: <span className="font-mono">1d20+@MAE</span>, <span className="font-mono">2d6+@MA+@MV</span></p>
                    <p className="text-[10px]">Comandos: @MA @MD @MAE @MDE @MV @MS @At @Dt @AEt @DEt @Vt @St @Cont</p>
                  </div>

                  {/* Área de Mensagens */}
                  <div ref={chatContainerRef} className={`${darkMode ? 'bg-gray-900' : 'bg-gray-50'} rounded-lg p-4 h-96 overflow-y-auto mb-4`}>
                    {chatMessages.length === 0 ? (
                      <p className={`text-center ${darkMode ? 'text-gray-500' : 'text-gray-400'} py-3 sm:py-5 md:py-8`}>
                        Nenhuma mensagem ainda. Seja o primeiro a falar!
                      </p>
                    ) : (
                      <div className="space-y-3">
                        {chatMessages.map((msg, idx) => (
                          <div key={idx} className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg p-3`}>
                            <div className="flex justify-between items-start mb-1">
                              <span className={`font-bold text-sm ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>
                                {msg.username}
                              </span>
                              <span className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                                {msg.timestamp}
                              </span>
                            </div>
                            {msg.isDiceRoll ? (
                              <div>
                                <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                  {msg.text}
                                </p>
                                <div className={`mt-2 p-2 rounded ${darkMode ? 'bg-green-900' : 'bg-green-100'}`}>
                                  <p className={`font-bold text-lg ${darkMode ? 'text-green-400' : 'text-green-700'}`}>
                                    Resultado: {msg.diceResult}
                                  </p>
                                  <p className={`text-xs ${darkMode ? 'text-green-300' : 'text-green-600'}`}>
                                    {msg.diceDetails}
                                  </p>
                                </div>
                              </div>
                            ) : msg.isAction ? (
                              <p className={`text-sm font-semibold text-yellow-500`}>
                                {msg.text}
                              </p>
                            ) : (
                              <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                {msg.text}
                              </p>
                            )}
                          </div>
                        ))}
                      </div>
                    )}
                  </div>

                  {/* Input de Mensagem */}
                  <div className="flex gap-2">
                    <input
                      type="text"
                      value={chatInput}
                      onChange={(e) => setChatInput(e.target.value)}
                      onKeyPress={(e) => {
                        if (e.key === 'Enter') {
                          handleSendMessage()
                        }
                      }}
                      placeholder="Digite sua mensagem, 1d20+@MAE, ou /r 1d20..."
                      className={`flex-1 px-3 py-2 sm:px-4 sm:py-3 rounded-lg border-2 text-sm sm:text-base ${
                        darkMode
                          ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-500'
                          : 'bg-white border-gray-300 text-gray-800 placeholder-gray-400'
                      } focus:outline-none focus:border-blue-500`}
                    />
                    <button
                      onClick={handleSendMessage}
                      className="px-3 sm:px-5 md:px-6 py-2 sm:py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold text-sm sm:text-base"
                    >
                      Enviar
                    </button>
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>

        {/* Modal Avançar para... */}
        {showAreaNavigationModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowAreaNavigationModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-sm w-full`} onClick={(e) => e.stopPropagation()}>
              <div className="p-3 sm:p-5 md:p-6">
                <h3 className={`text-xl sm:text-2xl font-bold mb-6 ${darkMode ? 'text-white' : 'text-gray-800'}`}>Avançar para...</h3>
                <div className="space-y-3">
                  {connections.map(area => (
                    <button key={area} onClick={() => handleSafariNavigate(area)}
                      className={`w-full py-3 rounded-lg font-semibold transition-all ${darkMode ? 'bg-green-800 text-white hover:bg-green-700' : 'bg-green-100 text-green-800 hover:bg-green-200'}`}>
                      {area}
                    </button>
                  ))}
                </div>
                <button onClick={() => setShowAreaNavigationModal(false)}
                  className={`w-full mt-4 py-3 rounded-lg font-semibold ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}>
                  Cancelar
                </button>
              </div>
            </div>
          </div>
        )}

        {showMapaSafariCompletoModal && (
          <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-2 sm:p-4" onClick={() => { setShowMapaSafariCompletoModal(false); setSafariMapSelectedArea(null) }}>
            <div className={`relative ${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-4 flex flex-col md:flex-row gap-2 sm:gap-3 md:gap-4 max-w-[95vw] sm:max-w-3xl md:max-w-4xl lg:max-w-6xl max-h-[90vh] overflow-y-auto md:overflow-y-visible`} onClick={e => e.stopPropagation()}>
              <button onClick={() => { setShowMapaSafariCompletoModal(false); setSafariMapSelectedArea(null) }}
                className={`absolute top-2 right-2 w-8 h-8 rounded-full flex items-center justify-center font-bold z-10 ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}>
                X
              </button>
              <div className="relative flex-shrink-0 w-full md:w-auto">
                <img src="/mapasafaricompleto.png" alt="Mapa Safari Completo" className="w-full md:max-h-[80vh] rounded-lg object-contain" />
                {[
                  { area: 'Área Norte', top: '5%', left: '49%', w: '18%', h: '4%' },
                  { area: 'Área Noroeste', top: '36%', left: '16%', w: '20%', h: '5%' },
                  { area: 'Área Nordeste', top: '34%', left: '77%', w: '20%', h: '4%' },
                  { area: 'Área Oeste', top: '60%', left: '23%', w: '18%', h: '4%' },
                  { area: 'Área Leste', top: '60%', left: '85%', w: '18%', h: '4%' },
                  { area: 'Área Central', top: '86%', left: '52%', w: '20%', h: '4%' },
                ].map(({ area, top, left, w, h }) => (
                  <button key={area} onClick={() => setSafariMapSelectedArea(safariMapSelectedArea === area ? null : area)}
                    className="absolute cursor-pointer"
                    style={{ top, left, width: w, height: h, background: 'transparent', border: 'none', outline: 'none', transform: 'translate(-50%, -50%)' }}
                    title={area}
                  />
                ))}
              </div>
              {safariMapSelectedArea && (
                <div className={`w-full md:w-72 flex-shrink-0 overflow-y-auto max-h-[40vh] md:max-h-[80vh] rounded-xl p-3 ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                  <h4 className={`text-base sm:text-lg font-bold mb-3 text-center ${darkMode ? 'text-white' : 'text-gray-800'}`}>{safariMapSelectedArea}</h4>
                  {['Grama', 'Água'].map(terrain => {
                    const encounters = SAFARI_ENCOUNTERS.filter(e => e.area === safariMapSelectedArea && e.terrain === terrain)
                    if (encounters.length === 0) return null
                    return (
                      <div key={terrain} className="mb-3">
                        <h5 className={`text-xs sm:text-sm font-bold mb-2 px-2 py-1 rounded ${terrain === 'Grama' ? 'bg-green-600 text-white' : 'bg-blue-600 text-white'}`}>
                          {terrain === 'Grama' ? '🌿' : '🌊'} {terrain}
                        </h5>
                        <div className="space-y-1">
                          {encounters.map((enc, i) => (
                            <div key={i} className={`px-2 py-1.5 rounded text-xs font-semibold ${darkMode ? 'bg-gray-600 text-white' : 'bg-white text-gray-800'}`}>
                              {enc.pokemon}
                            </div>
                          ))}
                        </div>
                      </div>
                    )
                  })}
                </div>
              )}
            </div>
          </div>
        )}

        {accountDataModal}
        {scenarioPopupOverlay}
        {mostrarTriunfosOverlay}
        {pokezapPanel}{pokeAgendaPanel}
        {batalhaChatPanel}
      </>
    )
  }

  // ÁREA ÁRVORE DE APRICORNS (Apenas Treinador)
  if (currentArea === 'Árvore de Apricorns' && currentUser.type === 'treinador') {
    return (
      <>
        <div className={`min-h-screen ${mainBgClass}`}>
          {sidebarNav}
          <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-lg`}>
            <div className="max-w-7xl mx-auto px-4 py-4">
              <div className="flex justify-between items-center mb-4">
                <div className="flex items-center gap-3"><button onClick={() => setSidebarOpen(true)} className={`p-2 rounded-lg ${darkMode ? "hover:bg-gray-700 text-gray-400" : "hover:bg-gray-200 text-gray-500"}`}><Menu size={24} /></button><h2 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Árvore de Apricorns</h2></div>
                <div className="flex gap-2 items-center">
                  <button onClick={() => setDarkMode(!darkMode)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-yellow-400' : 'bg-gray-200 text-gray-700'}`}>{darkMode ? <Sun size={20} /> : <Moon size={20} />}</button>
                  {pokezapBtn}{pokeAgendaBtn}{batalhaChatBtn}<button onClick={handleLogout} className="bg-red-500 text-white px-3 sm:px-5 md:px-6 py-2 rounded-lg hover:bg-red-600">Sair</button>
                  {currentClima && <div className="flex items-center gap-1.5 ml-1"><img src={`/pokeballs/${currentClima.image}`} alt={currentClima.name} className="w-7 h-7" /><span className={`text-xs font-semibold ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>{currentClima.name}</span></div>}
                </div>
              </div>
            </div>
          </div>

          {/* Navegação de Subáreas da Árvore de Apricorns */}
          <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-md`}>
            <div className="max-w-7xl mx-auto px-4 py-3">
              <div className="flex flex-wrap gap-2">
                {['Árvores', 'Bonsais'].map(subarea => (
                  <button
                    key={subarea}
                    onClick={() => setApricornSubarea(subarea)}
                    className={`px-4 py-2 rounded-lg text-sm font-semibold transition-all ${
                      apricornSubarea === subarea
                        ? 'bg-gradient-to-r from-green-600 to-emerald-700 text-white shadow-lg'
                        : darkMode
                        ? 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                        : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                    }`}
                  >
                    {subarea}
                  </button>
                ))}
              </div>
            </div>
          </div>

          <div className="max-w-7xl mx-auto px-4 py-3 sm:py-5 md:py-8">
            {/* Subárea: Árvores */}
            {apricornSubarea === 'Árvores' && (
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-6`}>
              <h4 className={`font-bold mb-4 text-lg sm:text-xl ${darkMode ? 'text-white' : 'text-gray-800'}`}>Árvores</h4>

              <button
                onClick={() => setShowPlantTreeModal(true)}
                className="bg-green-600 hover:bg-green-700 text-white px-3 sm:px-4 py-2 rounded-lg mb-4 font-semibold text-sm sm:text-base w-full sm:w-auto"
              >
                🌱 Plantar Árvore
              </button>

              {/* Generated Trees from Master */}
              <div className="mb-6">
                <h5 className={`font-semibold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Árvores Disponíveis (Geradas pelo Mestre)</h5>
                <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2 sm:gap-3 md:gap-4">
                  {generatedApricornTrees
                    .filter(tree => tree.hasFruit)
                    .map(tree => (
                      <div key={tree.id} className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-3 sm:p-4 rounded-lg text-center`}>
                        <img src={tree.image} alt={tree.name} className="w-16 h-16 sm:w-20 sm:h-20 mx-auto mb-2" />
                        <p className={`font-semibold mb-2 text-xs sm:text-sm ${darkMode ? 'text-white' : 'text-gray-800'}`}>{tree.name}</p>
                        <button
                          onClick={() => handleColherArvore(tree)}
                          className="bg-blue-600 hover:bg-blue-700 text-white px-3 sm:px-4 py-1 rounded text-xs sm:text-sm"
                        >
                          🍎 Colher (1d6)
                        </button>
                      </div>
                    ))}
                  {generatedApricornTrees.filter(tree => tree.hasFruit).length === 0 && (
                    <p className="col-span-3 text-center text-gray-400">Nenhuma árvore disponível no momento</p>
                  )}
                </div>
              </div>

              {/* Planted Trees */}
              <div>
                <h5 className={`font-semibold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Árvores Plantadas</h5>
                <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2 sm:gap-3 md:gap-4">
                  {plantedTrees.map(tree => (
                    <div key={tree.id} className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-3 sm:p-4 rounded-lg text-center relative group`}>
                      <button
                        onClick={() => handleExcluirArvore(tree.id)}
                        className="absolute top-2 right-2 text-red-500 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity"
                        title="Excluir árvore"
                      >
                        <Trash2 size={16} />
                      </button>
                      <img
                        src={tree.isMatured ? tree.image : '/mudadeapricorn.png'}
                        alt={tree.name}
                        className="w-16 h-16 sm:w-20 sm:h-20 mx-auto mb-2"
                      />
                      <p className={`font-semibold text-xs sm:text-sm ${darkMode ? 'text-white' : 'text-gray-800'}`}>{tree.name}</p>
                      <p className={`text-xs sm:text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Local: {tree.location}</p>

                      {!tree.isMatured && (
                        <>
                          <p className="text-yellow-400 text-xs sm:text-sm mt-1">Dias restantes: {tree.daysRemaining}</p>
                          <div className="flex flex-col xs:flex-row gap-2 mt-2">
                            <button
                              onClick={() => handlePassarDia(tree)}
                              disabled={tree.daysRemaining === 0}
                              className={`w-full xs:flex-1 px-2 sm:px-3 py-1 rounded text-xs sm:text-sm ${
                                tree.daysRemaining === 0
                                  ? 'bg-gray-500 cursor-not-allowed'
                                  : 'bg-yellow-600 hover:bg-yellow-700'
                              } text-white`}
                            >
                              ⏭️ Passar Dia
                            </button>
                            <button
                              onClick={() => handleAmadurecerArvore(tree)}
                              disabled={tree.daysRemaining > 0}
                              className={`w-full xs:flex-1 px-2 sm:px-3 py-1 rounded text-xs sm:text-sm ${
                                tree.daysRemaining > 0
                                  ? 'bg-gray-500 cursor-not-allowed'
                                  : 'bg-green-600 hover:bg-green-700'
                              } text-white`}
                            >
                              🌳 Amadurecer
                            </button>
                          </div>
                        </>
                      )}

                      {tree.isMatured && (
                        <button
                          onClick={() => handleColherArvore(tree)}
                          className="mt-2 bg-blue-600 hover:bg-blue-700 text-white px-3 sm:px-4 py-1 rounded text-xs sm:text-sm"
                        >
                          🍎 Colher Novamente (1d6)
                        </button>
                      )}
                    </div>
                  ))}
                  {plantedTrees.length === 0 && (
                    <p className="col-span-3 text-center text-gray-400">Nenhuma árvore plantada ainda</p>
                  )}
                </div>
              </div>
            </div>
            )}

            {/* Subárea: Bonsais */}
            {apricornSubarea === 'Bonsais' && (
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-6`}>
              <h4 className={`font-bold mb-4 text-lg sm:text-xl ${darkMode ? 'text-white' : 'text-gray-800'}`}>Bonsais</h4>
              <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2 sm:gap-3 md:gap-4">
                {keyItems
                  .filter(item => item.name?.startsWith('Bonsai'))
                  .map(bonsai => (
                    <div key={bonsai.name} className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-3 sm:p-4 rounded-lg text-center`}>
                      <img
                        src={getItemImage(bonsai.name)}
                        alt={bonsai.name}
                        className="w-12 h-12 sm:w-16 sm:h-16 mx-auto mb-2"
                      />
                      <p className={`font-semibold mb-1 text-xs sm:text-sm ${darkMode ? 'text-white' : 'text-gray-800'}`}>{bonsai.name}</p>
                      <p className={`text-xs sm:text-sm mb-2 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Quantidade: {bonsai.quantity || 1}</p>
                      <button
                        onClick={() => handleColetarBonsai(bonsai)}
                        className="bg-purple-600 hover:bg-purple-700 text-white px-2 sm:px-3 py-1 rounded text-xs sm:text-sm"
                      >
                        🌿 Coletar (1d3)
                      </button>
                    </div>
                  ))}
                {keyItems.filter(item => item.name?.startsWith('Bonsai')).length === 0 && (
                  <p className="text-gray-400 col-span-4 text-center">Nenhum bonsai na mochila</p>
                )}
              </div>
            </div>
            )}
          </div>
        </div>

        {/* Plant Tree Modal */}
        {showPlantTreeModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-2 sm:p-4">
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-3 sm:p-5 md:p-6 rounded-lg max-w-[95vw] sm:max-w-md md:max-w-2xl w-full max-h-[90vh] overflow-y-auto`}>
              <h3 className={`text-lg sm:text-xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-800'}`}>Plantar Árvore</h3>

              {/* Local do Plantio */}
              <div className="mb-4">
                <label className={`block mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Local do Plantio:</label>
                <input
                  type="text"
                  value={plantLocation}
                  onChange={(e) => setPlantLocation(e.target.value)}
                  className={`w-full px-3 py-2 rounded ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-100 text-gray-800'}`}
                  placeholder="Ex: Jardim da Casa, Rota 1, etc."
                />
              </div>

              {/* Tree Search */}
              <div className="mb-4">
                <label className={`block mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Buscar Árvore:</label>
                <input
                  type="text"
                  value={treeSearchQuery}
                  onChange={(e) => setTreeSearchQuery(e.target.value)}
                  className={`w-full px-3 py-2 rounded mb-2 ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-100 text-gray-800'}`}
                  placeholder="Digite para buscar..."
                />
              </div>

              {/* Tree Selection */}
              <div className="grid grid-cols-2 sm:grid-cols-3 gap-2 sm:gap-3 mb-4 max-h-60 overflow-y-auto">
                {APRICORN_TREES
                  .filter(tree => tree.fruit !== null)
                  .filter(tree =>
                    tree.name.toLowerCase().includes(treeSearchQuery.toLowerCase())
                  )
                  .map(tree => (
                    <button
                      key={tree.name}
                      onClick={() => setSelectedTreeToPlant(tree)}
                      className={`p-2 sm:p-3 rounded text-center transition-colors ${
                        selectedTreeToPlant?.name === tree.name
                          ? 'bg-gradient-to-r from-blue-600 to-purple-600 text-white'
                          : darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-gray-100 hover:bg-gray-200 text-gray-800'
                      }`}
                    >
                      <img src={tree.image} alt={tree.name} className="w-10 h-10 sm:w-12 sm:h-12 mx-auto mb-1" />
                      <p className="text-xs sm:text-sm">{tree.name}</p>
                    </button>
                  ))}
              </div>

              {/* Action Buttons */}
              <div className="flex flex-col sm:flex-row gap-2 sm:gap-3 md:gap-4">
                <button
                  onClick={() => {
                    setShowPlantTreeModal(false)
                    setPlantLocation('')
                    setSelectedTreeToPlant(null)
                    setTreeSearchQuery('')
                  }}
                  className={`w-full sm:flex-1 px-3 sm:px-4 py-2 rounded text-sm sm:text-base ${darkMode ? 'bg-gray-600 hover:bg-gray-500' : 'bg-gray-300 hover:bg-gray-400'} text-white`}
                >
                  Cancelar
                </button>
                <button
                  onClick={handlePlantarArvore}
                  className="w-full sm:flex-1 bg-green-600 hover:bg-green-700 text-white px-3 sm:px-4 py-2 rounded text-sm sm:text-base"
                >
                  Plantar
                </button>
              </div>
            </div>
          </div>
        )}

        {accountDataModal}
        {scenarioPopupOverlay}
        {mostrarTriunfosOverlay}
        {pokezapPanel}{pokeAgendaPanel}
        {batalhaChatPanel}
      </>
    )
  }

  // ÁREA HUB DE TROCA (Treinador)
  if (currentUser.type === 'treinador' && currentArea === 'Hub de Troca') {
    return (
      <>
        <div className={`min-h-screen ${mainBgClass}`}>
          {sidebarNav}
        <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-lg`}>
          <div className="max-w-7xl mx-auto px-4 py-4">
            <div className="flex justify-between items-center mb-4">
              <div className="flex items-center gap-3"><button onClick={() => setSidebarOpen(true)} className={`p-2 rounded-lg ${darkMode ? "hover:bg-gray-700 text-gray-400" : "hover:bg-gray-200 text-gray-500"}`}><Menu size={24} /></button><h2 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Hub de Troca</h2></div>
              <div className="flex gap-2">
                <button onClick={() => setShowAccountDataModal(true)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-200 text-gray-700'}`} title="Dados da Conta"><ArrowDownUp size={20} /></button>
                <button onClick={() => setDarkMode(!darkMode)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-yellow-400' : 'bg-gray-200 text-gray-700'}`}>{darkMode ? <Sun size={20} /> : <Moon size={20} />}</button>
                {pokezapBtn}{pokeAgendaBtn}{batalhaChatBtn}<button onClick={handleLogout} className="bg-red-500 text-white px-3 sm:px-5 md:px-6 py-2 rounded-lg hover:bg-red-600">Sair</button>
              </div>
            </div>
          </div>
        </div>

          <div className="max-w-7xl mx-auto px-4 py-6">
            {tradeHubOffers.length === 0 ? (
              <div className={`text-center py-20 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                <p className="text-xl">Nenhuma oferta de troca disponível</p>
                <p className="text-sm mt-2">Aguarde o Mestre gerar ofertas de troca.</p>
              </div>
            ) : (
              <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                {tradeHubOffers.map(trade => {
                  const pokemon = trade.offeredPokemon
                  const isCompleted = !!tradeHubCompletedTrades[trade.id]
                  const completedBy = tradeHubCompletedTrades[trade.id]

                  // Verificar se o treinador tem o pokémon necessário
                  const matchingMainTeam = mainTeam.filter(p => p.species === trade.requiredSpecies)
                  const matchingPc = pcPokemon.filter(p => p.species === trade.requiredSpecies)
                  const allMatching = [
                    ...matchingMainTeam.map(p => ({ ...p, _location: 'mainTeam' })),
                    ...matchingPc.map(p => ({ ...p, _location: 'pcPokemon' }))
                  ]
                  const hasRequired = allMatching.length > 0

                  return (
                    <div key={trade.id} className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl overflow-hidden ${isCompleted ? 'opacity-60' : ''}`}>
                      {/* Pokémon oferecido - Card simplificado (somente leitura) */}
                      <div className="p-3 sm:p-4">
                        <div className="flex flex-col items-center">
                          {pokemon.imageUrl && (
                            <img
                              src={pokemon.imageUrl}
                              alt={pokemon.name || pokemon.species}
                              className="w-20 h-20 sm:w-24 sm:h-24 object-contain mb-2"
                            />
                          )}
                          <p className={`text-sm font-bold text-center ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                            {pokemon.species || pokemon.name} {pokemon.shiny && '✨'}
                          </p>
                          <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                            Nível {pokemon.level}
                          </p>
                          {/* Tipos */}
                          <div className="flex gap-1 mt-1 flex-wrap justify-center">
                            {pokemon.types?.map((type, idx) => (
                              <span key={idx} className="px-2 py-0.5 text-[10px] rounded-lg bg-gradient-to-r from-blue-600 to-purple-700 text-white font-semibold">
                                {type}
                              </span>
                            ))}
                          </div>
                          {/* Habilidades */}
                          {(pokemon.habilidade1 || pokemon.habilidade2) && (
                            <div className="flex gap-1 mt-1 flex-wrap justify-center">
                              {pokemon.habilidade1 && (
                                <span className={`px-1.5 py-0.5 rounded text-[10px] font-semibold ${darkMode ? 'bg-blue-900 text-blue-300' : 'bg-blue-500 text-white'}`}>
                                  {pokemon.habilidade1}
                                </span>
                              )}
                              {pokemon.habilidade2 && (
                                <span className={`px-1.5 py-0.5 rounded text-[10px] font-semibold ${darkMode ? 'bg-purple-900 text-purple-300' : 'bg-purple-500 text-white'}`}>
                                  {pokemon.habilidade2}
                                </span>
                              )}
                            </div>
                          )}
                          {/* Atributos resumidos */}
                          <div className={`mt-2 w-full grid grid-cols-3 gap-1 text-[10px] ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                            <div className="text-center"><span className="font-bold">SAU</span> {pokemon.attributes?.saude}</div>
                            <div className="text-center"><span className="font-bold">ATK</span> {pokemon.attributes?.ataque}</div>
                            <div className="text-center"><span className="font-bold">DEF</span> {pokemon.attributes?.defesa}</div>
                            <div className="text-center"><span className="font-bold">ATE</span> {pokemon.attributes?.ataqueEspecial}</div>
                            <div className="text-center"><span className="font-bold">DEE</span> {pokemon.attributes?.defesaEspecial}</div>
                            <div className="text-center"><span className="font-bold">VEL</span> {pokemon.attributes?.velocidade}</div>
                          </div>
                          {/* Natureza */}
                          <p className={`text-[10px] mt-1 ${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>
                            {pokemon.nature?.nome} ({pokemon.nature?.up && `↑${pokemon.nature.up}`} {pokemon.nature?.down && `↓${pokemon.nature.down}`})
                          </p>
                        </div>
                      </div>

                      {/* Separador "troca por" */}
                      <div className={`flex items-center justify-center gap-2 py-2 ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                        <span className={`text-xs font-bold ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>↕ troca por ↕</span>
                      </div>

                      {/* Pokémon necessário */}
                      <div className="p-3 flex flex-col items-center">
                        <img
                          src={trade.requiredImageUrl}
                          alt={trade.requiredSpecies}
                          className="w-16 h-16 object-contain mb-1"
                          onError={(e) => { e.target.src = 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/0.png' }}
                        />
                        <p className={`text-xs font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{trade.requiredSpecies}</p>
                      </div>

                      {/* Botão de ação */}
                      <div className="px-3 pb-3">
                        {isCompleted ? (
                          <div className="w-full text-center py-2 rounded-lg bg-gray-500 text-white text-xs font-semibold">
                            Troca já feita. ({completedBy})
                          </div>
                        ) : !hasRequired ? (
                          <div className={`w-full text-center py-2 rounded-lg text-xs font-semibold ${darkMode ? 'bg-gray-700 text-gray-400' : 'bg-gray-200 text-gray-500'}`}>
                            Não possui o pokémon necessário
                          </div>
                        ) : (
                          <button
                            onClick={() => {
                              setSelectedTradeOffer(trade)
                              if (allMatching.length === 1) {
                                // Só tem 1, ir direto para confirmação
                                setSelectedTradeUserPokemon(allMatching[0])
                                setShowTradeConfirmModal(true)
                              } else {
                                // Múltiplos, abrir seleção
                                setShowTradeSelectPokemonModal(true)
                              }
                            }}
                            className="w-full bg-gradient-to-r from-green-600 to-emerald-600 text-white py-2 rounded-lg hover:from-green-700 hover:to-emerald-700 font-semibold text-xs"
                          >
                            Aceitar Troca
                          </button>
                        )}
                      </div>
                    </div>
                  )
                })}
              </div>
            )}
          </div>
        </div>

        {/* Modal de seleção de pokémon para troca */}
        {showTradeSelectPokemonModal && selectedTradeOffer && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => { setShowTradeSelectPokemonModal(false); setSelectedTradeOffer(null) }}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg p-4 sm:p-6 max-w-md w-full max-h-[80vh] overflow-y-auto`} onClick={e => e.stopPropagation()}>
              <div className="flex justify-between items-center mb-4">
                <h3 className={`text-lg font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Escolha qual {selectedTradeOffer.requiredSpecies} enviar</h3>
                <button onClick={() => { setShowTradeSelectPokemonModal(false); setSelectedTradeOffer(null) }} className={darkMode ? 'text-gray-400 hover:text-white' : 'text-gray-600 hover:text-gray-800'}><X size={24} /></button>
              </div>
              <div className="space-y-2">
                {[
                  ...mainTeam.filter(p => p.species === selectedTradeOffer.requiredSpecies).map(p => ({ ...p, _location: 'mainTeam' })),
                  ...pcPokemon.filter(p => p.species === selectedTradeOffer.requiredSpecies).map(p => ({ ...p, _location: 'pcPokemon' }))
                ].map((pkm, idx) => (
                  <button
                    key={idx}
                    onClick={() => {
                      setSelectedTradeUserPokemon(pkm)
                      setShowTradeSelectPokemonModal(false)
                      setShowTradeConfirmModal(true)
                    }}
                    className={`w-full flex items-center gap-3 p-3 rounded-lg transition-colors ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-100 hover:bg-gray-200'}`}
                  >
                    {pkm.imageUrl && <img src={pkm.imageUrl} alt={pkm.species} className="w-12 h-12 object-contain" />}
                    <div className="text-left">
                      <p className={`text-sm font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                        {pkm.nickname || pkm.species} {pkm.shiny && '✨'}
                      </p>
                      <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                        Nível {pkm.level} • {pkm._location === 'mainTeam' ? 'Time' : 'PC'}
                      </p>
                    </div>
                  </button>
                ))}
              </div>
            </div>
          </div>
        )}

        {/* Modal de confirmação de troca */}
        {showTradeConfirmModal && selectedTradeOffer && selectedTradeUserPokemon && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => { setShowTradeConfirmModal(false); setSelectedTradeOffer(null); setSelectedTradeUserPokemon(null) }}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg p-4 sm:p-6 max-w-md w-full`} onClick={e => e.stopPropagation()}>
              <h3 className={`text-lg font-bold mb-4 text-center ${darkMode ? 'text-white' : 'text-gray-800'}`}>Confirmar Troca</h3>
              <div className="flex items-center justify-center gap-4 mb-4">
                <div className="text-center">
                  {selectedTradeUserPokemon.imageUrl && <img src={selectedTradeUserPokemon.imageUrl} alt={selectedTradeUserPokemon.species} className="w-16 h-16 object-contain mx-auto" />}
                  <p className={`text-xs font-bold mt-1 ${darkMode ? 'text-red-400' : 'text-red-600'}`}>{selectedTradeUserPokemon.nickname || selectedTradeUserPokemon.species}</p>
                  <p className={`text-[10px] ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Nível {selectedTradeUserPokemon.level}</p>
                </div>
                <span className={`text-2xl font-bold ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>→</span>
                <div className="text-center">
                  {selectedTradeOffer.offeredPokemon.imageUrl && <img src={selectedTradeOffer.offeredPokemon.imageUrl} alt={selectedTradeOffer.offeredPokemon.species} className="w-16 h-16 object-contain mx-auto" />}
                  <p className={`text-xs font-bold mt-1 ${darkMode ? 'text-green-400' : 'text-green-600'}`}>{selectedTradeOffer.offeredPokemon.species}</p>
                  <p className={`text-[10px] ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Nível {selectedTradeOffer.offeredPokemon.level}</p>
                </div>
              </div>
              <p className={`text-sm text-center mb-4 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                Deseja trocar <strong>{selectedTradeUserPokemon.nickname || selectedTradeUserPokemon.species}</strong> por <strong>{selectedTradeOffer.offeredPokemon.species}</strong>?
              </p>
              <div className="flex gap-2">
                <button
                  onClick={() => acceptTrade(selectedTradeOffer, selectedTradeUserPokemon, selectedTradeUserPokemon._location)}
                  className="flex-1 bg-gradient-to-r from-green-600 to-emerald-600 text-white py-2.5 rounded-lg hover:from-green-700 hover:to-emerald-700 font-semibold text-sm"
                >
                  Confirmar
                </button>
                <button
                  onClick={() => { setShowTradeConfirmModal(false); setSelectedTradeOffer(null); setSelectedTradeUserPokemon(null) }}
                  className={`flex-1 py-2.5 rounded-lg font-semibold text-sm ${darkMode ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                >
                  Cancelar
                </button>
              </div>
            </div>
          </div>
        )}

        {accountDataModal}
        {scenarioPopupOverlay}
        {mostrarTriunfosOverlay}
        {pokezapPanel}{pokeAgendaPanel}
        {batalhaChatPanel}
      </>
    )
  }

  // ÁREA INTERLÚDIO (Apenas Treinador)
  if (currentArea === 'Interlúdio' && currentUser.type === 'treinador') {
    return (
      <>
        <div className={`min-h-screen ${mainBgClass}`}>
          {sidebarNav}
          <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-lg`}>
            <div className="max-w-7xl mx-auto px-4 py-4">
              <div className="flex justify-between items-center mb-4">
                <div className="flex items-center gap-3"><button onClick={() => setSidebarOpen(true)} className={`p-2 rounded-lg ${darkMode ? "hover:bg-gray-700 text-gray-400" : "hover:bg-gray-200 text-gray-500"}`}><Menu size={24} /></button><h2 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  Interlúdio
                </h2></div>
                <div className="flex gap-2 items-center">
                  <button onClick={() => setShowRegrasInterludioModal(true)} className={`px-4 py-2 rounded-lg font-semibold ${darkMode ? 'bg-indigo-600 text-white hover:bg-indigo-700' : 'bg-indigo-500 text-white hover:bg-indigo-600'}`}>
                    Regras Interlúdio
                  </button>
                  <button onClick={() => setDarkMode(!darkMode)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-yellow-400' : 'bg-gray-200 text-gray-700'}`}>
                    {darkMode ? <Sun size={20} /> : <Moon size={20} />}
                  </button>
                  {pokezapBtn}{pokeAgendaBtn}{batalhaChatBtn}<button onClick={handleLogout} className="bg-red-500 text-white px-3 sm:px-5 md:px-6 py-2 rounded-lg hover:bg-red-600">Sair</button>
                  {currentClima && <div className="flex items-center gap-1.5 ml-1"><img src={`/pokeballs/${currentClima.image}`} alt={currentClima.name} className="w-7 h-7" /><span className={`text-xs font-semibold ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>{currentClima.name}</span></div>}
                </div>
              </div>
            </div>
          </div>

          <div className="max-w-7xl mx-auto px-4 py-3 sm:py-5 md:py-8">
            {/* PARTE 1: Ação do Jogador e Time Principal */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4 md:gap-6 mb-8">
              {/* Coluna Esquerda: Ação do Jogador */}
              <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-6`}>
                <h3 className={`text-xl sm:text-2xl font-bold mb-6 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  Ação do Jogador
                </h3>

                {(() => {
                  const player = interludioPlayers.find(p => p.username === currentUser.username)
                  if (!player) return (
                    <p className={`text-center ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                      Jogador não encontrado
                    </p>
                  )

                  return (
                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} rounded-lg p-4`}>
                      {/* Nome do Jogador */}
                      <h4 className={`text-lg font-bold mb-3 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                        {player.username}
                      </h4>

                      {/* Checkboxes JN e RT */}
                      <div className="flex gap-2 sm:gap-3 md:gap-4 mb-4">
                        <label className="flex items-center gap-2 cursor-pointer">
                          <input
                            type="checkbox"
                            checked={player.jnChecked}
                            onChange={() => handleToggleJN(player.username)}
                            className="w-4 h-4 cursor-pointer"
                          />
                          <span className={`text-sm font-semibold ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                            JN
                          </span>
                        </label>
                        <label className="flex items-center gap-2 cursor-pointer">
                          <input
                            type="checkbox"
                            checked={player.rtChecked}
                            onChange={() => handleToggleRT(player.username)}
                            className="w-4 h-4 cursor-pointer"
                          />
                          <span className={`text-sm font-semibold ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                            Rt
                          </span>
                        </label>
                      </div>

                      {/* Caixa de Ações */}
                      {(player.jnChecked || player.rtChecked) && (
                        <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg p-4 border ${darkMode ? 'border-gray-600' : 'border-gray-300'}`}>
                          {/* Pontos e Botões de Controle */}
                          <div className="mb-3 flex items-center justify-between">
                            <span className={`text-sm font-bold ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>
                              {player.jnChecked ? `Pontos de Narração: ${player.jnPoints}` : `Pontos de Roteiro: ${player.rtPoints}`}
                            </span>
                            <div className="flex gap-2">
                              <button
                                onClick={() => handleResetPoints(player.username)}
                                className={`p-2 rounded ${darkMode ? 'bg-purple-600 hover:bg-purple-700 text-white' : 'bg-purple-500 hover:bg-purple-600 text-white'} transition-colors`}
                                title="Resetar Pontos"
                              >
                                <RefreshCcw className="w-4 h-4" />
                              </button>
                              <button
                                onClick={() => handleOpenCustomModal(player.username, player.jnChecked ? 'jn' : 'rt')}
                                className={`p-2 rounded ${darkMode ? 'bg-orange-600 hover:bg-orange-700 text-white' : 'bg-orange-500 hover:bg-orange-600 text-white'} transition-colors`}
                                title="Ação Customizada"
                              >
                                <Settings2 className="w-4 h-4" />
                              </button>
                            </div>
                          </div>

                          {/* Lista de Ações */}
                          <div className="space-y-2">
                            {(player.jnChecked ? acoesJN : acoesRT).map((acao, idx) => {
                              const points = player.jnChecked ? player.jnPoints : player.rtPoints
                              const canAfford = points >= acao.custo

                              return (
                                <button
                                  key={idx}
                                  onClick={() => {
                                    if (player.jnChecked) {
                                      handleAcaoJN(player.username, acao)
                                    } else {
                                      handleAcaoRT(player.username, acao)
                                    }
                                  }}
                                  disabled={!canAfford}
                                  className={`w-full text-left px-3 py-2 rounded text-sm ${
                                    !canAfford
                                      ? darkMode ? 'bg-gray-900 text-gray-600 cursor-not-allowed' : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                      : darkMode
                                      ? 'bg-blue-600 text-white hover:bg-blue-700'
                                      : 'bg-blue-500 text-white hover:bg-blue-600'
                                  } transition-colors`}
                                >
                                  {acao.nome} <span className="text-xs opacity-75">(${acao.custo} pt)</span>
                                </button>
                              )
                            })}
                          </div>
                        </div>
                      )}
                    </div>
                  )
                })()}
              </div>

              {/* Coluna Direita: Treinador e Time Principal */}
              <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-6`}>
                {/* Seção do Treinador */}
                <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} rounded-lg p-4 mb-4`}>
                  <div className="flex items-center justify-between mb-3">
                    <div className="flex items-center gap-3">
                      <h4 className={`text-lg font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                        {currentUser?.username || 'Treinador'} <span className={`ml-2 text-sm font-normal ${darkMode ? 'text-green-400' : 'text-green-600'}`}>HP: {currentHP}/{getMaxHP()}</span>
                      </h4>
                      {/* Shiny Charm (se o treinador possuir) */}
                      {keyItems.find(item => item.name === 'Shiny Charm') && (
                        <div
                          className="w-12 h-12 cursor-pointer hover:scale-110 transition-transform"
                          onClick={() => handleShinyCharmRoll(keyItems.find(item => item.name === 'Shiny Charm')?.luckyNumber)}
                          title={`Shiny Charm - Clique para rolar 1d1365 (Nº da Sorte: ${keyItems.find(item => item.name === 'Shiny Charm')?.luckyNumber})`}
                        >
                          <img
                            src="/pokeballs/shinycharm.png"
                            alt="Shiny Charm"
                            className="w-full h-full object-contain"
                          />
                        </div>
                      )}
                    </div>
                    <button
                      onClick={() => {
                        setInterludioTrainerDamageAmount('')
                        setShowInterludioTrainerDamageModal(true)
                      }}
                      className="flex items-center gap-1 px-3 py-2 bg-gradient-to-r from-red-500 to-green-500 text-white rounded-lg hover:from-red-600 hover:to-green-600 font-semibold"
                      title="Dano/Cura Treinador"
                    >
                      <Sword size={16} /><Heart size={16} />
                    </button>
                  </div>

                  {/* Perícias do Treinador */}
                  <div>
                    <h5 className={`text-xs font-semibold mb-2 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                      Perícias:
                    </h5>
                    <div className="grid grid-cols-2 gap-1">
                      {Object.entries(skills).map(([attr, skillList]) => {
                        const attrNames = {
                          saude: 'Saúde',
                          ataque: 'Ataque',
                          defesa: 'Defesa',
                          ataqueEspecial: 'Ataque Especial',
                          defesaEspecial: 'Defesa Especial',
                          velocidade: 'Velocidade'
                        }

                        return skillList.map((skill, idx) => {
                          const count = skillList.filter(s => s === skill).length
                          const isFirst = skillList.indexOf(skill) === idx

                          if (!isFirst) return null

                          const modifier = getModifier(attributes[attr])

                          return (
                            <button
                              key={`${attr}-${skill}-${idx}`}
                              onClick={() => {
                                const d20Roll = Math.floor(Math.random() * 20) + 1
                                let baseBonus, modifierMultiplier
                                if (count === 1) {
                                  baseBonus = 2
                                  modifierMultiplier = 1
                                } else {
                                  baseBonus = 4
                                  modifierMultiplier = 2
                                }
                                const modifierBonus = modifierMultiplier * modifier
                                const total = d20Roll + baseBonus + modifierBonus
                                const timestamp = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
                                const message = `🎲 ${skill} (${attrNames[attr]})\n1d20 = ${d20Roll} | ${baseBonus} + ${modifierMultiplier > 1 ? `${modifierMultiplier}x` : ''}Modificador(${modifier}) = ${modifierBonus}\nTotal: ${total}`
                                addChatMessage({
                                  username: currentUser.username,
                                  text: message,
                                  timestamp,
                                  isDiceRoll: true,
                                  diceResult: message
                                })
                              }}
                              className={`text-xs p-2 rounded ${darkMode ? 'bg-gray-800 hover:bg-gray-600 text-white' : 'bg-white hover:bg-gray-200 text-gray-800 border'}`}
                            >
                              {skill} {count > 1 && `(x${count})`}
                            </button>
                          )
                        })
                      })}
                    </div>
                  </div>
                </div>

                {/* Time Principal */}
                <h4 className={`text-lg font-bold mb-3 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  Time Principal
                </h4>

                {mainTeam.length === 0 ? (
                  <p className={`text-center ${darkMode ? 'text-gray-400' : 'text-gray-600'} py-4`}>
                    Nenhum Pokémon no time
                  </p>
                ) : (
                  <div className="space-y-2">
                    {mainTeam.map((pkmn, idx) => (
                      <div
                        key={idx}
                        className={`flex items-center justify-between p-3 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}
                      >
                        <div>
                          <span className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                            {pkmn.nickname || pkmn.species}
                          </span>
                          <span className={`ml-2 text-xs ${darkMode ? 'text-green-400' : 'text-green-600'}`}>
                            HP: {pkmn.currentHP !== undefined ? pkmn.currentHP : calculateMaxHP(pkmn)}/{calculateMaxHP(pkmn)}
                          </span>
                          <span className={`ml-2 text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                            Nv. {pkmn.level}
                          </span>
                        </div>
                        <button
                          onClick={() => {
                            setSelectedInterludioPokemon(pkmn)
                            setInterludioPokemonDamageAmount('')
                            setShowInterludioPokemonDamageModal(true)
                          }}
                          className="flex items-center gap-0.5 px-2 py-1 bg-gradient-to-r from-red-500 to-green-500 text-white rounded hover:from-red-600 hover:to-green-600 text-xs"
                          title="Dano/Cura"
                        >
                          <Sword size={12} /><Heart size={12} />
                        </button>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            </div>

            {/* MENUS DE INTERLÚDIO */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-2 sm:gap-3 md:gap-4 mb-8">
              {/* Menu Int. Talentos */}
              <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-4`}>
                <div
                  className="flex justify-between items-center cursor-pointer"
                  onClick={() => setShowIntTalentosMenu(!showIntTalentosMenu)}
                >
                  <h3 className={`text-lg font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                    Int. Talentos
                  </h3>
                  <div className="flex items-center gap-2">
                    {showIntTalentosMenu ? <ChevronUp size={20} className={darkMode ? 'text-gray-400' : 'text-gray-600'} /> : <ChevronDown size={20} className={darkMode ? 'text-gray-400' : 'text-gray-600'} />}
                  </div>
                </div>

                {showIntTalentosMenu && (
                  <div className={`${darkMode ? 'bg-gray-900' : 'bg-gray-50'} rounded-lg p-3 mt-3`}>
                    {talentinhos.length === 0 ? (
                      <p className={`text-center text-sm ${darkMode ? 'text-gray-500' : 'text-gray-400'} py-4`}>
                        Nenhum talento em jogo
                      </p>
                    ) : (
                      <div className="space-y-2">
                        {talentinhos.map((talentinho, idx) => (
                          <div
                            key={idx}
                            className={`p-3 rounded-lg ${darkMode ? 'bg-gray-800' : 'bg-white'} border ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}
                          >
                            <div className="flex items-start justify-between gap-2 mb-1">
                              <button
                                onClick={() => {
                                  setSelectedTalentinhoDetail(talentinho)
                                  setShowTalentinhoDetailModal(true)
                                }}
                                className={`flex-1 text-left font-semibold text-sm ${darkMode ? 'text-purple-400 hover:text-purple-300' : 'text-purple-600 hover:text-purple-700'} transition-colors`}
                              >
                                {talentinho.nome}
                              </button>
                              <div className="flex gap-1">
                                <button
                                  onClick={() => handleRollTalentinho(talentinho)}
                                  className={`p-1 rounded ${darkMode ? 'bg-green-700 hover:bg-green-600' : 'bg-green-500 hover:bg-green-600'} text-white`}
                                  title="Enviar no Chat"
                                >
                                  <Send size={12} />
                                </button>
                                <button
                                  onClick={() => handleEditTalentinho(idx)}
                                  className={`p-1 rounded ${darkMode ? 'bg-blue-700 hover:bg-blue-600' : 'bg-blue-500 hover:bg-blue-600'} text-white`}
                                  title="Editar"
                                >
                                  <Edit size={12} />
                                </button>
                                <button
                                  onClick={() => handleDeleteTalentinho(idx)}
                                  className={`p-1 rounded ${darkMode ? 'bg-red-700 hover:bg-red-600' : 'bg-red-500 hover:bg-red-600'} text-white`}
                                  title="Excluir"
                                >
                                  <Trash2 size={12} />
                                </button>
                              </div>
                            </div>
                            <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'} font-mono`}>
                              {talentinho.expressao}
                            </p>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                )}
              </div>

              {/* Menu Int. L.U. */}
              <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-4`}>
                <div
                  className="flex justify-between items-center cursor-pointer"
                  onClick={() => setShowIntLUMenu(!showIntLUMenu)}
                >
                  <h3 className={`text-lg font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                    Int. L.U.
                  </h3>
                  <div className="flex items-center gap-2">
                    {showIntLUMenu && (
                      <button
                        onClick={(e) => {
                          e.stopPropagation()
                          resetarTodosOsUsos()
                        }}
                        className={`flex items-center gap-1 px-2 py-1 rounded-lg text-xs font-medium transition-all ${darkMode ? 'bg-green-700 hover:bg-green-600' : 'bg-green-500 hover:bg-green-600'} text-white`}
                        title="Resetar todos os usos"
                      >
                        <RotateCcw size={14} />
                        Resetar
                      </button>
                    )}
                    {showIntLUMenu ? <ChevronUp size={20} className={darkMode ? 'text-gray-400' : 'text-gray-600'} /> : <ChevronDown size={20} className={darkMode ? 'text-gray-400' : 'text-gray-600'} />}
                  </div>
                </div>

                {showIntLUMenu && (
                  <div className={`${darkMode ? 'bg-gray-900' : 'bg-gray-50'} rounded-lg p-3 mt-3`}>
                    {getItensComLimiteDeUso().length === 0 ? (
                      <p className={`text-center text-sm ${darkMode ? 'text-gray-500' : 'text-gray-400'} py-4`}>
                        Nenhum limite de uso
                      </p>
                    ) : (
                      <div className="grid grid-cols-1 gap-2">
                        {getItensComLimiteDeUso().map((item, idx) => (
                          <div
                            key={`${item.tipo}-${item.index}`}
                            className={`p-3 rounded-lg ${darkMode ? 'bg-gray-800' : 'bg-white'} border ${
                              item.atual === 0
                                ? darkMode ? 'border-red-600' : 'border-red-400'
                                : darkMode ? 'border-gray-700' : 'border-gray-200'
                            }`}
                          >
                            <div className="flex flex-col gap-2 relative">
                              {item.isPersonalizado && (
                                <button
                                  onClick={() => removerLimiteUsoPersonalizado(item.index)}
                                  className="absolute -top-1 -right-1 p-0.5 rounded-full bg-red-500 hover:bg-red-600 text-white shadow-lg"
                                  title="Remover limite"
                                >
                                  <X size={10} />
                                </button>
                              )}
                              <div className="flex items-center justify-between">
                                <span className={`font-semibold text-sm ${
                                  item.tipo === 'modificador'
                                    ? darkMode ? 'text-blue-400' : 'text-blue-600'
                                    : item.tipo === 'talentinho'
                                      ? darkMode ? 'text-purple-400' : 'text-purple-600'
                                      : item.isPersonalizado
                                        ? darkMode ? 'text-cyan-400' : 'text-cyan-600'
                                        : darkMode ? 'text-yellow-400' : 'text-yellow-600'
                                }`}>
                                  {item.nome}
                                </span>
                                <span className={`text-xs px-1.5 py-0.5 rounded-full ${
                                  item.tipo === 'modificador'
                                    ? darkMode ? 'bg-blue-900 text-blue-300' : 'bg-blue-100 text-blue-700'
                                    : item.tipo === 'talentinho'
                                      ? darkMode ? 'bg-purple-900 text-purple-300' : 'bg-purple-100 text-purple-700'
                                      : item.isPersonalizado
                                        ? darkMode ? 'bg-cyan-900 text-cyan-300' : 'bg-cyan-100 text-cyan-700'
                                        : darkMode ? 'bg-yellow-900 text-yellow-300' : 'bg-yellow-100 text-yellow-700'
                                }`}>
                                  {item.tipo === 'modificador' ? 'Mod' : item.tipo === 'talentinho' && !item.isPersonalizado ? 'Talento' : item.isPersonalizado ? (item.fontes?.talento ? 'Talento' : item.fontes?.item ? 'Item' : 'Outros') : 'Item'}
                                </span>
                              </div>

                              <div className="flex items-center justify-center gap-2">
                                <button
                                  onClick={item.decrementar}
                                  disabled={item.atual === 0}
                                  className={`p-1.5 rounded-lg transition-colors ${
                                    item.atual === 0
                                      ? darkMode ? 'bg-gray-700 text-gray-500 cursor-not-allowed' : 'bg-gray-200 text-gray-400 cursor-not-allowed'
                                      : darkMode ? 'bg-red-700 hover:bg-red-600 text-white' : 'bg-red-500 hover:bg-red-600 text-white'
                                  }`}
                                  title="Usar"
                                >
                                  <Minus size={14} />
                                </button>

                                <span className={`text-lg sm:text-xl font-bold ${
                                  item.atual === 0
                                    ? darkMode ? 'text-red-400' : 'text-red-600'
                                    : darkMode ? 'text-white' : 'text-gray-800'
                                }`}>
                                  {item.atual}/{item.total}
                                </span>

                                <button
                                  onClick={item.resetar}
                                  className={`p-1.5 rounded-lg transition-colors ${darkMode ? 'bg-green-700 hover:bg-green-600' : 'bg-green-500 hover:bg-green-600'} text-white`}
                                  title="Resetar"
                                >
                                  <RotateCcw size={14} />
                                </button>
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                )}
              </div>

              {/* Menu Pokébola, Vai! */}
              <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-4`}>
                <div
                  className="flex justify-between items-center cursor-pointer"
                  onClick={() => setShowPokebolVaiMenu(!showPokebolVaiMenu)}
                >
                  <h3 className={`text-lg font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                    Pokébola, Vai!
                  </h3>
                  {showPokebolVaiMenu ? <ChevronUp size={20} className={darkMode ? 'text-gray-400' : 'text-gray-600'} /> : <ChevronDown size={20} className={darkMode ? 'text-gray-400' : 'text-gray-600'} />}
                </div>

                {showPokebolVaiMenu && (
                  <div className={`${darkMode ? 'bg-gray-900' : 'bg-gray-50'} rounded-lg p-3 mt-3`}>
                  {keyItems.filter(item => POKEBALL_MODIFIERS[item.name]).length === 0 ? (
                    <p className={`text-center text-sm ${darkMode ? 'text-gray-500' : 'text-gray-400'} py-4`}>
                      Nenhuma pokébola disponível
                    </p>
                  ) : (
                    <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2">
                      {/* Customball sempre aparece primeiro */}
                      <button
                        onClick={() => handleOpenCaptureModal('Customball')}
                        className={`relative flex flex-col items-center p-2 rounded-lg transition-all ${darkMode ? 'bg-gray-800 hover:bg-gray-700' : 'bg-white hover:bg-gray-100'} border-2 border-dashed ${darkMode ? 'border-gray-600' : 'border-gray-300'}`}
                        title="Customball"
                      >
                        <img
                          src="/pokeballs/custompokeball.png"
                          alt="Customball"
                          className="w-10 h-10 object-contain"
                          onError={(e) => {
                            e.target.style.display = 'none'
                            e.target.nextSibling.style.display = 'flex'
                          }}
                        />
                        <div className="w-10 h-10 hidden items-center justify-center text-lg sm:text-xl">
                          ?
                        </div>
                        <span className={`text-[9px] font-semibold text-center mt-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                          Customball
                        </span>
                      </button>

                      {/* Pokébolas dos keyItems */}
                      {keyItems
                        .filter(item => POKEBALL_MODIFIERS[item.name] && item.name !== 'Customball')
                        .map((item, idx) => (
                          <button
                            key={idx}
                            onClick={() => handleOpenCaptureModal(item.name)}
                            className={`relative flex flex-col items-center p-2 rounded-lg transition-all ${darkMode ? 'bg-gray-800 hover:bg-gray-700' : 'bg-white hover:bg-gray-100'} ${item.quantity > 0 ? '' : 'opacity-50 cursor-not-allowed'}`}
                            disabled={item.quantity === 0}
                            title={item.name}
                          >
                            <img
                              src={`/pokeballs/${item.name.toLowerCase().replace(' ', '')}.png`}
                              alt={item.name}
                              className="w-10 h-10 object-contain"
                              onError={(e) => {
                                e.target.style.display = 'none'
                                e.target.nextSibling.style.display = 'flex'
                              }}
                            />
                            <div className="w-10 h-10 hidden items-center justify-center text-lg sm:text-xl">
                              O
                            </div>
                            <span className={`text-[9px] font-semibold text-center mt-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                              {item.name}
                            </span>
                            <div className={`absolute -top-1 -right-1 w-4 h-4 rounded-full flex items-center justify-center text-[9px] font-bold ${item.quantity > 0 ? (darkMode ? 'bg-blue-600 text-white' : 'bg-blue-500 text-white') : (darkMode ? 'bg-gray-600 text-gray-400' : 'bg-gray-400 text-gray-600')}`}>
                              {item.quantity}
                            </div>
                          </button>
                        ))}
                    </div>
                  )}
                  </div>
                )}
              </div>

              {/* Menu Cura no Interlúdio */}
              <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-4`}>
                <div
                  className="flex justify-between items-center cursor-pointer"
                  onClick={() => setShowCuraInterludioMenu(!showCuraInterludioMenu)}
                >
                  <h3 className={`text-lg font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                    Cura no Interlúdio
                  </h3>
                  {showCuraInterludioMenu ? <ChevronUp size={20} className={darkMode ? 'text-gray-400' : 'text-gray-600'} /> : <ChevronDown size={20} className={darkMode ? 'text-gray-400' : 'text-gray-600'} />}
                </div>

                {showCuraInterludioMenu && (
                  <div className={`${darkMode ? 'bg-gray-900' : 'bg-gray-50'} rounded-lg p-3 mt-3`}>
                    {(() => {
                      // Filtrar itens de cura que o usuário possui e que têm expressão de dados
                      const healingItems = keyItems.filter(item => {
                        // Verificar se o item está no corredor de Cura
                        const curaItem = POKELOJA_DATA['Cura']?.find(i => i.name === item.name)
                        if (!curaItem) return false
                        // Verificar se tem expressão de dados na descrição
                        const hasDiceExpression = /\d+d\d+/i.test(curaItem.description)
                        return hasDiceExpression && item.quantity > 0
                      })

                      if (healingItems.length === 0) {
                        return (
                          <p className={`text-center text-sm ${darkMode ? 'text-gray-500' : 'text-gray-400'} py-4`}>
                            Nenhum item de cura com dados disponível
                          </p>
                        )
                      }

                      return (
                        <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2">
                          {healingItems.map((item, idx) => {
                            const curaItem = POKELOJA_DATA['Cura']?.find(i => i.name === item.name)
                            return (
                              <button
                                key={idx}
                                onClick={() => {
                                  setSelectedHealingItem({ ...item, ...curaItem })
                                  setShowHealingModal(true)
                                }}
                                className={`relative flex flex-col items-center p-2 rounded-lg transition-all ${darkMode ? 'bg-gray-800 hover:bg-gray-700' : 'bg-white hover:bg-gray-100'}`}
                                title={item.name}
                              >
                                <img
                                  src={curaItem?.image || `/pokeballs/${item.name.toLowerCase().replace(/ /g, '')}.png`}
                                  alt={item.name}
                                  className="w-10 h-10 object-contain"
                                  onError={(e) => {
                                    e.target.style.display = 'none'
                                    e.target.nextSibling.style.display = 'flex'
                                  }}
                                />
                                <div className="w-10 h-10 hidden items-center justify-center text-lg sm:text-xl">
                                  +
                                </div>
                                <span className={`text-[9px] font-semibold text-center mt-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                  {item.name}
                                </span>
                                <div className={`absolute -top-1 -right-1 w-4 h-4 rounded-full flex items-center justify-center text-[9px] font-bold ${darkMode ? 'bg-green-600 text-white' : 'bg-green-500 text-white'}`}>
                                  {item.quantity}
                                </div>
                              </button>
                            )
                          })}
                        </div>
                      )
                    })()}
                  </div>
                )}
              </div>
            </div>

            {/* PARTE 2: Apps de Interlúdio */}
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-8 mb-8`}>
              <h3 className={`text-xl sm:text-2xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                Apps de Interlúdio
              </h3>

              {/* Botões para selecionar o app */}
              <div className="flex gap-2 sm:gap-3 md:gap-4 mb-6 justify-center">
                <button
                  onClick={() => setInterludioApp(interludioApp === 'combate' ? null : 'combate')}
                  className={`px-3 sm:px-5 md:px-6 py-3 rounded-lg font-bold text-lg transition-all ${
                    interludioApp === 'combate'
                      ? 'bg-red-600 text-white shadow-lg scale-105'
                      : darkMode
                        ? 'bg-gray-700 text-gray-300 hover:bg-red-600 hover:text-white'
                        : 'bg-gray-200 text-gray-700 hover:bg-red-500 hover:text-white'
                  }`}
                >
                  Combate
                </button>
                <button
                  onClick={() => setInterludioApp(interludioApp === 'concurso' ? null : 'concurso')}
                  className={`px-3 sm:px-5 md:px-6 py-3 rounded-lg font-bold text-lg transition-all ${
                    interludioApp === 'concurso'
                      ? 'bg-purple-600 text-white shadow-lg scale-105'
                      : darkMode
                        ? 'bg-gray-700 text-gray-300 hover:bg-purple-600 hover:text-white'
                        : 'bg-gray-200 text-gray-700 hover:bg-purple-500 hover:text-white'
                  }`}
                >
                  Concurso
                </button>
              </div>

              {/* App de Combate */}
              {interludioApp === 'combate' && (
                <div className={`${darkMode ? 'bg-gray-900' : 'bg-gray-50'} rounded-xl p-3 sm:p-5 md:p-6`}>
                  <CombateInterludioApp darkMode={darkMode} />
                </div>
              )}

              {/* App de Concurso */}
              {interludioApp === 'concurso' && (
                <div className={`${darkMode ? 'bg-gray-900' : 'bg-gray-50'} rounded-xl p-3 sm:p-5 md:p-6`}>
                  <ConcursoInterludioApp darkMode={darkMode} />
                </div>
              )}

              {/* Mensagem quando nenhum app está selecionado */}
              {!interludioApp && (
                <p className={`text-lg ${darkMode ? 'text-gray-400' : 'text-gray-600'} text-center py-4`}>
                  Selecione um app acima para começar
                </p>
              )}
            </div>

            {/* PARTE 3: Chat com Sistema de Dados */}
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-8`}>
              <h3 className={`text-xl sm:text-2xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                Chat & Rolagem de Dados
              </h3>

              {/* Menu de Rolagem Rápida */}
              <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} rounded-lg p-3 sm:p-4 mb-4`}>
                <h4 className={`text-sm font-bold mb-3 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                  Rolagem Rápida
                </h4>
                <div className="flex flex-col sm:flex-row sm:flex-wrap sm:items-center gap-3">
                  {/* Primeira Parte: Número de dados */}
                  <div className="flex flex-col xs:flex-row xs:items-center gap-2">
                    <span className={`text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'} whitespace-nowrap`}>Quantidade:</span>
                    <div className="flex flex-wrap gap-1">
                      {[1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(num => (
                        <button
                          key={num}
                          onClick={() => setQuickRollNumDice(num)}
                          className={`w-7 h-7 sm:w-8 sm:h-8 rounded text-xs sm:text-sm font-bold transition-colors ${
                            quickRollNumDice === num
                              ? 'bg-blue-600 text-white'
                              : darkMode
                              ? 'bg-gray-600 text-gray-300 hover:bg-gray-500'
                              : 'bg-white text-gray-700 hover:bg-gray-200'
                          }`}
                        >
                          {num}
                        </button>
                      ))}
                    </div>
                  </div>

                  {/* Segunda Parte: Tipo de dado */}
                  <div className="flex flex-col xs:flex-row xs:items-center gap-2">
                    <span className={`text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'} whitespace-nowrap`}>Dado:</span>
                    <div className="flex flex-wrap gap-1">
                      {['d4', 'd6', 'd8', 'd10', 'd12', 'd20'].map(dice => (
                        <button
                          key={dice}
                          onClick={() => setQuickRollDiceType(dice)}
                          className={`px-2.5 h-7 sm:px-3 sm:h-8 rounded text-xs sm:text-sm font-bold transition-colors ${
                            quickRollDiceType === dice
                              ? 'bg-green-600 text-white'
                              : darkMode
                              ? 'bg-gray-600 text-gray-300 hover:bg-gray-500'
                              : 'bg-white text-gray-700 hover:bg-gray-200'
                          }`}
                        >
                          {dice}
                        </button>
                      ))}
                    </div>
                  </div>

                  {/* Botão Rolar */}
                  <button
                    onClick={() => {
                      const diceNotation = `${quickRollNumDice}${quickRollDiceType}`
                      const result = rollDiceExpression(diceNotation)
                      if (result.error) {
                        alert(result.error)
                        return
                      }
                      const newMessage = {
                        username: currentUser?.username || 'Anônimo',
                        text: `🎲 Rolagem Rápida: ${diceNotation}`,
                        timestamp: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
                        isDiceRoll: true,
                        diceResult: result.total,
                        diceDetails: result.formula
                      }
                      setChatMessages(prev => [...prev, newMessage])
                      if (useFirebase) {
                        (async () => {
                          const currentMessages = await loadChatMessages()
                          await saveChatMessages([...(currentMessages || []), newMessage])
                        })().catch(err => console.error('Erro ao salvar mensagem:', err))
                      }
                    }}
                    className="px-3 sm:px-5 md:px-6 h-7 sm:h-8 bg-purple-600 text-white rounded font-bold hover:bg-purple-700 transition-colors text-xs sm:text-sm"
                  >
                    🎲 Rolar
                  </button>
                </div>
              </div>

              <p className={`text-sm mb-4 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                Use /r ou /roll para rolar dados. Exemplo: /r 1d20+5, /roll 2d6
              </p>

              {/* Área de Mensagens */}
              <div ref={chatContainerRef} className={`${darkMode ? 'bg-gray-900' : 'bg-gray-50'} rounded-lg p-4 h-96 overflow-y-auto mb-4`}>
                {chatMessages.length === 0 ? (
                  <p className={`text-center ${darkMode ? 'text-gray-500' : 'text-gray-400'} py-3 sm:py-5 md:py-8`}>
                    Nenhuma mensagem ainda. Seja o primeiro a falar!
                  </p>
                ) : (
                  <div className="space-y-3">
                    {chatMessages.map((msg, idx) => (
                      <div key={idx} className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg p-3`}>
                        <div className="flex justify-between items-start mb-1">
                          <span className={`font-bold text-sm ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>
                            {msg.username}
                          </span>
                          <span className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                            {msg.timestamp}
                          </span>
                        </div>
                        {msg.isDiceRoll ? (
                          <div>
                            <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                              {msg.text}
                            </p>
                            <div className={`mt-2 p-2 rounded ${darkMode ? 'bg-green-900' : 'bg-green-100'}`}>
                              <p className={`font-bold text-lg ${darkMode ? 'text-green-400' : 'text-green-700'}`}>
                                Resultado: {msg.diceResult}
                              </p>
                              <p className={`text-xs ${darkMode ? 'text-green-300' : 'text-green-600'}`}>
                                {msg.diceDetails}
                              </p>
                            </div>
                          </div>
                        ) : msg.isAction ? (
                          <p className={`text-sm font-semibold text-yellow-500`}>
                            {msg.text}
                          </p>
                        ) : (
                          <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                            {msg.text}
                          </p>
                        )}
                      </div>
                    ))}
                  </div>
                )}
              </div>

              {/* Input de Mensagem */}
              <div className="flex gap-2">
                <input
                  type="text"
                  value={chatInput}
                  onChange={(e) => setChatInput(e.target.value)}
                  onKeyPress={(e) => {
                    if (e.key === 'Enter') {
                      handleSendMessage()
                    }
                  }}
                  placeholder="Digite sua mensagem, 1d20+@MAE, ou /r 1d20..."
                  className={`flex-1 px-3 py-2 sm:px-4 sm:py-3 rounded-lg border-2 text-sm sm:text-base ${
                    darkMode
                      ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-500'
                      : 'bg-white border-gray-300 text-gray-800 placeholder-gray-400'
                  } focus:outline-none focus:border-blue-500`}
                />
                <button
                  onClick={handleSendMessage}
                  className="px-3 sm:px-5 md:px-6 py-2 sm:py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold text-sm sm:text-base"
                >
                  Enviar
                </button>
              </div>
            </div>
          </div>
        </div>

        {/* Modal de Captura - Interlúdio */}
        {showCaptureModal && selectedPokeball && (
          <div
            className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
            onClick={() => setShowCaptureModal(false)}
          >
            <div
              className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg p-3 sm:p-5 md:p-6 max-w-md w-full`}
              onClick={(e) => e.stopPropagation()}
            >
              <div className="flex justify-between items-center mb-4">
                <h3 className={`text-lg sm:text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  {selectedPokeball}
                </h3>
                <button
                  onClick={() => setShowCaptureModal(false)}
                  className={`${darkMode ? 'text-gray-400 hover:text-white' : 'text-gray-600 hover:text-gray-800'}`}
                >
                  <X size={24} />
                </button>
              </div>

              {(() => {
                const pokeballData = POKELOJA_DATA['Captura']?.find(item => item.name === selectedPokeball)
                if (pokeballData?.description) {
                  return (
                    <div className={`mb-4 p-3 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                      <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                        <span className="font-semibold">Descrição:</span> {pokeballData.description}
                      </p>
                    </div>
                  )
                }
                return null
              })()}

              <div className="space-y-4">
                {selectedPokeball === 'Customball' ? (
                  <div>
                    <label className={`block text-sm font-semibold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      Modificador de Captura
                    </label>
                    <input
                      type="text"
                      value={customPokeballModifier}
                      onChange={(e) => setCustomPokeballModifier(e.target.value)}
                      className={`w-full px-3 py-2 sm:px-4 rounded-lg border-2 text-sm sm:text-base ${
                        darkMode
                          ? 'bg-gray-700 border-gray-600 text-white'
                          : 'bg-white border-gray-300 text-gray-800'
                      } focus:outline-none focus:border-blue-500`}
                      placeholder="Ex: +15, -5, @MA, 1d6+@MAE"
                    />
                    <p className={`text-xs mt-1 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                      Suporta comandos @ e expressões
                    </p>
                  </div>
                ) : POKEBALL_MODIFIERS[selectedPokeball]?.length > 1 ? (
                  <div>
                    <label className={`block text-sm font-semibold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      Modificador de Captura
                    </label>
                    <select
                      value={selectedPokeballModifier}
                      onChange={(e) => setSelectedPokeballModifier(e.target.value)}
                      className={`w-full px-3 py-2 sm:px-4 rounded-lg border-2 text-sm sm:text-base ${
                        darkMode
                          ? 'bg-gray-700 border-gray-600 text-white'
                          : 'bg-white border-gray-300 text-gray-800'
                      } focus:outline-none focus:border-blue-500`}
                    >
                      {POKEBALL_MODIFIERS[selectedPokeball].map((mod, idx) => (
                        <option key={idx} value={mod}>
                          {mod === 'auto' ? 'Captura Automática' : mod}
                        </option>
                      ))}
                    </select>
                  </div>
                ) : (
                  <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                    <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      Modificador: <span className="font-bold">{POKEBALL_MODIFIERS[selectedPokeball]?.[0]}</span>
                    </p>
                  </div>
                )}

                <button
                  onClick={handleThrowPokeball}
                  className="w-full bg-blue-600 text-white px-3 sm:px-5 md:px-6 py-3 rounded-lg hover:bg-blue-700 font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
                  disabled={selectedPokeball === 'Customball' && !customPokeballModifier}
                >
                  Pokébolaaa, vaaai!
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Modal de Cura em Interlúdio */}
        {showHealingModal && selectedHealingItem && (
          <div
            className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
            onClick={() => setShowHealingModal(false)}
          >
            <div
              className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg p-3 sm:p-5 md:p-6 max-w-md w-full`}
              onClick={(e) => e.stopPropagation()}
            >
              <div className="flex justify-between items-center mb-4">
                <h3 className={`text-lg sm:text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  {selectedHealingItem.name}
                </h3>
                <button
                  onClick={() => setShowHealingModal(false)}
                  className={`${darkMode ? 'text-gray-400 hover:text-white' : 'text-gray-600 hover:text-gray-800'}`}
                >
                  <X size={24} />
                </button>
              </div>

              <div className="space-y-4">
                <div className="flex items-center gap-2 sm:gap-3 md:gap-4">
                  <img
                    src={selectedHealingItem.image}
                    alt={selectedHealingItem.name}
                    className="w-16 h-16 object-contain"
                    onError={(e) => { e.target.src = '/pokeballs/pokeball.png' }}
                  />
                  <div>
                    <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      {selectedHealingItem.description}
                    </p>
                    <p className={`text-xs mt-1 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                      Quantidade: {selectedHealingItem.quantity}
                    </p>
                  </div>
                </div>

                {(() => {
                  // Extrair expressão de dados da descrição
                  const diceMatch = selectedHealingItem.description.match(/(\d+d\d+(\+\d+)?)/i)
                  const diceExpression = diceMatch ? diceMatch[1] : null

                  if (!diceExpression) return null

                  return (
                    <div className={`p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                      <p className={`text-center text-lg font-bold ${darkMode ? 'text-green-400' : 'text-green-600'}`}>
                        Expressão: {diceExpression}
                      </p>
                    </div>
                  )
                })()}

                <button
                  onClick={() => {
                    // Extrair expressão de dados da descrição
                    const diceMatch = selectedHealingItem.description.match(/(\d+d\d+(\+\d+)?)/i)
                    const diceExpression = diceMatch ? diceMatch[1] : null

                    if (diceExpression) {
                      const timestamp = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
                      const result = rollDiceExpression(diceExpression)

                      if (!result.error) {
                        addChatMessage({
                          username: currentUser.username,
                          text: `💊 Usou ${selectedHealingItem.name} (${diceExpression})`,
                          timestamp,
                          isDiceRoll: true,
                          diceResult: result.total,
                          diceDetails: result.formula
                        })

                        // Descontar item da mochila
                        const newQuantity = selectedHealingItem.quantity - 1
                        if (newQuantity <= 0) {
                          // Remover item se quantidade chegar a 0
                          setKeyItems(keyItems.filter(i => i.name !== selectedHealingItem.name))
                        } else {
                          // Decrementar quantidade
                          setKeyItems(keyItems.map(i =>
                            i.name === selectedHealingItem.name
                              ? { ...i, quantity: newQuantity }
                              : i
                          ))
                        }
                      }
                    }

                    setShowHealingModal(false)
                  }}
                  className="w-full bg-green-600 text-white px-3 sm:px-5 md:px-6 py-3 rounded-lg hover:bg-green-700 font-semibold"
                >
                  Curar?
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Modal de Detalhes do Talentinho - Interlúdio */}
        {showTalentinhoDetailModal && selectedTalentinhoDetail && (
          <div
            className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
            onClick={() => setShowTalentinhoDetailModal(false)}
          >
            <div
              className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-md w-full p-3 sm:p-5 md:p-6`}
              onClick={(e) => e.stopPropagation()}
            >
              <div className="flex justify-between items-center mb-6">
                <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  {selectedTalentinhoDetail.nome}
                </h3>
                <button
                  onClick={() => setShowTalentinhoDetailModal(false)}
                  className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}
                >
                  <X size={24} />
                </button>
              </div>

              <div className="space-y-4">
                <div>
                  <label className={`block text-sm font-semibold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Expressão
                  </label>
                  <div className={`px-4 py-3 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                    <code className={`text-sm font-mono ${darkMode ? 'text-purple-300' : 'text-purple-700'}`}>
                      {selectedTalentinhoDetail.expressao}
                    </code>
                  </div>
                </div>

                {selectedTalentinhoDetail.alvos && selectedTalentinhoDetail.alvos.length > 0 && (
                  <div>
                    <label className={`block text-sm font-semibold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      Alvos
                    </label>
                    <div className="space-y-2">
                      {selectedTalentinhoDetail.alvos.map((alvo, idx) => {
                        // Compatibilidade com formato antigo (string) e novo ({operador, valor})
                        const alvoObj = typeof alvo === 'object' ? alvo : { operador: '>=', valor: alvo }
                        const operadorTexto = {
                          '>=': 'maior ou igual a',
                          '<=': 'menor ou igual a',
                          '>': 'maior que',
                          '<': 'menor que',
                          '==': 'igual a'
                        }[alvoObj.operador] || 'maior ou igual a'
                        return (
                          <div key={idx} className={`px-4 py-2 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                            <span className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Alvo {idx + 1}:</span>
                            <code className={`text-sm font-mono block ${darkMode ? 'text-green-300' : 'text-green-700'}`}>
                              {operadorTexto} {alvoObj.valor}
                            </code>
                          </div>
                        )
                      })}
                    </div>
                  </div>
                )}

                <button
                  onClick={() => {
                    handleRollTalentinho(selectedTalentinhoDetail)
                    setShowTalentinhoDetailModal(false)
                  }}
                  className="w-full bg-green-600 text-white px-3 sm:px-5 md:px-6 py-3 rounded-lg hover:bg-green-700 font-semibold flex items-center justify-center gap-2"
                >
                  <Send size={20} />
                  Enviar no Chat
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Modal de Dano/Cura Pokémon Interlúdio */}
        {showInterludioPokemonDamageModal && selectedInterludioPokemon && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => { setShowInterludioPokemonDamageModal(false); cancelDamageTypeSelection(); }}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-3 sm:p-5 md:p-8 rounded-2xl shadow-2xl max-w-md w-full`} onClick={(e) => e.stopPropagation()}>
              <div className="flex justify-between items-center mb-4">
                <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  Dano/Cura - {selectedInterludioPokemon.nickname || selectedInterludioPokemon.species}
                </h3>
                <button onClick={() => { setShowInterludioPokemonDamageModal(false); cancelDamageTypeSelection(); }} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                  <X size={24} />
                </button>
              </div>
              <input
                type="number"
                min="1"
                max="1000"
                value={interludioPokemonDamageAmount}
                onChange={e => setInterludioPokemonDamageAmount(e.target.value)}
                placeholder="Valor (1-1000)"
                className={`w-full px-3 py-2 sm:px-4 sm:py-3 border-2 rounded-lg text-sm sm:text-base mb-4 text-center text-lg sm:text-xl ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300'}`}
                disabled={showDamageTypeButtons && pendingDamageContext === 'interludioPokemon'}
              />
              {!showDamageTypeButtons || pendingDamageContext !== 'interludioPokemon' ? (
                <div className="grid grid-cols-2 gap-2 sm:gap-3 md:gap-4">
                  <button
                    onClick={() => {
                      const v = parseInt(interludioPokemonDamageAmount) || 0;
                      const idx = mainTeam.findIndex(p => p === selectedInterludioPokemon);
                      if (idx !== -1) {
                        const updatedTeam = [...mainTeam];
                        const maxHP = calculateMaxHP(updatedTeam[idx]);
                        const currentHp = updatedTeam[idx].currentHP !== undefined ? updatedTeam[idx].currentHP : maxHP;
                        const newHP = Math.min(currentHp + v, maxHP);
                        updatedTeam[idx] = { ...updatedTeam[idx], currentHP: newHP };
                        setMainTeam(updatedTeam);
                      }
                      setInterludioPokemonDamageAmount('');
                      setShowInterludioPokemonDamageModal(false);
                    }}
                    className="bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 font-semibold flex items-center justify-center gap-2"
                  >
                    <Heart size={20} />Curar
                  </button>
                  <button
                    onClick={() => {
                      const v = parseInt(interludioPokemonDamageAmount) || 0;
                      if (v > 0) {
                        setPendingDamageValue(v);
                        setPendingDamageContext('interludioPokemon');
                        setShowDamageTypeButtons(true);
                      }
                    }}
                    className="bg-red-500 text-white py-3 rounded-lg hover:bg-red-600 font-semibold flex items-center justify-center gap-2"
                  >
                    <Sword size={20} />Dano
                  </button>
                </div>
              ) : (
                <div className="space-y-3">
                  <p className={`text-center text-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                    Dano: {pendingDamageValue} | Selecione o tipo de dano:
                  </p>
                  <div className="grid grid-cols-3 gap-3">
                    <button
                      onClick={() => {
                        // Aplicar dano físico
                        const idx = mainTeam.findIndex(p => p === selectedInterludioPokemon);
                        if (idx !== -1) {
                          const pokemon = mainTeam[idx];
                          const pokemonData = pokedexData.find(p => p.nome === pokemon.species);
                          const defense = pokemon.baseAttributes?.defesa || pokemonData?.statusBasais?.defesa || 0;
                          const finalDamage = Math.max(0, pendingDamageValue - defense);
                          const maxHP = calculateMaxHP(pokemon);
                          const currentHp = pokemon.currentHP !== undefined ? pokemon.currentHP : maxHP;
                          const newHP = Math.max(0, currentHp - finalDamage);
                          const updatedTeam = [...mainTeam];
                          updatedTeam[idx] = { ...pokemon, currentHP: newHP };
                          setMainTeam(updatedTeam);
                        }
                        cancelDamageTypeSelection();
                        setInterludioPokemonDamageAmount('');
                        setShowInterludioPokemonDamageModal(false);
                      }}
                      className="bg-orange-500 text-white py-3 rounded-lg hover:bg-orange-600 font-semibold flex items-center justify-center gap-2"
                    >
                      <Sword size={20} />Físico
                    </button>
                    <button
                      onClick={() => {
                        // Aplicar dano puro (sem defesa)
                        const idx = mainTeam.findIndex(p => p === selectedInterludioPokemon);
                        if (idx !== -1) {
                          const pokemon = mainTeam[idx];
                          const maxHP = calculateMaxHP(pokemon);
                          const currentHp = pokemon.currentHP !== undefined ? pokemon.currentHP : maxHP;
                          const newHP = Math.max(0, currentHp - pendingDamageValue);
                          const updatedTeam = [...mainTeam];
                          updatedTeam[idx] = { ...pokemon, currentHP: newHP };
                          setMainTeam(updatedTeam);
                        }
                        cancelDamageTypeSelection();
                        setInterludioPokemonDamageAmount('');
                        setShowInterludioPokemonDamageModal(false);
                      }}
                      className="bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600 font-semibold flex items-center justify-center gap-2"
                    >
                      <Minus size={20} />Puro
                    </button>
                    <button
                      onClick={() => {
                        // Aplicar dano especial
                        const idx = mainTeam.findIndex(p => p === selectedInterludioPokemon);
                        if (idx !== -1) {
                          const pokemon = mainTeam[idx];
                          const pokemonData = pokedexData.find(p => p.nome === pokemon.species);
                          const defense = pokemon.baseAttributes?.defesaEspecial || pokemonData?.statusBasais?.defesaEspecial || 0;
                          const finalDamage = Math.max(0, pendingDamageValue - defense);
                          const maxHP = calculateMaxHP(pokemon);
                          const currentHp = pokemon.currentHP !== undefined ? pokemon.currentHP : maxHP;
                          const newHP = Math.max(0, currentHp - finalDamage);
                          const updatedTeam = [...mainTeam];
                          updatedTeam[idx] = { ...pokemon, currentHP: newHP };
                          setMainTeam(updatedTeam);
                        }
                        cancelDamageTypeSelection();
                        setInterludioPokemonDamageAmount('');
                        setShowInterludioPokemonDamageModal(false);
                      }}
                      className="bg-purple-500 text-white py-3 rounded-lg hover:bg-purple-600 font-semibold flex items-center justify-center gap-2"
                    >
                      <Zap size={20} />Especial
                    </button>
                  </div>
                  <button
                    onClick={cancelDamageTypeSelection}
                    className={`w-full py-2 rounded-lg font-semibold ${darkMode ? 'bg-gray-600 text-gray-200 hover:bg-gray-500' : 'bg-gray-300 text-gray-700 hover:bg-gray-400'}`}
                  >
                    Cancelar
                  </button>
                </div>
              )}
            </div>
          </div>
        )}

        {/* Modal de Dano/Cura Treinador Interlúdio */}
        {showInterludioTrainerDamageModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => { setShowInterludioTrainerDamageModal(false); cancelDamageTypeSelection(); }}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-md w-full`} onClick={(e) => e.stopPropagation()}>
              <div className="p-3 sm:p-5 md:p-6">
                <div className="flex justify-between items-center mb-6">
                  <h3 className={`text-lg sm:text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                    Dano/Cura - {currentUser?.username || 'Treinador'}
                  </h3>
                  <button onClick={() => { setShowInterludioTrainerDamageModal(false); cancelDamageTypeSelection(); }} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}>
                    <X size={24} />
                  </button>
                </div>

                {/* Informação de HP Atual */}
                <div className={`mb-6 p-4 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                  <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>HP Atual</p>
                  <p className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                    {currentHP} / {getMaxHP()}
                  </p>
                </div>

                {/* Input de Quantidade */}
                <div className="mb-6">
                  <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Quantidade
                  </label>
                  <input
                    type="number"
                    value={interludioTrainerDamageAmount}
                    onChange={(e) => setInterludioTrainerDamageAmount(e.target.value)}
                    placeholder="Digite a quantidade..."
                    className={`w-full px-3 py-2 sm:px-4 sm:py-3 border-2 rounded-lg text-sm sm:text-base text-lg ${
                      darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'border-gray-300 placeholder-gray-400'
                    }`}
                    min="1"
                    disabled={showDamageTypeButtons && pendingDamageContext === 'interludioTrainer'}
                  />
                </div>

                {/* Botões de Ação */}
                {!showDamageTypeButtons || pendingDamageContext !== 'interludioTrainer' ? (
                  <div className="flex gap-3">
                    <button
                      onClick={() => {
                        const v = parseInt(interludioTrainerDamageAmount) || 0;
                        const maxHP = getMaxHP();
                        const newHP = Math.min(currentHP + v, maxHP);
                        setCurrentHP(newHP);
                        setInterludioTrainerDamageAmount('');
                        setShowInterludioTrainerDamageModal(false);
                      }}
                      disabled={!interludioTrainerDamageAmount || parseInt(interludioTrainerDamageAmount) <= 0}
                      className={`flex-1 py-3 rounded-lg flex items-center justify-center gap-2 ${
                        interludioTrainerDamageAmount && parseInt(interludioTrainerDamageAmount) > 0
                          ? 'bg-green-500 hover:bg-green-600 text-white'
                          : darkMode ? 'bg-gray-700 text-gray-500 cursor-not-allowed' : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                      } font-semibold`}
                    >
                      <Heart size={20} />Curar
                    </button>
                    <button
                      onClick={() => {
                        const v = parseInt(interludioTrainerDamageAmount) || 0;
                        if (v > 0) {
                          setPendingDamageValue(v);
                          setPendingDamageContext('interludioTrainer');
                          setShowDamageTypeButtons(true);
                        }
                      }}
                      disabled={!interludioTrainerDamageAmount || parseInt(interludioTrainerDamageAmount) <= 0}
                      className={`flex-1 py-3 rounded-lg flex items-center justify-center gap-2 ${
                        interludioTrainerDamageAmount && parseInt(interludioTrainerDamageAmount) > 0
                          ? 'bg-red-500 hover:bg-red-600 text-white'
                          : darkMode ? 'bg-gray-700 text-gray-500 cursor-not-allowed' : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                      } font-semibold`}
                    >
                      <Sword size={20} />Dano
                    </button>
                  </div>
                ) : (
                  <div className="space-y-3">
                    <p className={`text-center text-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                      Dano: {pendingDamageValue} | Selecione o tipo de dano:
                    </p>
                    <div className="grid grid-cols-3 gap-3">
                      <button
                        onClick={() => {
                          const defense = attributes?.defesa || 0;
                          const finalDamage = Math.max(0, pendingDamageValue - defense);
                          const newHP = Math.max(0, currentHP - finalDamage);
                          setCurrentHP(newHP);
                          cancelDamageTypeSelection();
                          setInterludioTrainerDamageAmount('');
                          setShowInterludioTrainerDamageModal(false);
                        }}
                        className="bg-orange-500 text-white py-3 rounded-lg hover:bg-orange-600 font-semibold flex items-center justify-center gap-2"
                      >
                        <Sword size={20} />Físico
                      </button>
                      <button
                        onClick={() => {
                          const newHP = Math.max(0, currentHP - pendingDamageValue);
                          setCurrentHP(newHP);
                          cancelDamageTypeSelection();
                          setInterludioTrainerDamageAmount('');
                          setShowInterludioTrainerDamageModal(false);
                        }}
                        className="bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600 font-semibold flex items-center justify-center gap-2"
                      >
                        <Minus size={20} />Puro
                      </button>
                      <button
                        onClick={() => {
                          const defense = attributes?.defesaEspecial || 0;
                          const finalDamage = Math.max(0, pendingDamageValue - defense);
                          const newHP = Math.max(0, currentHP - finalDamage);
                          setCurrentHP(newHP);
                          cancelDamageTypeSelection();
                          setInterludioTrainerDamageAmount('');
                          setShowInterludioTrainerDamageModal(false);
                        }}
                        className="bg-purple-500 text-white py-3 rounded-lg hover:bg-purple-600 font-semibold flex items-center justify-center gap-2"
                      >
                        <Zap size={20} />Especial
                      </button>
                    </div>
                    <button
                      onClick={cancelDamageTypeSelection}
                      className={`w-full py-2 rounded-lg font-semibold ${darkMode ? 'bg-gray-600 text-gray-200 hover:bg-gray-500' : 'bg-gray-300 text-gray-700 hover:bg-gray-400'}`}
                    >
                      Cancelar
                    </button>
                  </div>
                )}
              </div>
            </div>
          </div>
        )}

        {/* Modal de Ação Customizada */}
        {showCustomModal && (
          <div
            className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
            onClick={() => {
              setShowCustomModal(false)
              setCustomActionName('')
              setCustomActionCost('')
              setCustomActionPlayer(null)
              setCustomActionType('')
            }}
          >
            <div
              className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg p-3 sm:p-5 md:p-6 max-w-md w-full`}
              onClick={(e) => e.stopPropagation()}
            >
              <div className="flex justify-between items-center mb-4">
                <h3 className={`text-lg sm:text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  Ação Customizada ({customActionType === 'jn' ? 'JN' : 'RT'})
                </h3>
                <button
                  onClick={() => {
                    setShowCustomModal(false)
                    setCustomActionName('')
                    setCustomActionCost('')
                    setCustomActionPlayer(null)
                    setCustomActionType('')
                  }}
                  className={`p-1 rounded ${darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-200'}`}
                >
                  <X className={`w-5 h-5 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`} />
                </button>
              </div>

              <div className="space-y-4">
                <div>
                  <label className={`block text-sm font-semibold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Nome da Ação
                  </label>
                  <input
                    type="text"
                    value={customActionName}
                    onChange={(e) => setCustomActionName(e.target.value)}
                    placeholder="Ex: Treinar Pokémon"
                    className={`w-full px-3 py-2 rounded border ${
                      darkMode
                        ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-500'
                        : 'bg-white border-gray-300 text-gray-900 placeholder-gray-400'
                    } focus:outline-none focus:ring-2 focus:ring-blue-500`}
                  />
                </div>

                <div>
                  <label className={`block text-sm font-semibold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Custo (Pontos)
                  </label>
                  <input
                    type="number"
                    min="1"
                    value={customActionCost}
                    onChange={(e) => setCustomActionCost(e.target.value)}
                    placeholder="Ex: 3"
                    className={`w-full px-3 py-2 rounded border ${
                      darkMode
                        ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-500'
                        : 'bg-white border-gray-300 text-gray-900 placeholder-gray-400'
                    } focus:outline-none focus:ring-2 focus:ring-blue-500`}
                  />
                </div>

                <div className="flex gap-3 pt-2">
                  <button
                    onClick={() => {
                      setShowCustomModal(false)
                      setCustomActionName('')
                      setCustomActionCost('')
                      setCustomActionPlayer(null)
                      setCustomActionType('')
                    }}
                    className={`flex-1 px-4 py-2 rounded font-semibold ${
                      darkMode
                        ? 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                        : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                    } transition-colors`}
                  >
                    Cancelar
                  </button>
                  <button
                    onClick={handleCustomActionSubmit}
                    disabled={!customActionName.trim() || !customActionCost}
                    className={`flex-1 px-4 py-2 rounded font-semibold ${
                      !customActionName.trim() || !customActionCost
                        ? 'bg-gray-400 text-gray-200 cursor-not-allowed'
                        : 'bg-blue-600 text-white hover:bg-blue-700'
                    } transition-colors`}
                  >
                    Confirmar
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* MODAL DE REGRAS DO INTERLÚDIO - Área Treinador */}
        {showRegrasInterludioModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowRegrasInterludioModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-3 sm:p-5 md:p-6 rounded-2xl shadow-2xl max-w-sm sm:max-w-2xl md:max-w-4xl w-full max-h-[90vh] overflow-y-auto`} onClick={(e) => e.stopPropagation()}>
              <div className="flex justify-between items-center mb-6 sticky top-0 pb-4 border-b ${darkMode ? 'border-gray-700 bg-gray-800' : 'border-gray-200 bg-white'}">
                <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Regras do Interlúdio</h3>
                <button onClick={() => setShowRegrasInterludioModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}><X size={24} /></button>
              </div>

              <div className={`space-y-6 text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                {/* Explicação */}
                <div>
                  <h4 className={`text-lg font-bold mb-2 ${darkMode ? 'text-indigo-400' : 'text-indigo-600'}`}>Explicação</h4>
                  <p><strong>Verdade</strong> - a verdade sobre o mundo é algo que seja alcançável e plausível, para o mundo e nível dos personagens.</p>
                  <p className="mt-2"><strong>Jogador-narrador (JN)</strong> - aquele que vai narrar e jogar. Contará seus feitos em tempo real. Gastará seus pontos de narração para contar sua história.</p>
                  <p className="mt-2"><strong>Roteiristas (RT)</strong> - aqueles que vão ouvir a história e adicionar complicações, ajudas, npcs, pokémons... no caminho do JN. Gastarão pontos de roteiro.</p>
                  <p className="mt-2"><strong>Ponto de Narração</strong> - pontos usados para suas cenas.</p>
                  <p className="mt-2"><strong>Pontos de Roteiro</strong> - pontos usados para adicionar elementos nas cenas.</p>
                </div>

                {/* Mais a fundo */}
                <div>
                  <h4 className={`text-lg font-bold mb-2 ${darkMode ? 'text-indigo-400' : 'text-indigo-600'}`}>Mais a fundo</h4>
                  <p><strong>Verdade:</strong> O JN, ou o grupo, cria a verdade e não poderá alterá-la.</p>
                  <p className="mt-2"><strong>Pontos de Narração:</strong> O JN, ou o grupo, tem 6pts de narração.</p>
                </div>

                {/* Uso de Pontos de Narração */}
                <div>
                  <h4 className={`text-lg font-bold mb-2 ${darkMode ? 'text-yellow-400' : 'text-yellow-600'}`}>Uso de Pontos de Narração</h4>

                  <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-4 rounded-lg mb-3`}>
                    <h5 className="font-bold mb-2">Concursos e Torneios (3pts)</h5>
                    <ul className="list-disc list-inside space-y-1 ml-2">
                      <li>Gastam 1 semana no mínimo, tem 1d8-nºJN participantes e o prêmio é de 1º-1000₽, 2º-500₽, 3º-250₽.</li>
                      <li>A cada 3 dias a mais se adiciona 1d4 participantes.</li>
                      <li>A cada 3 dias a mais se adiciona 50% no valor da premiação.</li>
                      <li>Com 1 semana a mais, um item aleatório também entra como premiação.</li>
                      <li>Com 2 semanas a mais, o JN pode escolher a classe do item.</li>
                      <li>Com 3 semanas a mais o JN pode escolher o Item.</li>
                      <li>Em TORNEIOS, feitos de interlúdio, as regras sempre vão ser na inscrição de até 3 pkms.</li>
                      <li>O level dos pokémons variam em 5, pra menos ou mais, do pokémon mais forte do JN.</li>
                    </ul>
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-3 rounded-lg`}>
                      <p><strong>Procurar pkm (1pt):</strong> 4 dias procurando pokémon, cada dia te dá direito a 1d6+1 pokémons gerados.</p>
                    </div>
                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-3 rounded-lg`}>
                      <p><strong>Batalha com treinador (1pt):</strong> Você pode batalhar com 1d4 treinadores, cada treinador possui 1d4+1 pokémons.</p>
                    </div>
                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-3 rounded-lg`}>
                      <p><strong>Catalogar pokémon (1pt):</strong> Você pode ter gerado 1d8+2 pkms, o que não implica na certeza de pkms novos.</p>
                    </div>
                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-3 rounded-lg`}>
                      <p><strong>Adicionar recompensa (3pts):</strong> O jogador deve escolher 5 elementos do obstáculo ou quest, e a recompensa extra será escolhida rolando 1d5.</p>
                    </div>
                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-3 rounded-lg`}>
                      <p><strong>Em busca da Lenda (5pts):</strong> O jogador vai contar como conseguiu ou quase conseguiu uma pista sobre um pokémon lendário. Já tendo a pista, pode ir atrás do lendário.</p>
                    </div>
                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-3 rounded-lg`}>
                      <p><strong>Em busca do alvo (4pts/2pts):</strong> O jogador pode buscar informações sobre um pokémon específico. Se já tem a localização, só gasta 2pts.</p>
                    </div>
                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-3 rounded-lg`}>
                      <p><strong>Sidequest (5pts):</strong> O jogador pode criar uma quest com recompensa de itens, pokémoedas ou pokémons (limite de 1pkm por quest).</p>
                    </div>
                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-3 rounded-lg`}>
                      <p><strong>NPC aleatório (1pt):</strong> Pode gerar um NPC aleatório no gerador de NPC, level máximo não pode passar o seu próprio.</p>
                    </div>
                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-3 rounded-lg`}>
                      <p><strong>NPC específico (3pts):</strong> Pode escolher as classes/subclasses do NPC, level máximo não pode passar o seu próprio.</p>
                    </div>
                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-3 rounded-lg`}>
                      <p><strong>Batalha de Ginásio (3pts):</strong> Ir para uma batalha de ginásio. O líder tem 1d4+2 pkms.</p>
                    </div>
                  </div>
                </div>

                {/* Encontro Pokémon */}
                <div>
                  <h4 className={`text-lg font-bold mb-2 ${darkMode ? 'text-green-400' : 'text-green-600'}`}>Encontro Pokémon</h4>

                  <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-4 rounded-lg mb-3`}>
                    <h5 className="font-bold mb-2">Mapa</h5>
                    <ul className="list-disc list-inside space-y-1 ml-2">
                      <li>O JN anda pelo mapa após um dos RT posicionarem os pokémons gerados.</li>
                      <li>O JN tem 3 turnos antes que os pokémons se movam.</li>
                      <li>Caso um pokémon selvagem se mova do lado da borda, o RT joga 1d2: 1-sai do mapa; 2-se move para dentro do mapa.</li>
                      <li>Caso o JN pare seu movimento ao lado do pkm selvagem, o RT joga 1d20: 1-10 não percebe nada; 11-20 percebeu o pkm selvagem.</li>
                    </ul>
                  </div>

                  <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-4 rounded-lg`}>
                    <h5 className="font-bold mb-2">App de chance de encontro</h5>
                    <p>O RT usa o app de chance de encontro de acordo com as ações do JN. Um número de vezes igual ao valor do dado.</p>
                  </div>
                </div>

                {/* Pontos de Roteiro */}
                <div>
                  <h4 className={`text-lg font-bold mb-2 ${darkMode ? 'text-purple-400' : 'text-purple-600'}`}>Pontos de Roteiro</h4>
                  <p className="mb-3">O RT tem 4pts de roteiro.</p>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-3 rounded-lg`}>
                      <p className="font-bold mb-1">Adicionar NPC:</p>
                      <ul className="list-disc list-inside ml-2">
                        <li>NPC treinador: 1pt a cada 3 pkms (limite 6pkms)</li>
                        <li>NPC de história: 1pt</li>
                        <li>NPC vilão: 3pts a cada 3 pkms (limite 6pkms)</li>
                      </ul>
                    </div>
                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-3 rounded-lg`}>
                      <p className="font-bold mb-1">Adicionar Obstáculo:</p>
                      <ul className="list-disc list-inside ml-2">
                        <li>Fácil: 1pt (recompensa até 250₽)</li>
                        <li>Médio: 2pts (recompensa até 500₽)</li>
                        <li>Difícil: 3pts (recompensa até 800₽)</li>
                      </ul>
                    </div>
                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-3 rounded-lg`}>
                      <p className="font-bold mb-1">Adicionar Quest:</p>
                      <ul className="list-disc list-inside ml-2">
                        <li>Fácil: 2pts (recompensa até 450₽)</li>
                        <li>Médio: 3pts (recompensa até 750₽)</li>
                        <li>Difícil: 4pts (recompensa até 1000₽)</li>
                      </ul>
                    </div>
                  </div>
                </div>

                {/* Level de NPCs */}
                <div>
                  <h4 className={`text-lg font-bold mb-2 ${darkMode ? 'text-red-400' : 'text-red-600'}`}>Level de NPCs e PKMs</h4>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-3 rounded-lg`}>
                      <p className="font-bold mb-1">Level de NPCs:</p>
                      <ul className="list-disc list-inside ml-2">
                        <li>Treinador: 5 levels a mais/menos do que o JN</li>
                        <li>Vilão: de 5 a 15 levels a mais do que o JN</li>
                        <li>Líder de Ginásio: entre level 35 a 50</li>
                      </ul>
                    </div>
                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-3 rounded-lg`}>
                      <p className="font-bold mb-1">Level de PKMs de NPCs:</p>
                      <ul className="list-disc list-inside ml-2">
                        <li>Treinador: 5 levels a mais/menos do que o pkm mais forte do JN</li>
                        <li>Vilão: 5-10 leveis a mais do pkm mais forte do JN</li>
                        <li>Líder de Ginásio: até 5 levels a mais que o mais forte do JN</li>
                      </ul>
                    </div>
                  </div>
                </div>

                {/* Ganho de ₽ */}
                <div>
                  <h4 className={`text-lg font-bold mb-2 ${darkMode ? 'text-amber-400' : 'text-amber-600'}`}>Ganho de ₽ por Batalha</h4>
                  <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-4 rounded-lg`}>
                    <ul className="list-disc list-inside space-y-1">
                      <li><strong>Treinador:</strong> 25x o level do treinador, aumentando o valor final em 50% por pokémon adicionado.</li>
                      <li><strong>Vilão:</strong> 50x o level do vilão, aumentando o valor final em 50% por pokémon adicionado.</li>
                      <li><strong>Líder de Ginásio:</strong> 75x o level do líder.</li>
                    </ul>
                  </div>
                </div>
              </div>

              <div className="mt-6 pt-4 border-t ${darkMode ? 'border-gray-700' : 'border-gray-200'}">
                <button onClick={() => setShowRegrasInterludioModal(false)} className={`w-full py-3 rounded-lg font-semibold ${darkMode ? 'bg-indigo-600 text-white hover:bg-indigo-700' : 'bg-indigo-500 text-white hover:bg-indigo-600'}`}>
                  Fechar
                </button>
              </div>
            </div>
          </div>
        )}

        {accountDataModal}
        {scenarioPopupOverlay}
        {mostrarTriunfosOverlay}
        {pokezapPanel}{pokeAgendaPanel}
        {batalhaChatPanel}
      </>
    )
  }

  // ==================== ÁREA SAFARI STAFF (MESTRE) ====================
  if (currentArea === 'Safari Staff' && currentUser.type === 'mestre') {
    const staffRunKey = safariStaffActiveRun ? `run-${safariStaffActiveRun}` : null
    const staffRunGrid = staffRunKey ? safariRunGrids[staffRunKey] : null
    const staffRunArea = staffRunKey ? (safariRunAreas[staffRunKey] || 'Área Central') : null
    const staffRunTimer = staffRunKey ? (safariTimers[staffRunKey] !== undefined ? safariTimers[staffRunKey] : 600) : null
    const safariConditionsList = ['confusão', 'crítico', 'paralisia', 'sono', 'atordoamento', 'congelamento', 'paixão', 'queimadura', 'veneno']
    const typeColors = { normal: '#A8A878', fire: '#F08030', water: '#6890F0', electric: '#F8D030', grass: '#78C850', ice: '#98D8D8', fighting: '#C03028', poison: '#A040A0', ground: '#E0C068', flying: '#A890F0', psychic: '#F85888', bug: '#A8B820', rock: '#B8A038', ghost: '#705898', dragon: '#7038F8', dark: '#705848', steel: '#B8B8D0', fairy: '#EE99AC' }

    return (
      <>
        <div className={`min-h-screen ${mainBgClass}`}>
          {sidebarNav}
          <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-lg`}>
            <div className="max-w-7xl mx-auto px-4 py-4">
              <div className="flex justify-between items-center mb-4">
                <div className="flex items-center gap-3"><button onClick={() => setSidebarOpen(true)} className={`p-2 rounded-lg ${darkMode ? "hover:bg-gray-700 text-gray-400" : "hover:bg-gray-200 text-gray-500"}`}><Menu size={24} /></button><h2 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Safari Staff</h2></div>
                <div className="flex gap-2">
                  <button onClick={() => setDarkMode(!darkMode)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-yellow-400' : 'bg-gray-200 text-gray-700'}`}>{darkMode ? <Sun size={20} /> : <Moon size={20} />}</button>
                  {pokezapBtn}{pokeAgendaBtn}{batalhaChatBtn}<button onClick={handleLogout} className="bg-red-500 text-white px-3 sm:px-5 md:px-6 py-2 rounded-lg hover:bg-red-600">Sair</button>
                </div>
              </div>
            </div>
          </div>

          <div className="max-w-7xl mx-auto px-4 py-3 sm:py-5 md:py-8">
            {/* Subáreas */}
            <div className="flex gap-2 mb-6">
              {['Mapa Safari Staff', 'Encontro Safari Staff'].map(sub => (
                <button key={sub} onClick={() => setSafariStaffSubarea(sub)}
                  className={`px-4 py-2 rounded-lg font-semibold ${safariStaffSubarea === sub ? 'bg-green-600 text-white' : darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}>
                  {sub}
                </button>
              ))}
            </div>

            {/* MAPA SAFARI STAFF */}
            {safariStaffSubarea === 'Mapa Safari Staff' && (
              <div>
                {/* Controles */}
                <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-6 mb-6`}>
                  <div className="flex justify-between items-center mb-4">
                    <h3 className={`text-lg sm:text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Runs do Safari</h3>
                    <button onClick={handleResetSafari}
                      className="px-4 py-2 rounded-lg font-semibold bg-red-600 text-white hover:bg-red-700">
                      Resetar Safari
                    </button>
                  </div>

                  {/* Run Safari Staff Buttons com Checkboxes */}
                  <div className="space-y-4">
                    {[1, 2, 3, 4, 5].map(num => {
                      const rKey = `run-${num}`
                      const hasGrid = !!safariRunGrids[rKey]
                      const perms = safariRunPermissions[rKey] || {}
                      return (
                        <div key={num} className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} rounded-xl p-4`}>
                          <button onClick={() => setSafariStaffActiveRun(safariStaffActiveRun === num ? null : num)}
                            className={`px-4 py-2 rounded-lg font-semibold transition-all mb-3 ${
                              safariStaffActiveRun === num
                                ? 'bg-green-600 text-white ring-2 ring-green-400'
                                : hasGrid
                                  ? (darkMode ? 'bg-green-800 text-green-300 hover:bg-green-700' : 'bg-green-100 text-green-800 hover:bg-green-200')
                                  : (darkMode ? 'bg-gray-600 text-gray-300' : 'bg-gray-200 text-gray-500')
                            }`}>
                            Run Safari {num} Staff {hasGrid ? `(${safariRunAreas[rKey] || 'Central'})` : '(vazio)'}
                          </button>
                          <div className="flex flex-wrap gap-3">
                            {SAFARI_TRAINERS.map(trainer => (
                              <label key={trainer} className={`flex items-center gap-1.5 text-sm cursor-pointer ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                <input type="checkbox" checked={!!perms[trainer]}
                                  onChange={() => handleToggleSafariRunPermission(num, trainer)}
                                  className="w-4 h-4 rounded border-gray-400 text-green-600 focus:ring-green-500" />
                                {trainer}
                              </label>
                            ))}
                          </div>
                        </div>
                      )
                    })}
                  </div>
                </div>

                {/* Grid Run 1-5 Buttons */}
                <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-6 mb-6`}>
                  <h3 className={`text-lg font-bold mb-3 ${darkMode ? 'text-white' : 'text-gray-800'}`}>Visualizar Grid</h3>
                  <div className="flex flex-wrap gap-2 mb-4">
                    {[1, 2, 3, 4, 5].map(num => {
                      const rKey = `run-${num}`
                      const hasGrid = !!safariRunGrids[rKey]
                      return (
                        <button key={num} onClick={() => setSafariStaffActiveRun(safariStaffActiveRun === num ? null : num)}
                          className={`px-4 py-2 rounded-lg font-semibold transition-all ${
                            safariStaffActiveRun === num
                              ? 'bg-green-600 text-white ring-2 ring-green-400'
                              : hasGrid
                                ? (darkMode ? 'bg-green-800 text-green-300 hover:bg-green-700' : 'bg-green-100 text-green-800 hover:bg-green-200')
                                : (darkMode ? 'bg-gray-600 text-gray-400 cursor-not-allowed' : 'bg-gray-200 text-gray-400 cursor-not-allowed')
                          }`}
                          disabled={!hasGrid}>
                          Grid Run {num}
                        </button>
                      )
                    })}
                  </div>

                  {/* Grid do Run Selecionado */}
                  {staffRunGrid && (
                    <div>
                      <h4 className={`text-lg font-bold mb-2 ${darkMode ? 'text-green-400' : 'text-green-700'}`}>
                        Run Safari {safariStaffActiveRun} - {staffRunArea} <span className={`text-sm ${darkMode ? 'text-yellow-400' : 'text-yellow-600'}`}>⏰ {formatSafariTimer(staffRunTimer)}</span>
                      </h4>
                      <div className="grid grid-cols-8 gap-1 max-w-lg mx-auto">
                        {staffRunGrid.map((row, ri) => row.map((cell, ci) => (
                          <div key={`${ri}-${ci}`}
                            className={`aspect-square rounded border relative flex flex-col items-center justify-center text-xs overflow-hidden`}>
                            <img src={cell.terrain === 'Grama' ? '/gramasafari.png' : '/aguasafari.png'} alt={cell.terrain}
                              className="absolute inset-0 w-full h-full object-cover opacity-40" />
                            <div className="relative z-10">
                              {cell.pokemon && (
                                <div className="text-center">
                                  {cell.imageUrl && <img src={cell.imageUrl} alt={cell.pokemon} className="w-8 h-8 mx-auto" />}
                                  <div className="text-[8px] font-bold truncate w-full text-white drop-shadow-[0_1px_2px_rgba(0,0,0,0.8)]">
                                    {cell.pokemon}{cell.isSkittish ? '*' : ''}
                                  </div>
                                  <div className="text-[8px] text-white drop-shadow-[0_1px_2px_rgba(0,0,0,0.8)]">
                                    x{cell.quantity} Nv{cell.level}
                                  </div>
                                </div>
                              )}
                            </div>
                          </div>
                        )))}
                      </div>
                    </div>
                  )}
                </div>

                {/* Chat */}
                <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-6`}>
                  <h3 className={`text-xl sm:text-2xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-800'}`}>Chat Safari</h3>

                  {/* Menu de Rolagem Rápida */}
                  <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} rounded-lg p-3 sm:p-4 mb-4`}>
                    <h4 className={`text-sm font-bold mb-3 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      Rolagem Rápida
                    </h4>
                    <div className="flex flex-col sm:flex-row sm:flex-wrap sm:items-center gap-3">
                      {/* Primeira Parte: Número de dados */}
                      <div className="flex flex-col xs:flex-row xs:items-center gap-2">
                        <span className={`text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'} whitespace-nowrap`}>Quantidade:</span>
                        <div className="flex flex-wrap gap-1">
                          {[1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(num => (
                            <button
                              key={num}
                              onClick={() => setQuickRollNumDice(num)}
                              className={`w-7 h-7 sm:w-8 sm:h-8 rounded text-xs sm:text-sm font-bold transition-colors ${
                                quickRollNumDice === num
                                  ? 'bg-blue-600 text-white'
                                  : darkMode
                                  ? 'bg-gray-600 text-gray-300 hover:bg-gray-500'
                                  : 'bg-white text-gray-700 hover:bg-gray-200'
                              }`}
                            >
                              {num}
                            </button>
                          ))}
                        </div>
                      </div>

                      {/* Segunda Parte: Tipo de dado */}
                      <div className="flex flex-col xs:flex-row xs:items-center gap-2">
                        <span className={`text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'} whitespace-nowrap`}>Dado:</span>
                        <div className="flex flex-wrap gap-1">
                          {['d4', 'd6', 'd8', 'd10', 'd12', 'd20'].map(dice => (
                            <button
                              key={dice}
                              onClick={() => setQuickRollDiceType(dice)}
                              className={`px-2 sm:px-3 h-7 sm:h-8 rounded text-xs sm:text-sm font-bold transition-colors ${
                                quickRollDiceType === dice
                                  ? 'bg-green-600 text-white'
                                  : darkMode
                                  ? 'bg-gray-600 text-gray-300 hover:bg-gray-500'
                                  : 'bg-white text-gray-700 hover:bg-gray-200'
                              }`}
                            >
                              {dice}
                            </button>
                          ))}
                        </div>
                      </div>

                      {/* Botão Rolar */}
                      <button
                        onClick={() => {
                          const diceNotation = `${quickRollNumDice}${quickRollDiceType}`
                          const result = rollDiceExpression(diceNotation)
                          if (result.error) {
                            alert(result.error)
                            return
                          }
                          const newMessage = {
                            username: currentUser?.username || 'Anônimo',
                            text: `🎲 Rolagem Rápida: ${diceNotation}`,
                            timestamp: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
                            isDiceRoll: true,
                            diceResult: result.total,
                            diceDetails: result.formula
                          }
                          setChatMessages(prev => [...prev, newMessage])
                          if (useFirebase) {
                            (async () => {
                              const currentMessages = await loadChatMessages()
                              await saveChatMessages([...(currentMessages || []), newMessage])
                            })().catch(err => console.error('Erro ao salvar mensagem:', err))
                          }
                        }}
                        className="w-full sm:w-auto px-3 sm:px-5 md:px-6 h-8 bg-purple-600 text-white rounded font-bold hover:bg-purple-700 transition-colors text-sm"
                      >
                        🎲 Rolar
                      </button>
                    </div>
                  </div>

                  <div className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-4`}>
                    <p>Use /r ou /roll para rolar dados. Ex: /r 1d20+5</p>
                  </div>
                  <div ref={chatContainerRef} className={`${darkMode ? 'bg-gray-900' : 'bg-gray-50'} rounded-lg p-4 h-96 overflow-y-auto mb-4`}>
                    {chatMessages.length === 0 ? (
                      <p className={`text-center ${darkMode ? 'text-gray-500' : 'text-gray-400'} py-3 sm:py-5 md:py-8`}>Nenhuma mensagem ainda.</p>
                    ) : (
                      <div className="space-y-3">
                        {chatMessages.map((msg, idx) => (
                          <div key={idx} className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg p-3`}>
                            <div className="flex justify-between items-start mb-1">
                              <span className={`font-bold text-sm ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>{msg.username}</span>
                              <span className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>{msg.timestamp}</span>
                            </div>
                            {msg.isDiceRoll ? (
                              <div>
                                <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>{msg.text}</p>
                                <div className={`mt-2 p-2 rounded ${darkMode ? 'bg-green-900' : 'bg-green-100'}`}>
                                  <p className={`font-bold text-lg ${darkMode ? 'text-green-400' : 'text-green-700'}`}>Resultado: {msg.diceResult}</p>
                                  <p className={`text-xs ${darkMode ? 'text-green-300' : 'text-green-600'}`}>{msg.diceDetails}</p>
                                </div>
                              </div>
                            ) : msg.isAction ? (
                              <p className="text-sm font-semibold text-yellow-500">{msg.text}</p>
                            ) : (
                              <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>{msg.text}</p>
                            )}
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                  <div className="flex gap-2">
                    <input type="text" value={chatInput} onChange={(e) => setChatInput(e.target.value)}
                      onKeyPress={(e) => { if (e.key === 'Enter') handleSendMessage() }}
                      placeholder="Digite sua mensagem ou /r 1d20..."
                      className={`flex-1 px-3 py-2 sm:px-4 sm:py-3 rounded-lg border-2 text-sm sm:text-base ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-500' : 'bg-white border-gray-300 text-gray-800 placeholder-gray-400'} focus:outline-none focus:border-blue-500`} />
                    <button onClick={handleSendMessage} className="px-3 sm:px-5 md:px-6 py-2 sm:py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold text-sm sm:text-base">Enviar</button>
                  </div>
                </div>
              </div>
            )}

            {/* ENCONTRO SAFARI STAFF */}
            {safariStaffSubarea === 'Encontro Safari Staff' && (
              <div>
                <div className="flex justify-between items-center mb-6">
                  <h3 className={`text-lg sm:text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Encontros Safari Staff</h3>
                  <button onClick={handleEquipeLimpeza}
                    className="px-4 py-2 rounded-lg font-semibold bg-red-600 text-white hover:bg-red-700">
                    🧹 Equipe de Limpeza
                  </button>
                </div>

                {/* Run Pkm 1-5 Buttons */}
                <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-6 mb-6`}>
                  <div className="flex flex-wrap gap-2 mb-4">
                    {[1, 2, 3, 4, 5].map(num => {
                      const rKey = `run-${num}`
                      const runEnc = safariRunEncounters[rKey] || []
                      return (
                        <button key={num} onClick={() => setSafariStaffEncounterActiveRun(safariStaffEncounterActiveRun === num ? null : num)}
                          className={`px-4 py-2 rounded-lg font-semibold transition-all ${
                            safariStaffEncounterActiveRun === num
                              ? 'bg-green-600 text-white ring-2 ring-green-400'
                              : runEnc.length > 0
                                ? (darkMode ? 'bg-green-800 text-green-300 hover:bg-green-700' : 'bg-green-100 text-green-800 hover:bg-green-200')
                                : (darkMode ? 'bg-gray-600 text-gray-300 hover:bg-gray-500' : 'bg-gray-200 text-gray-500 hover:bg-gray-300')
                          }`}>
                          Run Pkm {num} {runEnc.length > 0 ? `(${runEnc.length})` : ''}
                        </button>
                      )
                    })}
                  </div>

                  {/* Pokémons da Run selecionada - Card NPC completo */}
                  {safariStaffEncounterActiveRun && (() => {
                    const activeRunKey = `run-${safariStaffEncounterActiveRun}`
                    const activeRunEnc = safariRunEncounters[activeRunKey] || []
                    return (
                      <div>
                        <h4 className={`text-lg font-bold mb-4 ${darkMode ? 'text-green-400' : 'text-green-700'}`}>
                          Run Safari {safariStaffEncounterActiveRun} {safariRunAreas[activeRunKey] ? `- ${safariRunAreas[activeRunKey]}` : ''}
                          <span className={`ml-2 text-sm ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>({activeRunEnc.length} pokémon)</span>
                        </h4>
                        {activeRunEnc.length === 0 ? (
                          <p className={`text-center py-4 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>Nenhum pokémon encontrado nesta run.</p>
                        ) : (
                          <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-2 sm:gap-3 md:gap-4">
                            {activeRunEnc.map((pokemon, pokemonIndex) => {
                              const isExpanded = expandedSafariNpcCards.includes(pokemon.id)
                              const conds = pokemon.conditions || {}

                              // Array de cores para os cards Safari NPC
                              const safariCardColors = [
                                { dark: 'bg-gradient-to-br from-rose-800 to-rose-900', light: 'bg-gradient-to-br from-rose-200 to-rose-300' },
                                { dark: 'bg-gradient-to-br from-blue-800 to-blue-900', light: 'bg-gradient-to-br from-blue-200 to-blue-300' },
                                { dark: 'bg-gradient-to-br from-emerald-800 to-emerald-900', light: 'bg-gradient-to-br from-emerald-200 to-emerald-300' },
                                { dark: 'bg-gradient-to-br from-amber-800 to-amber-900', light: 'bg-gradient-to-br from-amber-200 to-amber-300' },
                                { dark: 'bg-gradient-to-br from-purple-800 to-purple-900', light: 'bg-gradient-to-br from-purple-200 to-purple-300' },
                                { dark: 'bg-gradient-to-br from-cyan-800 to-cyan-900', light: 'bg-gradient-to-br from-cyan-200 to-cyan-300' },
                                { dark: 'bg-gradient-to-br from-pink-800 to-pink-900', light: 'bg-gradient-to-br from-pink-200 to-pink-300' },
                                { dark: 'bg-gradient-to-br from-indigo-800 to-indigo-900', light: 'bg-gradient-to-br from-indigo-200 to-indigo-300' },
                                { dark: 'bg-gradient-to-br from-teal-800 to-teal-900', light: 'bg-gradient-to-br from-teal-200 to-teal-300' },
                                { dark: 'bg-gradient-to-br from-orange-800 to-orange-900', light: 'bg-gradient-to-br from-orange-200 to-orange-300' },
                              ]
                              const cardColor = safariCardColors[pokemonIndex % safariCardColors.length]
                              const cardBg = darkMode ? cardColor.dark : cardColor.light

                              return (
                                <div key={pokemon.id}
                                  className={`${cardBg} rounded-2xl shadow-xl overflow-hidden transition-all ${
                                    isExpanded ? 'col-span-2 md:col-span-2 lg:col-span-3' : ''
                                  }`}>
                                  {!isExpanded ? (
                                    <div className="relative group">
                                      <div onClick={() => toggleSafariNpcCard(pokemon.id)} className="cursor-pointer p-4 flex flex-col items-center">
                                        {pokemon.imageUrl && <img src={pokemon.imageUrl} alt={pokemon.species} className="w-24 h-24 object-contain mb-2" />}
                                        <p className={`text-sm font-bold text-center ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                          {pokemon.species} {pokemon.shiny && '✨'}
                                        </p>
                                        <p className={`text-xs text-center ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Nível {pokemon.level}</p>
                                        <div className="flex gap-1 mt-1">
                                          {pokemon.habilidade1 && <span className={`px-1.5 py-0.5 rounded text-[10px] font-semibold ${darkMode ? 'bg-blue-900 text-blue-300' : 'bg-blue-500 text-white'}`}>{pokemon.habilidade1}</span>}
                                          {pokemon.habilidade2 && <span className={`px-1.5 py-0.5 rounded text-[10px] font-semibold ${darkMode ? 'bg-purple-900 text-purple-300' : 'bg-purple-500 text-white'}`}>{pokemon.habilidade2}</span>}
                                        </div>
                                      </div>
                                      <div className="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button onClick={(e) => { e.stopPropagation(); sendNpcPokemonToBattle(pokemon) }}
                                          className="bg-cyan-500 text-white p-1.5 rounded-lg hover:bg-cyan-600" title="Enviar para Batalha">
                                          <ArrowRightCircle size={14} />
                                        </button>
                                        <button onClick={(e) => { e.stopPropagation(); handleRemoveSafariPokemon(safariStaffEncounterActiveRun, pokemon.id) }}
                                          className="bg-red-500 text-white p-1.5 rounded-lg hover:bg-red-600" title="Excluir Pokémon">
                                          <Trash2 size={14} />
                                        </button>
                                      </div>
                                    </div>
                                  ) : (
                                    <div className="p-4">
                                      <div className="flex justify-between items-start mb-3">
                                        <div onClick={() => toggleSafariNpcCard(pokemon.id)} className="cursor-pointer flex-1">
                                          {pokemon.imageUrl && <div className="flex justify-center mb-2"><img src={pokemon.imageUrl} alt={pokemon.species} className="w-20 h-20 object-contain" /></div>}
                                          <div className="text-center mb-2">
                                            <p className={`text-sm font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{pokemon.species} {pokemon.shiny && '✨'}</p>
                                            <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>#{String(pokemon.dexNumber).padStart(4, '0')} • Nível {pokemon.level}</p>
                                          </div>
                                        </div>
                                        <div className="flex gap-2">
                                          <button onClick={() => sendNpcPokemonToBattle(pokemon)} className="bg-cyan-500 text-white p-1.5 rounded-lg hover:bg-cyan-600" title="Enviar para Batalha"><ArrowRightCircle size={14} /></button>
                                          <button onClick={() => handleRemoveSafariPokemon(safariStaffEncounterActiveRun, pokemon.id)} className="bg-red-500 text-white p-1.5 rounded-lg hover:bg-red-600" title="Excluir Pokémon"><Trash2 size={14} /></button>
                                        </div>
                                      </div>

                                      {/* Condições */}
                                      <div className="mb-2">
                                        <h4 className={`text-xs font-semibold mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Condições</h4>
                                        <div className="flex flex-wrap gap-1">
                                          {safariConditionsList.map(cond => (
                                            <label key={cond} className={`flex items-center gap-0.5 text-[10px] cursor-pointer ${conds[cond] ? 'text-red-400 font-bold' : darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                                              <input type="checkbox" checked={!!conds[cond]}
                                                onChange={() => handleToggleSafariCondition(safariStaffEncounterActiveRun, pokemon.id, cond)}
                                                className="w-3 h-3" />
                                              {cond}
                                            </label>
                                          ))}
                                        </div>
                                      </div>

                                      {/* Tipos & Habilidades */}
                                      <div className="mb-2">
                                        <h4 className={`text-xs font-semibold mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Tipos & Habilidades</h4>
                                        <div className="flex gap-1 flex-wrap mb-2">
                                          {(pokemon.types || []).map((type, idx) => (
                                            <span key={idx} className="px-2 py-0.5 text-xs rounded-lg font-semibold text-white" style={{ backgroundColor: typeColors[type] || '#888' }}>{type.charAt(0).toUpperCase() + type.slice(1)}</span>
                                          ))}
                                          {pokemon.habilidade1 && <span onClick={() => { setSelectedAbility(pokemon.habilidade1); setShowAbilityModal(true) }} className={`px-2 py-0.5 text-xs rounded-lg font-semibold cursor-pointer hover:opacity-80 ${darkMode ? 'bg-blue-900 text-blue-300' : 'bg-blue-500 text-white'}`}>{pokemon.habilidade1}</span>}
                                          {pokemon.habilidade2 && <span onClick={() => { setSelectedAbility(pokemon.habilidade2); setShowAbilityModal(true) }} className={`px-2 py-0.5 text-xs rounded-lg font-semibold cursor-pointer hover:opacity-80 ${darkMode ? 'bg-purple-900 text-purple-300' : 'bg-purple-500 text-white'}`}>{pokemon.habilidade2}</span>}
                                        </div>
                                      </div>

                                      {/* Chance de Fuga + Valor de Captura */}
                                      <div className="space-y-2 mb-2">
                                        <div className="flex justify-center">
                                          <button onClick={() => handleSafariChanceFugaRoll(safariStaffEncounterActiveRun, pokemon.id)}
                                            className={`px-3 py-1 rounded-lg text-sm font-bold transition-all ${pokemon.isSkittish ? 'bg-red-600 text-white hover:bg-red-700' : 'bg-orange-500 text-white hover:bg-orange-600'}`}>
                                            Chance de Fuga: {pokemon.chanceFuga}%
                                          </button>
                                        </div>

                                        {/* Valor de Captura (só Mestre vê) */}
                                        <div className="flex justify-center">
                                          <div className={`px-3 py-1 rounded-lg font-bold text-sm ${
                                            calculateSafariCaptureValue(pokemon) >= 0
                                              ? 'bg-green-600 text-white'
                                              : 'bg-red-600 text-white'
                                          }`}>
                                            Captura: {calculateSafariCaptureValue(pokemon) >= 0 ? '+' : ''}{calculateSafariCaptureValue(pokemon)}
                                          </div>
                                        </div>
                                      </div>

                                      {/* HP e Evasões */}
                                      {pokemon.attributes && (
                                        <div className={`mb-2 p-2 rounded-lg ${darkMode ? 'bg-gray-600' : 'bg-gray-50'}`}>
                                          <div className="flex items-center justify-between mb-2">
                                            <div className="flex-1">
                                              <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>HP</p>
                                              <p className={`text-sm font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                                {pokemon.currentHP !== undefined ? pokemon.currentHP : ((3 * pokemon.attributes.saude) + pokemon.level)} / {(3 * pokemon.attributes.saude) + pokemon.level}
                                              </p>
                                            </div>
                                            <button onClick={() => { setSelectedSafariNpcPokemon(pokemon); setSafariNpcDamageRunNumber(safariStaffEncounterActiveRun); setShowSafariNpcDamageModal(true) }}
                                              className="flex items-center gap-1 bg-gradient-to-r from-red-600 to-pink-600 text-white px-3 py-1.5 rounded-lg hover:from-red-700 hover:to-pink-700 font-semibold text-xs" title="Dano/Cura">
                                              <Sword size={12} /><Heart size={12} />
                                            </button>
                                          </div>
                                          <div className="grid grid-cols-3 gap-2">
                                            <div><p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Ev. Física</p><p className={`text-xs font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{Math.floor(pokemon.attributes.defesa / 5)}</p></div>
                                            <div><p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Ev. Especial</p><p className={`text-xs font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{Math.floor(pokemon.attributes.defesaEspecial / 5)}</p></div>
                                            <div><p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Ev. Veloz</p><p className={`text-xs font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{Math.floor(pokemon.attributes.velocidade / 10)}</p></div>
                                          </div>
                                        </div>
                                      )}

                                      {/* Informações Básicas */}
                                      {pokemon.attributes && (
                                        <div className={`grid grid-cols-2 gap-2 mb-2 p-2 rounded-lg ${darkMode ? 'bg-gray-600' : 'bg-gray-50'}`}>
                                          <div><p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Espécie</p><p className={`text-xs font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{pokemon.species}</p></div>
                                          <div><p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Catch Rate</p><p className={`text-xs font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{pokemon.catchRate}</p></div>
                                          <div><p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Experiência</p><p className={`text-xs font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{pokemon.experience} XP</p></div>
                                          <div><p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Gênero</p><p className={`text-xs font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{pokemon.gender || 'N/A'}</p></div>
                                          <div><p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Peso</p><p className={`text-xs font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{pokemon.weight ? `${pokemon.weight} kg` : 'N/A'}</p></div>
                                          <div><p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Altura</p><p className={`text-xs font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{pokemon.height ? `${pokemon.height} m` : 'N/A'}</p></div>
                                        </div>
                                      )}

                                      {/* Natureza */}
                                      {pokemon.nature && (
                                        <div className="mb-2">
                                          <h4 className={`text-xs font-semibold mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Natureza</h4>
                                          <p className={`text-xs ${darkMode ? 'text-gray-300' : 'text-gray-800'}`}>
                                            {pokemon.nature.nome} <span className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-600'}`}>({pokemon.nature.up && `↑${pokemon.nature.up}`} {pokemon.nature.down && `↓${pokemon.nature.down}`})</span>
                                          </p>
                                        </div>
                                      )}

                                      {/* Atributos */}
                                      {pokemon.attributes && pokemon.baseAttributes && (
                                        <div>
                                          <h4 className={`text-xs font-semibold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Atributos</h4>
                                          <div className="space-y-1">
                                            {[{label:'Saúde',key:'saude'},{label:'Ataque',key:'ataque'},{label:'Defesa',key:'defesa'},{label:'Ataque Especial',key:'ataqueEspecial'},{label:'Defesa Especial',key:'defesaEspecial'},{label:'Velocidade',key:'velocidade'}].map(attr => {
                                              const isUp = pokemon.nature?.up === attr.label
                                              const isDown = pokemon.nature?.down === attr.label
                                              return (
                                                <div key={attr.key} className={`flex justify-between items-center p-1 rounded text-xs ${isUp ? (darkMode ? 'bg-green-900/30' : 'bg-green-50') : isDown ? (darkMode ? 'bg-red-900/30' : 'bg-red-50') : (darkMode ? 'bg-gray-600' : 'bg-gray-100')}`}>
                                                  <span className={darkMode ? 'text-gray-300' : 'text-gray-700'}>{attr.label} {isUp && '↑'} {isDown && '↓'}</span>
                                                  <div className="flex gap-2">
                                                    <span className={darkMode ? 'text-gray-500' : 'text-gray-500'}>Base: {pokemon.baseAttributes[attr.key]}</span>
                                                    <span className={`font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Total: {pokemon.attributes[attr.key]}</span>
                                                  </div>
                                                </div>
                                              )
                                            })}
                                          </div>
                                        </div>
                                      )}

                                      {/* Golpes */}
                                      {pokemon.golpesAprendidos && pokemon.golpesAprendidos.length > 0 && (
                                        <div className="mt-2">
                                          <h4 className={`text-xs font-semibold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Golpes</h4>
                                          <div className="flex flex-wrap gap-1">
                                            {pokemon.golpesAprendidos.map((golpe, idx) => (
                                              <span key={idx} onClick={() => { setSelectedGolpeForDetail(golpe); setShowGolpeDetailModal(true) }}
                                                className={`px-2 py-1 text-xs rounded-lg font-medium cursor-pointer hover:opacity-80 ${darkMode ? 'bg-indigo-900 text-indigo-300' : 'bg-indigo-500 text-white'}`} title="Clique para ver detalhes">
                                                {golpe}
                                              </span>
                                            ))}
                                          </div>
                                        </div>
                                      )}

                                      {/* Botão Enviar para... */}
                                      <button onClick={() => {
                                        setPokemonToSend(pokemon)
                                        setSendPokemonSpecies(pokemon.species || pokemon.name || '')
                                        setSendPokemonNature(pokemon.nature || null)
                                        setSpeciesSearchSend('')
                                        setNatureSearchSend('')
                                        setShowSendToTrainerModal(true)
                                      }} className="w-full mt-3 bg-gradient-to-r from-green-600 to-emerald-600 text-white py-2 rounded-lg hover:from-green-700 hover:to-emerald-700 font-semibold text-sm">
                                        Enviar para...
                                      </button>
                                    </div>
                                  )}
                                </div>
                              )
                            })}
                          </div>
                        )}
                      </div>
                    )
                  })()}
                </div>

                {/* Chat Safari Staff */}
                <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-6`}>
                  <h3 className={`text-xl sm:text-2xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-800'}`}>Chat Safari</h3>

                  {/* Menu de Rolagem Rápida */}
                  <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} rounded-lg p-3 sm:p-4 mb-4`}>
                    <h4 className={`text-sm font-bold mb-3 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                      Rolagem Rápida
                    </h4>
                    <div className="flex flex-col sm:flex-row sm:flex-wrap sm:items-center gap-3">
                      {/* Primeira Parte: Número de dados */}
                      <div className="flex flex-col xs:flex-row xs:items-center gap-2">
                        <span className={`text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'} whitespace-nowrap`}>Quantidade:</span>
                        <div className="flex flex-wrap gap-1">
                          {[1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(num => (
                            <button
                              key={num}
                              onClick={() => setQuickRollNumDice(num)}
                              className={`w-7 h-7 sm:w-8 sm:h-8 rounded text-xs sm:text-sm font-bold transition-colors ${
                                quickRollNumDice === num
                                  ? 'bg-blue-600 text-white'
                                  : darkMode
                                  ? 'bg-gray-600 text-gray-300 hover:bg-gray-500'
                                  : 'bg-white text-gray-700 hover:bg-gray-200'
                              }`}
                            >
                              {num}
                            </button>
                          ))}
                        </div>
                      </div>

                      {/* Segunda Parte: Tipo de dado */}
                      <div className="flex flex-col xs:flex-row xs:items-center gap-2">
                        <span className={`text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'} whitespace-nowrap`}>Dado:</span>
                        <div className="flex flex-wrap gap-1">
                          {['d4', 'd6', 'd8', 'd10', 'd12', 'd20'].map(dice => (
                            <button
                              key={dice}
                              onClick={() => setQuickRollDiceType(dice)}
                              className={`px-2 sm:px-3 h-7 sm:h-8 rounded text-xs sm:text-sm font-bold transition-colors ${
                                quickRollDiceType === dice
                                  ? 'bg-green-600 text-white'
                                  : darkMode
                                  ? 'bg-gray-600 text-gray-300 hover:bg-gray-500'
                                  : 'bg-white text-gray-700 hover:bg-gray-200'
                              }`}
                            >
                              {dice}
                            </button>
                          ))}
                        </div>
                      </div>

                      {/* Botão Rolar */}
                      <button
                        onClick={() => {
                          const diceNotation = `${quickRollNumDice}${quickRollDiceType}`
                          const result = rollDiceExpression(diceNotation)
                          if (result.error) {
                            alert(result.error)
                            return
                          }
                          const newMessage = {
                            username: currentUser?.username || 'Anônimo',
                            text: `🎲 Rolagem Rápida: ${diceNotation}`,
                            timestamp: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
                            isDiceRoll: true,
                            diceResult: result.total,
                            diceDetails: result.formula
                          }
                          setChatMessages(prev => [...prev, newMessage])
                          if (useFirebase) {
                            (async () => {
                              const currentMessages = await loadChatMessages()
                              await saveChatMessages([...(currentMessages || []), newMessage])
                            })().catch(err => console.error('Erro ao salvar mensagem:', err))
                          }
                        }}
                        className="w-full sm:w-auto px-3 sm:px-5 md:px-6 h-8 bg-purple-600 text-white rounded font-bold hover:bg-purple-700 transition-colors text-sm"
                      >
                        🎲 Rolar
                      </button>
                    </div>
                  </div>

                  <div className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-4`}>
                    <p>Use /r ou /roll para rolar dados. Ex: /r 1d20+5</p>
                  </div>
                  <div ref={chatContainerRef} className={`${darkMode ? 'bg-gray-900' : 'bg-gray-50'} rounded-lg p-4 h-96 overflow-y-auto mb-4`}>
                    {chatMessages.length === 0 ? (
                      <p className={`text-center ${darkMode ? 'text-gray-500' : 'text-gray-400'} py-3 sm:py-5 md:py-8`}>Nenhuma mensagem ainda.</p>
                    ) : (
                      <div className="space-y-3">
                        {chatMessages.map((msg, idx) => (
                          <div key={idx} className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg p-3`}>
                            <div className="flex justify-between items-start mb-1">
                              <span className={`font-bold text-sm ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>{msg.username}</span>
                              <span className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>{msg.timestamp}</span>
                            </div>
                            {msg.isDiceRoll ? (
                              <div>
                                <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>{msg.text}</p>
                                <div className={`mt-2 p-2 rounded ${darkMode ? 'bg-green-900' : 'bg-green-100'}`}>
                                  <p className={`font-bold text-lg ${darkMode ? 'text-green-400' : 'text-green-700'}`}>Resultado: {msg.diceResult}</p>
                                  <p className={`text-xs ${darkMode ? 'text-green-300' : 'text-green-600'}`}>{msg.diceDetails}</p>
                                </div>
                              </div>
                            ) : msg.isAction ? (
                              <p className="text-sm font-semibold text-yellow-500">{msg.text}</p>
                            ) : (
                              <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>{msg.text}</p>
                            )}
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                  <div className="flex gap-2">
                    <input type="text" value={chatInput} onChange={(e) => setChatInput(e.target.value)}
                      onKeyPress={(e) => { if (e.key === 'Enter') handleSendMessage() }}
                      placeholder="Digite sua mensagem ou /r 1d20..."
                      className={`flex-1 px-3 py-2 sm:px-4 sm:py-3 rounded-lg border-2 text-sm sm:text-base ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-500' : 'bg-white border-gray-300 text-gray-800 placeholder-gray-400'} focus:outline-none focus:border-blue-500`} />
                    <button onClick={handleSendMessage} className="px-3 sm:px-5 md:px-6 py-2 sm:py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold text-sm sm:text-base">Enviar</button>
                  </div>
                </div>

                {/* Modais da subárea Encontro Safari Staff */}

                {/* Modal Dano/Cura Safari NPC */}
                {showSafariNpcDamageModal && selectedSafariNpcPokemon && (
                  <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => { setShowSafariNpcDamageModal(false); setSafariNpcDamageAmount('') }}>
                    <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-md w-full`} onClick={(e) => e.stopPropagation()}>
                      <div className="p-3 sm:p-5 md:p-6">
                        <div className="flex justify-between items-center mb-6">
                          <h3 className={`text-lg sm:text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Dano/Cura - {selectedSafariNpcPokemon.species}</h3>
                          <button onClick={() => { setShowSafariNpcDamageModal(false); setSafariNpcDamageAmount('') }} className={`${darkMode ? 'text-gray-400 hover:text-white' : 'text-gray-600 hover:text-black'}`}>✕</button>
                        </div>
                        <p className={`text-sm mb-4 ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                          HP: {selectedSafariNpcPokemon.currentHP !== undefined ? selectedSafariNpcPokemon.currentHP : ((3 * selectedSafariNpcPokemon.attributes.saude) + selectedSafariNpcPokemon.level)} / {(3 * selectedSafariNpcPokemon.attributes.saude) + selectedSafariNpcPokemon.level}
                        </p>
                        <input type="number" value={safariNpcDamageAmount} onChange={(e) => setSafariNpcDamageAmount(e.target.value)}
                          placeholder="Quantidade" min="1"
                          className={`w-full px-4 py-3 rounded-lg border-2 mb-4 ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'bg-white border-gray-300 text-gray-800'} focus:outline-none focus:border-blue-500`} />
                        <div className="flex gap-3">
                          <button onClick={() => applySafariNpcDamage(true)} className="flex-1 bg-red-600 text-white py-3 rounded-lg hover:bg-red-700 font-semibold">Dano</button>
                          <button onClick={() => applySafariNpcDamage(false)} className="flex-1 bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 font-semibold">Cura</button>
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                {/* Modal Enviar Para Treinador */}
                {showSendToTrainerModal && pokemonToSend && (
                  <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowSendToTrainerModal(false)}>
                    <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto`} onClick={(e) => e.stopPropagation()}>
                      <div className="p-3 sm:p-5 md:p-6">
                        <div className="flex justify-between items-center mb-6">
                          <h3 className={`text-lg sm:text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Enviar Pokémon para Treinador</h3>
                          <button onClick={() => setShowSendToTrainerModal(false)} className={`${darkMode ? 'text-gray-400 hover:text-white' : 'text-gray-600 hover:text-black'}`}>✕</button>
                        </div>

                        <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3 mb-6">
                          {SAFARI_TRAINERS.map(trainer => (
                            <button key={trainer} onClick={() => sendPokemonToTrainer(trainer)}
                              className={`px-4 py-3 rounded-lg font-semibold transition-all ${darkMode ? 'bg-blue-600 text-white hover:bg-blue-700' : 'bg-blue-500 text-white hover:bg-blue-600'}`}>
                              {trainer}
                            </button>
                          ))}
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                {/* Modal Detalhes do Golpe */}
                {showGolpeDetailModal && selectedGolpeForDetail && (() => {
                  const golpeData = GOLPES_DATA_IMPORTED[selectedGolpeForDetail]
                  return golpeData ? (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowGolpeDetailModal(false)}>
                      <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-2xl w-full`} onClick={(e) => e.stopPropagation()}>
                        <div className="p-3 sm:p-5 md:p-6">
                          <div className="flex justify-between items-center mb-4">
                            <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{selectedGolpeForDetail}</h3>
                            <button onClick={() => setShowGolpeDetailModal(false)} className={`${darkMode ? 'text-gray-400 hover:text-white' : 'text-gray-600 hover:text-black'}`}>✕</button>
                          </div>
                          <div className="space-y-3">
                            <div><span className={`font-semibold ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Tipo:</span> <span className={darkMode ? 'text-white' : 'text-gray-800'}>{golpeData.tipo}</span></div>
                            <div><span className={`font-semibold ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Aptidão:</span> <span className={darkMode ? 'text-white' : 'text-gray-800'}>{golpeData.aptidao}</span></div>
                            <div><span className={`font-semibold ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Dano Basal:</span> <span className={darkMode ? 'text-white' : 'text-gray-800'}>{golpeData.danoBasal || '-'}</span></div>
                            <div><span className={`font-semibold ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Acurácia:</span> <span className={darkMode ? 'text-white' : 'text-gray-800'}>{golpeData.acuracia}</span></div>
                            <div><span className={`font-semibold ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Alcance:</span> <span className={darkMode ? 'text-white' : 'text-gray-800'}>{golpeData.alcance}</span></div>
                            <div><span className={`font-semibold ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Frequência:</span> <span className={darkMode ? 'text-white' : 'text-gray-800'}>{golpeData.frequencia}</span></div>
                            {golpeData.descritores && <div><span className={`font-semibold ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Descritores:</span> <span className={darkMode ? 'text-white' : 'text-gray-800'}>{golpeData.descritores}</span></div>}
                            <div><span className={`font-semibold ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Efeito:</span> <p className={`mt-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>{golpeData.efeito}</p></div>
                          </div>
                        </div>
                      </div>
                    </div>
                  ) : null
                })()}

                {/* Modal Detalhes da Habilidade */}
                {showAbilityModal && selectedAbility && (() => {
                  const abilityData = HABILIDADES_DATA_IMPORTED.find(h => h.nome === selectedAbility)
                  return abilityData ? (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowAbilityModal(false)}>
                      <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-2xl w-full`} onClick={(e) => e.stopPropagation()}>
                        <div className="p-3 sm:p-5 md:p-6">
                          <div className="flex justify-between items-center mb-4">
                            <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{abilityData.nome}</h3>
                            <button onClick={() => setShowAbilityModal(false)} className={`${darkMode ? 'text-gray-400 hover:text-white' : 'text-gray-600 hover:text-black'}`}>✕</button>
                          </div>
                          <div className="space-y-3">
                            <div><span className={`font-semibold ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Descrição:</span> <p className={`mt-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>{abilityData.descricao}</p></div>
                          </div>
                        </div>
                      </div>
                    </div>
                  ) : null
                })()}
              </div>
            )}
          </div>
        </div>

        {accountDataModal}
        {scenarioPopupOverlay}
        {mostrarTriunfosOverlay}
        {pokezapPanel}{pokeAgendaPanel}
        {batalhaChatPanel}
      </>
    )
  }

  // ÁREA ÁRVORE DE APRICORNS M (Apenas Mestre)
  if (currentArea === 'Árvore de Apricorns M' && currentUser.type === 'mestre') {
    return (
      <>
        <div className={`min-h-screen ${mainBgClass}`}>
          {sidebarNav}
          <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-lg`}>
            <div className="max-w-7xl mx-auto px-4 py-4">
              <div className="flex justify-between items-center mb-4">
                <div className="flex items-center gap-3"><button onClick={() => setSidebarOpen(true)} className={`p-2 rounded-lg ${darkMode ? "hover:bg-gray-700 text-gray-400" : "hover:bg-gray-200 text-gray-500"}`}><Menu size={24} /></button><h2 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Árvore de Apricorns M</h2></div>
                <div className="flex gap-2">
                  <button onClick={() => setDarkMode(!darkMode)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-yellow-400' : 'bg-gray-200 text-gray-700'}`}>{darkMode ? <Sun size={20} /> : <Moon size={20} />}</button>
                  {pokezapBtn}{pokeAgendaBtn}{batalhaChatBtn}<button onClick={handleLogout} className="bg-red-500 text-white px-3 sm:px-5 md:px-6 py-2 rounded-lg hover:bg-red-600">Sair</button>
                </div>
              </div>
            </div>
          </div>

          <div className="max-w-7xl mx-auto px-4 py-3 sm:py-5 md:py-8">
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-6`}>
              <h3 className={`text-lg sm:text-xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-800'}`}>Árvore de Apricorns M</h3>

              <div className="flex flex-col sm:flex-row gap-2 sm:gap-3 md:gap-4 mb-6">
                <button
                  onClick={handleProcurarArvores}
                  className="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white px-3 sm:px-5 md:px-6 py-2 rounded-lg font-semibold text-sm sm:text-base"
                >
                  🔍 Procurar Árvores (1d6+1)
                </button>
                <button
                  onClick={handleLimparArvores}
                  className="w-full sm:w-auto bg-red-600 hover:bg-red-700 text-white px-3 sm:px-5 md:px-6 py-2 rounded-lg font-semibold text-sm sm:text-base"
                >
                  🗑️ Limpar Árvores
                </button>
              </div>

              <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-3 sm:p-4 rounded-lg`}>
                <h4 className={`font-bold mb-4 text-base sm:text-lg ${darkMode ? 'text-white' : 'text-gray-800'}`}>Árvores Geradas ({generatedApricornTrees.length})</h4>
                <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2 sm:gap-3 md:gap-4">
                  {generatedApricornTrees.map(tree => (
                    <div key={tree.id} className={`${darkMode ? 'bg-gray-600' : 'bg-white'} p-3 sm:p-4 rounded-lg text-center shadow`}>
                      <img src={tree.image} alt={tree.name} className="w-16 h-16 sm:w-20 sm:h-20 md:w-24 md:h-24 mx-auto mb-2" />
                      <p className={`font-semibold text-xs sm:text-sm ${darkMode ? 'text-white' : 'text-gray-800'}`}>{tree.name}</p>
                      {tree.hasFruit && <p className="text-green-400 text-xs sm:text-sm">🍎 Com frutos</p>}
                      {!tree.hasFruit && <p className="text-gray-400 text-xs sm:text-sm">❌ Sem frutos</p>}
                    </div>
                  ))}
                  {generatedApricornTrees.length === 0 && (
                    <p className="col-span-3 text-center text-gray-400">Nenhuma árvore gerada ainda</p>
                  )}
                </div>
              </div>
            </div>
          </div>
        </div>

        {accountDataModal}
        {scenarioPopupOverlay}
        {mostrarTriunfosOverlay}
        {pokezapPanel}{pokeAgendaPanel}
        {batalhaChatPanel}
      </>
    )
  }

  // ÁREA INTERLÚDIO M (Apenas Mestre)
  if (currentArea === 'Interlúdio M' && currentUser.type === 'mestre') {
    // Lista de treinadores disponíveis
    const trainersForSelection = users.filter(u => u.type === 'treinador')

    // Função para calcular HP máximo do treinador: (level + saude) * 4
    const calculateTrainerMaxHP = (trainerData) => {
      if (!trainerData) return 0
      const saudeAttr = trainerData.attributes?.saude || 10
      const level = trainerData.level || 1
      return (level + saudeAttr) * 4
    }

    // Função para calcular HP máximo de pokémon: (3 x Saúde Total) + Nível
    const calculatePokemonMaxHP = (pokemon) => {
      if (!pokemon) return 0
      const saudeBase = parseInt(pokemon.baseAttributes?.saude) || 0
      const bonusVal = parseInt(pokemon.bonusPoints?.saude) || 0
      const selectedNature = natures.find(n => n.nome === pokemon.nature)
      const isIncreased = selectedNature?.up === 'Saúde'
      const isDecreased = selectedNature?.down === 'Saúde'
      const natureBonus = isIncreased ? 1 : isDecreased ? -1 : 0
      const saudePontos = parseInt(pokemon.levelPoints?.saude) || 0
      const saudeTotal = saudeBase + bonusVal + natureBonus + saudePontos
      return (3 * saudeTotal) + (pokemon.level || 1)
    }

    // Função para obter modificador
    const getTrainerModifier = (value) => Math.floor((value - 10) / 2)

    return (
      <>
        <div className={`min-h-screen ${mainBgClass}`}>
          {sidebarNav}
          <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-lg`}>
            <div className="max-w-7xl mx-auto px-4 py-4">
              <div className="flex justify-between items-center mb-4">
                <div className="flex items-center gap-3"><button onClick={() => setSidebarOpen(true)} className={`p-2 rounded-lg ${darkMode ? "hover:bg-gray-700 text-gray-400" : "hover:bg-gray-200 text-gray-500"}`}><Menu size={24} /></button><h2 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                  Interlúdio M 👑
                </h2></div>
                <div className="flex gap-2">
                  <button onClick={() => setShowRegrasInterludioModal(true)} className={`px-4 py-2 rounded-lg font-semibold ${darkMode ? 'bg-indigo-600 text-white hover:bg-indigo-700' : 'bg-indigo-500 text-white hover:bg-indigo-600'}`}>
                    Regras Interlúdio
                  </button>
                  <button onClick={() => setDarkMode(!darkMode)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-yellow-400' : 'bg-gray-200 text-gray-700'}`}>
                    {darkMode ? <Sun size={20} /> : <Moon size={20} />}
                  </button>
                  {pokezapBtn}{pokeAgendaBtn}{batalhaChatBtn}<button onClick={handleLogout} className="bg-red-500 text-white px-3 sm:px-5 md:px-6 py-2 rounded-lg hover:bg-red-600">Sair</button>
                </div>
              </div>
            </div>
          </div>

          <div className="max-w-7xl mx-auto px-4 py-3 sm:py-5 md:py-8">
            {/* Botões de Seleção de Treinador */}
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-6 mb-8`}>
              <h3 className={`text-lg sm:text-xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                Selecionar Treinador
              </h3>
              <div className="flex flex-wrap gap-3">
                {trainersForSelection.map(trainer => (
                  <button
                    key={trainer.username}
                    onClick={() => setInterludioMSelectedTrainer(interludioMSelectedTrainer === trainer.username ? null : trainer.username)}
                    className={`px-3 sm:px-5 md:px-6 py-3 rounded-lg font-bold transition-all ${
                      interludioMSelectedTrainer === trainer.username
                        ? 'bg-gradient-to-r from-blue-600 to-purple-700 text-white shadow-lg scale-105'
                        : darkMode
                          ? 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                          : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                    }`}
                  >
                    {trainer.username}
                  </button>
                ))}
              </div>
            </div>

            {/* Informações do Treinador Selecionado */}
            {interludioMSelectedTrainer && interludioMTrainerData && (
              <>
                {/* Treinador Info e Time Principal */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4 md:gap-6 mb-8">
                  {/* Coluna Esquerda: Treinador */}
                  <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-6`}>
                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} rounded-lg p-4`}>
                      <h4 className={`text-lg font-bold mb-3 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                        {interludioMSelectedTrainer} <span className={`ml-2 text-sm font-normal ${darkMode ? 'text-green-400' : 'text-green-600'}`}>HP: {interludioMTrainerData.currentHP !== undefined ? interludioMTrainerData.currentHP : calculateTrainerMaxHP(interludioMTrainerData)}/{calculateTrainerMaxHP(interludioMTrainerData)}</span>
                      </h4>

                      {/* Perícias do Treinador */}
                      <div>
                        <h5 className={`text-xs font-semibold mb-2 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                          Perícias:
                        </h5>
                        <div className="grid grid-cols-2 gap-1">
                          {interludioMTrainerData.skills && Object.entries(interludioMTrainerData.skills).map(([attr, skillList]) => {
                            const attrNames = {
                              saude: 'Saúde',
                              ataque: 'Ataque',
                              defesa: 'Defesa',
                              ataqueEspecial: 'Ataque Especial',
                              defesaEspecial: 'Defesa Especial',
                              velocidade: 'Velocidade'
                            }

                            return skillList.map((skill, idx) => {
                              const count = skillList.filter(s => s === skill).length
                              const isFirst = skillList.indexOf(skill) === idx

                              if (!isFirst) return null

                              const modifier = getTrainerModifier(interludioMTrainerData.attributes?.[attr] || 10)

                              return (
                                <div
                                  key={`${attr}-${skill}-${idx}`}
                                  className={`text-xs p-2 rounded ${darkMode ? 'bg-gray-800 text-white' : 'bg-white text-gray-800 border'}`}
                                >
                                  {skill} {count > 1 && `(x${count})`}
                                </div>
                              )
                            })
                          })}
                        </div>
                      </div>
                    </div>
                  </div>

                  {/* Coluna Direita: Time Principal */}
                  <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-6`}>
                    <h4 className={`text-lg font-bold mb-3 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                      Time Principal
                    </h4>

                    {(!interludioMTrainerData.mainTeam || interludioMTrainerData.mainTeam.length === 0) ? (
                      <p className={`text-center ${darkMode ? 'text-gray-400' : 'text-gray-600'} py-4`}>
                        Nenhum Pokémon no time
                      </p>
                    ) : (
                      <div className="space-y-2">
                        {interludioMTrainerData.mainTeam.map((pkmn, idx) => {
                          const maxHP = calculatePokemonMaxHP(pkmn)
                          return (
                            <div
                              key={idx}
                              className={`flex items-center justify-between p-3 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}
                            >
                              <div>
                                <span className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                  {pkmn.nickname || pkmn.species}
                                </span>
                                <span className={`ml-2 text-xs ${darkMode ? 'text-green-400' : 'text-green-600'}`}>
                                  HP: {pkmn.currentHP !== undefined ? pkmn.currentHP : maxHP}/{maxHP}
                                </span>
                                <span className={`ml-2 text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                  Nv. {pkmn.level}
                                </span>
                              </div>
                            </div>
                          )
                        })}
                      </div>
                    )}
                  </div>
                </div>

                {/* MENUS DE INTERLÚDIO M */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-2 sm:gap-3 md:gap-4 mb-8">
                  {/* Menu Int. Talentos */}
                  <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-4`}>
                    <div
                      className="flex justify-between items-center cursor-pointer"
                      onClick={() => setShowIntMTalentosMenu(!showIntMTalentosMenu)}
                    >
                      <h3 className={`text-lg font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                        Int. Talentos
                      </h3>
                      <div className="flex items-center gap-2">
                        {showIntMTalentosMenu ? <ChevronUp size={20} className={darkMode ? 'text-gray-400' : 'text-gray-600'} /> : <ChevronDown size={20} className={darkMode ? 'text-gray-400' : 'text-gray-600'} />}
                      </div>
                    </div>

                    {showIntMTalentosMenu && (
                      <div className={`${darkMode ? 'bg-gray-900' : 'bg-gray-50'} rounded-lg p-3 mt-3`}>
                        {(!interludioMTrainerData.talentinhos || interludioMTrainerData.talentinhos.length === 0) ? (
                          <p className={`text-center text-sm ${darkMode ? 'text-gray-500' : 'text-gray-400'} py-4`}>
                            Nenhum talento em jogo
                          </p>
                        ) : (
                          <div className="space-y-2">
                            {interludioMTrainerData.talentinhos.map((talentinho, idx) => (
                              <div
                                key={idx}
                                className={`p-3 rounded-lg ${darkMode ? 'bg-gray-800' : 'bg-white'} border ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}
                              >
                                <div className="flex items-start justify-between gap-2 mb-1">
                                  <span className={`font-semibold text-sm ${darkMode ? 'text-purple-400' : 'text-purple-600'}`}>
                                    {talentinho.nome}
                                  </span>
                                </div>
                                <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'} font-mono`}>
                                  {talentinho.expressao}
                                </p>
                              </div>
                            ))}
                          </div>
                        )}
                      </div>
                    )}
                  </div>

                  {/* Menu Int. L.U. */}
                  <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-4`}>
                    <div
                      className="flex justify-between items-center cursor-pointer"
                      onClick={() => setShowIntMLUMenu(!showIntMLUMenu)}
                    >
                      <h3 className={`text-lg font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                        Int. L.U.
                      </h3>
                      <div className="flex items-center gap-2">
                        {showIntMLUMenu ? <ChevronUp size={20} className={darkMode ? 'text-gray-400' : 'text-gray-600'} /> : <ChevronDown size={20} className={darkMode ? 'text-gray-400' : 'text-gray-600'} />}
                      </div>
                    </div>

                    {showIntMLUMenu && (
                      <div className={`${darkMode ? 'bg-gray-900' : 'bg-gray-50'} rounded-lg p-3 mt-3`}>
                        {(() => {
                          // Coletar itens com limite de uso do treinador
                          const trainerData = interludioMTrainerData
                          const limitesItems = []

                          // Modificadores com limite de uso
                          if (trainerData.customModifiers) {
                            trainerData.customModifiers.forEach((mod, idx) => {
                              if (mod.usosACadaXLvl) {
                                const totalUsos = Math.floor((trainerData.level || 1) / parseInt(mod.usosACadaXLvl))
                                const usosAtuais = trainerData.modifierUsosAtuais?.[idx] !== undefined ? trainerData.modifierUsosAtuais[idx] : totalUsos
                                limitesItems.push({
                                  nome: mod.nome,
                                  tipo: 'modificador',
                                  atual: usosAtuais,
                                  total: totalUsos
                                })
                              }
                            })
                          }

                          // Talentinhos com limite de uso
                          if (trainerData.talentinhos) {
                            trainerData.talentinhos.forEach((tal, idx) => {
                              if (tal.usosACadaXLvl) {
                                const totalUsos = Math.floor((trainerData.level || 1) / parseInt(tal.usosACadaXLvl))
                                const usosAtuais = trainerData.talentinhoUsosAtuais?.[idx] !== undefined ? trainerData.talentinhoUsosAtuais[idx] : totalUsos
                                limitesItems.push({
                                  nome: tal.nome,
                                  tipo: 'talentinho',
                                  atual: usosAtuais,
                                  total: totalUsos
                                })
                              }
                            })
                          }

                          // Limites personalizados
                          if (trainerData.limitesUsoPersonalizados) {
                            trainerData.limitesUsoPersonalizados.forEach((limite, idx) => {
                              const totalUsos = Math.floor((trainerData.level || 1) / parseInt(limite.usosACadaXLvl || 1))
                              const usosAtuais = trainerData.limitesUsoPersonalizadosUsosAtuais?.[idx] !== undefined ? trainerData.limitesUsoPersonalizadosUsosAtuais[idx] : totalUsos
                              limitesItems.push({
                                nome: limite.nome,
                                tipo: 'personalizado',
                                atual: usosAtuais,
                                total: totalUsos,
                                fontes: limite.fontes
                              })
                            })
                          }

                          if (limitesItems.length === 0) {
                            return (
                              <p className={`text-center text-sm ${darkMode ? 'text-gray-500' : 'text-gray-400'} py-4`}>
                                Nenhum limite de uso
                              </p>
                            )
                          }

                          return (
                            <div className="grid grid-cols-1 gap-2">
                              {limitesItems.map((item, idx) => (
                                <div
                                  key={idx}
                                  className={`p-3 rounded-lg ${darkMode ? 'bg-gray-800' : 'bg-white'} border ${
                                    item.atual === 0
                                      ? darkMode ? 'border-red-600' : 'border-red-400'
                                      : darkMode ? 'border-gray-700' : 'border-gray-200'
                                  }`}
                                >
                                  <div className="flex items-center justify-between">
                                    <span className={`font-semibold text-sm ${
                                      item.tipo === 'modificador'
                                        ? darkMode ? 'text-blue-400' : 'text-blue-600'
                                        : item.tipo === 'talentinho'
                                          ? darkMode ? 'text-purple-400' : 'text-purple-600'
                                          : darkMode ? 'text-cyan-400' : 'text-cyan-600'
                                    }`}>
                                      {item.nome}
                                    </span>
                                    <span className={`text-lg font-bold ${
                                      item.atual === 0
                                        ? darkMode ? 'text-red-400' : 'text-red-600'
                                        : darkMode ? 'text-white' : 'text-gray-800'
                                    }`}>
                                      {item.atual}/{item.total}
                                    </span>
                                  </div>
                                </div>
                              ))}
                            </div>
                          )
                        })()}
                      </div>
                    )}
                  </div>

                  {/* Menu Pokébola, Vai! */}
                  <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-4`}>
                    <div
                      className="flex justify-between items-center cursor-pointer"
                      onClick={() => setShowIntMPokebolVaiMenu(!showIntMPokebolVaiMenu)}
                    >
                      <h3 className={`text-lg font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                        Pokébola, Vai!
                      </h3>
                      {showIntMPokebolVaiMenu ? <ChevronUp size={20} className={darkMode ? 'text-gray-400' : 'text-gray-600'} /> : <ChevronDown size={20} className={darkMode ? 'text-gray-400' : 'text-gray-600'} />}
                    </div>

                    {showIntMPokebolVaiMenu && (
                      <div className={`${darkMode ? 'bg-gray-900' : 'bg-gray-50'} rounded-lg p-3 mt-3`}>
                        {(() => {
                          const trainerKeyItems = interludioMTrainerData.keyItems || []
                          const pokeballs = trainerKeyItems.filter(item => POKEBALL_MODIFIERS[item.name])

                          if (pokeballs.length === 0) {
                            return (
                              <p className={`text-center text-sm ${darkMode ? 'text-gray-500' : 'text-gray-400'} py-4`}>
                                Nenhuma pokébola disponível
                              </p>
                            )
                          }

                          return (
                            <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2">
                              {pokeballs.map((item, idx) => (
                                <div
                                  key={idx}
                                  className={`relative flex flex-col items-center p-2 rounded-lg ${darkMode ? 'bg-gray-800' : 'bg-white'} ${item.quantity === 0 ? 'opacity-50' : ''}`}
                                  title={item.name}
                                >
                                  <img
                                    src={`/pokeballs/${item.name.toLowerCase().replace(' ', '')}.png`}
                                    alt={item.name}
                                    className="w-10 h-10 object-contain"
                                    onError={(e) => {
                                      e.target.style.display = 'none'
                                      e.target.nextSibling.style.display = 'flex'
                                    }}
                                  />
                                  <div className="w-10 h-10 hidden items-center justify-center text-lg sm:text-xl">
                                    O
                                  </div>
                                  <span className={`text-[9px] font-semibold text-center mt-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                    {item.name}
                                  </span>
                                  <div className={`absolute -top-1 -right-1 w-4 h-4 rounded-full flex items-center justify-center text-[9px] font-bold ${item.quantity > 0 ? (darkMode ? 'bg-blue-600 text-white' : 'bg-blue-500 text-white') : (darkMode ? 'bg-gray-600 text-gray-400' : 'bg-gray-400 text-gray-600')}`}>
                                    {item.quantity}
                                  </div>
                                </div>
                              ))}
                            </div>
                          )
                        })()}
                      </div>
                    )}
                  </div>

                  {/* Menu Cura no Interlúdio */}
                  <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-4`}>
                    <div
                      className="flex justify-between items-center cursor-pointer"
                      onClick={() => setShowIntMCuraMenu(!showIntMCuraMenu)}
                    >
                      <h3 className={`text-lg font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                        Cura no Interlúdio
                      </h3>
                      {showIntMCuraMenu ? <ChevronUp size={20} className={darkMode ? 'text-gray-400' : 'text-gray-600'} /> : <ChevronDown size={20} className={darkMode ? 'text-gray-400' : 'text-gray-600'} />}
                    </div>

                    {showIntMCuraMenu && (
                      <div className={`${darkMode ? 'bg-gray-900' : 'bg-gray-50'} rounded-lg p-3 mt-3`}>
                        {(() => {
                          const trainerKeyItems = interludioMTrainerData.keyItems || []
                          const healingItems = trainerKeyItems.filter(item => {
                            const curaItem = POKELOJA_DATA['Cura']?.find(i => i.name === item.name)
                            if (!curaItem) return false
                            const hasDiceExpression = /\d+d\d+/i.test(curaItem.description)
                            return hasDiceExpression && item.quantity > 0
                          })

                          if (healingItems.length === 0) {
                            return (
                              <p className={`text-center text-sm ${darkMode ? 'text-gray-500' : 'text-gray-400'} py-4`}>
                                Nenhum item de cura com dados disponível
                              </p>
                            )
                          }

                          return (
                            <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2">
                              {healingItems.map((item, idx) => {
                                const curaItem = POKELOJA_DATA['Cura']?.find(i => i.name === item.name)
                                return (
                                  <div
                                    key={idx}
                                    className={`relative flex flex-col items-center p-2 rounded-lg ${darkMode ? 'bg-gray-800' : 'bg-white'}`}
                                    title={item.name}
                                  >
                                    <img
                                      src={curaItem?.image || `/pokeballs/${item.name.toLowerCase().replace(/ /g, '')}.png`}
                                      alt={item.name}
                                      className="w-10 h-10 object-contain"
                                      onError={(e) => {
                                        e.target.style.display = 'none'
                                        e.target.nextSibling.style.display = 'flex'
                                      }}
                                    />
                                    <div className="w-10 h-10 hidden items-center justify-center text-lg sm:text-xl">
                                      +
                                    </div>
                                    <span className={`text-[9px] font-semibold text-center mt-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                      {item.name}
                                    </span>
                                    <div className={`absolute -top-1 -right-1 w-4 h-4 rounded-full flex items-center justify-center text-[9px] font-bold ${darkMode ? 'bg-green-600 text-white' : 'bg-green-500 text-white'}`}>
                                      {item.quantity}
                                    </div>
                                  </div>
                                )
                              })}
                            </div>
                          )
                        })()}
                      </div>
                    )}
                  </div>
                </div>
              </>
            )}

            {/* Apps de Interlúdio M */}
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-8 mb-8`}>
              <h3 className={`text-xl sm:text-2xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                Apps de Interlúdio M
              </h3>

              {/* Botões para selecionar o app */}
              <div className="flex gap-2 sm:gap-3 md:gap-4 mb-6 justify-center">
                <button
                  onClick={() => setInterludioMApp(interludioMApp === 'combate' ? null : 'combate')}
                  className={`px-3 sm:px-5 md:px-6 py-3 rounded-lg font-bold text-lg transition-all ${
                    interludioMApp === 'combate'
                      ? 'bg-red-600 text-white shadow-lg scale-105'
                      : darkMode
                        ? 'bg-gray-700 text-gray-300 hover:bg-red-600 hover:text-white'
                        : 'bg-gray-200 text-gray-700 hover:bg-red-500 hover:text-white'
                  }`}
                >
                  Combate
                </button>
                <button
                  onClick={() => setInterludioMApp(interludioMApp === 'concurso' ? null : 'concurso')}
                  className={`px-3 sm:px-5 md:px-6 py-3 rounded-lg font-bold text-lg transition-all ${
                    interludioMApp === 'concurso'
                      ? 'bg-purple-600 text-white shadow-lg scale-105'
                      : darkMode
                        ? 'bg-gray-700 text-gray-300 hover:bg-purple-600 hover:text-white'
                        : 'bg-gray-200 text-gray-700 hover:bg-purple-500 hover:text-white'
                  }`}
                >
                  Concurso
                </button>
              </div>

              {/* App de Combate */}
              {interludioMApp === 'combate' && (
                <div className={`${darkMode ? 'bg-gray-900' : 'bg-gray-50'} rounded-xl p-3 sm:p-5 md:p-6`}>
                  <CombateInterludioApp darkMode={darkMode} />
                </div>
              )}

              {/* App de Concurso */}
              {interludioMApp === 'concurso' && (
                <div className={`${darkMode ? 'bg-gray-900' : 'bg-gray-50'} rounded-xl p-3 sm:p-5 md:p-6`}>
                  <ConcursoInterludioApp darkMode={darkMode} />
                </div>
              )}

              {/* Mensagem quando nenhum app está selecionado */}
              {!interludioMApp && (
                <p className={`text-lg ${darkMode ? 'text-gray-400' : 'text-gray-600'} text-center py-4`}>
                  Selecione um app acima para começar
                </p>
              )}
            </div>

            {/* Chat */}
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl p-3 sm:p-5 md:p-8`}>
              <h3 className={`text-xl sm:text-2xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                Chat & Rolagem de Dados
              </h3>

              {/* Menu de Rolagem Rápida */}
              <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} rounded-lg p-3 sm:p-4 mb-4`}>
                <h4 className={`text-sm font-bold mb-3 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                  Rolagem Rápida
                </h4>
                <div className="flex flex-col sm:flex-row sm:flex-wrap sm:items-center gap-3">
                  {/* Primeira Parte: Número de dados */}
                  <div className="flex flex-col xs:flex-row xs:items-center gap-2">
                    <span className={`text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'} whitespace-nowrap`}>Quantidade:</span>
                    <div className="flex flex-wrap gap-1">
                      {[1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(num => (
                        <button
                          key={num}
                          onClick={() => setQuickRollNumDice(num)}
                          className={`w-7 h-7 sm:w-8 sm:h-8 rounded text-xs sm:text-sm font-bold transition-colors ${
                            quickRollNumDice === num
                              ? 'bg-blue-600 text-white'
                              : darkMode
                              ? 'bg-gray-600 text-gray-300 hover:bg-gray-500'
                              : 'bg-white text-gray-700 hover:bg-gray-200'
                          }`}
                        >
                          {num}
                        </button>
                      ))}
                    </div>
                  </div>

                  {/* Segunda Parte: Tipo de dado */}
                  <div className="flex flex-col xs:flex-row xs:items-center gap-2">
                    <span className={`text-xs font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'} whitespace-nowrap`}>Dado:</span>
                    <div className="flex flex-wrap gap-1">
                      {['d4', 'd6', 'd8', 'd10', 'd12', 'd20'].map(dice => (
                        <button
                          key={dice}
                          onClick={() => setQuickRollDiceType(dice)}
                          className={`px-2.5 h-7 sm:px-3 sm:h-8 rounded text-xs sm:text-sm font-bold transition-colors ${
                            quickRollDiceType === dice
                              ? 'bg-green-600 text-white'
                              : darkMode
                              ? 'bg-gray-600 text-gray-300 hover:bg-gray-500'
                              : 'bg-white text-gray-700 hover:bg-gray-200'
                          }`}
                        >
                          {dice}
                        </button>
                      ))}
                    </div>
                  </div>

                  {/* Botão Rolar */}
                  <button
                    onClick={() => {
                      const diceNotation = `${quickRollNumDice}${quickRollDiceType}`
                      const result = rollDiceExpression(diceNotation)
                      if (result.error) {
                        alert(result.error)
                        return
                      }
                      const newMessage = {
                        username: currentUser?.username || 'Anônimo',
                        text: `🎲 Rolagem Rápida: ${diceNotation}`,
                        timestamp: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
                        isDiceRoll: true,
                        diceResult: result.total,
                        diceDetails: result.formula
                      }
                      setChatMessages(prev => [...prev, newMessage])
                      if (useFirebase) {
                        (async () => {
                          const currentMessages = await loadChatMessages()
                          await saveChatMessages([...(currentMessages || []), newMessage])
                        })().catch(err => console.error('Erro ao salvar mensagem:', err))
                      }
                    }}
                    className="px-3 sm:px-5 md:px-6 h-7 sm:h-8 bg-purple-600 text-white rounded font-bold hover:bg-purple-700 transition-colors text-xs sm:text-sm"
                  >
                    🎲 Rolar
                  </button>
                </div>
              </div>

              <p className={`text-sm mb-4 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                Use /r ou /roll para rolar dados. Exemplo: /r 1d20+5, /roll 2d6
              </p>

              {/* Área de Mensagens */}
              <div ref={chatContainerRef} className={`${darkMode ? 'bg-gray-900' : 'bg-gray-50'} rounded-lg p-4 h-96 overflow-y-auto mb-4`}>
                {chatMessages.length === 0 ? (
                  <p className={`text-center ${darkMode ? 'text-gray-500' : 'text-gray-400'} py-3 sm:py-5 md:py-8`}>
                    Nenhuma mensagem ainda. Seja o primeiro a falar!
                  </p>
                ) : (
                  <div className="space-y-3">
                    {chatMessages.map((msg, idx) => (
                      <div key={idx} className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg p-3`}>
                        <div className="flex justify-between items-start mb-1">
                          <span className={`font-bold text-sm ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>
                            {msg.username}
                          </span>
                          <span className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                            {msg.timestamp}
                          </span>
                        </div>
                        {msg.isDiceRoll ? (
                          <div>
                            <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                              {msg.text}
                            </p>
                            <div className={`mt-2 p-2 rounded ${darkMode ? 'bg-green-900' : 'bg-green-100'}`}>
                              <p className={`font-bold text-lg ${darkMode ? 'text-green-400' : 'text-green-700'}`}>
                                Resultado: {msg.diceResult}
                              </p>
                              <p className={`text-xs ${darkMode ? 'text-green-300' : 'text-green-600'}`}>
                                {msg.diceDetails}
                              </p>
                            </div>
                          </div>
                        ) : msg.isAction ? (
                          <p className={`text-sm font-semibold text-yellow-500`}>
                            {msg.text}
                          </p>
                        ) : (
                          <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                            {msg.text}
                          </p>
                        )}
                      </div>
                    ))}
                  </div>
                )}
              </div>

              {/* Input de Mensagem */}
              <div className="flex gap-2">
                <input
                  type="text"
                  value={chatInput}
                  onChange={(e) => setChatInput(e.target.value)}
                  onKeyPress={(e) => {
                    if (e.key === 'Enter') {
                      handleSendMessage()
                    }
                  }}
                  placeholder="Digite sua mensagem, 1d20+@MAE, ou /r 1d20..."
                  className={`flex-1 px-3 py-2 sm:px-4 sm:py-3 rounded-lg border-2 text-sm sm:text-base ${
                    darkMode
                      ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-500'
                      : 'bg-white border-gray-300 text-gray-800 placeholder-gray-400'
                  } focus:outline-none focus:border-blue-500`}
                />
                <button
                  onClick={handleSendMessage}
                  className="px-3 sm:px-5 md:px-6 py-2 sm:py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold text-sm sm:text-base"
                >
                  Enviar
                </button>
              </div>
            </div>
          </div>
        </div>

        {/* MODAL DE REGRAS DO INTERLÚDIO - Área Mestre */}
        {showRegrasInterludioModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowRegrasInterludioModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-3 sm:p-5 md:p-6 rounded-2xl shadow-2xl max-w-sm sm:max-w-2xl md:max-w-4xl w-full max-h-[90vh] overflow-y-auto`} onClick={(e) => e.stopPropagation()}>
              <div className="flex justify-between items-center mb-6 sticky top-0 pb-4 border-b ${darkMode ? 'border-gray-700 bg-gray-800' : 'border-gray-200 bg-white'}">
                <h3 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Regras do Interlúdio</h3>
                <button onClick={() => setShowRegrasInterludioModal(false)} className={darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}><X size={24} /></button>
              </div>

              <div className={`space-y-6 text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                {/* Explicação */}
                <div>
                  <h4 className={`text-lg font-bold mb-2 ${darkMode ? 'text-indigo-400' : 'text-indigo-600'}`}>Explicação</h4>
                  <p><strong>Verdade</strong> - a verdade sobre o mundo é algo que seja alcançável e plausível, para o mundo e nível dos personagens.</p>
                  <p className="mt-2"><strong>Jogador-narrador (JN)</strong> - aquele que vai narrar e jogar. Contará seus feitos em tempo real. Gastará seus pontos de narração para contar sua história.</p>
                  <p className="mt-2"><strong>Roteiristas (RT)</strong> - aqueles que vão ouvir a história e adicionar complicações, ajudas, npcs, pokémons... no caminho do JN. Gastarão pontos de roteiro.</p>
                  <p className="mt-2"><strong>Ponto de Narração</strong> - pontos usados para suas cenas.</p>
                  <p className="mt-2"><strong>Pontos de Roteiro</strong> - pontos usados para adicionar elementos nas cenas.</p>
                </div>

                {/* Mais a fundo */}
                <div>
                  <h4 className={`text-lg font-bold mb-2 ${darkMode ? 'text-indigo-400' : 'text-indigo-600'}`}>Mais a fundo</h4>
                  <p><strong>Verdade:</strong> O JN, ou o grupo, cria a verdade e não poderá alterá-la.</p>
                  <p className="mt-2"><strong>Pontos de Narração:</strong> O JN, ou o grupo, tem 6pts de narração.</p>
                </div>

                {/* Uso de Pontos de Narração */}
                <div>
                  <h4 className={`text-lg font-bold mb-2 ${darkMode ? 'text-yellow-400' : 'text-yellow-600'}`}>Uso de Pontos de Narração</h4>

                  <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-4 rounded-lg mb-3`}>
                    <h5 className="font-bold mb-2">Concursos e Torneios (3pts)</h5>
                    <ul className="list-disc list-inside space-y-1 ml-2">
                      <li>Gastam 1 semana no mínimo, tem 1d8-nºJN participantes e o prêmio é de 1º-1000₽, 2º-500₽, 3º-250₽.</li>
                      <li>A cada 3 dias a mais se adiciona 1d4 participantes.</li>
                      <li>A cada 3 dias a mais se adiciona 50% no valor da premiação.</li>
                      <li>Com 1 semana a mais, um item aleatório também entra como premiação.</li>
                      <li>Com 2 semanas a mais, o JN pode escolher a classe do item.</li>
                      <li>Com 3 semanas a mais o JN pode escolher o Item.</li>
                      <li>Em TORNEIOS, feitos de interlúdio, as regras sempre vão ser na inscrição de até 3 pkms.</li>
                      <li>O level dos pokémons variam em 5, pra menos ou mais, do pokémon mais forte do JN.</li>
                    </ul>
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-3 rounded-lg`}>
                      <p><strong>Procurar pkm (1pt):</strong> 4 dias procurando pokémon, cada dia te dá direito a 1d6+1 pokémons gerados.</p>
                    </div>
                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-3 rounded-lg`}>
                      <p><strong>Batalha com treinador (1pt):</strong> Você pode batalhar com 1d4 treinadores, cada treinador possui 1d4+1 pokémons.</p>
                    </div>
                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-3 rounded-lg`}>
                      <p><strong>Catalogar pokémon (1pt):</strong> Você pode ter gerado 1d8+2 pkms, o que não implica na certeza de pkms novos.</p>
                    </div>
                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-3 rounded-lg`}>
                      <p><strong>Adicionar recompensa (3pts):</strong> O jogador deve escolher 5 elementos do obstáculo ou quest, e a recompensa extra será escolhida rolando 1d5.</p>
                    </div>
                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-3 rounded-lg`}>
                      <p><strong>Em busca da Lenda (5pts):</strong> O jogador vai contar como conseguiu ou quase conseguiu uma pista sobre um pokémon lendário. Já tendo a pista, pode ir atrás do lendário.</p>
                    </div>
                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-3 rounded-lg`}>
                      <p><strong>Em busca do alvo (4pts/2pts):</strong> O jogador pode buscar informações sobre um pokémon específico. Se já tem a localização, só gasta 2pts.</p>
                    </div>
                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-3 rounded-lg`}>
                      <p><strong>Sidequest (5pts):</strong> O jogador pode criar uma quest com recompensa de itens, pokémoedas ou pokémons (limite de 1pkm por quest).</p>
                    </div>
                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-3 rounded-lg`}>
                      <p><strong>NPC aleatório (1pt):</strong> Pode gerar um NPC aleatório no gerador de NPC, level máximo não pode passar o seu próprio.</p>
                    </div>
                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-3 rounded-lg`}>
                      <p><strong>NPC específico (3pts):</strong> Pode escolher as classes/subclasses do NPC, level máximo não pode passar o seu próprio.</p>
                    </div>
                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-3 rounded-lg`}>
                      <p><strong>Batalha de Ginásio (3pts):</strong> Ir para uma batalha de ginásio. O líder tem 1d4+2 pkms.</p>
                    </div>
                  </div>
                </div>

                {/* Encontro Pokémon */}
                <div>
                  <h4 className={`text-lg font-bold mb-2 ${darkMode ? 'text-green-400' : 'text-green-600'}`}>Encontro Pokémon</h4>

                  <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-4 rounded-lg mb-3`}>
                    <h5 className="font-bold mb-2">Mapa</h5>
                    <ul className="list-disc list-inside space-y-1 ml-2">
                      <li>O JN anda pelo mapa após um dos RT posicionarem os pokémons gerados.</li>
                      <li>O JN tem 3 turnos antes que os pokémons se movam.</li>
                      <li>Caso um pokémon selvagem se mova do lado da borda, o RT joga 1d2: 1-sai do mapa; 2-se move para dentro do mapa.</li>
                      <li>Caso o JN pare seu movimento ao lado do pkm selvagem, o RT joga 1d20: 1-10 não percebe nada; 11-20 percebeu o pkm selvagem.</li>
                    </ul>
                  </div>

                  <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-4 rounded-lg`}>
                    <h5 className="font-bold mb-2">App de chance de encontro</h5>
                    <p>O RT usa o app de chance de encontro de acordo com as ações do JN. Um número de vezes igual ao valor do dado.</p>
                  </div>
                </div>

                {/* Pontos de Roteiro */}
                <div>
                  <h4 className={`text-lg font-bold mb-2 ${darkMode ? 'text-purple-400' : 'text-purple-600'}`}>Pontos de Roteiro</h4>
                  <p className="mb-3">O RT tem 4pts de roteiro.</p>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-3 rounded-lg`}>
                      <p className="font-bold mb-1">Adicionar NPC:</p>
                      <ul className="list-disc list-inside ml-2">
                        <li>NPC treinador: 1pt a cada 3 pkms (limite 6pkms)</li>
                        <li>NPC de história: 1pt</li>
                        <li>NPC vilão: 3pts a cada 3 pkms (limite 6pkms)</li>
                      </ul>
                    </div>
                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-3 rounded-lg`}>
                      <p className="font-bold mb-1">Adicionar Obstáculo:</p>
                      <ul className="list-disc list-inside ml-2">
                        <li>Fácil: 1pt (recompensa até 250₽)</li>
                        <li>Médio: 2pts (recompensa até 500₽)</li>
                        <li>Difícil: 3pts (recompensa até 800₽)</li>
                      </ul>
                    </div>
                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-3 rounded-lg`}>
                      <p className="font-bold mb-1">Adicionar Quest:</p>
                      <ul className="list-disc list-inside ml-2">
                        <li>Fácil: 2pts (recompensa até 450₽)</li>
                        <li>Médio: 3pts (recompensa até 750₽)</li>
                        <li>Difícil: 4pts (recompensa até 1000₽)</li>
                      </ul>
                    </div>
                  </div>
                </div>

                {/* Level de NPCs */}
                <div>
                  <h4 className={`text-lg font-bold mb-2 ${darkMode ? 'text-red-400' : 'text-red-600'}`}>Level de NPCs e PKMs</h4>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-3 rounded-lg`}>
                      <p className="font-bold mb-1">Level de NPCs:</p>
                      <ul className="list-disc list-inside ml-2">
                        <li>Treinador: 5 levels a mais/menos do que o JN</li>
                        <li>Vilão: de 5 a 15 levels a mais do que o JN</li>
                        <li>Líder de Ginásio: entre level 35 a 50</li>
                      </ul>
                    </div>
                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-3 rounded-lg`}>
                      <p className="font-bold mb-1">Level de PKMs de NPCs:</p>
                      <ul className="list-disc list-inside ml-2">
                        <li>Treinador: 5 levels a mais/menos do que o pkm mais forte do JN</li>
                        <li>Vilão: 5-10 leveis a mais do pkm mais forte do JN</li>
                        <li>Líder de Ginásio: até 5 levels a mais que o mais forte do JN</li>
                      </ul>
                    </div>
                  </div>
                </div>

                {/* Ganho de ₽ */}
                <div>
                  <h4 className={`text-lg font-bold mb-2 ${darkMode ? 'text-amber-400' : 'text-amber-600'}`}>Ganho de ₽ por Batalha</h4>
                  <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} p-4 rounded-lg`}>
                    <ul className="list-disc list-inside space-y-1">
                      <li><strong>Treinador:</strong> 25x o level do treinador, aumentando o valor final em 50% por pokémon adicionado.</li>
                      <li><strong>Vilão:</strong> 50x o level do vilão, aumentando o valor final em 50% por pokémon adicionado.</li>
                      <li><strong>Líder de Ginásio:</strong> 75x o level do líder.</li>
                    </ul>
                  </div>
                </div>
              </div>

              <div className="mt-6 pt-4 border-t ${darkMode ? 'border-gray-700' : 'border-gray-200'}">
                <button onClick={() => setShowRegrasInterludioModal(false)} className={`w-full py-3 rounded-lg font-semibold ${darkMode ? 'bg-indigo-600 text-white hover:bg-indigo-700' : 'bg-indigo-500 text-white hover:bg-indigo-600'}`}>
                  Fechar
                </button>
              </div>
            </div>
          </div>
        )}

        {accountDataModal}
        {scenarioPopupOverlay}
        {mostrarTriunfosOverlay}
        {pokezapPanel}{pokeAgendaPanel}
        {batalhaChatPanel}
      </>
    )
  }

  // ===== ÁREA BATALHA GAME BOY (Treinador) =====
  if (currentUser.type === 'treinador' && currentArea === 'Batalha Game Boy') {
    // Verificar se o treinador tem permissão
    const userAllowed = gbBattleData.allowedUsers?.[currentUser.username]
    if (!userAllowed) {
      // MODO ESPECTADOR
      const gbAP_spec = gbBattleData.activePokemon || {}
      const redTeamUsers = Object.entries(gbBattleData.allowedUsers || {}).filter(([, c]) => c === 'red').map(([n]) => n)
      const blueTeamUsers = Object.entries(gbBattleData.allowedUsers || {}).filter(([, c]) => c === 'blue').map(([n]) => n)
      const redActivePokemon = redTeamUsers.flatMap(u => gbAP_spec[u] || [])
      const blueActivePokemon = blueTeamUsers.flatMap(u => gbAP_spec[u] || [])
      const npcActivePokemon_spec = gbAP_spec['__npc__'] || []
      const allOpponents_spec = [...blueActivePokemon, ...npcActivePokemon_spec]
      return (
        <>
          <div className={`min-h-screen ${mainBgClass}`}>
            {sidebarNav}
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-lg`}>
              <div className="max-w-7xl mx-auto px-4 py-4">
                <div className="flex justify-between items-center mb-4">
                  <div className="flex items-center gap-3"><button onClick={() => setSidebarOpen(true)} className={`p-2 rounded-lg ${darkMode ? "hover:bg-gray-700 text-gray-400" : "hover:bg-gray-200 text-gray-500"}`}><Menu size={24} /></button><h2 className={`text-lg sm:text-xl md:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Batalha Game Boy</h2></div>
                  <div className="flex gap-1.5 sm:gap-2 items-center flex-shrink-0">
                    <span className="text-xs px-3 py-1 rounded-full font-bold bg-red-600 text-white animate-pulse">Não toque em nada!</span>
                    <button onClick={() => setShowAccountDataModal(true)} className={`p-1.5 sm:p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-200 text-gray-700'}`} title="Dados da Conta"><ArrowDownUp size={18} className="sm:w-5 sm:h-5" /></button>
                    <button onClick={() => setDarkMode(!darkMode)} className={`p-1.5 sm:p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-yellow-400' : 'bg-gray-200 text-gray-700'}`}>{darkMode ? <Sun size={18} className="sm:w-5 sm:h-5" /> : <Moon size={18} className="sm:w-5 sm:h-5" />}</button>
                    {pokezapBtn}{pokeAgendaBtn}{batalhaChatBtn}<button onClick={handleLogout} className="bg-red-500 text-white px-2 sm:px-5 md:px-6 py-1.5 sm:py-2 rounded-lg hover:bg-red-600 text-sm sm:text-base">Sair</button>
                  </div>
                </div>
              </div>
            </div>
            <div className="max-w-4xl mx-auto px-4 py-3 sm:py-5">
              {/* GAME BOY COLOR FRAME — Espectador */}
              <div className="rounded-3xl p-3 sm:p-4 shadow-2xl" style={{ background: 'linear-gradient(145deg, #6A0DAD, #4B0082, #3A0068)' }}>
                <div className="text-center mb-2">
                  <span className="text-xs font-bold tracking-widest" style={{ color: '#C8A2C8' }}>GAME BOY COLOR</span>
                </div>
                <div className="rounded-xl p-3 sm:p-4 relative" style={{ background: '#b0b0b0', border: '4px solid #707070', minHeight: '280px' }}>
                  {/* Time Azul + NPCs — canto superior direito */}
                  {allOpponents_spec.length > 0 && (
                    <div className="absolute top-2 right-2 sm:top-3 sm:right-3">
                      {allOpponents_spec.map((pkmn, idx) => (
                        <div key={idx} className="mb-2 p-1.5 rounded-lg flex items-center gap-2" style={{ background: 'rgba(0,0,0,0.15)', maxWidth: '160px' }}>
                          {pkmn.imageUrl && <img src={pkmn.imageUrl} alt={pkmn.nome || pkmn.especie} className="w-[62px] h-[62px] object-contain flex-shrink-0" style={{ imageRendering: 'pixelated' }} />}
                          <div className="flex-1 min-w-0">
                            <p className="text-[10px] font-bold truncate" style={{ color: '#222222' }}>{pkmn.nome || pkmn.especie}</p>
                            <div className="w-full h-2 rounded-full mt-1" style={{ background: '#888888' }}>
                              <div className="h-full rounded-full transition-all" style={{ width: `${Math.max(0, ((pkmn.hp || 0) / (pkmn.maxHP || 1)) * 100)}%`, background: ((pkmn.hp || 0) / (pkmn.maxHP || 1)) > 0.5 ? '#22c55e' : ((pkmn.hp || 0) / (pkmn.maxHP || 1)) > 0.25 ? '#eab308' : '#ef4444' }} />
                            </div>
                            <p className="text-[10px] font-bold" style={{ color: '#222222' }}>{pkmn.hp}/{pkmn.maxHP}</p>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                  {/* Time Vermelho — canto inferior esquerdo */}
                  {redActivePokemon.length > 0 ? (
                    <div className="absolute bottom-2 left-2 sm:bottom-3 sm:left-3 flex gap-2 flex-wrap">
                      {redActivePokemon.map((pkmn, idx) => (
                        <div key={idx} className="p-1.5 rounded-lg flex items-center gap-2" style={{ background: 'rgba(0,0,0,0.12)', maxWidth: '180px' }}>
                          {pkmn.imageUrl && <img src={pkmn.imageUrl} alt={pkmn.nome} className="w-[87px] h-[87px] sm:w-[100px] sm:h-[100px] object-contain flex-shrink-0" style={{ imageRendering: 'pixelated' }} />}
                          <div className="flex-1 min-w-0">
                            <p className="text-xs font-bold truncate" style={{ color: '#222222' }}>{pkmn.nome}</p>
                            <p className="text-[10px]" style={{ color: '#444444' }}>Nv.{pkmn.level} | {(pkmn.tipos || []).join('/')}</p>
                            <div className="w-full h-2 rounded-full mt-1" style={{ background: '#888888' }}>
                              <div className="h-full rounded-full" style={{ width: `${Math.max(0, ((pkmn.hp || 0) / (pkmn.maxHP || 1)) * 100)}%`, background: ((pkmn.hp || 0) / (pkmn.maxHP || 1)) > 0.5 ? '#22c55e' : ((pkmn.hp || 0) / (pkmn.maxHP || 1)) > 0.25 ? '#eab308' : '#ef4444' }} />
                            </div>
                            <p className="text-[10px] font-bold" style={{ color: '#222222' }}>{pkmn.hp}/{pkmn.maxHP}</p>
                          </div>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <div className="flex items-center justify-center h-full" style={{ minHeight: '200px' }}>
                      <p className="text-sm font-bold" style={{ color: '#222222' }}>Aguardando batalha...</p>
                    </div>
                  )}
                </div>
                {/* Botões decorativos */}
                <div className="flex justify-between items-center mt-3 px-4">
                  <div className="flex gap-1">
                    <div className="w-6 h-6 rounded-full" style={{ background: '#2D1B4E' }} />
                    <div className="w-6 h-6 rounded-full" style={{ background: '#2D1B4E' }} />
                  </div>
                  <div className="flex gap-2">
                    <div className="w-8 h-4 rounded-full" style={{ background: '#2D1B4E' }} />
                    <div className="w-8 h-4 rounded-full" style={{ background: '#2D1B4E' }} />
                  </div>
                </div>
              </div>
              {/* CHAT DE BATALHA — somente leitura */}
              <div className={`mt-4 ${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-lg p-3 sm:p-4`}>
                <h3 className={`text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Chat de Batalha</h3>
                <div className={`${darkMode ? 'bg-gray-900' : 'bg-gray-50'} rounded-lg p-2 overflow-y-auto`} style={{ maxHeight: '200px' }}>
                  {gbChatMessages.length === 0 ? (
                    <p className={`text-xs text-center ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>Nenhuma mensagem ainda...</p>
                  ) : (
                    gbChatMessages.map((msg) => (
                      <div key={msg.id} className={`mb-1 text-xs ${msg.type === 'system' || msg.type === 'effect' ? 'italic' : ''} ${
                        msg.type === 'damage' ? (darkMode ? 'text-red-400' : 'text-red-600') :
                        msg.type === 'effect' ? (darkMode ? 'text-yellow-400' : 'text-yellow-600') :
                        msg.type === 'system' ? (darkMode ? 'text-blue-400' : 'text-blue-600') :
                        darkMode ? 'text-gray-300' : 'text-gray-700'
                      }`}>
                        <span className="font-bold">[{msg.timestamp}] {msg.user}: </span>{msg.text}
                      </div>
                    ))
                  )}
                </div>
              </div>
            </div>
          </div>
          {accountDataModal}
          {scenarioPopupOverlay}
        {mostrarTriunfosOverlay}
          {pokezapPanel}{pokeAgendaPanel}
        {batalhaChatPanel}
        </>
      )
    }

    const userTeamColor = gbBattleData.allowedUsers?.[currentUser.username] // 'red' ou 'blue'
    const maxActive = gbBattleData.battleMode === 'dupla' ? 2 : 1

    // activePokemon é armazenado no Firebase dentro de gbBattleData
    const gbAP = gbBattleData.activePokemon || {}

    // Meu pokémon ativo — lido do Firebase (gbBattleData.activePokemon[username])
    // mas HP atualizado em tempo real do mainTeam local
    const myActivePokemonData = (gbAP[currentUser.username] || []).map(snap => {
      const pkmn = mainTeam.find(p => (p.id || `team-${p.species}`) === snap.id)
      if (pkmn) {
        const maxHP = calculateMaxHP(pkmn)
        return {
          ...snap,
          hp: pkmn.currentHP !== undefined ? pkmn.currentHP : maxHP,
          maxHP,
          imageUrl: pokemonImages[sanitizeFirebaseKey(pkmn.id)] || pkmn.imageUrl || snap.imageUrl || null,
          golpes: (pkmn.golpesAprendidos || pkmn.golpes || pkmn.moves || snap.golpes || []).map(m => typeof m === 'string' ? m : (m.nome || m.name || '')).filter(Boolean),
        }
      }
      return snap
    })
    const myActivePokemonIds = myActivePokemonData.map(p => p.id)

    // Oponente: pokémon do time oposto (via Firebase) + NPCs ativos
    const opponentTeamColor = userTeamColor === 'red' ? 'blue' : 'red'
    const opponentUsers = Object.entries(gbBattleData.allowedUsers || {}).filter(([, color]) => color === opponentTeamColor).map(([name]) => name)
    const opponentActivePokemon = []
    for (const oppUser of opponentUsers) {
      for (const snap of (gbAP[oppUser] || [])) {
        opponentActivePokemon.push(snap)
      }
    }
    // NPCs como oponentes
    for (const snap of (gbAP['__npc__'] || [])) {
      opponentActivePokemon.push(snap)
    }

    return (
      <>
        <div className={`min-h-screen ${mainBgClass}`}>
          {sidebarNav}
          <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-lg`}>
            <div className="max-w-7xl mx-auto px-4 py-4">
              <div className="flex justify-between items-center mb-4">
                <div className="flex items-center gap-3"><button onClick={() => setSidebarOpen(true)} className={`p-2 rounded-lg ${darkMode ? "hover:bg-gray-700 text-gray-400" : "hover:bg-gray-200 text-gray-500"}`}><Menu size={24} /></button><h2 className={`text-lg sm:text-xl md:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Batalha Game Boy</h2></div>
                <div className="flex gap-1.5 sm:gap-2 items-center flex-shrink-0">
                  <span className={`text-xs px-2 py-1 rounded-full font-bold ${userTeamColor === 'red' ? 'bg-red-500 text-white' : 'bg-green-500 text-white'}`}>Time {userTeamColor === 'red' ? 'Vermelho' : 'Verde'}</span>
                  <button onClick={() => setShowAccountDataModal(true)} className={`p-1.5 sm:p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-200 text-gray-700'}`} title="Dados da Conta"><ArrowDownUp size={18} className="sm:w-5 sm:h-5" /></button>
                  <button onClick={() => setDarkMode(!darkMode)} className={`p-1.5 sm:p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-yellow-400' : 'bg-gray-200 text-gray-700'}`}>{darkMode ? <Sun size={18} className="sm:w-5 sm:h-5" /> : <Moon size={18} className="sm:w-5 sm:h-5" />}</button>
                  {pokezapBtn}{pokeAgendaBtn}{batalhaChatBtn}<button onClick={handleLogout} className="bg-red-500 text-white px-2 sm:px-5 md:px-6 py-1.5 sm:py-2 rounded-lg hover:bg-red-600 text-sm sm:text-base">Sair</button>
                </div>
              </div>
            </div>
          </div>

          <div className="max-w-4xl mx-auto px-4 py-3 sm:py-5">
            {/* GAME BOY COLOR FRAME */}
            <div className="rounded-3xl p-3 sm:p-4 shadow-2xl" style={{ background: 'linear-gradient(145deg, #6A0DAD, #4B0082, #3A0068)' }}>
              {/* Texto GAME BOY COLOR */}
              <div className="text-center mb-2">
                <span className="text-xs font-bold tracking-widest" style={{ color: '#C8A2C8' }}>GAME BOY COLOR</span>
              </div>

              {/* TELA */}
              <div className="rounded-xl p-3 sm:p-4 relative" style={{ background: '#b0b0b0', border: '4px solid #707070', minHeight: '280px' }}>
                {/* Oponente - canto superior direito */}
                {opponentActivePokemon.length > 0 && (
                  <div className="absolute top-2 right-2 sm:top-3 sm:right-3">
                    {opponentActivePokemon.map((opp, idx) => (
                      <div key={idx} className="mb-2 p-1.5 rounded-lg flex items-center gap-2" style={{ background: 'rgba(0,0,0,0.15)', maxWidth: '160px' }}>
                        {opp.imageUrl && (
                          <img src={opp.imageUrl} alt={opp.nome || opp.especie} className="w-[62px] h-[62px] object-contain flex-shrink-0" style={{ imageRendering: 'pixelated' }} />
                        )}
                        <div className="flex-1 min-w-0">
                          <p className="text-[10px] font-bold truncate" style={{ color: '#222222' }}>{opp.nome || opp.especie}</p>
                          <div className="w-full h-2 rounded-full mt-1" style={{ background: '#888888' }}>
                            <div className="h-full rounded-full transition-all" style={{
                              width: `${Math.max(0, ((opp.hp || 0) / (opp.maxHP || 1)) * 100)}%`,
                              background: ((opp.hp || 0) / (opp.maxHP || 1)) > 0.5 ? '#22c55e' : ((opp.hp || 0) / (opp.maxHP || 1)) > 0.25 ? '#eab308' : '#ef4444'
                            }} />
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                )}

                {/* Meu Pokémon - canto inferior esquerdo */}
                {myActivePokemonData.length > 0 ? (
                  <div className="absolute bottom-2 left-2 sm:bottom-3 sm:left-3 flex gap-2 flex-wrap">
                    {myActivePokemonData.map((pkmn) => (
                      <div key={pkmn.id} className="p-1.5 rounded-lg flex items-center gap-2" style={{ background: 'rgba(0,0,0,0.12)', maxWidth: '180px' }}>
                        {pkmn.imageUrl && (
                          <img src={pkmn.imageUrl} alt={pkmn.nome} className="w-[87px] h-[87px] sm:w-[100px] sm:h-[100px] object-contain flex-shrink-0" style={{ imageRendering: 'pixelated' }} />
                        )}
                        <div className="flex-1 min-w-0">
                          <p className="text-xs font-bold truncate" style={{ color: '#222222' }}>{pkmn.nome}</p>
                          <p className="text-[10px]" style={{ color: '#444444' }}>Nv.{pkmn.level} | {(pkmn.tipos || []).join('/')}</p>
                          <div className="w-full h-2 rounded-full mt-1" style={{ background: '#888888' }}>
                            <div className="h-full rounded-full" style={{
                              width: `${(pkmn.hp / pkmn.maxHP) * 100}%`,
                              background: (pkmn.hp / pkmn.maxHP) > 0.5 ? '#22c55e' : (pkmn.hp / pkmn.maxHP) > 0.25 ? '#eab308' : '#ef4444'
                            }} />
                          </div>
                          <p className="text-[10px] font-bold" style={{ color: '#222222' }}>{pkmn.hp}/{pkmn.maxHP}</p>
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className="flex items-center justify-center h-full" style={{ minHeight: '200px' }}>
                    <p className="text-sm font-bold" style={{ color: '#222222' }}>Selecione um Pokémon do seu time!</p>
                  </div>
                )}

                {/* Checkbox de alvo em dupla */}
                {gbBattleData.battleMode === 'dupla' && opponentActivePokemon.length > 0 && myActivePokemonData.length > 0 && (
                  <div className="absolute top-2 left-2 sm:top-3 sm:left-3">
                    <p className="text-[10px] font-bold mb-1" style={{ color: '#222222' }}>Alvos:</p>
                    {[...opponentActivePokemon, ...myActivePokemonData].map((pkmn) => (
                      <label key={pkmn.id} className="flex items-center gap-1 cursor-pointer">
                        <input
                          type="checkbox"
                          checked={gbSelectedTargets.includes(pkmn.id)}
                          onChange={(e) => {
                            if (e.target.checked) {
                              setGbSelectedTargets(prev => [...prev, pkmn.id])
                            } else {
                              setGbSelectedTargets(prev => prev.filter(id => id !== pkmn.id))
                            }
                          }}
                          className="w-3 h-3"
                        />
                        <span className="text-[10px] font-bold" style={{ color: '#222222' }}>{pkmn.nome}</span>
                      </label>
                    ))}
                  </div>
                )}
              </div>

              {/* BOTÕES DO GAME BOY (decorativos) */}
              <div className="flex justify-between items-center mt-3 px-4">
                <div className="flex gap-1">
                  <div className="w-6 h-6 rounded-full" style={{ background: '#2D1B4E' }} />
                  <div className="w-6 h-6 rounded-full" style={{ background: '#2D1B4E' }} />
                </div>
                <div className="flex gap-2">
                  <div className="w-8 h-4 rounded-full" style={{ background: '#2D1B4E' }} />
                  <div className="w-8 h-4 rounded-full" style={{ background: '#2D1B4E' }} />
                </div>
              </div>
            </div>

            {/* GOLPES DO POKÉMON ATIVO */}
            {myActivePokemonData.length > 0 && (
              <div className={`mt-4 ${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-lg p-3 sm:p-4`}>
                <h3 className={`text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Golpes</h3>
                {myActivePokemonData.map((pkmn) => (
                  <div key={pkmn.id} className="mb-3">
                    <p className={`text-xs font-semibold mb-1 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>{pkmn.nome}:</p>
                    <div className="grid grid-cols-2 gap-1.5">
                      {(pkmn.golpes || []).map((moveName, moveIdx) => {
                        if (!moveName) return null
                        const moveData = GOLPES_DATA[moveName]
                        const moveColor = moveData ? (TYPE_COLORS[normalizeType(moveData.tipo)] || '#A8A878') : '#A8A878'
                        return (
                          <button
                            key={moveIdx}
                            onClick={() => {
                              // Determinar alvos
                              let targets = []
                              if (gbBattleData.battleMode === 'dupla' && gbSelectedTargets.length > 0) {
                                targets = gbSelectedTargets.map(tid => {
                                  return opponentActivePokemon.find(o => o.id === tid) ||
                                    myActivePokemonData.find(m => m.id === tid)
                                }).filter(Boolean)
                              } else if (opponentActivePokemon.length > 0) {
                                targets = [opponentActivePokemon[0]]
                              }
                              if (targets.length > 0) {
                                gbHandleUseMove(pkmn, moveName, targets)
                              }
                            }}
                            className="px-2 py-1.5 rounded-lg text-white text-[10px] sm:text-xs font-semibold hover:opacity-80 transition-opacity text-left truncate"
                            style={{ background: moveColor }}
                            title={moveData ? `${moveName} | ${moveData.tipo} | AC: ${moveData.acuracia} | ${moveData.danoBasal || 'Sem dano'}` : moveName}
                          >
                            {moveName}
                          </button>
                        )
                      })}
                    </div>
                  </div>
                ))}
              </div>
            )}

            {/* TIME PRINCIPAL - POKÉBOLAS */}
            <div className={`mt-4 ${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-lg p-3 sm:p-4`}>
              <h3 className={`text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Time Principal ({mainTeam.length}/6)</h3>
              <div className="grid grid-cols-3 sm:grid-cols-6 gap-3">
                {mainTeam.map((pkmn, idx) => {
                  const pkId = pkmn.id || `team-${pkmn.species}`
                  const isActive = myActivePokemonIds.includes(pkId)
                  return (
                    <button
                      key={idx}
                      onClick={() => {
                        if (isActive) {
                          // Retornar à pokébola — remover de gbBattleData.activePokemon
                          const updated = {
                            ...gbBattleData,
                            activePokemon: {
                              ...(gbBattleData.activePokemon || {}),
                              [currentUser.username]: ((gbBattleData.activePokemon || {})[currentUser.username] || []).filter(p => p.id !== pkId)
                            }
                          }
                          setGbBattleData(updated)
                          if (useFirebase) saveGBBattle(updated)
                        } else if (myActivePokemonIds.length < maxActive) {
                          // Enviar para batalha — salvar snapshot com imageUrl e dados completos
                          const maxHP = calculateMaxHP(pkmn)
                          const snap = {
                            id: pkId,
                            originalId: pkId,
                            nome: pkmn.nickname || pkmn.species,
                            especie: pkmn.species,
                            tipos: getPokemonTypes(pkmn),
                            hp: pkmn.currentHP !== undefined ? pkmn.currentHP : maxHP,
                            maxHP,
                            level: pkmn.level || 1,
                            pokeball: pkmn.pokeball || 'Pokeball',
                            imageUrl: pokemonImages[sanitizeFirebaseKey(pkmn.id)] || pkmn.imageUrl || null,
                            isNpc: false,
                            owner: currentUser.username,
                            golpes: (pkmn.golpesAprendidos || pkmn.golpes || pkmn.moves || []).map(m => typeof m === 'string' ? m : (m.nome || m.name || '')).filter(Boolean),
                            attributes: {
                              ataque: calculateTotalAttribute(pkmn, 'ataque', 'Ataque'),
                              defesa: calculateTotalAttribute(pkmn, 'defesa', 'Defesa'),
                              ataqueEspecial: calculateTotalAttribute(pkmn, 'ataqueEspecial', 'Ataque Especial'),
                              defesaEspecial: calculateTotalAttribute(pkmn, 'defesaEspecial', 'Defesa Especial'),
                              velocidade: calculateTotalAttribute(pkmn, 'velocidade', 'Velocidade'),
                              saude: calculateTotalAttribute(pkmn, 'saude', 'Saúde')
                            },
                            evasaoFisica: Math.floor(calculateTotalAttribute(pkmn, 'defesa', 'Defesa') / 5),
                            evasaoEspecial: Math.floor(calculateTotalAttribute(pkmn, 'defesaEspecial', 'Defesa Especial') / 5),
                            evasaoVeloz: Math.floor(calculateTotalAttribute(pkmn, 'velocidade', 'Velocidade') / 10),
                          }
                          const updated = {
                            ...gbBattleData,
                            activePokemon: {
                              ...(gbBattleData.activePokemon || {}),
                              [currentUser.username]: [...((gbBattleData.activePokemon || {})[currentUser.username] || []), snap]
                            }
                          }
                          setGbBattleData(updated)
                          if (useFirebase) saveGBBattle(updated)
                        }
                      }}
                      className={`flex flex-col items-center gap-1 p-2 rounded-lg transition-all ${isActive ? 'opacity-40 ring-2 ring-yellow-400' : 'hover:bg-gray-700/20'}`}
                      title={isActive ? 'Clique para retornar à Pokébola' : 'Clique para enviar à batalha'}
                    >
                      <span className={`text-[10px] font-bold truncate w-full text-center ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>{pkmn.nickname || pkmn.species}</span>
                      <img
                        src={`/pokeballs/${(pkmn.pokeball || 'Pokeball').toLowerCase().replace(/\s+/g, '')}.png`}
                        alt={pkmn.pokeball || 'Pokeball'}
                        className="w-10 h-10 sm:w-12 sm:h-12 object-contain"
                      />
                    </button>
                  )
                })}
              </div>
            </div>

            {/* CHAT DE BATALHA */}
            <div className={`mt-4 ${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-lg p-3 sm:p-4`}>
              <h3 className={`text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Chat de Batalha</h3>
              <div className={`${darkMode ? 'bg-gray-900' : 'bg-gray-50'} rounded-lg p-2 mb-2 overflow-y-auto`} style={{ maxHeight: '200px' }}>
                {gbChatMessages.length === 0 ? (
                  <p className={`text-xs text-center ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>Nenhuma mensagem ainda...</p>
                ) : (
                  gbChatMessages.map((msg) => (
                    <div key={msg.id} className={`mb-1 text-xs ${msg.type === 'system' || msg.type === 'effect' ? 'italic' : ''} ${
                      msg.type === 'damage' ? (darkMode ? 'text-red-400' : 'text-red-600') :
                      msg.type === 'effect' ? (darkMode ? 'text-yellow-400' : 'text-yellow-600') :
                      msg.type === 'system' ? (darkMode ? 'text-blue-400' : 'text-blue-600') :
                      darkMode ? 'text-gray-300' : 'text-gray-700'
                    }`}>
                      <span className="font-bold">[{msg.timestamp}] {msg.user}: </span>{msg.text}
                    </div>
                  ))
                )}
              </div>
              {/* Input + Quick dice */}
              <div className="flex gap-2">
                <input
                  value={gbChatInput}
                  onChange={e => setGbChatInput(e.target.value)}
                  onKeyDown={e => {
                    if (e.key === 'Enter' && gbChatInput.trim()) {
                      const timestamp = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
                      // Verificar rolagem de dados
                      const diceMatch = gbChatInput.match(/(\d+)d(\d+)([+-]\d+)?/i)
                      if (diceMatch) {
                        const result = gbRollDice(gbChatInput.trim())
                        addGBChatMessage({ type: 'dice', user: currentUser.username, text: `${gbChatInput.trim()} = ${result}`, timestamp })
                      } else {
                        addGBChatMessage({ type: 'chat', user: currentUser.username, text: gbChatInput.trim(), timestamp })
                      }
                      setGbChatInput('')
                    }
                  }}
                  placeholder="Digite uma mensagem ou rolagem (ex: 1d20+5)..."
                  className={`flex-1 px-3 py-1.5 rounded-lg text-xs ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'bg-white border-gray-300 text-gray-800'} border`}
                />
                <button
                  onClick={() => {
                    if (!gbChatInput.trim()) return
                    const timestamp = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
                    const diceMatch = gbChatInput.match(/(\d+)d(\d+)([+-]\d+)?/i)
                    if (diceMatch) {
                      const result = gbRollDice(gbChatInput.trim())
                      addGBChatMessage({ type: 'dice', user: currentUser.username, text: `${gbChatInput.trim()} = ${result}`, timestamp })
                    } else {
                      addGBChatMessage({ type: 'chat', user: currentUser.username, text: gbChatInput.trim(), timestamp })
                    }
                    setGbChatInput('')
                  }}
                  className="bg-gradient-to-r from-green-600 to-teal-600 text-white px-3 py-1.5 rounded-lg text-xs font-semibold hover:opacity-90"
                >
                  <Send size={14} />
                </button>
              </div>
              {/* Quick dice buttons */}
              <div className="flex gap-1 mt-2 flex-wrap">
                {['1d4', '1d6', '1d8', '1d10', '1d12', '1d20'].map(dice => (
                  <button
                    key={dice}
                    onClick={() => {
                      const result = gbRollDice(dice)
                      const timestamp = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
                      addGBChatMessage({ type: 'dice', user: currentUser.username, text: `${dice} = ${result}`, timestamp })
                    }}
                    className={`px-2 py-1 rounded text-[10px] font-bold ${darkMode ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                  >
                    {dice}
                  </button>
                ))}
              </div>
            </div>
          </div>
        </div>
        {accountDataModal}
        {scenarioPopupOverlay}
        {mostrarTriunfosOverlay}
        {pokezapPanel}{pokeAgendaPanel}
        {batalhaChatPanel}
      </>
    )
  }

  // ===== ÁREA TIMES NPC (Mestre) =====
  if (currentUser.type === 'mestre' && currentArea === 'Times NPC') {
    const allNpcTrainers = [...(npcTrainers || []), ...(archivedNpcTrainers || [])]
    const allNpcPokemonList = [...(npcPokemon || []), ...(archivedNpcPokemon || [])]

    const handleCreateTeam = () => {
      const newTeam = {
        id: `team-${Date.now()}-${Math.random().toString(36).substr(2, 6)}`,
        teamColor: 'blue',
        trainer: null,
        pokemon: [null, null, null, null, null, null]
      }
      setNpcTeams(prev => [...prev, newTeam])
    }

    const handleDeleteTeam = (teamId) => {
      setNpcTeams(prev => prev.filter(t => t.id !== teamId))
    }

    const handleSetTeamColor = (teamId, color) => {
      setNpcTeams(prev => prev.map(t => t.id === teamId ? { ...t, teamColor: color } : t))
    }

    const handleSelectTrainer = (teamId, trainer) => {
      setNpcTeams(prev => prev.map(t => t.id === teamId ? { ...t, trainer: { id: trainer.id, name: trainer.name, imageUrl: trainer.imageUrl || null, level: trainer.level, attributes: trainer.attributes, hp: trainer.hp, currentHP: trainer.currentHP } } : t))
      setNpcTeamSelectingSlot(null)
      setNpcTeamSearchQuery('')
    }

    const handleSelectPokemon = (teamId, slotIndex, pokemon) => {
      setNpcTeams(prev => prev.map(t => {
        if (t.id !== teamId) return t
        const newSlots = [...t.pokemon]
        newSlots[slotIndex] = { id: pokemon.id, species: pokemon.species || pokemon.name, name: pokemon.name || pokemon.species, imageUrl: pokemon.imageUrl || null, level: pokemon.level, types: pokemon.types || [], attributes: pokemon.attributes, golpesAprendidos: pokemon.golpesAprendidos || pokemon.moves || [], gender: pokemon.gender, currentHP: pokemon.currentHP, habilidade1: pokemon.habilidade1, habilidade2: pokemon.habilidade2, isExotic: pokemon.isExotic }
        return { ...t, pokemon: newSlots }
      }))
      setNpcTeamSelectingSlot(null)
      setNpcTeamSearchQuery('')
    }

    const handleClearSlot = (teamId, slotType, slotIndex) => {
      setNpcTeams(prev => prev.map(t => {
        if (t.id !== teamId) return t
        if (slotType === 'trainer') return { ...t, trainer: null }
        const newSlots = [...t.pokemon]
        newSlots[slotIndex] = null
        return { ...t, pokemon: newSlots }
      }))
    }

    const handleSendTeamToGBBattle = async (team) => {
      const filledPokemon = team.pokemon.filter(p => p !== null)
      if (filledPokemon.length === 0) {
        alert('Adicione pelo menos um Pokémon ao time!')
        return
      }
      const excludedBalls = ['Masterball', 'Dreamball', 'Beastball', 'Alphaball', 'Custom Pokeball']
      const availableBalls = POKEBALLS_LIST.filter(b => !excludedBalls.includes(b))
      const newGbPokemon = filledPokemon.map(pokemon => {
        const randomBall = availableBalls[Math.floor(Math.random() * availableBalls.length)]
        const alfaBonus = npcAlfaStatus[pokemon.id] ? 3 : 0
        const maxHP = (3 * ((pokemon.attributes?.saude || 5) + alfaBonus)) + (pokemon.level || 1)
        return {
          id: `gb-npc-${Date.now()}-${Math.random()}`,
          nome: pokemon.species || pokemon.name,
          especie: pokemon.species || pokemon.name,
          tipos: pokemon.types || [],
          hp: pokemon.currentHP !== undefined ? pokemon.currentHP : maxHP,
          maxHP,
          level: pokemon.level || 1,
          gender: pokemon.gender || 'assexuado',
          pokeball: randomBall,
          imageUrl: pokemon.imageUrl || null,
          isNpc: true,
          isAlpha: npcAlfaStatus[pokemon.id] || false,
          golpes: (pokemon.golpesAprendidos || pokemon.moves || []).map(m => typeof m === 'string' ? m : (m.nome || m.name || '')).filter(Boolean),
          attributes: {
            ataque: (pokemon.attributes?.ataque || 0) + alfaBonus,
            defesa: (pokemon.attributes?.defesa || 0) + alfaBonus,
            ataqueEspecial: (pokemon.attributes?.ataqueEspecial || 0) + alfaBonus,
            defesaEspecial: (pokemon.attributes?.defesaEspecial || 0) + alfaBonus,
            velocidade: (pokemon.attributes?.velocidade || 0) + alfaBonus,
            saude: (pokemon.attributes?.saude || 0) + alfaBonus
          },
          evasaoFisica: Math.floor(((pokemon.attributes?.defesa || 0) + alfaBonus) / 5),
          evasaoEspecial: Math.floor(((pokemon.attributes?.defesaEspecial || 0) + alfaBonus) / 5),
          evasaoVeloz: Math.floor(((pokemon.attributes?.velocidade || 0) + alfaBonus) / 10),
          teamId: team.id,
          trainerName: team.trainer?.name || null,
          trainerImageUrl: team.trainer?.imageUrl || null,
        }
      })
      const updatedNpcList = [...(gbBattleData.npcPokemon || []), ...newGbPokemon]
      const updatedData = { ...gbBattleData, npcPokemon: updatedNpcList }
      setGbBattleData(updatedData)
      if (useFirebase) await saveGBBattle(updatedData)
      alert(`Time enviado para Batalha Game Boy! ${newGbPokemon.length} Pokémon adicionados.`)
    }

    const isSelectingFor = (teamId, slotType, slotIndex) => {
      return npcTeamSelectingSlot?.teamId === teamId && npcTeamSelectingSlot?.slotType === slotType && npcTeamSelectingSlot?.slotIndex === slotIndex
    }

    if (!spoilerMestreConfirmado) return (
      <>
        <div className={`min-h-screen ${mainBgClass}`}>
          {sidebarNav}
          <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-lg`}>
            <div className="max-w-7xl mx-auto px-4 py-4">
              <div className="flex justify-between items-center mb-4">
                <div className="flex items-center gap-3">
                  <button onClick={() => setSidebarOpen(true)} className={`p-2 rounded-lg ${darkMode ? "hover:bg-gray-700 text-gray-400" : "hover:bg-gray-200 text-gray-500"}`}><Menu size={24} /></button>
                  <h2 className={`text-lg sm:text-xl md:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Times NPC</h2>
                </div>
                <div className="flex gap-1.5 sm:gap-2 items-center flex-shrink-0">
                  <button onClick={() => setDarkMode(!darkMode)} className={`p-1.5 sm:p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-yellow-400' : 'bg-gray-200 text-gray-700'}`}>{darkMode ? <Sun size={18} /> : <Moon size={18} />}</button>
                  {pokezapBtn}{pokeAgendaBtn}{batalhaChatBtn}<button onClick={handleLogout} className="bg-red-500 text-white px-2 sm:px-5 py-1.5 sm:py-2 rounded-lg hover:bg-red-600 text-sm sm:text-base">Sair</button>
                </div>
              </div>
            </div>
          </div>
          <div className="max-w-7xl mx-auto px-4 py-3 sm:py-5 md:py-8 flex flex-col items-center justify-center min-h-[60vh] text-center gap-6">
            <div className="text-6xl">⚠️</div>
            <h2 className={`text-3xl font-bold ${darkMode ? 'text-yellow-400' : 'text-yellow-600'}`}>Alerta de Spoiler</h2>
            <p className={`text-base max-w-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
              Esta área contém informações confidenciais do Arco. Prossiga apenas se tiver certeza.
            </p>
            <button
              onClick={() => setSpoilerMestreConfirmado(true)}
              className="bg-yellow-500 hover:bg-yellow-600 text-black font-bold px-8 py-3 rounded-xl text-lg transition-colors"
            >
              Sou o mestre do Arco.
            </button>
          </div>
        </div>
      </>
    )

    return (
      <>
        <div className={`min-h-screen ${mainBgClass}`}>
          {sidebarNav}
          <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-lg`}>
            <div className="max-w-7xl mx-auto px-4 py-4">
              <div className="flex justify-between items-center mb-4">
                <div className="flex items-center gap-3">
                  <button onClick={() => setSidebarOpen(true)} className={`p-2 rounded-lg ${darkMode ? "hover:bg-gray-700 text-gray-400" : "hover:bg-gray-200 text-gray-500"}`}><Menu size={24} /></button>
                  <h2 className={`text-lg sm:text-xl md:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Times NPC</h2>
                </div>
                <div className="flex gap-1.5 sm:gap-2 items-center flex-shrink-0">
                  <button onClick={() => setDarkMode(!darkMode)} className={`p-1.5 sm:p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-yellow-400' : 'bg-gray-200 text-gray-700'}`}>{darkMode ? <Sun size={18} /> : <Moon size={18} />}</button>
                  {pokezapBtn}{pokeAgendaBtn}{batalhaChatBtn}<button onClick={handleLogout} className="bg-red-500 text-white px-2 sm:px-5 py-1.5 sm:py-2 rounded-lg hover:bg-red-600 text-sm sm:text-base">Sair</button>
                </div>
              </div>
            </div>
          </div>

          <div className="max-w-4xl mx-auto px-4 py-6 space-y-4">
            {/* Botão Montar Time */}
            <button
              onClick={handleCreateTeam}
              className={`w-full py-3 rounded-xl font-bold text-sm flex items-center justify-center gap-2 transition-all ${
                darkMode ? 'bg-blue-600 hover:bg-blue-700 text-white' : 'bg-blue-500 hover:bg-blue-600 text-white'
              }`}
            >
              <Plus size={18} /> Montar Time
            </button>

            {/* Lista de times */}
            {npcTeams.length === 0 && (
              <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-lg p-8 text-center`}>
                <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Nenhum time criado. Clique em "Montar Time" para começar.</p>
              </div>
            )}

            {npcTeams.map((team) => (
              <div key={team.id} className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-lg p-4`}>
                {/* Header do time */}
                <div className="flex items-center justify-between mb-3">
                  <div className="flex items-center gap-2">
                    <Gamepad2 size={18} className={darkMode ? 'text-gray-400' : 'text-gray-500'} />
                    <span className={`text-sm font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                      Time {team.trainer?.name || 'Sem Treinador'}
                    </span>
                  </div>
                  <div className="flex items-center gap-2">
                    {/* Seletor de cor */}
                    <button
                      onClick={() => handleSetTeamColor(team.id, 'blue')}
                      className={`px-2 py-1 rounded text-xs font-bold border-2 transition-all ${
                        team.teamColor === 'blue' ? 'bg-blue-500 border-blue-400 text-white' : darkMode ? 'bg-gray-700 border-gray-600 text-gray-400' : 'bg-gray-200 border-gray-300 text-gray-500'
                      }`}
                    >Azul</button>
                    <button
                      onClick={() => handleSetTeamColor(team.id, 'red')}
                      className={`px-2 py-1 rounded text-xs font-bold border-2 transition-all ${
                        team.teamColor === 'red' ? 'bg-red-500 border-red-400 text-white' : darkMode ? 'bg-gray-700 border-gray-600 text-gray-400' : 'bg-gray-200 border-gray-300 text-gray-500'
                      }`}
                    >Vermelho</button>
                    {/* Excluir */}
                    <button
                      onClick={() => handleDeleteTeam(team.id)}
                      className={`p-1 rounded ${darkMode ? 'text-red-400 hover:bg-red-900/30' : 'text-red-500 hover:bg-red-50'}`}
                      title="Excluir time"
                    ><Trash2 size={16} /></button>
                  </div>
                </div>

                {/* Slot de treinador */}
                <div className="mb-3">
                  <p className={`text-xs font-semibold mb-1.5 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Treinador:</p>
                  {team.trainer ? (
                    <div className={`flex items-center gap-3 p-2 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                      {team.trainer.imageUrl && (
                        <img src={team.trainer.imageUrl} alt={team.trainer.name} className="w-12 h-12 rounded-full object-cover flex-shrink-0" />
                      )}
                      <div className="flex-1 min-w-0">
                        <p className={`text-sm font-bold truncate ${darkMode ? 'text-white' : 'text-gray-800'}`}>{team.trainer.name}</p>
                        <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Nv.{team.trainer.level || '?'}</p>
                      </div>
                      <div className="flex gap-1">
                        <button onClick={() => { setNpcTeamSelectingSlot({ teamId: team.id, slotType: 'trainer', slotIndex: 0 }); setNpcTeamSearchQuery('') }} className={`p-1.5 rounded ${darkMode ? 'text-yellow-400 hover:bg-yellow-900/30' : 'text-yellow-600 hover:bg-yellow-50'}`} title="Trocar"><Pencil size={14} /></button>
                        <button onClick={() => sendNpcTrainerToBattle(team.trainer)} className={`p-1.5 rounded ${darkMode ? 'text-green-400 hover:bg-green-900/30' : 'text-green-600 hover:bg-green-50'}`} title="Enviar para Tracker"><Sword size={14} /></button>
                      </div>
                    </div>
                  ) : (
                    <button
                      onClick={() => { setNpcTeamSelectingSlot({ teamId: team.id, slotType: 'trainer', slotIndex: 0 }); setNpcTeamSearchQuery('') }}
                      className={`w-full p-3 rounded-lg border-2 border-dashed text-sm font-semibold transition-all ${
                        darkMode ? 'border-gray-600 text-gray-400 hover:border-gray-500' : 'border-gray-300 text-gray-400 hover:border-gray-400'
                      }`}
                    >+ Selecionar Treinador</button>
                  )}

                  {/* Lista de seleção de treinador */}
                  {isSelectingFor(team.id, 'trainer', 0) && (
                    <div className={`mt-2 rounded-lg border max-h-60 overflow-y-auto ${darkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-200'}`}>
                      <div className="p-2 sticky top-0 z-10" style={{ background: darkMode ? '#111827' : '#ffffff' }}>
                        <input
                          type="text"
                          placeholder="Buscar treinador..."
                          value={npcTeamSearchQuery}
                          onChange={(e) => setNpcTeamSearchQuery(e.target.value)}
                          className={`w-full px-3 py-1.5 rounded text-sm ${darkMode ? 'bg-gray-800 text-white border-gray-600' : 'bg-gray-100 text-gray-800 border-gray-300'} border`}
                          autoFocus
                        />
                      </div>
                      {allNpcTrainers.filter(t => t.name.toLowerCase().includes(npcTeamSearchQuery.toLowerCase())).map(trainer => (
                        <button
                          key={trainer.id}
                          onClick={() => handleSelectTrainer(team.id, trainer)}
                          className={`w-full flex items-center gap-2 px-3 py-2 text-left text-sm transition-all ${darkMode ? 'hover:bg-gray-800 text-gray-200' : 'hover:bg-gray-50 text-gray-700'}`}
                        >
                          {trainer.imageUrl && <img src={trainer.imageUrl} className="w-8 h-8 rounded-full object-cover flex-shrink-0" />}
                          <span className="truncate">{trainer.name}</span>
                          <span className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>Nv.{trainer.level || '?'}</span>
                        </button>
                      ))}
                      <button
                        onClick={() => { setNpcTeamSelectingSlot(null); setNpcTeamSearchQuery('') }}
                        className={`w-full py-2 text-xs font-semibold ${darkMode ? 'text-gray-500 hover:text-gray-300' : 'text-gray-400 hover:text-gray-600'}`}
                      >Cancelar</button>
                    </div>
                  )}
                </div>

                {/* 6 Slots de pokémon */}
                <div className="mb-3">
                  <p className={`text-xs font-semibold mb-1.5 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Pokémon (6):</p>
                  <div className="grid grid-cols-2 sm:grid-cols-3 gap-2">
                    {team.pokemon.map((pkmn, slotIdx) => (
                      <div key={slotIdx}>
                        {pkmn ? (
                          <div className={`flex items-center gap-2 p-2 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                            {pkmn.imageUrl && (
                              <img src={pkmn.imageUrl} alt={pkmn.species} className="w-10 h-10 object-contain flex-shrink-0" style={{ imageRendering: 'pixelated' }} />
                            )}
                            <div className="flex-1 min-w-0">
                              <p className={`text-xs font-bold truncate ${darkMode ? 'text-white' : 'text-gray-800'}`}>{pkmn.species || pkmn.name}</p>
                              <p className={`text-[10px] ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Nv.{pkmn.level || '?'}</p>
                            </div>
                            <div className="flex flex-col gap-0.5">
                              <button onClick={() => { setNpcTeamSelectingSlot({ teamId: team.id, slotType: 'pokemon', slotIndex: slotIdx }); setNpcTeamSearchQuery('') }} className={`p-1 rounded ${darkMode ? 'text-yellow-400 hover:bg-yellow-900/30' : 'text-yellow-600 hover:bg-yellow-50'}`} title="Trocar"><Pencil size={12} /></button>
                              <button onClick={() => sendNpcPokemonToBattle(pkmn)} className={`p-1 rounded ${darkMode ? 'text-green-400 hover:bg-green-900/30' : 'text-green-600 hover:bg-green-50'}`} title="Enviar para Tracker"><Sword size={12} /></button>
                            </div>
                          </div>
                        ) : (
                          <button
                            onClick={() => { setNpcTeamSelectingSlot({ teamId: team.id, slotType: 'pokemon', slotIndex: slotIdx }); setNpcTeamSearchQuery('') }}
                            className={`w-full p-3 rounded-lg border-2 border-dashed text-xs font-semibold transition-all ${
                              darkMode ? 'border-gray-600 text-gray-500 hover:border-gray-500' : 'border-gray-300 text-gray-400 hover:border-gray-400'
                            }`}
                          >+ Pokémon</button>
                        )}

                        {/* Lista de seleção de pokémon */}
                        {isSelectingFor(team.id, 'pokemon', slotIdx) && (
                          <div className={`mt-1 rounded-lg border max-h-48 overflow-y-auto ${darkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-200'}`}>
                            <div className="p-2 sticky top-0 z-10" style={{ background: darkMode ? '#111827' : '#ffffff' }}>
                              <input
                                type="text"
                                placeholder="Buscar pokémon..."
                                value={npcTeamSearchQuery}
                                onChange={(e) => setNpcTeamSearchQuery(e.target.value)}
                                className={`w-full px-2 py-1 rounded text-xs ${darkMode ? 'bg-gray-800 text-white border-gray-600' : 'bg-gray-100 text-gray-800 border-gray-300'} border`}
                                autoFocus
                              />
                            </div>
                            {allNpcPokemonList.filter(p => (p.species || p.name || '').toLowerCase().includes(npcTeamSearchQuery.toLowerCase())).map(pokemon => (
                              <button
                                key={pokemon.id}
                                onClick={() => handleSelectPokemon(team.id, slotIdx, pokemon)}
                                className={`w-full flex items-center gap-2 px-2 py-1.5 text-left text-xs transition-all ${darkMode ? 'hover:bg-gray-800 text-gray-200' : 'hover:bg-gray-50 text-gray-700'}`}
                              >
                                {pokemon.imageUrl && <img src={pokemon.imageUrl} className="w-7 h-7 object-contain flex-shrink-0" style={{ imageRendering: 'pixelated' }} />}
                                <span className="truncate">{pokemon.species || pokemon.name}</span>
                                <span className={`text-[10px] ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>Nv.{pokemon.level || '?'}</span>
                              </button>
                            ))}
                            <button
                              onClick={() => { setNpcTeamSelectingSlot(null); setNpcTeamSearchQuery('') }}
                              className={`w-full py-1.5 text-xs font-semibold ${darkMode ? 'text-gray-500 hover:text-gray-300' : 'text-gray-400 hover:text-gray-600'}`}
                            >Cancelar</button>
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                </div>

                {/* Botão enviar para Batalha Game Boy */}
                <button
                  onClick={() => handleSendTeamToGBBattle(team)}
                  className={`w-full py-2.5 rounded-lg font-bold text-xs flex items-center justify-center gap-2 transition-all ${
                    darkMode ? 'bg-purple-600 hover:bg-purple-700 text-white' : 'bg-purple-500 hover:bg-purple-600 text-white'
                  }`}
                >
                  <Gamepad2 size={16} /> Enviar Time para Batalha Game Boy
                </button>
              </div>
            ))}
          </div>
        </div>
        {accountDataModal}
        {scenarioPopupOverlay}
        {mostrarTriunfosOverlay}
        {pokezapPanel}{pokeAgendaPanel}
        {batalhaChatPanel}
      </>
    )
  }

  // ===== ÁREA BATALHA GAME BOY M (Mestre) =====
  if (currentUser.type === 'mestre' && currentArea === 'Batalha Game Boy M') {
    const gbNpcPokemon = gbBattleData.npcPokemon || []
    const gbAP_M = gbBattleData.activePokemon || {}
    const npcActiveIds = (gbAP_M['__npc__'] || []).map(p => p.id)
    const npcActivePokemonData = gbAP_M['__npc__'] || []
    const maxActiveNpc = gbBattleData.battleMode === 'dupla' ? 2 : 1

    // Pokémon oponente do time dos treinadores (via Firebase activePokemon)
    const trainerOpponents = []
    for (const [user, color] of Object.entries(gbBattleData.allowedUsers || {})) {
      if (!color) continue
      for (const snap of (gbAP_M[user] || [])) {
        trainerOpponents.push(snap)
      }
    }

    return (
      <>
        <div className={`min-h-screen ${mainBgClass}`}>
          {sidebarNav}
          <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-lg`}>
            <div className="max-w-7xl mx-auto px-4 py-4">
              <div className="flex justify-between items-center mb-4">
                <div className="flex items-center gap-3"><button onClick={() => setSidebarOpen(true)} className={`p-2 rounded-lg ${darkMode ? "hover:bg-gray-700 text-gray-400" : "hover:bg-gray-200 text-gray-500"}`}><Menu size={24} /></button><h2 className={`text-lg sm:text-xl md:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Batalha Game Boy M</h2></div>
                <div className="flex gap-1.5 sm:gap-2 items-center flex-shrink-0">
                  <button onClick={() => setShowAccountDataModal(true)} className={`p-1.5 sm:p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-200 text-gray-700'}`} title="Dados da Conta"><ArrowDownUp size={18} className="sm:w-5 sm:h-5" /></button>
                  <button onClick={() => setDarkMode(!darkMode)} className={`p-1.5 sm:p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-yellow-400' : 'bg-gray-200 text-gray-700'}`}>{darkMode ? <Sun size={18} className="sm:w-5 sm:h-5" /> : <Moon size={18} className="sm:w-5 sm:h-5" />}</button>
                  {pokezapBtn}{pokeAgendaBtn}{batalhaChatBtn}<button onClick={handleLogout} className="bg-red-500 text-white px-2 sm:px-5 md:px-6 py-1.5 sm:py-2 rounded-lg hover:bg-red-600 text-sm sm:text-base">Sair</button>
                </div>
              </div>
            </div>
          </div>

          <div className="max-w-4xl mx-auto px-4 py-3 sm:py-5">
            {/* CONTROLES DO MESTRE */}
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-lg p-3 sm:p-4 mb-4`}>
              {/* Modo de batalha */}
              <div className="flex items-center gap-4 mb-3">
                <span className={`text-sm font-bold ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Modo:</span>
                <label className="flex items-center gap-1 cursor-pointer">
                  <input
                    type="radio"
                    name="gbBattleMode"
                    checked={gbBattleData.battleMode === 'individual'}
                    onChange={() => {
                      const updated = { ...gbBattleData, battleMode: 'individual' }
                      setGbBattleData(updated)
                      if (useFirebase) saveGBBattle(updated)
                    }}
                    className="w-3 h-3"
                  />
                  <span className={`text-xs font-semibold ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Individual</span>
                </label>
                <label className="flex items-center gap-1 cursor-pointer">
                  <input
                    type="radio"
                    name="gbBattleMode"
                    checked={gbBattleData.battleMode === 'dupla'}
                    onChange={() => {
                      const updated = { ...gbBattleData, battleMode: 'dupla' }
                      setGbBattleData(updated)
                      if (useFirebase) saveGBBattle(updated)
                    }}
                    className="w-3 h-3"
                  />
                  <span className={`text-xs font-semibold ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Dupla</span>
                </label>
              </div>

              {/* Permissões de treinadores */}
              <div className="mb-2">
                <span className={`text-sm font-bold ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Treinadores:</span>
              </div>
              <div className="flex flex-wrap gap-2">
                {SAFARI_TRAINERS.map(trainer => {
                  const status = gbBattleData.allowedUsers?.[trainer] || false
                  // Ciclo: false (cinza) -> 'blue' -> 'red' -> false
                  const nextStatus = status === false ? 'blue' : status === 'blue' ? 'red' : false
                  return (
                    <button
                      key={trainer}
                      onClick={() => {
                        const updated = {
                          ...gbBattleData,
                          allowedUsers: { ...(gbBattleData.allowedUsers || {}), [trainer]: nextStatus }
                        }
                        setGbBattleData(updated)
                        if (useFirebase) saveGBBattle(updated)
                      }}
                      className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all border-2 ${
                        status === 'blue' ? 'bg-blue-500 border-blue-400 text-white' :
                        status === 'red' ? 'bg-red-500 border-red-400 text-white' :
                        darkMode ? 'bg-gray-700 border-gray-600 text-gray-400' : 'bg-gray-200 border-gray-300 text-gray-500'
                      }`}
                      title={status === false ? 'Desativado' : status === 'blue' ? 'Time Azul' : 'Time Vermelho'}
                    >
                      {trainer} {status === 'blue' ? '(Azul)' : status === 'red' ? '(Vermelho)' : '(Off)'}
                    </button>
                  )
                })}
              </div>
            </div>

            {/* GAME BOY COLOR FRAME */}
            <div className="rounded-3xl p-3 sm:p-4 shadow-2xl" style={{ background: 'linear-gradient(145deg, #6A0DAD, #4B0082, #3A0068)' }}>
              <div className="text-center mb-2">
                <span className="text-xs font-bold tracking-widest" style={{ color: '#C8A2C8' }}>GAME BOY COLOR</span>
              </div>

              {/* TELA */}
              <div className="rounded-xl p-3 sm:p-4 relative" style={{ background: '#b0b0b0', border: '4px solid #707070', minHeight: '280px' }}>
                {/* Pokémon dos treinadores oponentes no canto superior direito */}
                {trainerOpponents.length > 0 && (
                  <div className="absolute top-2 right-2 sm:top-3 sm:right-3">
                    {trainerOpponents.map((opp, idx) => (
                      <div key={idx} className="mb-2 p-1.5 rounded-lg flex items-center gap-2" style={{ background: 'rgba(0,0,0,0.15)', maxWidth: '160px' }}>
                        {opp.imageUrl && (
                          <img src={opp.imageUrl} alt={opp.nome || opp.especie} className="w-[62px] h-[62px] object-contain flex-shrink-0" style={{ imageRendering: 'pixelated' }} />
                        )}
                        <div className="flex-1 min-w-0">
                          <p className="text-[10px] font-bold truncate" style={{ color: '#222222' }}>{opp.nome || opp.especie}</p>
                          <div className="w-full h-2 rounded-full mt-1" style={{ background: '#888888' }}>
                            <div className="h-full rounded-full transition-all" style={{
                              width: `${Math.max(0, ((opp.hp || 0) / (opp.maxHP || 1)) * 100)}%`,
                              background: ((opp.hp || 0) / (opp.maxHP || 1)) > 0.5 ? '#22c55e' : ((opp.hp || 0) / (opp.maxHP || 1)) > 0.25 ? '#eab308' : '#ef4444'
                            }} />
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                )}

                {/* NPC ativo - canto inferior esquerdo */}
                {npcActivePokemonData.length > 0 ? (
                  <div className="absolute bottom-2 left-2 sm:bottom-3 sm:left-3 flex gap-2 flex-wrap">
                    {npcActivePokemonData.map((npc) => (
                      <div key={npc.id} className="p-1.5 rounded-lg flex items-center gap-2" style={{ background: 'rgba(0,0,0,0.12)', maxWidth: '180px' }}>
                        {npc.imageUrl && (
                          <img src={npc.imageUrl} alt={npc.nome} className="w-[87px] h-[87px] sm:w-[100px] sm:h-[100px] object-contain flex-shrink-0" style={{ imageRendering: 'pixelated' }} />
                        )}
                        <div className="flex-1 min-w-0">
                          <p className="text-xs font-bold truncate" style={{ color: '#222222' }}>{npc.nome}</p>
                          <p className="text-[10px]" style={{ color: '#444444' }}>Nv.{npc.level} | {(npc.tipos || []).join('/')}</p>
                          <div className="w-full h-2 rounded-full mt-1" style={{ background: '#888888' }}>
                            <div className="h-full rounded-full" style={{
                              width: `${(npc.hp / npc.maxHP) * 100}%`,
                              background: (npc.hp / npc.maxHP) > 0.5 ? '#22c55e' : (npc.hp / npc.maxHP) > 0.25 ? '#eab308' : '#ef4444'
                            }} />
                          </div>
                          <p className="text-[10px] font-bold" style={{ color: '#222222' }}>{npc.hp}/{npc.maxHP}</p>
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className="flex items-center justify-center h-full" style={{ minHeight: '200px' }}>
                    <p className="text-sm font-bold" style={{ color: '#222222' }}>
                      {gbNpcPokemon.length === 0 ? 'Envie NPCs da área Pokémon NPC!' : 'Selecione um NPC abaixo!'}
                    </p>
                  </div>
                )}

                {/* Checkbox de alvo em dupla */}
                {gbBattleData.battleMode === 'dupla' && (npcActivePokemonData.length > 0 || trainerOpponents.length > 0) && (
                  <div className="absolute top-2 left-2 sm:top-3 sm:left-3">
                    <p className="text-[10px] font-bold mb-1" style={{ color: '#222222' }}>Alvos:</p>
                    {[...trainerOpponents, ...npcActivePokemonData].map((pkmn) => (
                      <label key={pkmn.id} className="flex items-center gap-1 cursor-pointer">
                        <input
                          type="checkbox"
                          checked={gbSelectedTargets.includes(pkmn.id)}
                          onChange={(e) => {
                            if (e.target.checked) {
                              setGbSelectedTargets(prev => [...prev, pkmn.id])
                            } else {
                              setGbSelectedTargets(prev => prev.filter(id => id !== pkmn.id))
                            }
                          }}
                          className="w-3 h-3"
                        />
                        <span className="text-[10px] font-bold" style={{ color: '#222222' }}>{pkmn.nome}</span>
                      </label>
                    ))}
                  </div>
                )}
              </div>

              {/* Botões decorativos */}
              <div className="flex justify-between items-center mt-3 px-4">
                <div className="flex gap-1">
                  <div className="w-6 h-6 rounded-full" style={{ background: '#2D1B4E' }} />
                  <div className="w-6 h-6 rounded-full" style={{ background: '#2D1B4E' }} />
                </div>
                <div className="flex gap-2">
                  <div className="w-8 h-4 rounded-full" style={{ background: '#2D1B4E' }} />
                  <div className="w-8 h-4 rounded-full" style={{ background: '#2D1B4E' }} />
                </div>
              </div>
            </div>

            {/* GOLPES DO NPC ATIVO */}
            {npcActivePokemonData.length > 0 && (
              <div className={`mt-4 ${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-lg p-3 sm:p-4`}>
                <h3 className={`text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Golpes NPC</h3>
                {npcActivePokemonData.map((npc) => (
                  <div key={npc.id} className="mb-3">
                    <p className={`text-xs font-semibold mb-1 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>{npc.nome}:</p>
                    <div className="grid grid-cols-2 gap-1.5">
                      {(npc.golpes || []).map((moveName, moveIdx) => {
                        const moveData = GOLPES_DATA[moveName]
                        if (!moveData) return null
                        const moveColor = TYPE_COLORS[normalizeType(moveData.tipo)] || '#A8A878'
                        return (
                          <button
                            key={moveIdx}
                            onClick={() => {
                              // Mestre pode usar golpe NPC em treinadores oponentes
                              let targets = []
                              if (gbBattleData.battleMode === 'dupla' && gbSelectedTargets.length > 0) {
                                targets = gbSelectedTargets.map(tid => {
                                  return trainerOpponents.find(o => o.id === tid) ||
                                    npcActivePokemonData.find(m => m.id === tid)
                                }).filter(Boolean)
                              } else if (trainerOpponents.length > 0) {
                                targets = [trainerOpponents[0]]
                              }
                              if (targets.length > 0) {
                                gbHandleUseMove(npc, moveName, targets)
                              }
                            }}
                            className="px-2 py-1.5 rounded-lg text-white text-[10px] sm:text-xs font-semibold hover:opacity-80 transition-opacity text-left truncate"
                            style={{ background: moveColor }}
                            title={`${moveName} | ${moveData.tipo} | AC: ${moveData.acuracia} | ${moveData.danoBasal || 'Sem dano'}`}
                          >
                            {moveName}
                          </button>
                        )
                      })}
                    </div>
                  </div>
                ))}
              </div>
            )}

            {/* POKÉBOLAS NPC */}
            <div className={`mt-4 ${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-lg p-3 sm:p-4`}>
              <h3 className={`text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Pokémon NPC ({gbNpcPokemon.length})</h3>
              {gbNpcPokemon.length === 0 ? (
                <p className={`text-xs text-center ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>Nenhum NPC enviado. Use o botão <Gamepad2 size={12} className="inline" /> nos cards de Pokémon NPC.</p>
              ) : (
                <div className="grid grid-cols-3 sm:grid-cols-6 gap-3">
                  {gbNpcPokemon.map((npc) => {
                    const isActive = npcActiveIds.includes(npc.id)
                    return (
                      <button
                        key={npc.id}
                        onClick={() => {
                          if (isActive) {
                            const updated = {
                              ...gbBattleData,
                              activePokemon: {
                                ...(gbBattleData.activePokemon || {}),
                                '__npc__': ((gbBattleData.activePokemon || {})['__npc__'] || []).filter(p => p.id !== npc.id)
                              }
                            }
                            setGbBattleData(updated)
                            if (useFirebase) saveGBBattle(updated)
                          } else if (npcActiveIds.length < maxActiveNpc) {
                            const updated = {
                              ...gbBattleData,
                              activePokemon: {
                                ...(gbBattleData.activePokemon || {}),
                                '__npc__': [...((gbBattleData.activePokemon || {})['__npc__'] || []), npc]
                              }
                            }
                            setGbBattleData(updated)
                            if (useFirebase) saveGBBattle(updated)
                          }
                        }}
                        className={`flex flex-col items-center gap-1 p-2 rounded-lg transition-all ${isActive ? 'opacity-40 ring-2 ring-yellow-400' : 'hover:bg-gray-700/20'}`}
                        title={`${npc.nome} | HP: ${npc.hp}/${npc.maxHP} | ${isActive ? 'Em batalha' : 'Na pokébola'}`}
                      >
                        <span className={`text-[10px] font-bold truncate w-full text-center ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>{npc.nome}</span>
                        <img
                          src={`/pokeballs/${(npc.pokeball || 'Pokeball').toLowerCase().replace(/\s+/g, '')}.png`}
                          alt={npc.pokeball || 'Pokeball'}
                          className="w-10 h-10 sm:w-12 sm:h-12 object-contain"
                        />
                        {/* Mini HP bar */}
                        <div className="w-full h-1 rounded-full bg-gray-600">
                          <div className="h-full rounded-full" style={{
                            width: `${(npc.hp / npc.maxHP) * 100}%`,
                            background: (npc.hp / npc.maxHP) > 0.5 ? '#22c55e' : (npc.hp / npc.maxHP) > 0.25 ? '#eab308' : '#ef4444'
                          }} />
                        </div>
                      </button>
                    )
                  })}
                </div>
              )}
              {/* Botão para limpar NPCs */}
              {gbNpcPokemon.length > 0 && (
                <button
                  onClick={() => {
                    const updated = {
                      ...gbBattleData,
                      npcPokemon: [],
                      activePokemon: { ...(gbBattleData.activePokemon || {}), '__npc__': [] }
                    }
                    setGbBattleData(updated)
                    setGbTempBattleStats({})
                    if (useFirebase) saveGBBattle(updated)
                  }}
                  className="mt-3 bg-gradient-to-r from-red-600 to-pink-700 text-white px-3 py-1.5 rounded-lg text-xs font-semibold hover:opacity-90"
                >
                  Limpar NPCs
                </button>
              )}
            </div>

            {/* CHAT DE BATALHA */}
            <div className={`mt-4 ${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-lg p-3 sm:p-4`}>
              <h3 className={`text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Chat de Batalha</h3>
              <div className={`${darkMode ? 'bg-gray-900' : 'bg-gray-50'} rounded-lg p-2 mb-2 overflow-y-auto`} style={{ maxHeight: '200px' }}>
                {gbChatMessages.length === 0 ? (
                  <p className={`text-xs text-center ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>Nenhuma mensagem ainda...</p>
                ) : (
                  gbChatMessages.map((msg) => (
                    <div key={msg.id} className={`mb-1 text-xs ${msg.type === 'system' || msg.type === 'effect' ? 'italic' : ''} ${
                      msg.type === 'damage' ? (darkMode ? 'text-red-400' : 'text-red-600') :
                      msg.type === 'effect' ? (darkMode ? 'text-yellow-400' : 'text-yellow-600') :
                      msg.type === 'system' ? (darkMode ? 'text-blue-400' : 'text-blue-600') :
                      darkMode ? 'text-gray-300' : 'text-gray-700'
                    }`}>
                      <span className="font-bold">[{msg.timestamp}] {msg.user}: </span>{msg.text}
                    </div>
                  ))
                )}
              </div>
              <div className="flex gap-2">
                <input
                  value={gbChatInput}
                  onChange={e => setGbChatInput(e.target.value)}
                  onKeyDown={e => {
                    if (e.key === 'Enter' && gbChatInput.trim()) {
                      const timestamp = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
                      const diceMatch = gbChatInput.match(/(\d+)d(\d+)([+-]\d+)?/i)
                      if (diceMatch) {
                        const result = gbRollDice(gbChatInput.trim())
                        addGBChatMessage({ type: 'dice', user: 'Mestre', text: `${gbChatInput.trim()} = ${result}`, timestamp })
                      } else {
                        addGBChatMessage({ type: 'chat', user: 'Mestre', text: gbChatInput.trim(), timestamp })
                      }
                      setGbChatInput('')
                    }
                  }}
                  placeholder="Digite uma mensagem ou rolagem (ex: 1d20+5)..."
                  className={`flex-1 px-3 py-1.5 rounded-lg text-xs ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'bg-white border-gray-300 text-gray-800'} border`}
                />
                <button
                  onClick={() => {
                    if (!gbChatInput.trim()) return
                    const timestamp = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
                    const diceMatch = gbChatInput.match(/(\d+)d(\d+)([+-]\d+)?/i)
                    if (diceMatch) {
                      const result = gbRollDice(gbChatInput.trim())
                      addGBChatMessage({ type: 'dice', user: 'Mestre', text: `${gbChatInput.trim()} = ${result}`, timestamp })
                    } else {
                      addGBChatMessage({ type: 'chat', user: 'Mestre', text: gbChatInput.trim(), timestamp })
                    }
                    setGbChatInput('')
                  }}
                  className="bg-gradient-to-r from-green-600 to-teal-600 text-white px-3 py-1.5 rounded-lg text-xs font-semibold hover:opacity-90"
                >
                  <Send size={14} />
                </button>
              </div>
              <div className="flex gap-1 mt-2 flex-wrap">
                {['1d4', '1d6', '1d8', '1d10', '1d12', '1d20'].map(dice => (
                  <button
                    key={dice}
                    onClick={() => {
                      const result = gbRollDice(dice)
                      const timestamp = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
                      addGBChatMessage({ type: 'dice', user: 'Mestre', text: `${dice} = ${result}`, timestamp })
                    }}
                    className={`px-2 py-1 rounded text-[10px] font-bold ${darkMode ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                  >
                    {dice}
                  </button>
                ))}
              </div>
            </div>
          </div>
        </div>
        {accountDataModal}
        {scenarioPopupOverlay}
        {mostrarTriunfosOverlay}
        {pokezapPanel}{pokeAgendaPanel}
        {batalhaChatPanel}
      </>
    )
  }

  // ===== ÁREA CENÁRIOS DA SESSÃO =====
  if (currentUser.type === 'mestre' && currentArea === 'Cenários da Sessão') {
    if (!spoilerMestreConfirmado) return (
      <>
        <div className={`min-h-screen ${mainBgClass}`}>
          {sidebarNav}
          <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-lg`}>
            <div className="max-w-7xl mx-auto px-4 py-4">
              <div className="flex justify-between items-center mb-4">
                <div className="flex items-center gap-3">
                  <button onClick={() => setSidebarOpen(true)} className={`p-2 rounded-lg ${darkMode ? 'hover:bg-gray-700 text-gray-400' : 'hover:bg-gray-200 text-gray-500'}`}><Menu size={24} /></button>
                  <h2 className={`text-lg sm:text-xl md:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Cenários da Sessão</h2>
                </div>
                <div className="flex gap-1.5 sm:gap-2 items-center flex-shrink-0">
                  <button onClick={() => setShowAccountDataModal(true)} className={`p-1.5 sm:p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-200 text-gray-700'}`} title="Dados da Conta"><ArrowDownUp size={18} className="sm:w-5 sm:h-5" /></button>
                  <button onClick={() => setDarkMode(!darkMode)} className={`p-1.5 sm:p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-yellow-400' : 'bg-gray-200 text-gray-700'}`}>{darkMode ? <Sun size={18} className="sm:w-5 sm:h-5" /> : <Moon size={18} className="sm:w-5 sm:h-5" />}</button>
                  {pokezapBtn}{pokeAgendaBtn}{batalhaChatBtn}<button onClick={handleLogout} className="bg-red-500 text-white px-2 sm:px-5 md:px-6 py-1.5 sm:py-2 rounded-lg hover:bg-red-600 text-sm sm:text-base">Sair</button>
                </div>
              </div>
            </div>
          </div>
          <div className="max-w-7xl mx-auto px-4 py-3 sm:py-5 md:py-8 flex flex-col items-center justify-center min-h-[60vh] text-center gap-6">
            <div className="text-6xl">⚠️</div>
            <h2 className={`text-3xl font-bold ${darkMode ? 'text-yellow-400' : 'text-yellow-600'}`}>Alerta de Spoiler</h2>
            <p className={`text-base max-w-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
              Esta área contém informações confidenciais do Arco. Prossiga apenas se tiver certeza.
            </p>
            <button
              onClick={() => setSpoilerMestreConfirmado(true)}
              className="bg-yellow-500 hover:bg-yellow-600 text-black font-bold px-8 py-3 rounded-xl text-lg transition-colors"
            >
              Sou o mestre do Arco.
            </button>
          </div>
        </div>
      </>
    )
    return (
      <>
        <div className={`min-h-screen ${mainBgClass}`}>
          {sidebarNav}
          {/* Header */}
          <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-lg`}>
            <div className="max-w-7xl mx-auto px-4 py-4">
              <div className="flex justify-between items-center mb-4">
                <div className="flex items-center gap-3">
                  <button onClick={() => setSidebarOpen(true)} className={`p-2 rounded-lg ${darkMode ? 'hover:bg-gray-700 text-gray-400' : 'hover:bg-gray-200 text-gray-500'}`}><Menu size={24} /></button>
                  <h2 className={`text-lg sm:text-xl md:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Cenários da Sessão</h2>
                </div>
                <div className="flex gap-1.5 sm:gap-2 items-center flex-shrink-0">
                  <button onClick={() => setShowAccountDataModal(true)} className={`p-1.5 sm:p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-200 text-gray-700'}`} title="Dados da Conta"><ArrowDownUp size={18} className="sm:w-5 sm:h-5" /></button>
                  <button onClick={() => setDarkMode(!darkMode)} className={`p-1.5 sm:p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-yellow-400' : 'bg-gray-200 text-gray-700'}`}>{darkMode ? <Sun size={18} className="sm:w-5 sm:h-5" /> : <Moon size={18} className="sm:w-5 sm:h-5" />}</button>
                  {pokezapBtn}{pokeAgendaBtn}{batalhaChatBtn}<button onClick={handleLogout} className="bg-red-500 text-white px-2 sm:px-5 md:px-6 py-1.5 sm:py-2 rounded-lg hover:bg-red-600 text-sm sm:text-base">Sair</button>
                </div>
              </div>
            </div>
          </div>

          {/* Conteúdo */}
          <div className="max-w-7xl mx-auto px-4 py-6">
            <button
              onClick={() => {
                setEditingScenario(null)
                setScenarioForm({ title: '', imageUrls: [''] })
                setShowAddScenarioModal(true)
              }}
              className="mb-6 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg flex items-center gap-2 transition-colors"
            >
              <Plus size={18} /> Adicionar Cenário
            </button>

            {sessionScenarios.length === 0 ? (
              <div className={`text-center py-20 ${darkMode ? 'text-gray-400' : 'text-gray-300'}`}>
                Nenhum cenário adicionado ainda.
              </div>
            ) : (
              <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5">
                {sessionScenarios.map(scenario => (
                  <div key={scenario.id} className={`rounded-xl overflow-hidden shadow-lg ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
                    {/* Preview da primeira imagem */}
                    <div className="h-44 overflow-hidden bg-gray-900 flex items-center justify-center">
                      {scenario.imageUrls?.[0]
                        ? <img src={scenario.imageUrls[0]} alt={scenario.title} className="w-full h-full object-cover" onError={(e) => { e.target.style.display = 'none' }} />
                        : <span className="text-gray-600 text-sm">Sem imagem</span>
                      }
                    </div>
                    <div className="p-4">
                      <h3 className={`font-bold text-base mb-1 truncate ${darkMode ? 'text-white' : 'text-gray-800'}`}>{scenario.title}</h3>
                      <p className={`text-xs mb-3 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                        {scenario.imageUrls?.length || 0} imagem{(scenario.imageUrls?.length || 0) !== 1 ? 's' : ''}
                      </p>
                      <button
                        onClick={() => setScenarioDisplay({ active: true, scenarioId: scenario.id, currentImageIndex: 0, title: scenario.title, imageUrls: scenario.imageUrls })}
                        className="w-full mb-2 bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-bold py-2 px-3 rounded-lg transition-colors"
                      >
                        Mostrar para os Jogadores
                      </button>
                      <div className="flex gap-2">
                        <button
                          onClick={() => {
                            setEditingScenario(scenario)
                            setScenarioForm({ title: scenario.title, imageUrls: [...(scenario.imageUrls || [])] })
                            setShowAddScenarioModal(true)
                          }}
                          className={`flex-1 py-1.5 rounded-lg text-xs font-semibold flex items-center justify-center gap-1 ${darkMode ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}
                        >
                          <Pencil size={13} /> Editar
                        </button>
                        <button
                          onClick={() => {
                            if (confirm(`Excluir cenário "${scenario.title}"?`)) {
                              setSessionScenarios(prev => prev.filter(s => s.id !== scenario.id))
                            }
                          }}
                          className="flex-1 py-1.5 rounded-lg text-xs font-semibold flex items-center justify-center gap-1 bg-red-100 text-red-600 hover:bg-red-200 transition-colors"
                        >
                          <Trash2 size={13} /> Excluir
                        </button>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>

        {/* Modal Adicionar / Editar Cenário */}
        {showAddScenarioModal && (
          <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4" onClick={() => setShowAddScenarioModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto`} onClick={(e) => e.stopPropagation()}>
              <div className="p-5">
                <div className="flex justify-between items-center mb-5">
                  <h3 className={`text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{editingScenario ? 'Editar Cenário' : 'Novo Cenário'}</h3>
                  <button onClick={() => setShowAddScenarioModal(false)} className={darkMode ? 'text-gray-400 hover:text-white' : 'text-gray-500 hover:text-gray-700'}><X size={24} /></button>
                </div>

                {/* Título */}
                <div className="mb-4">
                  <label className={`block text-sm font-bold mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Título</label>
                  <input
                    type="text"
                    value={scenarioForm.title}
                    onChange={(e) => setScenarioForm(f => ({ ...f, title: e.target.value }))}
                    placeholder="Nome do cenário..."
                    className={`w-full px-3 py-2 border rounded-lg text-sm ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'border-gray-300 text-gray-800'}`}
                  />
                </div>

                {/* URLs das imagens */}
                <div className="mb-5">
                  <label className={`block text-sm font-bold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>URLs das Imagens</label>
                  <div className="space-y-2">
                    {scenarioForm.imageUrls.map((url, idx) => (
                      <div
                        key={idx}
                        draggable
                        onDragStart={() => setScenarioDragIndex(idx)}
                        onDragOver={(e) => e.preventDefault()}
                        onDrop={() => {
                          if (scenarioDragIndex === null || scenarioDragIndex === idx) return
                          const newUrls = [...scenarioForm.imageUrls]
                          const [dragged] = newUrls.splice(scenarioDragIndex, 1)
                          newUrls.splice(idx, 0, dragged)
                          setScenarioForm(f => ({ ...f, imageUrls: newUrls }))
                          setScenarioDragIndex(null)
                        }}
                        onDragEnd={() => setScenarioDragIndex(null)}
                        className={`flex items-center gap-2 p-2 rounded-lg cursor-grab active:cursor-grabbing transition-opacity ${scenarioDragIndex === idx ? 'opacity-40' : ''} ${darkMode ? 'bg-gray-700' : 'bg-gray-50 border border-gray-200'}`}
                      >
                        <MoveVertical size={14} className={`flex-shrink-0 ${darkMode ? 'text-gray-400' : 'text-gray-400'}`} />
                        <input
                          type="text"
                          value={url}
                          onChange={(e) => {
                            const newUrls = [...scenarioForm.imageUrls]
                            newUrls[idx] = e.target.value
                            setScenarioForm(f => ({ ...f, imageUrls: newUrls }))
                          }}
                          placeholder={`URL da imagem ${idx + 1}...`}
                          className={`flex-1 px-2 py-1.5 border rounded text-xs ${darkMode ? 'bg-gray-600 border-gray-500 text-white placeholder-gray-400' : 'border-gray-300 text-gray-800'}`}
                        />
                        <button
                          onClick={() => {
                            const newUrls = [...scenarioForm.imageUrls]
                            newUrls.splice(idx + 1, 0, '')
                            setScenarioForm(f => ({ ...f, imageUrls: newUrls }))
                          }}
                          className="text-green-500 hover:text-green-400 flex-shrink-0"
                          title="Adicionar URL abaixo"
                        >
                          <Plus size={16} />
                        </button>
                        {scenarioForm.imageUrls.length > 1 && (
                          <button
                            onClick={() => {
                              const newUrls = scenarioForm.imageUrls.filter((_, i) => i !== idx)
                              setScenarioForm(f => ({ ...f, imageUrls: newUrls }))
                            }}
                            className="text-red-400 hover:text-red-300 flex-shrink-0"
                          >
                            <X size={16} />
                          </button>
                        )}
                      </div>
                    ))}
                  </div>
                </div>

                {/* Botões */}
                <div className="flex gap-3">
                  <button onClick={() => setShowAddScenarioModal(false)} className={`flex-1 py-2 rounded-lg font-semibold text-sm ${darkMode ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>Cancelar</button>
                  <button
                    onClick={() => {
                      if (!scenarioForm.title.trim()) { alert('Digite um título para o cenário.'); return }
                      const urls = scenarioForm.imageUrls.filter(u => u.trim())
                      if (urls.length === 0) { alert('Adicione pelo menos uma URL de imagem.'); return }
                      if (editingScenario) {
                        setSessionScenarios(prev => prev.map(s =>
                          s.id === editingScenario.id
                            ? { ...s, title: scenarioForm.title.trim(), imageUrls: urls }
                            : s
                        ))
                      } else {
                        setSessionScenarios(prev => [...prev, {
                          id: `scenario_${Date.now()}`,
                          title: scenarioForm.title.trim(),
                          imageUrls: urls
                        }])
                      }
                      setShowAddScenarioModal(false)
                    }}
                    className="flex-1 py-2 rounded-lg font-semibold text-sm bg-indigo-600 hover:bg-indigo-700 text-white transition-colors"
                  >Salvar</button>
                </div>
              </div>
            </div>
          </div>
        )}

        {accountDataModal}
        {scenarioPopupOverlay}
        {mostrarTriunfosOverlay}
        {pokezapPanel}{pokeAgendaPanel}
        {batalhaChatPanel}
      </>
    )
  }

  // ===== SMART POKEFONE =====
  if (currentUser.type === 'treinador' && currentArea === 'SmartPokefone') {
    const userGradient = users.find(u => u.username === currentUser.username)?.gradient || 'linear-gradient(135deg, #4169E1, #87CEEB)'
    const unreadCount = smartPokefoneMessages.filter(m => !m.lida).length
    return (
      <>
        <div className={`min-h-screen ${mainBgClass}`}>
          {sidebarNav}
          {/* Header */}
          <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-lg`}>
            <div className="max-w-4xl mx-auto px-4 py-4">
              <div className="flex justify-between items-center">
                <div className="flex items-center gap-3">
                  <button onClick={() => setSidebarOpen(true)} className={`p-2 rounded-lg ${darkMode ? 'hover:bg-gray-700 text-gray-400' : 'hover:bg-gray-200 text-gray-500'}`}><Menu size={24} /></button>
                  <div className="flex items-center gap-2">
                    <div className="w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-sm" style={{ background: userGradient }}>
                      {currentUser.username[0]}
                    </div>
                    <div>
                      <h2 className={`text-lg font-bold leading-none ${darkMode ? 'text-white' : 'text-gray-800'}`}>SmartPokefone</h2>
                      <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>{currentUser.username}</p>
                    </div>
                    {unreadCount > 0 && (
                      <span className="bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full">{unreadCount}</span>
                    )}
                  </div>
                </div>
                <div className="flex gap-2 items-center">
                  <button onClick={() => setDarkMode(!darkMode)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-yellow-400' : 'bg-gray-200 text-gray-700'}`}>{darkMode ? <Sun size={18} /> : <Moon size={18} />}</button>
                  {pokezapBtn}{pokeAgendaBtn}{batalhaChatBtn}<button onClick={handleLogout} className="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 text-sm">Sair</button>
                </div>
              </div>
            </div>
          </div>

          {/* Corpo */}
          <div className="max-w-4xl mx-auto px-4 py-6">
            {smartPokefoneMessages.length === 0 ? (
              <div className={`flex flex-col items-center justify-center py-24 gap-3 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                <Send size={40} className="opacity-40" />
                <p className="text-lg font-medium">Nenhuma mensagem</p>
                <p className="text-sm">Suas recompensas de quests aparecerão aqui.</p>
              </div>
            ) : (
              <div className="space-y-2">
                {[...smartPokefoneMessages].reverse().map(msg => {
                  const isExpanded = expandedMessageId === msg.id
                  return (
                    <div
                      key={msg.id}
                      className={`rounded-xl border transition-all cursor-pointer ${
                        darkMode
                          ? `border-gray-700 ${msg.lida ? 'bg-gray-800' : 'bg-gray-750 border-l-4 border-l-yellow-500'}`
                          : `border-gray-200 ${msg.lida ? 'bg-white' : 'bg-yellow-50 border-l-4 border-l-yellow-400'}`
                      } shadow-sm`}
                      onClick={() => {
                        setExpandedMessageId(isExpanded ? null : msg.id)
                        if (!msg.lida) {
                          setSmartPokefoneMessages(prev => prev.map(m => m.id === msg.id ? { ...m, lida: true } : m))
                        }
                      }}
                    >
                      <div className="flex items-center gap-3 px-4 py-3">
                        {/* Indicador não-lido */}
                        <div className={`w-2 h-2 rounded-full flex-shrink-0 ${msg.lida ? 'bg-transparent' : 'bg-yellow-400'}`} />
                        {/* Ícone remetente */}
                        <div className="w-9 h-9 rounded-full bg-gradient-to-br from-yellow-400 to-orange-500 flex items-center justify-center flex-shrink-0">
                          <Sparkles size={16} className="text-white" />
                        </div>
                        <div className="flex-1 min-w-0">
                          <div className="flex items-center justify-between gap-2">
                            <span className={`text-xs font-semibold ${darkMode ? 'text-yellow-400' : 'text-yellow-600'}`}>Sistema de Quests</span>
                            <span className={`text-xs flex-shrink-0 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>{msg.recebidaEm ? new Date(msg.recebidaEm).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' }) : ''}</span>
                          </div>
                          <p className={`text-sm font-bold truncate ${darkMode ? 'text-white' : 'text-gray-800'} ${!msg.lida ? 'font-extrabold' : ''}`}>{msg.assunto}</p>
                          {!isExpanded && <p className={`text-xs truncate ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>{msg.corpo}</p>}
                        </div>
                        <div className="flex items-center gap-1 flex-shrink-0">
                          {isExpanded ? <ChevronUp size={16} className={darkMode ? 'text-gray-400' : 'text-gray-500'} /> : <ChevronDown size={16} className={darkMode ? 'text-gray-400' : 'text-gray-500'} />}
                          <button
                            onClick={(e) => {
                              e.stopPropagation()
                              setSmartPokefoneMessages(prev => prev.filter(m => m.id !== msg.id))
                              if (expandedMessageId === msg.id) setExpandedMessageId(null)
                            }}
                            className="p-1 rounded-lg text-red-400 hover:text-red-300 hover:bg-red-900/20 transition-colors"
                            title="Excluir mensagem"
                          >
                            <Trash2 size={15} />
                          </button>
                        </div>
                      </div>
                      {/* Corpo expandido */}
                      {isExpanded && (
                        <div className={`px-4 pb-4 pt-1 border-t ${darkMode ? 'border-gray-700' : 'border-gray-100'}`}>
                          <div className={`rounded-lg p-4 ${darkMode ? 'bg-gray-900' : 'bg-gray-50'}`}>
                            <p className={`text-sm leading-relaxed whitespace-pre-wrap ${darkMode ? 'text-gray-200' : 'text-gray-700'}`}>{msg.corpo}</p>
                          </div>
                        </div>
                      )}
                    </div>
                  )
                })}
              </div>
            )}
          </div>
        </div>
        {accountDataModal}
        {scenarioPopupOverlay}
        {mostrarTriunfosOverlay}
        {pokezapPanel}{pokeAgendaPanel}
        {batalhaChatPanel}
      </>
    )
  }

  // ===== CENTRAL NIAYPETA RIO CORP™ M (MESTRE) =====
  if (currentUser.type === 'mestre' && currentArea === 'Central Niaypeta Rio Corp™ M') {
    const QUESTS_PER_PAGE = 9
    const activeQuests = quests.filter(q => (q.realizadores || []).length < q.limite)
    const inactiveQuests = quests.filter(q => (q.realizadores || []).length >= q.limite)
    const displayedQuests = questSubAreaMestre === 'Ativas' ? activeQuests : inactiveQuests
    const totalPages = Math.ceil(displayedQuests.length / QUESTS_PER_PAGE)
    const pagedQuests = displayedQuests.slice(questPageMestre * QUESTS_PER_PAGE, (questPageMestre + 1) * QUESTS_PER_PAGE)
    const trainerUsers = users.filter(u => u.type === 'treinador')

    return (
      <>
        <div className={`min-h-screen ${mainBgClass}`}>
          {sidebarNav}
          {/* Header */}
          <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-lg`}>
            <div className="max-w-7xl mx-auto px-4 py-4">
              <div className="flex justify-between items-center">
                <div className="flex items-center gap-3">
                  <button onClick={() => setSidebarOpen(true)} className={`p-2 rounded-lg ${darkMode ? 'hover:bg-gray-700 text-gray-400' : 'hover:bg-gray-200 text-gray-500'}`}><Menu size={24} /></button>
                  <h2 className={`text-lg sm:text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Central Niaypeta Rio Corp™ 👑</h2>
                </div>
                <div className="flex gap-2 items-center">
                  <button onClick={() => setShowAccountDataModal(true)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-200 text-gray-700'}`} title="Dados da Conta"><ArrowDownUp size={18} /></button>
                  <button onClick={() => setDarkMode(!darkMode)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-yellow-400' : 'bg-gray-200 text-gray-700'}`}>{darkMode ? <Sun size={18} /> : <Moon size={18} />}</button>
                  {pokezapBtn}{pokeAgendaBtn}{batalhaChatBtn}<button onClick={handleLogout} className="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 text-sm">Sair</button>
                </div>
              </div>
            </div>
          </div>

          <div className="max-w-7xl mx-auto px-4 py-6">
            {/* Sub-abas */}
            <div className="flex gap-2 mb-6">
              {['Ativas', 'Inativas'].map(tab => (
                <button
                  key={tab}
                  onClick={() => { setQuestSubAreaMestre(tab); setQuestPageMestre(0); setExpandedQuestIdMestre(null) }}
                  className={`px-5 py-2 rounded-lg font-semibold text-sm transition-colors ${
                    questSubAreaMestre === tab
                      ? 'bg-yellow-500 text-gray-900'
                      : darkMode ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-white text-gray-600 hover:bg-gray-100'
                  }`}
                >
                  {tab === 'Ativas' ? `Quests Ativas (${activeQuests.length})` : `Quests Inativas (${inactiveQuests.length})`}
                </button>
              ))}
              {questSubAreaMestre === 'Ativas' && (
                <button
                  onClick={() => { setEditingQuest(null); setQuestForm({ nome: '', descricao: '', limite: 1, recompensa: '' }); setShowNewQuestModal(true) }}
                  className="ml-auto flex items-center gap-2 bg-yellow-500 hover:bg-yellow-400 text-gray-900 font-bold px-4 py-2 rounded-lg text-sm transition-colors"
                >
                  <Plus size={16} /> Nova Quest
                </button>
              )}
            </div>

            {/* Grid de quests */}
            {pagedQuests.length === 0 ? (
              <div className={`text-center py-20 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                <Trophy size={40} className="mx-auto mb-3 opacity-30" />
                <p>{questSubAreaMestre === 'Ativas' ? 'Nenhuma quest ativa.' : 'Nenhuma quest inativa.'}</p>
              </div>
            ) : (
              <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 items-start">
                {pagedQuests.map(quest => {
                  const isExpanded = expandedQuestIdMestre === quest.id
                  const realizadores = quest.realizadores || []
                  const progress = realizadores.length
                  return (
                    <div
                      key={quest.id}
                      className={`rounded-xl border transition-all ${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'} shadow-md`}
                    >
                      {/* Cabeçalho clicável */}
                      <div
                        className="flex items-center justify-between px-4 py-3 cursor-pointer"
                        onClick={() => setExpandedQuestIdMestre(isExpanded ? null : quest.id)}
                      >
                        <div className="flex items-center gap-2 min-w-0">
                          <Trophy size={16} className="text-yellow-500 flex-shrink-0" />
                          <span className={`font-bold text-sm truncate ${darkMode ? 'text-white' : 'text-gray-800'}`}>{quest.nome}</span>
                        </div>
                        <div className="flex items-center gap-1 flex-shrink-0 ml-2">
                          <span className={`text-xs px-2 py-0.5 rounded-full font-semibold ${progress >= quest.limite ? 'bg-gray-500 text-white' : 'bg-yellow-500 text-gray-900'}`}>
                            {progress}/{quest.limite}
                          </span>
                          {isExpanded ? <ChevronUp size={15} className={darkMode ? 'text-gray-400' : 'text-gray-500'} /> : <ChevronDown size={15} className={darkMode ? 'text-gray-400' : 'text-gray-500'} />}
                        </div>
                      </div>

                      {/* Conteúdo expandido */}
                      {isExpanded && (
                        <div className={`px-4 pb-4 border-t ${darkMode ? 'border-gray-700' : 'border-gray-100'}`}>
                          <div className="pt-3 space-y-2">
                            <div>
                              <p className={`text-xs font-semibold uppercase tracking-wide mb-1 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Descrição</p>
                              <p className={`text-sm ${darkMode ? 'text-gray-200' : 'text-gray-700'}`}>{quest.descricao || '—'}</p>
                            </div>
                            <div>
                              <p className={`text-xs font-semibold uppercase tracking-wide mb-1 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Recompensa</p>
                              <p className={`text-sm font-medium text-yellow-500`}>{quest.recompensa || '—'}</p>
                            </div>
                            <div>
                              <p className={`text-xs font-semibold uppercase tracking-wide mb-1 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Realizadores ({progress}/{quest.limite})</p>
                              {realizadores.length === 0 ? (
                                <p className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>Nenhum ainda.</p>
                              ) : (
                                <div className="flex flex-wrap gap-1">
                                  {realizadores.map(r => {
                                    const u = trainerUsers.find(u => u.username === r)
                                    return (
                                      <span key={r} className="text-xs text-white font-bold px-2 py-0.5 rounded-full" style={{ background: u?.gradient || '#4169E1' }}>{r}</span>
                                    )
                                  })}
                                </div>
                              )}
                            </div>
                          </div>
                          <div className="flex gap-2 mt-3">
                            <button
                              onClick={() => { setEditingQuest(quest); setQuestForm({ nome: quest.nome, descricao: quest.descricao || '', limite: quest.limite, recompensa: quest.recompensa || '' }); setShowNewQuestModal(true) }}
                              className={`flex-1 py-1.5 rounded-lg text-xs font-semibold flex items-center justify-center gap-1 ${darkMode ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}
                            >
                              <Pencil size={13} /> Editar
                            </button>
                            <button
                              onClick={() => {
                                if (confirm(`Excluir a quest "${quest.nome}"?`)) {
                                  setQuests(prev => prev.filter(q => q.id !== quest.id))
                                  setExpandedQuestIdMestre(null)
                                }
                              }}
                              className="flex-1 py-1.5 rounded-lg text-xs font-semibold flex items-center justify-center gap-1 bg-red-100 text-red-600 hover:bg-red-200 transition-colors"
                            >
                              <Trash2 size={13} /> Excluir
                            </button>
                          </div>
                        </div>
                      )}
                    </div>
                  )
                })}
              </div>
            )}

            {/* Paginação */}
            {totalPages > 1 && (
              <div className="flex justify-center items-center gap-3 mt-6">
                <button disabled={questPageMestre === 0} onClick={() => setQuestPageMestre(p => p - 1)} className={`px-3 py-1.5 rounded-lg text-sm font-semibold ${questPageMestre === 0 ? 'opacity-40 cursor-not-allowed' : ''} ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-white text-gray-700 hover:bg-gray-100 border'}`}>
                  <ChevronLeft size={16} />
                </button>
                <span className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>{questPageMestre + 1} / {totalPages}</span>
                <button disabled={questPageMestre >= totalPages - 1} onClick={() => setQuestPageMestre(p => p + 1)} className={`px-3 py-1.5 rounded-lg text-sm font-semibold ${questPageMestre >= totalPages - 1 ? 'opacity-40 cursor-not-allowed' : ''} ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-white text-gray-700 hover:bg-gray-100 border'}`}>
                  <ChevronRight size={16} />
                </button>
              </div>
            )}
          </div>
        </div>

        {/* Modal Nova / Editar Quest */}
        {showNewQuestModal && (
          <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4" onClick={() => setShowNewQuestModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-lg w-full`} onClick={e => e.stopPropagation()}>
              <div className="p-6">
                <div className="flex justify-between items-center mb-5">
                  <h3 className={`text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{editingQuest ? 'Editar Quest' : 'Nova Quest'}</h3>
                  <button onClick={() => setShowNewQuestModal(false)} className={darkMode ? 'text-gray-400 hover:text-white' : 'text-gray-500 hover:text-gray-700'}><X size={22} /></button>
                </div>
                <div className="space-y-4">
                  <div>
                    <label className={`block text-sm font-bold mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Nome</label>
                    <input type="text" value={questForm.nome} onChange={e => setQuestForm(f => ({ ...f, nome: e.target.value }))} placeholder="Nome da quest..." className={`w-full px-3 py-2 border rounded-lg text-sm ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'border-gray-300 text-gray-800'}`} />
                  </div>
                  <div>
                    <label className={`block text-sm font-bold mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Descrição</label>
                    <textarea value={questForm.descricao} onChange={e => setQuestForm(f => ({ ...f, descricao: e.target.value }))} placeholder="Descrição da quest..." rows={3} className={`w-full px-3 py-2 border rounded-lg text-sm resize-none ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'border-gray-300 text-gray-800'}`} />
                  </div>
                  <div>
                    <label className={`block text-sm font-bold mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Limite de realizadores</label>
                    <select value={questForm.limite} onChange={e => setQuestForm(f => ({ ...f, limite: Number(e.target.value) }))} className={`w-full px-3 py-2 border rounded-lg text-sm ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300 text-gray-800'}`}>
                      {[1, 2, 3, 4, 5].map(n => <option key={n} value={n}>{n}</option>)}
                    </select>
                  </div>
                  <div>
                    <label className={`block text-sm font-bold mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Recompensa</label>
                    <input type="text" value={questForm.recompensa} onChange={e => setQuestForm(f => ({ ...f, recompensa: e.target.value }))} placeholder="Descreva a recompensa..." className={`w-full px-3 py-2 border rounded-lg text-sm ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'border-gray-300 text-gray-800'}`} />
                  </div>
                </div>
                <div className="flex gap-3 mt-6">
                  <button onClick={() => setShowNewQuestModal(false)} className={`flex-1 py-2 rounded-lg font-semibold text-sm ${darkMode ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>Cancelar</button>
                  <button
                    onClick={() => {
                      if (!questForm.nome.trim()) { alert('Digite um nome para a quest.'); return }
                      if (!questForm.recompensa.trim()) { alert('Digite a recompensa da quest.'); return }
                      if (editingQuest) {
                        setQuests(prev => prev.map(q => q.id === editingQuest.id ? { ...q, ...questForm } : q))
                      } else {
                        setQuests(prev => [...prev, { id: `quest_${Date.now()}`, ...questForm, realizadores: [] }])
                      }
                      setShowNewQuestModal(false)
                    }}
                    className="flex-1 py-2 rounded-lg font-semibold text-sm bg-yellow-500 hover:bg-yellow-400 text-gray-900 transition-colors"
                  >Salvar</button>
                </div>
              </div>
            </div>
          </div>
        )}

        {accountDataModal}
        {scenarioPopupOverlay}
        {mostrarTriunfosOverlay}
        {pokezapPanel}{pokeAgendaPanel}
        {batalhaChatPanel}
      </>
    )
  }

  // ===== CENTRAL NIAYPETA RIO CORP™ (TREINADOR) =====
  if (currentUser.type === 'treinador' && currentArea === 'Central Niaypeta Rio Corp™') {
    const QUESTS_PER_PAGE = 9
    const activeQuests = quests.filter(q => (q.realizadores || []).length < q.limite)
    const inactiveQuests = quests.filter(q => (q.realizadores || []).length >= q.limite)
    const displayedQuests = questSubAreaTreinador === 'Ativas' ? activeQuests : inactiveQuests
    const totalPages = Math.ceil(displayedQuests.length / QUESTS_PER_PAGE)
    const pagedQuests = displayedQuests.slice(questPageTreinador * QUESTS_PER_PAGE, (questPageTreinador + 1) * QUESTS_PER_PAGE)
    const trainerUsers = users.filter(u => u.type === 'treinador')

    return (
      <>
        <div className={`min-h-screen ${mainBgClass}`}>
          {sidebarNav}
          {/* Header */}
          <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-lg`}>
            <div className="max-w-7xl mx-auto px-4 py-4">
              <div className="flex justify-between items-center">
                <div className="flex items-center gap-3">
                  <button onClick={() => setSidebarOpen(true)} className={`p-2 rounded-lg ${darkMode ? 'hover:bg-gray-700 text-gray-400' : 'hover:bg-gray-200 text-gray-500'}`}><Menu size={24} /></button>
                  <h2 className={`text-lg sm:text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Central Niaypeta Rio Corp™</h2>
                </div>
                <div className="flex gap-2 items-center">
                  <button onClick={() => setDarkMode(!darkMode)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-yellow-400' : 'bg-gray-200 text-gray-700'}`}>{darkMode ? <Sun size={18} /> : <Moon size={18} />}</button>
                  {pokezapBtn}{pokeAgendaBtn}{batalhaChatBtn}<button onClick={handleLogout} className="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 text-sm">Sair</button>
                </div>
              </div>
            </div>
          </div>

          <div className="max-w-7xl mx-auto px-4 py-6">
            {/* Sub-abas */}
            <div className="flex gap-2 mb-6">
              {['Ativas', 'Inativas'].map(tab => (
                <button
                  key={tab}
                  onClick={() => { setQuestSubAreaTreinador(tab); setQuestPageTreinador(0); setExpandedQuestIdTreinador(null) }}
                  className={`px-5 py-2 rounded-lg font-semibold text-sm transition-colors ${
                    questSubAreaTreinador === tab
                      ? 'bg-yellow-500 text-gray-900'
                      : darkMode ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-white text-gray-600 hover:bg-gray-100'
                  }`}
                >
                  {tab === 'Ativas' ? `Quests Ativas (${activeQuests.length})` : `Quests Inativas (${inactiveQuests.length})`}
                </button>
              ))}
            </div>

            {/* Grid de quests */}
            {pagedQuests.length === 0 ? (
              <div className={`text-center py-20 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                <Trophy size={40} className="mx-auto mb-3 opacity-30" />
                <p>{questSubAreaTreinador === 'Ativas' ? 'Nenhuma quest ativa no momento.' : 'Nenhuma quest inativa.'}</p>
              </div>
            ) : (
              <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 items-start">
                {pagedQuests.map(quest => {
                  const isExpanded = expandedQuestIdTreinador === quest.id
                  const realizadores = quest.realizadores || []
                  const jaRealizou = realizadores.includes(currentUser.username)
                  const progress = realizadores.length
                  return (
                    <div
                      key={quest.id}
                      className={`rounded-xl border transition-all ${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'} shadow-md`}
                    >
                      {/* Cabeçalho clicável */}
                      <div
                        className="flex items-center justify-between px-4 py-3 cursor-pointer"
                        onClick={() => setExpandedQuestIdTreinador(isExpanded ? null : quest.id)}
                      >
                        <div className="flex items-center gap-2 min-w-0">
                          <Trophy size={16} className={jaRealizou ? 'text-green-500' : 'text-yellow-500'} />
                          <span className={`font-bold text-sm truncate ${darkMode ? 'text-white' : 'text-gray-800'}`}>{quest.nome}</span>
                        </div>
                        <div className="flex items-center gap-1 flex-shrink-0 ml-2">
                          <span className={`text-xs px-2 py-0.5 rounded-full font-semibold ${progress >= quest.limite ? 'bg-gray-500 text-white' : 'bg-yellow-500 text-gray-900'}`}>
                            {progress}/{quest.limite}
                          </span>
                          {isExpanded ? <ChevronUp size={15} className={darkMode ? 'text-gray-400' : 'text-gray-500'} /> : <ChevronDown size={15} className={darkMode ? 'text-gray-400' : 'text-gray-500'} />}
                        </div>
                      </div>

                      {/* Conteúdo expandido */}
                      {isExpanded && (
                        <div className={`px-4 pb-4 border-t ${darkMode ? 'border-gray-700' : 'border-gray-100'}`}>
                          <div className="pt-3 space-y-2">
                            <div>
                              <p className={`text-xs font-semibold uppercase tracking-wide mb-1 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Descrição</p>
                              <p className={`text-sm ${darkMode ? 'text-gray-200' : 'text-gray-700'}`}>{quest.descricao || '—'}</p>
                            </div>
                            <div>
                              <p className={`text-xs font-semibold uppercase tracking-wide mb-1 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Recompensa</p>
                              <p className="text-sm font-medium text-yellow-500">{quest.recompensa || '—'}</p>
                            </div>
                            <div>
                              <p className={`text-xs font-semibold uppercase tracking-wide mb-1 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Realizadores ({progress}/{quest.limite})</p>
                              {realizadores.length === 0 ? (
                                <p className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>Nenhum ainda.</p>
                              ) : (
                                <div className="flex flex-wrap gap-1">
                                  {realizadores.map(r => {
                                    const u = trainerUsers.find(u => u.username === r)
                                    return (
                                      <span key={r} className="text-xs text-white font-bold px-2 py-0.5 rounded-full" style={{ background: u?.gradient || '#4169E1' }}>{r}</span>
                                    )
                                  })}
                                </div>
                              )}
                            </div>
                          </div>

                          {/* Botão Realizar Quest */}
                          {questSubAreaTreinador === 'Ativas' && (
                            <button
                              disabled={jaRealizou || progress >= quest.limite}
                              onClick={() => {
                                if (jaRealizou || progress >= quest.limite) return
                                // Adiciona o treinador à lista de realizadores
                                setQuests(prev => prev.map(q =>
                                  q.id === quest.id
                                    ? { ...q, realizadores: [...(q.realizadores || []), currentUser.username] }
                                    : q
                                ))
                                // Envia mensagem para o SmartPokefone do treinador
                                const novaMensagem = {
                                  id: `msg_${Date.now()}`,
                                  assunto: `Quest realizada: ${quest.nome}`,
                                  corpo: `Parabéns, ${currentUser.username}! Você realizou a quest "${quest.nome}".\n\nRecompensa: ${quest.recompensa}`,
                                  recebidaEm: Date.now(),
                                  lida: false
                                }
                                // Salva diretamente no Firebase para o treinador atual
                                loadSmartPokefoneMessages(currentUser.username).then(existing => {
                                  const msgs = Array.isArray(existing) ? existing : Object.values(existing || {})
                                  saveSmartPokefoneMessages(currentUser.username, [...msgs, novaMensagem])
                                })
                                setSmartPokefoneMessages(prev => [...prev, novaMensagem])
                              }}
                              className={`w-full mt-3 py-2 rounded-lg font-bold text-sm transition-colors flex items-center justify-center gap-2 ${
                                jaRealizou
                                  ? 'bg-green-700 text-green-200 cursor-not-allowed'
                                  : progress >= quest.limite
                                  ? 'bg-gray-600 text-gray-400 cursor-not-allowed'
                                  : 'bg-yellow-500 hover:bg-yellow-400 text-gray-900'
                              }`}
                            >
                              {jaRealizou ? <><Check size={15} /> Quest Realizada</> : progress >= quest.limite ? 'Limite atingido' : <><Target size={15} /> Realizar Quest</>}
                            </button>
                          )}
                        </div>
                      )}
                    </div>
                  )
                })}
              </div>
            )}

            {/* Paginação */}
            {totalPages > 1 && (
              <div className="flex justify-center items-center gap-3 mt-6">
                <button disabled={questPageTreinador === 0} onClick={() => setQuestPageTreinador(p => p - 1)} className={`px-3 py-1.5 rounded-lg text-sm font-semibold ${questPageTreinador === 0 ? 'opacity-40 cursor-not-allowed' : ''} ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-white text-gray-700 hover:bg-gray-100 border'}`}>
                  <ChevronLeft size={16} />
                </button>
                <span className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>{questPageTreinador + 1} / {totalPages}</span>
                <button disabled={questPageTreinador >= totalPages - 1} onClick={() => setQuestPageTreinador(p => p + 1)} className={`px-3 py-1.5 rounded-lg text-sm font-semibold ${questPageTreinador >= totalPages - 1 ? 'opacity-40 cursor-not-allowed' : ''} ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-white text-gray-700 hover:bg-gray-100 border'}`}>
                  <ChevronRight size={16} />
                </button>
              </div>
            )}
          </div>
        </div>
        {accountDataModal}
        {scenarioPopupOverlay}
        {mostrarTriunfosOverlay}
        {pokezapPanel}{pokeAgendaPanel}
        {batalhaChatPanel}
      </>
    )
  }

  // ===== TRIUNFOS M (MESTRE) =====
  if (currentUser.type === 'mestre' && currentArea === 'Objetivos M') {
    const trainerUsers = users.filter(u => u.type === 'treinador')

    const handleSalvarTriunfosGerais = () => {
      const novos = triunfoGeralFields
        .filter(f => f.texto.trim())
        .map(f => ({ id: Date.now() + Math.random(), texto: f.texto.trim(), vagas: f.vagas || 1, realizadores: [] }))
      if (novos.length === 0) return
      setTriunfosGerais(prev => [...prev, ...novos])
      setShowAddTriunfoGeralModal(false)
      setTriunfoGeralFields([{ texto: '', vagas: 1 }])
    }

    const handleSalvarTriunfosIndividuais = () => {
      const novos = triunfoIndividualFields
        .filter(f => f.texto.trim())
        .map(f => ({ id: Date.now() + Math.random(), texto: f.texto.trim(), realizado: false }))
      if (novos.length === 0) return
      setTriunfosIndividuais(prev => ({
        ...prev,
        [triunfoIndividualTargetUser]: [...(prev[triunfoIndividualTargetUser] || []), ...novos]
      }))
      setShowAddTriunfoIndividualModal(false)
      setTriunfoIndividualFields([{ texto: '' }])
      setTriunfoIndividualTargetUser('')
    }

    const handleCheckGeral = (triunfoId) => {
      setTempSelectedUsers([])
      setSelectUserForTriunfoData({ triunfoId })
      setShowSelectUserForTriunfo(true)
    }

    const handleConfirmarSelectUsers = () => {
      if (tempSelectedUsers.length === 0) return
      setTriunfosGerais(prev => prev.map(t => {
        if (t.id !== selectUserForTriunfoData.triunfoId) return t
        const existing = t.realizadores || []
        const newOnes = tempSelectedUsers.filter(u => !existing.includes(u))
        const combined = [...existing, ...newOnes].slice(0, t.vagas)
        return { ...t, realizadores: combined }
      }))
      setShowSelectUserForTriunfo(false)
      setSelectUserForTriunfoData(null)
      setTempSelectedUsers([])
    }

    const handleCheckIndividual = (username, triunfoId) => {
      setTriunfosIndividuais(prev => ({
        ...prev,
        [username]: (prev[username] || []).map(t =>
          t.id === triunfoId ? { ...t, realizado: true } : t
        )
      }))
    }

    const handleEnviarEmailTriunfos = () => {
      const trainerNames = trainerUsers.map(u => u.username)
      triunfosGerais.forEach(t => {
        ;(t.realizadores || []).forEach(username => {
          if (!trainerNames.includes(username)) return
          const msg = {
            id: `msg_${Date.now()}_${username}_${t.id}`,
            assunto: `Objetivo Geral obtido: ${t.texto}`,
            corpo: `Parabéns, ${username}! Você obteve o objetivo geral:\n\n"${t.texto}"`,
            recebidaEm: Date.now(),
            lida: false
          }
          loadSmartPokefoneMessages(username).then(existing => {
            const msgs = Array.isArray(existing) ? existing : Object.values(existing || {})
            saveSmartPokefoneMessages(username, [...msgs, msg])
          })
        })
      })
      Object.entries(triunfosIndividuais).forEach(([username, lista]) => {
        if (!trainerNames.includes(username)) return
        const concluidos = (lista || []).filter(t => t.realizado)
        if (concluidos.length === 0) return
        const corpo = concluidos.map(t => `• ${t.texto}`).join('\n')
        const msg = {
          id: `msg_${Date.now()}_${username}_ind`,
          assunto: `Seus Objetivos Individuais`,
          corpo: `Parabéns, ${username}! Você obteve os seguintes objetivos individuais:\n\n${corpo}`,
          recebidaEm: Date.now(),
          lida: false
        }
        loadSmartPokefoneMessages(username).then(existing => {
          const msgs = Array.isArray(existing) ? existing : Object.values(existing || {})
          saveSmartPokefoneMessages(username, [...msgs, msg])
        })
      })
      alert('Objetivos enviados para o SmartPokefone dos usuários!')
    }

    const triunfoGeralSelecionado = selectUserForTriunfoData
      ? triunfosGerais.find(t => t.id === selectUserForTriunfoData.triunfoId)
      : null
    const jaRealizadores = triunfoGeralSelecionado?.realizadores || []
    const slotsRestantes = triunfoGeralSelecionado ? triunfoGeralSelecionado.vagas - jaRealizadores.length : 0
    const disponiveis = trainerUsers.filter(u => !jaRealizadores.includes(u.username))

    return (
      <>
        <div className={`min-h-screen ${mainBgClass}`}>
          {sidebarNav}
          <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-lg`}>
            <div className="max-w-7xl mx-auto px-4 py-4">
              <div className="flex justify-between items-center mb-4">
                <div className="flex items-center gap-3"><button onClick={() => setSidebarOpen(true)} className={`p-2 rounded-lg ${darkMode ? "hover:bg-gray-700 text-gray-400" : "hover:bg-gray-200 text-gray-500"}`}><Menu size={24} /></button><h2 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Objetivos 👑</h2></div>
                <div className="flex gap-2">
                  <button onClick={() => setDarkMode(!darkMode)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-yellow-400' : 'bg-gray-200 text-gray-700'}`}>
                    {darkMode ? <Sun size={20} /> : <Moon size={20} />}
                  </button>
                  {pokezapBtn}{pokeAgendaBtn}{batalhaChatBtn}<button onClick={handleLogout} className="bg-red-500 text-white px-3 sm:px-5 md:px-6 py-2 rounded-lg hover:bg-red-600">Sair</button>
                </div>
              </div>
            </div>
          </div>

          {!spoilerMestreConfirmado && (
            <div className="max-w-7xl mx-auto px-4 py-3 sm:py-5 md:py-8 flex flex-col items-center justify-center min-h-[60vh] text-center gap-6">
              <div className="text-6xl">⚠️</div>
              <h2 className={`text-3xl font-bold ${darkMode ? 'text-yellow-400' : 'text-yellow-600'}`}>Alerta de Spoiler</h2>
              <p className={`text-base max-w-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                Esta área contém informações confidenciais do Arco. Prossiga apenas se tiver certeza.
              </p>
              <button
                onClick={() => setSpoilerMestreConfirmado(true)}
                className="bg-yellow-500 hover:bg-yellow-600 text-black font-bold px-8 py-3 rounded-xl text-lg transition-colors"
              >
                Sou o mestre do Arco.
              </button>
            </div>
          )}
          {spoilerMestreConfirmado && (
          <div className="max-w-7xl mx-auto px-4 py-3 sm:py-5 md:py-8">
            {/* Header */}
            <div className="flex items-center justify-between mb-6">
              <div className="flex items-center gap-3">
                <Trophy size={28} className="text-yellow-400" />
                <h1 className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Objetivos</h1>
              </div>
              <button
                onClick={handleEnviarEmailTriunfos}
                className="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold text-sm transition-colors"
              >
                <Send size={16} />
                Enviar para email
              </button>
            </div>

            {/* ===== OBJETIVOS GERAIS ===== */}
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-lg p-5 mb-6`}>
              <div className="flex items-center justify-between mb-4">
                <div className="flex items-center gap-2">
                  <Trophy size={20} className="text-yellow-400" />
                  <h2 className={`text-lg font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Objetivos Gerais</h2>
                </div>
                <div className="flex gap-2 flex-wrap justify-end">
                  {triunfosGerais.length > 0 && (
                    <button
                      onClick={() => { const d = { ativo: true, tipo: 'geral' }; setMostrarTriunfosData(d); setMostrarTriunfosMinimized(false); saveMostrarTriunfos(d) }}
                      className="flex items-center gap-1.5 bg-purple-600 hover:bg-purple-700 text-white px-3 py-2 rounded-lg font-semibold text-sm transition-colors"
                    >
                      <Users size={14} />
                      Mostrar Objetivos
                    </button>
                  )}
                  <button
                    onClick={() => { setTriunfoGeralFields([{ texto: '', vagas: 1 }]); setShowAddTriunfoGeralModal(true) }}
                    className="flex items-center gap-1.5 bg-yellow-500 hover:bg-yellow-400 text-gray-900 px-3 py-2 rounded-lg font-semibold text-sm transition-colors"
                  >
                    <Trophy size={14} />
                    Adicionar Objetivos Gerais
                  </button>
                </div>
              </div>

              {triunfosGerais.length === 0 ? (
                <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-500'} text-center py-6`}>Nenhum objetivo geral ainda.</p>
              ) : (
                <div className="space-y-3">
                  {triunfosGerais.map(t => {
                    const realizadores = t.realizadores || []
                    const completo = realizadores.length >= t.vagas
                    return (
                      <div key={t.id} className={`p-4 rounded-xl border ${darkMode ? 'border-gray-700 bg-gray-900' : 'border-gray-200 bg-gray-50'}`}>
                        <div className="flex items-start justify-between gap-3">
                          <div className="flex-1 min-w-0">
                            <p className={`font-semibold text-sm sm:text-base ${completo ? 'text-blue-400' : 'text-white'}`}>{t.texto}</p>
                            <p className={`text-xs mt-1 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>{realizadores.length}/{t.vagas} realizadores</p>
                            {realizadores.length > 0 && (
                              <div className="flex flex-wrap gap-1 mt-2">
                                {realizadores.map(u => {
                                  const uData = users.find(usr => usr.username === u)
                                  return (
                                    <span key={u} className="inline-flex items-center gap-1 text-xs font-bold text-white px-2 py-0.5 rounded-full" style={{ background: uData?.gradient || '#555' }}>
                                      {u}
                                      <button
                                        onClick={() => setTriunfosGerais(prev => prev.map(tr => tr.id === t.id ? { ...tr, realizadores: (tr.realizadores || []).filter(r => r !== u) } : tr))}
                                        className="opacity-80 hover:opacity-100 transition-opacity ml-0.5"
                                        title={`Remover ${u}`}
                                      >
                                        <X size={10} />
                                      </button>
                                    </span>
                                  )
                                })}
                              </div>
                            )}
                          </div>
                          <div className="flex gap-2 flex-shrink-0">
                            {!completo && (
                              <button
                                onClick={() => handleCheckGeral(t.id)}
                                className="w-8 h-8 rounded-full bg-green-600 hover:bg-green-500 flex items-center justify-center transition-colors"
                                title="Marcar realizadores"
                              >
                                <Check size={16} className="text-white" />
                              </button>
                            )}
                            {completo && (
                              <div className="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center">
                                <Check size={16} className="text-white" />
                              </div>
                            )}
                            <button
                              onClick={() => setEditingTriunfoGeral({ id: t.id, texto: t.texto, vagas: t.vagas })}
                              className="w-8 h-8 rounded-full bg-yellow-500 hover:bg-yellow-400 flex items-center justify-center transition-colors"
                              title="Editar"
                            >
                              <Pencil size={14} className="text-gray-900" />
                            </button>
                            <button
                              onClick={() => setTriunfosGerais(prev => prev.filter(x => x.id !== t.id))}
                              className="w-8 h-8 rounded-full bg-red-600 hover:bg-red-500 flex items-center justify-center transition-colors"
                              title="Remover"
                            >
                              <X size={14} className="text-white" />
                            </button>
                          </div>
                        </div>
                      </div>
                    )
                  })}
                </div>
              )}
            </div>

            {/* ===== OBJETIVOS INDIVIDUAIS ===== */}
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-lg p-5`}>
              <div className="flex items-center gap-2 mb-4">
                <Award size={20} className="text-red-500" />
                <h2 className={`text-lg font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Objetivos Individuais</h2>
              </div>
              <div className="space-y-4">
                {trainerUsers.map(user => {
                  const lista = triunfosIndividuais[user.username] || []
                  return (
                    <div key={user.username} className={`p-4 rounded-xl border ${darkMode ? 'border-gray-700 bg-gray-900' : 'border-gray-200 bg-gray-50'}`}>
                      <div className="flex items-center justify-between mb-3 flex-wrap gap-2">
                        <span className="text-sm font-bold text-white px-3 py-1 rounded-full" style={{ background: user.gradient }}>
                          {user.username}
                        </span>
                        <div className="flex gap-2">
                          {lista.length > 0 && (
                            <button
                              onClick={() => { const d = { ativo: true, tipo: 'individual', username: user.username }; setMostrarTriunfosData(d); setMostrarTriunfosMinimized(false); saveMostrarTriunfos(d) }}
                              className="flex items-center gap-1 bg-purple-600 hover:bg-purple-700 text-white px-2 py-1.5 rounded-lg font-semibold text-xs transition-colors"
                            >
                              <Users size={12} />
                              Mostrar
                            </button>
                          )}
                          <button
                            onClick={() => { setTriunfoIndividualTargetUser(user.username); setTriunfoIndividualFields([{ texto: '' }]); setShowAddTriunfoIndividualModal(true) }}
                            className="flex items-center gap-1 bg-red-600 hover:bg-red-500 text-white px-2 py-1.5 rounded-lg font-semibold text-xs transition-colors"
                          >
                            <Award size={12} />
                            + Objetivo
                          </button>
                        </div>
                      </div>
                      {lista.length === 0 ? (
                        <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'} text-center py-2`}>Nenhum objetivo ainda.</p>
                      ) : (
                        <div className="space-y-2">
                          {lista.map(t => (
                            <div key={t.id} className="flex items-center justify-between gap-2">
                              <p className={`text-sm flex-1 ${t.realizado ? 'text-blue-400' : 'text-white'}`}>{t.texto}</p>
                              <div className="flex gap-1 flex-shrink-0">
                                {!t.realizado && (
                                  <button
                                    onClick={() => handleCheckIndividual(user.username, t.id)}
                                    className="w-7 h-7 rounded-full bg-green-600 hover:bg-green-500 flex items-center justify-center transition-colors"
                                    title="Marcar realizado"
                                  >
                                    <Check size={13} className="text-white" />
                                  </button>
                                )}
                                {t.realizado && (
                                  <button
                                    onClick={() => setTriunfosIndividuais(prev => ({
                                      ...prev,
                                      [user.username]: (prev[user.username] || []).map(x =>
                                        x.id === t.id ? { ...x, realizado: false } : x
                                      )
                                    }))}
                                    className="w-7 h-7 rounded-full bg-blue-600 hover:bg-blue-500 flex items-center justify-center transition-colors"
                                    title="Desmarcar realizado"
                                  >
                                    <Check size={13} className="text-white" />
                                  </button>
                                )}
                                <button
                                  onClick={() => setEditingTriunfoIndividual({ username: user.username, id: t.id, texto: t.texto })}
                                  className="w-7 h-7 rounded-full bg-yellow-500 hover:bg-yellow-400 flex items-center justify-center transition-colors"
                                  title="Editar"
                                >
                                  <Pencil size={11} className="text-gray-900" />
                                </button>
                                <button
                                  onClick={() => setTriunfosIndividuais(prev => ({
                                    ...prev,
                                    [user.username]: (prev[user.username] || []).filter(x => x.id !== t.id)
                                  }))}
                                  className="w-7 h-7 rounded-full bg-red-600 hover:bg-red-500 flex items-center justify-center transition-colors"
                                  title="Remover"
                                >
                                  <X size={11} className="text-white" />
                                </button>
                              </div>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  )
                })}
              </div>
            </div>
          </div>
          )}
        </div>

        {/* Modal: Adicionar Objetivos Gerais */}
        {showAddTriunfoGeralModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowAddTriunfoGeralModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-lg w-full max-h-[85vh] overflow-y-auto`} onClick={e => e.stopPropagation()}>
              <div className="p-5">
                <div className="flex justify-between items-center mb-5">
                  <h3 className={`text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Adicionar Objetivos Gerais</h3>
                  <button onClick={() => setShowAddTriunfoGeralModal(false)} className={`${darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}`}><X size={20} /></button>
                </div>
                <div className="space-y-3">
                  {triunfoGeralFields.map((field, idx) => (
                    <div key={idx} className="flex items-center gap-2">
                      <span className={`text-xs font-bold w-5 text-center flex-shrink-0 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>{idx + 1}.</span>
                      <input
                        type="text"
                        value={field.texto}
                        onChange={e => setTriunfoGeralFields(prev => prev.map((f, i) => i === idx ? { ...f, texto: e.target.value } : f))}
                        placeholder="Descreva o objetivo..."
                        className={`flex-1 px-3 py-2 rounded-lg border text-sm ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'border-gray-300 bg-white'}`}
                      />
                      <input
                        type="number"
                        min={1}
                        max={5}
                        value={field.vagas}
                        onChange={e => setTriunfoGeralFields(prev => prev.map((f, i) => i === idx ? { ...f, vagas: Math.min(5, Math.max(1, parseInt(e.target.value) || 1)) } : f))}
                        className={`w-14 px-2 py-2 rounded-lg border text-sm text-center ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300 bg-white'}`}
                        title="Vagas (1-5)"
                      />
                      {triunfoGeralFields.length > 1 && (
                        <button onClick={() => setTriunfoGeralFields(prev => prev.filter((_, i) => i !== idx))} className="text-red-400 hover:text-red-300 flex-shrink-0"><X size={16} /></button>
                      )}
                    </div>
                  ))}
                </div>
                <button
                  onClick={() => setTriunfoGeralFields(prev => [...prev, { texto: '', vagas: 1 }])}
                  className={`mt-3 flex items-center gap-1.5 text-sm font-semibold ${darkMode ? 'text-blue-400 hover:text-blue-300' : 'text-blue-600 hover:text-blue-700'}`}
                >
                  <Plus size={16} /> Adicionar campo
                </button>
                <div className="flex gap-3 mt-5">
                  <button onClick={() => setShowAddTriunfoGeralModal(false)} className={`flex-1 py-2.5 rounded-lg font-semibold text-sm ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}>Cancelar</button>
                  <button onClick={handleSalvarTriunfosGerais} className="flex-1 py-2.5 rounded-lg font-semibold text-sm bg-yellow-500 hover:bg-yellow-400 text-gray-900">Salvar</button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Modal: Adicionar Objetivos Individuais */}
        {showAddTriunfoIndividualModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowAddTriunfoIndividualModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-lg w-full max-h-[85vh] overflow-y-auto`} onClick={e => e.stopPropagation()}>
              <div className="p-5">
                <div className="flex justify-between items-center mb-5">
                  <h3 className={`text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Objetivos de {triunfoIndividualTargetUser}</h3>
                  <button onClick={() => setShowAddTriunfoIndividualModal(false)} className={`${darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}`}><X size={20} /></button>
                </div>
                <div className="space-y-3">
                  {triunfoIndividualFields.map((field, idx) => (
                    <div key={idx} className="flex items-center gap-2">
                      <span className={`text-xs font-bold w-5 text-center flex-shrink-0 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>{idx + 1}.</span>
                      <input
                        type="text"
                        value={field.texto}
                        onChange={e => setTriunfoIndividualFields(prev => prev.map((f, i) => i === idx ? { texto: e.target.value } : f))}
                        placeholder="Descreva o objetivo..."
                        className={`flex-1 px-3 py-2 rounded-lg border text-sm ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'border-gray-300 bg-white'}`}
                      />
                      {triunfoIndividualFields.length > 1 && (
                        <button onClick={() => setTriunfoIndividualFields(prev => prev.filter((_, i) => i !== idx))} className="text-red-400 hover:text-red-300 flex-shrink-0"><X size={16} /></button>
                      )}
                    </div>
                  ))}
                </div>
                <button
                  onClick={() => setTriunfoIndividualFields(prev => [...prev, { texto: '' }])}
                  className={`mt-3 flex items-center gap-1.5 text-sm font-semibold ${darkMode ? 'text-blue-400 hover:text-blue-300' : 'text-blue-600 hover:text-blue-700'}`}
                >
                  <Plus size={16} /> Adicionar campo
                </button>
                <div className="flex gap-3 mt-5">
                  <button onClick={() => setShowAddTriunfoIndividualModal(false)} className={`flex-1 py-2.5 rounded-lg font-semibold text-sm ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}>Cancelar</button>
                  <button onClick={handleSalvarTriunfosIndividuais} className="flex-1 py-2.5 rounded-lg font-semibold text-sm bg-red-600 hover:bg-red-500 text-white">Salvar</button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Modal: Editar Objetivo Geral */}
        {editingTriunfoGeral && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setEditingTriunfoGeral(null)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-md w-full`} onClick={e => e.stopPropagation()}>
              <div className="p-5">
                <div className="flex justify-between items-center mb-5">
                  <h3 className={`text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Editar Objetivo Geral</h3>
                  <button onClick={() => setEditingTriunfoGeral(null)} className={`${darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}`}><X size={20} /></button>
                </div>
                <div className="space-y-3">
                  <input
                    type="text"
                    value={editingTriunfoGeral.texto}
                    onChange={e => setEditingTriunfoGeral(prev => ({ ...prev, texto: e.target.value }))}
                    placeholder="Descreva o objetivo..."
                    className={`w-full px-3 py-2 rounded-lg border text-sm ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'border-gray-300 bg-white'}`}
                  />
                  <div className="flex items-center gap-3">
                    <label className={`text-sm font-semibold ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Vagas:</label>
                    <input
                      type="number"
                      min={1}
                      max={5}
                      value={editingTriunfoGeral.vagas}
                      onChange={e => setEditingTriunfoGeral(prev => ({ ...prev, vagas: Math.min(5, Math.max(1, parseInt(e.target.value) || 1)) }))}
                      className={`w-20 px-3 py-2 rounded-lg border text-sm text-center ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300 bg-white'}`}
                    />
                  </div>
                </div>
                <div className="flex gap-3 mt-5">
                  <button onClick={() => setEditingTriunfoGeral(null)} className={`flex-1 py-2.5 rounded-lg font-semibold text-sm ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}>Cancelar</button>
                  <button
                    onClick={() => {
                      if (!editingTriunfoGeral.texto.trim()) return
                      setTriunfosGerais(prev => prev.map(t => t.id === editingTriunfoGeral.id ? { ...t, texto: editingTriunfoGeral.texto.trim(), vagas: editingTriunfoGeral.vagas } : t))
                      setEditingTriunfoGeral(null)
                    }}
                    className="flex-1 py-2.5 rounded-lg font-semibold text-sm bg-yellow-500 hover:bg-yellow-400 text-gray-900"
                  >Salvar</button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Modal: Editar Objetivo Individual */}
        {editingTriunfoIndividual && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setEditingTriunfoIndividual(null)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-md w-full`} onClick={e => e.stopPropagation()}>
              <div className="p-5">
                <div className="flex justify-between items-center mb-5">
                  <h3 className={`text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Editar Objetivo de {editingTriunfoIndividual.username}</h3>
                  <button onClick={() => setEditingTriunfoIndividual(null)} className={`${darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}`}><X size={20} /></button>
                </div>
                <input
                  type="text"
                  value={editingTriunfoIndividual.texto}
                  onChange={e => setEditingTriunfoIndividual(prev => ({ ...prev, texto: e.target.value }))}
                  placeholder="Descreva o objetivo..."
                  className={`w-full px-3 py-2 rounded-lg border text-sm ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'border-gray-300 bg-white'}`}
                />
                <div className="flex gap-3 mt-5">
                  <button onClick={() => setEditingTriunfoIndividual(null)} className={`flex-1 py-2.5 rounded-lg font-semibold text-sm ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}>Cancelar</button>
                  <button
                    onClick={() => {
                      if (!editingTriunfoIndividual.texto.trim()) return
                      setTriunfosIndividuais(prev => ({
                        ...prev,
                        [editingTriunfoIndividual.username]: (prev[editingTriunfoIndividual.username] || []).map(t =>
                          t.id === editingTriunfoIndividual.id ? { ...t, texto: editingTriunfoIndividual.texto.trim() } : t
                        )
                      }))
                      setEditingTriunfoIndividual(null)
                    }}
                    className="flex-1 py-2.5 rounded-lg font-semibold text-sm bg-yellow-500 hover:bg-yellow-400 text-gray-900"
                  >Salvar</button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Modal: Selecionar Usuários para Objetivo Geral */}
        {showSelectUserForTriunfo && triunfoGeralSelecionado && (
          <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[60] p-4" onClick={() => { setShowSelectUserForTriunfo(false); setTempSelectedUsers([]) }}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-sm w-full`} onClick={e => e.stopPropagation()}>
              <div className="p-5">
                <div className="flex justify-between items-center mb-4">
                  <h3 className={`text-lg font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Marcar Realizadores</h3>
                  <button onClick={() => { setShowSelectUserForTriunfo(false); setTempSelectedUsers([]) }} className={`${darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}`}><X size={18} /></button>
                </div>
                <p className={`text-sm font-semibold mb-1 ${darkMode ? 'text-gray-200' : 'text-gray-700'}`}>{triunfoGeralSelecionado.texto}</p>
                <p className={`text-xs mb-4 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                  Selecione até {slotsRestantes} usuário(s) — vagas restantes: {slotsRestantes}/{triunfoGeralSelecionado.vagas}
                </p>
                <div className="space-y-2">
                  {disponiveis.length === 0 ? (
                    <p className={`text-sm text-center py-3 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Todas as vagas já preenchidas.</p>
                  ) : (
                    disponiveis.map(u => {
                      const isSelected = tempSelectedUsers.includes(u.username)
                      const canAdd = tempSelectedUsers.length < slotsRestantes || isSelected
                      return (
                        <button
                          key={u.username}
                          onClick={() => {
                            if (isSelected) {
                              setTempSelectedUsers(prev => prev.filter(x => x !== u.username))
                            } else if (canAdd) {
                              setTempSelectedUsers(prev => [...prev, u.username])
                            }
                          }}
                          disabled={!isSelected && !canAdd}
                          className={`w-full flex items-center gap-3 p-3 rounded-xl border transition-all ${
                            isSelected
                              ? 'border-green-500 bg-green-900 bg-opacity-30'
                              : !canAdd
                              ? 'opacity-40 cursor-not-allowed border-gray-600'
                              : darkMode ? 'border-gray-700 hover:border-gray-500' : 'border-gray-200 hover:border-gray-400'
                          }`}
                        >
                          <span className="text-sm font-bold text-white px-2 py-0.5 rounded-full flex-1 text-left" style={{ background: u.gradient }}>
                            {u.username}
                          </span>
                          {isSelected && <Check size={16} className="text-green-400 flex-shrink-0" />}
                        </button>
                      )
                    })
                  )}
                </div>
                <div className="flex gap-3 mt-4">
                  <button
                    onClick={() => { setShowSelectUserForTriunfo(false); setTempSelectedUsers([]) }}
                    className={`flex-1 py-2 rounded-lg font-semibold text-sm ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}
                  >
                    Cancelar
                  </button>
                  <button
                    onClick={handleConfirmarSelectUsers}
                    disabled={tempSelectedUsers.length === 0}
                    className="flex-1 py-2 rounded-lg font-semibold text-sm bg-green-600 hover:bg-green-500 text-white disabled:opacity-40"
                  >
                    Confirmar ({tempSelectedUsers.length})
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {accountDataModal}
        {scenarioPopupOverlay}
        {mostrarTriunfosOverlay}
        {pokezapPanel}{pokeAgendaPanel}
        {batalhaChatPanel}
      </>
    )
  }

  if (currentUser.type === 'mestre' && currentArea === 'Bugigangas do Mestre') {
    if (!spoilerMestreConfirmado) return (
      <>
        <div className={`min-h-screen ${mainBgClass}`}>
          {sidebarNav}
          <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-lg`}>
            <div className="max-w-7xl mx-auto px-4 py-4">
              <div className="flex justify-between items-center mb-4">
                <div className="flex items-center gap-3">
                  <button onClick={() => setSidebarOpen(true)} className={`p-2 rounded-lg ${darkMode ? 'hover:bg-gray-700 text-gray-400' : 'hover:bg-gray-200 text-gray-500'}`}><Menu size={24} /></button>
                  <h2 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Bugigangas do Mestre 👑</h2>
                </div>
                <div className="flex gap-2">
                  <button onClick={() => setDarkMode(!darkMode)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-yellow-400' : 'bg-gray-200 text-gray-700'}`}>{darkMode ? <Sun size={20} /> : <Moon size={20} />}</button>
                  {pokezapBtn}{pokeAgendaBtn}{batalhaChatBtn}<button onClick={handleLogout} className="bg-red-500 text-white px-3 sm:px-5 md:px-6 py-2 rounded-lg hover:bg-red-600">Sair</button>
                </div>
              </div>
            </div>
          </div>
          <div className="max-w-7xl mx-auto px-4 py-3 sm:py-5 md:py-8 flex flex-col items-center justify-center min-h-[60vh] text-center gap-6">
            <div className="text-6xl">⚠️</div>
            <h2 className={`text-3xl font-bold ${darkMode ? 'text-yellow-400' : 'text-yellow-600'}`}>Alerta de Spoiler</h2>
            <p className={`text-base max-w-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
              Esta área contém informações confidenciais do Arco. Prossiga apenas se tiver certeza.
            </p>
            <button
              onClick={() => setSpoilerMestreConfirmado(true)}
              className="bg-yellow-500 hover:bg-yellow-600 text-black font-bold px-8 py-3 rounded-xl text-lg transition-colors"
            >
              Sou o mestre do Arco.
            </button>
          </div>
        </div>
        {accountDataModal}
        {scenarioPopupOverlay}
        {mostrarTriunfosOverlay}
        {pokezapPanel}{pokeAgendaPanel}
        {batalhaChatPanel}
      </>
    )

    const trainerUsers = users.filter(u => u.type === 'treinador')
    const ITEMS_PER_PAGE = 9

    const handleConfirmFabricarItem = () => {
      const nome = fabricarItemName.trim()
      if (!nome) { alert('Digite um nome para o item!'); return }
      const conflictPrefix = RESERVED_KEY_ITEM_PREFIXES.find(p => nome.startsWith(p))
      if (conflictPrefix) { alert(`O nome não pode começar com "${conflictPrefix.trim()}" — esse prefixo é reservado pelo sistema.`); return }
      if (RESERVED_KEY_ITEM_NAMES.includes(nome)) { alert(`"${nome}" é um nome reservado pelo sistema. Escolha outro nome.`); return }
      const qtyStr = fabricarItemQty.trim()
      const qty = qtyStr === '' ? 1 : Math.max(1, parseInt(qtyStr) || 1)
      const quantityFixed = qtyStr === ''
      const image = fabricarItemImage.trim() || '/pokeballs/placeholderitem.png'
      const description = fabricarItemDescription.trim()
      const newItem = { id: Date.now() + Math.random(), name: nome, quantity: qty, quantityFixed, image, ...(description && { description }) }
      setMasterItems(prev => [...prev, newItem])
      setShowFabricarItemModal(false)
      setFabricarItemName('')
      setFabricarItemQty('')
      setFabricarItemImage('')
      setFabricarItemDescription('')
    }

    const handleConfirmEditMasterItem = () => {
      if (!editingMasterItem) return
      const nome = editMasterItemName.trim()
      if (!nome) { alert('O nome não pode ser vazio!'); return }
      const qtyStr = editMasterItemQty.trim()
      const qty = qtyStr === '' ? 1 : Math.max(1, parseInt(qtyStr) || 1)
      const quantityFixed = qtyStr === ''
      const image = editMasterItemImage.trim() || '/pokeballs/placeholderitem.png'
      const description = editMasterItemDescription.trim()
      setMasterItems(prev => prev.map(item =>
        item.id === editingMasterItem.id
          ? { ...item, name: nome, quantity: qty, quantityFixed, image, description: description || undefined }
          : item
      ))
      setShowEditMasterItemModal(false)
      setEditingMasterItem(null)
    }

    const handleConfirmMandarItem = async () => {
      if (!mandarItemTarget || mandarItemSelectedUsers.length === 0) return
      if (!useFirebase) { alert('Esta função requer Firebase!'); return }
      try {
        for (const username of mandarItemSelectedUsers) {
          const receiverRef = ref(database, `trainers/${username}`)
          const snapshot = await get(receiverRef)
          if (!snapshot.exists()) continue
          const receiverData = snapshot.val()
          const receiverKeyItems = receiverData.keyItems || []
          const existingItem = receiverKeyItems.find(item => item.name === mandarItemTarget.name)
          let updatedReceiverKeyItems
          if (existingItem) {
            updatedReceiverKeyItems = receiverKeyItems.map(item =>
              item.name === mandarItemTarget.name ? { ...item, quantity: item.quantity + 1 } : item
            )
          } else {
            const newKI = { name: mandarItemTarget.name, quantity: 1 }
            if (mandarItemTarget.image && mandarItemTarget.image !== '/pokeballs/placeholderitem.png') newKI.image = mandarItemTarget.image
            if (mandarItemTarget.description) newKI.description = mandarItemTarget.description
            updatedReceiverKeyItems = [...receiverKeyItems, newKI]
          }
          await set(ref(database, `trainers/${username}/keyItems`), updatedReceiverKeyItems)
        }
        const newQty = mandarItemTarget.quantity - mandarItemSelectedUsers.length
        if (newQty <= 0) {
          setMasterItems(prev => prev.filter(item => item.id !== mandarItemTarget.id))
          setMasterItemsSent(prev => [...prev, { ...mandarItemTarget, quantity: 0 }])
        } else {
          setMasterItems(prev => prev.map(item =>
            item.id === mandarItemTarget.id ? { ...item, quantity: newQty } : item
          ))
        }
        setShowMandarItemModal(false)
        setMandarItemTarget(null)
        setMandarItemSelectedUsers([])
      } catch (err) {
        console.error('Erro ao enviar item:', err)
        alert('Erro ao enviar o item!')
      }
    }

    const handleConfirmRenovarItem = () => {
      if (!renovarItemTarget) return
      const qtyStr = renovarItemQty.trim()
      const qty = qtyStr === '' ? 1 : Math.max(1, parseInt(qtyStr) || 1)
      const quantityFixed = qtyStr === ''
      const renewedItem = { ...renovarItemTarget, quantity: qty, quantityFixed }
      setMasterItemsSent(prev => prev.filter(item => item.id !== renovarItemTarget.id))
      setMasterItems(prev => [...prev, renewedItem])
      setShowRenovarItemModal(false)
      setRenovarItemTarget(null)
      setRenovarItemQty('')
    }

    const notSentTotalPages = Math.max(1, Math.ceil(masterItems.length / ITEMS_PER_PAGE))
    const notSentPaged = masterItems.slice(masterItemsPage * ITEMS_PER_PAGE, (masterItemsPage + 1) * ITEMS_PER_PAGE)
    const sentTotalPages = Math.max(1, Math.ceil(masterItemsSent.length / ITEMS_PER_PAGE))
    const sentPaged = masterItemsSent.slice(masterItemsSentPage * ITEMS_PER_PAGE, (masterItemsSentPage + 1) * ITEMS_PER_PAGE)

    return (
      <>
        <div className={`min-h-screen ${mainBgClass}`}>
          {sidebarNav}
          <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-lg`}>
            <div className="max-w-7xl mx-auto px-4 py-4">
              <div className="flex justify-between items-center mb-4">
                <div className="flex items-center gap-3">
                  <button onClick={() => setSidebarOpen(true)} className={`p-2 rounded-lg ${darkMode ? 'hover:bg-gray-700 text-gray-400' : 'hover:bg-gray-200 text-gray-500'}`}><Menu size={24} /></button>
                  <h2 className={`text-xl sm:text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Bugigangas do Mestre 👑</h2>
                </div>
                <div className="flex gap-2">
                  <button onClick={() => setDarkMode(!darkMode)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-700 text-yellow-400' : 'bg-gray-200 text-gray-700'}`}>{darkMode ? <Sun size={20} /> : <Moon size={20} />}</button>
                  {pokezapBtn}{pokeAgendaBtn}{batalhaChatBtn}<button onClick={handleLogout} className="bg-red-500 text-white px-3 sm:px-5 md:px-6 py-2 rounded-lg hover:bg-red-600">Sair</button>
                </div>
              </div>
            </div>
          </div>

          <div className="max-w-7xl mx-auto px-4 py-3 sm:py-5 md:py-8 space-y-6">
            {/* Seção: Itens Não Enviados */}
            <div className={`rounded-2xl p-4 sm:p-5 ${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-sm`}>
              <div className="flex items-center justify-between mb-4">
                <h3 className={`text-base sm:text-lg font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Itens Não Enviados</h3>
                <button
                  onClick={() => { setFabricarItemName(''); setFabricarItemQty(''); setFabricarItemImage(''); setFabricarItemDescription(''); setShowFabricarItemModal(true) }}
                  className="flex items-center gap-2 px-3 py-2 rounded-xl text-sm font-semibold bg-purple-600 hover:bg-purple-500 text-white transition-colors"
                >
                  <Package size={16} /> Fabricar Itens
                </button>
              </div>
              {masterItems.length === 0 ? (
                <p className={`text-center text-sm py-8 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Nenhum item fabricado ainda.</p>
              ) : (
                <>
                  <div className="grid grid-cols-3 gap-2 sm:gap-3">
                    {notSentPaged.map(item => (
                      <div key={item.id} className={`relative group rounded-xl p-2 border flex flex-col items-center gap-1 ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-gray-50 border-gray-200'}`}>
                        {/* Info */}
                        <button
                          onClick={() => { setMasterItemDescTarget(item); setShowMasterItemDescModal(true) }}
                          className={`absolute top-0.5 left-0.5 opacity-0 group-hover:opacity-100 transition-opacity ${darkMode ? 'text-blue-400 hover:text-blue-300' : 'text-blue-500 hover:text-blue-600'}`}
                          title="Ver descrição"
                        >
                          <Info size={12} className="sm:w-[14px] sm:h-[14px]" />
                        </button>
                        {/* Edit + Delete */}
                        <div className="absolute top-0.5 right-0.5 flex gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity">
                          <button
                            onClick={() => {
                              setEditingMasterItem(item)
                              setEditMasterItemName(item.name)
                              setEditMasterItemQty(item.quantityFixed ? '' : String(item.quantity))
                              setEditMasterItemImage(item.image && item.image !== '/pokeballs/placeholderitem.png' ? item.image : '')
                              setEditMasterItemDescription(item.description || '')
                              setShowEditMasterItemModal(true)
                            }}
                            className={`${darkMode ? 'text-yellow-400 hover:text-yellow-300' : 'text-yellow-500 hover:text-yellow-600'}`}
                            title="Editar"
                          >
                            <Pencil size={12} className="sm:w-[14px] sm:h-[14px]" />
                          </button>
                          <button
                            onClick={() => setMasterItems(prev => prev.filter(i => i.id !== item.id))}
                            className={`${darkMode ? 'text-red-400 hover:text-red-300' : 'text-red-500 hover:text-red-600'}`}
                            title="Excluir"
                          >
                            <Trash2 size={12} className="sm:w-[14px] sm:h-[14px]" />
                          </button>
                        </div>
                        {/* Image */}
                        <div className="w-12 h-12 flex items-center justify-center mt-3">
                          <img
                            src={item.image || '/pokeballs/placeholderitem.png'}
                            alt={item.name}
                            className="max-w-full max-h-full object-contain"
                            onError={e => { e.target.src = '/pokeballs/placeholderitem.png' }}
                          />
                        </div>
                        {/* Name */}
                        <span className={`text-xs font-semibold text-center leading-tight line-clamp-2 ${darkMode ? 'text-gray-200' : 'text-gray-800'}`}>{item.name}</span>
                        {/* Qty */}
                        <span className={`text-xs font-bold ${darkMode ? 'text-purple-400' : 'text-purple-600'}`}>
                          x{item.quantity}{item.quantityFixed ? ' 🔒' : ''}
                        </span>
                        {/* Mandar button */}
                        <button
                          onClick={() => { setMandarItemTarget(item); setMandarItemSelectedUsers([]); setShowMandarItemModal(true) }}
                          className="w-full mt-1 py-1 px-2 rounded-lg text-xs font-semibold bg-purple-600 hover:bg-purple-500 text-white flex items-center justify-center gap-1"
                          title="Mandar Item"
                        >
                          <Send size={11} /> Mandar
                        </button>
                      </div>
                    ))}
                  </div>
                  {notSentTotalPages > 1 && (
                    <div className="flex items-center justify-center gap-3 mt-4">
                      <button onClick={() => setMasterItemsPage(p => Math.max(0, p - 1))} disabled={masterItemsPage === 0} className={`p-1.5 rounded-lg ${darkMode ? 'hover:bg-gray-600 text-gray-300' : 'hover:bg-gray-200 text-gray-600'} disabled:opacity-40`}><ChevronLeft size={18} /></button>
                      <span className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>{masterItemsPage + 1} / {notSentTotalPages}</span>
                      <button onClick={() => setMasterItemsPage(p => Math.min(notSentTotalPages - 1, p + 1))} disabled={masterItemsPage >= notSentTotalPages - 1} className={`p-1.5 rounded-lg ${darkMode ? 'hover:bg-gray-600 text-gray-300' : 'hover:bg-gray-200 text-gray-600'} disabled:opacity-40`}><ChevronRight size={18} /></button>
                    </div>
                  )}
                </>
              )}
            </div>

            {/* Seção: Itens Enviados */}
            <div className={`rounded-2xl p-4 sm:p-5 ${darkMode ? 'bg-gray-800' : 'bg-white'} shadow-sm`}>
              <h3 className={`text-base sm:text-lg font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-800'}`}>Itens Enviados</h3>
              {masterItemsSent.length === 0 ? (
                <p className={`text-center text-sm py-8 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Nenhum item enviado ainda.</p>
              ) : (
                <>
                  <div className="grid grid-cols-3 gap-2 sm:gap-3">
                    {sentPaged.map(item => (
                      <div key={item.id} className={`relative group rounded-xl p-2 border flex flex-col items-center gap-1 ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-gray-50 border-gray-200'}`}>
                        {/* Info */}
                        <button
                          onClick={() => { setMasterItemDescTarget(item); setShowMasterItemDescModal(true) }}
                          className={`absolute top-0.5 left-0.5 opacity-0 group-hover:opacity-100 transition-opacity ${darkMode ? 'text-blue-400 hover:text-blue-300' : 'text-blue-500 hover:text-blue-600'}`}
                          title="Ver descrição"
                        >
                          <Info size={12} className="sm:w-[14px] sm:h-[14px]" />
                        </button>
                        {/* Renew + Delete */}
                        <div className="absolute top-0.5 right-0.5 flex gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity">
                          <button
                            onClick={() => { setRenovarItemTarget(item); setRenovarItemQty(''); setShowRenovarItemModal(true) }}
                            className={`${darkMode ? 'text-green-400 hover:text-green-300' : 'text-green-500 hover:text-green-600'}`}
                            title="Renovar"
                          >
                            <RefreshCcw size={12} className="sm:w-[14px] sm:h-[14px]" />
                          </button>
                          <button
                            onClick={() => setMasterItemsSent(prev => prev.filter(i => i.id !== item.id))}
                            className={`${darkMode ? 'text-red-400 hover:text-red-300' : 'text-red-500 hover:text-red-600'}`}
                            title="Excluir"
                          >
                            <Trash2 size={12} className="sm:w-[14px] sm:h-[14px]" />
                          </button>
                        </div>
                        {/* Image */}
                        <div className="w-12 h-12 flex items-center justify-center mt-3 opacity-60">
                          <img
                            src={item.image || '/pokeballs/placeholderitem.png'}
                            alt={item.name}
                            className="max-w-full max-h-full object-contain"
                            onError={e => { e.target.src = '/pokeballs/placeholderitem.png' }}
                          />
                        </div>
                        {/* Name */}
                        <span className={`text-xs font-semibold text-center leading-tight line-clamp-2 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>{item.name}</span>
                        <span className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>Enviado</span>
                      </div>
                    ))}
                  </div>
                  {sentTotalPages > 1 && (
                    <div className="flex items-center justify-center gap-3 mt-4">
                      <button onClick={() => setMasterItemsSentPage(p => Math.max(0, p - 1))} disabled={masterItemsSentPage === 0} className={`p-1.5 rounded-lg ${darkMode ? 'hover:bg-gray-600 text-gray-300' : 'hover:bg-gray-200 text-gray-600'} disabled:opacity-40`}><ChevronLeft size={18} /></button>
                      <span className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>{masterItemsSentPage + 1} / {sentTotalPages}</span>
                      <button onClick={() => setMasterItemsSentPage(p => Math.min(sentTotalPages - 1, p + 1))} disabled={masterItemsSentPage >= sentTotalPages - 1} className={`p-1.5 rounded-lg ${darkMode ? 'hover:bg-gray-600 text-gray-300' : 'hover:bg-gray-200 text-gray-600'} disabled:opacity-40`}><ChevronRight size={18} /></button>
                    </div>
                  )}
                </>
              )}
            </div>
          </div>
        </div>

        {/* Modal: Fabricar Item */}
        {showFabricarItemModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowFabricarItemModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto`} onClick={e => e.stopPropagation()}>
              <div className="p-5">
                <div className="flex justify-between items-center mb-5">
                  <h3 className={`text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Fabricar Item</h3>
                  <button onClick={() => setShowFabricarItemModal(false)} className={`${darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}`}><X size={20} /></button>
                </div>
                <div className="space-y-4">
                  <div>
                    <label className={`block text-sm font-semibold mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Nome *</label>
                    <input type="text" value={fabricarItemName} onChange={e => setFabricarItemName(e.target.value)} placeholder="Nome do item" className={`w-full px-3 py-2.5 rounded-lg border text-sm ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'border-gray-300 bg-white'}`} />
                  </div>
                  <div>
                    <label className={`block text-sm font-semibold mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>URL da Imagem</label>
                    <input type="text" value={fabricarItemImage} onChange={e => setFabricarItemImage(e.target.value)} placeholder="https://... (opcional)" className={`w-full px-3 py-2.5 rounded-lg border text-sm ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'border-gray-300 bg-white'}`} />
                  </div>
                  <div>
                    <label className={`block text-sm font-semibold mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Quantidade</label>
                    <input type="number" min={1} value={fabricarItemQty} onChange={e => setFabricarItemQty(e.target.value)} placeholder="Padrão: 1 (fixo)" className={`w-full px-3 py-2.5 rounded-lg border text-sm ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'border-gray-300 bg-white'}`} />
                    {fabricarItemQty === '' && <p className={`text-xs mt-1 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Sem valor → quantidade 1 (não editável manualmente)</p>}
                  </div>
                  <div>
                    <label className={`block text-sm font-semibold mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Descrição</label>
                    <textarea value={fabricarItemDescription} onChange={e => setFabricarItemDescription(e.target.value)} placeholder="Descrição do item (opcional)" rows={3} className={`w-full px-3 py-2.5 rounded-lg border text-sm resize-none ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'border-gray-300 bg-white'}`} />
                  </div>
                </div>
                <div className="flex gap-3 mt-6">
                  <button onClick={() => setShowFabricarItemModal(false)} className={`flex-1 py-2.5 rounded-xl font-semibold text-sm ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}>Cancelar</button>
                  <button onClick={handleConfirmFabricarItem} className="flex-1 py-2.5 rounded-xl font-semibold text-sm bg-purple-600 hover:bg-purple-500 text-white">Fabricar</button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Modal: Editar Item */}
        {showEditMasterItemModal && editingMasterItem && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowEditMasterItemModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto`} onClick={e => e.stopPropagation()}>
              <div className="p-5">
                <div className="flex justify-between items-center mb-5">
                  <h3 className={`text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Editar Item</h3>
                  <button onClick={() => setShowEditMasterItemModal(false)} className={`${darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}`}><X size={20} /></button>
                </div>
                <div className="space-y-4">
                  <div>
                    <label className={`block text-sm font-semibold mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Nome *</label>
                    <input type="text" value={editMasterItemName} onChange={e => setEditMasterItemName(e.target.value)} className={`w-full px-3 py-2.5 rounded-lg border text-sm ${darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border-gray-300 bg-white'}`} />
                  </div>
                  <div>
                    <label className={`block text-sm font-semibold mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>URL da Imagem</label>
                    <input type="text" value={editMasterItemImage} onChange={e => setEditMasterItemImage(e.target.value)} placeholder="https://... (opcional)" className={`w-full px-3 py-2.5 rounded-lg border text-sm ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'border-gray-300 bg-white'}`} />
                  </div>
                  <div>
                    <label className={`block text-sm font-semibold mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Quantidade</label>
                    <input type="number" min={1} value={editMasterItemQty} onChange={e => setEditMasterItemQty(e.target.value)} placeholder="Padrão: 1 (fixo)" className={`w-full px-3 py-2.5 rounded-lg border text-sm ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'border-gray-300 bg-white'}`} />
                    {editMasterItemQty === '' && <p className={`text-xs mt-1 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Sem valor → quantidade 1 (não editável manualmente)</p>}
                  </div>
                  <div>
                    <label className={`block text-sm font-semibold mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Descrição</label>
                    <textarea value={editMasterItemDescription} onChange={e => setEditMasterItemDescription(e.target.value)} placeholder="Descrição do item (opcional)" rows={3} className={`w-full px-3 py-2.5 rounded-lg border text-sm resize-none ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'border-gray-300 bg-white'}`} />
                  </div>
                </div>
                <div className="flex gap-3 mt-6">
                  <button onClick={() => setShowEditMasterItemModal(false)} className={`flex-1 py-2.5 rounded-xl font-semibold text-sm ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}>Cancelar</button>
                  <button onClick={handleConfirmEditMasterItem} className="flex-1 py-2.5 rounded-xl font-semibold text-sm bg-yellow-600 hover:bg-yellow-500 text-white">Salvar</button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Modal: Mandar Item */}
        {showMandarItemModal && mandarItemTarget && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => { setShowMandarItemModal(false); setMandarItemSelectedUsers([]) }}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto`} onClick={e => e.stopPropagation()}>
              <div className="p-5">
                <div className="flex justify-between items-center mb-2">
                  <h3 className={`text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Enviar Item</h3>
                  <button onClick={() => { setShowMandarItemModal(false); setMandarItemSelectedUsers([]) }} className={`${darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}`}><X size={20} /></button>
                </div>
                <p className={`text-sm font-semibold mb-1 ${darkMode ? 'text-gray-200' : 'text-gray-700'}`}>{mandarItemTarget.name}</p>
                <p className={`text-xs mb-4 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                  Selecione até {mandarItemTarget.quantity} treinador{mandarItemTarget.quantity !== 1 ? 'es' : ''} (mínimo 1).
                </p>
                <div className="space-y-2 max-h-60 overflow-y-auto mb-4">
                  {trainerUsers.length === 0 ? (
                    <p className={`text-sm text-center ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Nenhum treinador disponível.</p>
                  ) : trainerUsers.map(u => {
                    const isSelected = mandarItemSelectedUsers.includes(u.username)
                    const maxReached = mandarItemSelectedUsers.length >= mandarItemTarget.quantity
                    return (
                      <button
                        key={u.username}
                        onClick={() => {
                          if (isSelected) {
                            setMandarItemSelectedUsers(prev => prev.filter(x => x !== u.username))
                          } else if (!maxReached) {
                            setMandarItemSelectedUsers(prev => [...prev, u.username])
                          }
                        }}
                        disabled={!isSelected && maxReached}
                        className={`w-full flex items-center justify-between px-3 py-2.5 rounded-xl border text-left transition-colors ${
                          isSelected
                            ? 'border-purple-500 bg-purple-500/20'
                            : darkMode
                              ? 'border-gray-600 bg-gray-700 hover:bg-gray-600 disabled:opacity-40'
                              : 'border-gray-200 bg-gray-50 hover:bg-gray-100 disabled:opacity-40'
                        }`}
                      >
                        <span className="text-sm font-bold px-2 py-0.5 rounded-full text-white" style={{ background: u.gradient }}>{u.username}</span>
                        {isSelected && <Check size={16} className="text-purple-400 flex-shrink-0" />}
                      </button>
                    )
                  })}
                </div>
                <div className="flex gap-3">
                  <button onClick={() => { setShowMandarItemModal(false); setMandarItemSelectedUsers([]) }} className={`flex-1 py-2.5 rounded-xl font-semibold text-sm ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}>Cancelar</button>
                  <button onClick={handleConfirmMandarItem} disabled={mandarItemSelectedUsers.length === 0} className="flex-1 py-2.5 rounded-xl font-semibold text-sm bg-purple-600 hover:bg-purple-500 text-white disabled:opacity-40">
                    Enviar ({mandarItemSelectedUsers.length})
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Modal: Descrição Item */}
        {showMasterItemDescModal && masterItemDescTarget && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowMasterItemDescModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl p-4 sm:p-6 max-w-sm w-full`} onClick={e => e.stopPropagation()}>
              <div className="w-full h-24 mb-3 flex items-center justify-center">
                <img src={masterItemDescTarget.image || '/pokeballs/placeholderitem.png'} alt={masterItemDescTarget.name} className="max-w-full max-h-full object-contain" onError={e => { e.target.src = '/pokeballs/placeholderitem.png' }} />
              </div>
              <h3 className={`text-lg font-bold text-center mb-3 ${darkMode ? 'text-white' : 'text-gray-800'}`}>{masterItemDescTarget.name}</h3>
              <p className={`text-sm text-center mb-5 ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>{masterItemDescTarget.description || 'Sem descrição.'}</p>
              <button onClick={() => setShowMasterItemDescModal(false)} className={`w-full py-3 rounded-lg font-semibold ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}>Fechar</button>
            </div>
          </div>
        )}

        {/* Modal: Renovar Item */}
        {showRenovarItemModal && renovarItemTarget && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowRenovarItemModal(false)}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl shadow-2xl max-w-sm w-full`} onClick={e => e.stopPropagation()}>
              <div className="p-5">
                <div className="flex justify-between items-center mb-4">
                  <h3 className={`text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Renovar Item</h3>
                  <button onClick={() => setShowRenovarItemModal(false)} className={`${darkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-700'}`}><X size={20} /></button>
                </div>
                <p className={`text-sm font-semibold mb-4 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>{renovarItemTarget.name}</p>
                <div>
                  <label className={`block text-sm font-semibold mb-1 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Nova Quantidade</label>
                  <input type="number" min={1} value={renovarItemQty} onChange={e => setRenovarItemQty(e.target.value)} placeholder="Padrão: 1 (fixo)" className={`w-full px-3 py-2.5 rounded-lg border text-sm ${darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'border-gray-300 bg-white'}`} />
                  {renovarItemQty === '' && <p className={`text-xs mt-1 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Sem valor → quantidade 1 (não editável manualmente)</p>}
                </div>
                <div className="flex gap-3 mt-6">
                  <button onClick={() => setShowRenovarItemModal(false)} className={`flex-1 py-2.5 rounded-xl font-semibold text-sm ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'}`}>Cancelar</button>
                  <button onClick={handleConfirmRenovarItem} className="flex-1 py-2.5 rounded-xl font-semibold text-sm bg-green-600 hover:bg-green-500 text-white">Renovar</button>
                </div>
              </div>
            </div>
          </div>
        )}

        {accountDataModal}
        {scenarioPopupOverlay}
        {mostrarTriunfosOverlay}
        {pokezapPanel}{pokeAgendaPanel}
        {batalhaChatPanel}
      </>
    )
  }

  return null
}

export default App
